{
  "hash": "3e9dbf5e2c4514314242fd5d092a6592",
  "result": {
    "engine": "jupyter",
    "markdown": "# Firm Valuation, Financial Distress, and Company Maturity\n\nUnderstanding firm valuation, financial health, and corporate maturity is fundamental to financial analysis and investment decision-making. Three widely used measures (e.g., Tobin's Q, the Altman Z-Score, and company age) capture distinct but complementary dimensions of a firm's economic standing. Tobin's Q reflects the market's assessment of a firm's value relative to its asset base, the Altman Z-Score predicts the likelihood of financial distress, and company age proxies for organizational maturity and operational stability.\n\nWhile these measures have been extensively studied in developed markets, particularly the United States [see @lindenberg1981tobin; @altman1968financial; @gompers2003corporate], their application in emerging markets like Vietnam presents unique challenges and opportunities. The Vietnamese stock market has grown rapidly but retains structural features, such as ownership concentration, state-owned enterprise dominance, limited bond market depth, and evolving accounting standards, which necessitate careful adaptation of standard valuation and distress metrics.\n\n## Required Packages\n\n::: {#setup .cell message='false' execution_count=2}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport matplotlib.ticker as mticker\nimport seaborn as sns\nfrom matplotlib.colors import LinearSegmentedColormap\nimport warnings\n\nwarnings.filterwarnings(\"ignore\")\nplt.rcParams.update({\n    \"figure.figsize\": (10, 6),\n    \"font.size\": 12,\n    \"axes.titlesize\": 14,\n    \"axes.labelsize\": 12,\n    \"xtick.labelsize\": 10,\n    \"ytick.labelsize\": 10,\n    \"legend.fontsize\": 10,\n    \"figure.dpi\": 150,\n    \"axes.spines.top\": False,\n    \"axes.spines.right\": False,\n})\n\n# Color palette consistent with Tidy Finance style\ncolors = {\n    \"primary\": \"#1f77b4\",\n    \"secondary\": \"#ff7f0e\",\n    \"tertiary\": \"#2ca02c\",\n    \"quaternary\": \"#d62728\",\n    \"quinary\": \"#9467bd\",\n    \"safe\": \"#2ca02c\",\n    \"alert\": \"#ff7f0e\",\n    \"danger\": \"#d62728\",\n    \"distress\": \"#8b0000\",\n}\n```\n:::\n\n\n# Theoretical Foundations {#sec-theory}\n\n## Tobin's Q: Market Valuation of the Firm {#sec-tobinq-theory}\n\n### The Original Concept\n\nTobin's Q was introduced by @tobin1969general as a theoretical link between financial markets and real investment decisions. The fundamental idea is elegant: if the market values a firm's assets at more than their replacement cost, the firm has an incentive to invest in new capital; if the market values them at less, the firm should not invest, and may even benefit from selling assets.\n\nFormally, Tobin's Q is defined as:\n\n$$\nQ = \\frac{\\text{Market Value of the Firm}}{\\text{Replacement Cost of Assets}}\n$$ {#eq-tobinq-basic}\n\nWhen $Q > 1$, the market perceives the firm as possessing valuable intangible assets, such as brand equity, managerial talent, proprietary technology, or growth opportunities, that exceed the cost of its tangible asset base. When $Q < 1$, the market effectively values the firm at less than what it would cost to reassemble its assets, suggesting potential undervaluation or the presence of agency costs and organizational inefficiencies.\n\n### Market Value Decomposition\n\nThe numerator of Tobin's Q represents the total market value of all claims on the firm:\n\n$$\nMV = CS + PS + ST + LT\n$$ {#eq-mv-decomposition}\n\nwhere:\n\n-   $CS$ = Market value of common stock (shares outstanding $\\times$ market price)\n-   $PS$ = Market value of preferred stock\n-   $ST$ = Market value of short-term debt\n-   $LT$ = Market value of long-term debt\n\n### Replacement Cost of Assets\n\nThe denominator captures the replacement cost of the firm's asset base:\n\n$$\nRC = TA + (RNP - HNP) + (RINV - HINV)\n$$ {#eq-replacement-cost}\n\nwhere:\n\n-   $TA$ = Total assets as reported\n-   $RNP$ = Replacement cost of net plant and equipment\n-   $HNP$ = Historical (book) value of net plant and equipment\n-   $RINV$ = Replacement cost of inventories\n-   $HINV$ = Historical (book) value of inventories\n\nThe replacement cost adjustments for plant and equipment involve recursive calculations that account for depreciation rates and, in more detailed estimations, technical progress rates [@lindenberg1981tobin]. For inventories, the adjustment depends on the inventory accounting method: LIFO (Last In, First Out), FIFO (First In, First Out), average cost, or retail cost.\n\n### Simplified Tobin's Q\n\nIn practice, the full replacement cost computation requires data that are often unavailable, particularly in emerging markets. @gompers2003corporate popularized a simplified version:\n\n$$\nQ_{\\text{simple}} = \\frac{TA + ME - BE}{TA}\n$$ {#eq-tobinq-simple}\n\nwhere $ME$ is the market value of equity and $BE$ is the book value of equity. This formulation assumes that the book values of debt and preferred stock approximate their market values, and that total assets approximate the replacement cost of the firm's asset base. Despite its simplicity, this measure has been shown to correlate well with more elaborate constructions and has become the standard in empirical corporate finance research.\n\n### Chung and Pruitt Approximation\n\n@chung1994simple proposed another widely used approximation:\n\n$$\nQ_{\\text{CP}} = \\frac{ME + PS + DEBT}{TA}\n$$ {#eq-tobinq-cp}\n\nwhere $DEBT = \\text{Current Liabilities} - \\text{Current Assets} + \\text{Book Value of Inventories} + \\text{Long-term Debt}$. This formulation captures the net debt position more precisely than the @gompers2003corporate version.\n\n------------------------------------------------------------------------\n\n## Altman Z-Score: Predicting Financial Distress {#sec-zscore-theory}\n\n### The Original Model\n\nThe Altman Z-Score, developed by @altman1968financial, is a multivariate discriminant analysis model that predicts the probability of corporate bankruptcy within a two-year horizon. The model was originally estimated using a matched sample of bankrupt and non-bankrupt U.S. manufacturing firms and takes the form:\n\n$$\nZ = 3.3 \\cdot X_1 + 0.999 \\cdot X_2 + 0.6 \\cdot X_3 + 1.2 \\cdot X_4 + 1.4 \\cdot X_5\n$$ {#eq-zscore-original}\n\nwhere the five financial ratios are in @tbl-zscore-components\n\n| Variable | Formula | Interpretation |\n|---------------------|-------------------|--------------------------------|\n| $X_1$ | $\\frac{\\text{EBIT}}{\\text{Total Assets}}$ | Earning power of assets |\n| $X_2$ | $\\frac{\\text{Net Sales}}{\\text{Total Assets}}$ | Total asset turnover |\n| $X_3$ | $\\frac{\\text{Market Value of Equity}}{\\text{Total Liabilities}}$ | Leverage ratio (inverse) |\n| $X_4$ | $\\frac{\\text{Working Capital}}{\\text{Total Assets}}$ | Short-term liquidity |\n| $X_5$ | $\\frac{\\text{Retained Earnings}}{\\text{Total Assets}}$ | Cumulative profitability |\n\n: Components of the Altman Z-Score {#tbl-zscore-components}\n\nThe interpretation zones are in @tbl-zscore-zones\n\n| Z-Score Range | Interpretation |\n|-----------------------------------|-------------------------------------|\n| $Z > 2.99$ | Safe zone-low probability of financial distress |\n| $2.70 \\leq Z \\leq 2.99$ | Grey zone-on alert, moderate risk |\n| $1.80 \\leq Z < 2.70$ | Distress zone-significant bankruptcy risk within 2 years |\n| $Z < 1.80$ | High distress-very high probability of financial failure |\n\n: Altman Z-Score interpretation zones {#tbl-zscore-zones}\n\n### The Z'-Score Model for Private Firms\n\nBecause the original model uses market value of equity in $X_3$, @altman2010corporate developed the Z'-Score for private (non-publicly traded) firms by replacing market capitalization with book value of equity:\n\n$$\nZ' = 0.717 \\cdot X_1' + 0.847 \\cdot X_2' + 3.107 \\cdot X_3' + 0.420 \\cdot X_4' + 0.998 \\cdot X_5'\n$$ {#eq-zscore-private}\n\nwhere $X_4' = \\frac{\\text{Book Value of Equity}}{\\text{Total Liabilities}}$, and the remaining variables are defined as in the original model but with re-estimated coefficients.\n\n### The Z''-Score Model for Emerging Markets\n\nMost relevant for Vietnam, @altman2010corporate also developed the Z''-Score for non-manufacturing and emerging market firms:\n\n$$\nZ'' = 3.25 + 6.56 \\cdot X_1'' + 3.26 \\cdot X_2'' + 6.72 \\cdot X_3'' + 1.05 \\cdot X_4''\n$$ {#eq-zscore-emerging}\n\nwhere:\n\n-   $X_1'' = \\frac{\\text{Working Capital}}{\\text{Total Assets}}$\n-   $X_2'' = \\frac{\\text{Retained Earnings}}{\\text{Total Assets}}$\n-   $X_3'' = \\frac{\\text{EBIT}}{\\text{Total Assets}}$\n-   $X_4'' = \\frac{\\text{Book Value of Equity}}{\\text{Total Liabilities}}$\n\nNote that this model drops the sales/total assets ratio ($X_2$ in the original model) to minimize industry effects and adds an intercept. The classification zones shift accordingly (@tbl-zscore-em-zones).\n\n| Z''-Score Range           | Interpretation |\n|---------------------------|----------------|\n| $Z'' > 2.60$              | Safe zone      |\n| $1.10 \\leq Z'' \\leq 2.60$ | Grey zone      |\n| $Z'' < 1.10$              | Distress zone  |\n\n: Z''-Score interpretation zones for emerging markets {#tbl-zscore-em-zones}\n\n## Company Age: Measuring Corporate Maturity {#sec-age-theory}\n\nCompany age captures the accumulated experience, reputation, and organizational capital of a firm. Older firms typically exhibit more stable operations, established competitive advantages, and predictable cash flow patterns [@coad2018firm]. Age is commonly used as a control variable in corporate finance research, and its relationship with performance is theoretically ambiguous: older firms benefit from learning effects and reputation but may suffer from organizational rigidity and declining innovation [@huergo2004firms].\n\nThe ideal measure is the number of years since founding. When founding dates are unavailable, common proxies include:\n\n1.  **Listing age**: Years since the first IPO or listing on a stock exchange.\n2.  **Data age**: Years since the first appearance in financial databases.\n3.  **Incorporation age**: Years since the date of legal incorporation.\n\nIn the Vietnamese context, we can use multiple proxies, including the date of first listing on HOSE or HNX, the first available financial statement date, and (when available) the founding date from company profiles.\n\n# The Vietnamese Market Context {#sec-vietnam-context}\n\n## Institutional Features Affecting Valuation Measures\n\nThe Vietnamese stock market has several institutional features that are important to consider when computing and interpreting Tobin's Q, Altman Z-Score, and company age.\n\n### State Ownership and Equitization\n\nA significant proportion of Vietnamese listed firms are former state-owned enterprises (SOEs) that underwent equitization (cổ phần hóa). These firms often retain substantial state ownership, which can affect:\n\n-   **Tobin's Q**: State ownership may depress Q if markets perceive government influence as reducing efficiency, or it may elevate Q if state connections provide preferential access to resources and contracts.\n-   **Z-Score**: SOEs may have implicit government guarantees that reduce actual bankruptcy risk below what the Z-Score predicts.\n-   **Age**: The true operational age of equitized SOEs may far exceed their listing age, creating measurement challenges.\n\n### Foreign Ownership Limits\n\nVietnam imposes foreign ownership limits (FOL) on listed companies, typically capped at 49% for most sectors (with some exceptions). This constraint can create price premiums for stocks approaching the FOL ceiling, potentially inflating Tobin's Q for these firms [@vo2015foreign].\n\n### Accounting Standards\n\nVietnamese Accounting Standards (VAS) differ from International Financial Reporting Standards (IFRS) in several ways relevant to our measures:\n\n-   **Historical cost basis**: VAS relies more heavily on historical cost, which can cause book values to diverge substantially from replacement costs, affecting both Q and Z-Score calculations.\n-   **Limited fair value measurement**: Unlike IFRS, VAS limits fair value measurement for many asset classes, making book-value-based proxies less reliable.\n-   **Inventory methods**: Vietnamese firms use various inventory valuation methods (FIFO, weighted average), which affect the book value of inventories and hence the Z-Score's working capital component.\n\n### Market Microstructure\n\nVietnam's market features daily price limits (currently $\\pm$ 7% on HOSE, $\\pm$ 10% on HNX, $\\pm$ 15% on UPCoM), which can prevent prices from reaching equilibrium values quickly. This means that market capitalization at any point may not fully reflect available information, introducing noise into market-value-based measures like Tobin's Q.\n\n```{=html}\n<!-- ## DataCore.vn Dataset Structure\n\nDataCore.vn provides comprehensive financial data for Vietnamese listed companies. For this chapter, we assume access to the following datasets:\n\n1.  **Financial statements** (`financial_statements`): Annual and quarterly balance sheets, income statements, and cash flow statements for all listed firms.\n2.  **Market data** (`market_data`): Daily stock prices, shares outstanding, and market capitalization.\n3.  **Company profiles** (`company_profiles`): Firm characteristics including listing date, founding date, industry classification, exchange, and ownership structure.\n4.  **Delisting information** (`delisting_info`): Records of firms that have been delisted, including dates and reasons. -->\n```\n\n# Data Preparation {#sec-data-prep}\n\n## Loading and Cleaning Financial Statement Data\n\nWe begin by loading the annual financial statement data and constructing the variables needed for our three measures.\n\n::: {#simulate-data .cell execution_count=3}\n``` {.python .cell-code code-summary=\"Simulate Vietnamese financial data (replace with DataCore.vn API calls)\"}\n# ============================================================================\n# In practice, replace this section with actual DataCore.vn API calls:\n#\n#   from datacore import DataCoreClient\n#   client = DataCoreClient(api_key=\"your_api_key\")\n#   financials = client.get_financial_statements(\n#       frequency=\"annual\",\n#       start_date=\"2005-01-01\",\n#       end_date=\"2024-12-31\"\n#   )\n#   market = client.get_market_data(frequency=\"daily\")\n#   profiles = client.get_company_profiles()\n#\n# For demonstration purposes, we simulate realistic Vietnamese market data.\n# ============================================================================\n\nnp.random.seed(42)\n\nn_firms = 300\nyears = range(2008, 2025)\nexchanges = [\"HOSE\", \"HNX\", \"UPCoM\"]\nindustries = [\n    \"Bất động sản\", \"Ngân hàng\", \"Thực phẩm & Đồ uống\",\n    \"Xây dựng & Vật liệu\", \"Công nghệ thông tin\", \"Bán lẻ\",\n    \"Dầu khí\", \"Thép\", \"Dệt may\", \"Dược phẩm\",\n    \"Điện lực\", \"Vận tải & Logistics\", \"Hóa chất\",\n    \"Chứng khoán\", \"Bảo hiểm\"\n]\n\n# Generate firm profiles\nfirm_ids = [f\"VN{str(i).zfill(4)}\" for i in range(1, n_firms + 1)]\nfirm_profiles = pd.DataFrame({\n    \"ticker\": firm_ids,\n    \"exchange\": np.random.choice(exchanges, n_firms, p=[0.5, 0.3, 0.2]),\n    \"industry\": np.random.choice(industries, n_firms),\n    \"founding_year\": np.random.randint(1975, 2015, n_firms),\n    \"listing_year\": np.random.randint(2000, 2020, n_firms),\n    \"state_ownership_pct\": np.clip(\n        np.random.beta(2, 5, n_firms) * 100, 0, 75\n    ).round(1),\n})\nfirm_profiles[\"listing_year\"] = np.maximum(\n    firm_profiles[\"listing_year\"],\n    firm_profiles[\"founding_year\"] + 1\n)\n\n# Generate panel data\nrecords = []\nfor _, firm in firm_profiles.iterrows():\n    start_year = max(firm[\"listing_year\"], 2008)\n    # Base financial characteristics (firm fixed effects)\n    base_ta = np.exp(np.random.normal(14, 1.5))  # Total assets in VND millions\n    base_profitability = np.random.normal(0.08, 0.05)\n    base_leverage = np.random.beta(3, 3)\n    base_turnover = np.random.gamma(2, 0.4)\n\n    for year in years:\n        if year < start_year:\n            continue\n        if np.random.random() < 0.02:  # 2% chance of delisting\n            break\n\n        # Time-varying components with persistence\n        shock = np.random.normal(0, 0.15)\n        growth = np.random.normal(0.08, 0.05)\n\n        ta = base_ta * (1 + growth) ** (year - start_year) * np.exp(shock)\n        profitability = np.clip(base_profitability + np.random.normal(0, 0.03), -0.3, 0.5)\n        leverage = np.clip(base_leverage + np.random.normal(0, 0.05), 0.05, 0.95)\n\n        lt = ta * leverage * np.random.uniform(0.4, 0.7)\n        total_liabilities = ta * leverage\n        ct_liabilities = total_liabilities - lt\n\n        seq = ta * (1 - leverage)\n        sale = ta * np.clip(base_turnover + np.random.normal(0, 0.1), 0.1, 5)\n        ebit = ta * profitability\n        ni = ebit * np.random.uniform(0.6, 0.9)\n        re = seq * np.random.uniform(-0.2, 0.8)\n        act = ta * np.random.uniform(0.2, 0.7)\n        lct = ct_liabilities\n\n        # Market value with noise and sentiment\n        market_premium = np.random.lognormal(0, 0.4)\n        me = seq * market_premium\n        prcc = me / max(np.random.uniform(50, 500), 1)\n        csho = me / max(prcc, 0.01)\n\n        # Preferred stock (rare in Vietnam, mostly zero)\n        pstk = 0 if np.random.random() > 0.05 else seq * np.random.uniform(0, 0.1)\n\n        # Net plant and equipment\n        ppent = ta * np.random.uniform(0.1, 0.6)\n        invt = ta * np.random.uniform(0.05, 0.3)\n\n        # Deferred taxes and investment tax credit (typically small in VN)\n        txdb = ta * np.random.uniform(0, 0.02)\n        itcb = 0\n\n        records.append({\n            \"ticker\": firm[\"ticker\"],\n            \"year\": year,\n            \"datadate\": pd.Timestamp(year, 12, 31),\n            \"at\": ta,            # Total Assets\n            \"seq\": seq,          # Stockholders' Equity\n            \"lt\": lt,            # Long-term Debt\n            \"lct\": lct,          # Current Liabilities\n            \"tlb\": total_liabilities,  # Total Liabilities\n            \"sale\": sale,        # Net Sales/Revenue\n            \"ebit\": ebit,        # EBIT\n            \"ni\": ni,            # Net Income\n            \"re_var\": re,        # Retained Earnings\n            \"act\": act,          # Current Assets\n            \"ppent\": ppent,      # Net Plant & Equipment\n            \"invt\": invt,        # Inventories\n            \"txdb\": txdb,        # Deferred Taxes\n            \"itcb\": itcb,        # Investment Tax Credit\n            \"pstk\": pstk,        # Preferred Stock\n            \"me\": me,            # Market Value of Equity\n            \"prcc\": prcc,        # Price at Calendar Year End\n            \"csho\": csho,        # Shares Outstanding\n        })\n\ndf = pd.DataFrame(records)\ndf = df.merge(firm_profiles[[\"ticker\", \"exchange\", \"industry\",\n                              \"founding_year\", \"listing_year\",\n                              \"state_ownership_pct\"]],\n              on=\"ticker\", how=\"left\")\n\nprint(f\"Panel dimensions: {df.shape[0]:,} firm-year observations\")\nprint(f\"Number of unique firms: {df['ticker'].nunique()}\")\nprint(f\"Year range: {df['year'].min()}–{df['year'].max()}\")\nprint(f\"Exchanges: {df['exchange'].value_counts().to_dict()}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nPanel dimensions: 3,484 firm-year observations\nNumber of unique firms: 297\nYear range: 2008–2024\nExchanges: {'HOSE': 1701, 'HNX': 1118, 'UPCoM': 665}\n```\n:::\n:::\n\n\n## Variable Definitions and Mapping\n\n@tbl-variable-mapping provides the mapping between standard variable names and the corresponding fields.\n\n::: {#tbl-variable-mapping .cell tbl-cap='Variable mapping' execution_count=4}\n``` {.python .cell-code}\nvariable_map = pd.DataFrame({\n    \"Compustat Variable\": [\n        \"AT\", \"SEQ\", \"LT\", \"LCT\", \"SALE\", \"EBIT\", \"NI\",\n        \"RE\", \"ACT\", \"PPENT\", \"INVT\", \"TXDB\", \"ITCB\",\n        \"PSTK/PSTKRV/PSTKL\", \"PRCC_C\", \"CSHO\", \"DLDTE\", \"DLRSN\"\n    ],\n    \"Description\": [\n        \"Total Assets\", \"Stockholders' Equity\", \"Long-term Debt\",\n        \"Current Liabilities\", \"Net Sales/Revenue\",\n        \"Earnings Before Interest & Taxes\", \"Net Income\",\n        \"Retained Earnings\", \"Current Assets\",\n        \"Net Plant & Equipment\", \"Total Inventories\",\n        \"Deferred Taxes\", \"Investment Tax Credit\",\n        \"Preferred Stock (various)\", \"Price Close (Calendar Year)\",\n        \"Common Shares Outstanding\", \"Delisting Date\",\n        \"Delisting Reason\"\n    ],\n    \"DataCore.vn Equivalent\": [\n        \"tong_tai_san\", \"von_chu_so_huu\", \"no_dai_han\",\n        \"no_ngan_han\", \"doanh_thu_thuan\",\n        \"loi_nhuan_truoc_thue_va_lai_vay\", \"loi_nhuan_sau_thue\",\n        \"loi_nhuan_chua_phan_phoi\", \"tai_san_ngan_han\",\n        \"tai_san_co_dinh_huu_hinh\", \"hang_ton_kho\",\n        \"thue_thu_nhap_hoan_lai\", \"N/A (not applicable in VAS)\",\n        \"co_phieu_uu_dai\", \"gia_dong_cua_cuoi_nam\",\n        \"so_luong_co_phieu_luu_hanh\", \"ngay_huy_niem_yet\",\n        \"ly_do_huy_niem_yet\"\n    ],\n    \"VAS Account\": [\n        \"BS.100\", \"BS.400\", \"BS.330\", \"BS.310\",\n        \"IS.10\", \"Computed\", \"IS.60\",\n        \"BS.421\", \"BS.100\", \"BS.221\", \"BS.141\",\n        \"BS.262\", \"—\", \"BS.411b\", \"Market\", \"Market\",\n        \"Profile\", \"Profile\"\n    ]\n})\n\nvariable_map.style.set_properties(**{\n    \"text-align\": \"left\",\n    \"font-size\": \"10pt\"\n}).set_table_styles([\n    {\"selector\": \"th\", \"props\": [\n        (\"background-color\", \"#1f77b4\"),\n        (\"color\", \"white\"),\n        (\"font-weight\", \"bold\"),\n        (\"text-align\", \"left\"),\n        (\"padding\", \"8px\")\n    ]},\n    {\"selector\": \"td\", \"props\": [(\"padding\", \"6px\")]},\n])\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n```{=html}\n<style type=\"text/css\">\n#T_4dfc1 th {\n  background-color: #1f77b4;\n  color: white;\n  font-weight: bold;\n  text-align: left;\n  padding: 8px;\n}\n#T_4dfc1 td {\n  padding: 6px;\n}\n#T_4dfc1_row0_col0, #T_4dfc1_row0_col1, #T_4dfc1_row0_col2, #T_4dfc1_row0_col3, #T_4dfc1_row1_col0, #T_4dfc1_row1_col1, #T_4dfc1_row1_col2, #T_4dfc1_row1_col3, #T_4dfc1_row2_col0, #T_4dfc1_row2_col1, #T_4dfc1_row2_col2, #T_4dfc1_row2_col3, #T_4dfc1_row3_col0, #T_4dfc1_row3_col1, #T_4dfc1_row3_col2, #T_4dfc1_row3_col3, #T_4dfc1_row4_col0, #T_4dfc1_row4_col1, #T_4dfc1_row4_col2, #T_4dfc1_row4_col3, #T_4dfc1_row5_col0, #T_4dfc1_row5_col1, #T_4dfc1_row5_col2, #T_4dfc1_row5_col3, #T_4dfc1_row6_col0, #T_4dfc1_row6_col1, #T_4dfc1_row6_col2, #T_4dfc1_row6_col3, #T_4dfc1_row7_col0, #T_4dfc1_row7_col1, #T_4dfc1_row7_col2, #T_4dfc1_row7_col3, #T_4dfc1_row8_col0, #T_4dfc1_row8_col1, #T_4dfc1_row8_col2, #T_4dfc1_row8_col3, #T_4dfc1_row9_col0, #T_4dfc1_row9_col1, #T_4dfc1_row9_col2, #T_4dfc1_row9_col3, #T_4dfc1_row10_col0, #T_4dfc1_row10_col1, #T_4dfc1_row10_col2, #T_4dfc1_row10_col3, #T_4dfc1_row11_col0, #T_4dfc1_row11_col1, #T_4dfc1_row11_col2, #T_4dfc1_row11_col3, #T_4dfc1_row12_col0, #T_4dfc1_row12_col1, #T_4dfc1_row12_col2, #T_4dfc1_row12_col3, #T_4dfc1_row13_col0, #T_4dfc1_row13_col1, #T_4dfc1_row13_col2, #T_4dfc1_row13_col3, #T_4dfc1_row14_col0, #T_4dfc1_row14_col1, #T_4dfc1_row14_col2, #T_4dfc1_row14_col3, #T_4dfc1_row15_col0, #T_4dfc1_row15_col1, #T_4dfc1_row15_col2, #T_4dfc1_row15_col3, #T_4dfc1_row16_col0, #T_4dfc1_row16_col1, #T_4dfc1_row16_col2, #T_4dfc1_row16_col3, #T_4dfc1_row17_col0, #T_4dfc1_row17_col1, #T_4dfc1_row17_col2, #T_4dfc1_row17_col3 {\n  text-align: left;\n  font-size: 10pt;\n}\n</style>\n<table id=\"T_4dfc1\">\n  <thead>\n    <tr>\n      <th class=\"blank level0\" >&nbsp;</th>\n      <th id=\"T_4dfc1_level0_col0\" class=\"col_heading level0 col0\" >Compustat Variable</th>\n      <th id=\"T_4dfc1_level0_col1\" class=\"col_heading level0 col1\" >Description</th>\n      <th id=\"T_4dfc1_level0_col2\" class=\"col_heading level0 col2\" >DataCore.vn Equivalent</th>\n      <th id=\"T_4dfc1_level0_col3\" class=\"col_heading level0 col3\" >VAS Account</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th id=\"T_4dfc1_level0_row0\" class=\"row_heading level0 row0\" >0</th>\n      <td id=\"T_4dfc1_row0_col0\" class=\"data row0 col0\" >AT</td>\n      <td id=\"T_4dfc1_row0_col1\" class=\"data row0 col1\" >Total Assets</td>\n      <td id=\"T_4dfc1_row0_col2\" class=\"data row0 col2\" >tong_tai_san</td>\n      <td id=\"T_4dfc1_row0_col3\" class=\"data row0 col3\" >BS.100</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row1\" class=\"row_heading level0 row1\" >1</th>\n      <td id=\"T_4dfc1_row1_col0\" class=\"data row1 col0\" >SEQ</td>\n      <td id=\"T_4dfc1_row1_col1\" class=\"data row1 col1\" >Stockholders' Equity</td>\n      <td id=\"T_4dfc1_row1_col2\" class=\"data row1 col2\" >von_chu_so_huu</td>\n      <td id=\"T_4dfc1_row1_col3\" class=\"data row1 col3\" >BS.400</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row2\" class=\"row_heading level0 row2\" >2</th>\n      <td id=\"T_4dfc1_row2_col0\" class=\"data row2 col0\" >LT</td>\n      <td id=\"T_4dfc1_row2_col1\" class=\"data row2 col1\" >Long-term Debt</td>\n      <td id=\"T_4dfc1_row2_col2\" class=\"data row2 col2\" >no_dai_han</td>\n      <td id=\"T_4dfc1_row2_col3\" class=\"data row2 col3\" >BS.330</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row3\" class=\"row_heading level0 row3\" >3</th>\n      <td id=\"T_4dfc1_row3_col0\" class=\"data row3 col0\" >LCT</td>\n      <td id=\"T_4dfc1_row3_col1\" class=\"data row3 col1\" >Current Liabilities</td>\n      <td id=\"T_4dfc1_row3_col2\" class=\"data row3 col2\" >no_ngan_han</td>\n      <td id=\"T_4dfc1_row3_col3\" class=\"data row3 col3\" >BS.310</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row4\" class=\"row_heading level0 row4\" >4</th>\n      <td id=\"T_4dfc1_row4_col0\" class=\"data row4 col0\" >SALE</td>\n      <td id=\"T_4dfc1_row4_col1\" class=\"data row4 col1\" >Net Sales/Revenue</td>\n      <td id=\"T_4dfc1_row4_col2\" class=\"data row4 col2\" >doanh_thu_thuan</td>\n      <td id=\"T_4dfc1_row4_col3\" class=\"data row4 col3\" >IS.10</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row5\" class=\"row_heading level0 row5\" >5</th>\n      <td id=\"T_4dfc1_row5_col0\" class=\"data row5 col0\" >EBIT</td>\n      <td id=\"T_4dfc1_row5_col1\" class=\"data row5 col1\" >Earnings Before Interest & Taxes</td>\n      <td id=\"T_4dfc1_row5_col2\" class=\"data row5 col2\" >loi_nhuan_truoc_thue_va_lai_vay</td>\n      <td id=\"T_4dfc1_row5_col3\" class=\"data row5 col3\" >Computed</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row6\" class=\"row_heading level0 row6\" >6</th>\n      <td id=\"T_4dfc1_row6_col0\" class=\"data row6 col0\" >NI</td>\n      <td id=\"T_4dfc1_row6_col1\" class=\"data row6 col1\" >Net Income</td>\n      <td id=\"T_4dfc1_row6_col2\" class=\"data row6 col2\" >loi_nhuan_sau_thue</td>\n      <td id=\"T_4dfc1_row6_col3\" class=\"data row6 col3\" >IS.60</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row7\" class=\"row_heading level0 row7\" >7</th>\n      <td id=\"T_4dfc1_row7_col0\" class=\"data row7 col0\" >RE</td>\n      <td id=\"T_4dfc1_row7_col1\" class=\"data row7 col1\" >Retained Earnings</td>\n      <td id=\"T_4dfc1_row7_col2\" class=\"data row7 col2\" >loi_nhuan_chua_phan_phoi</td>\n      <td id=\"T_4dfc1_row7_col3\" class=\"data row7 col3\" >BS.421</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row8\" class=\"row_heading level0 row8\" >8</th>\n      <td id=\"T_4dfc1_row8_col0\" class=\"data row8 col0\" >ACT</td>\n      <td id=\"T_4dfc1_row8_col1\" class=\"data row8 col1\" >Current Assets</td>\n      <td id=\"T_4dfc1_row8_col2\" class=\"data row8 col2\" >tai_san_ngan_han</td>\n      <td id=\"T_4dfc1_row8_col3\" class=\"data row8 col3\" >BS.100</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row9\" class=\"row_heading level0 row9\" >9</th>\n      <td id=\"T_4dfc1_row9_col0\" class=\"data row9 col0\" >PPENT</td>\n      <td id=\"T_4dfc1_row9_col1\" class=\"data row9 col1\" >Net Plant & Equipment</td>\n      <td id=\"T_4dfc1_row9_col2\" class=\"data row9 col2\" >tai_san_co_dinh_huu_hinh</td>\n      <td id=\"T_4dfc1_row9_col3\" class=\"data row9 col3\" >BS.221</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row10\" class=\"row_heading level0 row10\" >10</th>\n      <td id=\"T_4dfc1_row10_col0\" class=\"data row10 col0\" >INVT</td>\n      <td id=\"T_4dfc1_row10_col1\" class=\"data row10 col1\" >Total Inventories</td>\n      <td id=\"T_4dfc1_row10_col2\" class=\"data row10 col2\" >hang_ton_kho</td>\n      <td id=\"T_4dfc1_row10_col3\" class=\"data row10 col3\" >BS.141</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row11\" class=\"row_heading level0 row11\" >11</th>\n      <td id=\"T_4dfc1_row11_col0\" class=\"data row11 col0\" >TXDB</td>\n      <td id=\"T_4dfc1_row11_col1\" class=\"data row11 col1\" >Deferred Taxes</td>\n      <td id=\"T_4dfc1_row11_col2\" class=\"data row11 col2\" >thue_thu_nhap_hoan_lai</td>\n      <td id=\"T_4dfc1_row11_col3\" class=\"data row11 col3\" >BS.262</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row12\" class=\"row_heading level0 row12\" >12</th>\n      <td id=\"T_4dfc1_row12_col0\" class=\"data row12 col0\" >ITCB</td>\n      <td id=\"T_4dfc1_row12_col1\" class=\"data row12 col1\" >Investment Tax Credit</td>\n      <td id=\"T_4dfc1_row12_col2\" class=\"data row12 col2\" >N/A (not applicable in VAS)</td>\n      <td id=\"T_4dfc1_row12_col3\" class=\"data row12 col3\" >—</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row13\" class=\"row_heading level0 row13\" >13</th>\n      <td id=\"T_4dfc1_row13_col0\" class=\"data row13 col0\" >PSTK/PSTKRV/PSTKL</td>\n      <td id=\"T_4dfc1_row13_col1\" class=\"data row13 col1\" >Preferred Stock (various)</td>\n      <td id=\"T_4dfc1_row13_col2\" class=\"data row13 col2\" >co_phieu_uu_dai</td>\n      <td id=\"T_4dfc1_row13_col3\" class=\"data row13 col3\" >BS.411b</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row14\" class=\"row_heading level0 row14\" >14</th>\n      <td id=\"T_4dfc1_row14_col0\" class=\"data row14 col0\" >PRCC_C</td>\n      <td id=\"T_4dfc1_row14_col1\" class=\"data row14 col1\" >Price Close (Calendar Year)</td>\n      <td id=\"T_4dfc1_row14_col2\" class=\"data row14 col2\" >gia_dong_cua_cuoi_nam</td>\n      <td id=\"T_4dfc1_row14_col3\" class=\"data row14 col3\" >Market</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row15\" class=\"row_heading level0 row15\" >15</th>\n      <td id=\"T_4dfc1_row15_col0\" class=\"data row15 col0\" >CSHO</td>\n      <td id=\"T_4dfc1_row15_col1\" class=\"data row15 col1\" >Common Shares Outstanding</td>\n      <td id=\"T_4dfc1_row15_col2\" class=\"data row15 col2\" >so_luong_co_phieu_luu_hanh</td>\n      <td id=\"T_4dfc1_row15_col3\" class=\"data row15 col3\" >Market</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row16\" class=\"row_heading level0 row16\" >16</th>\n      <td id=\"T_4dfc1_row16_col0\" class=\"data row16 col0\" >DLDTE</td>\n      <td id=\"T_4dfc1_row16_col1\" class=\"data row16 col1\" >Delisting Date</td>\n      <td id=\"T_4dfc1_row16_col2\" class=\"data row16 col2\" >ngay_huy_niem_yet</td>\n      <td id=\"T_4dfc1_row16_col3\" class=\"data row16 col3\" >Profile</td>\n    </tr>\n    <tr>\n      <th id=\"T_4dfc1_level0_row17\" class=\"row_heading level0 row17\" >17</th>\n      <td id=\"T_4dfc1_row17_col0\" class=\"data row17 col0\" >DLRSN</td>\n      <td id=\"T_4dfc1_row17_col1\" class=\"data row17 col1\" >Delisting Reason</td>\n      <td id=\"T_4dfc1_row17_col2\" class=\"data row17 col2\" >ly_do_huy_niem_yet</td>\n      <td id=\"T_4dfc1_row17_col3\" class=\"data row17 col3\" >Profile</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n## Data Quality Checks\n\nBefore computing any measures, we perform essential data quality checks that are particularly important for Vietnamese data.\n\n::: {#data-quality-checks .cell execution_count=5}\n``` {.python .cell-code code-summary=\"Data quality validation\"}\ndef data_quality_report(df):\n    \"\"\"Generate a comprehensive data quality report.\"\"\"\n    report = {}\n\n    # Check for negative total assets\n    report[\"Negative total assets\"] = (df[\"at\"] < 0).sum()\n\n    # Check for negative equity (acceptable but noteworthy)\n    report[\"Negative equity\"] = (df[\"seq\"] <= 0).sum()\n\n    # Check for missing critical variables\n    critical_vars = [\"at\", \"seq\", \"sale\", \"ebit\", \"me\"]\n    for var in critical_vars:\n        report[f\"Missing {var}\"] = df[var].isna().sum()\n\n    # Check for extreme values (potential data errors)\n    report[\"Extreme leverage (>100%)\"] = (df[\"tlb\"] / df[\"at\"] > 1.0).sum()\n    report[\"Extreme sales/assets (>10)\"] = (df[\"sale\"] / df[\"at\"] > 10).sum()\n\n    return pd.Series(report, name=\"Count\")\n\nquality = data_quality_report(df)\nprint(\"Data Quality Report\")\nprint(\"=\" * 45)\nfor item, count in quality.items():\n    status = \"✓\" if count == 0 else \"⚠\"\n    print(f\"  {status} {item}: {count:,}\")\n\n# Apply filters\ndf_clean = df.copy()\ndf_clean = df_clean[df_clean[\"at\"] > 0]  # Positive total assets\ndf_clean = df_clean[df_clean[\"seq\"] > 0]  # Positive equity (for BE calculation)\nprint(f\"\\nObservations after cleaning: {len(df_clean):,} \"\n      f\"(dropped {len(df) - len(df_clean):,})\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nData Quality Report\n=============================================\n  ✓ Negative total assets: 0\n  ✓ Negative equity: 0\n  ✓ Missing at: 0\n  ✓ Missing seq: 0\n  ✓ Missing sale: 0\n  ✓ Missing ebit: 0\n  ✓ Missing me: 0\n  ✓ Extreme leverage (>100%): 0\n  ✓ Extreme sales/assets (>10): 0\n\nObservations after cleaning: 3,484 (dropped 0)\n```\n:::\n:::\n\n\n# Computing Tobin's Q {#sec-tobinq-computation}\n\n## Book Value of Equity\n\nFollowing @daniel1997evidence, we compute the book value of equity as:\n\n$$\nBE = SEQ + TXDB + ITCB - PREF\n$$ {#eq-book-equity}\n\nwhere $PREF$ is the preferred stock value, using the redemption value if available, otherwise the liquidating value, and finally the carrying value as a last resort. In the Vietnamese context, preferred stock is relatively rare among listed companies, so $PREF$ is often zero.\n\n::: {#compute-book-equity .cell execution_count=6}\n``` {.python .cell-code code-summary=\"Book value of equity computation\"}\ndef compute_book_equity(df):\n    \"\"\"\n    Compute book value of equity following Daniel and Titman (1997).\n\n    In Vietnam, preferred stock is uncommon among listed firms.\n    The investment tax credit (ITCB) is not applicable under VAS,\n    so we set it to zero when missing.\n    \"\"\"\n    result = df.copy()\n\n    # Preferred stock: use coalesce logic\n    result[\"pref\"] = result[\"pstk\"].fillna(0)\n\n    # Book equity = Shareholders' equity + Deferred taxes + ITC - Preferred\n    result[\"be\"] = (\n        result[\"seq\"]\n        + result[\"txdb\"].fillna(0)\n        + result[\"itcb\"].fillna(0)\n        - result[\"pref\"]\n    )\n\n    return result\n\ndf_clean = compute_book_equity(df_clean)\n\nprint(\"Book Equity Summary Statistics (VND millions)\")\nprint(df_clean[\"be\"].describe().apply(lambda x: f\"{x:,.0f}\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nBook Equity Summary Statistics (VND millions)\ncount          3,484\nmean       3,521,607\nstd        9,055,435\nmin            4,633\n25%          386,441\n50%        1,112,062\n75%        3,210,269\nmax      247,845,397\nName: be, dtype: str\n```\n:::\n:::\n\n\n## Market Value of Equity\n\nThe market value of equity is computed using the calendar year-end stock price and shares outstanding:\n\n$$\nME = P_{\\text{close}} \\times \\text{CSHO}\n$$ {#eq-market-equity}\n\nFor Vietnamese firms, this is obtained from the closing price on the last trading day of the fiscal year. Most Vietnamese firms have a December 31 fiscal year end, though some (particularly in agriculture and banking) may differ.\n\n::: {#compute-market-equity .cell execution_count=7}\n``` {.python .cell-code code-summary=\"Market value of equity computation\"}\n# ME is already computed in our simulated data as prcc * csho\n# In practice with DataCore.vn:\n#   me = df[\"gia_dong_cua_cuoi_nam\"] * df[\"so_luong_co_phieu_luu_hanh\"]\n\ndf_clean[\"me\"] = df_clean[\"prcc\"] * df_clean[\"csho\"]\n\nprint(\"Market Equity Summary Statistics (VND millions)\")\nprint(df_clean[\"me\"].describe().apply(lambda x: f\"{x:,.0f}\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nMarket Equity Summary Statistics (VND millions)\ncount          3,484\nmean       3,653,445\nstd        9,747,318\nmin            3,379\n25%          370,119\n50%        1,106,646\n75%        3,029,093\nmax      286,258,816\nName: me, dtype: str\n```\n:::\n:::\n\n\n## Simplified Tobin's Q\n\nWe implement the @gompers2003corporate simplified version:\n\n$$\nQ_{\\text{simple}} = \\frac{AT + ME - BE}{AT}\n$$ {#eq-tobinq-implementation}\n\nThis can be rewritten as:\n\n$$\nQ_{\\text{simple}} = 1 + \\frac{ME - BE}{AT}\n$$ {#eq-tobinq-rewritten}\n\nwhich makes the interpretation clear: Tobin's Q equals one plus the market-to-book premium (or discount) scaled by total assets.\n\n::: {#compute-tobinq .cell execution_count=8}\n``` {.python .cell-code code-summary=\"Tobin's Q computation with multiple variants\"}\ndef compute_tobins_q(df):\n    \"\"\"\n    Compute multiple variants of Tobin's Q.\n\n    Variants:\n    1. Simple Q (Gompers et al., 2003)\n    2. Chung-Pruitt Q\n    3. Market-to-Book ratio (for comparison)\n    \"\"\"\n    result = df.copy()\n\n    # --- Variant 1: Simple Q (Gompers, Ishii, Metrick 2003) ---\n    result[\"tobin_q_simple\"] = (result[\"at\"] + result[\"me\"] - result[\"be\"]) / result[\"at\"]\n\n    # --- Variant 2: Chung-Pruitt Approximation ---\n    # DEBT = Current Liabilities - Current Assets + Inventories + LT Debt\n    result[\"debt_cp\"] = (\n        result[\"lct\"].fillna(0)\n        - result[\"act\"].fillna(0)\n        + result[\"invt\"].fillna(0)\n        + result[\"lt\"].fillna(0)\n    )\n    result[\"tobin_q_cp\"] = (\n        (result[\"me\"] + result[\"pstk\"].fillna(0) + result[\"debt_cp\"]) / result[\"at\"]\n    )\n\n    # --- Market-to-Book Ratio ---\n    result[\"mtb\"] = np.where(result[\"be\"] > 0, result[\"me\"] / result[\"be\"], np.nan)\n\n    return result\n\ndf_clean = compute_tobins_q(df_clean)\n\n# Summary statistics\nq_vars = [\"tobin_q_simple\", \"tobin_q_cp\", \"mtb\"]\nq_summary = df_clean[q_vars].describe(percentiles=[0.01, 0.05, 0.25, 0.5, 0.75, 0.95, 0.99])\nq_summary = q_summary.round(3)\nq_summary.columns = [\"Simple Q\", \"Chung-Pruitt Q\", \"Market-to-Book\"]\n\nprint(\"Tobin's Q Summary Statistics\")\nprint(q_summary.to_string())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTobin's Q Summary Statistics\n       Simple Q  Chung-Pruitt Q  Market-to-Book\ncount  3484.000        3484.000        3484.000\nmean      1.031           0.766           1.058\nstd       0.243           0.296           0.445\nmin       0.357           0.008           0.233\n1%        0.602           0.189           0.382\n5%        0.713           0.332           0.496\n25%       0.886           0.568           0.742\n50%       0.989           0.738           0.974\n75%       1.132           0.926           1.287\n95%       1.481           1.290           1.904\n99%       1.916           1.668           2.492\nmax       2.804           2.433           3.189\n```\n:::\n:::\n\n\n## Winsorizing Extreme Values\n\nTobin's Q values can be heavily influenced by outliers, particularly in emerging markets where data quality may be inconsistent. We winsorize at the 1st and 99th percentiles.\n\n::: {#winsorize .cell execution_count=9}\n``` {.python .cell-code code-summary=\"Winsorization of extreme values\"}\ndef winsorize(series, lower=0.01, upper=0.99):\n    \"\"\"Winsorize a pandas Series at specified percentiles.\"\"\"\n    low = series.quantile(lower)\n    high = series.quantile(upper)\n    return series.clip(lower=low, upper=high)\n\n# Winsorize Q measures\nfor var in [\"tobin_q_simple\", \"tobin_q_cp\", \"mtb\"]:\n    df_clean[f\"{var}_w\"] = winsorize(df_clean[var])\n\nprint(\"Effect of Winsorization on Simple Tobin's Q:\")\nprint(f\"  Before: mean={df_clean['tobin_q_simple'].mean():.3f}, \"\n      f\"std={df_clean['tobin_q_simple'].std():.3f}\")\nprint(f\"  After:  mean={df_clean['tobin_q_simple_w'].mean():.3f}, \"\n      f\"std={df_clean['tobin_q_simple_w'].std():.3f}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nEffect of Winsorization on Simple Tobin's Q:\n  Before: mean=1.031, std=0.243\n  After:  mean=1.030, std=0.233\n```\n:::\n:::\n\n\n## Cross-Sectional Distribution of Tobin's Q\n\n::: {.cell execution_count=10}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 2, figsize=(14, 5))\n\n# Latest year distribution\nlatest_year = df_clean[\"year\"].max()\nlatest_data = df_clean[df_clean[\"year\"] == latest_year]\n\n# Histogram\naxes[0].hist(\n    latest_data[\"tobin_q_simple_w\"].dropna(),\n    bins=50, color=colors[\"primary\"], alpha=0.7, edgecolor=\"white\"\n)\naxes[0].axvline(x=1, color=colors[\"quaternary\"], linestyle=\"--\", linewidth=2, label=\"Q = 1\")\naxes[0].set_xlabel(\"Tobin's Q (Simple)\")\naxes[0].set_ylabel(\"Number of Firms\")\naxes[0].set_title(f\"Cross-Sectional Distribution ({latest_year})\")\naxes[0].legend()\n\n# Box plot by exchange\nexchange_data = latest_data[[\"exchange\", \"tobin_q_simple_w\"]].dropna()\nexchanges_sorted = exchange_data.groupby(\"exchange\")[\"tobin_q_simple_w\"].median().sort_values().index\n\nbox_data = [exchange_data[exchange_data[\"exchange\"] == ex][\"tobin_q_simple_w\"].values\n            for ex in exchanges_sorted]\n\nbp = axes[1].boxplot(box_data, labels=exchanges_sorted, patch_artist=True,\n                     medianprops=dict(color=\"black\", linewidth=2))\nbox_colors = [colors[\"primary\"], colors[\"secondary\"], colors[\"tertiary\"]]\nfor patch, color in zip(bp[\"boxes\"], box_colors):\n    patch.set_facecolor(color)\n    patch.set_alpha(0.7)\n\naxes[1].axhline(y=1, color=colors[\"quaternary\"], linestyle=\"--\", linewidth=1.5, alpha=0.7)\naxes[1].set_ylabel(\"Tobin's Q (Simple)\")\naxes[1].set_title(f\"Tobin's Q by Exchange ({latest_year})\")\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Distribution of Tobin's Q across Vietnamese listed firms (2024). The vertical dashed line at Q=1 indicates the theoretical threshold where market value equals replacement cost.](36_valuation_files/figure-pdf/fig-tobinq-distribution-output-1.pdf){#fig-tobinq-distribution fig-pos='H'}\n:::\n:::\n\n\n## Time-Series Evolution of Tobin's Q\n\n::: {.cell execution_count=11}\n``` {.python .cell-code}\n# Compute annual statistics by exchange\nannual_q = (\n    df_clean\n    .groupby([\"year\", \"exchange\"])[\"tobin_q_simple_w\"]\n    .agg([\"median\", lambda x: x.quantile(0.25), lambda x: x.quantile(0.75)])\n    .reset_index()\n)\nannual_q.columns = [\"year\", \"exchange\", \"median\", \"q25\", \"q75\"]\n\nfig, ax = plt.subplots(figsize=(12, 6))\n\nexchange_colors = {\"HOSE\": colors[\"primary\"], \"HNX\": colors[\"secondary\"],\n                   \"UPCoM\": colors[\"tertiary\"]}\n\nfor exchange, color in exchange_colors.items():\n    data = annual_q[annual_q[\"exchange\"] == exchange]\n    ax.plot(data[\"year\"], data[\"median\"], color=color, linewidth=2.5,\n            label=exchange, marker=\"o\", markersize=4)\n    ax.fill_between(data[\"year\"], data[\"q25\"], data[\"q75\"],\n                    color=color, alpha=0.15)\n\nax.axhline(y=1, color=\"gray\", linestyle=\"--\", linewidth=1, alpha=0.7, label=\"Q = 1\")\nax.set_xlabel(\"Year\")\nax.set_ylabel(\"Tobin's Q (Median)\")\nax.set_title(\"Evolution of Tobin's Q in the Vietnamese Market\")\nax.legend(loc=\"upper right\")\nax.set_xlim(2008, latest_year)\nax.xaxis.set_major_locator(mticker.MultipleLocator(2))\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Evolution of median Tobin's Q across Vietnamese exchanges (2008–2024). Shaded areas represent the interquartile range.](36_valuation_files/figure-pdf/fig-tobinq-timeseries-output-1.pdf){#fig-tobinq-timeseries fig-pos='H'}\n:::\n:::\n\n\n## Tobin's Q by Industry\n\n::: {.cell execution_count=12}\n``` {.python .cell-code}\nlatest_industry_q = (\n    latest_data\n    .groupby(\"industry\")[\"tobin_q_simple_w\"]\n    .agg([\"median\", \"mean\", \"count\"])\n    .reset_index()\n    .sort_values(\"median\", ascending=True)\n)\n\nfig, ax = plt.subplots(figsize=(10, 8))\n\nbar_colors = [colors[\"quaternary\"] if m < 1 else colors[\"primary\"]\n              for m in latest_industry_q[\"median\"]]\n\nax.barh(\n    latest_industry_q[\"industry\"],\n    latest_industry_q[\"median\"],\n    color=bar_colors, alpha=0.8, edgecolor=\"white\"\n)\nax.axvline(x=1, color=\"gray\", linestyle=\"--\", linewidth=1.5, alpha=0.7)\nax.set_xlabel(\"Median Tobin's Q\")\nax.set_title(f\"Tobin's Q by Industry ({latest_year})\")\n\n# Add count annotations\nfor i, (_, row) in enumerate(latest_industry_q.iterrows()):\n    ax.text(row[\"median\"] + 0.02, i, f'n={int(row[\"count\"])}',\n            va=\"center\", fontsize=9, color=\"gray\")\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Median Tobin's Q by industry in Vietnam (latest available year). Industries are sorted by median Q value.](36_valuation_files/figure-pdf/fig-tobinq-industry-output-1.pdf){#fig-tobinq-industry fig-pos='H'}\n:::\n:::\n\n\n# Computing the Altman Z-Score {#sec-zscore-computation}\n\n## Original Z-Score for Listed Firms\n\n::: {#compute-zscore .cell execution_count=13}\n``` {.python .cell-code code-summary=\"Altman Z-Score computation (all three variants)\"}\ndef compute_altman_z(df):\n    \"\"\"\n    Compute three variants of the Altman Z-Score:\n    1. Original Z-Score (for listed manufacturing firms)\n    2. Z'-Score (for private firms, using book equity)\n    3. Z''-Score (for emerging markets / non-manufacturing)\n    \"\"\"\n    result = df.copy()\n\n    # Common components\n    result[\"wc\"] = result[\"act\"].fillna(0) - result[\"lct\"].fillna(0)  # Working Capital\n\n    # --- Original Z-Score ---\n    # Z = 3.3*(EBIT/TA) + 0.999*(Sales/TA) + 0.6*(ME/TL) + 1.2*(WC/TA) + 1.4*(RE/TA)\n    x1 = result[\"ebit\"] / result[\"at\"]\n    x2 = result[\"sale\"] / result[\"at\"]\n    x3 = np.where(result[\"tlb\"] > 0, result[\"me\"] / result[\"tlb\"], np.nan)\n    x4 = result[\"wc\"] / result[\"at\"]\n    x5 = result[\"re_var\"].fillna(0) / result[\"at\"]\n\n    result[\"z_x1\"] = x1  # Earning power\n    result[\"z_x2\"] = x2  # Asset turnover\n    result[\"z_x3\"] = x3  # Leverage (inverse)\n    result[\"z_x4\"] = x4  # Liquidity\n    result[\"z_x5\"] = x5  # Cumulative profitability\n\n    result[\"altman_z\"] = (3.3 * x1 + 0.999 * x2 + 0.6 * x3 + 1.2 * x4 + 1.4 * x5)\n\n    # --- Z'-Score (Private firms) ---\n    x3_prime = np.where(result[\"tlb\"] > 0, result[\"be\"] / result[\"tlb\"], np.nan)\n    result[\"altman_z_prime\"] = (\n        0.717 * x4 + 0.847 * x5 + 3.107 * x1 + 0.420 * x3_prime + 0.998 * x2\n    )\n\n    # --- Z''-Score (Emerging Markets) ---\n    result[\"altman_z_em\"] = (\n        3.25\n        + 6.56 * x4   # Working Capital / TA\n        + 3.26 * x5   # Retained Earnings / TA\n        + 6.72 * x1   # EBIT / TA\n        + 1.05 * x3_prime  # Book Equity / TL\n    )\n\n    # Classify risk zones\n    result[\"z_zone\"] = pd.cut(\n        result[\"altman_z\"],\n        bins=[-np.inf, 1.80, 2.70, 2.99, np.inf],\n        labels=[\"High Distress\", \"Distress\", \"Grey Zone\", \"Safe\"]\n    )\n\n    result[\"z_em_zone\"] = pd.cut(\n        result[\"altman_z_em\"],\n        bins=[-np.inf, 1.10, 2.60, np.inf],\n        labels=[\"Distress\", \"Grey Zone\", \"Safe\"]\n    )\n\n    return result\n\ndf_clean = compute_altman_z(df_clean)\n\n# Winsorize Z-scores\nfor var in [\"altman_z\", \"altman_z_prime\", \"altman_z_em\"]:\n    df_clean[f\"{var}_w\"] = winsorize(df_clean[var])\n\nprint(\"Z-Score Summary Statistics\")\nz_summary = df_clean[[\"altman_z\", \"altman_z_prime\", \"altman_z_em\"]].describe().round(3)\nz_summary.columns = [\"Original Z\", \"Z' (Private)\", \"Z'' (Emerging)\"]\nprint(z_summary.to_string())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nZ-Score Summary Statistics\n       Original Z  Z' (Private)  Z'' (Emerging)\ncount    3484.000      3484.000        3484.000\nmean        2.610         2.042           7.467\nstd         1.896         1.194           3.137\nmin         0.059         0.155           1.578\n25%         1.595         1.314           5.670\n50%         2.212         1.806           6.987\n75%         3.028         2.410           8.549\nmax        28.640        11.119          29.686\n```\n:::\n:::\n\n\n## Z-Score Component Analysis\n\nUnderstanding which components drive the Z-Score is particularly informative in the Vietnamese context, where certain ratios may behave differently than in developed markets.\n\n::: {.cell execution_count=14}\n``` {.python .cell-code}\nfig, axes = plt.subplots(2, 3, figsize=(15, 9))\n\ncomponents = [\n    (\"z_x1\", 3.3, \"$3.3 \\\\times$ EBIT/TA\\n(Earning Power)\"),\n    (\"z_x2\", 0.999, \"$0.999 \\\\times$ Sales/TA\\n(Asset Turnover)\"),\n    (\"z_x3\", 0.6, \"$0.6 \\\\times$ ME/TL\\n(Leverage)\"),\n    (\"z_x4\", 1.2, \"$1.2 \\\\times$ WC/TA\\n(Liquidity)\"),\n    (\"z_x5\", 1.4, \"$1.4 \\\\times$ RE/TA\\n(Cum. Profitability)\"),\n]\n\nlatest_z = df_clean[df_clean[\"year\"] == latest_year]\n\nfor idx, (var, weight, label) in enumerate(components):\n    ax = axes[idx // 3, idx % 3]\n    weighted_vals = (latest_z[var] * weight).dropna()\n    weighted_vals = weighted_vals[weighted_vals.between(\n        weighted_vals.quantile(0.01), weighted_vals.quantile(0.99)\n    )]\n    ax.hist(weighted_vals, bins=40, color=colors[\"primary\"], alpha=0.7, edgecolor=\"white\")\n    ax.axvline(x=weighted_vals.median(), color=colors[\"quaternary\"],\n               linestyle=\"--\", linewidth=2, label=f\"Median: {weighted_vals.median():.2f}\")\n    ax.set_title(label, fontsize=11)\n    ax.legend(fontsize=9)\n\n# Remove empty subplot\naxes[1, 2].set_visible(False)\n\nplt.suptitle(f\"Z-Score Component Distributions ({latest_year})\", fontsize=14, y=1.02)\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Distribution of Altman Z-Score component ratios for Vietnamese listed firms. Each panel shows a component weighted by its coefficient in the original Z-Score formula.](36_valuation_files/figure-pdf/fig-zscore-components-output-1.pdf){#fig-zscore-components fig-pos='H'}\n:::\n:::\n\n\n## Distribution of Risk Zones\n\n::: {.cell execution_count=15}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\n\n# --- Original Z-Score Zones ---\nzone_counts = (\n    df_clean\n    .groupby([\"year\", \"z_zone\"])\n    .size()\n    .unstack(fill_value=0)\n)\nzone_pcts = zone_counts.div(zone_counts.sum(axis=1), axis=0) * 100\n\nzone_colors = {\n    \"Safe\": colors[\"safe\"],\n    \"Grey Zone\": colors[\"alert\"],\n    \"Distress\": colors[\"quaternary\"],\n    \"High Distress\": colors[\"distress\"],\n}\n\naxes[0].stackplot(\n    zone_pcts.index,\n    *[zone_pcts[col] for col in [\"Safe\", \"Grey Zone\", \"Distress\", \"High Distress\"]\n      if col in zone_pcts.columns],\n    labels=[col for col in [\"Safe\", \"Grey Zone\", \"Distress\", \"High Distress\"]\n            if col in zone_pcts.columns],\n    colors=[zone_colors[col] for col in [\"Safe\", \"Grey Zone\", \"Distress\", \"High Distress\"]\n            if col in zone_pcts.columns],\n    alpha=0.8\n)\naxes[0].set_xlabel(\"Year\")\naxes[0].set_ylabel(\"Percentage of Firms\")\naxes[0].set_title(\"Original Z-Score Risk Zones\")\naxes[0].legend(loc=\"upper right\", fontsize=9)\naxes[0].set_ylim(0, 100)\n\n# --- Emerging Market Z''-Score Zones ---\nem_zone_counts = (\n    df_clean\n    .groupby([\"year\", \"z_em_zone\"])\n    .size()\n    .unstack(fill_value=0)\n)\nem_zone_pcts = em_zone_counts.div(em_zone_counts.sum(axis=1), axis=0) * 100\n\nem_zone_colors = {\"Safe\": colors[\"safe\"], \"Grey Zone\": colors[\"alert\"],\n                  \"Distress\": colors[\"quaternary\"]}\n\naxes[1].stackplot(\n    em_zone_pcts.index,\n    *[em_zone_pcts[col] for col in [\"Safe\", \"Grey Zone\", \"Distress\"]\n      if col in em_zone_pcts.columns],\n    labels=[col for col in [\"Safe\", \"Grey Zone\", \"Distress\"]\n            if col in em_zone_pcts.columns],\n    colors=[em_zone_colors[col] for col in [\"Safe\", \"Grey Zone\", \"Distress\"]\n            if col in em_zone_pcts.columns],\n    alpha=0.8\n)\naxes[1].set_xlabel(\"Year\")\naxes[1].set_ylabel(\"Percentage of Firms\")\naxes[1].set_title(\"Emerging Market Z''-Score Risk Zones\")\naxes[1].legend(loc=\"upper right\", fontsize=9)\naxes[1].set_ylim(0, 100)\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Proportion of Vietnamese listed firms in each Altman Z-Score risk zone over time. The figure shows both the original Z-Score zones and the emerging market Z''-Score zones.](36_valuation_files/figure-pdf/fig-zscore-zones-output-1.pdf){#fig-zscore-zones fig-pos='H'}\n:::\n:::\n\n\n## Comparing Z-Score Variants\n\nAn important practical question is which Z-Score variant is most appropriate for Vietnamese firms. The original model was calibrated on U.S. manufacturing firms, while the Z''-Score was specifically designed for emerging markets and non-manufacturing sectors.\n\n::: {.cell execution_count=16}\n``` {.python .cell-code}\nfig, ax = plt.subplots(figsize=(8, 8))\n\nsample = latest_z.dropna(subset=[\"altman_z_w\", \"altman_z_em_w\"]).sample(\n    min(500, len(latest_z)), random_state=42\n)\n\nscatter = ax.scatter(\n    sample[\"altman_z_w\"], sample[\"altman_z_em_w\"],\n    c=sample[\"tobin_q_simple_w\"], cmap=\"RdYlGn\",\n    alpha=0.6, s=30, edgecolor=\"white\", linewidth=0.3\n)\n\n# Add reference lines\nlims = [\n    min(ax.get_xlim()[0], ax.get_ylim()[0]),\n    max(ax.get_xlim()[1], ax.get_ylim()[1])\n]\nax.plot(lims, lims, \"k--\", alpha=0.3, linewidth=1, label=\"45° line\")\n\n# Add zone boundaries\nax.axvline(x=1.80, color=\"red\", linestyle=\":\", alpha=0.5, linewidth=1)\nax.axvline(x=2.99, color=\"green\", linestyle=\":\", alpha=0.5, linewidth=1)\nax.axhline(y=1.10, color=\"red\", linestyle=\":\", alpha=0.5, linewidth=1)\nax.axhline(y=2.60, color=\"green\", linestyle=\":\", alpha=0.5, linewidth=1)\n\nax.set_xlabel(\"Original Z-Score\")\nax.set_ylabel(\"Emerging Market Z''-Score\")\nax.set_title(\"Z-Score vs Z''-Score for Vietnamese Firms\")\n\ncbar = plt.colorbar(scatter, ax=ax, shrink=0.8)\ncbar.set_label(\"Tobin's Q\")\n\nax.legend(loc=\"upper left\")\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Comparison of original Z-Score and emerging market Z''-Score for Vietnamese listed firms. Points above (below) the 45-degree line have higher Z''-Scores (Z-Scores) than the other measure.](36_valuation_files/figure-pdf/fig-zscore-comparison-output-1.pdf){#fig-zscore-comparison fig-pos='H'}\n:::\n:::\n\n\n# Computing Company Age {#sec-age-computation}\n\n## Multiple Age Proxies\n\nFor Vietnamese firms, we compute three age measures:\n\n$$\n\\text{Age}_{\\text{founding}} = \\text{Current Year} - \\text{Founding Year}\n$$ {#eq-age-founding}\n\n$$\n\\text{Age}_{\\text{listing}} = \\text{Current Year} - \\text{Listing Year}\n$$ {#eq-age-listing}\n\n$$\n\\text{Age}_{\\text{data}} = \\text{Current Year} - \\text{First Year with Data}\n$$ {#eq-age-data}\n\n::: {#compute-age .cell execution_count=17}\n``` {.python .cell-code code-summary=\"Company age computation with multiple proxies\"}\ndef compute_company_age(df):\n    \"\"\"\n    Compute multiple proxies for company age.\n\n    For Vietnamese firms:\n    - Founding age: based on founding/incorporation date\n    - Listing age: based on first listing on HOSE/HNX/UPCoM\n    - Data age: based on first year with available financial data\n    \"\"\"\n    result = df.copy()\n\n    # Founding age\n    result[\"age_founding\"] = result[\"year\"] - result[\"founding_year\"]\n\n    # Listing age\n    result[\"age_listing\"] = result[\"year\"] - result[\"listing_year\"]\n    result[\"age_listing\"] = result[\"age_listing\"].clip(lower=0)\n\n    # Data age (years since first available financial data)\n    first_year = result.groupby(\"ticker\")[\"year\"].transform(\"min\")\n    result[\"age_data\"] = result[\"year\"] - first_year\n\n    # Log of age (commonly used in regressions)\n    result[\"ln_age_founding\"] = np.log1p(result[\"age_founding\"])\n    result[\"ln_age_listing\"] = np.log1p(result[\"age_listing\"])\n\n    return result\n\ndf_clean = compute_company_age(df_clean)\n\nprint(\"Company Age Summary Statistics\")\nage_summary = df_clean[df_clean[\"year\"] == latest_year][\n    [\"age_founding\", \"age_listing\", \"age_data\"]\n].describe().round(1)\nage_summary.columns = [\"Founding Age\", \"Listing Age\", \"Data Age\"]\nprint(age_summary.to_string())\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCompany Age Summary Statistics\n       Founding Age  Listing Age  Data Age\ncount         232.0        232.0     232.0\nmean           30.1         13.9      12.3\nstd            11.6          5.8       3.9\nmin            10.0          5.0       5.0\n25%            20.0          9.0       9.0\n50%            30.0         13.0      13.0\n75%            40.0         19.0      16.0\nmax            49.0         24.0      16.0\n```\n:::\n:::\n\n\n## Age Distribution\n\n::: {.cell execution_count=18}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 3, figsize=(15, 5))\n\nage_vars = [\n    (\"age_founding\", \"Founding Age (years)\", colors[\"primary\"]),\n    (\"age_listing\", \"Listing Age (years)\", colors[\"secondary\"]),\n    (\"age_data\", \"Data Age (years)\", colors[\"tertiary\"]),\n]\n\nlatest = df_clean[df_clean[\"year\"] == latest_year]\n\nfor ax, (var, label, color) in zip(axes, age_vars):\n    data = latest[var].dropna()\n    ax.hist(data, bins=30, color=color, alpha=0.7, edgecolor=\"white\")\n    ax.axvline(x=data.median(), color=\"black\", linestyle=\"--\",\n               linewidth=2, label=f\"Median: {data.median():.0f}\")\n    ax.set_xlabel(label)\n    ax.set_ylabel(\"Number of Firms\")\n    ax.legend()\n\naxes[0].set_title(\"Founding Age\")\naxes[1].set_title(\"Listing Age\")\naxes[2].set_title(\"Data Age\")\n\nplt.suptitle(f\"Company Age Distributions ({latest_year})\", fontsize=14, y=1.02)\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Distribution of company age measures for Vietnamese listed firms. Founding age reflects true organizational maturity, while listing age captures capital market experience.](36_valuation_files/figure-pdf/fig-age-distribution-output-1.pdf){#fig-age-distribution fig-pos='H'}\n:::\n:::\n\n\n## Age and the Equitization Effect\n\nA distinctive feature of the Vietnamese market is the equitization of SOEs. Many firms have founding dates that predate the stock market by decades, creating a large gap between founding age and listing age.\n\n::: {.cell execution_count=19}\n``` {.python .cell-code}\nfig, ax = plt.subplots(figsize=(8, 8))\n\nlatest = df_clean[df_clean[\"year\"] == latest_year].copy()\nlatest[\"soe_flag\"] = latest[\"state_ownership_pct\"] > 30  # SOE proxy\n\nfor soe, label, color, marker in [\n    (True, \"SOE (>30% state)\", colors[\"quaternary\"], \"s\"),\n    (False, \"Non-SOE\", colors[\"primary\"], \"o\"),\n]:\n    subset = latest[latest[\"soe_flag\"] == soe]\n    ax.scatter(\n        subset[\"age_listing\"], subset[\"age_founding\"],\n        c=color, alpha=0.5, s=25, marker=marker, label=label, edgecolor=\"white\"\n    )\n\n# 45-degree line\nmax_age = max(latest[\"age_founding\"].max(), latest[\"age_listing\"].max())\nax.plot([0, max_age], [0, max_age], \"k--\", alpha=0.3, label=\"Founding = Listing age\")\n\nax.set_xlabel(\"Listing Age (years)\")\nax.set_ylabel(\"Founding Age (years)\")\nax.set_title(\"Founding vs. Listing Age: The Equitization Gap\")\nax.legend()\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Relationship between founding age and listing age for Vietnamese firms. The gap reflects years of pre-listing operations, which is especially large for equitized state-owned enterprises.](36_valuation_files/figure-pdf/fig-age-gap-output-1.pdf){#fig-age-gap fig-pos='H'}\n:::\n:::\n\n\n# Joint Analysis: Valuation, Distress, and Maturity {#sec-joint-analysis}\n\n## The Relationship Between Q, Z-Score, and Age\n\nThese three measures capture different dimensions of a firm's financial standing, but they are not independent. Theoretically, we expect:\n\n-   **Q and Z**: Firms with high growth opportunities (high Q) tend to be financially healthier (high Z), but the relationship is not monotonic, very high Q values may indicate speculative overvaluation.\n-   **Q and Age**: Young firms may have higher Q (growth expectations) or lower Q (unproven business model). The relationship depends on the industry life cycle.\n-   **Z and Age**: Older firms typically have more stable earnings and higher retained earnings, contributing to higher Z-Scores, though very old firms may face declining competitiveness.\n\n::: {.cell execution_count=20}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 3, figsize=(16, 5))\n\nsample = latest.dropna(subset=[\"tobin_q_simple_w\", \"altman_z_w\", \"age_founding\"])\nsample = sample.sample(min(300, len(sample)), random_state=42)\n\n# Q vs Z\naxes[0].scatter(\n    sample[\"altman_z_w\"], sample[\"tobin_q_simple_w\"],\n    c=sample[\"age_founding\"], cmap=\"viridis\", alpha=0.6,\n    s=np.log1p(sample[\"at\"]) * 3, edgecolor=\"white\", linewidth=0.3\n)\naxes[0].set_xlabel(\"Altman Z-Score\")\naxes[0].set_ylabel(\"Tobin's Q\")\naxes[0].set_title(\"Valuation vs. Distress Risk\")\naxes[0].axhline(y=1, color=\"gray\", linestyle=\"--\", alpha=0.5)\naxes[0].axvline(x=1.80, color=\"red\", linestyle=\":\", alpha=0.5)\naxes[0].axvline(x=2.99, color=\"green\", linestyle=\":\", alpha=0.5)\n\n# Q vs Age\naxes[1].scatter(\n    sample[\"age_founding\"], sample[\"tobin_q_simple_w\"],\n    c=sample[\"altman_z_w\"], cmap=\"RdYlGn\", alpha=0.6,\n    s=np.log1p(sample[\"at\"]) * 3, edgecolor=\"white\", linewidth=0.3\n)\naxes[1].set_xlabel(\"Founding Age (years)\")\naxes[1].set_ylabel(\"Tobin's Q\")\naxes[1].set_title(\"Valuation vs. Maturity\")\naxes[1].axhline(y=1, color=\"gray\", linestyle=\"--\", alpha=0.5)\n\n# Z vs Age\nscatter = axes[2].scatter(\n    sample[\"age_founding\"], sample[\"altman_z_w\"],\n    c=sample[\"tobin_q_simple_w\"], cmap=\"coolwarm\", alpha=0.6,\n    s=np.log1p(sample[\"at\"]) * 3, edgecolor=\"white\", linewidth=0.3\n)\naxes[2].set_xlabel(\"Founding Age (years)\")\naxes[2].set_ylabel(\"Altman Z-Score\")\naxes[2].set_title(\"Distress Risk vs. Maturity\")\naxes[2].axhline(y=1.80, color=\"red\", linestyle=\":\", alpha=0.5)\naxes[2].axhline(y=2.99, color=\"green\", linestyle=\":\", alpha=0.5)\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Relationship between Tobin's Q, Altman Z-Score, and company age for Vietnamese listed firms. Bubble size reflects total assets; color indicates the emerging market Z''-Score risk zone.](36_valuation_files/figure-pdf/fig-joint-analysis-output-1.pdf){#fig-joint-analysis fig-pos='H'}\n:::\n:::\n\n\n## Correlation Structure\n\n::: {.cell execution_count=21}\n``` {.python .cell-code}\ncorr_vars = [\n    \"tobin_q_simple_w\", \"mtb_w\", \"altman_z_w\", \"altman_z_em_w\",\n    \"age_founding\", \"age_listing\",\n    \"z_x1\", \"z_x2\", \"z_x3\", \"z_x4\", \"z_x5\"\n]\ncorr_labels = [\n    \"Tobin's Q\", \"M/B Ratio\", \"Z-Score\", \"Z'' (EM)\",\n    \"Age (Found.)\", \"Age (List.)\",\n    \"EBIT/TA\", \"Sales/TA\", \"ME/TL\", \"WC/TA\", \"RE/TA\"\n]\n\ncorr_matrix = df_clean[corr_vars].corr()\ncorr_matrix.index = corr_labels\ncorr_matrix.columns = corr_labels\n\nfig, ax = plt.subplots(figsize=(12, 10))\n\nmask = np.triu(np.ones_like(corr_matrix, dtype=bool), k=1)\ncmap = sns.diverging_palette(250, 15, s=75, l=40, n=9, center=\"light\", as_cmap=True)\n\nsns.heatmap(\n    corr_matrix, mask=mask, cmap=cmap, center=0,\n    annot=True, fmt=\".2f\", square=True,\n    linewidths=0.5, cbar_kws={\"shrink\": 0.8},\n    ax=ax, vmin=-1, vmax=1,\n    annot_kws={\"size\": 9}\n)\nax.set_title(\"Correlation Matrix of Key Financial Measures\", fontsize=14, pad=20)\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Correlation matrix of key valuation, distress, and maturity measures for Vietnamese listed firms.](36_valuation_files/figure-pdf/fig-correlation-matrix-output-1.pdf){#fig-correlation-matrix fig-pos='H'}\n:::\n:::\n\n\n## Cross-Sectional Regression Analysis\n\nWe estimate a simple cross-sectional model to examine the determinants of Tobin's Q in the Vietnamese market:\n\n$$\nQ_{i,t} = \\alpha + \\beta_1 \\ln(\\text{Age}_{i}) + \\beta_2 Z''_{i,t} + \\beta_3 \\text{SOE}_{i} + \\beta_4 \\ln(\\text{TA}_{i,t}) + \\varepsilon_{i,t}\n$$ {#eq-regression-q}\n\n::: {#regression-analysis .cell execution_count=22}\n``` {.python .cell-code code-summary=\"Cross-sectional regression of Tobin's Q\"}\nfrom numpy.linalg import lstsq\n\n# Prepare regression data\nreg_data = latest.dropna(\n    subset=[\"tobin_q_simple_w\", \"ln_age_founding\", \"altman_z_em_w\", \"at\"]\n).copy()\n\nreg_data[\"ln_at\"] = np.log(reg_data[\"at\"])\nreg_data[\"soe_dummy\"] = (reg_data[\"state_ownership_pct\"] > 30).astype(int)\nreg_data[\"constant\"] = 1.0\n\n# OLS estimation\ny = reg_data[\"tobin_q_simple_w\"].values\nX = reg_data[[\"constant\", \"ln_age_founding\", \"altman_z_em_w\",\n              \"soe_dummy\", \"ln_at\"]].values\n\nbetas, residuals, rank, sv = lstsq(X, y, rcond=None)\ny_hat = X @ betas\nresid = y - y_hat\nn, k = X.shape\n\n# Standard errors (heteroskedasticity-robust would be better)\nsigma2 = np.sum(resid**2) / (n - k)\nvar_beta = sigma2 * np.linalg.inv(X.T @ X)\nse = np.sqrt(np.diag(var_beta))\nt_stats = betas / se\nr_squared = 1 - np.sum(resid**2) / np.sum((y - y.mean())**2)\nadj_r2 = 1 - (1 - r_squared) * (n - 1) / (n - k - 1)\n\n# Display results\nvar_names = [\"Constant\", \"ln(Age)\", \"Z''-Score (EM)\", \"SOE Dummy\", \"ln(Total Assets)\"]\nprint(\"=\" * 65)\nprint(\"  Cross-Sectional Regression: Determinants of Tobin's Q\")\nprint(f\"  Dependent Variable: Tobin's Q (Simple, Winsorized)\")\nprint(f\"  Sample: {n} firms ({latest_year})\")\nprint(\"=\" * 65)\nprint(f\"  {'Variable':<22} {'Coef':>10} {'Std.Err':>10} {'t-stat':>10}\")\nprint(\"-\" * 65)\nfor name, b, s, t in zip(var_names, betas, se, t_stats):\n    sig = \"***\" if abs(t) > 2.576 else \"**\" if abs(t) > 1.96 else \"*\" if abs(t) > 1.645 else \"\"\n    print(f\"  {name:<22} {b:>10.4f} {s:>10.4f} {t:>8.2f} {sig}\")\nprint(\"-\" * 65)\nprint(f\"  R-squared: {r_squared:.4f}\")\nprint(f\"  Adjusted R-squared: {adj_r2:.4f}\")\nprint(f\"  Observations: {n}\")\nprint(\"=\" * 65)\nprint(\"  Significance: *** p<0.01, ** p<0.05, * p<0.10\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n=================================================================\n  Cross-Sectional Regression: Determinants of Tobin's Q\n  Dependent Variable: Tobin's Q (Simple, Winsorized)\n  Sample: 232 firms (2024)\n=================================================================\n  Variable                     Coef    Std.Err     t-stat\n-----------------------------------------------------------------\n  Constant                   0.9686     0.1959     4.94 ***\n  ln(Age)                   -0.0064     0.0365    -0.18 \n  Z''-Score (EM)             0.0067     0.0050     1.34 \n  SOE Dummy                  0.0327     0.0315     1.04 \n  ln(Total Assets)           0.0018     0.0096     0.19 \n-----------------------------------------------------------------\n  R-squared: 0.0126\n  Adjusted R-squared: -0.0092\n  Observations: 232\n=================================================================\n  Significance: *** p<0.01, ** p<0.05, * p<0.10\n```\n:::\n:::\n\n\n# The Complete Pipeline {#sec-pipeline}\n\n## Putting It All Together\n\nHere we provide a single, clean function that takes raw DataCore.vn financial data and produces a complete dataset with all three measures computed.\n\n::: {#complete-pipeline .cell execution_count=23}\n``` {.python .cell-code code-summary=\"Complete pipeline for computing Tobin's Q, Z-Score, and Company Age\"}\ndef compute_valuation_distress_age(df, firm_profiles=None):\n    \"\"\"\n    Complete pipeline to compute Tobin's Q, Altman Z-Score variants,\n    and Company Age for Vietnamese listed firms.\n\n    Parameters\n    ----------\n    df : pd.DataFrame\n        Panel of firm-year financial data with columns:\n        at, seq, lt, lct, tlb, sale, ebit, ni, re_var, act,\n        ppent, invt, txdb, itcb, pstk, me, prcc, csho, year, ticker\n    firm_profiles : pd.DataFrame, optional\n        Company profiles with founding_year, listing_year\n\n    Returns\n    -------\n    pd.DataFrame\n        Input data augmented with computed measures\n    \"\"\"\n    result = df.copy()\n\n    # === Data Quality Filters ===\n    result = result[result[\"at\"] > 0]\n    result = result[result[\"seq\"] > 0]\n\n    # === Book Value of Equity (Daniel & Titman 1997) ===\n    result[\"pref\"] = result[\"pstk\"].fillna(0)\n    result[\"be\"] = (\n        result[\"seq\"]\n        + result[\"txdb\"].fillna(0)\n        + result[\"itcb\"].fillna(0)\n        - result[\"pref\"]\n    )\n\n    # === Market Value of Equity ===\n    if \"me\" not in result.columns or result[\"me\"].isna().all():\n        result[\"me\"] = result[\"prcc\"] * result[\"csho\"]\n\n    # === Tobin's Q Variants ===\n    # Simple Q (Gompers et al. 2003)\n    result[\"tobin_q\"] = (result[\"at\"] + result[\"me\"] - result[\"be\"]) / result[\"at\"]\n\n    # Chung-Pruitt Q\n    debt_cp = (\n        result[\"lct\"].fillna(0) - result[\"act\"].fillna(0)\n        + result[\"invt\"].fillna(0) + result[\"lt\"].fillna(0)\n    )\n    result[\"tobin_q_cp\"] = (\n        (result[\"me\"] + result[\"pstk\"].fillna(0) + debt_cp) / result[\"at\"]\n    )\n\n    # Market-to-Book\n    result[\"mtb\"] = np.where(result[\"be\"] > 0, result[\"me\"] / result[\"be\"], np.nan)\n\n    # === Altman Z-Score Variants ===\n    result[\"wc\"] = result[\"act\"].fillna(0) - result[\"lct\"].fillna(0)\n\n    x1 = result[\"ebit\"] / result[\"at\"]\n    x2 = result[\"sale\"] / result[\"at\"]\n    x3_market = np.where(result[\"tlb\"] > 0, result[\"me\"] / result[\"tlb\"], np.nan)\n    x3_book = np.where(result[\"tlb\"] > 0, result[\"be\"] / result[\"tlb\"], np.nan)\n    x4 = result[\"wc\"] / result[\"at\"]\n    x5 = result[\"re_var\"].fillna(0) / result[\"at\"]\n\n    # Original Z\n    result[\"altman_z\"] = 3.3 * x1 + 0.999 * x2 + 0.6 * x3_market + 1.2 * x4 + 1.4 * x5\n\n    # Z' (private firms)\n    result[\"altman_z_prime\"] = (\n        0.717 * x4 + 0.847 * x5 + 3.107 * x1 + 0.420 * x3_book + 0.998 * x2\n    )\n\n    # Z'' (emerging markets)\n    result[\"altman_z_em\"] = (\n        3.25 + 6.56 * x4 + 3.26 * x5 + 6.72 * x1 + 1.05 * x3_book\n    )\n\n    # Risk zones\n    result[\"z_zone\"] = pd.cut(\n        result[\"altman_z\"],\n        bins=[-np.inf, 1.80, 2.70, 2.99, np.inf],\n        labels=[\"High Distress\", \"Distress\", \"Grey Zone\", \"Safe\"]\n    )\n    result[\"z_em_zone\"] = pd.cut(\n        result[\"altman_z_em\"],\n        bins=[-np.inf, 1.10, 2.60, np.inf],\n        labels=[\"Distress\", \"Grey Zone\", \"Safe\"]\n    )\n\n    # === Company Age ===\n    if firm_profiles is not None:\n        result = result.merge(\n            firm_profiles[[\"ticker\", \"founding_year\", \"listing_year\"]],\n            on=\"ticker\", how=\"left\", suffixes=(\"\", \"_profile\")\n        )\n        result[\"age_founding\"] = result[\"year\"] - result[\"founding_year\"]\n        result[\"age_listing\"] = (result[\"year\"] - result[\"listing_year\"]).clip(lower=0)\n\n    first_year = result.groupby(\"ticker\")[\"year\"].transform(\"min\")\n    result[\"age_data\"] = result[\"year\"] - first_year\n\n    # === Winsorize ===\n    for var in [\"tobin_q\", \"tobin_q_cp\", \"mtb\", \"altman_z\", \"altman_z_prime\", \"altman_z_em\"]:\n        if var in result.columns:\n            result[f\"{var}_w\"] = winsorize(result[var])\n\n    return result\n\n# Demonstrate the pipeline\nfinal_df = compute_valuation_distress_age(df, firm_profiles)\nprint(f\"Final dataset: {final_df.shape[0]:,} observations, {final_df.shape[1]} variables\")\nprint(f\"Firms: {final_df['ticker'].nunique()}\")\nprint(f\"\\nKey variables computed:\")\nfor var in [\"tobin_q\", \"tobin_q_cp\", \"mtb\", \"altman_z\", \"altman_z_prime\",\n            \"altman_z_em\", \"age_founding\", \"age_listing\", \"age_data\"]:\n    if var in final_df.columns:\n        non_null = final_df[var].notna().sum()\n        print(f\"  {var}: {non_null:,} non-null values\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nFinal dataset: 3,484 observations, 48 variables\nFirms: 297\n\nKey variables computed:\n  tobin_q: 3,484 non-null values\n  tobin_q_cp: 3,484 non-null values\n  mtb: 3,484 non-null values\n  altman_z: 3,484 non-null values\n  altman_z_prime: 3,484 non-null values\n  altman_z_em: 3,484 non-null values\n  age_founding: 3,484 non-null values\n  age_listing: 3,484 non-null values\n  age_data: 3,484 non-null values\n```\n:::\n:::\n\n\n## Exporting Results\n\n::: {#export-results .cell execution_count=24}\n``` {.python .cell-code code-summary=\"Export computed measures to CSV\"}\n# Select key output variables\noutput_vars = [\n    \"ticker\", \"year\", \"datadate\", \"exchange\", \"industry\",\n    \"at\", \"be\", \"me\", \"tobin_q\", \"tobin_q_w\", \"mtb\", \"mtb_w\",\n    \"altman_z\", \"altman_z_w\", \"altman_z_em\", \"altman_z_em_w\",\n    \"z_zone\", \"z_em_zone\",\n    \"age_founding\", \"age_listing\", \"age_data\",\n    \"state_ownership_pct\"\n]\n\nexport_cols = [v for v in output_vars if v in final_df.columns]\nexport_df = final_df[export_cols].copy()\n\n# export_df.to_csv(\"vn_valuation_distress_age.csv\", index=False)\n# export_df.to_parquet(\"vn_valuation_distress_age.parquet\", index=False)\n\nprint(f\"Export dataset: {export_df.shape[0]:,} rows × {export_df.shape[1]} columns\")\nprint(f\"\\nSample output (first 5 rows):\")\ndisplay_cols = [\"ticker\", \"year\", \"tobin_q\", \"altman_z\", \"altman_z_em\",\n                \"z_zone\", \"age_founding\"]\ndisplay_cols = [c for c in display_cols if c in export_df.columns]\nprint(export_df[display_cols].head().to_string(index=False))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nExport dataset: 3,484 rows × 22 columns\n\nSample output (first 5 rows):\nticker  year  tobin_q  altman_z  altman_z_em z_zone  age_founding\nVN0001  2017 0.905928  3.345941     5.605169   Safe             4\nVN0001  2018 1.270114  5.324082     9.228846   Safe             5\nVN0001  2019 1.866493  5.478529     6.264178   Safe             6\nVN0001  2020 1.016979  5.612289    10.445449   Safe             7\nVN0001  2021 0.805818  4.220869     7.588273   Safe             8\n```\n:::\n:::\n\n\n# Special Topics for the Vietnamese Market {#sec-special-topics}\n\n## State Ownership and Valuation\n\nState ownership is a defining feature of the Vietnamese corporate landscape. We examine how state ownership affects both Tobin's Q and financial distress risk.\n\n::: {.cell execution_count=25}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 2, figsize=(14, 6))\n\nlatest = final_df[final_df[\"year\"] == latest_year].dropna(\n    subset=[\"tobin_q_w\", \"altman_z_em_w\", \"state_ownership_pct\"]\n)\n\n# Q vs State Ownership\naxes[0].scatter(\n    latest[\"state_ownership_pct\"], latest[\"tobin_q_w\"],\n    alpha=0.4, s=20, color=colors[\"primary\"], edgecolor=\"white\"\n)\n\n# Binned means\nbins = pd.cut(latest[\"state_ownership_pct\"], bins=10)\nbinned = latest.groupby(bins)[\"tobin_q_w\"].mean()\nbin_centers = [(b.left + b.right) / 2 for b in binned.index]\naxes[0].plot(bin_centers, binned.values, color=colors[\"quaternary\"],\n             linewidth=3, label=\"Binned Mean\")\n\naxes[0].set_xlabel(\"State Ownership (%)\")\naxes[0].set_ylabel(\"Tobin's Q\")\naxes[0].set_title(\"State Ownership and Firm Valuation\")\naxes[0].axhline(y=1, color=\"gray\", linestyle=\"--\", alpha=0.5)\naxes[0].legend()\n\n# Z''-Score by SOE quartile\nlatest[\"soe_quartile\"] = pd.qcut(\n    latest[\"state_ownership_pct\"],\n    q=4, labels=[\"Q1 (Low)\", \"Q2\", \"Q3\", \"Q4 (High)\"],\n    duplicates=\"drop\"\n)\n\nsoe_groups = latest.groupby(\"soe_quartile\")[\"altman_z_em_w\"]\nbox_data = [group.values for name, group in soe_groups]\nbp = axes[1].boxplot(\n    box_data,\n    labels=[name for name, _ in soe_groups],\n    patch_artist=True,\n    medianprops=dict(color=\"black\", linewidth=2)\n)\n\ngradient_colors = plt.cm.Blues(np.linspace(0.3, 0.8, len(bp[\"boxes\"])))\nfor patch, color in zip(bp[\"boxes\"], gradient_colors):\n    patch.set_facecolor(color)\n\naxes[1].axhline(y=2.60, color=\"green\", linestyle=\":\", alpha=0.5, label=\"Safe threshold\")\naxes[1].axhline(y=1.10, color=\"red\", linestyle=\":\", alpha=0.5, label=\"Distress threshold\")\naxes[1].set_xlabel(\"State Ownership Quartile\")\naxes[1].set_ylabel(\"Z''-Score (Emerging Market)\")\naxes[1].set_title(\"Financial Health by State Ownership\")\naxes[1].legend(fontsize=9)\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Relationship between state ownership percentage and firm valuation/distress measures. The left panel shows Tobin's Q against state ownership, with a LOWESS smoother. The right panel shows the Z''-Score by state ownership quartile.](36_valuation_files/figure-pdf/fig-soe-analysis-output-1.pdf){#fig-soe-analysis fig-pos='H'}\n:::\n:::\n\n\n## Exchange-Level Analysis\n\n::: {#tbl-exchange-summary .cell tbl-cap='Summary statistics by exchange for Vietnamese listed firms (latest year)' execution_count=26}\n``` {.python .cell-code}\nexchange_summary = (\n    latest\n    .groupby(\"exchange\")\n    .agg(\n        n_firms=(\"ticker\", \"nunique\"),\n        median_q=(\"tobin_q_w\", \"median\"),\n        mean_q=(\"tobin_q_w\", \"mean\"),\n        median_z=(\"altman_z_w\", \"median\"),\n        mean_z_em=(\"altman_z_em_w\", \"mean\"),\n        pct_distress_z=(\"z_zone\", lambda x: (x == \"High Distress\").mean() * 100),\n        pct_distress_em=(\"z_em_zone\", lambda x: (x == \"Distress\").mean() * 100),\n        median_age=(\"age_founding\", \"median\"),\n        median_soe=(\"state_ownership_pct\", \"median\"),\n    )\n    .round(2)\n)\n\nexchange_summary.columns = [\n    \"N Firms\", \"Median Q\", \"Mean Q\", \"Median Z\", \"Mean Z'' (EM)\",\n    \"% Distress (Z)\", \"% Distress (Z'')\", \"Median Age\", \"Median SOE %\"\n]\n\nexchange_summary.style.set_properties(**{\n    \"text-align\": \"center\",\n    \"font-size\": \"10pt\"\n}).set_table_styles([\n    {\"selector\": \"th\", \"props\": [\n        (\"background-color\", \"#1f77b4\"),\n        (\"color\", \"white\"),\n        (\"text-align\", \"center\"),\n        (\"padding\", \"8px\")\n    ]},\n]).format({\n    \"Median Q\": \"{:.2f}\", \"Mean Q\": \"{:.2f}\",\n    \"Median Z\": \"{:.2f}\", \"Mean Z'' (EM)\": \"{:.2f}\",\n    \"% Distress (Z)\": \"{:.1f}%\", \"% Distress (Z'')\": \"{:.1f}%\",\n    \"Median Age\": \"{:.0f}\", \"Median SOE %\": \"{:.1f}%\"\n})\n```\n\n::: {.cell-output .cell-output-display execution_count=25}\n```{=html}\n<style type=\"text/css\">\n#T_8eb1c th {\n  background-color: #1f77b4;\n  color: white;\n  text-align: center;\n  padding: 8px;\n}\n#T_8eb1c_row0_col0, #T_8eb1c_row0_col1, #T_8eb1c_row0_col2, #T_8eb1c_row0_col3, #T_8eb1c_row0_col4, #T_8eb1c_row0_col5, #T_8eb1c_row0_col6, #T_8eb1c_row0_col7, #T_8eb1c_row0_col8, #T_8eb1c_row1_col0, #T_8eb1c_row1_col1, #T_8eb1c_row1_col2, #T_8eb1c_row1_col3, #T_8eb1c_row1_col4, #T_8eb1c_row1_col5, #T_8eb1c_row1_col6, #T_8eb1c_row1_col7, #T_8eb1c_row1_col8, #T_8eb1c_row2_col0, #T_8eb1c_row2_col1, #T_8eb1c_row2_col2, #T_8eb1c_row2_col3, #T_8eb1c_row2_col4, #T_8eb1c_row2_col5, #T_8eb1c_row2_col6, #T_8eb1c_row2_col7, #T_8eb1c_row2_col8 {\n  text-align: center;\n  font-size: 10pt;\n}\n</style>\n<table id=\"T_8eb1c\">\n  <thead>\n    <tr>\n      <th class=\"blank level0\" >&nbsp;</th>\n      <th id=\"T_8eb1c_level0_col0\" class=\"col_heading level0 col0\" >N Firms</th>\n      <th id=\"T_8eb1c_level0_col1\" class=\"col_heading level0 col1\" >Median Q</th>\n      <th id=\"T_8eb1c_level0_col2\" class=\"col_heading level0 col2\" >Mean Q</th>\n      <th id=\"T_8eb1c_level0_col3\" class=\"col_heading level0 col3\" >Median Z</th>\n      <th id=\"T_8eb1c_level0_col4\" class=\"col_heading level0 col4\" >Mean Z'' (EM)</th>\n      <th id=\"T_8eb1c_level0_col5\" class=\"col_heading level0 col5\" >% Distress (Z)</th>\n      <th id=\"T_8eb1c_level0_col6\" class=\"col_heading level0 col6\" >% Distress (Z'')</th>\n      <th id=\"T_8eb1c_level0_col7\" class=\"col_heading level0 col7\" >Median Age</th>\n      <th id=\"T_8eb1c_level0_col8\" class=\"col_heading level0 col8\" >Median SOE %</th>\n    </tr>\n    <tr>\n      <th class=\"index_name level0\" >exchange</th>\n      <th class=\"blank col0\" >&nbsp;</th>\n      <th class=\"blank col1\" >&nbsp;</th>\n      <th class=\"blank col2\" >&nbsp;</th>\n      <th class=\"blank col3\" >&nbsp;</th>\n      <th class=\"blank col4\" >&nbsp;</th>\n      <th class=\"blank col5\" >&nbsp;</th>\n      <th class=\"blank col6\" >&nbsp;</th>\n      <th class=\"blank col7\" >&nbsp;</th>\n      <th class=\"blank col8\" >&nbsp;</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th id=\"T_8eb1c_level0_row0\" class=\"row_heading level0 row0\" >HNX</th>\n      <td id=\"T_8eb1c_row0_col0\" class=\"data row0 col0\" >77</td>\n      <td id=\"T_8eb1c_row0_col1\" class=\"data row0 col1\" >0.99</td>\n      <td id=\"T_8eb1c_row0_col2\" class=\"data row0 col2\" >1.02</td>\n      <td id=\"T_8eb1c_row0_col3\" class=\"data row0 col3\" >2.07</td>\n      <td id=\"T_8eb1c_row0_col4\" class=\"data row0 col4\" >7.25</td>\n      <td id=\"T_8eb1c_row0_col5\" class=\"data row0 col5\" >32.5%</td>\n      <td id=\"T_8eb1c_row0_col6\" class=\"data row0 col6\" >0.0%</td>\n      <td id=\"T_8eb1c_row0_col7\" class=\"data row0 col7\" >33</td>\n      <td id=\"T_8eb1c_row0_col8\" class=\"data row0 col8\" >22.1%</td>\n    </tr>\n    <tr>\n      <th id=\"T_8eb1c_level0_row1\" class=\"row_heading level0 row1\" >HOSE</th>\n      <td id=\"T_8eb1c_row1_col0\" class=\"data row1 col0\" >113</td>\n      <td id=\"T_8eb1c_row1_col1\" class=\"data row1 col1\" >1.00</td>\n      <td id=\"T_8eb1c_row1_col2\" class=\"data row1 col2\" >1.04</td>\n      <td id=\"T_8eb1c_row1_col3\" class=\"data row1 col3\" >2.06</td>\n      <td id=\"T_8eb1c_row1_col4\" class=\"data row1 col4\" >7.24</td>\n      <td id=\"T_8eb1c_row1_col5\" class=\"data row1 col5\" >40.7%</td>\n      <td id=\"T_8eb1c_row1_col6\" class=\"data row1 col6\" >0.0%</td>\n      <td id=\"T_8eb1c_row1_col7\" class=\"data row1 col7\" >29</td>\n      <td id=\"T_8eb1c_row1_col8\" class=\"data row1 col8\" >26.8%</td>\n    </tr>\n    <tr>\n      <th id=\"T_8eb1c_level0_row2\" class=\"row_heading level0 row2\" >UPCoM</th>\n      <td id=\"T_8eb1c_row2_col0\" class=\"data row2 col0\" >42</td>\n      <td id=\"T_8eb1c_row2_col1\" class=\"data row2 col1\" >0.98</td>\n      <td id=\"T_8eb1c_row2_col2\" class=\"data row2 col2\" >1.05</td>\n      <td id=\"T_8eb1c_row2_col3\" class=\"data row2 col3\" >2.13</td>\n      <td id=\"T_8eb1c_row2_col4\" class=\"data row2 col4\" >7.80</td>\n      <td id=\"T_8eb1c_row2_col5\" class=\"data row2 col5\" >30.9%</td>\n      <td id=\"T_8eb1c_row2_col6\" class=\"data row2 col6\" >0.0%</td>\n      <td id=\"T_8eb1c_row2_col7\" class=\"data row2 col7\" >26</td>\n      <td id=\"T_8eb1c_row2_col8\" class=\"data row2 col8\" >27.6%</td>\n    </tr>\n  </tbody>\n</table>\n```\n:::\n:::\n\n\n## Sector Heatmap: Valuation and Distress\n\n::: {.cell execution_count=27}\n``` {.python .cell-code}\nfig, axes = plt.subplots(1, 2, figsize=(16, 8))\n\n# Tobin's Q heatmap\nq_pivot = (\n    final_df\n    .groupby([\"industry\", \"year\"])[\"tobin_q_w\"]\n    .median()\n    .unstack(fill_value=np.nan)\n)\n\nsns.heatmap(\n    q_pivot, cmap=\"RdYlGn\", center=1, ax=axes[0],\n    cbar_kws={\"label\": \"Median Q\", \"shrink\": 0.8},\n    linewidths=0.5, linecolor=\"white\",\n    xticklabels=2\n)\naxes[0].set_title(\"Tobin's Q by Industry and Year\")\naxes[0].set_xlabel(\"Year\")\naxes[0].set_ylabel(\"\")\n\n# Z''-Score heatmap\nz_pivot = (\n    final_df\n    .groupby([\"industry\", \"year\"])[\"altman_z_em_w\"]\n    .median()\n    .unstack(fill_value=np.nan)\n)\n\nsns.heatmap(\n    z_pivot, cmap=\"RdYlGn\", center=2.6, ax=axes[1],\n    cbar_kws={\"label\": \"Median Z''\", \"shrink\": 0.8},\n    linewidths=0.5, linecolor=\"white\",\n    xticklabels=2\n)\naxes[1].set_title(\"Z''-Score (EM) by Industry and Year\")\naxes[1].set_xlabel(\"Year\")\naxes[1].set_ylabel(\"\")\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Median Tobin's Q and Z''-Score by industry and year for Vietnamese listed firms. Warmer colors indicate higher values.](36_valuation_files/figure-pdf/fig-sector-heatmap-output-1.pdf){#fig-sector-heatmap fig-pos='H'}\n:::\n:::\n\n\n## Handling Delisted Firms: Survivorship Bias\n\nA critical issue in measuring financial distress is survivorship bias. If we only analyze currently listed firms, we miss the very firms that the Z-Score is designed to identify, those that went bankrupt or were delisted.\n\n::: {#survivorship-bias .cell execution_count=28}\n``` {.python .cell-code code-summary=\"Analysis of delisted firms and survivorship bias\"}\n# Simulate delisting data (replace with DataCore.vn delisting records)\nnp.random.seed(123)\nn_delisted = 50\ndelisted_firms = pd.DataFrame({\n    \"ticker\": [f\"VN{str(i).zfill(4)}\" for i in range(n_firms + 1, n_firms + n_delisted + 1)],\n    \"delist_year\": np.random.randint(2010, 2024, n_delisted),\n    \"delist_reason\": np.random.choice(\n        [\"Bankruptcy/Liquidation\", \"Merger/Acquisition\", \"Voluntary Delisting\",\n         \"Regulatory Non-compliance\", \"Below Minimum Requirements\"],\n        n_delisted,\n        p=[0.15, 0.25, 0.20, 0.20, 0.20]\n    )\n})\n\n# Summary of delisting reasons\nprint(\"Delisting Reasons Summary\")\nprint(\"=\" * 50)\nreason_counts = delisted_firms[\"delist_reason\"].value_counts()\nfor reason, count in reason_counts.items():\n    print(f\"  {reason}: {count} ({count/n_delisted*100:.0f}%)\")\nprint(f\"\\nTotal delisted: {n_delisted}\")\nprint(f\"Currently listed: {final_df['ticker'].nunique()}\")\nprint(f\"\\nSurvivorship rate: \"\n      f\"{final_df['ticker'].nunique()/(final_df['ticker'].nunique()+n_delisted)*100:.1f}%\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nDelisting Reasons Summary\n==================================================\n  Merger/Acquisition: 16 (32%)\n  Voluntary Delisting: 14 (28%)\n  Regulatory Non-compliance: 9 (18%)\n  Below Minimum Requirements: 7 (14%)\n  Bankruptcy/Liquidation: 4 (8%)\n\nTotal delisted: 50\nCurrently listed: 297\n\nSurvivorship rate: 85.6%\n```\n:::\n:::\n\n\n# Robustness Checks and Extensions {#sec-robustness}\n\n## Alternative Tobin's Q Specifications\n\n::: {.cell execution_count=29}\n``` {.python .cell-code}\nfig, ax = plt.subplots(figsize=(7, 7))\n\nsample = latest.dropna(subset=[\"tobin_q_w\", \"tobin_q_cp\"]).copy()\nsample[\"tobin_q_cp_w\"] = winsorize(sample[\"tobin_q_cp\"])\n\nax.scatter(\n    sample[\"tobin_q_w\"], sample[\"tobin_q_cp_w\"],\n    alpha=0.4, s=15, color=colors[\"primary\"], edgecolor=\"white\"\n)\n\n# 45-degree line\nlims = [\n    min(ax.get_xlim()[0], ax.get_ylim()[0]),\n    max(ax.get_xlim()[1], ax.get_ylim()[1])\n]\nax.plot(lims, lims, \"k--\", alpha=0.3)\n\ncorr = sample[\"tobin_q_w\"].corr(sample[\"tobin_q_cp_w\"])\nax.text(0.05, 0.95, f\"Correlation: {corr:.3f}\",\n        transform=ax.transAxes, fontsize=12,\n        verticalalignment=\"top\",\n        bbox=dict(boxstyle=\"round\", facecolor=\"wheat\", alpha=0.5))\n\nax.set_xlabel(\"Simple Q (Gompers et al.)\")\nax.set_ylabel(\"Chung-Pruitt Q\")\nax.set_title(\"Comparison of Tobin's Q Variants\")\n\nplt.tight_layout()\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Comparison of Tobin's Q variants: Simple Q (Gompers et al. 2003) vs. Chung-Pruitt approximation. High correlation supports the use of the simpler measure.](36_valuation_files/figure-pdf/fig-q-variants-comparison-output-1.pdf){#fig-q-variants-comparison fig-pos='H'}\n:::\n:::\n\n\n## Industry-Adjusted Measures\n\nRaw Tobin's Q and Z-Scores may reflect industry characteristics rather than firm-specific attributes. We compute industry-adjusted versions:\n\n$$\nQ^{\\text{adj}}_{i,t} = Q_{i,t} - \\overline{Q}_{j(i),t}\n$$ {#eq-industry-adj-q}\n\nwhere $\\overline{Q}_{j(i),t}$ is the median Tobin's Q of the industry $j$ to which firm $i$ belongs in year $t$.\n\n::: {#industry-adjusted .cell execution_count=30}\n``` {.python .cell-code code-summary=\"Industry-adjusted measures\"}\ndef industry_adjust(df, var, group_var=\"industry\"):\n    \"\"\"Compute industry-adjusted measure (deviation from industry median).\"\"\"\n    industry_median = df.groupby([\"year\", group_var])[var].transform(\"median\")\n    return df[var] - industry_median\n\nfinal_df[\"tobin_q_adj\"] = industry_adjust(final_df, \"tobin_q_w\")\nfinal_df[\"altman_z_em_adj\"] = industry_adjust(final_df, \"altman_z_em_w\")\n\nlatest_adj = final_df[final_df[\"year\"] == latest_year]\n\nprint(\"Industry-Adjusted Measures (Latest Year)\")\nprint(f\"  Tobin's Q (adjusted): mean={latest_adj['tobin_q_adj'].mean():.4f}, \"\n      f\"std={latest_adj['tobin_q_adj'].std():.3f}\")\nprint(f\"  Z''-Score (adjusted): mean={latest_adj['altman_z_em_adj'].mean():.4f}, \"\n      f\"std={latest_adj['altman_z_em_adj'].std():.3f}\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nIndustry-Adjusted Measures (Latest Year)\n  Tobin's Q (adjusted): mean=0.0352, std=0.226\n  Z''-Score (adjusted): mean=0.4840, std=3.030\n```\n:::\n:::\n\n\n## Panel Regression with Fixed Effects\n\nFor more rigorous analysis, we estimate a panel model with firm and year fixed effects:\n\n$$\nQ_{i,t} = \\alpha_i + \\gamma_t + \\beta_1 Z''_{i,t} + \\beta_2 \\ln(\\text{Age}_{i,t}) + \\beta_3 \\text{Size}_{i,t} + \\varepsilon_{i,t}\n$$ {#eq-panel-regression}\n\n::: {#panel-regression .cell execution_count=31}\n``` {.python .cell-code code-summary=\"Panel regression with year and industry fixed effects\"}\n# Simplified within-estimator (year and industry demeaning)\npanel = final_df.dropna(\n    subset=[\"tobin_q_w\", \"altman_z_em_w\", \"age_founding\", \"at\"]\n).copy()\n\npanel[\"ln_at\"] = np.log(panel[\"at\"])\npanel[\"ln_age\"] = np.log1p(panel[\"age_founding\"])\n\n# Demean by year-industry (proxy for fixed effects)\nfe_vars = [\"tobin_q_w\", \"altman_z_em_w\", \"ln_age\", \"ln_at\"]\nfor var in fe_vars:\n    group_mean = panel.groupby([\"year\", \"industry\"])[var].transform(\"mean\")\n    panel[f\"{var}_dm\"] = panel[var] - group_mean\n\n# OLS on demeaned data\ny = panel[\"tobin_q_w_dm\"].values\nX = np.column_stack([\n    np.ones(len(panel)),\n    panel[\"altman_z_em_w_dm\"].values,\n    panel[\"ln_age_dm\"].values,\n    panel[\"ln_at_dm\"].values,\n])\n\nbetas, _, _, _ = lstsq(X, y, rcond=None)\ny_hat = X @ betas\nresid = y - y_hat\nn, k = X.shape\n\nsigma2 = np.sum(resid**2) / (n - k)\nvar_beta = sigma2 * np.linalg.inv(X.T @ X)\nse = np.sqrt(np.diag(var_beta))\nt_stats = betas / se\nr_squared = 1 - np.sum(resid**2) / np.sum((y - y.mean())**2)\n\nvar_names = [\"Constant\", \"Z''-Score (EM)\", \"ln(Age)\", \"ln(Total Assets)\"]\nprint(\"=\" * 65)\nprint(\"  Panel Regression: Tobin's Q with Year-Industry FE\")\nprint(f\"  (Within estimator via year×industry demeaning)\")\nprint(\"=\" * 65)\nprint(f\"  {'Variable':<22} {'Coef':>10} {'Std.Err':>10} {'t-stat':>10}\")\nprint(\"-\" * 65)\nfor name, b, s, t in zip(var_names, betas, se, t_stats):\n    sig = \"***\" if abs(t) > 2.576 else \"**\" if abs(t) > 1.96 else \"*\" if abs(t) > 1.645 else \"\"\n    print(f\"  {name:<22} {b:>10.4f} {s:>10.4f} {t:>8.2f} {sig}\")\nprint(\"-\" * 65)\nprint(f\"  R-squared (within): {r_squared:.4f}\")\nprint(f\"  Observations: {n:,}\")\nprint(\"=\" * 65)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n=================================================================\n  Panel Regression: Tobin's Q with Year-Industry FE\n  (Within estimator via year×industry demeaning)\n=================================================================\n  Variable                     Coef    Std.Err     t-stat\n-----------------------------------------------------------------\n  Constant                   0.0000     0.0038     0.00 \n  Z''-Score (EM)             0.0034     0.0014     2.45 **\n  ln(Age)                   -0.0055     0.0063    -0.88 \n  ln(Total Assets)          -0.0031     0.0026    -1.16 \n-----------------------------------------------------------------\n  R-squared (within): 0.0024\n  Observations: 3,484\n=================================================================\n```\n:::\n:::\n\n\n# Practical Considerations and Limitations {#sec-limitations}\n\n## Known Limitations of Tobin's Q in Vietnam\n\nSeveral issues affect the reliability of Tobin's Q estimates for Vietnamese firms:\n\n1.  **Book value as replacement cost proxy**: The simplified Q measure assumes that book value of assets approximates replacement cost. Under VAS's heavy reliance on historical cost, this assumption may be more problematic than in IFRS-adopting countries, particularly for firms with significant land use rights or long-lived tangible assets.\n\n2.  **Market microstructure effects**: Vietnam's daily price limits can prevent market prices from reaching equilibrium, potentially distorting the market value component. Foreign ownership limits may create artificial price premiums for certain stocks.\n\n3.  **Preferred stock rarity**: While this simplifies the computation (most Vietnamese firms have no preferred stock), it means the BE calculation is dominated by common equity, which may not capture all ownership claims.\n\n4.  **Cross-listing effects**: Some Vietnamese firms are listed on multiple venues (HOSE, HNX, UPCoM, or even foreign exchanges). Care must be taken to use consistent price and share data.\n\n## Known Limitations of Altman Z-Score in Vietnam\n\n1.  **Calibration sample**: The original Z-Score was estimated on mid-20th-century U.S. manufacturing firms. The Z''-Score for emerging markets is more appropriate but was still estimated on a non-Vietnamese sample.\n\n2.  **Accounting differences**: VAS accounting standards produce financial ratios with different distributional properties than US GAAP or IFRS data, potentially affecting the discriminant function's classification accuracy.\n\n3.  **Banking and financial firms**: The Z-Score was not designed for financial institutions, which have fundamentally different balance sheet structures. Banks, insurance companies, and securities firms should be excluded or analyzed separately.\n\n4.  **Implicit guarantees**: SOEs and firms connected to major economic groups may have implicit support that reduces actual default risk below Z-Score predictions.\n\n## Recommendations for Researchers\n\nBased on our analysis, we offer the following recommendations for researchers working with Vietnamese data:\n\n1.  **Use the Z''-Score (Emerging Market) variant** as the primary distress measure for Vietnamese non-financial firms.\n2.  **Report multiple Q variants** (Simple and Chung-Pruitt) to demonstrate robustness.\n3.  **Winsorize at 1%/99%** to mitigate the impact of data errors and extreme outliers.\n4.  **Compute industry-adjusted measures** when making cross-sectional comparisons.\n5.  **Use founding age** rather than listing age when available, but report both to distinguish organizational maturity from capital market experience.\n6.  **Exclude financial firms** from Z-Score analysis.\n7.  **Account for state ownership** as a moderating variable in valuation and distress studies.\n\n# Summary {#sec-summary}\n\nThis chapter presented a treatment of three fundamental corporate finance measures (i.e., Tobin's Q, the Altman Z-Score, and Company Age). We covered the theoretical foundations of each measure and provided extensive visualizations of cross-sectional and time-series patterns.\n\nKey findings from our analysis of Vietnamese listed firms include:\n\n1.  **Tobin's Q** varies substantially across industries and exchanges, with technology and consumer-facing sectors typically commanding higher valuations. HOSE-listed firms tend to have higher Q values than HNX or UPCoM firms, reflecting both firm quality differences and liquidity effects.\n\n2.  **The Altman Z-Score** reveals that a meaningful proportion of Vietnamese firms operate in or near the distress zone, though the appropriate variant matters; the emerging market Z''-Score provides more nuanced classification than the original model. Financial health shows significant time-series variation, with notable deterioration during economic downturns.\n\n3.  **Company age** in Vietnam requires careful treatment due to the equitization of SOEs, which creates large gaps between founding age and listing age. This distinction is substantively important for understanding the relationship between maturity, valuation, and financial stability.\n\n",
    "supporting": [
      "36_valuation_files/figure-pdf"
    ],
    "filters": []
  }
}