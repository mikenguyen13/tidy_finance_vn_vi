{
  "hash": "7c10933f82dd57325cacad67d7466a1a",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: The Capital Asset Pricing Model\nformat:\n  html:\n    toc: true\n    number-sections: true\njupyter: python3\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\n## From Efficient Portfolios to Equilibrium Prices\n\nThe previous chapter on [Modern Portfolio Theory](02_modern_portfolio_theory.qmd) (MPT) showed how an investor can construct portfolios that optimally trade off risk and expected return. But MPT leaves a crucial question unanswered: What determines the *expected returns* themselves? Why do some assets command higher risk premiums than others?\n\nThe Capital Asset Pricing Model (CAPM) answers this question. Developed simultaneously by @Sharpe1964, @Lintner1965, and @Mossin1966, the CAPM extends MPT to explain how assets should be priced in equilibrium when *all* investors follow mean-variance optimization principles. The CAPM's central insight is both elegant and counterintuitive: **not all risk is rewarded**. Only the component of risk that cannot be diversified away (i.e., systematic risk) commands a risk premium in equilibrium.\n\nThe CAPM remains the cornerstone of asset pricing theory, not because it perfectly describes reality, but because it provides the simplest coherent framework for understanding the relationship between risk and expected return. Every extension and alternative model in asset pricing (e.g., from the Fama-French factors to consumption-based pricing) builds upon or reacts against the CAPM's foundational logic.\n\nIn this chapter, we derive the CAPM from first principles, illustrate its theoretical underpinnings, and show how to estimate its parameters empirically. We download stock market data, estimate betas using regression analysis, and evaluate asset performance relative to model predictions.\n\n::: {#0964942b .cell execution_count=2}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\nimport tidyfinance as tf\n\nfrom plotnine import *\nfrom mizani.formatters import percent_format\nfrom adjustText import adjust_text\n```\n:::\n\n\n## Systematic versus Idiosyncratic Risk\n\nBefore diving into the mathematics, we need to understand the fundamental distinction that makes the CAPM work: the difference between *systematic* and *idiosyncratic* risk.\n\n### Idiosyncratic Risk: Diversifiable and Unrewarded\n\nConsider events that affect individual companies but not the broader market: a CEO resigns unexpectedly, a product launch fails, earnings disappoint analysts, or a factory experiences a fire. These company-specific events can dramatically affect individual stock prices, but they tend to average out across a diversified portfolio. When one company has bad news, another often has good news; the shocks are largely uncorrelated.\n\nThis idiosyncratic (or firm-specific) risk can be eliminated through diversification. By holding a portfolio of many stocks, an investor can reduce idiosyncratic risk to nearly zero. Since this risk can be avoided at no cost, investors should not expect compensation for bearing it. In equilibrium, idiosyncratic risk earns no premium.\n\n### Systematic Risk: Undiversifiable and Priced\n\nSystematic risk, by contrast, affects all assets simultaneously. Recessions, interest rate changes, geopolitical crises, and pandemics impact virtually every company to some degree. No amount of diversification can eliminate exposure to these economy-wide shocks, they are inherent to participating in the market.\n\nSince systematic risk cannot be diversified away, investors genuinely dislike it. They must be compensated for bearing it. The CAPM formalizes this intuition: expected returns should depend only on systematic risk, not total risk. Two assets with identical total volatility can have very different expected returns if their systematic risk exposures differ.\n\n### A Simple Illustration\n\nImagine two stocks with identical 30% annual volatility. Stock A is a gold mining company whose returns move opposite to the overall market: it does well when the economy struggles and poorly when it booms. Stock B is a luxury retailer that amplifies market movements: soaring in good times and crashing in bad times.\n\nWhich stock should offer higher expected returns? Intuition might suggest they should be equal since both have the same volatility. But the CAPM says Stock B should offer substantially higher returns. Why? Because Stock B performs poorly precisely when investors' overall wealth is already down (during market crashes), making its returns particularly painful. Stock A, by contrast, provides insurance. Its strong performance during market downturns partially offsets losses elsewhere in the portfolio. Investors value this insurance property and are willing to accept lower expected returns in exchange.\n\nThis is the CAPM's core insight: expected returns compensate investors for systematic risk exposure, measured by how an asset's returns co-move with the market portfolio.\n\n## Data Preparation\n\nBuilding on our analysis from the previous chapter, we examine the VN30 constituents as our asset universe. We download and prepare monthly return data:\n\n::: {#c9ca5486 .cell execution_count=3}\n``` {.python .cell-code}\nvn30_symbols = [\n    \"ACB\", \"BCM\", \"BID\", \"BVH\", \"CTG\", \"FPT\", \"GAS\", \"GVR\", \"HDB\", \"HPG\",\n    \"MBB\", \"MSN\", \"MWG\", \"PLX\", \"POW\", \"SAB\", \"SHB\", \"SSB\", \"STB\", \"TCB\",\n    \"TPB\", \"VCB\", \"VHM\", \"VIB\", \"VIC\", \"VJC\", \"VNM\", \"VPB\", \"VRE\", \"EIB\"\n]\n```\n:::\n\n\n::: {#999eac6a .cell execution_count=4}\n``` {.python .cell-code}\nimport os\nimport boto3\nfrom botocore.client import Config\nfrom io import BytesIO\n\nclass ConnectMinio:\n    def __init__(self):\n        self.MINIO_ENDPOINT = os.environ[\"MINIO_ENDPOINT\"]\n        self.MINIO_ACCESS_KEY = os.environ[\"MINIO_ACCESS_KEY\"]\n        self.MINIO_SECRET_KEY = os.environ[\"MINIO_SECRET_KEY\"]\n        self.REGION = os.getenv(\"MINIO_REGION\", \"us-east-1\")\n\n        self.s3 = boto3.client(\n            \"s3\",\n            endpoint_url=self.MINIO_ENDPOINT,\n            aws_access_key_id=self.MINIO_ACCESS_KEY,\n            aws_secret_access_key=self.MINIO_SECRET_KEY,\n            region_name=self.REGION,\n            config=Config(signature_version=\"s3v4\"),\n        )\n\n    def test_connection(self):\n        resp = self.s3.list_buckets()\n        print(\"Connected. Buckets:\")\n        for b in resp.get(\"Buckets\", []):\n            print(\" -\", b[\"Name\"])\n\n\nconn = ConnectMinio()\ns3 = conn.s3\nconn.test_connection()\n\nbucket_name = os.environ[\"MINIO_BUCKET\"]\n\nprices = pd.read_csv(\n    BytesIO(\n        s3.get_object(\n            Bucket=bucket_name,\n            Key=\"historycal_price/dataset_historical_price.csv\"\n        )[\"Body\"].read()\n    ),\n    low_memory=False\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nConnected. Buckets:\n - dsteam-data\n - rawbctc\n```\n:::\n:::\n\n\nWe process the raw price data to compute adjusted closing prices and standardize column names:\n\n::: {#2fa79708 .cell execution_count=5}\n``` {.python .cell-code}\nprices[\"date\"] = pd.to_datetime(prices[\"date\"])\nprices[\"adjusted_close\"] = prices[\"close_price\"] * prices[\"adj_ratio\"]\nprices = prices.rename(columns={\n    \"vol_total\": \"volume\",\n    \"open_price\": \"open\",\n    \"low_price\": \"low\",\n    \"high_price\": \"high\",\n    \"close_price\": \"close\"\n})\nprices = prices.sort_values([\"symbol\", \"date\"])\n```\n:::\n\n\n::: {#8d49ed4f .cell execution_count=6}\n``` {.python .cell-code}\nprices_daily = prices[prices[\"symbol\"].isin(vn30_symbols)]\nprices_daily[[\"date\", \"symbol\", \"adjusted_close\"]].head(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=5}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>symbol</th>\n      <th>adjusted_close</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>18176</th>\n      <td>2010-01-04</td>\n      <td>ACB</td>\n      <td>329.408244</td>\n    </tr>\n    <tr>\n      <th>18177</th>\n      <td>2010-01-05</td>\n      <td>ACB</td>\n      <td>329.408244</td>\n    </tr>\n    <tr>\n      <th>18178</th>\n      <td>2010-01-06</td>\n      <td>ACB</td>\n      <td>320.258015</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n### Computing Monthly Returns\n\nWe aggregate daily prices to monthly frequency. Using monthly returns rather than daily returns offers several advantages for portfolio analysis: monthly returns exhibit less noise, better approximate normality, and reduce the impact of microstructure effects like bid-ask bounce.\n\n::: {#f12c3911 .cell execution_count=7}\n``` {.python .cell-code}\nreturns_monthly = (prices_daily\n    .assign(\n        date=prices_daily[\"date\"].dt.to_period(\"M\").dt.to_timestamp(\"M\")\n    )\n    .groupby([\"symbol\", \"date\"], as_index=False)\n    .agg(adjusted_close=(\"adjusted_close\", \"last\"))\n    .sort_values([\"symbol\", \"date\"])\n    .assign(\n        ret=lambda x: x.groupby(\"symbol\")[\"adjusted_close\"].pct_change()\n    )\n)\n\nreturns_monthly.head(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>symbol</th>\n      <th>date</th>\n      <th>adjusted_close</th>\n      <th>ret</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>ACB</td>\n      <td>2010-01-31</td>\n      <td>291.975489</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>ACB</td>\n      <td>2010-02-28</td>\n      <td>303.621235</td>\n      <td>0.039886</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>ACB</td>\n      <td>2010-03-31</td>\n      <td>273.784658</td>\n      <td>-0.098269</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## The Risk-Free Asset and the Investment Opportunity Set\n\n### Adding a Risk-Free Asset\n\nThe previous chapter on MPT considered portfolios composed entirely of risky assets, requiring that portfolio weights sum to one. The CAPM introduces a crucial new element: a **risk-free asset** that pays a constant interest rate $r_f$ with zero volatility.\n\nThis seemingly simple addition fundamentally transforms the investment opportunity set. With a risk-free asset available, investors can choose to park some wealth in the safe asset and invest the remainder in risky assets. They can also borrow at the risk-free rate to leverage their risky positions.\n\nLet $\\omega \\in \\mathbb{R}^N$ denote the portfolio weights in the $N$ risky assets. Unlike before, these weights need not sum to one. The remainder, $1 - \\iota'\\omega$ (where $\\iota$ is a vector of ones), is invested in the risk-free asset.\n\n### Portfolio Return with a Risk-Free Asset\n\nThe expected return on this combined portfolio is:\n\n$$\n\\mu_\\omega = \\omega'\\mu + (1 - \\iota'\\omega)r_f = r_f + \\omega'(\\mu - r_f) = r_f + \\omega'\\tilde{\\mu}\n$$\n\nwhere $\\mu$ is the vector of expected returns on risky assets and $\\tilde{\\mu} = \\mu - r_f$ denotes the vector of **excess returns** (returns above the risk-free rate).\n\nThis expression reveals an important decomposition: the portfolio's expected return equals the risk-free rate plus a risk premium determined by the exposure to risky assets.\n\n### Portfolio Variance\n\nSince the risk-free asset has zero volatility and zero covariance with risky assets, only the risky portion contributes to portfolio variance:\n\n$$\n\\sigma_\\omega^2 = \\omega'\\Sigma\\omega\n$$\n\nwhere $\\Sigma$ is the variance-covariance matrix of risky asset returns. The portfolio's volatility (standard deviation) is:\n\n$$\n\\sigma_\\omega = \\sqrt{\\omega'\\Sigma\\omega}\n$$\n\n### Setting Up the Risk-Free Rate\n\nFor a realistic proxy of the risk-free rate, we use the Vietnam government bond yield. Government bonds of stable economies are considered \"risk-free\" because the government can always print money to meet its obligations (though this may cause inflation).\n\n::: {#910b21aa .cell execution_count=8}\n``` {.python .cell-code}\nall_dates = pd.date_range(\n    start=returns_monthly[\"date\"].min(), \n    end=returns_monthly[\"date\"].max(), \n    freq=\"ME\"\n)\n\n# Vietnam 10-Year Government Bond Yield (approximately 2.52% annualized)\nrf_annual = 0.0252\nrf_monthly_val = (1 + rf_annual)**(1/12) - 1\n\nrisk_free_monthly = pd.DataFrame({\n    \"date\": all_dates,\n    \"risk_free\": rf_monthly_val\n})\n\nrisk_free_monthly[\"date\"] = (\n    pd.to_datetime(risk_free_monthly[\"date\"])\n    .dt.to_period(\"M\")\n    .dt.to_timestamp(\"M\")\n)\n\nrisk_free_monthly.head(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>risk_free</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>2010-01-31</td>\n      <td>0.002076</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2010-02-28</td>\n      <td>0.002076</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2010-03-31</td>\n      <td>0.002076</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nWe merge the risk-free rate with our returns data and compute excess returns:\n\n::: {#ef2cca15 .cell execution_count=9}\n``` {.python .cell-code}\nreturns_monthly = returns_monthly.merge(\n    risk_free_monthly[[\"date\", \"risk_free\"]], \n    on=\"date\", \n    how=\"left\"\n)\n\nrf = risk_free_monthly[\"risk_free\"].mean()\n\nreturns_monthly = (returns_monthly\n    .assign(\n        ret_excess=lambda x: x[\"ret\"] - x[\"risk_free\"]\n    )\n    .assign(\n        ret_excess=lambda x: x[\"ret_excess\"].clip(lower=-1)\n    )\n)\n\nreturns_monthly.head(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=8}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>symbol</th>\n      <th>date</th>\n      <th>adjusted_close</th>\n      <th>ret</th>\n      <th>risk_free</th>\n      <th>ret_excess</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>ACB</td>\n      <td>2010-01-31</td>\n      <td>291.975489</td>\n      <td>NaN</td>\n      <td>0.002076</td>\n      <td>NaN</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>ACB</td>\n      <td>2010-02-28</td>\n      <td>303.621235</td>\n      <td>0.039886</td>\n      <td>0.002076</td>\n      <td>0.037810</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>ACB</td>\n      <td>2010-03-31</td>\n      <td>273.784658</td>\n      <td>-0.098269</td>\n      <td>0.002076</td>\n      <td>-0.100345</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## The Tangency Portfolio: Where Everyone Invests\n\n### Deriving the Optimal Risky Portfolio\n\nWith a risk-free asset available, how should an investor allocate wealth across risky assets? Consider an investor who wants to achieve a target expected excess return $\\bar{\\mu}$ with minimum variance. The optimization problem becomes:\n\n$$\n\\min_\\omega \\omega'\\Sigma\\omega \\quad \\text{subject to} \\quad \\omega'\\tilde{\\mu} = \\bar{\\mu}\n$$\n\nUsing the Lagrangian method:\n\n$$\n\\mathcal{L}(\\omega, \\lambda) = \\omega'\\Sigma\\omega - \\lambda(\\omega'\\tilde{\\mu} - \\bar{\\mu})\n$$\n\nThe first-order condition with respect to $\\omega$ is:\n\n$$\n\\frac{\\partial \\mathcal{L}}{\\partial \\omega} = 2\\Sigma\\omega - \\lambda\\tilde{\\mu} = 0\n$$\n\nSolving for the optimal weights:\n\n$$\n\\omega^* = \\frac{\\lambda}{2}\\Sigma^{-1}\\tilde{\\mu}\n$$\n\nThe constraint $\\omega'\\tilde{\\mu} = \\bar{\\mu}$ determines $\\lambda$:\n\n$$\n\\bar{\\mu} = \\tilde{\\mu}'\\omega^* = \\frac{\\lambda}{2}\\tilde{\\mu}'\\Sigma^{-1}\\tilde{\\mu} \\implies \\lambda = \\frac{2\\bar{\\mu}}{\\tilde{\\mu}'\\Sigma^{-1}\\tilde{\\mu}}\n$$\n\nSubstituting back:\n\n$$\n\\omega^* = \\frac{\\bar{\\mu}}{\\tilde{\\mu}'\\Sigma^{-1}\\tilde{\\mu}}\\Sigma^{-1}\\tilde{\\mu}\n$$\n\n### The Tangency Portfolio\n\nNotice something remarkable: the *direction* of $\\omega^*$ is always $\\Sigma^{-1}\\tilde{\\mu}$, regardless of the target return $\\bar{\\mu}$. Only the *scale* changes. This means all investors, regardless of their risk preferences, hold the *same portfolio of risky assets*. They differ only in how much they allocate to this portfolio versus the risk-free asset.\n\nTo obtain the portfolio of risky assets that is fully invested (weights summing to one), we normalize:\n\n$$\n\\omega_{\\text{tan}} = \\frac{\\omega^*}{\\iota'\\omega^*} = \\frac{\\Sigma^{-1}(\\mu - r_f)}{\\iota'\\Sigma^{-1}(\\mu - r_f)}\n$$\n\nThis is called the **tangency portfolio** (or maximum Sharpe ratio portfolio) because it lies at the point where the efficient frontier is tangent to the capital market line.\n\n### The Sharpe Ratio and the Capital Market Line\n\nThe **Sharpe ratio** measures excess return per unit of volatility:\n\n$$\n\\text{Sharpe Ratio} = \\frac{\\mu_p - r_f}{\\sigma_p}\n$$\n\nThe tangency portfolio maximizes the Sharpe ratio among all possible portfolios. Any combination of the risk-free asset and the tangency portfolio lies on a straight line in mean-standard deviation space, called the **Capital Market Line (CML)**:\n\n$$\n\\mu_p = r_f + \\left(\\frac{\\mu_{\\text{tan}} - r_f}{\\sigma_{\\text{tan}}}\\right)\\sigma_p\n$$\n\nThe slope of this line equals the Sharpe ratio of the tangency portfolio (i.e., the highest achievable Sharpe ratio).\n\n### Computing the Tangency Portfolio\n\nLet's compute the tangency portfolio for our VN30 universe:\n\n::: {#95e13c6e .cell execution_count=10}\n``` {.python .cell-code}\nassets = (returns_monthly\n    .groupby(\"symbol\", as_index=False)\n    .agg(\n        mu=(\"ret\", \"mean\"),\n        sigma=(\"ret\", \"std\")\n    )\n)\n\nsigma = (returns_monthly\n    .pivot(index=\"date\", columns=\"symbol\", values=\"ret\")\n    .cov()\n)\n\nmu = (returns_monthly\n    .groupby(\"symbol\")[\"ret\"]\n    .mean()\n    .values\n)\n```\n:::\n\n\n::: {#552d1ad7 .cell execution_count=11}\n``` {.python .cell-code}\n# Compute tangency portfolio weights\nw_tan = np.linalg.solve(sigma, mu - rf)\nw_tan = w_tan / np.sum(w_tan)\n\n# Portfolio performance metrics\nmu_w = w_tan.T @ mu\nsigma_w = np.sqrt(w_tan.T @ sigma @ w_tan)\n\nefficient_portfolios = pd.DataFrame([\n    {\"symbol\": r\"$\\omega_{\\mathrm{tan}}$\", \"mu\": mu_w, \"sigma\": sigma_w},\n    {\"symbol\": r\"$r_f$\", \"mu\": rf, \"sigma\": 0}\n])\n\nsharpe_ratio = (mu_w - rf) / sigma_w\n\nprint(f\"Tangency Portfolio Sharpe Ratio: {sharpe_ratio:.4f}\")\nprint(efficient_portfolios)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nTangency Portfolio Sharpe Ratio: -0.5552\n                    symbol        mu     sigma\n0  $\\omega_{\\mathrm{tan}}$ -0.041157  0.077866\n1                    $r_f$  0.002076  0.000000\n```\n:::\n:::\n\n\n### Visualizing the Efficient Frontier with a Risk-Free Asset\n\n@fig-300 shows the efficient frontier when a risk-free asset is available. The frontier is now a straight line (the Capital Market Line) connecting the risk-free asset to the tangency portfolio and extending beyond.\n\n::: {#cell-fig-300 .cell execution_count=12}\n``` {.python .cell-code}\nefficient_portfolios_figure = (\n    ggplot(efficient_portfolios, aes(x=\"sigma\", y=\"mu\"))\n    + geom_point(data=assets)\n    + geom_point(data=efficient_portfolios, color=\"blue\", size=3)\n    + geom_label(\n        aes(label=\"symbol\"), \n        adjust_text={\"arrowprops\": {\"arrowstyle\": \"-\"}}\n    )\n    + scale_x_continuous(labels=percent_format())\n    + scale_y_continuous(labels=percent_format())\n    + labs(\n        x=\"Volatility (Standard Deviation)\", \n        y=\"Expected Return\",\n        title=\"Efficient Frontier with Risk-Free Asset (VN30)\"\n    )\n    + geom_abline(slope=sharpe_ratio, intercept=rf, linetype=\"dotted\")\n)\n\nefficient_portfolios_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![The efficient frontier with a risk-free asset becomes a straight line (the Capital Market Line) connecting the risk-free rate to the tangency portfolio. Individual assets lie below this line, demonstrating the benefits of diversification.](03_capm_files/figure-html/fig-300-output-1.png){#fig-300 width=672 height=480 fig-alt='Title: The efficient frontier with a risk-free asset and VN30 index constituents. The figure shows a scatter plot with volatilities on the horizontal axis and expected returns on the vertical axis. A dotted line represents the Capital Market Line.'}\n:::\n:::\n\n\nYou may notice that estimated expected returns appear quite low, some even negative. This is not a model failure but reflects the realities of estimation:\n\n1. **Sample period matters**: If the estimation window includes market downturns (such as the 2022-2023 period), realized average returns can be near zero or negative. Mean-variance optimization takes sample means literally.\n\n2. **Estimation noise in emerging markets**: With volatile emerging market data, sample means are dominated by noise. A few extremely bad months can push the average below the risk-free rate even if the long-run equity premium is positive.\n\nThis highlights a fundamental challenge in portfolio optimization: the inputs we observe (historical returns) are noisy estimates of the true parameters we need (expected future returns).\n\n## The CAPM Equation: Risk and Expected Return\n\n### From Individual Optimization to Market Equilibrium\n\nSo far, we've focused on one investor's optimization problem. The CAPM's power comes from considering what happens when *all* investors optimize simultaneously.\n\nIf all investors follow mean-variance optimization, they all hold some combination of the risk-free asset and the tangency portfolio. The only difference between investors is their risk tolerance. More risk-averse investors hold more of the risk-free asset, while risk-tolerant investors may even borrow at the risk-free rate to leverage their position in the tangency portfolio.\n\n### The Market Portfolio\n\nIn equilibrium, the total demand for each risky asset must equal its supply. Since all investors hold the same portfolio of risky assets (the tangency portfolio), the equilibrium portfolio weights must equal the *market capitalization weights*. The tangency portfolio *is* the market portfolio.\n\nThis insight has enormous practical implications: instead of estimating expected returns and covariances to compute the tangency portfolio, we can simply use the market portfolio (approximated by a broad market index) as a proxy.\n\n### Deriving the CAPM Equation\n\nFrom the first-order conditions of the optimization problem, we derived that:\n\n$$\n\\tilde{\\mu} = \\frac{2}{\\lambda}\\Sigma\\omega^*\n$$\n\nSince $\\omega^*$ is proportional to $\\omega_{\\text{tan}}$, and in equilibrium $\\omega_{\\text{tan}}$ equals the market portfolio $\\omega_m$:\n\n$$\n\\tilde{\\mu} = c \\cdot \\Sigma\\omega_m\n$$\n\nfor some constant $c$. The $i$-th element of $\\Sigma\\omega_m$ is:\n\n$$\n\\sum_{j=1}^N \\sigma_{ij}\\omega_{m,j} = \\text{Cov}(r_i, r_m)\n$$\n\nwhere $r_m = \\sum_j \\omega_{m,j} r_j$ is the return on the market portfolio.\n\nFor the market portfolio itself:\n\n$$\n\\tilde{\\mu}_m = c \\cdot \\text{Var}(r_m) = c \\cdot \\sigma_m^2\n$$\n\nTherefore $c = \\tilde{\\mu}_m / \\sigma_m^2$, and for any asset $i$:\n\n$$\n\\tilde{\\mu}_i = \\frac{\\tilde{\\mu}_m}{\\sigma_m^2} \\text{Cov}(r_i, r_m) = \\beta_i \\tilde{\\mu}_m\n$$\n\nwhere:\n\n$$\n\\beta_i = \\frac{\\text{Cov}(r_i, r_m)}{\\text{Var}(r_m)}\n$$\n\nThis is the famous **CAPM equation**:\n\n$$\nE(r_i) - r_f = \\beta_i [E(r_m) - r_f]\n$$\n\n### Interpreting Beta\n\nBeta ($\\beta_i$) measures an asset's **systematic risk** (i.e., its sensitivity to market movements). The interpretation is straightforward:\n\n- $\\beta = 1$: The asset moves one-for-one with the market (average systematic risk)\n- $\\beta > 1$: The asset amplifies market movements (aggressive, high systematic risk)\n- $\\beta < 1$: The asset dampens market movements (defensive, low systematic risk)\n- $\\beta < 0$: The asset moves opposite to the market (provides insurance)\n\nThe CAPM says that expected excess return is proportional to beta, not to total volatility. This explains why:\n\n1. An asset with zero beta earns only the risk-free rate (i.e., its risk is entirely idiosyncratic).\n2. An asset with beta of 1 earns the market risk premium\n3. A negative-beta asset earns *less* than the risk-free rate (i.e., investors pay for its insurance properties).\n\n## The Security Market Line\n\nThe CAPM predicts a linear relationship between beta and expected return. This relationship is called the **Security Market Line (SML)**:\n\n$$\nE(r_i) = r_f + \\beta_i [E(r_m) - r_f]\n$$\n\nUnlike the Capital Market Line (which plots expected return against total risk), the Security Market Line plots expected return against systematic risk (beta).\n\n::: {#ee8d3554 .cell execution_count=13}\n``` {.python .cell-code}\nbetas = (sigma @ w_tan) / (w_tan.T @ sigma @ w_tan)\nassets[\"beta\"] = betas.values\n\nprice_of_risk = float(w_tan.T @ mu - rf)\n\nassets_figure = (\n    ggplot(assets, aes(x=\"beta\", y=\"mu\"))\n    + geom_point()\n    + geom_abline(intercept=rf, slope=price_of_risk)\n    + scale_y_continuous(labels=percent_format())\n    + labs(\n        x=\"Beta (Systematic Risk)\", \n        y=\"Expected Return\",\n        title=\"Security Market Line\"\n    )\n    + annotate(\"text\", x=0.05, y=rf + 0.001, label=\"Risk-free rate\")\n)\n\nassets_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![](03_capm_files/figure-html/cell-13-output-1.png){width=672 height=480}\n:::\n:::\n\n\nYou may observe that the estimated SML has a negative slope, which seems to contradict CAPM's prediction. This reflects a **negative estimated market risk premium** in our sample period (i.e., the market portfolio earned less than the risk-free rate).\n\nWhen the market risk premium is negative, CAPM predicts that high-beta stocks should have *lower* expected returns than low-beta stocks. This is not a model failure, the model is behaving consistently. Rather, it reflects an unusual (but not impossible) sample period where risky assets underperformed safe assets.\n\nThis observation highlights an important distinction: CAPM describes *expected* returns in equilibrium, but *realized* returns over any particular period may differ substantially from expectations due to shocks and surprises.\n\n## Empirical Estimation of CAPM Parameters\n\n### The Regression Framework\n\nIn practice, we estimate CAPM parameters using time-series regression. The model implies:\n\n$$\nr_{i,t} - r_{f,t} = \\alpha_i + \\beta_i(r_{m,t} - r_{f,t}) + \\varepsilon_{i,t}\n$$\n\nwhere:\n\n- $r_{i,t}$: Return on asset $i$ at time $t$\n- $r_{f,t}$: Risk-free rate at time $t$\n- $r_{m,t}$: Market return at time $t$\n- $\\alpha_i$: Intercept (should be zero if CAPM holds)\n- $\\beta_i$: Systematic risk (slope coefficient)\n- $\\varepsilon_{i,t}$: Idiosyncratic shock (residual)\n\n### Alpha: Risk-Adjusted Performance\n\nThe intercept $\\alpha_i$ measures **risk-adjusted performance**. If CAPM holds perfectly, alpha should be zero for all assets (i.e., any excess return is exactly compensated by systematic risk).\n\n- $\\alpha > 0$: The asset outperformed its CAPM-predicted return (positive abnormal return)\n- $\\alpha < 0$: The asset underperformed its CAPM-predicted return (negative abnormal return)\n\nPositive alpha is the holy grail of active management: earning returns beyond what systematic risk exposure would justify.\n\n### Loading Factor Data\n\nWe use Fama-French market excess returns as our market portfolio proxy. These data provide a widely accepted benchmark that is already adjusted for the risk-free rate:\n\n::: {#484e89a8 .cell execution_count=14}\n``` {.python .cell-code}\nimport sqlite3\n\ntidy_finance = sqlite3.connect(database=\"data/tidy_finance_python.sqlite\")\n\nfactors = pd.read_sql_query(\n    sql=\"SELECT * FROM factors_ff5_monthly\",\n    con=tidy_finance,\n    parse_dates={\"date\"}\n)\n\nfactors.head(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>date</th>\n      <th>smb</th>\n      <th>hml</th>\n      <th>rmw</th>\n      <th>cma</th>\n      <th>mkt_excess</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>2011-07-31</td>\n      <td>0.008933</td>\n      <td>-0.013099</td>\n      <td>0.012139</td>\n      <td>-0.009529</td>\n      <td>-0.011287</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>2011-08-31</td>\n      <td>0.004830</td>\n      <td>-0.016656</td>\n      <td>0.014516</td>\n      <td>-0.003981</td>\n      <td>0.007856</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>2011-09-30</td>\n      <td>0.004970</td>\n      <td>-0.000462</td>\n      <td>0.008899</td>\n      <td>0.001241</td>\n      <td>-0.006501</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n### Running the Regressions\n\nWe estimate CAPM regressions for each stock in our universe:\n\n::: {#f7fed34a .cell execution_count=15}\n``` {.python .cell-code}\nimport statsmodels.formula.api as smf\n\nreturns_excess_monthly = (returns_monthly\n    .merge(factors, on=\"date\", how=\"left\")\n    .assign(ret_excess=lambda x: x[\"ret\"] - x[\"risk_free\"])\n)\n\n\ndef estimate_capm(data):\n    model = smf.ols(\"ret_excess ~ mkt_excess\", data=data).fit()\n    result = pd.DataFrame({\n        \"coefficient\": [\"alpha\", \"beta\"],\n        \"estimate\": model.params.values,\n        \"t_statistic\": model.tvalues.values\n    })\n    return result\n\n\ncapm_results = (returns_excess_monthly\n    .groupby(\"symbol\", group_keys=True)\n    .apply(estimate_capm)\n    .reset_index()\n)\n\ncapm_results.head(4)\n```\n\n::: {.cell-output .cell-output-display execution_count=14}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>symbol</th>\n      <th>level_1</th>\n      <th>coefficient</th>\n      <th>estimate</th>\n      <th>t_statistic</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>ACB</td>\n      <td>0</td>\n      <td>alpha</td>\n      <td>-0.007479</td>\n      <td>-0.876326</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>ACB</td>\n      <td>1</td>\n      <td>beta</td>\n      <td>-0.240019</td>\n      <td>-0.252484</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>BCM</td>\n      <td>0</td>\n      <td>alpha</td>\n      <td>0.027827</td>\n      <td>1.737895</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>BCM</td>\n      <td>1</td>\n      <td>beta</td>\n      <td>4.150186</td>\n      <td>2.625283</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n### Visualizing Alpha Estimates\n\n@fig-305 shows the estimated alphas across our VN30 sample. Statistical significance (at the 95% level) is indicated by color.\n\n::: {#cell-fig-305 .cell execution_count=16}\n``` {.python .cell-code}\nalphas = (capm_results\n    .query(\"coefficient == 'alpha'\")\n    .assign(is_significant=lambda x: np.abs(x[\"t_statistic\"]) >= 1.96)\n)\n\nalphas[\"symbol\"] = pd.Categorical(\n    alphas[\"symbol\"],\n    categories=alphas.sort_values(\"estimate\")[\"symbol\"],\n    ordered=True\n)\n\nalphas_figure = (\n    ggplot(alphas, aes(y=\"estimate\", x=\"symbol\", fill=\"is_significant\"))\n    + geom_col()\n    + scale_y_continuous(labels=percent_format())\n    + coord_flip()\n    + labs(\n        x=\"\", \n        y=\"Estimated Alpha (Monthly)\", \n        fill=\"Significant at 95%?\",\n        title=\"Estimated CAPM Alphas for VN30 Index Constituents\"\n    )\n)\n\nalphas_figure.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Estimated CAPM alphas for VN30 index constituents. Color indicates statistical significance at the 95% confidence level. Most alphas are statistically indistinguishable from zero, consistent with CAPM predictions.](03_capm_files/figure-html/fig-305-output-1.png){#fig-305 width=672 height=480 fig-alt='Title: Estimated CAPM alphas for VN30 index constituents. The figure shows a bar chart with estimated alphas and indicates whether each estimate is statistically significant at 95%.'}\n:::\n:::\n\n\nThe distribution of alphas provides evidence on CAPM's empirical validity. If the model holds, we expect:\n\n1. Most alphas close to zero\n2. Few statistically significant alphas\n3. Roughly equal numbers of positive and negative alphas\n\nSystematic patterns in alphas, such as consistently positive alphas for certain types of stocks, would suggest the CAPM is incomplete and that additional risk factors may be needed.\n\n## Limitations and Extensions\n\n### The Market Portfolio Problem\n\nA fundamental challenge in testing the CAPM is identifying the market portfolio. The theory requires a portfolio that includes *all* investable assets, not just stocks, but also bonds, real estate, private businesses, human capital, and even intangible assets. In practice, we use proxies like broad market indices (VNI, S&P 500), but these capture only publicly traded equities.\n\nThis limitation is profound. As Richard Roll famously argued, the CAPM is essentially untestable because the true market portfolio is unobservable. Any test of the CAPM is simultaneously a test of whether our proxy adequately represents the market.\n\n### Time-Varying Betas\n\nThe CAPM assumes that betas are constant over time, but this assumption rarely holds in practice. Companies undergo changes that affect their market sensitivity:\n\n- **Capital structure changes**: Increasing leverage raises beta\n- **Business model evolution**: Diversification into new industries can alter systematic risk\n- **Market conditions**: Betas often increase during market stress\n\nConditional CAPM models [@Jagannathan1996] address this by allowing risk premiums and betas to vary with the business cycle.\n\n### Empirical Anomalies\n\nDecades of empirical research have documented patterns in stock returns that CAPM cannot explain:\n\n1. **Size effect**: Small-cap stocks tend to outperform large-cap stocks, even after adjusting for beta\n2. **Value effect**: Stocks with high book-to-market ratios outperform growth stocks\n3. **Momentum**: Stocks that performed well recently tend to continue performing well\n\nThese anomalies suggest that systematic risk has multiple dimensions beyond market exposure.\n\n### Multifactor Extensions\n\nThe limitations of CAPM have led to increasingly sophisticated asset pricing models. The **Fama-French three-factor model** [@Fama1992] adds two factors to capture size and value effects:\n\n- **SMB (Small Minus Big)**: Returns on small stocks minus large stocks\n- **HML (High Minus Low)**: Returns on value stocks minus growth stocks\n\nThe **Fama-French five-factor model** [@FamaFrench2015] adds two more dimensions:\n\n- **RMW (Robust Minus Weak)**: Returns on profitable firms minus unprofitable firms  \n- **CMA (Conservative Minus Aggressive)**: Returns on conservative investors minus aggressive investors\n\nThe **Carhart four-factor model** [@Carhart1997] adds momentum to the three-factor framework.\n\nOther theoretical developments include:\n\n- **Consumption CAPM**: Links asset prices to macroeconomic consumption risk\n- **Q-factor model** [@Hou2015]: Derives factors from investment-based asset pricing theory\n- **Arbitrage Pricing Theory**: Allows for multiple sources of systematic risk without specifying their identity\n\nDespite its limitations, the CAPM remains valuable as a conceptual benchmark. Its core insight (i.e., only systematic, undiversifiable risk commands a premium) continues to inform how we think about risk and return.\n\n## Key Takeaways\n\nThis chapter introduced the Capital Asset Pricing Model and its implications for understanding the relationship between risk and expected return. The main insights are:\n\n1. **Not all risk is rewarded**: The CAPM distinguishes between systematic risk (which cannot be diversified away and commands a premium) and idiosyncratic risk (which can be eliminated through diversification and earns no premium).\n\n2. **The tangency portfolio is universal**: When a risk-free asset exists, all mean-variance investors hold the same portfolio of risky assets (i.e., the tangency or maximum Sharpe ratio portfolio). They differ only in how much they allocate to this portfolio versus the risk-free asset.\n\n3. **In equilibrium, the tangency portfolio is the market portfolio**: Since all investors hold the same risky portfolio, and total demand must equal supply, the equilibrium portfolio weights are market capitalization weights.\n\n4. **Expected returns depend on beta**: The CAPM equation states that expected excess return equals beta times the market risk premium. Beta measures covariance with the market portfolio, normalized by market variance.\n\n5. **Alpha measures risk-adjusted performance**: Positive alpha indicates returns above what systematic risk would justify; negative alpha indicates underperformance.\n\n6. **Empirical challenges exist**: Testing the CAPM requires identifying the market portfolio, which is unobservable in practice. Documented anomalies (size, value, momentum) suggest additional risk factors beyond market exposure.\n\n7. **Extensions abound**: Multifactor models like Fama-French extend the CAPM framework by adding factors that capture dimensions of systematic risk the market factor misses.\n\nThe CAPM's elegance lies in its simplicity: a single factor (i.e., exposure to the market) should explain expected returns in equilibrium. While reality is more complex, this framework provides the foundation for all modern asset pricing theory.\n\n",
    "supporting": [
      "03_capm_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}