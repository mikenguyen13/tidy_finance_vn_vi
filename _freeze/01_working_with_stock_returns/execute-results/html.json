{
  "hash": "7338b6d3b0d7de664932de9a2c9cfed5",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Constructing and Analyzing Equity Return Series\nformat:\n  html:\n    toc: true\n    number-sections: true\njupyter: python3\nexecute:\n  echo: true\n  warning: false\n  message: false\n---\n\nThis chapter develops a practical framework for transforming raw equity price records into return series suitable for empirical financial analysis. The focus is on methodological clarity and reproducibility, with particular attention to data issues that are prevalent in emerging equity markets such as Vietnam. \n\nThe discussion proceeds from individual stocks to a broad market cross-section, using constituents of the VN30 index as the primary empirical setting.\n\n## Data Access and Preparation\n\nWe begin by loading the core numerical and data manipulation libraries. These provide all functionality required for return construction without relying on specialized financial wrappers.\n\n::: {#e20b7a6b .cell execution_count=2}\n``` {.python .cell-code}\nimport pandas as pd\nimport numpy as np\n```\n:::\n\n\nHistorical price data are stored in an S3-compatible object storage system. Access credentials are supplied via environment variables, which keeps sensitive information separate from the analysis and supports collaborative reproducibility.\n\n::: {#efd62e65 .cell execution_count=3}\n``` {.python .cell-code}\nimport os\nimport boto3\nfrom botocore.client import Config\n\n\nclass ObjectStorage:\n    def __init__(self):\n        self.client = boto3.client(\n            \"s3\",\n            endpoint_url=os.environ[\"MINIO_ENDPOINT\"],\n            aws_access_key_id=os.environ[\"MINIO_ACCESS_KEY\"],\n            aws_secret_access_key=os.environ[\"MINIO_SECRET_KEY\"],\n            region_name=os.getenv(\"MINIO_REGION\", \"us-east-1\"),\n            config=Config(signature_version=\"s3v4\"),\n        )\n\n\nstorage = ObjectStorage()\nbucket = os.environ[\"MINIO_BUCKET\"]\n```\n:::\n\n\nThe daily price file is read directly into memory. We explicitly parse dates and harmonize variable names to avoid ambiguity in later steps.\n\n::: {#6aff529b .cell execution_count=4}\n``` {.python .cell-code}\nfrom io import BytesIO\n\nprices = pd.read_csv(\n    BytesIO(\n        storage.client.get_object(\n            Bucket=bucket,\n            Key=\"historycal_price/dataset_historical_price.csv\",\n        )[\"Body\"].read()\n    ),\n    low_memory=False,\n)\n\n\nprices[\"date\"] = pd.to_datetime(prices[\"date\"])\n\n\nprices[\"adjusted_close\"] = prices[\"close_price\"] * prices[\"adj_ratio\"]\n\n\nprices = prices.rename(\n    columns={\n        \"vol_total\": \"volume\",\n        \"open_price\": \"open\",\n        \"low_price\": \"low\",\n        \"high_price\": \"high\",\n        \"close_price\": \"close\",\n    }\n)\n\nprices = prices.sort_values([\"symbol\", \"date\"])\n```\n:::\n\n\nAdjusted closing prices incorporate mechanical changes due to corporate actions such as cash dividends and stock splits. Using adjusted prices ensures that subsequent return calculations reflect investor-relevant performance rather than accounting artifacts.\n\n## Examining a Single Equity\n\nTo ground the discussion, we isolate the trading history of a single large-cap stock, FPT, over a long sample period.\n\n::: {#9eeca823 .cell execution_count=5}\n``` {.python .cell-code}\nimport datetime as dt\n\nstart = pd.Timestamp(\"2000-01-01\")\nend = pd.Timestamp(dt.date.today().year - 1, 12, 31)\n\n\nfpt = prices.loc[\n    (prices[\"symbol\"] == \"FPT\")\n    & (prices[\"date\"] >= start)\n    & (prices[\"date\"] <= end),\n    [\"date\", \"symbol\", \"volume\", \"open\", \"low\", \"high\", \"close\", \"adjusted_close\"],\n].copy()\n```\n:::\n\n\nThis subset contains the standard daily market variables required for most empirical studies. Before computing returns, it is good practice to visually inspect the price series.\n\n::: {#e31dbdf0 .cell execution_count=6}\n``` {.python .cell-code}\nfrom plotnine import ggplot, aes, geom_line, labs\n```\n:::\n\n\n::: {#cell-fig-100 .cell execution_count=7}\n``` {.python .cell-code}\n(\n    ggplot(fpt, aes(x=\"date\", y=\"adjusted_close\"))\n    + geom_line()\n    + labs(title=\"Adjusted price path of FPT\", x=\"\", y=\"\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n![Prices are in VND, adjusted for dividend payments and stock splits.](01_working_with_stock_returns_files/figure-html/fig-100-output-1.png){#fig-100 width=672 height=480 fig-alt='Title: FPT stock prices'}\n:::\n:::\n\n\n## From Prices to Returns\n\nMost empirical asset pricing models are formulated in terms of returns rather than price levels. The simple daily return is defined as\n\n$$\nr_t = \\frac{p_t}{p_t - 1} - 1, \n$$\n\n\nwhere $p_t$ denotes the adjusted closing price at the end of trading day $t$.\n\nBefore computing returns, we must address invalid price observations. In Vietnamese equity data, adjusted prices occasionally take the value zero. These entries typically arise from IPO placeholders, trading suspensions, or historical backfilling conventions and cannot be used to compute meaningful returns.\n\n::: {#1a868632 .cell execution_count=8}\n``` {.python .cell-code}\nprices.loc[prices[\"adjusted_close\"] <= 0, [\"symbol\", \"date\", \"adjusted_close\"]].head()\n```\n\n::: {.cell-output .cell-output-display execution_count=7}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>symbol</th>\n      <th>date</th>\n      <th>adjusted_close</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>33886</th>\n      <td>ADP</td>\n      <td>2010-02-09</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>33887</th>\n      <td>ADP</td>\n      <td>2010-02-24</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>33888</th>\n      <td>ADP</td>\n      <td>2010-03-01</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>33889</th>\n      <td>ADP</td>\n      <td>2010-03-03</td>\n      <td>0.0</td>\n    </tr>\n    <tr>\n      <th>33890</th>\n      <td>ADP</td>\n      <td>2010-03-12</td>\n      <td>0.0</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\nWe therefore exclude non-positive adjusted prices and compute returns stock by stock. Correct chronological ordering is essential.\n\n::: {#0040738c .cell execution_count=9}\n``` {.python .cell-code}\nreturns = (\n    prices\n    .loc[prices[\"adjusted_close\"] > 0]\n    .sort_values([\"symbol\", \"date\"])\n    .assign(ret=lambda x: x.groupby(\"symbol\")[\"adjusted_close\"].pct_change())\n    [[\"symbol\", \"date\", \"ret\"]]\n)\nreturns = returns.dropna(subset=[\"ret\"])\n```\n:::\n\n\nThe initial return for each stock is missing by construction, since no lagged price is available. These observations are mechanical and can safely be removed in most applications.\n\n## Limiting the Influence of Extreme Returns\n\nDaily return series often contain extreme observations driven by data errors, thin trading, or abrupt price adjustments. A common approach is to winsorize returns using cross-sectional percentile cutoffs.\n\n::: {#b3b3578f .cell execution_count=10}\n``` {.python .cell-code}\ndef winsorize_cs(df, column=\"ret\", lower_q=0.01, upper_q=0.99):\n    lo = df[column].quantile(lower_q)\n    hi = df[column].quantile(upper_q)\n    out = df.copy()\n    out[column] = out[column].clip(lo, hi)\n    return out\n\nreturns = winsorize_cs(returns)\n```\n:::\n\n\nApplying winsorization across the full cross-section limits the impact of extreme market-wide observations while preserving relative differences between firms. Winsorizing within each stock is rarely appropriate in panel settings and can severely distort illiquid securities.\n\n## Distributional Features of Returns\n\nWe next examine the empirical distribution of daily returns for FPT. The figure below also marks the historical 5 percent quantile, which provides a simple, non-parametric measure of downside risk.\n\n::: {#324454f8 .cell execution_count=11}\n``` {.python .cell-code}\nfrom mizani.formatters import percent_format\nfrom plotnine import geom_histogram, geom_vline, scale_x_continuous\n\n\nfpt_ret = returns.loc[returns[\"symbol\"] == \"FPT\"].copy()\nq05 = fpt_ret[\"ret\"].quantile(0.05)\n```\n:::\n\n\n::: {#cell-fig-101 .cell execution_count=12}\n``` {.python .cell-code}\n(\n    ggplot(fpt_ret, aes(x=\"ret\"))\n    + geom_histogram(bins=100)\n    + geom_vline(xintercept=q05, linetype=\"dashed\")\n    + scale_x_continuous(labels=percent_format())\n    + labs(title=\"Distribution of daily FPT returns\", x=\"\", y=\"\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=11}\n![The dotted vertical line indicates the historical five percent quantile.](01_working_with_stock_returns_files/figure-html/fig-101-output-1.png){#fig-101 width=672 height=480 fig-alt='Title: Distribution of daily FPT stock returns in percent. The figure shows a histogram of daily returns. The vertical line indicates that the historical five percent quantile of daily returns was around negative three percent.'}\n:::\n:::\n\n\nSummary statistics offer a compact description of return behavior and should always be inspected before formal modeling.\n\n::: {#61cd29d5 .cell execution_count=13}\n``` {.python .cell-code}\nreturns[\"ret\"].describe().round(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=12}\n```\ncount    4305063.000\nmean           0.000\nstd            0.035\nmin           -0.125\n25%           -0.004\n50%            0.000\n75%            0.003\nmax            0.130\nName: ret, dtype: float64\n```\n:::\n:::\n\n\nComputing these statistics by calendar year can reveal periods of elevated volatility or structural change.\n\n::: {#cb82daad .cell execution_count=14}\n``` {.python .cell-code}\n(\n    returns\n    .assign(year=lambda x: x[\"date\"].dt.year)\n    .groupby(\"year\")[\"ret\"]\n    .describe()\n    .round(3)\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=13}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>count</th>\n      <th>mean</th>\n      <th>std</th>\n      <th>min</th>\n      <th>25%</th>\n      <th>50%</th>\n      <th>75%</th>\n      <th>max</th>\n    </tr>\n    <tr>\n      <th>year</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>2010</th>\n      <td>131548.0</td>\n      <td>-0.001</td>\n      <td>0.036</td>\n      <td>-0.125</td>\n      <td>-0.021</td>\n      <td>0.0</td>\n      <td>0.018</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2011</th>\n      <td>166826.0</td>\n      <td>-0.003</td>\n      <td>0.033</td>\n      <td>-0.125</td>\n      <td>-0.020</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2012</th>\n      <td>177938.0</td>\n      <td>0.000</td>\n      <td>0.033</td>\n      <td>-0.125</td>\n      <td>-0.012</td>\n      <td>0.0</td>\n      <td>0.015</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2013</th>\n      <td>180417.0</td>\n      <td>0.001</td>\n      <td>0.033</td>\n      <td>-0.125</td>\n      <td>-0.004</td>\n      <td>0.0</td>\n      <td>0.008</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2014</th>\n      <td>181907.0</td>\n      <td>0.001</td>\n      <td>0.034</td>\n      <td>-0.125</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2015</th>\n      <td>197881.0</td>\n      <td>0.000</td>\n      <td>0.033</td>\n      <td>-0.125</td>\n      <td>-0.006</td>\n      <td>0.0</td>\n      <td>0.005</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2016</th>\n      <td>227896.0</td>\n      <td>0.000</td>\n      <td>0.035</td>\n      <td>-0.125</td>\n      <td>-0.005</td>\n      <td>0.0</td>\n      <td>0.003</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2017</th>\n      <td>283642.0</td>\n      <td>0.001</td>\n      <td>0.034</td>\n      <td>-0.125</td>\n      <td>-0.002</td>\n      <td>0.0</td>\n      <td>0.001</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2018</th>\n      <td>329887.0</td>\n      <td>0.000</td>\n      <td>0.035</td>\n      <td>-0.125</td>\n      <td>0.000</td>\n      <td>0.0</td>\n      <td>0.000</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2019</th>\n      <td>352754.0</td>\n      <td>0.000</td>\n      <td>0.033</td>\n      <td>-0.125</td>\n      <td>0.000</td>\n      <td>0.0</td>\n      <td>0.000</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2020</th>\n      <td>369367.0</td>\n      <td>0.001</td>\n      <td>0.035</td>\n      <td>-0.125</td>\n      <td>0.000</td>\n      <td>0.0</td>\n      <td>0.000</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2021</th>\n      <td>379415.0</td>\n      <td>0.002</td>\n      <td>0.038</td>\n      <td>-0.125</td>\n      <td>-0.005</td>\n      <td>0.0</td>\n      <td>0.007</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2022</th>\n      <td>387050.0</td>\n      <td>-0.001</td>\n      <td>0.038</td>\n      <td>-0.125</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.004</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2023</th>\n      <td>391605.0</td>\n      <td>0.001</td>\n      <td>0.034</td>\n      <td>-0.125</td>\n      <td>-0.002</td>\n      <td>0.0</td>\n      <td>0.002</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2024</th>\n      <td>400379.0</td>\n      <td>0.000</td>\n      <td>0.031</td>\n      <td>-0.125</td>\n      <td>-0.002</td>\n      <td>0.0</td>\n      <td>0.000</td>\n      <td>0.13</td>\n    </tr>\n    <tr>\n      <th>2025</th>\n      <td>146551.0</td>\n      <td>0.000</td>\n      <td>0.037</td>\n      <td>-0.125</td>\n      <td>-0.004</td>\n      <td>0.0</td>\n      <td>0.002</td>\n      <td>0.13</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Expanding to a Market Cross-Section\n\nThe same procedures apply naturally to a larger universe of stocks. We now restrict attention to the constituents of the VN30 index.\n\n::: {#33805cf6 .cell execution_count=15}\n``` {.python .cell-code}\nvn30 = [\n    \"ACB\",\"BCM\",\"BID\",\"BVH\",\"CTG\",\"FPT\",\"GAS\",\"GVR\",\"HDB\",\"HPG\",\n    \"MBB\",\"MSN\",\"MWG\",\"PLX\",\"POW\",\"SAB\",\"SHB\",\"SSB\",\"STB\",\"TCB\",\n    \"TPB\",\"VCB\",\"VHM\",\"VIB\",\"VIC\",\"VJC\",\"VNM\",\"VPB\",\"VRE\",\"EIB\",\n]\n\n\nprices_vn30 = prices.loc[prices[\"symbol\"].isin(vn30)]\nfrom plotnine import theme\n```\n:::\n\n\n::: {#cell-fig-102 .cell execution_count=16}\n``` {.python .cell-code}\n(\n    ggplot(prices_vn30, aes(x=\"date\", y=\"adjusted_close\", color=\"symbol\"))\n    + geom_line()\n    + labs(title=\"Adjusted prices of VN30 constituents\", x=\"\", y=\"\")\n    + theme(legend_position=\"none\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=15}\n![Prices in VND, adjusted for dividend payments and stock splits.](01_working_with_stock_returns_files/figure-html/fig-102-output-1.png){#fig-102 width=672 height=480 fig-alt='Title: Stock prices of VN30 index constituents.'}\n:::\n:::\n\n\nReturns for the VN30 universe are computed analogously.\n\n::: {#fbad5598 .cell execution_count=17}\n``` {.python .cell-code}\nreturns_vn30 = (\n    prices_vn30\n    .sort_values([\"symbol\", \"date\"])\n    .assign(ret=lambda x: x.groupby(\"symbol\")[\"adjusted_close\"].pct_change())\n    [[\"symbol\", \"date\", \"ret\"]]\n    .dropna()\n)\n\n\nreturns_vn30.groupby(\"symbol\")[\"ret\"].describe().round(3)\n```\n\n::: {.cell-output .cell-output-display execution_count=16}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>count</th>\n      <th>mean</th>\n      <th>std</th>\n      <th>min</th>\n      <th>25%</th>\n      <th>50%</th>\n      <th>75%</th>\n      <th>max</th>\n    </tr>\n    <tr>\n      <th>symbol</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>ACB</th>\n      <td>3822.0</td>\n      <td>-0.000</td>\n      <td>0.023</td>\n      <td>-0.407</td>\n      <td>-0.006</td>\n      <td>0.0</td>\n      <td>0.007</td>\n      <td>0.097</td>\n    </tr>\n    <tr>\n      <th>BCM</th>\n      <td>1795.0</td>\n      <td>0.001</td>\n      <td>0.027</td>\n      <td>-0.136</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.159</td>\n    </tr>\n    <tr>\n      <th>BID</th>\n      <td>2811.0</td>\n      <td>0.000</td>\n      <td>0.024</td>\n      <td>-0.369</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>BVH</th>\n      <td>3825.0</td>\n      <td>0.000</td>\n      <td>0.024</td>\n      <td>-0.097</td>\n      <td>-0.012</td>\n      <td>0.0</td>\n      <td>0.012</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>CTG</th>\n      <td>3825.0</td>\n      <td>0.000</td>\n      <td>0.024</td>\n      <td>-0.376</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>EIB</th>\n      <td>3825.0</td>\n      <td>-0.000</td>\n      <td>0.022</td>\n      <td>-0.302</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.008</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>FPT</th>\n      <td>3825.0</td>\n      <td>-0.000</td>\n      <td>0.024</td>\n      <td>-0.439</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.009</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>GAS</th>\n      <td>3236.0</td>\n      <td>0.000</td>\n      <td>0.022</td>\n      <td>-0.289</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>GVR</th>\n      <td>1775.0</td>\n      <td>0.001</td>\n      <td>0.030</td>\n      <td>-0.137</td>\n      <td>-0.014</td>\n      <td>0.0</td>\n      <td>0.016</td>\n      <td>0.169</td>\n    </tr>\n    <tr>\n      <th>HDB</th>\n      <td>1828.0</td>\n      <td>-0.001</td>\n      <td>0.028</td>\n      <td>-0.391</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>HPG</th>\n      <td>3825.0</td>\n      <td>-0.001</td>\n      <td>0.032</td>\n      <td>-0.581</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>MBB</th>\n      <td>3371.0</td>\n      <td>-0.000</td>\n      <td>0.023</td>\n      <td>-0.473</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.008</td>\n      <td>0.069</td>\n    </tr>\n    <tr>\n      <th>MSN</th>\n      <td>3825.0</td>\n      <td>0.000</td>\n      <td>0.024</td>\n      <td>-0.553</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>MWG</th>\n      <td>2701.0</td>\n      <td>-0.000</td>\n      <td>0.035</td>\n      <td>-0.751</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>PLX</th>\n      <td>2009.0</td>\n      <td>-0.000</td>\n      <td>0.021</td>\n      <td>-0.140</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>POW</th>\n      <td>1784.0</td>\n      <td>0.000</td>\n      <td>0.023</td>\n      <td>-0.071</td>\n      <td>-0.012</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.102</td>\n    </tr>\n    <tr>\n      <th>SAB</th>\n      <td>2100.0</td>\n      <td>-0.000</td>\n      <td>0.024</td>\n      <td>-0.745</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.007</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>SHB</th>\n      <td>3824.0</td>\n      <td>-0.000</td>\n      <td>0.028</td>\n      <td>-0.338</td>\n      <td>-0.013</td>\n      <td>0.0</td>\n      <td>0.013</td>\n      <td>0.100</td>\n    </tr>\n    <tr>\n      <th>SSB</th>\n      <td>1029.0</td>\n      <td>-0.000</td>\n      <td>0.023</td>\n      <td>-0.292</td>\n      <td>-0.005</td>\n      <td>0.0</td>\n      <td>0.004</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>STB</th>\n      <td>3825.0</td>\n      <td>0.000</td>\n      <td>0.024</td>\n      <td>-0.321</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>TCB</th>\n      <td>1732.0</td>\n      <td>-0.000</td>\n      <td>0.035</td>\n      <td>-0.884</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>TPB</th>\n      <td>1761.0</td>\n      <td>-0.001</td>\n      <td>0.029</td>\n      <td>-0.477</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.009</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VCB</th>\n      <td>3825.0</td>\n      <td>-0.000</td>\n      <td>0.024</td>\n      <td>-0.539</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.009</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VHM</th>\n      <td>1744.0</td>\n      <td>-0.000</td>\n      <td>0.024</td>\n      <td>-0.419</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.008</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VIB</th>\n      <td>2072.0</td>\n      <td>-0.000</td>\n      <td>0.031</td>\n      <td>-0.489</td>\n      <td>-0.009</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.109</td>\n    </tr>\n    <tr>\n      <th>VIC</th>\n      <td>3825.0</td>\n      <td>-0.000</td>\n      <td>0.027</td>\n      <td>-0.673</td>\n      <td>-0.008</td>\n      <td>0.0</td>\n      <td>0.008</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VJC</th>\n      <td>2046.0</td>\n      <td>-0.000</td>\n      <td>0.020</td>\n      <td>-0.455</td>\n      <td>-0.007</td>\n      <td>0.0</td>\n      <td>0.006</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VNM</th>\n      <td>3825.0</td>\n      <td>-0.000</td>\n      <td>0.023</td>\n      <td>-0.547</td>\n      <td>-0.007</td>\n      <td>0.0</td>\n      <td>0.007</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VPB</th>\n      <td>1927.0</td>\n      <td>-0.000</td>\n      <td>0.033</td>\n      <td>-0.678</td>\n      <td>-0.010</td>\n      <td>0.0</td>\n      <td>0.010</td>\n      <td>0.070</td>\n    </tr>\n    <tr>\n      <th>VRE</th>\n      <td>1871.0</td>\n      <td>-0.000</td>\n      <td>0.024</td>\n      <td>-0.295</td>\n      <td>-0.012</td>\n      <td>0.0</td>\n      <td>0.011</td>\n      <td>0.070</td>\n    </tr>\n  </tbody>\n</table>\n</div>\n```\n:::\n:::\n\n\n## Aggregating Returns Across Time\n\nFinancial variables are observed at different frequencies. While equity prices are recorded daily, many empirical questions require monthly or annual returns. Lower-frequency returns are constructed by compounding higher-frequency observations.\n\n::: {#fea5a5cd .cell execution_count=18}\n``` {.python .cell-code}\nreturns_monthly = (\n    returns_vn30\n    .assign(month=lambda x: x[\"date\"].dt.to_period(\"M\").dt.to_timestamp())\n    .groupby([\"symbol\", \"month\"], as_index=False)\n    .agg(ret=(\"ret\", lambda x: np.prod(1 + x) - 1))\n)\n```\n:::\n\n\nComparing daily and monthly return distributions illustrates how aggregation dampens volatility and alters tail behavior.\n\n::: {#32890417 .cell execution_count=19}\n``` {.python .cell-code}\nfrom plotnine import facet_wrap\n\nfpt_d = returns_vn30.loc[returns_vn30[\"symbol\"] == \"FPT\"].assign(freq=\"Daily\")\nfpt_m = returns_monthly.loc[returns_monthly[\"symbol\"] == \"FPT\"].assign(freq=\"Monthly\")\n\n\nfpt_both = pd.concat([\n    fpt_d[[\"ret\", \"freq\"]],\n    fpt_m[[\"ret\", \"freq\"]],\n])\n```\n:::\n\n\n::: {#cell-fig-103 .cell execution_count=20}\n``` {.python .cell-code}\n(\n    ggplot(fpt_both, aes(x=\"ret\"))\n    + geom_histogram(bins=50)\n    + scale_x_continuous(labels=percent_format())\n    + labs(title=\"FPT returns at different frequencies\", x=\"\", y=\"\")\n    + facet_wrap(\"freq\", scales=\"free\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=19}\n![Returns are based on prices adjusted for dividend payments and stock splits.](01_working_with_stock_returns_files/figure-html/fig-103-output-1.png){#fig-103 width=672 height=480 fig-alt='Title: Distribution of FPT returns across different frequencies. The figure shows the distribution of daily and monthly returns in two separate facets.'}\n:::\n:::\n\n\n## Aggregation Across Firms: Trading Activity\n\nAggregation is not limited to time. In some settings, it is informative to aggregate variables across firms. As an illustration, we compute total daily trading value for VN30 stocks by multiplying share volume by adjusted prices and summing across firms.\n\n::: {#4c5d5d35 .cell execution_count=21}\n``` {.python .cell-code}\ntrading_value = (\n    prices_vn30\n    .assign(value=lambda x: x[\"volume\"] * x[\"adjusted_close\"] / 1e9)\n    .groupby(\"date\")[\"value\"]\n    .sum()\n    .reset_index()\n    .assign(value_lag=lambda x: x[\"value\"].shift(1))\n)\n(\n    ggplot(trading_value, aes(x=\"date\", y=\"value\"))\n    + geom_line()\n    + labs(title=\"Aggregate VN30 trading value (billion VND)\", x=\"\", y=\"\")\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=20}\n![](01_working_with_stock_returns_files/figure-html/cell-21-output-1.png){width=672 height=480}\n:::\n:::\n\n\nFinally, we assess persistence in trading activity by comparing trading value on consecutive days.\n\n::: {#00fc0cc4 .cell execution_count=22}\n``` {.python .cell-code}\nfrom plotnine import geom_point, geom_abline\n```\n:::\n\n\n::: {#cell-fig-104 .cell execution_count=23}\n``` {.python .cell-code}\n(\n    ggplot(trading_value, aes(x=\"value_lag\", y=\"value\"))\n    + geom_point()\n    + geom_abline(intercept=0, slope=1, linetype=\"dashed\")\n    + labs(\n        title=\"Persistence in VN30 trading value\",\n        x=\"Previous day\",\n        y=\"Current day\",\n    )\n)\n```\n\n::: {.cell-output .cell-output-display execution_count=22}\n![Total daily trading volume.](01_working_with_stock_returns_files/figure-html/fig-104-output-1.png){#fig-104 width=672 height=480 fig-alt='Title: Aggregate daily trading volume of VN30 index constitutens. The figure shows a volatile time series of daily trading volume.'}\n:::\n:::\n\n\nA strong alignment along the 45-degree line indicates that high-activity trading days tend to be followed by similarly active days, a common empirical regularity in equity markets.\n\n## Summary\n\nThis chapter established a reproducible workflow for transforming raw price data into return series, diagnosing common data issues, and aggregating information across time and firms. These steps provide the empirical foundation for subsequent analyses of risk, return predictability, and market dynamics in Vietnamâ€™s equity market.\n\n",
    "supporting": [
      "01_working_with_stock_returns_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}