<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7&nbsp; Accessing and Managing Financial Data – Tidy Finance in Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08_beta_estimation.html" rel="next">
<link href="./05_discounted_cash_flow.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./test.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Accessing and Managing Financial Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Tidy Finance in Vietnam</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./test.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Accessing and Managing Financial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Size Sorts and p-Hacking</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Replicating Fama-French Factors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-foundation-of-empirical-finance" id="toc-the-foundation-of-empirical-finance" class="nav-link active" data-scroll-target="#the-foundation-of-empirical-finance"><span class="header-section-number">7.1</span> The Foundation of Empirical Finance</a></li>
  <li><a href="#setting-up-the-sqlite-database" id="toc-setting-up-the-sqlite-database" class="nav-link" data-scroll-target="#setting-up-the-sqlite-database"><span class="header-section-number">7.2</span> Setting Up the SQLite Database</a>
  <ul class="collapse">
  <li><a href="#why-a-database-instead-of-csv-files" id="toc-why-a-database-instead-of-csv-files" class="nav-link" data-scroll-target="#why-a-database-instead-of-csv-files"><span class="header-section-number">7.2.1</span> Why a Database Instead of CSV Files?</a></li>
  <li><a href="#creating-the-database" id="toc-creating-the-database" class="nav-link" data-scroll-target="#creating-the-database"><span class="header-section-number">7.2.2</span> Creating the Database</a></li>
  </ul></li>
  <li><a href="#connecting-to-datacore" id="toc-connecting-to-datacore" class="nav-link" data-scroll-target="#connecting-to-datacore"><span class="header-section-number">7.3</span> Connecting to DataCore</a>
  <ul class="collapse">
  <li><a href="#establishing-the-connection" id="toc-establishing-the-connection" class="nav-link" data-scroll-target="#establishing-the-connection"><span class="header-section-number">7.3.1</span> Establishing the Connection</a></li>
  </ul></li>
  <li><a href="#downloading-and-preparing-stock-price-data" id="toc-downloading-and-preparing-stock-price-data" class="nav-link" data-scroll-target="#downloading-and-preparing-stock-price-data"><span class="header-section-number">7.4</span> Downloading and Preparing Stock Price Data</a>
  <ul class="collapse">
  <li><a href="#loading-historical-prices" id="toc-loading-historical-prices" class="nav-link" data-scroll-target="#loading-historical-prices"><span class="header-section-number">7.4.1</span> Loading Historical Prices</a></li>
  <li><a href="#cleaning-and-standardizing-price-data" id="toc-cleaning-and-standardizing-price-data" class="nav-link" data-scroll-target="#cleaning-and-standardizing-price-data"><span class="header-section-number">7.4.2</span> Cleaning and Standardizing Price Data</a></li>
  <li><a href="#computing-returns" id="toc-computing-returns" class="nav-link" data-scroll-target="#computing-returns"><span class="header-section-number">7.4.3</span> Computing Returns</a></li>
  <li><a href="#aggregating-to-monthly-frequency" id="toc-aggregating-to-monthly-frequency" class="nav-link" data-scroll-target="#aggregating-to-monthly-frequency"><span class="header-section-number">7.4.4</span> Aggregating to Monthly Frequency</a></li>
  <li><a href="#computing-market-capitalization" id="toc-computing-market-capitalization" class="nav-link" data-scroll-target="#computing-market-capitalization"><span class="header-section-number">7.4.5</span> Computing Market Capitalization</a></li>
  </ul></li>
  <li><a href="#downloading-and-preparing-company-fundamentals" id="toc-downloading-and-preparing-company-fundamentals" class="nav-link" data-scroll-target="#downloading-and-preparing-company-fundamentals"><span class="header-section-number">7.5</span> Downloading and Preparing Company Fundamentals</a>
  <ul class="collapse">
  <li><a href="#loading-fundamental-data" id="toc-loading-fundamental-data" class="nav-link" data-scroll-target="#loading-fundamental-data"><span class="header-section-number">7.5.1</span> Loading Fundamental Data</a></li>
  <li><a href="#cleaning-fundamental-data" id="toc-cleaning-fundamental-data" class="nav-link" data-scroll-target="#cleaning-fundamental-data"><span class="header-section-number">7.5.2</span> Cleaning Fundamental Data</a></li>
  <li><a href="#creating-standardized-variables" id="toc-creating-standardized-variables" class="nav-link" data-scroll-target="#creating-standardized-variables"><span class="header-section-number">7.5.3</span> Creating Standardized Variables</a></li>
  <li><a href="#computing-book-equity" id="toc-computing-book-equity" class="nav-link" data-scroll-target="#computing-book-equity"><span class="header-section-number">7.5.4</span> Computing Book Equity</a></li>
  <li><a href="#computing-profitability-and-investment" id="toc-computing-profitability-and-investment" class="nav-link" data-scroll-target="#computing-profitability-and-investment"><span class="header-section-number">7.5.5</span> Computing Profitability and Investment</a></li>
  <li><a href="#computing-total-debt" id="toc-computing-total-debt" class="nav-link" data-scroll-target="#computing-total-debt"><span class="header-section-number">7.5.6</span> Computing Total Debt</a></li>
  <li><a href="#filtering-to-valid-observations" id="toc-filtering-to-valid-observations" class="nav-link" data-scroll-target="#filtering-to-valid-observations"><span class="header-section-number">7.5.7</span> Filtering to Valid Observations</a></li>
  </ul></li>
  <li><a href="#merging-stock-prices-with-fundamentals" id="toc-merging-stock-prices-with-fundamentals" class="nav-link" data-scroll-target="#merging-stock-prices-with-fundamentals"><span class="header-section-number">7.6</span> Merging Stock Prices with Fundamentals</a>
  <ul class="collapse">
  <li><a href="#computing-market-capitalization-1" id="toc-computing-market-capitalization-1" class="nav-link" data-scroll-target="#computing-market-capitalization-1"><span class="header-section-number">7.6.1</span> Computing Market Capitalization</a></li>
  <li><a href="#computing-lagged-market-capitalization" id="toc-computing-lagged-market-capitalization" class="nav-link" data-scroll-target="#computing-lagged-market-capitalization"><span class="header-section-number">7.6.2</span> Computing Lagged Market Capitalization</a></li>
  <li><a href="#computing-excess-returns" id="toc-computing-excess-returns" class="nav-link" data-scroll-target="#computing-excess-returns"><span class="header-section-number">7.6.3</span> Computing Excess Returns</a></li>
  <li><a href="#final-cleaning" id="toc-final-cleaning" class="nav-link" data-scroll-target="#final-cleaning"><span class="header-section-number">7.6.4</span> Final Cleaning</a></li>
  </ul></li>
  <li><a href="#constructing-factor-data" id="toc-constructing-factor-data" class="nav-link" data-scroll-target="#constructing-factor-data"><span class="header-section-number">7.7</span> Constructing Factor Data</a>
  <ul class="collapse">
  <li><a href="#market-factor" id="toc-market-factor" class="nav-link" data-scroll-target="#market-factor"><span class="header-section-number">7.7.1</span> Market Factor</a></li>
  </ul></li>
  <li><a href="#storing-data-in-the-database" id="toc-storing-data-in-the-database" class="nav-link" data-scroll-target="#storing-data-in-the-database"><span class="header-section-number">7.8</span> Storing Data in the Database</a>
  <ul class="collapse">
  <li><a href="#storing-company-fundamentals" id="toc-storing-company-fundamentals" class="nav-link" data-scroll-target="#storing-company-fundamentals"><span class="header-section-number">7.8.1</span> Storing Company Fundamentals</a></li>
  <li><a href="#storing-monthly-prices" id="toc-storing-monthly-prices" class="nav-link" data-scroll-target="#storing-monthly-prices"><span class="header-section-number">7.8.2</span> Storing Monthly Prices</a></li>
  <li><a href="#storing-factor-data" id="toc-storing-factor-data" class="nav-link" data-scroll-target="#storing-factor-data"><span class="header-section-number">7.8.3</span> Storing Factor Data</a></li>
  </ul></li>
  <li><a href="#accessing-data-from-the-database" id="toc-accessing-data-from-the-database" class="nav-link" data-scroll-target="#accessing-data-from-the-database"><span class="header-section-number">7.9</span> Accessing Data from the Database</a></li>
  <li><a href="#descriptive-statistics" id="toc-descriptive-statistics" class="nav-link" data-scroll-target="#descriptive-statistics"><span class="header-section-number">7.10</span> Descriptive Statistics</a>
  <ul class="collapse">
  <li><a href="#sample-coverage-over-time" id="toc-sample-coverage-over-time" class="nav-link" data-scroll-target="#sample-coverage-over-time"><span class="header-section-number">7.10.1</span> Sample Coverage Over Time</a></li>
  <li><a href="#market-capitalization-distribution" id="toc-market-capitalization-distribution" class="nav-link" data-scroll-target="#market-capitalization-distribution"><span class="header-section-number">7.10.2</span> Market Capitalization Distribution</a></li>
  <li><a href="#book-equity-coverage" id="toc-book-equity-coverage" class="nav-link" data-scroll-target="#book-equity-coverage"><span class="header-section-number">7.10.3</span> Book Equity Coverage</a></li>
  </ul></li>
  <li><a href="#database-maintenance" id="toc-database-maintenance" class="nav-link" data-scroll-target="#database-maintenance"><span class="header-section-number">7.11</span> Database Maintenance</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">7.12</span> Key Takeaways</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Accessing and Managing Financial Data</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="the-foundation-of-empirical-finance" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="the-foundation-of-empirical-finance"><span class="header-section-number">7.1</span> The Foundation of Empirical Finance</h2>
<p>Every empirical finance project begins with data. Whether you’re testing asset pricing models, constructing portfolios, or valuing companies, the quality and organization of your data fundamentally determines the quality of your analysis. This chapter establishes the data infrastructure that supports all subsequent chapters in this book.</p>
<p>Working with financial data presents unique challenges. Data comes from multiple sources in different formats. Date handling varies across systems. Missing values require careful treatment. And as datasets grow, memory constraints become binding. A systematic approach to data management (e.g., downloading, cleaning, storing, and retrieving) saves enormous time and prevents errors that can invalidate entire analyses.</p>
<p>We address these challenges by building a centralized SQLite database that stores all our financial data in a consistent format. This approach offers several advantages over scattered CSV files: consistent data types across sessions, efficient queries for specific subsets, easy sharing across projects and collaborators, and a single source of truth that eliminates version confusion.</p>
<p>Our data infrastructure draws from two primary sources:</p>
<ol type="1">
<li><strong>Public macroeconomic data</strong> from sources like FRED (Federal Reserve Economic Data) and academic data libraries</li>
<li><strong>Vietnamese market data</strong> from DataCore, which provides stock prices, returns, and company fundamentals for firms listed on Vietnamese exchanges</li>
</ol>
<p>By the end of this chapter, you will have a fully populated database containing stock returns, market capitalizations, company fundamentals, and risk factors. Everything needed for the portfolio analyses and asset pricing tests in subsequent chapters.</p>
<div id="432a9800" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> comma_format, percent_format</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We define the date range for our analysis upfront, making future updates tractable:</p>
<div id="a1ba49a5" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"1960-01-01"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-12-31"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="setting-up-the-sqlite-database" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="setting-up-the-sqlite-database"><span class="header-section-number">7.2</span> Setting Up the SQLite Database</h2>
<p>Before downloading any data, we establish our storage infrastructure. We use SQLite, a lightweight, file-based database that requires no external server. SQLite is ideal for research applications: it’s fast, reliable, and the database file can be easily shared or moved between computers.</p>
<section id="why-a-database-instead-of-csv-files" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="why-a-database-instead-of-csv-files"><span class="header-section-number">7.2.1</span> Why a Database Instead of CSV Files?</h3>
<p>You might wonder why we bother with a database when CSV files seem simpler. Consider these common problems with CSV-based workflows:</p>
<ol type="1">
<li><p><strong>Type inconsistency</strong>: Dates read as strings in one session, datetime objects in another. Numeric columns sometimes include commas or currency symbols.</p></li>
<li><p><strong>Memory constraints</strong>: Large datasets must be loaded entirely into memory, even when you only need a small subset.</p></li>
<li><p><strong>Version confusion</strong>: Multiple copies of “cleaned” data proliferate across projects, each slightly different.</p></li>
<li><p><strong>Inefficient queries</strong>: Finding all observations for a specific firm requires loading the entire dataset.</p></li>
</ol>
<p>A database solves all these problems. Data types are enforced on storage. Queries retrieve only the rows and columns you need. A single database file serves as the authoritative source.</p>
</section>
<section id="creating-the-database" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="creating-the-database"><span class="header-section-number">7.2.2</span> Creating the Database</h3>
<p>Creating an SQLite database is remarkably simple:</p>
<div id="4c1c497b" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create data directory if it doesn't exist</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">"data"</span>):</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    os.makedirs(<span class="st">"data"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to database (creates file if it doesn't exist)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Database connection established"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Database connection established</code></pre>
</div>
</div>
<p>That’s it. The database file <code>tidy_finance_python.sqlite</code> now exists in the <code>data</code> subdirectory. We’ll populate it with tables throughout this chapter.</p>
</section>
</section>
<section id="connecting-to-datacore" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="connecting-to-datacore"><span class="header-section-number">7.3</span> Connecting to DataCore</h2>
<p>DataCore is a leading provider of financial and economic data for the Vietnamese market. It offers comprehensive coverage of stock prices, company fundamentals, and corporate actions for firms listed on the Ho Chi Minh Stock Exchange (HOSE) and Hanoi Stock Exchange (HNX).</p>
<p>Access to DataCore typically requires a subscription, available through many university libraries. If you don’t have access, DataCore provides demo datasets that allow you to run the code in this book with sample data.</p>
<section id="establishing-the-connection" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="establishing-the-connection"><span class="header-section-number">7.3.1</span> Establishing the Connection</h3>
<p>DataCore data is accessed through a MinIO-compatible object storage interface. We establish the connection using credentials stored in environment variables:</p>
<div id="c6336558" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> botocore.client <span class="im">import</span> Config</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> ConnectMinio:</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Connection handler for DataCore's MinIO-based data storage.</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Credentials should be set as environment variables:</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - MINIO_ENDPOINT: The API endpoint URL</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - MINIO_ACCESS_KEY: Your access key</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - MINIO_SECRET_KEY: Your secret key</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    - MINIO_BUCKET: The bucket containing financial data</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ENDPOINT <span class="op">=</span> os.environ.get(<span class="st">"MINIO_ENDPOINT"</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ACCESS_KEY <span class="op">=</span> os.environ.get(<span class="st">"MINIO_ACCESS_KEY"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_SECRET_KEY <span class="op">=</span> os.environ.get(<span class="st">"MINIO_SECRET_KEY"</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.REGION <span class="op">=</span> os.environ.get(<span class="st">"MINIO_REGION"</span>, <span class="st">"us-east-1"</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>([<span class="va">self</span>.MINIO_ENDPOINT, <span class="va">self</span>.MINIO_ACCESS_KEY, <span class="va">self</span>.MINIO_SECRET_KEY]):</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Missing required environment variables. "</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Please set MINIO_ENDPOINT, MINIO_ACCESS_KEY, and MINIO_SECRET_KEY."</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.s3 <span class="op">=</span> boto3.client(</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"s3"</span>,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            endpoint_url<span class="op">=</span><span class="va">self</span>.MINIO_ENDPOINT,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>            aws_access_key_id<span class="op">=</span><span class="va">self</span>.MINIO_ACCESS_KEY,</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>            aws_secret_access_key<span class="op">=</span><span class="va">self</span>.MINIO_SECRET_KEY,</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>            region_name<span class="op">=</span><span class="va">self</span>.REGION,</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>Config(signature_version<span class="op">=</span><span class="st">"s3v4"</span>),</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test_connection(<span class="va">self</span>):</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Verify connection by listing available buckets."""</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        resp <span class="op">=</span> <span class="va">self</span>.s3.list_buckets()</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Connected successfully. Available buckets:"</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bucket <span class="kw">in</span> resp.get(<span class="st">"Buckets"</span>, []):</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>bucket[<span class="st">'Name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Establish connection</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    conn <span class="op">=</span> ConnectMinio()</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    s3 <span class="op">=</span> conn.s3</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    conn.test_connection()</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    bucket_name <span class="op">=</span> os.environ.get(<span class="st">"MINIO_BUCKET"</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Could not connect to DataCore: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Proceeding with existing local data if available."</span>)</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    s3 <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    bucket_name <span class="op">=</span> <span class="va">None</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Connected successfully. Available buckets:
  - dsteam-data
  - rawbctc</code></pre>
</div>
</div>
</section>
</section>
<section id="downloading-and-preparing-stock-price-data" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="downloading-and-preparing-stock-price-data"><span class="header-section-number">7.4</span> Downloading and Preparing Stock Price Data</h2>
<p>Stock price data forms the foundation of most empirical finance research. We need daily and monthly prices to compute returns, market capitalizations, and various portfolio characteristics.</p>
<section id="loading-historical-prices" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="loading-historical-prices"><span class="header-section-number">7.4.1</span> Loading Historical Prices</h3>
<p>DataCore provides historical price data including open, high, low, close prices, trading volume, and adjustment factors for corporate actions like stock splits and dividends:</p>
<div id="04e993ec" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> s3 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> bucket_name <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download price data from DataCore</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    prices_raw <span class="op">=</span> pd.read_csv(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        BytesIO(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>            s3.get_object(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                Bucket<span class="op">=</span>bucket_name,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                Key<span class="op">=</span><span class="st">"historycal_price/dataset_historical_price.csv"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>            )[<span class="st">"Body"</span>].read()</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        low_memory<span class="op">=</span><span class="va">False</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloaded </span><span class="sc">{</span><span class="bu">len</span>(prices_raw)<span class="sc">:,}</span><span class="ss"> price observations"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load from existing database if available</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>        prices_raw <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SELECT * FROM prices_daily_raw"</span>,</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>            con<span class="op">=</span>tidy_finance</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(prices_raw)<span class="sc">:,}</span><span class="ss"> price observations from local database"</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No price data available. Please check DataCore connection."</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        prices_raw <span class="op">=</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded 4,307,791 price observations</code></pre>
</div>
</div>
</section>
<section id="cleaning-and-standardizing-price-data" class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="cleaning-and-standardizing-price-data"><span class="header-section-number">7.4.2</span> Cleaning and Standardizing Price Data</h3>
<p>Raw price data requires several transformations before it’s ready for analysis:</p>
<div id="4ed1b2a4" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> prices_raw.copy()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert date column</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    prices[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(prices[<span class="st">"date"</span>])</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate adjusted close price</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The adjustment ratio accounts for splits, dividends, etc.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    prices[<span class="st">"adjusted_close"</span>] <span class="op">=</span> prices[<span class="st">"close_price"</span>] <span class="op">*</span> prices[<span class="st">"adj_ratio"</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize column names</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> prices.rename(columns<span class="op">=</span>{</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vol_total"</span>: <span class="st">"volume"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"open_price"</span>: <span class="st">"open"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"low_price"</span>: <span class="st">"low"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high_price"</span>: <span class="st">"high"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"close_price"</span>: <span class="st">"close"</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure proper sorting for return calculations</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    prices <span class="op">=</span> prices.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed prices for </span><span class="sc">{</span>prices[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss"> securities"</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processed prices for 1,837 securities
Date range: 2010-01-04 to 2025-05-12</code></pre>
</div>
</div>
</section>
<section id="computing-returns" class="level3" data-number="7.4.3">
<h3 data-number="7.4.3" class="anchored" data-anchor-id="computing-returns"><span class="header-section-number">7.4.3</span> Computing Returns</h3>
<p>Returns are the primary variable of interest in asset pricing. We compute simple returns from adjusted prices:</p>
<p><span class="math display">\[
r_{i,t} = \frac{P_{i,t} - P_{i,t-1}}{P_{i,t-1}} = \frac{P_{i,t}}{P_{i,t-1}} - 1
\]</span></p>
<p>where <span class="math inline">\(P_{i,t}\)</span> is the adjusted closing price of stock <span class="math inline">\(i\)</span> on day <span class="math inline">\(t\)</span>.</p>
<div id="5c0e7a2a" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    prices[<span class="st">"ret"</span>] <span class="op">=</span> (</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        prices.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        .pct_change()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle extreme values</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Returns below -100% are economically impossible</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    prices[<span class="st">"ret"</span>] <span class="op">=</span> prices[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check for data quality</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Return statistics:"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(prices[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Return statistics:
count    4.305128e+06
mean              inf
std               NaN
min     -9.900000e-01
25%     -4.200000e-03
50%      0.000000e+00
75%      3.200000e-03
max               inf
Name: ret, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="aggregating-to-monthly-frequency" class="level3" data-number="7.4.4">
<h3 data-number="7.4.4" class="anchored" data-anchor-id="aggregating-to-monthly-frequency"><span class="header-section-number">7.4.4</span> Aggregating to Monthly Frequency</h3>
<p>While daily data is useful for some applications, monthly data is standard for portfolio analysis and asset pricing tests. We aggregate by taking the last observation of each month:</p>
<div id="595272ee" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample to monthly frequency</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> (</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        prices</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        .resample(<span class="st">"ME"</span>, on<span class="op">=</span><span class="st">"date"</span>)  <span class="co"># Month-End frequency</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        .last()</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        .drop(columns<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute monthly returns</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"ret"</span>] <span class="op">=</span> (</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        prices_monthly.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        .pct_change()</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"ret"</span>] <span class="op">=</span> prices_monthly[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Monthly observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Monthly observations: 210,331</code></pre>
</div>
</div>
</section>
<section id="computing-market-capitalization" class="level3" data-number="7.4.5">
<h3 data-number="7.4.5" class="anchored" data-anchor-id="computing-market-capitalization"><span class="header-section-number">7.4.5</span> Computing Market Capitalization</h3>
<p>Market capitalization—the total market value of a company’s outstanding shares—is essential for constructing value-weighted portfolios and size-based sorts:</p>
<p><span class="math display">\[
\text{Market Cap}_{i,t} = \text{Price}_{i,t} \times \text{Shares Outstanding}_{i,t}
\]</span></p>
<p>Shares outstanding must be obtained from fundamental data, which we’ll merge shortly.</p>
</section>
</section>
<section id="downloading-and-preparing-company-fundamentals" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="downloading-and-preparing-company-fundamentals"><span class="header-section-number">7.5</span> Downloading and Preparing Company Fundamentals</h2>
<p>Company fundamentals—accounting data from financial statements—provide the book values, earnings, and other metrics used in factor models and valuation.</p>
<section id="loading-fundamental-data" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="loading-fundamental-data"><span class="header-section-number">7.5.1</span> Loading Fundamental Data</h3>
<p>DataCore provides annual fundamental data split across multiple files. We load and concatenate them:</p>
<div id="7e07e038" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> s3 <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> bucket_name <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define paths to fundamental data files</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    fundamental_paths <span class="op">=</span> [</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fundamental_annual_1767674486317/fundamental_annual_1.xlsx"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fundamental_annual_1767674486317/fundamental_annual_2.xlsx"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fundamental_annual_1767674486317/fundamental_annual_3.xlsx"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load and concatenate</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    fundamental_dfs <span class="op">=</span> []</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> path <span class="kw">in</span> fundamental_paths:</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>            obj <span class="op">=</span> s3.get_object(Bucket<span class="op">=</span>bucket_name, Key<span class="op">=</span>path)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>            df_tmp <span class="op">=</span> pd.read_excel(BytesIO(obj[<span class="st">"Body"</span>].read()))</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>            fundamental_dfs.append(df_tmp)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"Could not load </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fundamental_dfs:</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        fundamentals_raw <span class="op">=</span> pd.concat(fundamental_dfs, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(fundamentals_raw)<span class="sc">:,}</span><span class="ss"> fundamental observations"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        fundamentals_raw <span class="op">=</span> pd.DataFrame()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        fundamentals_raw <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"SELECT * FROM comp_vn_raw"</span>,</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>            con<span class="op">=</span>tidy_finance</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(fundamentals_raw)<span class="sc">:,}</span><span class="ss"> fundamental observations from local database"</span>)</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No fundamental data available."</span>)</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        fundamentals_raw <span class="op">=</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 22,821 fundamental observations</code></pre>
</div>
</div>
</section>
<section id="cleaning-fundamental-data" class="level3" data-number="7.5.2">
<h3 data-number="7.5.2" class="anchored" data-anchor-id="cleaning-fundamental-data"><span class="header-section-number">7.5.2</span> Cleaning Fundamental Data</h3>
<p>Fundamental data requires careful cleaning to handle duplicates, missing values, and inconsistent formats:</p>
<div id="384410e2" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> fundamentals_raw.copy()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize identifiers</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"symbol"</span>] <span class="op">=</span> comp_vn[<span class="st">"symbol"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.upper().<span class="bu">str</span>.strip()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(comp_vn[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>).astype(<span class="st">"Int64"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop rows missing key identifiers</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> comp_vn.dropna(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert numeric columns</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    numeric_columns <span class="op">=</span> [</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_asset"</span>, <span class="st">"total_equity"</span>, <span class="st">"total_liabilities"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_current_liabilities"</span>, <span class="st">"total_current_asset"</span>,</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_net_revenue"</span>, <span class="st">"is_cogs"</span>, <span class="st">"is_manage_expense"</span>,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_interest_expense"</span>, <span class="st">"is_gross_profit"</span>, <span class="st">"is_eat"</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ca_cce"</span>, <span class="st">"ca_total_inventory"</span>, <span class="st">"ca_acc_receiv"</span>,</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cfo_depreciation"</span>, <span class="st">"capex"</span>, <span class="st">"total_cfo"</span>,</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_ebt"</span>, <span class="st">"is_cit_expense"</span>, <span class="st">"is_net_business_profit"</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cfo_receive"</span>, <span class="st">"cfo_inventory"</span>, <span class="st">"cfo_payale"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"na_tax_deferred"</span>, <span class="st">"nl_tax_deferred"</span>, <span class="st">"e_preferred_stock"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cl_loan"</span>, <span class="st">"cl_finlease"</span>, <span class="st">"cl_due_long_debt"</span>,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"nl_loan"</span>, <span class="st">"nl_finlease"</span>,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_cos_of_sales"</span>, <span class="st">"basic_eps"</span>, <span class="st">"is_shareholders_eat"</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> numeric_columns:</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> comp_vn.columns:</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            comp_vn[col] <span class="op">=</span> pd.to_numeric(comp_vn[col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle duplicates: keep row with most non-missing values</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"_completeness"</span>] <span class="op">=</span> comp_vn.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> (</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        comp_vn</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"_completeness"</span>])</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        .drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        .drop(columns<span class="op">=</span>[<span class="st">"_completeness"</span>])</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Cleaned fundamentals: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Year range: </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cleaned fundamentals: 21,232 observations
Unique firms: 1,554
Year range: 1998 to 2023</code></pre>
</div>
</div>
</section>
<section id="creating-standardized-variables" class="level3" data-number="7.5.3">
<h3 data-number="7.5.3" class="anchored" data-anchor-id="creating-standardized-variables"><span class="header-section-number">7.5.3</span> Creating Standardized Variables</h3>
<p>We create standardized variable names following conventions from the academic literature, particularly the Compustat naming conventions used in US research:</p>
<div id="47fa3d60" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fiscal year-end date</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"datadate"</span>] <span class="op">=</span> pd.to_datetime(comp_vn[<span class="st">"year"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-12-31"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Balance sheet items</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"at"</span>] <span class="op">=</span> comp_vn[<span class="st">"total_asset"</span>]  <span class="co"># Total assets</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"act"</span>] <span class="op">=</span> comp_vn[<span class="st">"total_current_asset"</span>]  <span class="co"># Current assets</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"lt"</span>] <span class="op">=</span> comp_vn[<span class="st">"total_liabilities"</span>]  <span class="co"># Total liabilities</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"lct"</span>] <span class="op">=</span> comp_vn[<span class="st">"total_current_liabilities"</span>]  <span class="co"># Current liabilities</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"seq"</span>] <span class="op">=</span> comp_vn[<span class="st">"total_equity"</span>]  <span class="co"># Stockholders' equity</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Income statement items</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"sale"</span>] <span class="op">=</span> comp_vn[<span class="st">"is_net_revenue"</span>]  <span class="co"># Revenue</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"cogs"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"is_cogs"</span>, <span class="dv">0</span>)  <span class="co"># Cost of goods sold</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"xsga"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"is_manage_expense"</span>, <span class="dv">0</span>)  <span class="co"># SG&amp;A expenses</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"xint"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"is_interest_expense"</span>, <span class="dv">0</span>)  <span class="co"># Interest expense</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cash flow items</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"oancf"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"total_cfo"</span>, np.nan)  <span class="co"># Operating cash flow</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"capx"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"capex"</span>, np.nan)  <span class="co"># Capital expenditures</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Deferred taxes (for book equity calculation)</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"txditc"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"na_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"txdb"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"nl_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Preferred stock</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"pstk"</span>] <span class="op">=</span> comp_vn.get(<span class="st">"e_preferred_stock"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-book-equity" class="level3" data-number="7.5.4">
<h3 data-number="7.5.4" class="anchored" data-anchor-id="computing-book-equity"><span class="header-section-number">7.5.4</span> Computing Book Equity</h3>
<p>Book equity is a critical variable for the value factor (HML) in the Fama-French model. We follow the standard definition from <span class="citation" data-cites="Fama1992">Fama and French (<a href="references.html#ref-Fama1992" role="doc-biblioref">1992</a>)</span>:</p>
<p><span class="math display">\[
\text{Book Equity} = \text{Stockholders' Equity} + \text{Deferred Taxes} - \text{Preferred Stock}
\]</span></p>
<div id="2161c1dc" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute book equity</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"be"</span>] <span class="op">=</span> (</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>        comp_vn[<span class="st">"seq"</span>]</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn[<span class="st">"txditc"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> comp_vn[<span class="st">"pstk"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set negative or zero book equity to missing</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is standard practice—negative BE makes ratios meaningless</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"be"</span>] <span class="op">=</span> comp_vn[<span class="st">"be"</span>].<span class="bu">apply</span>(</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: np.nan <span class="cf">if</span> pd.isna(x) <span class="kw">or</span> x <span class="op">&lt;=</span> <span class="dv">0</span> <span class="cf">else</span> x</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Observations with valid book equity: </span><span class="sc">{</span>comp_vn[<span class="st">'be'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observations with valid book equity: 20,235</code></pre>
</div>
</div>
</section>
<section id="computing-profitability-and-investment" class="level3" data-number="7.5.5">
<h3 data-number="7.5.5" class="anchored" data-anchor-id="computing-profitability-and-investment"><span class="header-section-number">7.5.5</span> Computing Profitability and Investment</h3>
<p>The Fama-French five-factor model requires measures of profitability and investment:</p>
<div id="af82a92a" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Operating profitability (Fama-French definition)</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OP = (Revenue - COGS - SG&amp;A - Interest) / Book Equity</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"op"</span>] <span class="op">=</span> (</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        (comp_vn[<span class="st">"sale"</span>] </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> comp_vn[<span class="st">"cogs"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> comp_vn[<span class="st">"xsga"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span> comp_vn[<span class="st">"xint"</span>].fillna(<span class="dv">0</span>))</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">/</span> comp_vn[<span class="st">"be"</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Investment (asset growth)</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First, create lagged assets</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    comp_vn_lag <span class="op">=</span> (</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"at"</span>]]</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"year"</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"at"</span>: <span class="st">"at_lag"</span>})</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> comp_vn.merge(comp_vn_lag, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Investment = (Assets_t / Assets_{t-1}) - 1</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"inv"</span>] <span class="op">=</span> comp_vn[<span class="st">"at"</span>] <span class="op">/</span> comp_vn[<span class="st">"at_lag"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    comp_vn.loc[comp_vn[<span class="st">"at_lag"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">"inv"</span>] <span class="op">=</span> np.nan</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-total-debt" class="level3" data-number="7.5.6">
<h3 data-number="7.5.6" class="anchored" data-anchor-id="computing-total-debt"><span class="header-section-number">7.5.6</span> Computing Total Debt</h3>
<p>For leverage analysis, we need total interest-bearing debt. In Vietnamese financial reports, total liabilities include non-interest-bearing items like accounts payable. We compute true debt by aggregating loan and lease obligations:</p>
<div id="207f06c3" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    debt_columns <span class="op">=</span> [<span class="st">"cl_loan"</span>, <span class="st">"cl_finlease"</span>, <span class="st">"cl_due_long_debt"</span>, <span class="st">"nl_loan"</span>, <span class="st">"nl_finlease"</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> debt_columns:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> comp_vn.columns:</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>            comp_vn[col] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"total_debt"</span>] <span class="op">=</span> (</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        comp_vn[<span class="st">"cl_loan"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn[<span class="st">"cl_finlease"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn[<span class="st">"cl_due_long_debt"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn[<span class="st">"nl_loan"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn[<span class="st">"nl_finlease"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also compute SG&amp;A for financial statement analysis</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"selling_general_and_administrative_expenses"</span>] <span class="op">=</span> (</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        comp_vn.get(<span class="st">"is_cos_of_sales"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> comp_vn.get(<span class="st">"is_manage_expense"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="filtering-to-valid-observations" class="level3" data-number="7.5.7">
<h3 data-number="7.5.7" class="anchored" data-anchor-id="filtering-to-valid-observations"><span class="header-section-number">7.5.7</span> Filtering to Valid Observations</h3>
<p>We keep only firm-years with the minimum required data for meaningful analysis:</p>
<div id="14bb74d1" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    required_columns <span class="op">=</span> [<span class="st">"at"</span>, <span class="st">"lt"</span>, <span class="st">"seq"</span>, <span class="st">"sale"</span>]</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> comp_vn.dropna(subset<span class="op">=</span>required_columns)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> comp_vn[comp_vn[<span class="st">"at"</span>] <span class="op">&gt;</span> <span class="dv">0</span>]  <span class="co"># Assets must be positive</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> comp_vn[comp_vn[<span class="st">"sale"</span>] <span class="op">&gt;=</span> <span class="dv">0</span>]  <span class="co"># Sales cannot be negative</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep only the last observation per firm-year</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>    comp_vn <span class="op">=</span> (</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        comp_vn</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        .sort_values(<span class="st">"datadate"</span>)</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        .tail(<span class="dv">1</span>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Final fundamental observations: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final fundamental observations: 20,091
Unique firms: 1,502</code></pre>
</div>
</div>
</section>
</section>
<section id="merging-stock-prices-with-fundamentals" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="merging-stock-prices-with-fundamentals"><span class="header-section-number">7.6</span> Merging Stock Prices with Fundamentals</h2>
<p>To compute market-based ratios like book-to-market, we need to merge stock price data with company fundamentals. The key challenge is timing: accounting data is released with a lag, so we must be careful not to introduce look-ahead bias.</p>
<section id="computing-market-capitalization-1" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="computing-market-capitalization-1"><span class="header-section-number">7.6.1</span> Computing Market Capitalization</h3>
<p>First, we need shares outstanding to compute market cap. We estimate this from earnings per share and net income:</p>
<div id="30abcaaa" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty <span class="kw">and</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Estimate shares outstanding from fundamentals</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shares = Net Income / EPS</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    comp_vn[<span class="st">"shrout"</span>] <span class="op">=</span> (</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        comp_vn[<span class="st">"is_shareholders_eat"</span>] <span class="op">/</span> comp_vn[<span class="st">"basic_eps"</span>]</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add year to prices for merging</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"year"</span>] <span class="op">=</span> prices_monthly[<span class="st">"date"</span>].dt.year</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge shares outstanding onto monthly prices</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"shrout"</span>]],</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>],</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute market capitalization</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market Cap = Price × Shares Outstanding</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"mktcap"</span>] <span class="op">=</span> prices_monthly[<span class="st">"close"</span>] <span class="op">*</span> prices_monthly[<span class="st">"shrout"</span>]</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to millions and handle zeros</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"mktcap"</span>] <span class="op">=</span> (</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>        prices_monthly[<span class="st">"mktcap"</span>] <span class="op">/</span> <span class="fl">1e6</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    ).replace(<span class="dv">0</span>, np.nan)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-lagged-market-capitalization" class="level3" data-number="7.6.2">
<h3 data-number="7.6.2" class="anchored" data-anchor-id="computing-lagged-market-capitalization"><span class="header-section-number">7.6.2</span> Computing Lagged Market Capitalization</h3>
<p>For value-weighted portfolio returns, we need market cap at the beginning of the return period (i.e., lagged market cap):</p>
<div id="8539f03e" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty <span class="kw">and</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> (</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>        prices_monthly</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"symbol"</span>)[<span class="st">"mktcap"</span>]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>        .shift(<span class="dv">1</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-excess-returns" class="level3" data-number="7.6.3">
<h3 data-number="7.6.3" class="anchored" data-anchor-id="computing-excess-returns"><span class="header-section-number">7.6.3</span> Computing Excess Returns</h3>
<p>Excess returns—returns above the risk-free rate—are the dependent variable in asset pricing tests. We use the Vietnam government bond yield as our risk-free rate proxy:</p>
<div id="692d8cc6" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vietnam 10-year government bond yield (approximately 4% annualized)</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This is a reasonable proxy when Fama-French Vietnam data isn't available</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    annual_rf <span class="op">=</span> <span class="fl">0.04</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    monthly_rf <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create risk-free rate series</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    rf_monthly <span class="op">=</span> pd.DataFrame({</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: pd.date_range(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            start<span class="op">=</span>prices_monthly[<span class="st">"date"</span>].<span class="bu">min</span>(),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>            end<span class="op">=</span>prices_monthly[<span class="st">"date"</span>].<span class="bu">max</span>(),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>            freq<span class="op">=</span><span class="st">"ME"</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"risk_free"</span>: monthly_rf</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge and compute excess returns</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> prices_monthly.merge(rf_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> prices_monthly[<span class="st">"ret"</span>] <span class="op">-</span> prices_monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bound excess returns at -100%</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> prices_monthly[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="final-cleaning" class="level3" data-number="7.6.4">
<h3 data-number="7.6.4" class="anchored" data-anchor-id="final-cleaning"><span class="header-section-number">7.6.4</span> Final Cleaning</h3>
<p>Remove observations with missing critical values:</p>
<div id="2ee1864c" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows with missing returns or market cap</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> prices_monthly.dropna(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove infinite values</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> prices_monthly.replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    prices_monthly <span class="op">=</span> prices_monthly.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>])</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Final monthly price observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final monthly price observations: 160,482</code></pre>
</div>
</div>
</section>
</section>
<section id="constructing-factor-data" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="constructing-factor-data"><span class="header-section-number">7.7</span> Constructing Factor Data</h2>
<p>For asset pricing tests, we need factor returns. While Fama-French provide factors for the US market, we must construct our own for Vietnam. This section creates a placeholder structure; the full factor construction is covered in a later chapter.</p>
<section id="market-factor" class="level3" data-number="7.7.1">
<h3 data-number="7.7.1" class="anchored" data-anchor-id="market-factor"><span class="header-section-number">7.7.1</span> Market Factor</h3>
<p>The market factor is the value-weighted return on all stocks minus the risk-free rate:</p>
<div id="4d6a8557" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute value-weighted market return</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    factors_monthly <span class="op">=</span> (</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>        prices_monthly</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                <span class="st">"mkt_excess"</span>: np.average(</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                    x[<span class="st">"ret_excess"</span>],</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                    weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>                ) <span class="cf">if</span> x[<span class="st">"mktcap_lag"</span>].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>            }),</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>            include_groups<span class="op">=</span><span class="va">False</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add risk-free rate for reference</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    factors_monthly <span class="op">=</span> factors_monthly.merge(</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        rf_monthly,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Market factor statistics:"</span>)</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(factors_monthly[<span class="st">"mkt_excess"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Market factor statistics:
count    167.0000
mean      -0.0130
std        0.0585
min       -0.2133
25%       -0.0406
50%       -0.0117
75%        0.0193
max        0.1682
Name: mkt_excess, dtype: float64</code></pre>
</div>
</div>
</section>
</section>
<section id="storing-data-in-the-database" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="storing-data-in-the-database"><span class="header-section-number">7.8</span> Storing Data in the Database</h2>
<p>With all data prepared, we store it in our SQLite database for use in subsequent chapters.</p>
<section id="storing-company-fundamentals" class="level3" data-number="7.8.1">
<h3 data-number="7.8.1" class="anchored" data-anchor-id="storing-company-fundamentals"><span class="header-section-number">7.8.1</span> Storing Company Fundamentals</h3>
<div id="92002be6" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty:</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    comp_vn.to_sql(</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"comp_vn"</span>,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stored </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> fundamental observations in 'comp_vn' table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stored 20,091 fundamental observations in 'comp_vn' table</code></pre>
</div>
</div>
</section>
<section id="storing-monthly-prices" class="level3" data-number="7.8.2">
<h3 data-number="7.8.2" class="anchored" data-anchor-id="storing-monthly-prices"><span class="header-section-number">7.8.2</span> Storing Monthly Prices</h3>
<div id="d62b75d6" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly.to_sql(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"prices_monthly"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>        if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stored </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> price observations in 'prices_monthly' table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stored 160,482 price observations in 'prices_monthly' table</code></pre>
</div>
</div>
</section>
<section id="storing-factor-data" class="level3" data-number="7.8.3">
<h3 data-number="7.8.3" class="anchored" data-anchor-id="storing-factor-data"><span class="header-section-number">7.8.3</span> Storing Factor Data</h3>
<div id="17264206" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    factors_monthly.to_sql(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"factors_ff5_monthly"</span>,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Stored </span><span class="sc">{</span><span class="bu">len</span>(factors_monthly)<span class="sc">:,}</span><span class="ss"> factor observations in 'factors_ff5_monthly' table"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stored 167 factor observations in 'factors_ff5_monthly' table</code></pre>
</div>
</div>
</section>
</section>
<section id="accessing-data-from-the-database" class="level2" data-number="7.9">
<h2 data-number="7.9" class="anchored" data-anchor-id="accessing-data-from-the-database"><span class="header-section-number">7.9</span> Accessing Data from the Database</h2>
<p>In subsequent chapters, retrieving data is straightforward:</p>
<div id="fca8a21a" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Load monthly prices</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>prices_from_db <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM prices_monthly"</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieved </span><span class="sc">{</span><span class="bu">len</span>(prices_from_db)<span class="sc">:,}</span><span class="ss"> observations from database"</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>prices_from_db.head(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieved 160,482 observations from database</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">#</th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">adj_ratio</th>
<th data-quarto-table-cell-role="th">average_price</th>
<th data-quarto-table-cell-role="th">basic_price</th>
<th data-quarto-table-cell-role="th">buy_count</th>
<th data-quarto-table-cell-role="th">buy_vol_foreign</th>
<th data-quarto-table-cell-role="th">buy_val_foreigh</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">vol_putth</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">adjusted_close</th>
<th data-quarto-table-cell-role="th">ret</th>
<th data-quarto-table-cell-role="th">shrout</th>
<th data-quarto-table-cell-role="th">mktcap</th>
<th data-quarto-table-cell-role="th">mktcap_lag</th>
<th data-quarto-table-cell-role="th">risk_free</th>
<th data-quarto-table-cell-role="th">ret_excess</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>A32</td>
<td>2018-11-30</td>
<td>2186706.0</td>
<td>2186706.0</td>
<td>1.72102</td>
<td>32.0</td>
<td>32.0</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>2018</td>
<td>55.072640</td>
<td>0.235521</td>
<td>6.800000e+06</td>
<td>217.60</td>
<td>176.12</td>
<td>0.003333</td>
<td>0.232188</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>A32</td>
<td>2018-12-31</td>
<td>2186726.0</td>
<td>2186726.0</td>
<td>1.72102</td>
<td>30.2</td>
<td>30.2</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>2018</td>
<td>51.974804</td>
<td>-0.056250</td>
<td>6.800000e+06</td>
<td>205.36</td>
<td>217.60</td>
<td>0.003333</td>
<td>-0.059583</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>A32</td>
<td>2019-01-31</td>
<td>2186748.0</td>
<td>2186748.0</td>
<td>1.64034</td>
<td>30.5</td>
<td>30.5</td>
<td>0.0</td>
<td>0.0</td>
<td>0.0</td>
<td>...</td>
<td>0.0</td>
<td>0.0</td>
<td>2019</td>
<td>50.030370</td>
<td>-0.037411</td>
<td>6.800000e+06</td>
<td>207.40</td>
<td>205.36</td>
<td>0.003333</td>
<td>-0.040744</td>
</tr>
</tbody>
</table>

<p>3 rows × 37 columns</p>
</div>
</div>
</div>
<div id="c266d188" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Load specific columns with a filter</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>recent_data <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="st">    SELECT symbol, date, ret_excess, mktcap </span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="st">    FROM prices_monthly </span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="st">    WHERE date &gt;= '2020-01-01'</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Retrieved </span><span class="sc">{</span><span class="bu">len</span>(recent_data)<span class="sc">:,}</span><span class="ss"> observations from 2020 onward"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieved 63,904 observations from 2020 onward</code></pre>
</div>
</div>
</section>
<section id="descriptive-statistics" class="level2" data-number="7.10">
<h2 data-number="7.10" class="anchored" data-anchor-id="descriptive-statistics"><span class="header-section-number">7.10</span> Descriptive Statistics</h2>
<p>Before concluding, let’s examine some key characteristics of our data.</p>
<section id="sample-coverage-over-time" class="level3" data-number="7.10.1">
<h3 data-number="7.10.1" class="anchored" data-anchor-id="sample-coverage-over-time"><span class="header-section-number">7.10.1</span> Sample Coverage Over Time</h3>
<p><a href="#fig-100" class="quarto-xref">Figure&nbsp;<span>7.1</span></a> shows the number of securities in our sample over time:</p>
<div id="cell-fig-100" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    securities_per_month <span class="op">=</span> (</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>        prices_monthly</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        .agg(n_securities<span class="op">=</span>(<span class="st">"symbol"</span>, <span class="st">"nunique"</span>))</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    coverage_figure <span class="op">=</span> (</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        ggplot(securities_per_month, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"n_securities"</span>))</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"steelblue"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> labs(</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Number of Securities"</span>,</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Monthly Number of Securities in Vietnam Stock Sample"</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> theme_minimal()</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    coverage_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-100" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Title: Monthly number of securities over time. The figure shows a line chart with the count of securities by month.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-100-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="test_files/figure-html/fig-100-output-1.png" alt="Title: Monthly number of securities over time. The figure shows a line chart with the count of securities by month." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-100-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: The figure shows the monthly number of securities with valid return and market capitalization data in the Vietnamese stock market.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="market-capitalization-distribution" class="level3" data-number="7.10.2">
<h3 data-number="7.10.2" class="anchored" data-anchor-id="market-capitalization-distribution"><span class="header-section-number">7.10.2</span> Market Capitalization Distribution</h3>
<p><a href="#fig-101" class="quarto-xref">Figure&nbsp;<span>7.2</span></a> shows the evolution of total market capitalization:</p>
<div id="cell-fig-101" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    total_mktcap <span class="op">=</span> (</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        prices_monthly</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        .agg(total_mktcap<span class="op">=</span>(<span class="st">"mktcap"</span>, <span class="st">"sum"</span>))</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    mktcap_figure <span class="op">=</span> (</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        ggplot(total_mktcap, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"total_mktcap/1000"</span>))</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> labs(</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Total Market Cap (Billion VND)"</span>,</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Total Market Capitalization of Vietnamese Stocks"</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> theme_minimal()</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    mktcap_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-101" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Title: Total market capitalization over time. The figure shows a line chart of aggregate market cap.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-101-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="test_files/figure-html/fig-101-output-1.png" alt="Title: Total market capitalization over time. The figure shows a line chart of aggregate market cap." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-101-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: The figure shows the total market capitalization of Vietnamese stocks over time.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="book-equity-coverage" class="level3" data-number="7.10.3">
<h3 data-number="7.10.3" class="anchored" data-anchor-id="book-equity-coverage"><span class="header-section-number">7.10.3</span> Book Equity Coverage</h3>
<p><a href="#fig-102" class="quarto-xref">Figure&nbsp;<span>7.3</span></a> shows the share of securities with valid book equity values over time:</p>
<div id="cell-fig-102" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> fundamentals_raw.empty <span class="kw">and</span> <span class="kw">not</span> prices_raw.empty:</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge to check book equity coverage</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    share_with_be <span class="op">=</span> (</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        prices_monthly</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.year)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        .sort_values(<span class="st">"date"</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>        .tail(<span class="dv">1</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>        .merge(comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"be"</span>]], on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"year"</span>)</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">"share_with_be"</span>: x[<span class="st">"be"</span>].notna().<span class="bu">sum</span>() <span class="op">/</span> <span class="bu">len</span>(x)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            }),</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            include_groups<span class="op">=</span><span class="va">False</span></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>    be_coverage_figure <span class="op">=</span> (</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        ggplot(share_with_be, aes(x<span class="op">=</span><span class="st">"year"</span>, y<span class="op">=</span><span class="st">"share_with_be"</span>))</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> geom_point(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> labs(</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"Year"</span>, y<span class="op">=</span><span class="st">"Share with Book Equity"</span>,</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Share of Securities with Book Equity Values"</span></span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format(), limits<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> theme_minimal()</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>    be_coverage_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-102" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Title: Share of securities with book equity. The figure shows a line chart of the percentage of securities with valid book equity data.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-102-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="test_files/figure-html/fig-102-output-1.png" alt="Title: Share of securities with book equity. The figure shows a line chart of the percentage of securities with valid book equity data." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-102-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: The figure shows the share of securities with book equity values from financial statements.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="database-maintenance" class="level2" data-number="7.11">
<h2 data-number="7.11" class="anchored" data-anchor-id="database-maintenance"><span class="header-section-number">7.11</span> Database Maintenance</h2>
<p>Over time, database files can become bloated as deleted data leaves empty space. The <code>VACUUM</code> command rebuilds the database to reclaim this space:</p>
<div id="aa8a82de" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Optimize database file size</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>tidy_finance.execute(<span class="st">"VACUUM"</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Database optimized"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Database optimized</code></pre>
</div>
</div>
</section>
<section id="key-takeaways" class="level2" data-number="7.12">
<h2 data-number="7.12" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">7.12</span> Key Takeaways</h2>
<p>This chapter established the data infrastructure that supports all subsequent analyses in this book. The main insights are:</p>
<ol type="1">
<li><p><strong>Centralized storage beats scattered files</strong>: An SQLite database provides consistent data types, efficient queries, and a single source of truth across all projects.</p></li>
<li><p><strong>DataCore provides comprehensive Vietnamese market data</strong>: Stock prices, returns, and company fundamentals are available for firms listed on HOSE and HNX through DataCore’s API.</p></li>
<li><p><strong>Data cleaning requires careful attention</strong>: Handling duplicates, missing values, date formats, and extreme values is essential before any analysis.</p></li>
<li><p><strong>Standardized variable names facilitate replication</strong>: Following academic conventions (like Compustat naming) makes code more readable and research more comparable.</p></li>
<li><p><strong>Book equity requires proper construction</strong>: The Fama-French definition combines stockholders’ equity, deferred taxes, and preferred stock with careful handling of negative values.</p></li>
<li><p><strong>Market cap links prices to fundamentals</strong>: Shares outstanding from fundamentals combined with market prices yields market capitalization for portfolio weighting.</p></li>
<li><p><strong>Excess returns are the standard dependent variable</strong>: Subtracting the risk-free rate from raw returns yields the quantity that asset pricing models aim to explain.</p></li>
</ol>
<p>With our database populated, subsequent chapters can focus on analysis rather than data wrangling. Each chapter will begin by loading the relevant tables and proceed directly to portfolio construction, factor analysis, or valuation.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Fama1992" class="csl-entry" role="listitem">
Fama, Eugene F., and Kenneth R. French. 1992. <span>“<span class="nocase">The cross-section of expected stock returns</span>.”</span> <em><span>The Journal of Finance</span></em> 47 (2): 427–65. <a href="https://doi.org/2329112">https://doi.org/2329112</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./05_discounted_cash_flow.html" class="pagination-link" aria-label="Discounted Cash Flow Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08_beta_estimation.html" class="pagination-link" aria-label="Beta Estimation">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>