% Options for packages loaded elsewhere
% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrreprt}
\usepackage{xcolor}
\usepackage{amsmath,amssymb}
\setcounter{secnumdepth}{5}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math} % this also loads fontspec
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else
  % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
% Make \paragraph and \subparagraph free-standing
\makeatletter
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}{
    \@ifstar
      \xxxParagraphStar
      \xxxParagraphNoStar
  }
  \newcommand{\xxxParagraphStar}[1]{\oldparagraph*{#1}\mbox{}}
  \newcommand{\xxxParagraphNoStar}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}{
    \@ifstar
      \xxxSubParagraphStar
      \xxxSubParagraphNoStar
  }
  \newcommand{\xxxSubParagraphStar}[1]{\oldsubparagraph*{#1}\mbox{}}
  \newcommand{\xxxSubParagraphNoStar}[1]{\oldsubparagraph{#1}\mbox{}}
\fi
\makeatother

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\usepackage{longtable,booktabs,array}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\newsavebox\pandoc@box
\newcommand*\pandocbounded[1]{% scales image to fit in text height/width
  \sbox\pandoc@box{#1}%
  \Gscale@div\@tempa{\textheight}{\dimexpr\ht\pandoc@box+\dp\pandoc@box\relax}%
  \Gscale@div\@tempb{\linewidth}{\wd\pandoc@box}%
  \ifdim\@tempb\p@<\@tempa\p@\let\@tempa\@tempb\fi% select the smaller of both
  \ifdim\@tempa\p@<\p@\scalebox{\@tempa}{\usebox\pandoc@box}%
  \else\usebox{\pandoc@box}%
  \fi%
}
% Set default figure placement to htbp
\def\fps@figure{htbp}
\makeatother


% definitions for citeproc citations
\NewDocumentCommand\citeproctext{}{}
\NewDocumentCommand\citeproc{mm}{%
  \begingroup\def\citeproctext{#2}\cite{#1}\endgroup}
\makeatletter
 % allow citations to break across lines
 \let\@cite@ofmt\@firstofone
 % avoid brackets around text for \cite:
 \def\@biblabel#1{}
 \def\@cite#1#2{{#1\if@tempswa , #2\fi}}
\makeatother
\newlength{\cslhangindent}
\setlength{\cslhangindent}{1.5em}
\newlength{\csllabelwidth}
\setlength{\csllabelwidth}{3em}
\newenvironment{CSLReferences}[2] % #1 hanging-indent, #2 entry-spacing
 {\begin{list}{}{%
  \setlength{\itemindent}{0pt}
  \setlength{\leftmargin}{0pt}
  \setlength{\parsep}{0pt}
  % turn on hanging indent if param 1 is 1
  \ifodd #1
   \setlength{\leftmargin}{\cslhangindent}
   \setlength{\itemindent}{-1\cslhangindent}
  \fi
  % set entry spacing
  \setlength{\itemsep}{#2\baselineskip}}}
 {\end{list}}
\usepackage{calc}
\newcommand{\CSLBlock}[1]{\hfill\break\parbox[t]{\linewidth}{\strut\ignorespaces#1\strut}}
\newcommand{\CSLLeftMargin}[1]{\parbox[t]{\csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLRightInline}[1]{\parbox[t]{\linewidth - \csllabelwidth}{\strut#1\strut}}
\newcommand{\CSLIndent}[1]{\hspace{\cslhangindent}#1}



\setlength{\emergencystretch}{3em} % prevent overfull lines

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}



 


\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{tcolorbox}{}{\usepackage[skins,breakable]{tcolorbox}}
\@ifpackageloaded{fontawesome5}{}{\usepackage{fontawesome5}}
\definecolor{quarto-callout-color}{HTML}{909090}
\definecolor{quarto-callout-note-color}{HTML}{0758E5}
\definecolor{quarto-callout-important-color}{HTML}{CC1914}
\definecolor{quarto-callout-warning-color}{HTML}{EB9113}
\definecolor{quarto-callout-tip-color}{HTML}{00A047}
\definecolor{quarto-callout-caution-color}{HTML}{FC5300}
\definecolor{quarto-callout-color-frame}{HTML}{acacac}
\definecolor{quarto-callout-note-color-frame}{HTML}{4582ec}
\definecolor{quarto-callout-important-color-frame}{HTML}{d9534f}
\definecolor{quarto-callout-warning-color-frame}{HTML}{f0ad4e}
\definecolor{quarto-callout-tip-color-frame}{HTML}{02b875}
\definecolor{quarto-callout-caution-color-frame}{HTML}{fd7e14}
\makeatother
\makeatletter
\@ifpackageloaded{bookmark}{}{\usepackage{bookmark}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\usepackage{bookmark}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same}
\hypersetup{
  pdftitle={Applying Tidy Finance with Python to Vietnam},
  pdfauthor={Mike},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}


\title{Applying Tidy Finance with Python to Vietnam}
\author{Mike}
\date{2026-02-01}
\begin{document}
\maketitle

\renewcommand*\contentsname{Table of contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{2}
\tableofcontents
}

\bookmarksetup{startatroot}

\chapter*{Preface}\label{preface}
\addcontentsline{toc}{chapter}{Preface}

\markboth{Preface}{Preface}

\begin{tcolorbox}[enhanced jigsaw, opacitybacktitle=0.6, opacityback=0, colframe=quarto-callout-note-color-frame, leftrule=.75mm, colback=white, left=2mm, bottomtitle=1mm, colbacktitle=quarto-callout-note-color!10!white, breakable, rightrule=.15mm, toprule=.15mm, bottomrule=.15mm, toptitle=1mm, titlerule=0mm, title=\textcolor{quarto-callout-note-color}{\faInfo}\hspace{0.5em}{Attribution}, arc=.35mm, coltitle=black]

This book is an independent derivative work inspired by reproducible
research principles developed in
\href{https://www.tidy-finance.org/}{\textbf{Tidy Finance}}. It is not
affiliated with, or officially provided by the creators of the original
Tidy Finance books. All content, code, and empirical applications are
original and tailored to the Vietnamese market.

This work builds directly on the methodological foundation established
in:

\begin{itemize}
\tightlist
\item
  Scheuch, C., Voigt, S., \& Weiss, P. (2023). \emph{Tidy Finance with
  R}. Chapman and Hall/CRC. \url{https://www.tidy-finance.org/r/}
  (Scheuch, Voigt, and Weiss 2023)
\item
  Scheuch, C., Voigt, S., Weiss, P., \& Frey, C. (2024). \emph{Tidy
  Finance with Python}. Chapman and Hall/CRC.
  \url{https://www.tidy-finance.org/python/} (Scheuch et al. 2024)
\end{itemize}

We gratefully acknowledge the Tidy Finance authors for developing an
open, reproducible approach to empirical finance that made this
market-specific adaptation possible.

\end{tcolorbox}

\section*{Motivation}\label{motivation}
\addcontentsline{toc}{section}{Motivation}

\markright{Motivation}

Empirical finance has undergone a fundamental transformation over the
past two decades. Advances in computational capacity, open-source
statistical software, and data availability have reshaped how financial
research is conducted, evaluated, and disseminated. Increasingly,
credible empirical work is expected to be transparent, replicable, and
extensible, with results generated through scripted workflows rather
than manual intervention. Reproducibility, defined as the ability for
independent researchers to regenerate empirical results using the same
data and methods, has thus become a core norm in modern financial
economics.

Despite this progress, the adoption of reproducible research practices
has been uneven across markets. In developed financial systems,
particularly those with long-established databases and standardized
reporting regimes, reproducible empirical workflows are now commonplace.
In contrast, research on emerging and frontier markets frequently relies
on fragmented datasets, undocumented data cleaning procedures, and
implicit institutional assumptions that are difficult to verify or
extend. As a result, empirical findings in these markets are often
fragile, non-comparable across studies, and costly to update as new data
become available.

This book addresses that gap.

It develops a reproducible empirical finance framework designed
explicitly for emerging and frontier markets, using Vietnam as a primary
empirical case. Rather than adapting developed-market research pipelines
post hoc, the book begins from the institutional and data realities of a
fast-growing, retail-dominated, regulation-intensive market and builds
methodological solutions accordingly. The objective is not merely to
analyze Vietnam's financial markets, but to demonstrate how reproducible
finance principles, as developed in the Tidy Finance framework, can be
extended, stress-tested, and refined in environments characterized by
data scarcity, institutional heterogeneity, and rapid structural change.

\section*{Why Emerging Markets Require Different Empirical
Infrastructure}\label{why-emerging-markets-require-different-empirical-infrastructure}
\addcontentsline{toc}{section}{Why Emerging Markets Require Different
Empirical Infrastructure}

\markright{Why Emerging Markets Require Different Empirical
Infrastructure}

Much of modern empirical finance implicitly assumes the existence of
stable, high-frequency, institutionally harmonized datasets. These
assumptions are rarely stated, yet they are deeply embedded in standard
research designs: survivorship-free security histories, consistent
accounting standards, unrestricted trading mechanisms, and deep
institutional liquidity.

Emerging and frontier markets challenge each of these assumptions.

In Vietnam, as in many comparable economies, equity markets exhibit
binding daily price limits, episodic trading halts, concentrated state
ownership, and a predominance of retail investors. Financial disclosures
reflect local accounting standards and evolving regulatory frameworks.
Corporate actions are frequent, inconsistently documented, and
occasionally revised ex post.

These characteristics are not inconveniences to be eliminated through
aggressive data cleaning. They shape return dynamics, risk premia,
factor construction, and statistical inference itself. An empirical
framework that ignores these institutional features risks producing
results that are internally inconsistent or externally misleading. A
reproducible approach for emerging markets must therefore encode
institutional context directly into data schemas, transformation logic,
and modeling choices.

\section*{Reproducibility as a Research Design
Principle}\label{reproducibility-as-a-research-design-principle}
\addcontentsline{toc}{section}{Reproducibility as a Research Design
Principle}

\markright{Reproducibility as a Research Design Principle}

In this book, reproducibility extends beyond the narrow notion of code
availability. It is treated as an organizing principle governing the
entire empirical research lifecycle.

First, all datasets are constructed from raw inputs through documented,
deterministic transformations, ensuring clear data provenance. Second,
empirical methods are implemented in a manner that makes modeling
assumptions explicit and modifiable. Third, results are generated
through scripted pipelines rather than interactive analysis,
guaranteeing that updates to data or parameters propagate consistently
throughout the analysis. Finally, empirical designs are modular,
allowing researchers to substitute markets, sample periods, or variable
definitions without rewriting entire workflows.

This approach draws methodological inspiration from the broader
reproducible research movement in economics and finance (e.g., Gentzkow
and Shapiro 2014; Vilhuber 2020), while deliberately extending it beyond
its original institutional and data environment. The goal is not to
reproduce existing studies, but to enable new ones---particularly those
that would otherwise be impractical due to fragmented data and
institutional complexity.

\section*{Vietnam as a Case, Not an
Exception}\label{vietnam-as-a-case-not-an-exception}
\addcontentsline{toc}{section}{Vietnam as a Case, Not an Exception}

\markright{Vietnam as a Case, Not an Exception}

Vietnam serves as the central empirical case throughout the book, but it
is not treated as an idiosyncratic exception. Instead, it is presented
as a representative example of a class of markets that occupy an
intermediate position between frontier and emerging status: large enough
to sustain active equity trading, yet still evolving in terms of
regulation, disclosure quality, and investor composition.

By grounding methodological development in Vietnam's market structure,
the book aims to produce insights that generalize to other contexts,
including Southeast Asia, South Asia, Sub-Saharan Africa, and parts of
Latin America. Each empirical chapter emphasizes which components are
market-specific and which are portable, encouraging readers to adapt the
framework rather than adopt it wholesale.

\section*{Data Access}\label{data-access}
\addcontentsline{toc}{section}{Data Access}

\markright{Data Access}

The empirical analyses in this book rely on Vietnamese equity market
data provided by \href{https://datacore.vn/}{Datacore}. To ensure
reproducibility while respecting data licensing constraints, we provide
the following resources:

\begin{itemize}
\tightlist
\item
  \textbf{Sample datasets}: A subset of anonymized data is available in
  \href{https://datacore.vn/en/demo/dataset-groups}{DataCore's Sample
  Dataset} for readers to run example code.
\item
  \textbf{Data construction scripts}: All scripts used to clean and
  transform raw data are fully documented and available in the
  repository.
\item
  \textbf{Replication guidance}: Readers with access to Vietnamese
  market data from commercial providers can use our scripts to construct
  equivalent datasets.
\end{itemize}

For questions about data access or replication, please contact the
author.

\section*{Contribution and Audience}\label{contribution-and-audience}
\addcontentsline{toc}{section}{Contribution and Audience}

\markright{Contribution and Audience}

This book makes three primary contributions.

First, it proposes a reproducible empirical finance framework explicitly
designed for emerging and frontier markets, integrating institutional
detail into data construction and model design. Second, it provides
original empirical evidence on asset pricing, liquidity, and market
microstructure in Vietnam using consistently constructed datasets.
Third, it provides publication-ready, end-to-end research workflows
suitable for academic research, policy analysis, and applied finance.

The intended audience includes graduate students in finance and
economics, academic researchers studying non-developed markets, and
practitioners interested in the systematic analysis of emerging-market
equities. Familiarity with basic asset pricing theory and statistical
programming is assumed, but no prior experience with Vietnam or similar
markets is required.

\section*{Structure of the Book}\label{structure-of-the-book}
\addcontentsline{toc}{section}{Structure of the Book}

\markright{Structure of the Book}

The chapters that follow progress from data infrastructure to empirical
application. The book begins with an introduction to the data sources
and infrastructure used throughout, followed by chapters on
institutional context, data construction, and reproducible workflow
design. Subsequent chapters develop asset pricing tests, liquidity
measures, and market microstructure analyses tailored to Vietnam's
equity market. Each chapter is designed to be self-contained, yet all
are linked through a common data and code architecture to ensure
internal consistency.

The book concludes by reflecting on the broader implications of
reproducible empirical finance for emerging markets research and by
outlining directions for future methodological and empirical work.

\bookmarksetup{startatroot}

\chapter{Institutional Background and Market Structure of Vietnam's
Equity
Market}\label{institutional-background-and-market-structure-of-vietnams-equity-market}

Empirical analysis of financial markets is inseparable from
institutional context. Market design, regulatory constraints, ownership
structure, and investor composition shape observed prices, volumes, and
returns. In developed markets, many of these features are sufficiently
stable and standardized that they fade into the background of empirical
research. In emerging markets, by contrast, institutional features are
often first-order determinants of empirical outcomes.

This chapter provides the institutional foundation for the empirical
analyses developed later in the book. It describes the structure of
Vietnam's equity market, the regulatory environment governing trading
and disclosure, and the characteristics of listed firms and investors.
Rather than offering a purely descriptive account, the discussion
emphasizes how institutional features map directly into data
construction choices, modeling assumptions, and interpretation of
empirical results.

\section{Evolution of Vietnam's Equity
Market}\label{evolution-of-vietnams-equity-market}

Vietnam's modern equity market is relatively young. Formal stock
exchanges were established only in the early 2000s, as part of broader
economic reforms aimed at transitioning from a centrally planned system
toward a market-oriented economy. Since then, market capitalization,
trading volume, and the number of listed firms have grown rapidly,
albeit unevenly across sectors and time.

The pace of market development has been shaped by a combination of
gradual privatization of state-owned enterprises, episodic regulatory
reform, and sustained participation by retail investors. Unlike markets
that evolved alongside large institutional investor bases, Vietnam's
equity market matured in an environment where individual investors
dominate trading activity and informational asymmetries remain
substantial.

These features have important empirical implications. Return dynamics
may reflect behavioral trading patterns, liquidity shocks can be
amplified by coordinated retail activity, and firm-level information is
incorporated into prices at varying speeds. A reproducible empirical
framework must therefore be capable of capturing these dynamics without
imposing assumptions derived from institutionally different markets.

\section{Exchange Structure and Trading
Mechanisms}\label{exchange-structure-and-trading-mechanisms}

Vietnam operates multiple equity exchanges, each with distinct listing
requirements and trading rules. Trading is conducted through a
centralized limit order book, with price-time priority determining
execution. Importantly, daily price limits constrain the maximum
allowable price movement for individual securities. These limits vary by
exchange and security type and are binding during periods of heightened
volatility.

Price limits introduce mechanical truncation in observed returns,
clustering at upper and lower bounds, and persistence in price movements
across days. From an empirical perspective, this challenges standard
assumptions about continuous price adjustment and complicates volatility
estimation, momentum measurement, and event-study design.

In this book, price limits are treated as structural features rather
than anomalies. Data pipelines explicitly preserve limit-hit indicators,
and empirical models are adapted to account for constrained price
dynamics. This design choice reflects a broader principle:
reproducibility in emerging markets requires preserving institutional
signals rather than smoothing them away.

\section{Listing Requirements and Firm
Characteristics}\label{listing-requirements-and-firm-characteristics}

Listed firms in Vietnam exhibit substantial heterogeneity in size,
ownership structure, and disclosure quality. A defining characteristic
of the market is the prevalence of firms with significant state
ownership, either directly or through affiliated entities. State
ownership affects governance, dividend policy, risk-taking behavior, and
responsiveness to market signals.

Accounting disclosures follow Vietnamese Accounting Standards, which
differ in important respects from international standards. While
convergence efforts are ongoing, historical financial statements often
reflect transitional rules, incomplete adoption of fair value
accounting, and limited segment reporting. These features complicate
cross-firm comparability and longitudinal analysis.

From a reproducible research standpoint, accounting variables cannot be
treated as uniform primitives. Variable definitions, reporting lags, and
restatement practices must be explicitly documented and encoded into
data construction logic. Later chapters demonstrate how accounting data
are harmonized in a transparent, version-controlled manner without
obscuring underlying institutional differences.

\section{Investor Composition and Trading
Behavior}\label{investor-composition-and-trading-behavior}

Retail investors dominate trading volume in Vietnam's equity market.
Institutional investors, including domestic funds and foreign
participants, play a growing but still secondary role. This investor
composition has implications for liquidity provision, price discovery,
and market stability.

Retail-dominated markets tend to exhibit higher turnover, episodic
herding behavior, and sensitivity to non-fundamental information. These
patterns affect the interpretation of empirical results, particularly in
studies of short-term return predictability, volume-return relations,
and volatility clustering.

Rather than assuming institutional trading as the default, this book
explicitly models liquidity and trading activity in a retail-centric
environment. Measures of liquidity, for example, are chosen and
constructed to remain meaningful in the presence of small trade sizes,
intermittent trading, and order imbalances driven by individual
investors.

\section{Regulatory Environment and Market
Frictions}\label{regulatory-environment-and-market-frictions}

Regulatory oversight of Vietnam's equity market has evolved alongside
market development. Trading rules, disclosure requirements, and foreign
ownership limits have been periodically revised, sometimes with limited
backward compatibility. Regulatory changes can induce structural breaks
in data that are not immediately apparent in raw time series.

Short-selling constraints, limited securities lending, and restrictions
on derivative usage further distinguish Vietnam's market from developed
counterparts. These frictions affect arbitrage activity and the
feasibility of certain trading strategies, influencing observed return
patterns and factor realizations.

A key principle of the empirical framework developed in this book is
regulatory awareness. Data pipelines incorporate regulatory timelines,
and empirical tests are designed to be robust to rule changes. This
ensures that results are interpretable within the institutional regime
in which they arise.

\section{Implications for Empirical
Design}\label{implications-for-empirical-design}

The institutional features described in this chapter motivate several
design choices that recur throughout the book:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Data preservation over simplification}: Institutional
  constraints such as price limits and trading halts are retained and
  explicitly modeled.
\item
  \textbf{Modular variable construction}: Accounting and market
  variables are constructed through transparent functions that can be
  adjusted as standards evolve.
\item
  \textbf{Regime sensitivity}: Empirical analyses are structured to
  detect and accommodate regulatory and structural breaks.
\item
  \textbf{Context-aware interpretation}: Results are interpreted in
  light of market structure rather than benchmarked mechanically against
  developed-market findings.
\end{enumerate}

\section{Summary}\label{summary}

Vietnam's equity market combines rapid growth with distinctive
institutional features that challenge conventional empirical finance
methods. Price limits, retail investor dominance, state ownership, and
evolving regulation shape market outcomes in ways that cannot be ignored
or abstracted away. For researchers working in such environments,
reproducibility requires more than clean code and documented data---it
requires embedding institutional context directly into empirical design.

\bookmarksetup{startatroot}

\chapter{Constructing and Analyzing Equity Return
Series}\label{constructing-and-analyzing-equity-return-series}

This chapter develops a practical framework for transforming raw equity
price records into return series suitable for empirical financial
analysis. The focus is on methodological clarity and reproducibility,
with particular attention to data issues that are prevalent in emerging
equity markets such as Vietnam.

The discussion proceeds from individual stocks to a broad market
cross-section, using constituents of the VN30 index as the primary
empirical setting.

\section{Data Access and Preparation}\label{data-access-and-preparation}

We begin by loading the core numerical and data manipulation libraries.
These provide all functionality required for return construction without
relying on specialized financial wrappers.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\end{Highlighting}
\end{Shaded}

For this project, we retrieve our historical price data using the
DataCore API. If you wish to replicate this analysis or use the dataset
for your own work, you will need to access the data through their
platform.

\subsection{Prerequisites for API
Access}\label{prerequisites-for-api-access}

To run the code below, you need to configure a few things first:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Obtain an API Key:} You must subscribe to the relevant dataset
  on the \href{https://datacore.vn/}{DataCore} platform to receive a
  unique API key.
\item
  \textbf{Whitelist Your IP Address:} The API requires your IP address
  to be whitelisted for security.

  \begin{itemize}
  \tightlist
  \item
    \textbf{Local Machine:} If you are running this code on your
    personal computer, you generally need to whitelist your public IP
    address.
  \item
    \textbf{Cloud or Remote Sessions (e.g., HPC Open OnDemand):} If you
    are using a remote server such as those provided by DataCore, the
    server's IP address will change with each new session. You must
    retrieve the server's private/public IP for that specific session
    and whitelist it in your DataCore account settings before running
    the script.
  \end{itemize}
\item
  \textbf{Set Environment Variables:} To keep your credentials secure,
  do not hardcode your API key into your scripts. Instead, save it as an
  environment variable named \texttt{datacore\_api} on your machine.
\end{enumerate}

\emph{Note: If you only want to test the code performance, DataCore
provides a preview endpoint that does not require an API key, though the
data returned is limited.}

\phantomsection\label{datacore-demo}
\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ requests}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}

\NormalTok{url }\OperatorTok{=} \StringTok{"https://gateway.datacore.vn/data/ds/preview"}
\NormalTok{params }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"dataSetCode"}\NormalTok{: }\StringTok{"fundamental\_annual"}\NormalTok{,}
    \StringTok{"pageSize"}\NormalTok{: }\DecValTok{10000} 
\NormalTok{\}}
\NormalTok{headers }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{"Accept"}\NormalTok{: }\StringTok{"application/json"}\NormalTok{,}
    \StringTok{"Origin"}\NormalTok{: }\StringTok{"https://datacore.vn"}\NormalTok{,}
    \StringTok{"Referer"}\NormalTok{: }\StringTok{"https://datacore.vn/"}
\NormalTok{\}}

\NormalTok{response }\OperatorTok{=}\NormalTok{ requests.get(url, params}\OperatorTok{=}\NormalTok{params, headers}\OperatorTok{=}\NormalTok{headers)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ response.json()}

\NormalTok{columns }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}data\textquotesingle{}}\NormalTok{][}\StringTok{\textquotesingle{}fields\textquotesingle{}}\NormalTok{]}
\NormalTok{rows }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}data\textquotesingle{}}\NormalTok{][}\StringTok{\textquotesingle{}dataDetail\textquotesingle{}}\NormalTok{]}

\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(rows, columns}\OperatorTok{=}\NormalTok{columns)}
\BuiltInTok{print}\NormalTok{(df.head())}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Total rows:"}\NormalTok{, }\BuiltInTok{len}\NormalTok{(df))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  symbol  year  total_current_asset ca_fin        ca_cce       ca_cash  \
0    CLL  2011         1.078338e+11   None  8.313178e+10  4.131776e+09   
1    CLL  2012         2.360575e+10   None  8.003560e+09  4.003560e+09   
2    CLL  2013         5.764370e+10   None  3.496426e+10  9.964256e+09   
3    CLL  2014         4.973590e+10   None  1.718744e+10  1.718744e+10   
4    CLL  2015         2.389115e+11   None  1.790364e+11  2.403638e+10   

  ca_cash_inbank ca_cash_attransit  ca_cash_equivalent  ca_fin_invest  ...  \
0           None              None        7.900000e+10   0.000000e+00  ...   
1           None              None        4.000000e+09   0.000000e+00  ...   
2           None              None        2.500000e+10   0.000000e+00  ...   
3           None              None        0.000000e+00   1.000000e+09  ...   
4           None              None        1.550000e+11   1.000000e+09  ...   

   operating_margin      roe      roa sector_pe sector_pb  sector_ps  \
0           0.35473  0.19560  0.10649   3.00213   0.26108    0.22170   
1           0.45369  0.20337  0.13018   2.40335   0.26211    0.21745   
2           0.45997  0.23459  0.16452   3.11089   0.41013    0.32436   
3           0.40554  0.19984  0.14747   3.25886   0.46823    0.42146   
4           0.33774  0.16525  0.12633   6.77337   0.81110    0.68401   

   sector_eps  sector_ros  sector_roe  sector_roa  
0  3341.54903     0.07385     0.08753     0.05039  
1  4296.47005     0.09048     0.11392     0.06346  
2  4024.74648     0.10427     0.13645     0.07415  
3  5100.81019     0.12933     0.14956     0.08087  
4  5216.38499     0.10098     0.11815     0.06234  

[5 rows x 308 columns]
Total rows: 10
\end{verbatim}

\subsection{Checking Your IP Address}\label{checking-your-ip-address}

If you need to verify the IP address of the machine running your code
(to whitelist it), you can use the following Python snippets.

\textbf{To find your Public IP:}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ requests}

\ControlFlowTok{try}\NormalTok{:}
\NormalTok{    public\_ip }\OperatorTok{=}\NormalTok{ requests.get(}\StringTok{"https://api.ipify.org"}\NormalTok{).text}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Public IP: }\SpecialCharTok{\{}\NormalTok{public\_ip}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\ControlFlowTok{except}\NormalTok{ requests.exceptions.RequestException }\ImportTok{as}\NormalTok{ e:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Could not retrieve Public IP: }\SpecialCharTok{\{}\NormalTok{e}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{To find your Private IP (useful for specific remote server
setups):}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ socket}

\KeywordTok{def}\NormalTok{ get\_private\_ip():}
    \ControlFlowTok{try}\NormalTok{:}
\NormalTok{        s }\OperatorTok{=}\NormalTok{ socket.socket(socket.AF\_INET, socket.SOCK\_DGRAM)}
\NormalTok{        s.}\ExtensionTok{connect}\NormalTok{((}\StringTok{"8.8.8.8"}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{        private\_ip }\OperatorTok{=}\NormalTok{ s.getsockname()[}\DecValTok{0}\NormalTok{]}
\NormalTok{        s.close()}
        \ControlFlowTok{return}\NormalTok{ private\_ip}
    \ControlFlowTok{except} \PreprocessorTok{Exception} \ImportTok{as}\NormalTok{ e:}
        \ControlFlowTok{return} \SpecialStringTok{f"Error: }\SpecialCharTok{\{}\NormalTok{e}\SpecialCharTok{\}}\SpecialStringTok{"}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Private IP: }\SpecialCharTok{\{}\NormalTok{get\_private\_ip()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Fetching the Dataset}\label{fetching-the-dataset}

The following script demonstrates how to securely authenticate and
paginate through the DataCore API to retrieve the full
\texttt{dataset\_historical\_price} dataset.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Convert the date column to proper datetime objects}
\NormalTok{prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(prices[}\StringTok{"date"}\NormalTok{])}

\CommentTok{\# Ensure price and ratio columns are numeric before calculation}
\NormalTok{prices[}\StringTok{"close\_price"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_numeric(prices[}\StringTok{"close\_price"}\NormalTok{])}
\NormalTok{prices[}\StringTok{"adj\_ratio"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_numeric(prices[}\StringTok{"adj\_ratio"}\NormalTok{])}

\CommentTok{\# Calculate the adjusted close price}
\NormalTok{prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices[}\StringTok{"close\_price"}\NormalTok{] }\OperatorTok{*}\NormalTok{ prices[}\StringTok{"adj\_ratio"}\NormalTok{]}

\CommentTok{\# Rename columns to match standard conventions}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.rename(}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{\{}
        \StringTok{"vol\_total"}\NormalTok{: }\StringTok{"volume"}\NormalTok{,}
        \StringTok{"open\_price"}\NormalTok{: }\StringTok{"open"}\NormalTok{,}
        \StringTok{"low\_price"}\NormalTok{: }\StringTok{"low"}\NormalTok{,}
        \StringTok{"high\_price"}\NormalTok{: }\StringTok{"high"}\NormalTok{,}
        \StringTok{"close\_price"}\NormalTok{: }\StringTok{"close"}\NormalTok{,}
\NormalTok{    \}}
\NormalTok{)}

\CommentTok{\# Sort the dataset logically by symbol and date}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Data manipulation complete. The dataset is ready for analysis."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Data manipulation complete. The dataset is ready for analysis.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(prices[}\StringTok{"date"}\NormalTok{])}


\NormalTok{prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices[}\StringTok{"close\_price"}\NormalTok{] }\OperatorTok{*}\NormalTok{ prices[}\StringTok{"adj\_ratio"}\NormalTok{]}


\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.rename(}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{\{}
        \StringTok{"vol\_total"}\NormalTok{: }\StringTok{"volume"}\NormalTok{,}
        \StringTok{"open\_price"}\NormalTok{: }\StringTok{"open"}\NormalTok{,}
        \StringTok{"low\_price"}\NormalTok{: }\StringTok{"low"}\NormalTok{,}
        \StringTok{"high\_price"}\NormalTok{: }\StringTok{"high"}\NormalTok{,}
        \StringTok{"close\_price"}\NormalTok{: }\StringTok{"close"}\NormalTok{,}
\NormalTok{    \}}
\NormalTok{)}

\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

Adjusted closing prices incorporate mechanical changes due to corporate
actions such as cash dividends and stock splits. Using adjusted prices
ensures that subsequent return calculations reflect investor-relevant
performance rather than accounting artifacts.

\section{Examining a Single Equity}\label{examining-a-single-equity}

To ground the discussion, we isolate the trading history of a single
large-cap stock, FPT, over a long sample period.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ datetime }\ImportTok{as}\NormalTok{ dt}

\NormalTok{start }\OperatorTok{=}\NormalTok{ pd.Timestamp(}\StringTok{"2000{-}01{-}01"}\NormalTok{)}
\NormalTok{end }\OperatorTok{=}\NormalTok{ pd.Timestamp(dt.date.today().year }\OperatorTok{{-}} \DecValTok{1}\NormalTok{, }\DecValTok{12}\NormalTok{, }\DecValTok{31}\NormalTok{)}


\NormalTok{fpt }\OperatorTok{=}\NormalTok{ prices.loc[}
\NormalTok{    (prices[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{==} \StringTok{"FPT"}\NormalTok{)}
    \OperatorTok{\&}\NormalTok{ (prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{\textgreater{}=}\NormalTok{ start)}
    \OperatorTok{\&}\NormalTok{ (prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{\textless{}=}\NormalTok{ end),}
\NormalTok{    [}\StringTok{"date"}\NormalTok{, }\StringTok{"symbol"}\NormalTok{, }\StringTok{"volume"}\NormalTok{, }\StringTok{"open"}\NormalTok{, }\StringTok{"low"}\NormalTok{, }\StringTok{"high"}\NormalTok{, }\StringTok{"close"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{],}
\NormalTok{].copy()}
\end{Highlighting}
\end{Shaded}

This subset contains the standard daily market variables required for
most empirical studies. Before computing returns, it is good practice to
visually inspect the price series.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import}\NormalTok{ ggplot, aes, geom\_line, labs}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ggplot(fpt, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"adjusted\_close"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line()}
    \OperatorTok{+}\NormalTok{ labs(title}\OperatorTok{=}\StringTok{"Adjusted price path of FPT"}\NormalTok{, x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/fig-100-output-1.pdf}}

}

\caption{\label{fig-100}Prices are in VND, adjusted for dividend
payments and stock splits.}

\end{figure}%

\section{From Prices to Returns}\label{from-prices-to-returns}

Most empirical asset pricing models are formulated in terms of returns
rather than price levels. The simple daily return is defined as

\[
r_t = \frac{p_t}{p_t - 1} - 1, 
\]

where \(p_t\) denotes the adjusted closing price at the end of trading
day \(t\).

Before computing returns, we must address invalid price observations. In
Vietnamese equity data, adjusted prices occasionally take the value
zero. These entries typically arise from IPO placeholders, trading
suspensions, or historical backfilling conventions and cannot be used to
compute meaningful returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices.loc[prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, [}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{]].head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& symbol & date & adjusted\_close \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
33886 & ADP & 2010-02-09 & 0.0 \\
33887 & ADP & 2010-02-24 & 0.0 \\
33888 & ADP & 2010-03-01 & 0.0 \\
33889 & ADP & 2010-03-03 & 0.0 \\
33890 & ADP & 2010-03-12 & 0.0 \\
\end{longtable}

We therefore exclude non-positive adjusted prices and compute returns
stock by stock. Correct chronological ordering is essential.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices}
\NormalTok{    .loc[prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{]}
\NormalTok{    .sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{    .assign(ret}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change())}
\NormalTok{    [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]]}
\NormalTok{)}
\NormalTok{returns }\OperatorTok{=}\NormalTok{ returns.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

The initial return for each stock is missing by construction, since no
lagged price is available. These observations are mechanical and can
safely be removed in most applications.

\section{Limiting the Influence of Extreme
Returns}\label{limiting-the-influence-of-extreme-returns}

Daily return series often contain extreme observations driven by data
errors, thin trading, or abrupt price adjustments. A common approach is
to winsorize returns using cross-sectional percentile cutoffs.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ winsorize\_cs(df, column}\OperatorTok{=}\StringTok{"ret"}\NormalTok{, lower\_q}\OperatorTok{=}\FloatTok{0.01}\NormalTok{, upper\_q}\OperatorTok{=}\FloatTok{0.99}\NormalTok{):}
\NormalTok{    lo }\OperatorTok{=}\NormalTok{ df[column].quantile(lower\_q)}
\NormalTok{    hi }\OperatorTok{=}\NormalTok{ df[column].quantile(upper\_q)}
\NormalTok{    out }\OperatorTok{=}\NormalTok{ df.copy()}
\NormalTok{    out[column] }\OperatorTok{=}\NormalTok{ out[column].clip(lo, hi)}
    \ControlFlowTok{return}\NormalTok{ out}

\NormalTok{returns }\OperatorTok{=}\NormalTok{ winsorize\_cs(returns)}
\end{Highlighting}
\end{Shaded}

Applying winsorization across the full cross-section limits the impact
of extreme market-wide observations while preserving relative
differences between firms. Winsorizing within each stock is rarely
appropriate in panel settings and can severely distort illiquid
securities.

\section{Distributional Features of
Returns}\label{distributional-features-of-returns}

We next examine the empirical distribution of daily returns for FPT. The
figure below also marks the historical 5 percent quantile, which
provides a simple, non-parametric measure of downside risk.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format}
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import}\NormalTok{ geom\_histogram, geom\_vline, scale\_x\_continuous}


\NormalTok{fpt\_ret }\OperatorTok{=}\NormalTok{ returns.loc[returns[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{==} \StringTok{"FPT"}\NormalTok{].copy()}
\NormalTok{q05 }\OperatorTok{=}\NormalTok{ fpt\_ret[}\StringTok{"ret"}\NormalTok{].quantile(}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ggplot(fpt\_ret, aes(x}\OperatorTok{=}\StringTok{"ret"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_histogram(bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_vline(xintercept}\OperatorTok{=}\NormalTok{q05, linetype}\OperatorTok{=}\StringTok{"dashed"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(title}\OperatorTok{=}\StringTok{"Distribution of daily FPT returns"}\NormalTok{, x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/fig-101-output-1.pdf}}

}

\caption{\label{fig-101}The dotted vertical line indicates the
historical five percent quantile.}

\end{figure}%

Summary statistics offer a compact description of return behavior and
should always be inspected before formal modeling.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{"ret"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count    4305063.000
mean           0.000
std            0.035
min           -0.125
25%           -0.004
50%            0.000
75%            0.003
max            0.130
Name: ret, dtype: float64
\end{verbatim}

Computing these statistics by calendar year can reveal periods of
elevated volatility or structural change.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns}
\NormalTok{    .assign(year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.year)}
\NormalTok{    .groupby(}\StringTok{"year"}\NormalTok{)[}\StringTok{"ret"}\NormalTok{]}
\NormalTok{    .describe()}
\NormalTok{    .}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& count & mean & std & min & 25\% & 50\% & 75\% & max \\
year & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2010 & 131548.0 & -0.001 & 0.036 & -0.125 & -0.021 & 0.0 & 0.018 &
0.13 \\
2011 & 166826.0 & -0.003 & 0.033 & -0.125 & -0.020 & 0.0 & 0.011 &
0.13 \\
2012 & 177938.0 & 0.000 & 0.033 & -0.125 & -0.012 & 0.0 & 0.015 &
0.13 \\
2013 & 180417.0 & 0.001 & 0.033 & -0.125 & -0.004 & 0.0 & 0.008 &
0.13 \\
2014 & 181907.0 & 0.001 & 0.034 & -0.125 & -0.008 & 0.0 & 0.011 &
0.13 \\
2015 & 197881.0 & 0.000 & 0.033 & -0.125 & -0.006 & 0.0 & 0.005 &
0.13 \\
2016 & 227896.0 & 0.000 & 0.035 & -0.125 & -0.005 & 0.0 & 0.003 &
0.13 \\
2017 & 283642.0 & 0.001 & 0.034 & -0.125 & -0.002 & 0.0 & 0.001 &
0.13 \\
2018 & 329887.0 & 0.000 & 0.035 & -0.125 & 0.000 & 0.0 & 0.000 & 0.13 \\
2019 & 352754.0 & 0.000 & 0.033 & -0.125 & 0.000 & 0.0 & 0.000 & 0.13 \\
2020 & 369367.0 & 0.001 & 0.035 & -0.125 & 0.000 & 0.0 & 0.000 & 0.13 \\
2021 & 379415.0 & 0.002 & 0.038 & -0.125 & -0.005 & 0.0 & 0.007 &
0.13 \\
2022 & 387050.0 & -0.001 & 0.038 & -0.125 & -0.008 & 0.0 & 0.004 &
0.13 \\
2023 & 391605.0 & 0.001 & 0.034 & -0.125 & -0.002 & 0.0 & 0.002 &
0.13 \\
2024 & 400379.0 & 0.000 & 0.031 & -0.125 & -0.002 & 0.0 & 0.000 &
0.13 \\
2025 & 146551.0 & 0.000 & 0.037 & -0.125 & -0.004 & 0.0 & 0.002 &
0.13 \\
\end{longtable}

\section{Expanding to a Market
Cross-Section}\label{expanding-to-a-market-cross-section}

The same procedures apply naturally to a larger universe of stocks. We
now restrict attention to the constituents of the VN30 index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vn30 }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"ACB"}\NormalTok{,}\StringTok{"BCM"}\NormalTok{,}\StringTok{"BID"}\NormalTok{,}\StringTok{"BVH"}\NormalTok{,}\StringTok{"CTG"}\NormalTok{,}\StringTok{"FPT"}\NormalTok{,}\StringTok{"GAS"}\NormalTok{,}\StringTok{"GVR"}\NormalTok{,}\StringTok{"HDB"}\NormalTok{,}\StringTok{"HPG"}\NormalTok{,}
    \StringTok{"MBB"}\NormalTok{,}\StringTok{"MSN"}\NormalTok{,}\StringTok{"MWG"}\NormalTok{,}\StringTok{"PLX"}\NormalTok{,}\StringTok{"POW"}\NormalTok{,}\StringTok{"SAB"}\NormalTok{,}\StringTok{"SHB"}\NormalTok{,}\StringTok{"SSB"}\NormalTok{,}\StringTok{"STB"}\NormalTok{,}\StringTok{"TCB"}\NormalTok{,}
    \StringTok{"TPB"}\NormalTok{,}\StringTok{"VCB"}\NormalTok{,}\StringTok{"VHM"}\NormalTok{,}\StringTok{"VIB"}\NormalTok{,}\StringTok{"VIC"}\NormalTok{,}\StringTok{"VJC"}\NormalTok{,}\StringTok{"VNM"}\NormalTok{,}\StringTok{"VPB"}\NormalTok{,}\StringTok{"VRE"}\NormalTok{,}\StringTok{"EIB"}\NormalTok{,}
\NormalTok{]}


\NormalTok{prices\_vn30 }\OperatorTok{=}\NormalTok{ prices.loc[prices[}\StringTok{"symbol"}\NormalTok{].isin(vn30)]}
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import}\NormalTok{ theme}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ggplot(prices\_vn30, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"adjusted\_close"}\NormalTok{, color}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line()}
    \OperatorTok{+}\NormalTok{ labs(title}\OperatorTok{=}\StringTok{"Adjusted prices of VN30 constituents"}\NormalTok{, x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/fig-102-output-1.pdf}}

}

\caption{\label{fig-102}Prices in VND, adjusted for dividend payments
and stock splits.}

\end{figure}%

Returns for the VN30 universe are computed analogously.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_vn30 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices\_vn30}
\NormalTok{    .sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{    .assign(ret}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change())}
\NormalTok{    [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}


\NormalTok{returns\_vn30.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"ret"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& count & mean & std & min & 25\% & 50\% & 75\% & max \\
symbol & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
ACB & 3822.0 & -0.000 & 0.023 & -0.407 & -0.006 & 0.0 & 0.007 & 0.097 \\
BCM & 1795.0 & 0.001 & 0.027 & -0.136 & -0.010 & 0.0 & 0.010 & 0.159 \\
BID & 2811.0 & 0.000 & 0.024 & -0.369 & -0.010 & 0.0 & 0.011 & 0.070 \\
BVH & 3825.0 & 0.000 & 0.024 & -0.097 & -0.012 & 0.0 & 0.012 & 0.070 \\
CTG & 3825.0 & 0.000 & 0.024 & -0.376 & -0.010 & 0.0 & 0.010 & 0.070 \\
EIB & 3825.0 & -0.000 & 0.022 & -0.302 & -0.008 & 0.0 & 0.008 & 0.070 \\
FPT & 3825.0 & -0.000 & 0.024 & -0.439 & -0.008 & 0.0 & 0.009 & 0.070 \\
GAS & 3236.0 & 0.000 & 0.022 & -0.289 & -0.009 & 0.0 & 0.010 & 0.070 \\
GVR & 1775.0 & 0.001 & 0.030 & -0.137 & -0.014 & 0.0 & 0.016 & 0.169 \\
HDB & 1828.0 & -0.001 & 0.028 & -0.391 & -0.009 & 0.0 & 0.010 & 0.070 \\
HPG & 3825.0 & -0.001 & 0.032 & -0.581 & -0.010 & 0.0 & 0.011 & 0.070 \\
MBB & 3371.0 & -0.000 & 0.023 & -0.473 & -0.008 & 0.0 & 0.008 & 0.069 \\
MSN & 3825.0 & 0.000 & 0.024 & -0.553 & -0.010 & 0.0 & 0.010 & 0.070 \\
MWG & 2701.0 & -0.000 & 0.035 & -0.751 & -0.009 & 0.0 & 0.011 & 0.070 \\
PLX & 2009.0 & -0.000 & 0.021 & -0.140 & -0.010 & 0.0 & 0.010 & 0.070 \\
POW & 1784.0 & 0.000 & 0.023 & -0.071 & -0.012 & 0.0 & 0.011 & 0.102 \\
SAB & 2100.0 & -0.000 & 0.024 & -0.745 & -0.008 & 0.0 & 0.007 & 0.070 \\
SHB & 3824.0 & -0.000 & 0.028 & -0.338 & -0.013 & 0.0 & 0.013 & 0.100 \\
SSB & 1029.0 & -0.000 & 0.023 & -0.292 & -0.005 & 0.0 & 0.004 & 0.070 \\
STB & 3825.0 & 0.000 & 0.024 & -0.321 & -0.010 & 0.0 & 0.010 & 0.070 \\
TCB & 1732.0 & -0.000 & 0.035 & -0.884 & -0.009 & 0.0 & 0.010 & 0.070 \\
TPB & 1761.0 & -0.001 & 0.029 & -0.477 & -0.009 & 0.0 & 0.009 & 0.070 \\
VCB & 3825.0 & -0.000 & 0.024 & -0.539 & -0.009 & 0.0 & 0.009 & 0.070 \\
VHM & 1744.0 & -0.000 & 0.024 & -0.419 & -0.009 & 0.0 & 0.008 & 0.070 \\
VIB & 2072.0 & -0.000 & 0.031 & -0.489 & -0.009 & 0.0 & 0.010 & 0.109 \\
VIC & 3825.0 & -0.000 & 0.027 & -0.673 & -0.008 & 0.0 & 0.008 & 0.070 \\
VJC & 2046.0 & -0.000 & 0.020 & -0.455 & -0.007 & 0.0 & 0.006 & 0.070 \\
VNM & 3825.0 & -0.000 & 0.023 & -0.547 & -0.007 & 0.0 & 0.007 & 0.070 \\
VPB & 1927.0 & -0.000 & 0.033 & -0.678 & -0.010 & 0.0 & 0.010 & 0.070 \\
VRE & 1871.0 & -0.000 & 0.024 & -0.295 & -0.012 & 0.0 & 0.011 & 0.070 \\
\end{longtable}

\section{Aggregating Returns Across
Time}\label{aggregating-returns-across-time}

Financial variables are observed at different frequencies. While equity
prices are recorded daily, many empirical questions require monthly or
annual returns. Lower-frequency returns are constructed by compounding
higher-frequency observations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_monthly }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_vn30}
\NormalTok{    .assign(month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{).dt.to\_timestamp())}
\NormalTok{    .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"month"}\NormalTok{], as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    .agg(ret}\OperatorTok{=}\NormalTok{(}\StringTok{"ret"}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: np.prod(}\DecValTok{1} \OperatorTok{+}\NormalTok{ x) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Comparing daily and monthly return distributions illustrates how
aggregation dampens volatility and alters tail behavior.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import}\NormalTok{ facet\_wrap}

\NormalTok{fpt\_d }\OperatorTok{=}\NormalTok{ returns\_vn30.loc[returns\_vn30[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{==} \StringTok{"FPT"}\NormalTok{].assign(freq}\OperatorTok{=}\StringTok{"Daily"}\NormalTok{)}
\NormalTok{fpt\_m }\OperatorTok{=}\NormalTok{ returns\_monthly.loc[returns\_monthly[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{==} \StringTok{"FPT"}\NormalTok{].assign(freq}\OperatorTok{=}\StringTok{"Monthly"}\NormalTok{)}


\NormalTok{fpt\_both }\OperatorTok{=}\NormalTok{ pd.concat([}
\NormalTok{    fpt\_d[[}\StringTok{"ret"}\NormalTok{, }\StringTok{"freq"}\NormalTok{]],}
\NormalTok{    fpt\_m[[}\StringTok{"ret"}\NormalTok{, }\StringTok{"freq"}\NormalTok{]],}
\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ggplot(fpt\_both, aes(x}\OperatorTok{=}\StringTok{"ret"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_histogram(bins}\OperatorTok{=}\DecValTok{50}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(title}\OperatorTok{=}\StringTok{"FPT returns at different frequencies"}\NormalTok{, x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ facet\_wrap(}\StringTok{"freq"}\NormalTok{, scales}\OperatorTok{=}\StringTok{"free"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/fig-103-output-1.pdf}}

}

\caption{\label{fig-103}Returns are based on prices adjusted for
dividend payments and stock splits.}

\end{figure}%

\section{Aggregation Across Firms: Trading
Activity}\label{aggregation-across-firms-trading-activity}

Aggregation is not limited to time. In some settings, it is informative
to aggregate variables across firms. As an illustration, we compute
total daily trading value for VN30 stocks by multiplying share volume by
adjusted prices and summing across firms.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{trading\_value }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices\_vn30}
\NormalTok{    .assign(value}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"volume"}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{/} \FloatTok{1e9}\NormalTok{)}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)[}\StringTok{"value"}\NormalTok{]}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(value\_lag}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"value"}\NormalTok{].shift(}\DecValTok{1}\NormalTok{))}
\NormalTok{)}
\NormalTok{(}
\NormalTok{    ggplot(trading\_value, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"value"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line()}
    \OperatorTok{+}\NormalTok{ labs(title}\OperatorTok{=}\StringTok{"Aggregate VN30 trading value (billion VND)"}\NormalTok{, x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/cell-27-output-1.pdf}}

Finally, we assess persistence in trading activity by comparing trading
value on consecutive days.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import}\NormalTok{ geom\_point, geom\_abline}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ggplot(trading\_value, aes(x}\OperatorTok{=}\StringTok{"value\_lag"}\NormalTok{, y}\OperatorTok{=}\StringTok{"value"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_point()}
    \OperatorTok{+}\NormalTok{ geom\_abline(intercept}\OperatorTok{=}\DecValTok{0}\NormalTok{, slope}\OperatorTok{=}\DecValTok{1}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"dashed"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Persistence in VN30 trading value"}\NormalTok{,}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Previous day"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Current day"}\NormalTok{,}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{01_working_with_stock_returns_files/figure-pdf/fig-104-output-1.pdf}}

}

\caption{\label{fig-104}Total daily trading volume.}

\end{figure}%

A strong alignment along the 45-degree line indicates that high-activity
trading days tend to be followed by similarly active days, a common
empirical regularity in equity markets.

\section{Summary}\label{summary-1}

This chapter established a reproducible workflow for transforming raw
price data into return series, diagnosing common data issues, and
aggregating information across time and firms. These steps provide the
empirical foundation for subsequent analyses of risk, return
predictability, and market dynamics in Vietnam's equity market.

\bookmarksetup{startatroot}

\chapter{Modern Portfolio Theory}\label{modern-portfolio-theory}

In the previous chapter, we showed how to download and analyze stock
market data with figures and summary statistics. Now, we turn to one of
the most fundamental questions in finance: How should an investor
allocate their wealth across assets that differ in expected returns,
variance, and correlations to optimize their portfolio's performance?

This question might seem straightforward at first glance. Why not simply
invest everything in the asset with the highest expected return? The
answer lies in a profound insight that transformed financial economics:
\textbf{risk matters, and it can be managed through diversification}.

Modern Portfolio Theory (MPT), introduced by Markowitz (1952),
revolutionized investment decision-making by formalizing the trade-off
between risk and expected return. Before Markowitz, investors largely
thought about risk on a security-by-security basis. Markowitz's genius
was recognizing that what matters is not the risk of individual
securities in isolation, but how they contribute to the risk of the
\emph{entire portfolio}. This insight was so influential that it earned
him the Sveriges Riksbank Prize in Economic Sciences in 1990 and laid
the foundation for much of modern finance.

\subsection{The Core Insight: Diversification as a Free
Lunch}\label{the-core-insight-diversification-as-a-free-lunch}

MPT relies on a crucial mathematical fact: portfolio risk depends not
only on individual asset volatilities but also on the
\emph{correlations} between asset returns. This insight reveals the
power of diversification---combining assets whose returns don't move in
perfect lockstep can reduce overall portfolio risk without necessarily
sacrificing expected return.

Consider a simple analogy: Imagine you run a business selling both
sunscreen and umbrellas. On sunny days, sunscreen sales boom but
umbrella sales suffer; on rainy days, the reverse happens. By selling
both products, your total revenue becomes more stable than if you sold
only one. The ``correlation'' between sunscreen and umbrella sales is
negative, and combining them reduces the variance of your overall
income. This is precisely the logic behind portfolio diversification.

The fruit basket analogy offers another perspective: If all you have are
apples and they spoil, you lose everything. With a variety of fruits,
some may spoil, but others will stay fresh. Diversification provides
insurance against the idiosyncratic risks of individual assets.

\subsection{The Mean-Variance
Framework}\label{the-mean-variance-framework}

At the heart of MPT is \textbf{mean-variance analysis}, which evaluates
portfolios based on two dimensions:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Expected return (mean)}: The anticipated average profit from
  holding the portfolio
\item
  \textbf{Risk (variance)}: The dispersion of possible returns around
  the expected value
\end{enumerate}

The key assumption is that investors care only about these two moments
of the return distribution. This assumption is exactly correct if
returns are normally distributed, or if investors have quadratic utility
functions. Even when these conditions don't hold precisely,
mean-variance analysis often provides a good approximation to optimal
portfolio choice.

By balancing expected return and risk, investors can construct
portfolios that either maximize expected return for a given level of
risk, or minimize risk for a desired level of expected return. In this
chapter, we derive these optimal portfolio decisions analytically and
implement the mean-variance approach computationally.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ tidyfinance }\ImportTok{as}\NormalTok{ tf}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format}
\ImportTok{from}\NormalTok{ adjustText }\ImportTok{import}\NormalTok{ adjust\_text}
\end{Highlighting}
\end{Shaded}

\section{The Asset Universe: Setting Up the
Problem}\label{the-asset-universe-setting-up-the-problem}

Suppose \(N\) different risky assets are available to the investor. Each
asset \(i\) is characterized by:

\begin{itemize}
\tightlist
\item
  \textbf{Expected return} \(\mu_i\): The anticipated profit from
  holding the asset for one period
\item
  \textbf{Variance} \(\sigma_i^2\): The dispersion of returns around the
  mean
\item
  \textbf{Covariances} \(\sigma_{ij}\): The degree to which asset
  \(i\)'s returns move together with asset \(j\)'s returns
\end{itemize}

The investor chooses \textbf{portfolio weights} \(\omega_i\) for each
asset \(i\). These weights represent the fraction of total wealth
invested in each asset. We impose the constraint that weights sum to
one:

\[
\sum_{i=1}^N \omega_i = 1
\]

This ``budget constraint'' ensures that the investor is fully
invested---there is no outside option such as keeping money under a
mattress. Note that we allow weights to be negative (short selling) or
greater than one (leverage), though in practice these positions may face
constraints.

\subsection{The Two Stages of Portfolio
Selection}\label{the-two-stages-of-portfolio-selection}

According to Markowitz (1952), portfolio selection involves two distinct
stages:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Estimation}: Forming expectations about future security
  performance based on observations, experience, and economic reasoning
\item
  \textbf{Optimization}: Using these expectations to choose an optimal
  portfolio
\end{enumerate}

In practice, these stages cannot be fully separated. The estimation
stage determines the inputs (\(\mu\), \(\Sigma\)) that feed into the
optimization stage. Poor estimation leads to poor portfolio choices,
regardless of how sophisticated the optimization procedure.

To keep things conceptually clear, we focus primarily on the
optimization stage in this chapter. We treat the expected returns and
variance-covariance matrix as known, using historical data to compute
reasonable proxies. In later chapters, we address the substantial
challenges that arise from estimation uncertainty.

\subsection{Loading and Preparing the
Data}\label{loading-and-preparing-the-data}

We work with the VN30 index constituents---the 30 largest and most
liquid stocks on Vietnam's Ho Chi Minh Stock Exchange. This provides a
realistic asset universe for a domestic Vietnamese investor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vn30\_symbols }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"ACB"}\NormalTok{,}\StringTok{"BCM"}\NormalTok{,}\StringTok{"BID"}\NormalTok{,}\StringTok{"BVH"}\NormalTok{,}\StringTok{"CTG"}\NormalTok{,}\StringTok{"FPT"}\NormalTok{,}\StringTok{"GAS"}\NormalTok{,}\StringTok{"GVR"}\NormalTok{,}\StringTok{"HDB"}\NormalTok{,}\StringTok{"HPG"}\NormalTok{,}
    \StringTok{"MBB"}\NormalTok{,}\StringTok{"MSN"}\NormalTok{,}\StringTok{"MWG"}\NormalTok{,}\StringTok{"PLX"}\NormalTok{,}\StringTok{"POW"}\NormalTok{,}\StringTok{"SAB"}\NormalTok{,}\StringTok{"SHB"}\NormalTok{,}\StringTok{"SSB"}\NormalTok{,}\StringTok{"STB"}\NormalTok{,}\StringTok{"TCB"}\NormalTok{,}
    \StringTok{"TPB"}\NormalTok{,}\StringTok{"VCB"}\NormalTok{,}\StringTok{"VHM"}\NormalTok{,}\StringTok{"VIB"}\NormalTok{,}\StringTok{"VIC"}\NormalTok{,}\StringTok{"VJC"}\NormalTok{,}\StringTok{"VNM"}\NormalTok{,}\StringTok{"VPB"}\NormalTok{,}\StringTok{"VRE"}\NormalTok{,}\StringTok{"EIB"}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

We load the historical price data:

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{from}\NormalTok{ io }\ImportTok{import}\NormalTok{ BytesIO}
\ImportTok{import}\NormalTok{ datetime }\ImportTok{as}\NormalTok{ dt}
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ boto3}
\ImportTok{from}\NormalTok{ botocore.client }\ImportTok{import}\NormalTok{ Config}

\KeywordTok{class}\NormalTok{ ConnectMinio:}
    \KeywordTok{def} \FunctionTok{\_\_init\_\_}\NormalTok{(}\VariableTok{self}\NormalTok{):}
        \VariableTok{self}\NormalTok{.MINIO\_ENDPOINT }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ENDPOINT"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ACCESS\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_SECRET\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.REGION }\OperatorTok{=}\NormalTok{ os.getenv(}\StringTok{"MINIO\_REGION"}\NormalTok{, }\StringTok{"us{-}east{-}1"}\NormalTok{)}

        \VariableTok{self}\NormalTok{.s3 }\OperatorTok{=}\NormalTok{ boto3.client(}
            \StringTok{"s3"}\NormalTok{,}
\NormalTok{            endpoint\_url}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ENDPOINT,}
\NormalTok{            aws\_access\_key\_id}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY,}
\NormalTok{            aws\_secret\_access\_key}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY,}
\NormalTok{            region\_name}\OperatorTok{=}\VariableTok{self}\NormalTok{.REGION,}
\NormalTok{            config}\OperatorTok{=}\NormalTok{Config(signature\_version}\OperatorTok{=}\StringTok{"s3v4"}\NormalTok{),}
\NormalTok{        )}

    \KeywordTok{def}\NormalTok{ test\_connection(}\VariableTok{self}\NormalTok{):}
\NormalTok{        resp }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.list\_buckets()}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"Connected. Buckets:"}\NormalTok{)}
        \ControlFlowTok{for}\NormalTok{ b }\KeywordTok{in}\NormalTok{ resp.get(}\StringTok{"Buckets"}\NormalTok{, []):}
            \BuiltInTok{print}\NormalTok{(}\StringTok{" {-}"}\NormalTok{, b[}\StringTok{"Name"}\NormalTok{])}

\NormalTok{conn }\OperatorTok{=}\NormalTok{ ConnectMinio()}
\NormalTok{s3 }\OperatorTok{=}\NormalTok{ conn.s3}
\NormalTok{conn.test\_connection()}

\NormalTok{bucket\_name }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_BUCKET"}\NormalTok{]}

\NormalTok{prices }\OperatorTok{=}\NormalTok{ pd.read\_csv(}
\NormalTok{    BytesIO(}
\NormalTok{        s3.get\_object(}
\NormalTok{            Bucket}\OperatorTok{=}\NormalTok{bucket\_name,}
\NormalTok{            Key}\OperatorTok{=}\StringTok{"historycal\_price/dataset\_historical\_price.csv"}
\NormalTok{        )[}\StringTok{"Body"}\NormalTok{].read()}
\NormalTok{    ),}
\NormalTok{    low\_memory}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\NormalTok{prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(prices[}\StringTok{"date"}\NormalTok{])}
\NormalTok{prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices[}\StringTok{"close\_price"}\NormalTok{] }\OperatorTok{*}\NormalTok{ prices[}\StringTok{"adj\_ratio"}\NormalTok{]}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.rename(columns}\OperatorTok{=}\NormalTok{\{}
    \StringTok{"vol\_total"}\NormalTok{: }\StringTok{"volume"}\NormalTok{,}
    \StringTok{"open\_price"}\NormalTok{: }\StringTok{"open"}\NormalTok{,}
    \StringTok{"low\_price"}\NormalTok{: }\StringTok{"low"}\NormalTok{,}
    \StringTok{"high\_price"}\NormalTok{: }\StringTok{"high"}\NormalTok{,}
    \StringTok{"close\_price"}\NormalTok{: }\StringTok{"close"}
\NormalTok{\})}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Connected. Buckets:
 - dsteam-data
 - rawbctc
\end{verbatim}

We filter to keep only the VN30 constituents:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ prices[prices[}\StringTok{"symbol"}\NormalTok{].isin(vn30\_symbols)]}
\NormalTok{prices\_daily[[}\StringTok{"date"}\NormalTok{, }\StringTok{"symbol"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{]].head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& date & symbol & adjusted\_close \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
18176 & 2010-01-04 & ACB & 329.408244 \\
18177 & 2010-01-05 & ACB & 329.408244 \\
18178 & 2010-01-06 & ACB & 320.258015 \\
\end{longtable}

\subsection{Computing Expected
Returns}\label{computing-expected-returns}

The sample mean return serves as our proxy for expected returns. For
each asset \(i\), we compute:

\[
\hat{\mu}_i = \frac{1}{T} \sum_{t=1}^{T} r_{i,t}
\]

where \(r_{i,t}\) is the return of asset \(i\) in period \(t\), and
\(T\) is the total number of periods.

\textbf{Why monthly returns?} While daily data provides more
observations, monthly returns offer several advantages for portfolio
optimization. First, monthly returns are less noisy and exhibit weaker
serial correlation. Second, monthly rebalancing is more realistic for
most investors, avoiding excessive transaction costs. Third, the
estimation error in mean returns is already substantial---using daily
data doesn't materially improve the precision of mean estimates because
the mean return scales with the horizon while estimation error scales
with the square root of observations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_monthly }\OperatorTok{=}\NormalTok{ (prices\_daily}
\NormalTok{  .assign(}
\NormalTok{    date}\OperatorTok{=}\NormalTok{prices\_daily[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{).dt.to\_timestamp()}
\NormalTok{  )}
\NormalTok{  .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{  .agg(adjusted\_close}\OperatorTok{=}\NormalTok{(}\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"last"}\NormalTok{))}
\NormalTok{  .assign(}
\NormalTok{    ret}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Volatilities}\label{computing-volatilities}

Individual asset risk in MPT is quantified using variance
(\(\sigma^2_i\)) or its square root, the standard deviation or
volatility (\(\sigma_i\)). We use the sample standard deviation as our
proxy:

\[
\hat{\sigma}_i = \sqrt{\frac{1}{T-1} \sum_{t=1}^{T} (r_{i,t} - \hat{\mu}_i)^2}
\]

Alternative risk measures exist, including Value-at-Risk, Expected
Shortfall, and higher-order moments such as skewness and kurtosis.
However, variance remains the workhorse measure in portfolio theory
because of its mathematical tractability and the central role of the
normal distribution in finance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{assets }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{  .groupby(}\StringTok{"symbol"}\NormalTok{, as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{  .agg(}
\NormalTok{    mu}\OperatorTok{=}\NormalTok{(}\StringTok{"ret"}\NormalTok{, }\StringTok{"mean"}\NormalTok{),}
\NormalTok{    sigma}\OperatorTok{=}\NormalTok{(}\StringTok{"ret"}\NormalTok{, }\StringTok{"std"}\NormalTok{)}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Visualizing the Risk-Return
Trade-off}\label{visualizing-the-risk-return-trade-off}

Figure~\ref{fig-201} displays each asset's expected return (vertical
axis) against its volatility (horizontal axis). This ``mean-standard
deviation'' space is fundamental to portfolio theory.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{assets\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    assets, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"sigma"}\NormalTok{, y}\OperatorTok{=}\StringTok{"mu"}\NormalTok{, label}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_point()}
  \OperatorTok{+}\NormalTok{ geom\_text(adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\})}
  \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{"Volatility (Standard Deviation)"}\NormalTok{, }
\NormalTok{      y}\OperatorTok{=}\StringTok{"Expected Return"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"Expected returns and volatilities of VN30 index constituents"}
\NormalTok{  )}
\NormalTok{)}
\NormalTok{assets\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{02_modern_portfolio_theory_files/figure-pdf/fig-201-output-1.pdf}}

}

\caption{\label{fig-201}Expected returns and volatilities based on
monthly returns adjusted for dividend payments and stock splits.}

\end{figure}%

Several observations emerge from this figure. First, there is
substantial heterogeneity in both expected returns and volatilities
across stocks. Second, the relationship between risk and return is far
from linear. Some high-volatility stocks have low or even negative
expected returns. Third, most individual stocks appear to offer poor
risk-return trade-offs. As we will see, portfolios can substantially
improve upon these individual positions.

\section{The Variance-Covariance Matrix: Capturing Asset
Interactions}\label{the-variance-covariance-matrix-capturing-asset-interactions}

\subsection{Why Correlations Matter}\label{why-correlations-matter}

A key innovation of MPT is recognizing that portfolio risk depends
critically on how assets move together. The \textbf{variance-covariance
matrix} \(\Sigma\) captures all pairwise interactions between asset
returns.

To understand why correlations matter, consider the variance of a
two-asset portfolio:
\[\sigma_p^2 = \omega_1^2\sigma_1^2 + \omega_2^2\sigma_2^2 + 2\omega_1\omega_2\sigma_{12}\]

The third term involves the covariance
\(\sigma_{12} = \rho_{12}\sigma_1\sigma_2\), where \(\rho_{12}\) is the
correlation coefficient. When \(\rho_{12} < 1\), the portfolio variance
is \emph{less} than the weighted average of individual variances. When
\(\rho_{12} < 0\), the diversification benefit is even more pronounced.

This mathematical fact has profound implications: \textbf{You can reduce
risk without reducing expected return} by combining assets that don't
move perfectly together. This is sometimes called the ``only free lunch
in finance.''

\subsection{Computing the Variance-Covariance
Matrix}\label{computing-the-variance-covariance-matrix}

We compute the sample covariance matrix as:
\[\hat{\sigma}_{ij} = \frac{1}{T-1} \sum_{t=1}^{T} (r_{i,t} - \hat{\mu}_i)(r_{j,t} - \hat{\mu}_j)\]

First, we reshape the returns data into a wide format with assets as
columns:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_wide }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{  .pivot(index}\OperatorTok{=}\StringTok{"date"}\NormalTok{, columns}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, values}\OperatorTok{=}\StringTok{"ret"}\NormalTok{)}
\NormalTok{  .reset\_index()}
\NormalTok{)}

\NormalTok{sigma }\OperatorTok{=}\NormalTok{ (returns\_wide}
\NormalTok{  .drop(columns}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{])}
\NormalTok{  .cov()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Interpreting the Variance-Covariance
Matrix}\label{interpreting-the-variance-covariance-matrix}

The diagonal elements of \(\Sigma\) are the variances of individual
assets. The off-diagonal elements are covariances, which can be positive
(assets tend to move together), negative (assets tend to move in
opposite directions), or zero (no linear relationship).

For easier interpretation, we often convert covariances to correlations:
\[\rho_{ij} = \frac{\sigma_{ij}}{\sigma_i \sigma_j}\]

Correlations are bounded between -1 and +1, making them easier to
compare across asset pairs.

Figure~\ref{fig-203} visualizes the variance-covariance matrix as a
heatmap.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sigma\_long }\OperatorTok{=}\NormalTok{ (sigma}
\NormalTok{  .reset\_index()}
\NormalTok{  .melt(id\_vars}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, var\_name}\OperatorTok{=}\StringTok{"symbol\_b"}\NormalTok{, value\_name}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{)}

\NormalTok{sigma\_long[}\StringTok{"symbol\_b"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{  sigma\_long[}\StringTok{"symbol\_b"}\NormalTok{], }
\NormalTok{  categories}\OperatorTok{=}\NormalTok{sigma\_long[}\StringTok{"symbol\_b"}\NormalTok{].unique()[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{],}
\NormalTok{  ordered}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{sigma\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    sigma\_long, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, y}\OperatorTok{=}\StringTok{"symbol\_b"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_tile()}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{, fill}\OperatorTok{=}\StringTok{"(Co{-})Variance"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"Sample variance{-}covariance matrix of VN30 index constituents"}
\NormalTok{    )}
  \OperatorTok{+}\NormalTok{ scale\_fill\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ theme(axis\_text\_x}\OperatorTok{=}\NormalTok{element\_text(angle}\OperatorTok{=}\DecValTok{45}\NormalTok{, hjust}\OperatorTok{=}\DecValTok{1}\NormalTok{))}
\NormalTok{)}
\NormalTok{sigma\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{02_modern_portfolio_theory_files/figure-pdf/fig-203-output-1.pdf}}

}

\caption{\label{fig-203}Variances and covariances based on monthly
returns adjusted for dividend payments and stock splits.}

\end{figure}%

The heatmap reveals important patterns. The diagonal (variances) shows
which stocks are most volatile. The off-diagonal patterns show which
pairs of stocks tend to move together. In general, stocks within the
same sector tend to have higher correlations with each other than with
stocks from different sectors.

\section{The Minimum-Variance
Portfolio}\label{the-minimum-variance-portfolio}

\subsection{Motivation: Risk Minimization as a
Benchmark}\label{motivation-risk-minimization-as-a-benchmark}

Before considering expected returns, let's find the portfolio that
minimizes risk entirely. This \textbf{minimum-variance portfolio (MVP)}
serves as an important benchmark and reference point. It represents what
an extremely risk-averse investor---one who cares only about minimizing
volatility---would choose.

\subsection{The Optimization Problem}\label{the-optimization-problem}

The minimum-variance investor solves: \[
\min_{\omega} \omega^{\prime}\Sigma\omega
\]

subject to the constraint that weights sum to one:

\[
\omega^{\prime}\iota = 1
\]

where \(\iota\) is an \(N \times 1\) vector of ones.

In words: minimize portfolio variance, subject to being fully invested.

\subsection{The Analytical Solution}\label{the-analytical-solution}

This is a classic constrained optimization problem that can be solved
using Lagrange multipliers. The Lagrangian is:

\[
\mathcal{L} = \omega^{\prime}\Sigma\omega - \lambda(\omega^{\prime}\iota - 1)
\]

Taking the first-order condition with respect to \(\omega\): \[
\frac{\partial \mathcal{L}}{\partial \omega} = 2\Sigma\omega - \lambda\iota = 0
\]

Solving for \(\omega\): \[
\omega = \frac{\lambda}{2}\Sigma^{-1}\iota
\]

Using the constraint \(\omega^{\prime}\iota = 1\) to solve for
\(\lambda\): \[
\frac{\lambda}{2}\iota^{\prime}\Sigma^{-1}\iota = 1 \implies \frac{\lambda}{2} = \frac{1}{\iota^{\prime}\Sigma^{-1}\iota}
\]

Substituting back: \[
\omega_{\text{mvp}} = \frac{\Sigma^{-1}\iota}{\iota^{\prime}\Sigma^{-1}\iota}
\]

This elegant formula shows that the minimum-variance weights depend only
on the covariance matrix---expected returns play no role. The inverse
covariance matrix \(\Sigma^{-1}\) determines how much to invest in each
asset based on its variance and its covariances with all other assets.

\subsection{Implementation}\label{implementation}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{iota }\OperatorTok{=}\NormalTok{ np.ones(sigma.shape[}\DecValTok{0}\NormalTok{])}
\NormalTok{sigma\_inv }\OperatorTok{=}\NormalTok{ np.linalg.inv(sigma.values)}
\NormalTok{omega\_mvp }\OperatorTok{=}\NormalTok{ (sigma\_inv }\OperatorTok{@}\NormalTok{ iota) }\OperatorTok{/}\NormalTok{ (iota }\OperatorTok{@}\NormalTok{ sigma\_inv }\OperatorTok{@}\NormalTok{ iota)}
\end{Highlighting}
\end{Shaded}

\subsection{Visualizing the Minimum-Variance
Weights}\label{visualizing-the-minimum-variance-weights}

Figure~\ref{fig-204} displays the portfolio weights of the
minimum-variance portfolio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{assets }\OperatorTok{=}\NormalTok{ assets.assign(omega\_mvp}\OperatorTok{=}\NormalTok{omega\_mvp)}

\NormalTok{assets[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{  assets[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{  categories}\OperatorTok{=}\NormalTok{assets.sort\_values(}\StringTok{"omega\_mvp"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{  ordered}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{omega\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    assets,}
\NormalTok{    aes(y}\OperatorTok{=}\StringTok{"omega\_mvp"}\NormalTok{, x}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"omega\_mvp\textgreater{}0"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_col()}
  \OperatorTok{+}\NormalTok{ coord\_flip()}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{""}\NormalTok{, }
\NormalTok{      y}\OperatorTok{=}\StringTok{"Portfolio Weight"}\NormalTok{, }
\NormalTok{      title}\OperatorTok{=}\StringTok{"Minimum{-}variance portfolio weights"}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}
\NormalTok{omega\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{02_modern_portfolio_theory_files/figure-pdf/fig-204-output-1.pdf}}

}

\caption{\label{fig-204}Weights are based on historical moments of
monthly returns adjusted for dividend payments and stock splits.}

\end{figure}%

Several features of the minimum-variance portfolio are noteworthy.
First, many stocks receive zero or near-zero weights. Second, some
stocks receive negative weights (short positions). These short positions
are not a computational artifact, they reflect the optimizer's attempt
to exploit correlations for risk reduction. Third, the weights are quite
extreme (both large positive and large negative), which often indicates
estimation error amplification, which is a topic we address in later
chapters.

\subsection{Portfolio Performance}\label{portfolio-performance}

Let's compute the expected return and volatility of the minimum-variance
portfolio:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu }\OperatorTok{=}\NormalTok{ assets[}\StringTok{"mu"}\NormalTok{].values}
\NormalTok{mu\_mvp }\OperatorTok{=}\NormalTok{ omega\_mvp }\OperatorTok{@}\NormalTok{ mu}
\NormalTok{sigma\_mvp }\OperatorTok{=}\NormalTok{ np.sqrt(omega\_mvp }\OperatorTok{@}\NormalTok{ sigma.values }\OperatorTok{@}\NormalTok{ omega\_mvp)}

\NormalTok{summary\_mvp }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
  \StringTok{"mu"}\NormalTok{: [mu\_mvp],}
  \StringTok{"sigma"}\NormalTok{: [sigma\_mvp],}
  \StringTok{"type"}\NormalTok{: [}\StringTok{"Minimum{-}Variance Portfolio"}\NormalTok{]}
\NormalTok{\})}
\NormalTok{summary\_mvp}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& mu & sigma & type \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & -0.011424 & 0.043512 & Minimum-Variance Portfolio \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu\_mvp\_fmt }\OperatorTok{=} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{mu\_mvp}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}
\NormalTok{sigma\_mvp\_fmt }\OperatorTok{=} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{sigma\_mvp}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"The MVP return is }\SpecialCharTok{\{}\NormalTok{mu\_mvp\_fmt}\SpecialCharTok{\}}\SpecialStringTok{ and volatility is }\SpecialCharTok{\{}\NormalTok{sigma\_mvp\_fmt}\SpecialCharTok{\}}\SpecialStringTok{."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
The MVP return is -0.0114 and volatility is 0.0435.
\end{verbatim}

If the expected return is negative, this is not a computational error.
The minimum-variance portfolio minimizes risk without regard to expected
returns. Because some assets in the sample have negative average
returns, the risk-minimizing combination may inherit a negative expected
return. This highlights a fundamental limitation of using historical
sample means as estimates of expected returns: they are extremely noisy,
and can lead to economically unintuitive results even when the
optimization mathematics are working correctly.

\section{Efficient Portfolios: Balancing Risk and
Return}\label{efficient-portfolios-balancing-risk-and-return}

\subsection{The Investor's Trade-off}\label{the-investors-trade-off}

In most cases, minimizing variance is not the investor's sole objective.
A more realistic formulation allows the investor to trade off risk
against expected return. The investor might be willing to accept higher
portfolio variance in exchange for higher expected returns.

An \textbf{efficient portfolio} minimizes variance subject to earning at
least some target expected return \(\bar{\mu}\). Formally:

\[\min_{\omega} \omega^{\prime}\Sigma\omega\]

subject to: \[\omega^{\prime}\iota = 1 \quad \text{(fully invested)}\]
\[\omega^{\prime}\mu \geq \bar{\mu} \quad \text{(minimum return)}\]

When \(\bar{\mu}\) exceeds the expected return of the minimum-variance
portfolio, the investor accepts more risk to earn more return.

\subsection{Setting the Target Return}\label{setting-the-target-return}

For illustration, suppose the investor wants to earn at least the
historical average return of the best-performing stock:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu\_bar }\OperatorTok{=}\NormalTok{ assets[}\StringTok{"mu"}\NormalTok{].}\BuiltInTok{max}\NormalTok{()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Target expected return: }\SpecialCharTok{\{}\NormalTok{mu\_bar}\SpecialCharTok{:.5f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Target expected return: 0.01886
\end{verbatim}

This is an ambitious target---it means matching the return of the single
highest-returning stock while benefiting from diversification to reduce
risk.

\subsection{The Analytical Solution}\label{the-analytical-solution-1}

The constrained optimization problem with an inequality constraint on
expected returns can be solved using the Karush-Kuhn-Tucker (KKT)
conditions. At the optimum (assuming the return constraint binds), the
solution is:

\[\omega_{\text{efp}} = \frac{\lambda^*}{2}\left(\Sigma^{-1}\mu - \frac{D}{C}\Sigma^{-1}\iota\right)\]

where:

\begin{itemize}
\tightlist
\item
  \(C = \iota^{\prime}\Sigma^{-1}\iota\) (a scalar measuring the
  ``size'' of the inverse covariance matrix)
\item
  \(D = \iota^{\prime}\Sigma^{-1}\mu\) (capturing the interaction
  between expected returns and the inverse covariance matrix)
\item
  \(E = \mu^{\prime}\Sigma^{-1}\mu\) (measuring the ``signal'' in
  expected returns weighted by inverse covariances)
\item
  \(\lambda^* = 2\frac{\bar{\mu} - D/C}{E - D^2/C}\) (the shadow price
  of the return constraint)
\end{itemize}

Alternatively, we can express the efficient portfolio as a linear
combination of the minimum-variance portfolio and an ``excess return''
portfolio:

\[\omega_{\text{efp}} = \omega_{\text{mvp}} + \frac{\lambda^*}{2}\left(\Sigma^{-1}\mu - D \cdot \omega_{\text{mvp}}\right)\]

This representation reveals important intuition: the efficient portfolio
starts from the minimum-variance portfolio and tilts toward
higher-expected-return assets, with the tilt magnitude determined by
\(\lambda^*\).

\subsection{Implementation}\label{implementation-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{C }\OperatorTok{=}\NormalTok{ iota }\OperatorTok{@}\NormalTok{ sigma\_inv }\OperatorTok{@}\NormalTok{ iota}
\NormalTok{D }\OperatorTok{=}\NormalTok{ iota }\OperatorTok{@}\NormalTok{ sigma\_inv }\OperatorTok{@}\NormalTok{ mu}
\NormalTok{E }\OperatorTok{=}\NormalTok{ mu }\OperatorTok{@}\NormalTok{ sigma\_inv }\OperatorTok{@}\NormalTok{ mu}
\NormalTok{lambda\_tilde }\OperatorTok{=} \DecValTok{2} \OperatorTok{*}\NormalTok{ (mu\_bar }\OperatorTok{{-}}\NormalTok{ D }\OperatorTok{/}\NormalTok{ C) }\OperatorTok{/}\NormalTok{ (E }\OperatorTok{{-}}\NormalTok{ (D }\OperatorTok{**} \DecValTok{2}\NormalTok{) }\OperatorTok{/}\NormalTok{ C)}
\NormalTok{omega\_efp }\OperatorTok{=}\NormalTok{ omega\_mvp }\OperatorTok{+}\NormalTok{ (lambda\_tilde }\OperatorTok{/} \DecValTok{2}\NormalTok{) }\OperatorTok{*}\NormalTok{ (sigma\_inv }\OperatorTok{@}\NormalTok{ mu }\OperatorTok{{-}}\NormalTok{ D }\OperatorTok{*}\NormalTok{ omega\_mvp)}

\NormalTok{mu\_efp }\OperatorTok{=}\NormalTok{ omega\_efp }\OperatorTok{@}\NormalTok{ mu}
\NormalTok{sigma\_efp }\OperatorTok{=}\NormalTok{ np.sqrt(omega\_efp }\OperatorTok{@}\NormalTok{ sigma.values }\OperatorTok{@}\NormalTok{ omega\_efp)}

\NormalTok{summary\_efp }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
  \StringTok{"mu"}\NormalTok{: [mu\_efp],}
  \StringTok{"sigma"}\NormalTok{: [sigma\_efp],}
  \StringTok{"type"}\NormalTok{: [}\StringTok{"Efficient Portfolio"}\NormalTok{]}
\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\subsection{Comparing the Portfolios}\label{comparing-the-portfolios}

Figure~\ref{fig-205} plots both portfolios alongside the individual
assets.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summaries }\OperatorTok{=}\NormalTok{ pd.concat(}
\NormalTok{  [assets, summary\_mvp, summary\_efp], ignore\_index}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{summaries\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    summaries, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"sigma"}\NormalTok{, y}\OperatorTok{=}\StringTok{"mu"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{summaries.query(}\StringTok{"type.isna()"}\NormalTok{))}
  \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{summaries.query(}\StringTok{"type.notna()"}\NormalTok{), color}\OperatorTok{=}\StringTok{"\#F21A00"}\NormalTok{, size}\OperatorTok{=}\DecValTok{3}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ geom\_label(aes(label}\OperatorTok{=}\StringTok{"type"}\NormalTok{), adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\})}
  \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{"Volatility (Standard Deviation)"}\NormalTok{, }
\NormalTok{      y}\OperatorTok{=}\StringTok{"Expected Return"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"Efficient \& minimum{-}variance portfolios"}
\NormalTok{    ) }
\NormalTok{)}
\NormalTok{summaries\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{02_modern_portfolio_theory_files/figure-pdf/fig-205-output-1.pdf}}

}

\caption{\label{fig-205}The big dots indicate the location of the
minimum-variance and the efficient portfolio that delivers the expected
return of the stock with the highest return, respectively. The small
dots indicate the location of the individual constituents.}

\end{figure}%

The figure demonstrates the substantial diversification benefits of
portfolio optimization. The efficient portfolio achieves the same
expected return as the highest-returning individual stock but with
substantially lower volatility. This ``free lunch'' from diversification
is the central insight of Modern Portfolio Theory.

\subsection{The Role of Risk Aversion}\label{the-role-of-risk-aversion}

The target return \(\bar{\mu}\) implicitly reflects the investor's risk
aversion. Less risk-averse investors choose higher \(\bar{\mu}\),
accepting more variance to earn more expected return. More risk-averse
investors choose \(\bar{\mu}\) closer to the minimum-variance
portfolio's expected return.

Equivalently, the mean-variance framework can be derived from the
optimal decisions of an investor with a mean-variance utility function:
\[U(\omega) = \omega^{\prime}\mu - \frac{\gamma}{2}\omega^{\prime}\Sigma\omega\]

where \(\gamma\) is the coefficient of relative risk aversion. The
Appendix shows there is a one-to-one mapping between \(\gamma\) and
\(\bar{\mu}\), so both formulations yield identical efficient
portfolios.

\section{The Efficient Frontier: The Menu of Optimal
Portfolios}\label{the-efficient-frontier-the-menu-of-optimal-portfolios}

The \textbf{efficient frontier} is the set of all portfolios for which
no other portfolio offers higher expected return at the same or lower
variance. Geometrically, it traces the upper boundary of achievable
(volatility, expected return) combinations.

Every rational mean-variance investor should hold a portfolio on the
efficient frontier. Portfolios below the frontier are ``dominated,''
there exists another portfolio with either higher return for the same
risk, or lower risk for the same return.

\subsection{The Mutual Fund Separation
Theorem}\label{the-mutual-fund-separation-theorem}

A remarkable result simplifies the construction of the efficient
frontier. The \textbf{mutual fund separation theorem} (sometimes called
the two-fund theorem) states that any efficient portfolio can be
expressed as a linear combination of any two distinct efficient
portfolios.

Formally, if \(\omega_{\mu_1}\) and \(\omega_{\mu_2}\) are efficient
portfolios earning expected returns \(\mu_1\) and \(\mu_2\)
respectively, then the portfolio:
\[\omega_{a\mu_1 + (1-a)\mu_2} = a \cdot \omega_{\mu_1} + (1-a) \cdot \omega_{\mu_2}\]

is also efficient and earns expected return \(a\mu_1 + (1-a)\mu_2\).

This result has profound practical implications: an investor needs
access to only two efficient ``mutual funds'' to construct any portfolio
on the efficient frontier. The specific funds don't matter---any two
distinct efficient portfolios span the entire frontier.

\subsection{Proof of the Separation
Theorem}\label{proof-of-the-separation-theorem}

The proof follows directly from the analytical solution for efficient
portfolios. Consider:

\[
a \cdot \omega_{\mu_1} + (1-a) \cdot \omega_{\mu_2} = \left(\frac{a\mu_1 + (1-a)\mu_2 - D/C}{E - D^2/C}\right)\left(\Sigma^{-1}\mu - \frac{D}{C}\Sigma^{-1}\iota\right)
\]

This expression has exactly the form of the efficient portfolio earning
expected return \(a\mu_1 + (1-a)\mu_2\), proving the theorem.

\subsection{Computing the Efficient
Frontier}\label{computing-the-efficient-frontier}

Using the minimum-variance portfolio and our efficient portfolio as the
two ``funds,'' we can trace out the entire efficient frontier:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{efficient\_frontier }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  pd.DataFrame(\{}
    \StringTok{"a"}\NormalTok{: np.arange(}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\FloatTok{2.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{  \})}
\NormalTok{  .assign(}
\NormalTok{    omega}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"a"}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ a: a }\OperatorTok{*}\NormalTok{ omega\_efp }\OperatorTok{+}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}}\NormalTok{ a) }\OperatorTok{*}\NormalTok{ omega\_mvp)}
\NormalTok{  )}
\NormalTok{  .assign(}
\NormalTok{    mu}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"omega"}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ w: w }\OperatorTok{@}\NormalTok{ mu),}
\NormalTok{    sigma}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"omega"}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ w: np.sqrt(w }\OperatorTok{@}\NormalTok{ sigma }\OperatorTok{@}\NormalTok{ w))}
\NormalTok{  )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Note that we allow \(a\) to range from -1 to 2, which means some
portfolios involve shorting one of the two basis funds and leveraging
into the other. This traces out both the upper and lower portions of the
frontier hyperbola.

\subsection{Visualizing the Efficient
Frontier}\label{visualizing-the-efficient-frontier}

Figure~\ref{fig-206} displays the efficient frontier alongside
individual assets and the benchmark portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{summaries }\OperatorTok{=}\NormalTok{ pd.concat(}
\NormalTok{  [summaries, efficient\_frontier], ignore\_index}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{summaries\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    summaries, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"sigma"}\NormalTok{, y}\OperatorTok{=}\StringTok{"mu"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{summaries.query(}\StringTok{"type.isna()"}\NormalTok{))}
  \OperatorTok{+}\NormalTok{ geom\_line(data}\OperatorTok{=}\NormalTok{efficient\_frontier, color}\OperatorTok{=}\StringTok{"blue"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{summaries.query(}\StringTok{"type.notna()"}\NormalTok{), color}\OperatorTok{=}\StringTok{"\#F21A00"}\NormalTok{, size}\OperatorTok{=}\DecValTok{3}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ geom\_label(aes(label}\OperatorTok{=}\StringTok{"type"}\NormalTok{), adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\})}
  \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{"Volatility (Standard Deviation)"}\NormalTok{, }
\NormalTok{      y}\OperatorTok{=}\StringTok{"Expected Return"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"The Efficient Frontier and VN30 Constituents"}
\NormalTok{    ) }
\NormalTok{)}
\NormalTok{summaries\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{02_modern_portfolio_theory_files/figure-pdf/fig-206-output-1.pdf}}

}

\caption{\label{fig-206}The big dots indicate the location of the
minimum-variance and the efficient portfolio. The small dots indicate
the location of the individual constituents.}

\end{figure}%

The efficient frontier has a characteristic hyperbolic shape. The
leftmost point is the minimum-variance portfolio. Moving up and to the
right along the frontier, expected return increases but so does
volatility. The upper portion of the hyperbola (above the
minimum-variance portfolio) is the ``efficient'' part---these portfolios
offer the highest return for each level of risk. The lower portion is
``inefficient''---these portfolios are dominated by their mirror images
on the upper portion.

The figure also reveals how dramatically diversification improves upon
individual stock positions. Nearly all individual stocks lie well inside
the efficient frontier, meaning investors can achieve the same expected
return with much less risk, or much higher expected return with the same
risk, simply by diversifying.

\section{Key Takeaways}\label{key-takeaways}

This chapter introduced the concepts of Modern Portfolio Theory. The
main insights are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Portfolio risk depends on correlations}: The variance of a
  portfolio is not simply the weighted average of individual variances.
  Covariances between assets play a crucial role, creating opportunities
  for diversification.
\item
  \textbf{Diversification is the ``only free lunch'' in finance}: By
  combining assets that don't move perfectly together, investors can
  reduce risk without sacrificing expected return. This insight is the
  cornerstone of modern investment practice.
\item
  \textbf{The minimum-variance portfolio minimizes risk}: This portfolio
  depends only on the covariance matrix and serves as an important
  benchmark. It represents the least risky way to be fully invested in
  risky assets.
\item
  \textbf{Efficient portfolios balance risk and return}: By accepting
  more variance, investors can earn higher expected returns. Efficient
  portfolios are those that offer the best possible trade-off.
\item
  \textbf{The efficient frontier characterizes optimal portfolios}: This
  boundary in mean-standard deviation space represents the menu of
  optimal choices available to mean-variance investors.
\item
  \textbf{Two-fund separation simplifies implementation}: Any efficient
  portfolio can be constructed from any two distinct efficient
  portfolios, reducing the computational burden of portfolio
  optimization.
\end{enumerate}

Looking ahead, several important complications arise in practice. First,
the inputs to portfolio optimization (expected returns and covariances)
must be estimated from data, and estimation error can dramatically
affect portfolio performance. Second, real-world constraints such as
transaction costs, short-sale restrictions, and position limits modify
the optimization problem. Third, the assumption that investors care only
about mean and variance may be too restrictive when returns are
non-normal or when investors have more complex preferences. We address
these extensions in subsequent chapters.

\bookmarksetup{startatroot}

\chapter{The Capital Asset Pricing
Model}\label{the-capital-asset-pricing-model}

\section{From Efficient Portfolios to Equilibrium
Prices}\label{from-efficient-portfolios-to-equilibrium-prices}

The previous chapter on \hyperref[modern-portfolio-theory]{Modern
Portfolio Theory} (MPT) showed how an investor can construct portfolios
that optimally trade off risk and expected return. But MPT leaves a
crucial question unanswered: What determines the \emph{expected returns}
themselves? Why do some assets command higher risk premiums than others?

The Capital Asset Pricing Model (CAPM) answers this question. Developed
simultaneously by Sharpe (1964), Lintner (1965), and Mossin (1966), the
CAPM extends MPT to explain how assets should be priced in equilibrium
when \emph{all} investors follow mean-variance optimization principles.
The CAPM's central insight is both elegant and counterintuitive:
\textbf{not all risk is rewarded}. Only the component of risk that
cannot be diversified away (i.e., systematic risk) commands a risk
premium in equilibrium.

The CAPM remains the cornerstone of asset pricing theory, not because it
perfectly describes reality, but because it provides the simplest
coherent framework for understanding the relationship between risk and
expected return. Every extension and alternative model in asset pricing
(e.g., from the Fama-French factors to consumption-based pricing) builds
upon or reacts against the CAPM's foundational logic.

In this chapter, we derive the CAPM from first principles, illustrate
its theoretical underpinnings, and show how to estimate its parameters
empirically. We download stock market data, estimate betas using
regression analysis, and evaluate asset performance relative to model
predictions.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ tidyfinance }\ImportTok{as}\NormalTok{ tf}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format}
\ImportTok{from}\NormalTok{ adjustText }\ImportTok{import}\NormalTok{ adjust\_text}
\end{Highlighting}
\end{Shaded}

\section{Systematic versus Idiosyncratic
Risk}\label{systematic-versus-idiosyncratic-risk}

Before diving into the mathematics, we need to understand the
fundamental distinction that makes the CAPM work: the difference between
\emph{systematic} and \emph{idiosyncratic} risk.

\subsection{Idiosyncratic Risk: Diversifiable and
Unrewarded}\label{idiosyncratic-risk-diversifiable-and-unrewarded}

Consider events that affect individual companies but not the broader
market: a CEO resigns unexpectedly, a product launch fails, earnings
disappoint analysts, or a factory experiences a fire. These
company-specific events can dramatically affect individual stock prices,
but they tend to average out across a diversified portfolio. When one
company has bad news, another often has good news; the shocks are
largely uncorrelated.

This idiosyncratic (or firm-specific) risk can be eliminated through
diversification. By holding a portfolio of many stocks, an investor can
reduce idiosyncratic risk to nearly zero. Since this risk can be avoided
at no cost, investors should not expect compensation for bearing it. In
equilibrium, idiosyncratic risk earns no premium.

\subsection{Systematic Risk: Undiversifiable and
Priced}\label{systematic-risk-undiversifiable-and-priced}

Systematic risk, by contrast, affects all assets simultaneously.
Recessions, interest rate changes, geopolitical crises, and pandemics
impact virtually every company to some degree. No amount of
diversification can eliminate exposure to these economy-wide shocks,
they are inherent to participating in the market.

Since systematic risk cannot be diversified away, investors genuinely
dislike it. They must be compensated for bearing it. The CAPM formalizes
this intuition: expected returns should depend only on systematic risk,
not total risk. Two assets with identical total volatility can have very
different expected returns if their systematic risk exposures differ.

\subsection{A Simple Illustration}\label{a-simple-illustration}

Imagine two stocks with identical 30\% annual volatility. Stock A is a
gold mining company whose returns move opposite to the overall market:
it does well when the economy struggles and poorly when it booms. Stock
B is a luxury retailer that amplifies market movements: soaring in good
times and crashing in bad times.

Which stock should offer higher expected returns? Intuition might
suggest they should be equal since both have the same volatility. But
the CAPM says Stock B should offer substantially higher returns. Why?
Because Stock B performs poorly precisely when investors' overall wealth
is already down (during market crashes), making its returns particularly
painful. Stock A, by contrast, provides insurance. Its strong
performance during market downturns partially offsets losses elsewhere
in the portfolio. Investors value this insurance property and are
willing to accept lower expected returns in exchange.

This is the CAPM's core insight: expected returns compensate investors
for systematic risk exposure, measured by how an asset's returns co-move
with the market portfolio.

\section{Data Preparation}\label{data-preparation}

Building on our analysis from the previous chapter, we examine the VN30
constituents as our asset universe. We download and prepare monthly
return data:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vn30\_symbols }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"ACB"}\NormalTok{, }\StringTok{"BCM"}\NormalTok{, }\StringTok{"BID"}\NormalTok{, }\StringTok{"BVH"}\NormalTok{, }\StringTok{"CTG"}\NormalTok{, }\StringTok{"FPT"}\NormalTok{, }\StringTok{"GAS"}\NormalTok{, }\StringTok{"GVR"}\NormalTok{, }\StringTok{"HDB"}\NormalTok{, }\StringTok{"HPG"}\NormalTok{,}
    \StringTok{"MBB"}\NormalTok{, }\StringTok{"MSN"}\NormalTok{, }\StringTok{"MWG"}\NormalTok{, }\StringTok{"PLX"}\NormalTok{, }\StringTok{"POW"}\NormalTok{, }\StringTok{"SAB"}\NormalTok{, }\StringTok{"SHB"}\NormalTok{, }\StringTok{"SSB"}\NormalTok{, }\StringTok{"STB"}\NormalTok{, }\StringTok{"TCB"}\NormalTok{,}
    \StringTok{"TPB"}\NormalTok{, }\StringTok{"VCB"}\NormalTok{, }\StringTok{"VHM"}\NormalTok{, }\StringTok{"VIB"}\NormalTok{, }\StringTok{"VIC"}\NormalTok{, }\StringTok{"VJC"}\NormalTok{, }\StringTok{"VNM"}\NormalTok{, }\StringTok{"VPB"}\NormalTok{, }\StringTok{"VRE"}\NormalTok{, }\StringTok{"EIB"}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ boto3}
\ImportTok{from}\NormalTok{ botocore.client }\ImportTok{import}\NormalTok{ Config}
\ImportTok{from}\NormalTok{ io }\ImportTok{import}\NormalTok{ BytesIO}

\KeywordTok{class}\NormalTok{ ConnectMinio:}
    \KeywordTok{def} \FunctionTok{\_\_init\_\_}\NormalTok{(}\VariableTok{self}\NormalTok{):}
        \VariableTok{self}\NormalTok{.MINIO\_ENDPOINT }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ENDPOINT"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ACCESS\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_SECRET\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.REGION }\OperatorTok{=}\NormalTok{ os.getenv(}\StringTok{"MINIO\_REGION"}\NormalTok{, }\StringTok{"us{-}east{-}1"}\NormalTok{)}

        \VariableTok{self}\NormalTok{.s3 }\OperatorTok{=}\NormalTok{ boto3.client(}
            \StringTok{"s3"}\NormalTok{,}
\NormalTok{            endpoint\_url}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ENDPOINT,}
\NormalTok{            aws\_access\_key\_id}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY,}
\NormalTok{            aws\_secret\_access\_key}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY,}
\NormalTok{            region\_name}\OperatorTok{=}\VariableTok{self}\NormalTok{.REGION,}
\NormalTok{            config}\OperatorTok{=}\NormalTok{Config(signature\_version}\OperatorTok{=}\StringTok{"s3v4"}\NormalTok{),}
\NormalTok{        )}

    \KeywordTok{def}\NormalTok{ test\_connection(}\VariableTok{self}\NormalTok{):}
\NormalTok{        resp }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.list\_buckets()}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"Connected. Buckets:"}\NormalTok{)}
        \ControlFlowTok{for}\NormalTok{ b }\KeywordTok{in}\NormalTok{ resp.get(}\StringTok{"Buckets"}\NormalTok{, []):}
            \BuiltInTok{print}\NormalTok{(}\StringTok{" {-}"}\NormalTok{, b[}\StringTok{"Name"}\NormalTok{])}


\NormalTok{conn }\OperatorTok{=}\NormalTok{ ConnectMinio()}
\NormalTok{s3 }\OperatorTok{=}\NormalTok{ conn.s3}
\NormalTok{conn.test\_connection()}

\NormalTok{bucket\_name }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_BUCKET"}\NormalTok{]}

\NormalTok{prices }\OperatorTok{=}\NormalTok{ pd.read\_csv(}
\NormalTok{    BytesIO(}
\NormalTok{        s3.get\_object(}
\NormalTok{            Bucket}\OperatorTok{=}\NormalTok{bucket\_name,}
\NormalTok{            Key}\OperatorTok{=}\StringTok{"historycal\_price/dataset\_historical\_price.csv"}
\NormalTok{        )[}\StringTok{"Body"}\NormalTok{].read()}
\NormalTok{    ),}
\NormalTok{    low\_memory}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Connected. Buckets:
 - dsteam-data
 - rawbctc
\end{verbatim}

We process the raw price data to compute adjusted closing prices and
standardize column names:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(prices[}\StringTok{"date"}\NormalTok{])}
\NormalTok{prices[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices[}\StringTok{"close\_price"}\NormalTok{] }\OperatorTok{*}\NormalTok{ prices[}\StringTok{"adj\_ratio"}\NormalTok{]}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.rename(columns}\OperatorTok{=}\NormalTok{\{}
    \StringTok{"vol\_total"}\NormalTok{: }\StringTok{"volume"}\NormalTok{,}
    \StringTok{"open\_price"}\NormalTok{: }\StringTok{"open"}\NormalTok{,}
    \StringTok{"low\_price"}\NormalTok{: }\StringTok{"low"}\NormalTok{,}
    \StringTok{"high\_price"}\NormalTok{: }\StringTok{"high"}\NormalTok{,}
    \StringTok{"close\_price"}\NormalTok{: }\StringTok{"close"}
\NormalTok{\})}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ prices.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ prices[prices[}\StringTok{"symbol"}\NormalTok{].isin(vn30\_symbols)]}
\NormalTok{prices\_daily[[}\StringTok{"date"}\NormalTok{, }\StringTok{"symbol"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{]].head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& date & symbol & adjusted\_close \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
18176 & 2010-01-04 & ACB & 329.408244 \\
18177 & 2010-01-05 & ACB & 329.408244 \\
18178 & 2010-01-06 & ACB & 320.258015 \\
\end{longtable}

\subsection{Computing Monthly Returns}\label{computing-monthly-returns}

We aggregate daily prices to monthly frequency. Using monthly returns
rather than daily returns offers several advantages for portfolio
analysis: monthly returns exhibit less noise, better approximate
normality, and reduce the impact of microstructure effects like bid-ask
bounce.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_monthly }\OperatorTok{=}\NormalTok{ (prices\_daily}
\NormalTok{    .assign(}
\NormalTok{        date}\OperatorTok{=}\NormalTok{prices\_daily[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{).dt.to\_timestamp(}\StringTok{"M"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    .agg(adjusted\_close}\OperatorTok{=}\NormalTok{(}\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"last"}\NormalTok{))}
\NormalTok{    .sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{    .assign(}
\NormalTok{        ret}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{returns\_monthly.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& symbol & date & adjusted\_close & ret \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & ACB & 2010-01-31 & 291.975489 & NaN \\
1 & ACB & 2010-02-28 & 303.621235 & 0.039886 \\
2 & ACB & 2010-03-31 & 273.784658 & -0.098269 \\
\end{longtable}

\section{The Risk-Free Asset and the Investment Opportunity
Set}\label{the-risk-free-asset-and-the-investment-opportunity-set}

\subsection{Adding a Risk-Free Asset}\label{adding-a-risk-free-asset}

The previous chapter on MPT considered portfolios composed entirely of
risky assets, requiring that portfolio weights sum to one. The CAPM
introduces a crucial new element: a \textbf{risk-free asset} that pays a
constant interest rate \(r_f\) with zero volatility.

This seemingly simple addition fundamentally transforms the investment
opportunity set. With a risk-free asset available, investors can choose
to park some wealth in the safe asset and invest the remainder in risky
assets. They can also borrow at the risk-free rate to leverage their
risky positions.

Let \(\omega \in \mathbb{R}^N\) denote the portfolio weights in the
\(N\) risky assets. Unlike before, these weights need not sum to one.
The remainder, \(1 - \iota'\omega\) (where \(\iota\) is a vector of
ones), is invested in the risk-free asset.

\subsection{Portfolio Return with a Risk-Free
Asset}\label{portfolio-return-with-a-risk-free-asset}

The expected return on this combined portfolio is:

\[
\mu_\omega = \omega'\mu + (1 - \iota'\omega)r_f = r_f + \omega'(\mu - r_f) = r_f + \omega'\tilde{\mu}
\]

where \(\mu\) is the vector of expected returns on risky assets and
\(\tilde{\mu} = \mu - r_f\) denotes the vector of \textbf{excess
returns} (returns above the risk-free rate).

This expression reveals an important decomposition: the portfolio's
expected return equals the risk-free rate plus a risk premium determined
by the exposure to risky assets.

\subsection{Portfolio Variance}\label{portfolio-variance}

Since the risk-free asset has zero volatility and zero covariance with
risky assets, only the risky portion contributes to portfolio variance:

\[
\sigma_\omega^2 = \omega'\Sigma\omega
\]

where \(\Sigma\) is the variance-covariance matrix of risky asset
returns. The portfolio's volatility (standard deviation) is:

\[
\sigma_\omega = \sqrt{\omega'\Sigma\omega}
\]

\subsection{Setting Up the Risk-Free
Rate}\label{setting-up-the-risk-free-rate}

For a realistic proxy of the risk-free rate, we use the Vietnam
government bond yield. Government bonds of stable economies are
considered ``risk-free'' because the government can always print money
to meet its obligations (though this may cause inflation).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{all\_dates }\OperatorTok{=}\NormalTok{ pd.date\_range(}
\NormalTok{    start}\OperatorTok{=}\NormalTok{returns\_monthly[}\StringTok{"date"}\NormalTok{].}\BuiltInTok{min}\NormalTok{(), }
\NormalTok{    end}\OperatorTok{=}\NormalTok{returns\_monthly[}\StringTok{"date"}\NormalTok{].}\BuiltInTok{max}\NormalTok{(), }
\NormalTok{    freq}\OperatorTok{=}\StringTok{"ME"}
\NormalTok{)}

\CommentTok{\# Vietnam 10{-}Year Government Bond Yield (approximately 2.52\% annualized)}
\NormalTok{rf\_annual }\OperatorTok{=} \FloatTok{0.0252}
\NormalTok{rf\_monthly\_val }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rf\_annual)}\OperatorTok{**}\NormalTok{(}\DecValTok{1}\OperatorTok{/}\DecValTok{12}\NormalTok{) }\OperatorTok{{-}} \DecValTok{1}

\NormalTok{risk\_free\_monthly }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{"date"}\NormalTok{: all\_dates,}
    \StringTok{"risk\_free"}\NormalTok{: rf\_monthly\_val}
\NormalTok{\})}

\NormalTok{risk\_free\_monthly[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.to\_datetime(risk\_free\_monthly[}\StringTok{"date"}\NormalTok{])}
\NormalTok{    .dt.to\_period(}\StringTok{"M"}\NormalTok{)}
\NormalTok{    .dt.to\_timestamp(}\StringTok{"M"}\NormalTok{)}
\NormalTok{)}

\NormalTok{risk\_free\_monthly.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& date & risk\_free \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2010-01-31 & 0.002076 \\
1 & 2010-02-28 & 0.002076 \\
2 & 2010-03-31 & 0.002076 \\
\end{longtable}

We merge the risk-free rate with our returns data and compute excess
returns:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_monthly }\OperatorTok{=}\NormalTok{ returns\_monthly.merge(}
\NormalTok{    risk\_free\_monthly[[}\StringTok{"date"}\NormalTok{, }\StringTok{"risk\_free"}\NormalTok{]], }
\NormalTok{    on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, }
\NormalTok{    how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{)}

\NormalTok{rf }\OperatorTok{=}\NormalTok{ risk\_free\_monthly[}\StringTok{"risk\_free"}\NormalTok{].mean()}

\NormalTok{returns\_monthly }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{    .assign(}
\NormalTok{        ret\_excess}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .assign(}
\NormalTok{        ret\_excess}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ret\_excess"}\NormalTok{].clip(lower}\OperatorTok{={-}}\DecValTok{1}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{returns\_monthly.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& symbol & date & adjusted\_close & ret & risk\_free & ret\_excess \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & ACB & 2010-01-31 & 291.975489 & NaN & 0.002076 & NaN \\
1 & ACB & 2010-02-28 & 303.621235 & 0.039886 & 0.002076 & 0.037810 \\
2 & ACB & 2010-03-31 & 273.784658 & -0.098269 & 0.002076 & -0.100345 \\
\end{longtable}

\section{The Tangency Portfolio: Where Everyone
Invests}\label{the-tangency-portfolio-where-everyone-invests}

\subsection{Deriving the Optimal Risky
Portfolio}\label{deriving-the-optimal-risky-portfolio}

With a risk-free asset available, how should an investor allocate wealth
across risky assets? Consider an investor who wants to achieve a target
expected excess return \(\bar{\mu}\) with minimum variance. The
optimization problem becomes:

\[
\min_\omega \omega'\Sigma\omega \quad \text{subject to} \quad \omega'\tilde{\mu} = \bar{\mu}
\]

Using the Lagrangian method:

\[
\mathcal{L}(\omega, \lambda) = \omega'\Sigma\omega - \lambda(\omega'\tilde{\mu} - \bar{\mu})
\]

The first-order condition with respect to \(\omega\) is:

\[
\frac{\partial \mathcal{L}}{\partial \omega} = 2\Sigma\omega - \lambda\tilde{\mu} = 0
\]

Solving for the optimal weights:

\[
\omega^* = \frac{\lambda}{2}\Sigma^{-1}\tilde{\mu}
\]

The constraint \(\omega'\tilde{\mu} = \bar{\mu}\) determines
\(\lambda\):

\[
\bar{\mu} = \tilde{\mu}'\omega^* = \frac{\lambda}{2}\tilde{\mu}'\Sigma^{-1}\tilde{\mu} \implies \lambda = \frac{2\bar{\mu}}{\tilde{\mu}'\Sigma^{-1}\tilde{\mu}}
\]

Substituting back:

\[
\omega^* = \frac{\bar{\mu}}{\tilde{\mu}'\Sigma^{-1}\tilde{\mu}}\Sigma^{-1}\tilde{\mu}
\]

\subsection{The Tangency Portfolio}\label{the-tangency-portfolio}

Notice something remarkable: the \emph{direction} of \(\omega^*\) is
always \(\Sigma^{-1}\tilde{\mu}\), regardless of the target return
\(\bar{\mu}\). Only the \emph{scale} changes. This means all investors,
regardless of their risk preferences, hold the \emph{same portfolio of
risky assets}. They differ only in how much they allocate to this
portfolio versus the risk-free asset.

To obtain the portfolio of risky assets that is fully invested (weights
summing to one), we normalize:

\[
\omega_{\text{tan}} = \frac{\omega^*}{\iota'\omega^*} = \frac{\Sigma^{-1}(\mu - r_f)}{\iota'\Sigma^{-1}(\mu - r_f)}
\]

This is called the \textbf{tangency portfolio} (or maximum Sharpe ratio
portfolio) because it lies at the point where the efficient frontier is
tangent to the capital market line.

\subsection{The Sharpe Ratio and the Capital Market
Line}\label{the-sharpe-ratio-and-the-capital-market-line}

The \textbf{Sharpe ratio} measures excess return per unit of volatility:

\[
\text{Sharpe Ratio} = \frac{\mu_p - r_f}{\sigma_p}
\]

The tangency portfolio maximizes the Sharpe ratio among all possible
portfolios. Any combination of the risk-free asset and the tangency
portfolio lies on a straight line in mean-standard deviation space,
called the \textbf{Capital Market Line (CML)}:

\[
\mu_p = r_f + \left(\frac{\mu_{\text{tan}} - r_f}{\sigma_{\text{tan}}}\right)\sigma_p
\]

The slope of this line equals the Sharpe ratio of the tangency portfolio
(i.e., the highest achievable Sharpe ratio).

\subsection{Computing the Tangency
Portfolio}\label{computing-the-tangency-portfolio}

Let's compute the tangency portfolio for our VN30 universe:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{assets }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{    .groupby(}\StringTok{"symbol"}\NormalTok{, as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    .agg(}
\NormalTok{        mu}\OperatorTok{=}\NormalTok{(}\StringTok{"ret"}\NormalTok{, }\StringTok{"mean"}\NormalTok{),}
\NormalTok{        sigma}\OperatorTok{=}\NormalTok{(}\StringTok{"ret"}\NormalTok{, }\StringTok{"std"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{sigma }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{    .pivot(index}\OperatorTok{=}\StringTok{"date"}\NormalTok{, columns}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, values}\OperatorTok{=}\StringTok{"ret"}\NormalTok{)}
\NormalTok{    .cov()}
\NormalTok{)}

\NormalTok{mu }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{    .groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"ret"}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .values}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Compute tangency portfolio weights}
\NormalTok{w\_tan }\OperatorTok{=}\NormalTok{ np.linalg.solve(sigma, mu }\OperatorTok{{-}}\NormalTok{ rf)}
\NormalTok{w\_tan }\OperatorTok{=}\NormalTok{ w\_tan }\OperatorTok{/}\NormalTok{ np.}\BuiltInTok{sum}\NormalTok{(w\_tan)}

\CommentTok{\# Portfolio performance metrics}
\NormalTok{mu\_w }\OperatorTok{=}\NormalTok{ w\_tan.T }\OperatorTok{@}\NormalTok{ mu}
\NormalTok{sigma\_w }\OperatorTok{=}\NormalTok{ np.sqrt(w\_tan.T }\OperatorTok{@}\NormalTok{ sigma }\OperatorTok{@}\NormalTok{ w\_tan)}

\NormalTok{efficient\_portfolios }\OperatorTok{=}\NormalTok{ pd.DataFrame([}
\NormalTok{    \{}\StringTok{"symbol"}\NormalTok{: }\VerbatimStringTok{r"}\DecValTok{$}\ErrorTok{\textbackslash{}}\VerbatimStringTok{omega\_\{}\DecValTok{\textbackslash{}m}\VerbatimStringTok{athrm\{tan\}\}}\DecValTok{$}\VerbatimStringTok{"}\NormalTok{, }\StringTok{"mu"}\NormalTok{: mu\_w, }\StringTok{"sigma"}\NormalTok{: sigma\_w\},}
\NormalTok{    \{}\StringTok{"symbol"}\NormalTok{: }\VerbatimStringTok{r"}\DecValTok{$}\VerbatimStringTok{r\_f}\DecValTok{$}\VerbatimStringTok{"}\NormalTok{, }\StringTok{"mu"}\NormalTok{: rf, }\StringTok{"sigma"}\NormalTok{: }\DecValTok{0}\NormalTok{\}}
\NormalTok{])}

\NormalTok{sharpe\_ratio }\OperatorTok{=}\NormalTok{ (mu\_w }\OperatorTok{{-}}\NormalTok{ rf) }\OperatorTok{/}\NormalTok{ sigma\_w}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Tangency Portfolio Sharpe Ratio: }\SpecialCharTok{\{}\NormalTok{sharpe\_ratio}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(efficient\_portfolios)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Tangency Portfolio Sharpe Ratio: -0.5552
                    symbol        mu     sigma
0  $\omega_{\mathrm{tan}}$ -0.041157  0.077866
1                    $r_f$  0.002076  0.000000
\end{verbatim}

\subsection{Visualizing the Efficient Frontier with a Risk-Free
Asset}\label{visualizing-the-efficient-frontier-with-a-risk-free-asset}

Figure~\ref{fig-300} shows the efficient frontier when a risk-free asset
is available. The frontier is now a straight line (the Capital Market
Line) connecting the risk-free asset to the tangency portfolio and
extending beyond.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{efficient\_portfolios\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(efficient\_portfolios, aes(x}\OperatorTok{=}\StringTok{"sigma"}\NormalTok{, y}\OperatorTok{=}\StringTok{"mu"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{assets)}
    \OperatorTok{+}\NormalTok{ geom\_point(data}\OperatorTok{=}\NormalTok{efficient\_portfolios, color}\OperatorTok{=}\StringTok{"blue"}\NormalTok{, size}\OperatorTok{=}\DecValTok{3}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_label(}
\NormalTok{        aes(label}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{), }
\NormalTok{        adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\}}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Volatility (Standard Deviation)"}\NormalTok{, }
\NormalTok{        y}\OperatorTok{=}\StringTok{"Expected Return"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Efficient Frontier with Risk{-}Free Asset (VN30)"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_abline(slope}\OperatorTok{=}\NormalTok{sharpe\_ratio, intercept}\OperatorTok{=}\NormalTok{rf, linetype}\OperatorTok{=}\StringTok{"dotted"}\NormalTok{)}
\NormalTok{)}

\NormalTok{efficient\_portfolios\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{03_capm_files/figure-pdf/fig-300-output-1.pdf}}

}

\caption{\label{fig-300}The efficient frontier with a risk-free asset
becomes a straight line (the Capital Market Line) connecting the
risk-free rate to the tangency portfolio. Individual assets lie below
this line, demonstrating the benefits of diversification.}

\end{figure}%

You may notice that estimated expected returns appear quite low, some
even negative. This is not a model failure but reflects the realities of
estimation:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Sample period matters}: If the estimation window includes
  market downturns (such as the 2022-2023 period), realized average
  returns can be near zero or negative. Mean-variance optimization takes
  sample means literally.
\item
  \textbf{Estimation noise in emerging markets}: With volatile emerging
  market data, sample means are dominated by noise. A few extremely bad
  months can push the average below the risk-free rate even if the
  long-run equity premium is positive.
\end{enumerate}

This highlights a fundamental challenge in portfolio optimization: the
inputs we observe (historical returns) are noisy estimates of the true
parameters we need (expected future returns).

\section{The CAPM Equation: Risk and Expected
Return}\label{the-capm-equation-risk-and-expected-return}

\subsection{From Individual Optimization to Market
Equilibrium}\label{from-individual-optimization-to-market-equilibrium}

So far, we've focused on one investor's optimization problem. The CAPM's
power comes from considering what happens when \emph{all} investors
optimize simultaneously.

If all investors follow mean-variance optimization, they all hold some
combination of the risk-free asset and the tangency portfolio. The only
difference between investors is their risk tolerance. More risk-averse
investors hold more of the risk-free asset, while risk-tolerant
investors may even borrow at the risk-free rate to leverage their
position in the tangency portfolio.

\subsection{The Market Portfolio}\label{the-market-portfolio}

In equilibrium, the total demand for each risky asset must equal its
supply. Since all investors hold the same portfolio of risky assets (the
tangency portfolio), the equilibrium portfolio weights must equal the
\emph{market capitalization weights}. The tangency portfolio \emph{is}
the market portfolio.

This insight has enormous practical implications: instead of estimating
expected returns and covariances to compute the tangency portfolio, we
can simply use the market portfolio (approximated by a broad market
index) as a proxy.

\subsection{Deriving the CAPM
Equation}\label{deriving-the-capm-equation}

From the first-order conditions of the optimization problem, we derived
that:

\[
\tilde{\mu} = \frac{2}{\lambda}\Sigma\omega^*
\]

Since \(\omega^*\) is proportional to \(\omega_{\text{tan}}\), and in
equilibrium \(\omega_{\text{tan}}\) equals the market portfolio
\(\omega_m\):

\[
\tilde{\mu} = c \cdot \Sigma\omega_m
\]

for some constant \(c\). The \(i\)-th element of \(\Sigma\omega_m\) is:

\[
\sum_{j=1}^N \sigma_{ij}\omega_{m,j} = \text{Cov}(r_i, r_m)
\]

where \(r_m = \sum_j \omega_{m,j} r_j\) is the return on the market
portfolio.

For the market portfolio itself:

\[
\tilde{\mu}_m = c \cdot \text{Var}(r_m) = c \cdot \sigma_m^2
\]

Therefore \(c = \tilde{\mu}_m / \sigma_m^2\), and for any asset \(i\):

\[
\tilde{\mu}_i = \frac{\tilde{\mu}_m}{\sigma_m^2} \text{Cov}(r_i, r_m) = \beta_i \tilde{\mu}_m
\]

where:

\[
\beta_i = \frac{\text{Cov}(r_i, r_m)}{\text{Var}(r_m)}
\]

This is the famous \textbf{CAPM equation}:

\[
E(r_i) - r_f = \beta_i [E(r_m) - r_f]
\]

\subsection{Interpreting Beta}\label{interpreting-beta}

Beta (\(\beta_i\)) measures an asset's \textbf{systematic risk} (i.e.,
its sensitivity to market movements). The interpretation is
straightforward:

\begin{itemize}
\tightlist
\item
  \(\beta = 1\): The asset moves one-for-one with the market (average
  systematic risk)
\item
  \(\beta > 1\): The asset amplifies market movements (aggressive, high
  systematic risk)
\item
  \(\beta < 1\): The asset dampens market movements (defensive, low
  systematic risk)
\item
  \(\beta < 0\): The asset moves opposite to the market (provides
  insurance)
\end{itemize}

The CAPM says that expected excess return is proportional to beta, not
to total volatility. This explains why:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  An asset with zero beta earns only the risk-free rate (i.e., its risk
  is entirely idiosyncratic).
\item
  An asset with beta of 1 earns the market risk premium
\item
  A negative-beta asset earns \emph{less} than the risk-free rate (i.e.,
  investors pay for its insurance properties).
\end{enumerate}

\section{The Security Market Line}\label{the-security-market-line}

The CAPM predicts a linear relationship between beta and expected
return. This relationship is called the \textbf{Security Market Line
(SML)}:

\[
E(r_i) = r_f + \beta_i [E(r_m) - r_f]
\]

Unlike the Capital Market Line (which plots expected return against
total risk), the Security Market Line plots expected return against
systematic risk (beta).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas }\OperatorTok{=}\NormalTok{ (sigma }\OperatorTok{@}\NormalTok{ w\_tan) }\OperatorTok{/}\NormalTok{ (w\_tan.T }\OperatorTok{@}\NormalTok{ sigma }\OperatorTok{@}\NormalTok{ w\_tan)}
\NormalTok{assets[}\StringTok{"beta"}\NormalTok{] }\OperatorTok{=}\NormalTok{ betas.values}

\NormalTok{price\_of\_risk }\OperatorTok{=} \BuiltInTok{float}\NormalTok{(w\_tan.T }\OperatorTok{@}\NormalTok{ mu }\OperatorTok{{-}}\NormalTok{ rf)}

\NormalTok{assets\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(assets, aes(x}\OperatorTok{=}\StringTok{"beta"}\NormalTok{, y}\OperatorTok{=}\StringTok{"mu"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_point()}
    \OperatorTok{+}\NormalTok{ geom\_abline(intercept}\OperatorTok{=}\NormalTok{rf, slope}\OperatorTok{=}\NormalTok{price\_of\_risk)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Beta (Systematic Risk)"}\NormalTok{, }
\NormalTok{        y}\OperatorTok{=}\StringTok{"Expected Return"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Security Market Line"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ annotate(}\StringTok{"text"}\NormalTok{, x}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, y}\OperatorTok{=}\NormalTok{rf }\OperatorTok{+} \FloatTok{0.001}\NormalTok{, label}\OperatorTok{=}\StringTok{"Risk{-}free rate"}\NormalTok{)}
\NormalTok{)}

\NormalTok{assets\_figure.show()}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{03_capm_files/figure-pdf/cell-13-output-1.pdf}}

You may observe that the estimated SML has a negative slope, which seems
to contradict CAPM's prediction. This reflects a \textbf{negative
estimated market risk premium} in our sample period (i.e., the market
portfolio earned less than the risk-free rate).

When the market risk premium is negative, CAPM predicts that high-beta
stocks should have \emph{lower} expected returns than low-beta stocks.
This is not a model failure, the model is behaving consistently. Rather,
it reflects an unusual (but not impossible) sample period where risky
assets underperformed safe assets.

This observation highlights an important distinction: CAPM describes
\emph{expected} returns in equilibrium, but \emph{realized} returns over
any particular period may differ substantially from expectations due to
shocks and surprises.

\section{Empirical Estimation of CAPM
Parameters}\label{empirical-estimation-of-capm-parameters}

\subsection{The Regression Framework}\label{the-regression-framework}

In practice, we estimate CAPM parameters using time-series regression.
The model implies:

\[
r_{i,t} - r_{f,t} = \alpha_i + \beta_i(r_{m,t} - r_{f,t}) + \varepsilon_{i,t}
\]

where:

\begin{itemize}
\tightlist
\item
  \(r_{i,t}\): Return on asset \(i\) at time \(t\)
\item
  \(r_{f,t}\): Risk-free rate at time \(t\)
\item
  \(r_{m,t}\): Market return at time \(t\)
\item
  \(\alpha_i\): Intercept (should be zero if CAPM holds)
\item
  \(\beta_i\): Systematic risk (slope coefficient)
\item
  \(\varepsilon_{i,t}\): Idiosyncratic shock (residual)
\end{itemize}

\subsection{Alpha: Risk-Adjusted
Performance}\label{alpha-risk-adjusted-performance}

The intercept \(\alpha_i\) measures \textbf{risk-adjusted performance}.
If CAPM holds perfectly, alpha should be zero for all assets (i.e., any
excess return is exactly compensated by systematic risk).

\begin{itemize}
\tightlist
\item
  \(\alpha > 0\): The asset outperformed its CAPM-predicted return
  (positive abnormal return)
\item
  \(\alpha < 0\): The asset underperformed its CAPM-predicted return
  (negative abnormal return)
\end{itemize}

Positive alpha is the holy grail of active management: earning returns
beyond what systematic risk exposure would justify.

\subsection{Loading Factor Data}\label{loading-factor-data}

We use Fama-French market excess returns as our market portfolio proxy.
These data provide a widely accepted benchmark that is already adjusted
for the risk-free rate:

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ sqlite3}

\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\NormalTok{factors }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM factors\_ff5\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\NormalTok{factors.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& date & smb & hml & rmw & cma & mkt\_excess \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2011-07-31 & 0.029280 & -0.049915 & 0.013239 & -0.025244 &
-0.067002 \\
1 & 2011-08-31 & 0.022241 & -0.021097 & 0.001543 & -0.021929 &
0.049073 \\
2 & 2011-09-30 & 0.026609 & 0.014323 & 0.025125 & 0.003444 &
-0.017362 \\
\end{longtable}

\subsection{Running the Regressions}\label{running-the-regressions}

We estimate CAPM regressions for each stock in our universe:

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}

\NormalTok{returns\_excess\_monthly }\OperatorTok{=}\NormalTok{ (returns\_monthly}
\NormalTok{    .merge(factors, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{    .assign(ret\_excess}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{"risk\_free"}\NormalTok{])}
\NormalTok{)}


\KeywordTok{def}\NormalTok{ estimate\_capm(data):}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ smf.ols(}\StringTok{"ret\_excess \textasciitilde{} mkt\_excess"}\NormalTok{, data}\OperatorTok{=}\NormalTok{data).fit()}
\NormalTok{    result }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
        \StringTok{"coefficient"}\NormalTok{: [}\StringTok{"alpha"}\NormalTok{, }\StringTok{"beta"}\NormalTok{],}
        \StringTok{"estimate"}\NormalTok{: model.params.values,}
        \StringTok{"t\_statistic"}\NormalTok{: model.tvalues.values}
\NormalTok{    \})}
    \ControlFlowTok{return}\NormalTok{ result}


\NormalTok{capm\_results }\OperatorTok{=}\NormalTok{ (returns\_excess\_monthly}
\NormalTok{    .groupby(}\StringTok{"symbol"}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(estimate\_capm)}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\NormalTok{capm\_results.head(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& symbol & level\_1 & coefficient & estimate & t\_statistic \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & ACB & 0 & alpha & -0.000677 & -0.086189 \\
1 & ACB & 1 & beta & 0.611184 & 4.518154 \\
2 & BCM & 0 & alpha & 0.035585 & 2.410328 \\
3 & BCM & 1 & beta & 1.062267 & 4.666808 \\
\end{longtable}

\subsection{Visualizing Alpha
Estimates}\label{visualizing-alpha-estimates}

Figure~\ref{fig-305} shows the estimated alphas across our VN30 sample.
Statistical significance (at the 95\% level) is indicated by color.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{alphas }\OperatorTok{=}\NormalTok{ (capm\_results}
\NormalTok{    .query(}\StringTok{"coefficient == \textquotesingle{}alpha\textquotesingle{}"}\NormalTok{)}
\NormalTok{    .assign(is\_significant}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.}\BuiltInTok{abs}\NormalTok{(x[}\StringTok{"t\_statistic"}\NormalTok{]) }\OperatorTok{\textgreater{}=} \FloatTok{1.96}\NormalTok{)}
\NormalTok{)}

\NormalTok{alphas[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{    alphas[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{    categories}\OperatorTok{=}\NormalTok{alphas.sort\_values(}\StringTok{"estimate"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{    ordered}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{alphas\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(alphas, aes(y}\OperatorTok{=}\StringTok{"estimate"}\NormalTok{, x}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"is\_significant"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_col()}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ coord\_flip()}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, }
\NormalTok{        y}\OperatorTok{=}\StringTok{"Estimated Alpha (Monthly)"}\NormalTok{, }
\NormalTok{        fill}\OperatorTok{=}\StringTok{"Significant at 95\%?"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Estimated CAPM Alphas for VN30 Index Constituents"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{alphas\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{03_capm_files/figure-pdf/fig-305-output-1.pdf}}

}

\caption{\label{fig-305}Estimated CAPM alphas for VN30 index
constituents. Color indicates statistical significance at the 95\%
confidence level. Most alphas are statistically indistinguishable from
zero, consistent with CAPM predictions.}

\end{figure}%

The distribution of alphas provides evidence on CAPM's empirical
validity. If the model holds, we expect:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Most alphas close to zero
\item
  Few statistically significant alphas
\item
  Roughly equal numbers of positive and negative alphas
\end{enumerate}

Systematic patterns in alphas, such as consistently positive alphas for
certain types of stocks, would suggest the CAPM is incomplete and that
additional risk factors may be needed.

\section{Limitations and Extensions}\label{limitations-and-extensions}

\subsection{The Market Portfolio
Problem}\label{the-market-portfolio-problem}

A fundamental challenge in testing the CAPM is identifying the market
portfolio. The theory requires a portfolio that includes \emph{all}
investable assets, not just stocks, but also bonds, real estate, private
businesses, human capital, and even intangible assets. In practice, we
use proxies like broad market indices (VNI, S\&P 500), but these capture
only publicly traded equities.

This limitation is profound. As Richard Roll famously argued, the CAPM
is essentially untestable because the true market portfolio is
unobservable. Any test of the CAPM is simultaneously a test of whether
our proxy adequately represents the market.

\subsection{Time-Varying Betas}\label{time-varying-betas}

The CAPM assumes that betas are constant over time, but this assumption
rarely holds in practice. Companies undergo changes that affect their
market sensitivity:

\begin{itemize}
\tightlist
\item
  \textbf{Capital structure changes}: Increasing leverage raises beta
\item
  \textbf{Business model evolution}: Diversification into new industries
  can alter systematic risk
\item
  \textbf{Market conditions}: Betas often increase during market stress
\end{itemize}

Conditional CAPM models (Jagannathan and Wang 1996) address this by
allowing risk premiums and betas to vary with the business cycle.

\subsection{Empirical Anomalies}\label{empirical-anomalies}

Decades of empirical research have documented patterns in stock returns
that CAPM cannot explain:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Size effect}: Small-cap stocks tend to outperform large-cap
  stocks, even after adjusting for beta
\item
  \textbf{Value effect}: Stocks with high book-to-market ratios
  outperform growth stocks
\item
  \textbf{Momentum}: Stocks that performed well recently tend to
  continue performing well
\end{enumerate}

These anomalies suggest that systematic risk has multiple dimensions
beyond market exposure.

\subsection{Multifactor Extensions}\label{multifactor-extensions}

The limitations of CAPM have led to increasingly sophisticated asset
pricing models. The \textbf{Fama-French three-factor model} (Eugene F.
Fama and French 1992) adds two factors to capture size and value
effects:

\begin{itemize}
\tightlist
\item
  \textbf{SMB (Small Minus Big)}: Returns on small stocks minus large
  stocks
\item
  \textbf{HML (High Minus Low)}: Returns on value stocks minus growth
  stocks
\end{itemize}

The \textbf{Fama-French five-factor model} (Eugene F. Fama and French
2015) adds two more dimensions:

\begin{itemize}
\tightlist
\item
  \textbf{RMW (Robust Minus Weak)}: Returns on profitable firms minus
  unprofitable firms\\
\item
  \textbf{CMA (Conservative Minus Aggressive)}: Returns on conservative
  investors minus aggressive investors
\end{itemize}

The \textbf{Carhart four-factor model} (Mark M. Carhart 1997b) adds
momentum to the three-factor framework.

Other theoretical developments include:

\begin{itemize}
\tightlist
\item
  \textbf{Consumption CAPM}: Links asset prices to macroeconomic
  consumption risk
\item
  \textbf{Q-factor model} (Hou, Xue, and Zhang 2014): Derives factors
  from investment-based asset pricing theory
\item
  \textbf{Arbitrage Pricing Theory}: Allows for multiple sources of
  systematic risk without specifying their identity
\end{itemize}

Despite its limitations, the CAPM remains valuable as a conceptual
benchmark. Its core insight (i.e., only systematic, undiversifiable risk
commands a premium) continues to inform how we think about risk and
return.

\section{Key Takeaways}\label{key-takeaways-1}

This chapter introduced the Capital Asset Pricing Model and its
implications for understanding the relationship between risk and
expected return. The main insights are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Not all risk is rewarded}: The CAPM distinguishes between
  systematic risk (which cannot be diversified away and commands a
  premium) and idiosyncratic risk (which can be eliminated through
  diversification and earns no premium).
\item
  \textbf{The tangency portfolio is universal}: When a risk-free asset
  exists, all mean-variance investors hold the same portfolio of risky
  assets (i.e., the tangency or maximum Sharpe ratio portfolio). They
  differ only in how much they allocate to this portfolio versus the
  risk-free asset.
\item
  \textbf{In equilibrium, the tangency portfolio is the market
  portfolio}: Since all investors hold the same risky portfolio, and
  total demand must equal supply, the equilibrium portfolio weights are
  market capitalization weights.
\item
  \textbf{Expected returns depend on beta}: The CAPM equation states
  that expected excess return equals beta times the market risk premium.
  Beta measures covariance with the market portfolio, normalized by
  market variance.
\item
  \textbf{Alpha measures risk-adjusted performance}: Positive alpha
  indicates returns above what systematic risk would justify; negative
  alpha indicates underperformance.
\item
  \textbf{Empirical challenges exist}: Testing the CAPM requires
  identifying the market portfolio, which is unobservable in practice.
  Documented anomalies (size, value, momentum) suggest additional risk
  factors beyond market exposure.
\item
  \textbf{Extensions abound}: Multifactor models like Fama-French extend
  the CAPM framework by adding factors that capture dimensions of
  systematic risk the market factor misses.
\end{enumerate}

The CAPM's elegance lies in its simplicity: a single factor (i.e.,
exposure to the market) should explain expected returns in equilibrium.
While reality is more complex, this framework provides the foundation
for all modern asset pricing theory.

\bookmarksetup{startatroot}

\chapter{Financial Statement
Analysis}\label{financial-statement-analysis}

\section{From Market Prices to Fundamental
Value}\label{from-market-prices-to-fundamental-value}

The previous chapters focused on how financial markets price assets in
equilibrium. The \hyperref[the-capital-asset-pricing-model]{Capital
Asset Pricing Model} showed that expected returns depend on systematic
risk exposure, while \hyperref[modern-portfolio-theory]{Modern Portfolio
Theory} demonstrated how to construct efficient portfolios. But these
frameworks take expected returns and risk as given, they don't explain
where these expectations come from.

Financial statement analysis addresses this gap. By examining a
company's accounting records, investors can form independent assessments
of firm value, identify mispriced securities, and understand the
economic forces driving business performance. Financial statements
provide the primary source of standardized information about a company's
operations, financial position, and cash generation. Their legal
requirements and standardized formats make them particularly valuable.
Every publicly traded company must file them, creating a level playing
field for analysis.

This chapter introduces the three primary financial statements: the
balance sheet, income statement, and cash flow statement. We then
demonstrate how to transform raw accounting data into meaningful
financial ratios that facilitate comparison across companies and over
time. These ratios serve multiple purposes: they enable investors to
benchmark companies against peers, help creditors assess default risk,
and provide inputs for asset pricing models like the Fama-French factors
we will encounter in later chapters.

Our analysis combines theoretical frameworks with practical
implementation using Vietnamese market data. By the end of this chapter,
you will understand how to access financial statements, calculate key
ratios across multiple categories, and interpret these metrics in
context.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format}
\ImportTok{from}\NormalTok{ adjustText }\ImportTok{import}\NormalTok{ adjust\_text}
\end{Highlighting}
\end{Shaded}

\section{The Three Financial
Statements}\label{the-three-financial-statements}

Before diving into ratios and analysis, we need to understand the three
interconnected statements that form the foundation of financial
reporting. Each statement answers a different question about the
company, and together they provide a comprehensive picture of financial
health.

\subsection{The Balance Sheet: A Snapshot of Financial
Position}\label{the-balance-sheet-a-snapshot-of-financial-position}

The balance sheet captures a company's financial position at a specific
moment in time, think of it as a photograph rather than a movie. It
lists everything the company owns (assets), everything it owes
(liabilities), and the residual claim belonging to shareholders
(equity). These three components are linked by the fundamental
accounting equation:

\[
\text{Assets} = \text{Liabilities} + \text{Equity}
\]

This equation is not merely a definition, it reflects a core economic
principle. A company's resources (assets) must be financed from
somewhere: either borrowed from creditors (liabilities) or contributed
by owners (equity). Every transaction affects both sides equally,
maintaining the balance.

\textbf{Assets} represent resources the company controls that are
expected to generate future economic benefits:

\begin{itemize}
\tightlist
\item
  \textbf{Current assets} can be converted to cash within one year: cash
  and equivalents, short-term investments, accounts receivable (money
  owed by customers), and inventory (raw materials, work-in-progress,
  and finished goods)
\item
  \textbf{Non-current assets} support operations beyond one year:
  property, plant, and equipment (PP\&E), long-term investments, and
  intangible assets like patents, trademarks, and goodwill
\end{itemize}

\textbf{Liabilities} encompass obligations to external parties:

\begin{itemize}
\tightlist
\item
  \textbf{Current liabilities} come due within one year: accounts
  payable (money owed to suppliers), short-term debt, accrued expenses,
  and the current portion of long-term debt
\item
  \textbf{Non-current liabilities} extend beyond one year: long-term
  debt, bonds payable, pension obligations, and deferred tax liabilities
\end{itemize}

\textbf{Shareholders' equity} represents the owners' residual claim:

\begin{itemize}
\tightlist
\item
  \textbf{Common stock} and additional paid-in capital from share
  issuance
\item
  \textbf{Retained earnings} (i.e., accumulated profits reinvested
  rather than distributed as dividends)
\item
  \textbf{Treasury stock}: shares repurchased by the company
\end{itemize}

Understanding these categories is essential for ratio analysis. Current
assets and liabilities determine short-term liquidity, while the mix of
debt and equity reveals capital structure choices.

\subsection{The Income Statement: Performance Over
Time}\label{the-income-statement-performance-over-time}

While the balance sheet provides a snapshot, the income statement (also
called the profit and loss statement, or P\&L) measures financial
performance over a period (e.g., a quarter or year). It follows a
hierarchical structure that progressively captures different levels of
profitability:

\[
\text{Revenue} - \text{COGS} = \text{Gross Profit}
\]

\[
\text{Gross Profit} - \text{Operating Expenses} = \text{Operating Income (EBIT)}
\]

\[
\text{EBIT} - \text{Interest} - \text{Taxes} = \text{Net Income}
\]

Each line reveals something different about the business:

\begin{itemize}
\tightlist
\item
  \textbf{Revenue (Sales)}: Total income from goods or services sold
  (i.e., the ``top line'')
\item
  \textbf{Cost of Goods Sold (COGS)}: Direct costs of producing what was
  sold (materials, direct labor, manufacturing overhead)
\item
  \textbf{Gross Profit}: Revenue minus COGS, measuring basic
  profitability from core operations
\item
  \textbf{Operating Expenses}: Costs of running the business beyond
  production (selling, general \& administrative expenses, research \&
  development)
\item
  \textbf{Operating Income (EBIT)}: Earnings Before Interest and Taxes,
  measuring profitability from operations before financing decisions and
  taxes
\item
  \textbf{Interest Expense}: The cost of debt financing
\item
  \textbf{Net Income}: The ``bottom line'' (i.e., total profit after all
  expenses)
\end{itemize}

The income statement's hierarchical structure allows analysts to
identify where profitability problems originate. A company with strong
gross margins but weak net income might have bloated overhead costs. One
with weak gross margins faces fundamental pricing or production
challenges.

\subsection{The Cash Flow Statement: Following the
Money}\label{the-cash-flow-statement-following-the-money}

The cash flow statement bridges a critical gap: profitable companies can
run out of cash, and unprofitable companies can generate positive cash
flow. This happens because accrual accounting (used in the income
statement) recognizes revenue when earned and expenses when incurred,
not when cash changes hands.

The cash flow statement tracks actual cash movements, divided into three
categories:

\begin{itemize}
\tightlist
\item
  \textbf{Operating activities}: Cash generated from core business
  operations. Starts with net income, then adjusts for non-cash items
  (depreciation, changes in working capital)
\item
  \textbf{Investing activities}: Cash spent on or received from
  long-term investments (e.g., purchasing equipment, acquiring
  businesses, selling assets)
\item
  \textbf{Financing activities}: Cash flows from capital structure
  decisions (e.g., issuing stock, borrowing, repaying debt, paying
  dividends, buying back shares)
\end{itemize}

A company can show strong net income while burning cash if it's building
inventory, extending generous credit terms, or making large capital
expenditures. Conversely, a company reporting losses might generate
positive operating cash flow by collecting receivables faster than it
pays suppliers.

\subsection{Illustrating with FPT's Financial
Statements}\label{illustrating-with-fpts-financial-statements}

To see these concepts in practice, let's examine FPT Corporation's 2023
financial statements. FPT is one of Vietnam's largest technology
companies, providing IT services, telecommunications, and education.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Placeholder for FPT balance sheet visualization}
\CommentTok{\# In practice, this would display the actual PDF or cleaned data}
\CommentTok{\# from DataCore\textquotesingle{}s acquisition pipeline}

\CommentTok{\# Example structure of what the balance sheet data looks like:}
\CommentTok{\# Assets: Current assets (cash, receivables, inventory) + Non{-}current assets (PP\&E, intangibles)}
\CommentTok{\# Liabilities: Current liabilities (payables, short{-}term debt) + Non{-}current liabilities (long{-}term debt)}
\CommentTok{\# Equity: Common stock + Retained earnings}
\end{Highlighting}
\end{Shaded}

The balance sheet demonstrates the fundamental accounting equation in
action. FPT's assets (e.g., spanning cash, receivables, technology
infrastructure, and intangible assets like software) exactly equal the
sum of its liabilities and equity.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Placeholder for FPT income statement visualization}
\CommentTok{\# Shows the progression from revenue through various profit measures to net income}
\end{Highlighting}
\end{Shaded}

FPT's income statement reveals how the company transforms revenue into
profit. The progression from gross profit through operating income to
net income shows the impact of operating expenses, interest costs, and
taxes.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Placeholder for FPT cash flow statement visualization}
\CommentTok{\# Reconciles net income with actual cash generation}
\end{Highlighting}
\end{Shaded}

The cash flow statement shows how FPT's reported profits translate into
actual cash. Differences between net income and operating cash flow
reveal the impact of working capital management and non-cash expenses.

\section{Loading Financial Statement
Data}\label{loading-financial-statement-data}

We now turn to systematic analysis across multiple companies. We load
financial statement data for the VN30 index constituents (i.e., the 30
largest and most liquid stocks on Vietnam's Ho Chi Minh Stock Exchange).

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ sqlite3}

\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM comp\_vn"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"datadate"}\NormalTok{\}}
\NormalTok{)}

\NormalTok{comp\_vn.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& symbol & year & total\_current\_asset & ca\_fin & ca\_cce & ca\_cash &
ca\_cash\_inbank & ca\_cash\_attransit & ca\_cash\_equivalent &
ca\_fin\_invest & ... & txditc & txdb & pstk & be & op & at\_lag & inv &
total\_debt & selling\_general\_and\_administrative\_expenses &
shrout \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & AGF & 1998 & 8.845141e+10 & None & 5.469709e+09 & 0.000000e+00 &
None & None & 0.0 & 1.110705e+10 & ... & 0.0 & 0.0 & 0.0 & 2.656020e+10
& 0.711195 & NaN & NaN & 0.000000e+00 & 1.990718e+10 & 4.179130e+06 \\
1 & BBC & 1999 & 5.672574e+10 & None & 5.354939e+09 & 5.354939e+09 &
None & None & 0.0 & 0.000000e+00 & ... & 0.0 & 0.0 & 0.0 & 3.211410e+10
& 0.728193 & NaN & NaN & 1.505529e+09 & 2.387858e+10 & 2.500000e+06 \\
2 & AGF & 1999 & 9.558392e+10 & None & 2.609276e+09 & 0.000000e+00 &
None & None & 0.0 & 1.008298e+10 & ... & 0.0 & 0.0 & 0.0 & 3.576596e+10
& 0.816972 & 1.068410e+11 & 0.090477 & 0.000000e+00 & 2.744458e+10 &
4.179130e+06 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vn30\_symbols }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"ACB"}\NormalTok{, }\StringTok{"BCM"}\NormalTok{, }\StringTok{"BID"}\NormalTok{, }\StringTok{"BVH"}\NormalTok{, }\StringTok{"CTG"}\NormalTok{, }\StringTok{"FPT"}\NormalTok{, }\StringTok{"GAS"}\NormalTok{, }\StringTok{"GVR"}\NormalTok{, }\StringTok{"HDB"}\NormalTok{, }\StringTok{"HPG"}\NormalTok{,}
    \StringTok{"MBB"}\NormalTok{, }\StringTok{"MSN"}\NormalTok{, }\StringTok{"MWG"}\NormalTok{, }\StringTok{"PLX"}\NormalTok{, }\StringTok{"POW"}\NormalTok{, }\StringTok{"SAB"}\NormalTok{, }\StringTok{"SHB"}\NormalTok{, }\StringTok{"SSB"}\NormalTok{, }\StringTok{"STB"}\NormalTok{, }\StringTok{"TCB"}\NormalTok{,}
    \StringTok{"TPB"}\NormalTok{, }\StringTok{"VCB"}\NormalTok{, }\StringTok{"VHM"}\NormalTok{, }\StringTok{"VIB"}\NormalTok{, }\StringTok{"VIC"}\NormalTok{, }\StringTok{"VJC"}\NormalTok{, }\StringTok{"VNM"}\NormalTok{, }\StringTok{"VPB"}\NormalTok{, }\StringTok{"VRE"}\NormalTok{, }\StringTok{"EIB"}
\NormalTok{]}

\NormalTok{comp\_vn30 }\OperatorTok{=}\NormalTok{ comp\_vn[comp\_vn[}\StringTok{"symbol"}\NormalTok{].isin(vn30\_symbols)]}
\NormalTok{comp\_vn30.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& symbol & year & total\_current\_asset & ca\_fin & ca\_cce & ca\_cash &
ca\_cash\_inbank & ca\_cash\_attransit & ca\_cash\_equivalent &
ca\_fin\_invest & ... & txditc & txdb & pstk & be & op & at\_lag & inv &
total\_debt & selling\_general\_and\_administrative\_expenses &
shrout \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
11 & FPT & 2002 & 5.098910e+11 & None & 1.027470e+11 & 0.000000e+00 &
None & None & 0.0 & 0.0 & ... & 0.0 & 0.0 & 0.0 & 3.125400e+10 &
3.293018 & NaN & NaN & 0.0 & 1.235850e+11 & 6.081023e+07 \\
17 & VNM & 2003 & 2.101406e+12 & None & 6.925924e+11 & 6.925924e+11 &
None & None & 0.0 & 0.0 & ... & 0.0 & 0.0 & 0.0 & 1.560789e+12 &
0.663257 & NaN & NaN & 0.0 & 5.037799e+11 & 1.590000e+08 \\
21 & FPT & 2003 & 9.171390e+11 & None & 7.995600e+10 & 0.000000e+00 &
None & None & 0.0 & 0.0 & ... & 0.0 & 0.0 & 0.0 & 1.697000e+11 &
0.940218 & 5.504080e+11 & 0.779104 & 0.0 & 1.968430e+11 &
6.081023e+07 \\
\end{longtable}

This dataset provides the foundation for calculating financial ratios
and conducting cross-sectional comparisons. Each row contains balance
sheet, income statement, and cash flow items for a company-year
observation.

\section{Liquidity Ratios: Can the Company Pay Its
Bills?}\label{liquidity-ratios-can-the-company-pay-its-bills}

Liquidity ratios assess a company's ability to meet short-term
obligations. These metrics matter most to creditors, suppliers, and
employees who need assurance that the company can pay its bills. They're
calculated using balance sheet items, comparing liquid assets against
near-term liabilities.

\subsection{The Current Ratio}\label{the-current-ratio}

The most basic liquidity measure compares all current assets to current
liabilities:

\[
\text{Current Ratio} = \frac{\text{Current Assets}}{\text{Current Liabilities}}
\]

A ratio above one indicates the company has enough current assets to
cover obligations due within one year. However, the interpretation
depends heavily on the composition of current assets. A company with
current assets tied up in slow-moving inventory is less liquid than one
holding cash.

\subsection{The Quick Ratio}\label{the-quick-ratio}

The quick ratio (or ``acid test'') provides a more stringent measure by
excluding inventory:

\[
\text{Quick Ratio} = \frac{\text{Current Assets} - \text{Inventory}}{\text{Current Liabilities}}
\]

Why exclude inventory? Inventory is typically the least liquid current
asset. It must be sold (potentially at a discount) before generating
cash. A company facing a liquidity crisis cannot easily convert raw
materials or finished goods into immediate cash. The quick ratio
answers: ``Can we pay our bills without relying on inventory sales?''

\subsection{The Cash Ratio}\label{the-cash-ratio}

The most conservative liquidity measure focuses solely on the most
liquid assets:

\[
\text{Cash Ratio} = \frac{\text{Cash and Cash Equivalents}}{\text{Current Liabilities}}
\]

While a ratio of one indicates robust liquidity, most companies maintain
lower cash ratios to avoid holding excessive non-productive assets. Cash
sitting in bank accounts could otherwise be invested in growth
opportunities, returned to shareholders, or used to pay down costly
debt.

\subsection{Calculating Liquidity
Ratios}\label{calculating-liquidity-ratios}

Let's compute these ratios for our VN30 sample:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balance\_sheet\_statements }\OperatorTok{=}\NormalTok{ (comp\_vn30}
\NormalTok{    .assign(}
\NormalTok{        fiscal\_year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"year"}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{),}
        
        \CommentTok{\# Current Ratio: Current Assets / Current Liabilities}
\NormalTok{        current\_ratio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"act"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"lct"}\NormalTok{],}
        
        \CommentTok{\# Quick Ratio: (Current Assets {-} Inventory) / Current Liabilities}
\NormalTok{        quick\_ratio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{"act"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{"inv"}\NormalTok{]) }\OperatorTok{/}\NormalTok{ x[}\StringTok{"lct"}\NormalTok{],}
        
        \CommentTok{\# Cash Ratio: Cash and Equivalents / Current Liabilities}
\NormalTok{        cash\_ratio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ca\_cce"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"lct"}\NormalTok{],}
        
\NormalTok{        label}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(}
\NormalTok{            x[}\StringTok{"symbol"}\NormalTok{].isin(vn30\_symbols), x[}\StringTok{"symbol"}\NormalTok{], np.nan}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{balance\_sheet\_statements.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& symbol & year & total\_current\_asset & ca\_fin & ca\_cce & ca\_cash &
ca\_cash\_inbank & ca\_cash\_attransit & ca\_cash\_equivalent &
ca\_fin\_invest & ... & at\_lag & inv & total\_debt &
selling\_general\_and\_administrative\_expenses & shrout & fiscal\_year
& current\_ratio & quick\_ratio & cash\_ratio & label \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
11 & FPT & 2002 & 5.098910e+11 & None & 1.027470e+11 & 0.000000e+00 &
None & None & 0.0 & 0.0 & ... & NaN & NaN & 0.0 & 1.235850e+11 &
6.081023e+07 & 2002 & 1.211413 & NaN & 0.244109 & FPT \\
17 & VNM & 2003 & 2.101406e+12 & None & 6.925924e+11 & 6.925924e+11 &
None & None & 0.0 & 0.0 & ... & NaN & NaN & 0.0 & 5.037799e+11 &
1.590000e+08 & 2003 & 2.195772 & NaN & 0.723694 & VNM \\
21 & FPT & 2003 & 9.171390e+11 & None & 7.995600e+10 & 0.000000e+00 &
None & None & 0.0 & 0.0 & ... & 5.504080e+11 & 0.779104 & 0.0 &
1.968430e+11 & 6.081023e+07 & 2003 & 1.274633 & 1.274633 & 0.111122 &
FPT \\
\end{longtable}

\subsection{Cross-Sectional Comparison of
Liquidity}\label{cross-sectional-comparison-of-liquidity}

Figure~\ref{fig-409} compares liquidity ratios across companies for the
most recent fiscal year. This cross-sectional view reveals how different
business models and industries maintain different liquidity profiles.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{liquidity\_ratios }\OperatorTok{=}\NormalTok{ (balance\_sheet\_statements}
\NormalTok{    .query(}\StringTok{"year == 2023 \& label.notna()"}\NormalTok{)}
\NormalTok{    .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"current\_ratio"}\NormalTok{, }\StringTok{"quick\_ratio"}\NormalTok{, }\StringTok{"cash\_ratio"}\NormalTok{])}
\NormalTok{    .melt(id\_vars}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{], var\_name}\OperatorTok{=}\StringTok{"name"}\NormalTok{, value\_name}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        name}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"name"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.replace(}\StringTok{"\_"}\NormalTok{, }\StringTok{" "}\NormalTok{).}\BuiltInTok{str}\NormalTok{.title()}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{liquidity\_ratios\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(liquidity\_ratios, aes(y}\OperatorTok{=}\StringTok{"value"}\NormalTok{, x}\OperatorTok{=}\StringTok{"name"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_col(position}\OperatorTok{=}\StringTok{"dodge"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ coord\_flip()}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Ratio Value"}\NormalTok{, fill}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Liquidity Ratios for VN30 Stocks (2023)"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{liquidity\_ratios\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-409-output-1.pdf}}

}

\caption{\label{fig-409}Liquidity ratios measure a company's ability to
meet short-term obligations. Higher values indicate greater liquidity,
though excessively high ratios may suggest inefficient use of assets.}

\end{figure}%

Several patterns emerge from this comparison. Banks and financial
institutions typically show different liquidity profiles than industrial
companies due to their unique business models. Companies with high
inventory (retailers, manufacturers) often show larger gaps between
current and quick ratios.

\section{Leverage Ratios: How Is the Company
Financed?}\label{leverage-ratios-how-is-the-company-financed}

Leverage ratios examine a company's capital structure (i.e., the mix of
debt and equity financing). These metrics reveal financial risk and
long-term solvency, helping investors understand how much of the
company's operations are funded by borrowed money.

\subsection{Why Capital Structure
Matters}\label{why-capital-structure-matters}

A company's financing choice involves fundamental trade-offs:

\begin{itemize}
\tightlist
\item
  \textbf{Debt} offers tax advantages (interest is deductible) and
  doesn't dilute ownership, but creates fixed obligations that must be
  met regardless of business performance
\item
  \textbf{Equity} provides flexibility (no required payments) but
  dilutes existing shareholders and may be more expensive than debt
\end{itemize}

Companies with high leverage amplify both gains and losses. In good
times, shareholders capture more upside because profits aren't shared
with additional equity holders. In bad times, fixed interest payments
can push the company toward distress. This is why beta (systematic risk)
tends to increase with leverage.

\subsection{Debt-to-Equity Ratio}\label{debt-to-equity-ratio}

This ratio indicates how much debt financing the company uses relative
to shareholder investment:

\[
\text{Debt-to-Equity} = \frac{\text{Total Debt}}{\text{Total Equity}}
\]

A ratio of 1.0 means equal parts debt and equity financing. Higher
ratios indicate more aggressive use of leverage, which can enhance
returns in good times but increases bankruptcy risk.

\subsection{Debt-to-Asset Ratio}\label{debt-to-asset-ratio}

This ratio shows what percentage of assets are financed through debt:

\[
\text{Debt-to-Asset} = \frac{\text{Total Debt}}{\text{Total Assets}}
\]

A ratio of 0.5 means half the company's assets are debt-financed. This
metric is bounded between 0 and 1 (assuming positive equity), making it
easier to compare across companies than the debt-to-equity ratio.

\subsection{Interest Coverage Ratio}\label{interest-coverage-ratio}

While the above ratios measure leverage levels, interest coverage
assesses the ability to service that debt:

\[
\text{Interest Coverage} = \frac{\text{EBIT}}{\text{Interest Expense}}
\]

This ratio answers: ``How many times over can current operating profits
cover interest obligations?'' A ratio below 1.0 means operating income
doesn't cover interest payments, which is a dangerous position. Ratios
above 3-5 generally indicate comfortable coverage.

\subsection{Calculating Leverage
Ratios}\label{calculating-leverage-ratios}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{balance\_sheet\_statements }\OperatorTok{=}\NormalTok{ balance\_sheet\_statements.assign(}
\NormalTok{    debt\_to\_equity}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"total\_debt"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_equity"}\NormalTok{],}
\NormalTok{    debt\_to\_asset}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"total\_debt"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"at"}\NormalTok{]}
\NormalTok{)}

\NormalTok{income\_statements }\OperatorTok{=}\NormalTok{ (comp\_vn30}
\NormalTok{    .assign(}
\NormalTok{        year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"year"}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{),}
        \CommentTok{\# Handle zero interest expense to avoid infinity}
\NormalTok{        interest\_coverage}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(}
\NormalTok{            x[}\StringTok{"cfo\_interest\_expense"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
\NormalTok{            x[}\StringTok{"is\_net\_business\_profit"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"cfo\_interest\_expense"}\NormalTok{],}
\NormalTok{            np.nan}
\NormalTok{        ),}
\NormalTok{        label}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(}
\NormalTok{            x[}\StringTok{"symbol"}\NormalTok{].isin(vn30\_symbols), x[}\StringTok{"symbol"}\NormalTok{], np.nan}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Leverage Trends Over Time}\label{leverage-trends-over-time}

Figure~\ref{fig-410} tracks how debt-to-asset ratios have evolved over
time. Time-series analysis reveals whether companies are becoming more
or less leveraged.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{debt\_to\_asset }\OperatorTok{=}\NormalTok{ balance\_sheet\_statements.query(}\StringTok{"symbol in @vn30\_symbols"}\NormalTok{)}

\NormalTok{debt\_to\_asset\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(debt\_to\_asset, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"debt\_to\_asset"}\NormalTok{, color}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Debt{-}to{-}Asset Ratio"}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Debt{-}to{-}Asset Ratios of VN30 Stocks Over Time"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{debt\_to\_asset\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-410-output-1.pdf}}

}

\caption{\label{fig-410}Debt-to-asset ratios show the proportion of
assets financed by debt. Changes over time reflect evolving capital
structure strategies and market conditions.}

\end{figure}%

\subsection{Cross-Sectional Leverage
Comparison}\label{cross-sectional-leverage-comparison}

Figure~\ref{fig-411} provides a snapshot of leverage across all VN30
constituents for the most recent year.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{debt\_to\_asset\_comparison }\OperatorTok{=}\NormalTok{ balance\_sheet\_statements.query(}\StringTok{"year == 2023"}\NormalTok{)}

\NormalTok{debt\_to\_asset\_comparison[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{    debt\_to\_asset\_comparison[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{    categories}\OperatorTok{=}\NormalTok{debt\_to\_asset\_comparison.sort\_values(}\StringTok{"debt\_to\_asset"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{],}
\NormalTok{    ordered}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}

\NormalTok{debt\_to\_asset\_comparison\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        debt\_to\_asset\_comparison,}
\NormalTok{        aes(y}\OperatorTok{=}\StringTok{"debt\_to\_asset"}\NormalTok{, x}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"label"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_col()}
    \OperatorTok{+}\NormalTok{ coord\_flip()}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Debt{-}to{-}Asset Ratio"}\NormalTok{, fill}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Debt{-}to{-}Asset Ratios of VN30 Stocks (2023)"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}

\NormalTok{debt\_to\_asset\_comparison\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-411-output-1.pdf}}

}

\caption{\label{fig-411}Cross-sectional comparison of debt-to-asset
ratios reveals industry patterns and company-specific financing
strategies.}

\end{figure}%

\subsection{The Leverage-Coverage
Trade-off}\label{the-leverage-coverage-trade-off}

Figure~\ref{fig-412} examines the relationship between leverage levels
and debt-servicing ability. Companies with higher debt loads should
ideally have stronger interest coverage to maintain financial stability.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{interest\_coverage }\OperatorTok{=}\NormalTok{ (income\_statements}
\NormalTok{    .query(}\StringTok{"year == 2023"}\NormalTok{)}
\NormalTok{    .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"interest\_coverage"}\NormalTok{])}
\NormalTok{    .merge(balance\_sheet\_statements, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{)}

\NormalTok{interest\_coverage\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        interest\_coverage,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"debt\_to\_asset"}\NormalTok{, y}\OperatorTok{=}\StringTok{"interest\_coverage"}\NormalTok{, color}\OperatorTok{=}\StringTok{"label"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_point(size}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_label(}
\NormalTok{        aes(label}\OperatorTok{=}\StringTok{"label"}\NormalTok{),}
\NormalTok{        adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\}}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Debt{-}to{-}Asset Ratio"}\NormalTok{, y}\OperatorTok{=}\StringTok{"Interest Coverage Ratio"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Leverage versus Interest Coverage for VN30 Stocks (2023)"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}

\NormalTok{interest\_coverage\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-412-output-1.pdf}}

}

\caption{\label{fig-412}The relationship between leverage and interest
coverage reveals whether companies can comfortably service their debt.
High leverage with low coverage indicates elevated financial risk.}

\end{figure}%

The scatter plot reveals important patterns. Companies in the upper-left
quadrant (low leverage, high coverage) have conservative financing with
ample debt capacity. Those in the lower-right (high leverage, low
coverage) face elevated financial risk.

\section{Efficiency Ratios: How Well Are Assets
Managed?}\label{efficiency-ratios-how-well-are-assets-managed}

Efficiency ratios measure how effectively a company utilizes its assets
and manages operations. These metrics help identify whether management
is extracting maximum value from the company's resource base.

\subsection{Asset Turnover}\label{asset-turnover}

This ratio measures how efficiently a company uses total assets to
generate revenue:

\[
\text{Asset Turnover} = \frac{\text{Revenue}}{\text{Total Assets}}
\]

A higher ratio indicates more efficient asset utilization: the company
generates more sales per dollar of assets. However, optimal levels vary
dramatically across industries. Retailers with minimal fixed assets
might achieve turnovers above 2.0, while capital-intensive manufacturers
might operate below 0.5.

\subsection{Inventory Turnover}\label{inventory-turnover}

For companies carrying inventory, this ratio reveals how quickly stock
moves through the business:

\[
\text{Inventory Turnover} = \frac{\text{Cost of Goods Sold}}{\text{Inventory}}
\]

Higher turnover suggests efficient inventory management (i.e., goods
don't sit on shelves collecting dust). However, extremely high turnover
might indicate stockout risks, while very low turnover could signal
obsolete inventory or overinvestment in working capital.

We use COGS rather than revenue in the numerator because inventory is
recorded at cost, not selling price. Using revenue would overstate
turnover for high-margin businesses.

\subsection{Receivables Turnover}\label{receivables-turnover}

This ratio measures how effectively a company collects payments from
customers:

\[
\text{Receivables Turnover} = \frac{\text{Revenue}}{\text{Accounts Receivable}}
\]

Higher turnover indicates faster collection (i.e., customers pay
promptly). Converting this to ``days sales outstanding'' (365 /
turnover) gives the average collection period in days. Companies must
balance collection efficiency against the sales impact of restrictive
credit policies.

\subsection{Calculating Efficiency
Ratios}\label{calculating-efficiency-ratios}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{combined\_statements }\OperatorTok{=}\NormalTok{ (balance\_sheet\_statements}
\NormalTok{    .get([}
        \StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"label"}\NormalTok{, }\StringTok{"current\_ratio"}\NormalTok{, }\StringTok{"quick\_ratio"}\NormalTok{,}
        \StringTok{"cash\_ratio"}\NormalTok{, }\StringTok{"debt\_to\_equity"}\NormalTok{, }\StringTok{"debt\_to\_asset"}\NormalTok{, }\StringTok{"total\_asset"}\NormalTok{,}
        \StringTok{"total\_equity"}
\NormalTok{    ])}
\NormalTok{    .merge(}
\NormalTok{        (income\_statements}
\NormalTok{            .get([}
                \StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"interest\_coverage"}\NormalTok{, }\StringTok{"is\_revenue"}\NormalTok{,}
                \StringTok{"is\_cogs"}\NormalTok{, }\StringTok{"selling\_general\_and\_administrative\_expenses"}\NormalTok{,}
                \StringTok{"is\_interest\_expense"}\NormalTok{, }\StringTok{"is\_gross\_profit"}\NormalTok{, }\StringTok{"is\_eat"}
\NormalTok{            ])}
\NormalTok{        ),}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{    .merge(}
\NormalTok{        (comp\_vn30}
\NormalTok{            .assign(year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"year"}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{))}
\NormalTok{            .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"ca\_total\_inventory"}\NormalTok{, }\StringTok{"ca\_acc\_receiv"}\NormalTok{])}
\NormalTok{        ),}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{combined\_statements }\OperatorTok{=}\NormalTok{ combined\_statements.assign(}
\NormalTok{    asset\_turnover}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_revenue"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_asset"}\NormalTok{],}
\NormalTok{    inventory\_turnover}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_cogs"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"ca\_total\_inventory"}\NormalTok{],}
\NormalTok{    receivables\_turnover}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_revenue"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"ca\_acc\_receiv"}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Efficiency ratios vary dramatically across industries, making peer
comparison essential. A grocery store and a shipbuilder will have
fundamentally different asset and inventory dynamics.

\section{Profitability Ratios: Is the Company Making
Money?}\label{profitability-ratios-is-the-company-making-money}

Profitability ratios evaluate how effectively a company converts
activity into earnings. These metrics directly measure financial success
and are among the most closely watched indicators by investors.

\subsection{Gross Margin}\label{gross-margin}

The gross margin reveals what percentage of revenue remains after direct
production costs:

\[
\text{Gross Margin} = \frac{\text{Gross Profit}}{\text{Revenue}} = \frac{\text{Revenue} - \text{COGS}}{\text{Revenue}}
\]

Higher gross margins indicate stronger pricing power, more efficient
production, or a favorable product mix. This metric is particularly
useful for comparing companies within an industry, as it reveals
relative efficiency in core operations before overhead costs.

\subsection{Profit Margin}\label{profit-margin}

The profit margin shows what percentage of revenue ultimately becomes
net income:

\[
\text{Profit Margin} = \frac{\text{Net Income}}{\text{Revenue}}
\]

This comprehensive measure accounts for all costs (e.g., production,
operations, interest, and taxes). Higher profit margins suggest
effective overall cost management. However, optimal margins vary by
industry: software companies routinely achieve 20\%+ margins, while
grocery stores operate on razor-thin 2-3\% margins.

\subsection{Return on Equity (ROE)}\label{return-on-equity-roe}

ROE measures how efficiently a company uses shareholders' investment to
generate profits:

\[
\text{Return on Equity} = \frac{\text{Net Income}}{\text{Total Equity}}
\]

This metric directly addresses what shareholders care about: returns on
their invested capital. Higher ROE indicates more effective use of
equity, though interpretation requires caution. High leverage can
artificially inflate ROE by reducing the equity base (e.g., a company
financed 90\% by debt will show spectacular ROE on modest profits).

\subsection{The DuPont Decomposition}\label{the-dupont-decomposition}

The DuPont framework decomposes ROE into three components that reveal
different aspects of performance:

\[
\text{ROE} = \underbrace{\frac{\text{Net Income}}{\text{Revenue}}}_{\text{Profit Margin}} \times \underbrace{\frac{\text{Revenue}}{\text{Assets}}}_{\text{Asset Turnover}} \times \underbrace{\frac{\text{Assets}}{\text{Equity}}}_{\text{Leverage}}
\]

This decomposition shows that high ROE can come from different sources:
strong profit margins (pricing power, cost control), efficient asset use
(high turnover), or aggressive leverage. Understanding which driver
dominates helps assess sustainability. ROE driven by margins is
generally more sustainable than ROE driven by leverage.

\subsection{Calculating Profitability
Ratios}\label{calculating-profitability-ratios}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{combined\_statements }\OperatorTok{=}\NormalTok{ combined\_statements.assign(}
\NormalTok{    gross\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_gross\_profit"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"is\_revenue"}\NormalTok{],}
\NormalTok{    profit\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_eat"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"is\_revenue"}\NormalTok{],}
\NormalTok{    after\_tax\_roe}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_eat"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_equity"}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Gross Margin Trends}\label{gross-margin-trends}

Figure~\ref{fig-413} tracks gross margin evolution over time, revealing
whether companies are maintaining pricing power and production
efficiency.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{gross\_margins }\OperatorTok{=}\NormalTok{ combined\_statements.query(}\StringTok{"symbol in @vn30\_symbols"}\NormalTok{)}

\NormalTok{gross\_margins\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(gross\_margins, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"gross\_margin"}\NormalTok{, color}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line()}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Gross Margin"}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Gross Margins for VN30 Stocks (2019{-}2023)"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{gross\_margins\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-413-output-1.pdf}}

}

\caption{\label{fig-413}Gross margin trends reveal changes in pricing
power and production efficiency. Declining margins may signal increased
competition or rising input costs.}

\end{figure}%

\subsection{From Gross to Net: Where Do Profits
Go?}\label{from-gross-to-net-where-do-profits-go}

Figure~\ref{fig-414} examines the relationship between gross and profit
margins. The gap between them reveals the impact of operating expenses,
interest, and taxes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{profit\_margins }\OperatorTok{=}\NormalTok{ combined\_statements.query(}\StringTok{"year == 2023"}\NormalTok{)}

\NormalTok{profit\_margins\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        profit\_margins,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"gross\_margin"}\NormalTok{, y}\OperatorTok{=}\StringTok{"profit\_margin"}\NormalTok{, color}\OperatorTok{=}\StringTok{"label"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_point(size}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_label(}
\NormalTok{        aes(label}\OperatorTok{=}\StringTok{"label"}\NormalTok{),}
\NormalTok{        adjust\_text}\OperatorTok{=}\NormalTok{\{}\StringTok{"arrowprops"}\NormalTok{: \{}\StringTok{"arrowstyle"}\NormalTok{: }\StringTok{"{-}"}\NormalTok{\}\}}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Gross Margin"}\NormalTok{, y}\OperatorTok{=}\StringTok{"Profit Margin"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Gross versus Profit Margins for VN30 Stocks (2023)"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}

\NormalTok{profit\_margins\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-414-output-1.pdf}}

}

\caption{\label{fig-414}Comparing gross and profit margins reveals how
much of gross profit survives operating expenses, interest, and taxes.
Companies far below the diagonal have high overhead relative to gross
profit.}

\end{figure}%

Companies along the diagonal convert gross profit to net income
efficiently. Those well below the diagonal face high operating costs,
interest burdens, or tax rates that erode profitability.

\section{Combining Financial Ratios: A Holistic
View}\label{combining-financial-ratios-a-holistic-view}

Individual ratios provide specific insights, but combining them offers a
more complete picture. A company might excel in profitability while
struggling with liquidity, or maintain conservative leverage while
underperforming on efficiency.

\subsection{Ranking Companies Across
Categories}\label{ranking-companies-across-categories}

Figure~\ref{fig-415} compares company rankings across four ratio
categories. Rankings closer to 1 indicate better performance within each
category, enabling quick identification of relative strengths and
weaknesses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{financial\_ratios }\OperatorTok{=}\NormalTok{ (combined\_statements}
\NormalTok{    .query(}\StringTok{"year == 2023"}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{filter}\NormalTok{(}
\NormalTok{        items}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{+}\NormalTok{ [}
\NormalTok{            col }\ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ combined\_statements.columns}
            \ControlFlowTok{if} \BuiltInTok{any}\NormalTok{(x }\KeywordTok{in}\NormalTok{ col }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ [}
                \StringTok{"ratio"}\NormalTok{, }\StringTok{"margin"}\NormalTok{, }\StringTok{"roe"}\NormalTok{, }\StringTok{"\_to\_"}\NormalTok{, }\StringTok{"turnover"}\NormalTok{, }\StringTok{"interest\_coverage"}
\NormalTok{            ])}
\NormalTok{        ]}
\NormalTok{    )}
\NormalTok{    .melt(id\_vars}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{], var\_name}\OperatorTok{=}\StringTok{"name"}\NormalTok{, value\_name}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{    .assign(}
        \BuiltInTok{type}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            [}
\NormalTok{                x[}\StringTok{"name"}\NormalTok{].isin([}\StringTok{"current\_ratio"}\NormalTok{, }\StringTok{"quick\_ratio"}\NormalTok{, }\StringTok{"cash\_ratio"}\NormalTok{]),}
\NormalTok{                x[}\StringTok{"name"}\NormalTok{].isin([}\StringTok{"debt\_to\_equity"}\NormalTok{, }\StringTok{"debt\_to\_asset"}\NormalTok{, }\StringTok{"interest\_coverage"}\NormalTok{]),}
\NormalTok{                x[}\StringTok{"name"}\NormalTok{].isin([}\StringTok{"asset\_turnover"}\NormalTok{, }\StringTok{"inventory\_turnover"}\NormalTok{, }\StringTok{"receivables\_turnover"}\NormalTok{]),}
\NormalTok{                x[}\StringTok{"name"}\NormalTok{].isin([}\StringTok{"gross\_margin"}\NormalTok{, }\StringTok{"profit\_margin"}\NormalTok{, }\StringTok{"after\_tax\_roe"}\NormalTok{]),}
\NormalTok{            ],}
\NormalTok{            [}
                \StringTok{"Liquidity Ratios"}\NormalTok{,}
                \StringTok{"Leverage Ratios"}\NormalTok{,}
                \StringTok{"Efficiency Ratios"}\NormalTok{,}
                \StringTok{"Profitability Ratios"}
\NormalTok{            ],}
\NormalTok{            default}\OperatorTok{=}\StringTok{"Other"}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{financial\_ratios[}\StringTok{"rank"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (financial\_ratios}
\NormalTok{    .sort\_values([}\StringTok{"type"}\NormalTok{, }\StringTok{"name"}\NormalTok{, }\StringTok{"value"}\NormalTok{], ascending}\OperatorTok{=}\NormalTok{[}\VariableTok{True}\NormalTok{, }\VariableTok{True}\NormalTok{, }\VariableTok{False}\NormalTok{])}
\NormalTok{    .groupby([}\StringTok{"type"}\NormalTok{, }\StringTok{"name"}\NormalTok{])}
\NormalTok{    .cumcount() }\OperatorTok{+} \DecValTok{1}
\NormalTok{)}

\NormalTok{final\_ranks }\OperatorTok{=}\NormalTok{ (financial\_ratios}
\NormalTok{    .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"type"}\NormalTok{], as\_index}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    .agg(rank}\OperatorTok{=}\NormalTok{(}\StringTok{"rank"}\NormalTok{, }\StringTok{"mean"}\NormalTok{))}
\NormalTok{    .query(}\StringTok{"symbol in @vn30\_symbols"}\NormalTok{)}
\NormalTok{)}

\NormalTok{final\_ranks\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(final\_ranks, aes(x}\OperatorTok{=}\StringTok{"rank"}\NormalTok{, y}\OperatorTok{=}\StringTok{"type"}\NormalTok{, color}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_point(shape}\OperatorTok{=}\StringTok{"\^{}"}\NormalTok{, size}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Average Rank (Lower is Better)"}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Average Rank Across Financial Ratio Categories"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ coord\_cartesian(xlim}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{30}\NormalTok{])}
\NormalTok{)}

\NormalTok{final\_ranks\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-415-output-1.pdf}}

}

\caption{\label{fig-415}Ranking companies across multiple ratio
categories reveals overall financial profiles. Companies with
consistently low ranks across categories demonstrate broad-based
financial strength.}

\end{figure}%

The combined view reveals how different business strategies manifest in
financial profiles. A company might deliberately accept lower
profitability rankings in exchange for stronger liquidity, or use
aggressive leverage to boost returns at the cost of financial
flexibility.

\section{Financial Ratios in Asset
Pricing}\label{financial-ratios-in-asset-pricing}

Beyond evaluating individual companies, financial ratios serve as
crucial inputs for asset pricing models. The Fama-French five-factor
model, which we explore in detail in
\href{12_fama_french.qmd}{Fama-French Factors}, uses several
accounting-based measures to explain cross-sectional variation in stock
returns.

\subsection{The Fama-French Factors}\label{the-fama-french-factors}

The model incorporates four company characteristics derived from
financial statements:

\textbf{Size} is measured as the logarithm of market capitalization: \[
\text{Size} = \ln(\text{Market Cap})
\]

This captures the empirical finding that smaller firms tend to
outperform larger firms on a risk-adjusted basis (i.e., the ``size
premium'').

\textbf{Book-to-Market} relates accounting value to market value: \[
\text{Book-to-Market} = \frac{\text{Book Equity}}{\text{Market Cap}}
\]

High book-to-market stocks (``value'' stocks) have historically
outperformed low book-to-market stocks (``growth'' stocks) (i.e., the
``value premium'').

\textbf{Operating Profitability} measures profit generation relative to
equity: \[
\text{Profitability} = \frac{\text{Revenue} - \text{COGS} - \text{SG\&A} - \text{Interest}}{\text{Book Equity}}
\]

More profitable firms tend to earn higher returns (i.e., the
``profitability premium'').

\textbf{Investment} captures asset growth: \[
\text{Investment} = \frac{\text{Total Assets}_t}{\text{Total Assets}_{t-1}} - 1
\] Firms investing aggressively tend to underperform conservative
investors (i.e., the ``investment premium'').

\subsection{Calculating Fama-French
Variables}\label{calculating-fama-french-variables}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM prices\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"datadate"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Use December prices for annual calculations}
\NormalTok{prices\_december }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .assign(date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.to\_datetime(x[}\StringTok{"date"}\NormalTok{]))}
\NormalTok{    .query(}\StringTok{"date.dt.month == 12"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{combined\_statements\_ff }\OperatorTok{=}\NormalTok{ (combined\_statements}
\NormalTok{    .query(}\StringTok{"year == 2023"}\NormalTok{)}
\NormalTok{    .merge(prices\_december, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{    .merge(}
\NormalTok{        (balance\_sheet\_statements}
\NormalTok{            .query(}\StringTok{"year == 2022"}\NormalTok{)}
\NormalTok{            .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"total\_asset"}\NormalTok{])}
\NormalTok{            .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"total\_asset"}\NormalTok{: }\StringTok{"total\_assets\_lag"}\NormalTok{\})}
\NormalTok{        ),}
\NormalTok{        on}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{,}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{    .assign(}
\NormalTok{        size}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.log(x[}\StringTok{"mktcap"}\NormalTok{]),}
\NormalTok{        book\_to\_market}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"total\_equity"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"mktcap"}\NormalTok{],}
\NormalTok{        operating\_profitability}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (}
\NormalTok{            (x[}\StringTok{"is\_revenue"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{"is\_cogs"}\NormalTok{] }\OperatorTok{{-}}
\NormalTok{             x[}\StringTok{"selling\_general\_and\_administrative\_expenses"}\NormalTok{] }\OperatorTok{{-}}
\NormalTok{             x[}\StringTok{"is\_interest\_expense"}\NormalTok{]) }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_equity"}\NormalTok{]}
\NormalTok{        ),}
\NormalTok{        investment}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"total\_asset"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_assets\_lag"}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{combined\_statements\_ff.head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& symbol & year & label & current\_ratio & quick\_ratio & cash\_ratio &
debt\_to\_equity & debt\_to\_asset & total\_asset & total\_equity & ...
& shrout & mktcap & mktcap\_lag & risk\_free & ret\_excess &
total\_assets\_lag & size & book\_to\_market & operating\_profitability
& investment \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & POW & 2023 & POW & 1.084255 & 1.084255 & 0.315089 & 0.0 & 0.0 &
7.036209e+13 & 3.411943e+13 & ... & 2.341872e+09 & 26346.055367 &
26346.055367 & 0.003333 & -0.003333 & 5.684324e+13 & 10.179074 &
1.295049e+09 & 0.025539 & 0.237827 \\
1 & HPG & 2023 & HPG & 1.156655 & 1.156655 & 0.171324 & 0.0 & 0.0 &
1.877826e+14 & 1.028364e+14 & ... & 5.814786e+09 & 162523.260217 &
154382.560242 & 0.003333 & 0.049397 & 1.703355e+14 & 11.998576 &
6.327489e+08 & 0.072798 & 0.102428 \\
2 & MWG & 2023 & MWG & 1.688604 & 1.688604 & 0.174408 & 0.0 & 0.0 &
6.011124e+13 & 2.335956e+13 & ... & 1.462941e+09 & 62613.896064 &
56323.247628 & 0.003333 & 0.108355 & 5.583410e+13 & 11.044743 &
3.730731e+08 & -0.002443 & 0.076604 \\
\end{longtable}

\subsection{Fama-French Factor
Rankings}\label{fama-french-factor-rankings}

Figure~\ref{fig-416} shows how VN30 companies rank on each Fama-French
variable, connecting fundamental analysis to asset pricing.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ranks }\OperatorTok{=}\NormalTok{ (combined\_statements\_ff}
\NormalTok{    .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"size"}\NormalTok{, }\StringTok{"book\_to\_market"}\NormalTok{, }\StringTok{"operating\_profitability"}\NormalTok{, }\StringTok{"investment"}\NormalTok{])}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}
        \StringTok{"size"}\NormalTok{: }\StringTok{"Size"}\NormalTok{,}
        \StringTok{"book\_to\_market"}\NormalTok{: }\StringTok{"Book{-}to{-}Market"}\NormalTok{,}
        \StringTok{"operating\_profitability"}\NormalTok{: }\StringTok{"Profitability"}\NormalTok{,}
        \StringTok{"investment"}\NormalTok{: }\StringTok{"Investment"}
\NormalTok{    \})}
\NormalTok{    .melt(id\_vars}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{], var\_name}\OperatorTok{=}\StringTok{"name"}\NormalTok{, value\_name}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        rank}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (}
\NormalTok{            x.sort\_values([}\StringTok{"name"}\NormalTok{, }\StringTok{"value"}\NormalTok{], ascending}\OperatorTok{=}\NormalTok{[}\VariableTok{True}\NormalTok{, }\VariableTok{False}\NormalTok{])}
\NormalTok{            .groupby(}\StringTok{"name"}\NormalTok{)}
\NormalTok{            .cumcount() }\OperatorTok{+} \DecValTok{1}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    .query(}\StringTok{"symbol in @vn30\_symbols"}\NormalTok{)}
\NormalTok{)}

\NormalTok{factors\_ranks\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(factors\_ranks, aes(x}\OperatorTok{=}\StringTok{"rank"}\NormalTok{, y}\OperatorTok{=}\StringTok{"name"}\NormalTok{, color}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_point(shape}\OperatorTok{=}\StringTok{"\^{}"}\NormalTok{, size}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Rank"}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Rank in Fama{-}French Variables for VN30 Stocks"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ coord\_cartesian(xlim}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{30}\NormalTok{])}
\NormalTok{)}

\NormalTok{factors\_ranks\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{04_financial_statement_analysis_files/figure-pdf/fig-416-output-1.pdf}}

}

\caption{\label{fig-416}Rankings on Fama-French variables connect
financial statement analysis to asset pricing. According to factor
models, smaller, higher book-to-market, more profitable, and
lower-investment firms should earn higher expected returns.}

\end{figure}%

These rankings have implications for expected returns according to
factor models. A small, high book-to-market, highly profitable company
with conservative investment should, in theory, earn higher
risk-adjusted returns than its opposite.

\section{Limitations and Practical
Considerations}\label{limitations-and-practical-considerations}

While financial ratios provide powerful analytical tools, several
limitations deserve attention:

\subsection{Accounting Discretion}\label{accounting-discretion}

Companies have significant discretion in how they apply accounting
standards. Revenue recognition timing, depreciation methods, inventory
valuation (FIFO vs.~LIFO), and capitalization versus expensing decisions
all affect reported numbers. Sophisticated analysis requires
understanding these choices and their impact.

\subsection{Industry Comparability}\label{industry-comparability}

Ratios vary dramatically across industries. Comparing a bank's leverage
to a retailer's is meaningless (e.g., banks naturally operate with much
higher leverage due to their business model). Always benchmark against
industry peers rather than absolute standards.

\subsection{Point-in-Time Limitations}\label{point-in-time-limitations}

Balance sheet ratios capture a single moment, which may not represent
typical conditions. Companies often ``window dress'' by temporarily
improving metrics at reporting dates. Trend analysis and
quarter-over-quarter comparisons can reveal such practices.

\subsection{Backward-Looking Nature}\label{backward-looking-nature}

Financial statements report historical results. Past profitability
doesn't guarantee future performance, especially for companies in
rapidly changing industries or facing disruption.

\subsection{Quality of Earnings}\label{quality-of-earnings}

Not all profits are created equal. Earnings driven by one-time gains,
accounting adjustments, or aggressive revenue recognition may not recur.
Cash flow analysis helps assess earnings quality. Profits that don't
convert to cash warrant skepticism.

\section{Key Takeaways}\label{key-takeaways-2}

This chapter introduced financial statement analysis as a tool for
understanding company fundamentals. The main insights are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Three statements, three perspectives}: The balance sheet shows
  financial position at a point in time, the income statement measures
  performance over a period, and the cash flow statement tracks actual
  cash movements. Together, they provide a complete picture of financial
  health.
\item
  \textbf{Liquidity ratios assess short-term survival}: Current, quick,
  and cash ratios measure the ability to meet near-term obligations.
  Higher ratios indicate greater liquidity but may suggest inefficient
  asset use.
\item
  \textbf{Leverage ratios reveal capital structure risk}:
  Debt-to-equity, debt-to-asset, and interest coverage ratios show how
  the company finances operations and whether it can service its debt.
  Higher leverage amplifies both returns and risk.
\item
  \textbf{Efficiency ratios measure management effectiveness}: Asset
  turnover, inventory turnover, and receivables turnover reveal how well
  the company converts resources into revenue. Industry context is
  essential for interpretation.
\item
  \textbf{Profitability ratios quantify financial success}: Gross
  margin, profit margin, and ROE measure the ability to generate
  earnings. The DuPont decomposition reveals whether ROE comes from
  margins, turnover, or leverage.
\item
  \textbf{Ratios connect to asset pricing}: Financial statement
  variables like book-to-market, profitability, and investment form the
  basis of factor models that explain cross-sectional return
  differences.
\item
  \textbf{Context matters for interpretation}: Ratios must be compared
  against industry peers, tracked over time, and considered alongside
  qualitative factors. No single ratio tells the complete story.
\end{enumerate}

Looking ahead, subsequent chapters will explore how these fundamental
variables interact with market prices in asset pricing models, and how
to construct factor portfolios based on financial statement
characteristics.

\bookmarksetup{startatroot}

\chapter{Discounted Cash Flow
Analysis}\label{discounted-cash-flow-analysis}

\section{What Is a Company Worth?}\label{what-is-a-company-worth}

The previous chapters examined how markets price securities in
equilibrium and how financial statements reveal company fundamentals.
But these approaches leave a central question unanswered: What is the
\emph{intrinsic value} of a business, independent of its current market
price?

Discounted Cash Flow (DCF) analysis answers this question by valuing a
company based on its ability to generate cash for investors. The core
insight is simple: a business is worth the present value of all future
cash it will produce. This principle that value equals discounted future
cash flows underlies virtually all of finance, from bond pricing to real
estate valuation.

DCF analysis stands apart from other valuation approaches in three
important ways. First, it explicitly accounts for the \textbf{time value
of money} (i.e., the principle that a dollar today is worth more than a
dollar tomorrow). By discounting future cash flows at an appropriate
rate, we incorporate both time preferences and risk. Second, DCF is
\textbf{forward-looking}, making it particularly suitable for companies
where historical performance may not reflect future potential. Third,
DCF is \textbf{flexible} enough to accommodate various business models
and capital structures, making it applicable across industries and
company sizes.

\subsection{Valuation Methods
Overview}\label{valuation-methods-overview}

Company valuation methods broadly fall into three categories:

\begin{itemize}
\tightlist
\item
  \textbf{Market-based approaches} compare companies using relative
  metrics like Price-to-Earnings or EV/EBITDA ratios. These are quick
  but assume comparable companies are fairly valued.
\item
  \textbf{Asset-based methods} focus on the net value of tangible and
  intangible assets. These work well for liquidation scenarios but miss
  going-concern value.
\item
  \textbf{Income-based techniques} value companies based on their
  ability to generate future cash flows. DCF is the most rigorous
  income-based method.
\end{itemize}

We focus on DCF because it forces analysts to make explicit assumptions
about growth, profitability, and risk. These assumptions are often
hidden in other methods. Even when DCF isn't the final word on
valuation, the discipline of building a DCF model deepens understanding
of what drives value.

\subsection{The Three Pillars of DCF}\label{the-three-pillars-of-dcf}

Every DCF analysis rests on three components:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Free Cash Flow (FCF) forecasts}: The expected future cash
  available for distribution to investors after operating expenses,
  taxes, and investments
\item
  \textbf{Terminal value}: The company's value beyond the explicit
  forecast period, often representing a majority of total valuation
\item
  \textbf{Discount rate}: Typically the Weighted Average Cost of Capital
  (WACC), which adjusts future cash flows to present value by
  incorporating risk and capital structure
\end{enumerate}

We make simplifying assumptions throughout this chapter. In particular,
we assume firms conduct only operating activities (i.e., financial
statements do not include non-operating items like excess cash or
investment securities). Real-world valuations require valuing these
separately. Entire textbooks are devoted to valuation nuances; our goal
is to establish the conceptual framework and practical implementation.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format, comma\_format}
\ImportTok{from}\NormalTok{ itertools }\ImportTok{import}\NormalTok{ product}
\end{Highlighting}
\end{Shaded}

\section{Understanding Free Cash
Flow}\label{understanding-free-cash-flow}

Before diving into calculations, we need to understand what Free Cash
Flow represents and why it matters for valuation.

\subsection{Why Free Cash Flow, Not Net
Income?}\label{why-free-cash-flow-not-net-income}

Accountants report net income, but DCF uses free cash flow. Why the
difference?

Net income includes non-cash items (like depreciation) and ignores cash
needs (like capital expenditures and working capital investments). A
company can report strong profits while burning cash, or generate
substantial cash while reporting losses. Free cash flow captures what
actually matters for valuation: the cash available to distribute to all
capital providers (both debt holders and equity holders) after funding
operations and investments.

\subsection{The Free Cash Flow
Formula}\label{the-free-cash-flow-formula}

We calculate FCF using the following formula:

\[
\text{FCF} = \text{EBIT} \times (1 - \tau) + \text{D\&A} - \Delta\text{WC} - \text{CAPEX}
\]

where:

\begin{itemize}
\tightlist
\item
  \textbf{EBIT} (Earnings Before Interest and Taxes): Core operating
  profit before financing costs and taxes
\item
  \textbf{\(\tau\)}: Corporate tax rate applied to operating profits
\item
  \textbf{D\&A} (Depreciation \& Amortization): Non-cash charges that
  reduce reported earnings but don't consume cash
\item
  \textbf{\(\Delta\)WC} (Change in Working Capital): Cash tied up in (or
  released from) operations (increases in receivables and inventory
  consume cash, while increases in payables provide cash)
\item
  \textbf{CAPEX} (Capital Expenditures): Investments in long-term assets
  required to maintain and grow operations
\end{itemize}

An alternative formulation starts from EBIT directly:

\[
\text{FCF} = \text{EBIT} + \text{D\&A} - \text{Taxes} - \Delta\text{WC} - \text{CAPEX}
\]

Both formulations yield the same result when taxes are calculated
consistently. The key insight is that FCF represents cash generated from
operations after all reinvestment needs (i.e., cash that could
theoretically be distributed to investors without impairing the
business).

\section{Loading Historical Financial
Data}\label{loading-historical-financial-data}

We use FPT Corporation, one of Vietnam's largest technology companies,
as our case study. FPT provides IT services, telecommunications, and
education. It's a diversified business with meaningful capital
requirements and growth potential.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ sqlite3}

\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM comp\_vn"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Filter to FPT and examine the data structure}
\NormalTok{fpt\_data }\OperatorTok{=}\NormalTok{ comp\_vn[comp\_vn[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{==} \StringTok{"FPT"}\NormalTok{].copy()}
\NormalTok{fpt\_data[}\StringTok{"year"}\NormalTok{] }\OperatorTok{=}\NormalTok{ fpt\_data[}\StringTok{"year"}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{fpt\_data }\OperatorTok{=}\NormalTok{ fpt\_data.sort\_values(}\StringTok{"year"}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Available years: }\SpecialCharTok{\{}\NormalTok{fpt\_data[}\StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{fpt\_data[}\StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Number of observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(fpt\_data)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Available years: 2002 to 2023
Number of observations: 22
\end{verbatim}

\subsection{Computing Historical Free Cash
Flow}\label{computing-historical-free-cash-flow}

Let's calculate the components needed for FCF from the financial
statement data:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extract and compute FCF components}
\NormalTok{historical\_data }\OperatorTok{=}\NormalTok{ (fpt\_data}
\NormalTok{    .assign(}
        \CommentTok{\# Revenue for ratio calculations}
\NormalTok{        revenue}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_net\_revenue"}\NormalTok{],}
        
        \CommentTok{\# EBIT = Earnings before interest and taxes}
        \CommentTok{\# Approximate as EBT + Interest Expense}
\NormalTok{        ebit}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_ebt"}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{"is\_interest\_expense"}\NormalTok{],}
        
        \CommentTok{\# Tax payments (use actual tax expense)}
\NormalTok{        taxes}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"is\_cit\_expense"}\NormalTok{],}
        
        \CommentTok{\# Depreciation and amortization (non{-}cash add{-}back)}
\NormalTok{        depreciation}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"cfo\_depreciation"}\NormalTok{],}
        
        \CommentTok{\# Change in working capital components}
        \CommentTok{\# Positive delta\_wc means cash is consumed (tied up in working capital)}
\NormalTok{        delta\_working\_capital}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (}
\NormalTok{            x[}\StringTok{"cfo\_receive"}\NormalTok{] }\OperatorTok{+}      \CommentTok{\# Change in receivables}
\NormalTok{            x[}\StringTok{"cfo\_inventory"}\NormalTok{] }\OperatorTok{{-}}    \CommentTok{\# Change in inventory  }
\NormalTok{            x[}\StringTok{"cfo\_payale"}\NormalTok{]         }\CommentTok{\# Change in payables (negative = cash source)}
\NormalTok{        ),}
        
        \CommentTok{\# Capital expenditures}
\NormalTok{        capex}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"capex"}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .loc[:, [}
        \StringTok{"year"}\NormalTok{, }\StringTok{"revenue"}\NormalTok{, }\StringTok{"ebit"}\NormalTok{, }\StringTok{"taxes"}\NormalTok{, }\StringTok{"depreciation"}\NormalTok{,}
        \StringTok{"delta\_working\_capital"}\NormalTok{, }\StringTok{"capex"}
\NormalTok{    ]]}
\NormalTok{)}

\CommentTok{\# Calculate Free Cash Flow}
\NormalTok{historical\_data[}\StringTok{"fcf"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    historical\_data[}\StringTok{"ebit"}\NormalTok{] }
    \OperatorTok{{-}}\NormalTok{ historical\_data[}\StringTok{"taxes"}\NormalTok{]}
    \OperatorTok{+}\NormalTok{ historical\_data[}\StringTok{"depreciation"}\NormalTok{]}
    \OperatorTok{{-}}\NormalTok{ historical\_data[}\StringTok{"delta\_working\_capital"}\NormalTok{]}
    \OperatorTok{{-}}\NormalTok{ historical\_data[}\StringTok{"capex"}\NormalTok{]}
\NormalTok{)}

\NormalTok{historical\_data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& year & revenue & ebit & taxes & depreciation & delta\_working\_capital
& capex & fcf \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2002 & 1.514961e+12 & 2.698700e+10 & 0.000000e+00 & 1.261500e+10 &
-2.561760e+11 & 2.202800e+10 & 2.737500e+11 \\
1 & 2003 & 4.148298e+12 & 5.676100e+10 & 0.000000e+00 & 1.837700e+10 &
-5.078740e+11 & 3.753300e+10 & 5.454790e+11 \\
2 & 2004 & 8.734781e+12 & 2.145902e+11 & 1.795700e+10 & 2.947900e+10 &
-4.280270e+11 & 5.252100e+10 & 6.016182e+11 \\
3 & 2005 & 1.410079e+13 & 3.753490e+11 & 4.251500e+10 & 5.381700e+10 &
-4.471110e+11 & 1.428320e+11 & 6.909300e+11 \\
4 & 2006 & 2.139975e+13 & 6.672593e+11 & 7.368682e+10 & 1.068192e+11 &
-1.173099e+12 & 2.459780e+11 & 1.627513e+12 \\
5 & 2007 & 1.349889e+13 & 1.071941e+12 & 1.487146e+11 & 1.709335e+11 &
-1.873794e+12 & 4.802762e+11 & 2.487677e+12 \\
6 & 2008 & 1.638184e+13 & 1.320573e+12 & 1.890384e+11 & 2.395799e+11 &
-1.419506e+11 & 6.690461e+11 & 8.440192e+11 \\
7 & 2009 & 1.840403e+13 & 1.807221e+12 & 2.916482e+11 & 3.041813e+11 &
-8.065011e+11 & 7.632280e+11 & 1.863027e+12 \\
8 & 2010 & 2.001730e+13 & 2.261341e+12 & 3.314359e+11 & 3.294060e+11 &
-2.360993e+12 & 8.672138e+11 & 3.753090e+12 \\
9 & 2011 & 2.537025e+13 & 2.751044e+12 & 4.223952e+11 & 3.759567e+11 &
-2.099380e+12 & 4.524081e+11 & 4.351578e+12 \\
10 & 2012 & 2.459430e+13 & 2.635219e+12 & 4.210738e+11 & 3.995598e+11 &
8.043763e+11 & 7.083318e+11 & 1.100997e+12 \\
11 & 2013 & 2.702789e+13 & 2.690568e+12 & 4.503170e+11 & 4.429860e+11 &
-1.947751e+12 & 9.110216e+11 & 3.719967e+12 \\
12 & 2014 & 3.264466e+13 & 2.625389e+12 & 3.800994e+11 & 5.472736e+11 &
-3.078130e+12 & 1.417399e+12 & 4.453295e+12 \\
13 & 2015 & 3.795970e+13 & 3.113651e+12 & 4.130641e+11 & 7.328801e+11 &
-1.951778e+12 & 1.974295e+12 & 3.410951e+12 \\
14 & 2016 & 3.953147e+13 & 3.388085e+12 & 4.382078e+11 & 9.334397e+11 &
-9.242713e+11 & 1.428472e+12 & 3.379116e+12 \\
15 & 2017 & 4.265861e+13 & 4.623663e+12 & 7.270039e+11 & 1.039417e+12 &
-4.638788e+12 & 1.100498e+12 & 8.474367e+12 \\
16 & 2018 & 2.321354e+13 & 4.095947e+12 & 6.236054e+11 & 1.164692e+12 &
-1.033438e+12 & 2.452902e+12 & 3.217569e+12 \\
17 & 2019 & 2.771696e+13 & 5.023518e+12 & 7.528183e+11 & 1.354613e+12 &
-5.308818e+11 & 3.230818e+12 & 2.925377e+12 \\
18 & 2020 & 2.983040e+13 & 5.648794e+12 & 8.397114e+11 & 1.490607e+12 &
-8.040730e+11 & 3.014322e+12 & 4.089441e+12 \\
19 & 2021 & 3.565726e+13 & 6.821202e+12 & 9.879053e+11 & 1.643916e+12 &
-2.821825e+12 & 2.908134e+12 & 7.390903e+12 \\
20 & 2022 & 4.400953e+13 & 8.308009e+12 & 1.170940e+12 & 1.833064e+12 &
-3.746661e+12 & 3.209581e+12 & 9.507213e+12 \\
21 & 2023 & 5.261790e+13 & 1.003565e+13 & 1.414956e+12 & 2.286514e+12 &
-2.147304e+12 & 3.948982e+12 & 9.105534e+12 \\
\end{longtable}

\subsection{Understanding the Historical
Pattern}\label{understanding-the-historical-pattern}

Before forecasting, we should understand the historical trends in FCF
and its components:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Calculate key ratios relative to revenue}
\NormalTok{historical\_ratios }\OperatorTok{=}\NormalTok{ (historical\_data}
\NormalTok{    .assign(}
        \CommentTok{\# Revenue growth (year{-}over{-}year)}
\NormalTok{        revenue\_growth}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"revenue"}\NormalTok{].pct\_change(),}
        
        \CommentTok{\# Operating margin: EBIT as \% of revenue}
\NormalTok{        operating\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ebit"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{],}
        
        \CommentTok{\# Depreciation as \% of revenue}
\NormalTok{        depreciation\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"depreciation"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{],}
        
        \CommentTok{\# Tax rate (taxes as \% of revenue, for simplicity)}
\NormalTok{        tax\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"taxes"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{],}
        
        \CommentTok{\# Working capital intensity}
\NormalTok{        working\_capital\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"delta\_working\_capital"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{],}
        
        \CommentTok{\# Capital intensity}
\NormalTok{        capex\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"capex"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{],}
        
        \CommentTok{\# FCF margin}
\NormalTok{        fcf\_margin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"fcf"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"revenue"}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\CommentTok{\# Display key metrics}
\NormalTok{display\_cols }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"year"}\NormalTok{, }\StringTok{"revenue\_growth"}\NormalTok{, }\StringTok{"operating\_margin"}\NormalTok{, }\StringTok{"depreciation\_margin"}\NormalTok{,}
    \StringTok{"tax\_margin"}\NormalTok{, }\StringTok{"working\_capital\_margin"}\NormalTok{, }\StringTok{"capex\_margin"}\NormalTok{, }\StringTok{"fcf\_margin"}
\NormalTok{]}

\NormalTok{historical\_ratios[display\_cols].}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& year & revenue\_growth & operating\_margin & depreciation\_margin &
tax\_margin & working\_capital\_margin & capex\_margin & fcf\_margin \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2002 & NaN & 0.018 & 0.008 & 0.000 & -0.169 & 0.015 & 0.181 \\
1 & 2003 & 1.738 & 0.014 & 0.004 & 0.000 & -0.122 & 0.009 & 0.131 \\
2 & 2004 & 1.106 & 0.025 & 0.003 & 0.002 & -0.049 & 0.006 & 0.069 \\
3 & 2005 & 0.614 & 0.027 & 0.004 & 0.003 & -0.032 & 0.010 & 0.049 \\
4 & 2006 & 0.518 & 0.031 & 0.005 & 0.003 & -0.055 & 0.011 & 0.076 \\
5 & 2007 & -0.369 & 0.079 & 0.013 & 0.011 & -0.139 & 0.036 & 0.184 \\
6 & 2008 & 0.214 & 0.081 & 0.015 & 0.012 & -0.009 & 0.041 & 0.052 \\
7 & 2009 & 0.123 & 0.098 & 0.017 & 0.016 & -0.044 & 0.041 & 0.101 \\
8 & 2010 & 0.088 & 0.113 & 0.016 & 0.017 & -0.118 & 0.043 & 0.187 \\
9 & 2011 & 0.267 & 0.108 & 0.015 & 0.017 & -0.083 & 0.018 & 0.172 \\
10 & 2012 & -0.031 & 0.107 & 0.016 & 0.017 & 0.033 & 0.029 & 0.045 \\
11 & 2013 & 0.099 & 0.100 & 0.016 & 0.017 & -0.072 & 0.034 & 0.138 \\
12 & 2014 & 0.208 & 0.080 & 0.017 & 0.012 & -0.094 & 0.043 & 0.136 \\
13 & 2015 & 0.163 & 0.082 & 0.019 & 0.011 & -0.051 & 0.052 & 0.090 \\
14 & 2016 & 0.041 & 0.086 & 0.024 & 0.011 & -0.023 & 0.036 & 0.085 \\
15 & 2017 & 0.079 & 0.108 & 0.024 & 0.017 & -0.109 & 0.026 & 0.199 \\
16 & 2018 & -0.456 & 0.176 & 0.050 & 0.027 & -0.045 & 0.106 & 0.139 \\
17 & 2019 & 0.194 & 0.181 & 0.049 & 0.027 & -0.019 & 0.117 & 0.106 \\
18 & 2020 & 0.076 & 0.189 & 0.050 & 0.028 & -0.027 & 0.101 & 0.137 \\
19 & 2021 & 0.195 & 0.191 & 0.046 & 0.028 & -0.079 & 0.082 & 0.207 \\
20 & 2022 & 0.234 & 0.189 & 0.042 & 0.027 & -0.085 & 0.073 & 0.216 \\
21 & 2023 & 0.196 & 0.191 & 0.043 & 0.027 & -0.041 & 0.075 & 0.173 \\
\end{longtable}

\section{Visualizing Historical
Ratios}\label{visualizing-historical-ratios}

Figure~\ref{fig-500} shows the historical evolution of key financial
ratios that drive FCF. Understanding these patterns helps inform our
forecasts.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Prepare data for plotting}
\NormalTok{ratio\_columns }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"operating\_margin"}\NormalTok{, }\StringTok{"depreciation\_margin"}\NormalTok{, }\StringTok{"tax\_margin"}\NormalTok{,}
    \StringTok{"working\_capital\_margin"}\NormalTok{, }\StringTok{"capex\_margin"}
\NormalTok{]}

\NormalTok{ratios\_long }\OperatorTok{=}\NormalTok{ (historical\_ratios}
\NormalTok{    .melt(}
\NormalTok{        id\_vars}\OperatorTok{=}\NormalTok{[}\StringTok{"year"}\NormalTok{],}
\NormalTok{        value\_vars}\OperatorTok{=}\NormalTok{ratio\_columns,}
\NormalTok{        var\_name}\OperatorTok{=}\StringTok{"ratio"}\NormalTok{,}
\NormalTok{        value\_name}\OperatorTok{=}\StringTok{"value"}
\NormalTok{    )}
\NormalTok{    .assign(}
\NormalTok{        ratio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"ratio"}\NormalTok{].}\BuiltInTok{str}\NormalTok{.replace(}\StringTok{"\_"}\NormalTok{, }\StringTok{" "}\NormalTok{).}\BuiltInTok{str}\NormalTok{.title()}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ratios\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(ratios\_long, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"value"}\NormalTok{, color}\OperatorTok{=}\StringTok{"ratio"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_point(size}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Ratio (}\SpecialCharTok{\% o}\StringTok{f Revenue)"}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Key Financial Ratios of FPT Over Time"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"right"}\NormalTok{)}
\NormalTok{)}

\NormalTok{ratios\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{05_discounted_cash_flow_files/figure-pdf/fig-500-output-1.pdf}}

}

\caption{\label{fig-500}Historical financial ratios reveal the operating
characteristics of FPT. These patterns inform our forecast assumptions.}

\end{figure}%

Several patterns emerge from the historical data. Operating margins show
the profitability of core operations. Depreciation margins indicate
asset intensity. CAPEX margins reveal investment requirements. Working
capital margins can be volatile, reflecting changes in credit terms and
inventory management.

\section{Forecasting Free Cash Flow}\label{forecasting-free-cash-flow}

With historical patterns established, we now project FCF into the
future. This requires forecasting both revenue growth and the ratios
that convert revenue into cash flow.

\subsection{The Ratio-Based Forecasting
Approach}\label{the-ratio-based-forecasting-approach}

We use a ratio-based approach that links all FCF components to revenue.
This makes forecasting tractable: rather than projecting absolute dollar
amounts for each component, we forecast (1) revenue growth and (2) how
each component scales with revenue.

This approach embeds a key assumption: that the relationship between
revenue and FCF components remains stable. In reality, operating
leverage, investment needs, and working capital requirements may change
as companies mature. Sophisticated valuations model these dynamics
explicitly.

\subsection{Setting Forecast
Assumptions}\label{setting-forecast-assumptions}

For our five-year forecast, we make the following assumptions about
FPT's financial ratios. These should reflect industry analysis, company
guidance, and competitive dynamics. Here we use estimates for
illustration:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define the forecast horizon}
\NormalTok{last\_historical\_year }\OperatorTok{=}\NormalTok{ historical\_data[}\StringTok{"year"}\NormalTok{].}\BuiltInTok{max}\NormalTok{()}
\NormalTok{forecast\_years }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(last\_historical\_year }\OperatorTok{+} \DecValTok{1}\NormalTok{, last\_historical\_year }\OperatorTok{+} \DecValTok{6}\NormalTok{))}
\NormalTok{n\_forecast\_years }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(forecast\_years)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Forecast period: }\SpecialCharTok{\{}\NormalTok{forecast\_years[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{forecast\_years[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}

\CommentTok{\# Define forecast ratios}
\CommentTok{\# In practice, these would come from detailed analysis}
\NormalTok{forecast\_assumptions }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{"year"}\NormalTok{: forecast\_years,}
    \CommentTok{\# Operating margin: slight improvement as scale increases}
    \StringTok{"operating\_margin"}\NormalTok{: [}\FloatTok{0.12}\NormalTok{, }\FloatTok{0.125}\NormalTok{, }\FloatTok{0.13}\NormalTok{, }\FloatTok{0.13}\NormalTok{, }\FloatTok{0.135}\NormalTok{],}
    \CommentTok{\# Depreciation: stable as \% of revenue}
    \StringTok{"depreciation\_margin"}\NormalTok{: [}\FloatTok{0.03}\NormalTok{, }\FloatTok{0.03}\NormalTok{, }\FloatTok{0.03}\NormalTok{, }\FloatTok{0.028}\NormalTok{, }\FloatTok{0.028}\NormalTok{],}
    \CommentTok{\# Tax rate: stable}
    \StringTok{"tax\_margin"}\NormalTok{: [}\FloatTok{0.02}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.02}\NormalTok{, }\FloatTok{0.02}\NormalTok{],}
    \CommentTok{\# Working capital: modest cash consumption}
    \StringTok{"working\_capital\_margin"}\NormalTok{: [}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{, }\FloatTok{0.008}\NormalTok{, }\FloatTok{0.008}\NormalTok{, }\FloatTok{0.008}\NormalTok{],}
    \CommentTok{\# CAPEX: declining as \% of revenue as growth moderates}
    \StringTok{"capex\_margin"}\NormalTok{: [}\FloatTok{0.05}\NormalTok{, }\FloatTok{0.048}\NormalTok{, }\FloatTok{0.045}\NormalTok{, }\FloatTok{0.042}\NormalTok{, }\FloatTok{0.04}\NormalTok{]}
\NormalTok{\})}

\NormalTok{forecast\_assumptions}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Forecast period: 2024 to 2028
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& year & operating\_margin & depreciation\_margin & tax\_margin &
working\_capital\_margin & capex\_margin \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2024 & 0.120 & 0.030 & 0.02 & 0.010 & 0.050 \\
1 & 2025 & 0.125 & 0.030 & 0.02 & 0.010 & 0.048 \\
2 & 2026 & 0.130 & 0.030 & 0.02 & 0.008 & 0.045 \\
3 & 2027 & 0.130 & 0.028 & 0.02 & 0.008 & 0.042 \\
4 & 2028 & 0.135 & 0.028 & 0.02 & 0.008 & 0.040 \\
\end{longtable}

\subsection{Forecasting Revenue
Growth}\label{forecasting-revenue-growth}

Revenue growth is often the most important and most uncertain assumption
in DCF analysis. We demonstrate two approaches: using historical
averages and linking growth to macroeconomic forecasts.

\textbf{Approach 1: Historical Average}

A simple approach uses the historical average growth rate:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{historical\_growth }\OperatorTok{=}\NormalTok{ historical\_ratios[}\StringTok{"revenue\_growth"}\NormalTok{].dropna()}
\NormalTok{avg\_historical\_growth }\OperatorTok{=}\NormalTok{ historical\_growth.mean()}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Average historical revenue growth: }\SpecialCharTok{\{}\NormalTok{avg\_historical\_growth}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Average historical revenue growth: 25.2%
\end{verbatim}

\textbf{Approach 2: GDP-Linked Growth}

A more sophisticated approach links company growth to GDP forecasts from
institutions like the IMF. This captures the intuition that company
revenues often move with broader economic activity.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Vietnam GDP growth forecasts (illustrative, based on IMF WEO style projections)}
\CommentTok{\# In practice, download from IMF WEO database}
\NormalTok{gdp\_forecasts }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{"year"}\NormalTok{: forecast\_years,}
    \StringTok{"gdp\_growth"}\NormalTok{: [}\FloatTok{0.065}\NormalTok{, }\FloatTok{0.063}\NormalTok{, }\FloatTok{0.060}\NormalTok{, }\FloatTok{0.058}\NormalTok{, }\FloatTok{0.055}\NormalTok{]  }\CommentTok{\# Gradually declining to long{-}term}
\NormalTok{\})}

\CommentTok{\# Assume FPT grows at a premium to GDP (tech sector outperformance)}
\CommentTok{\# This premium should reflect company{-}specific factors}
\NormalTok{growth\_premium }\OperatorTok{=} \FloatTok{0.05}  \CommentTok{\# 5 percentage points above GDP}

\NormalTok{forecast\_assumptions }\OperatorTok{=}\NormalTok{ forecast\_assumptions.merge(gdp\_forecasts, on}\OperatorTok{=}\StringTok{"year"}\NormalTok{)}
\NormalTok{forecast\_assumptions[}\StringTok{"revenue\_growth"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    forecast\_assumptions[}\StringTok{"gdp\_growth"}\NormalTok{] }\OperatorTok{+}\NormalTok{ growth\_premium}
\NormalTok{)}

\NormalTok{forecast\_assumptions[[}\StringTok{"year"}\NormalTok{, }\StringTok{"gdp\_growth"}\NormalTok{, }\StringTok{"revenue\_growth"}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& year & gdp\_growth & revenue\_growth \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2024 & 0.065 & 0.115 \\
1 & 2025 & 0.063 & 0.113 \\
2 & 2026 & 0.060 & 0.110 \\
3 & 2027 & 0.058 & 0.108 \\
4 & 2028 & 0.055 & 0.105 \\
\end{longtable}

\subsection{Building the Forecast}\label{building-the-forecast}

Now we combine our assumptions to project revenue and FCF:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get the last historical revenue as our starting point}
\NormalTok{last\_revenue }\OperatorTok{=}\NormalTok{ historical\_data.loc[}
\NormalTok{    historical\_data[}\StringTok{"year"}\NormalTok{] }\OperatorTok{==}\NormalTok{ last\_historical\_year, }\StringTok{"revenue"}
\NormalTok{].values[}\DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Last historical revenue (}\SpecialCharTok{\{}\NormalTok{last\_historical\_year}\SpecialCharTok{\}}\SpecialStringTok{): }\SpecialCharTok{\{}\NormalTok{last\_revenue}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.2f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}

\CommentTok{\# Project revenue forward}
\NormalTok{forecast\_data }\OperatorTok{=}\NormalTok{ forecast\_assumptions.copy()}
\NormalTok{forecast\_data[}\StringTok{"revenue"}\NormalTok{] }\OperatorTok{=} \VariableTok{None}

\CommentTok{\# Calculate revenue for each forecast year}
\ControlFlowTok{for}\NormalTok{ i, row }\KeywordTok{in}\NormalTok{ forecast\_data.iterrows():}
    \ControlFlowTok{if}\NormalTok{ i }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \CommentTok{\# First forecast year: grow from last historical}
\NormalTok{        forecast\_data.loc[i, }\StringTok{"revenue"}\NormalTok{] }\OperatorTok{=}\NormalTok{ last\_revenue }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ row[}\StringTok{"revenue\_growth"}\NormalTok{])}
    \ControlFlowTok{else}\NormalTok{:}
        \CommentTok{\# Subsequent years: grow from previous forecast}
\NormalTok{        prev\_revenue }\OperatorTok{=}\NormalTok{ forecast\_data.loc[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\StringTok{"revenue"}\NormalTok{]}
\NormalTok{        forecast\_data.loc[i, }\StringTok{"revenue"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prev\_revenue }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ row[}\StringTok{"revenue\_growth"}\NormalTok{])}

\CommentTok{\# Convert revenue to numeric}
\NormalTok{forecast\_data[}\StringTok{"revenue"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{].astype(}\BuiltInTok{float}\NormalTok{)}

\CommentTok{\# Calculate FCF components from ratios}
\NormalTok{forecast\_data[}\StringTok{"ebit"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"operating\_margin"}\NormalTok{] }\OperatorTok{*}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{]}
\NormalTok{forecast\_data[}\StringTok{"depreciation"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"depreciation\_margin"}\NormalTok{] }\OperatorTok{*}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{]}
\NormalTok{forecast\_data[}\StringTok{"taxes"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"tax\_margin"}\NormalTok{] }\OperatorTok{*}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{]}
\NormalTok{forecast\_data[}\StringTok{"delta\_working\_capital"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"working\_capital\_margin"}\NormalTok{] }\OperatorTok{*}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{]}
\NormalTok{forecast\_data[}\StringTok{"capex"}\NormalTok{] }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"capex\_margin"}\NormalTok{] }\OperatorTok{*}\NormalTok{ forecast\_data[}\StringTok{"revenue"}\NormalTok{]}

\CommentTok{\# Calculate FCF}
\NormalTok{forecast\_data[}\StringTok{"fcf"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    forecast\_data[}\StringTok{"ebit"}\NormalTok{]}
    \OperatorTok{{-}}\NormalTok{ forecast\_data[}\StringTok{"taxes"}\NormalTok{]}
    \OperatorTok{+}\NormalTok{ forecast\_data[}\StringTok{"depreciation"}\NormalTok{]}
    \OperatorTok{{-}}\NormalTok{ forecast\_data[}\StringTok{"delta\_working\_capital"}\NormalTok{]}
    \OperatorTok{{-}}\NormalTok{ forecast\_data[}\StringTok{"capex"}\NormalTok{]}
\NormalTok{)}

\NormalTok{forecast\_data[[}\StringTok{"year"}\NormalTok{, }\StringTok{"revenue"}\NormalTok{, }\StringTok{"ebit"}\NormalTok{, }\StringTok{"fcf"}\NormalTok{]].}\BuiltInTok{round}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Last historical revenue (2023): 52.62 trillion VND
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & revenue & ebit & fcf \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 2024 & 5.866896e+13 & 7.040275e+12 & 4.106827e+12 \\
1 & 2025 & 6.529855e+13 & 8.162319e+12 & 5.027988e+12 \\
2 & 2026 & 7.248139e+13 & 9.422581e+12 & 6.305881e+12 \\
3 & 2027 & 8.030938e+13 & 1.044022e+13 & 7.067226e+12 \\
4 & 2028 & 8.874187e+13 & 1.198015e+13 & 8.430477e+12 \\
\end{longtable}

\section{Visualizing the Forecast}\label{visualizing-the-forecast}

Figure~\ref{fig-501} compares our forecast ratios with historical
values, showing the transition from realized to projected performance.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Prepare historical data for plotting}
\NormalTok{historical\_plot }\OperatorTok{=}\NormalTok{ (historical\_ratios}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"operating\_margin"}\NormalTok{, }\StringTok{"depreciation\_margin"}\NormalTok{, }
             \StringTok{"tax\_margin"}\NormalTok{, }\StringTok{"working\_capital\_margin"}\NormalTok{, }\StringTok{"capex\_margin"}\NormalTok{]]}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Historical"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Prepare forecast data for plotting}
\NormalTok{forecast\_plot }\OperatorTok{=}\NormalTok{ (forecast\_data}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"operating\_margin"}\NormalTok{, }\StringTok{"depreciation\_margin"}\NormalTok{,}
             \StringTok{"tax\_margin"}\NormalTok{, }\StringTok{"working\_capital\_margin"}\NormalTok{, }\StringTok{"capex\_margin"}\NormalTok{]]}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Forecast"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Combine}
\NormalTok{combined\_ratios }\OperatorTok{=}\NormalTok{ pd.concat([historical\_plot, forecast\_plot], ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\CommentTok{\# Reshape for plotting}
\NormalTok{combined\_long }\OperatorTok{=}\NormalTok{ combined\_ratios.melt(}
\NormalTok{    id\_vars}\OperatorTok{=}\NormalTok{[}\StringTok{"year"}\NormalTok{, }\StringTok{"type"}\NormalTok{],}
\NormalTok{    var\_name}\OperatorTok{=}\StringTok{"ratio"}\NormalTok{,}
\NormalTok{    value\_name}\OperatorTok{=}\StringTok{"value"}
\NormalTok{)}

\NormalTok{combined\_long[}\StringTok{"type"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{    combined\_long[}\StringTok{"type"}\NormalTok{], }
\NormalTok{    categories}\OperatorTok{=}\NormalTok{[}\StringTok{"Historical"}\NormalTok{, }\StringTok{"Forecast"}\NormalTok{]}
\NormalTok{)}

\NormalTok{forecast\_ratios\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(combined\_long, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"value"}\NormalTok{, color}\OperatorTok{=}\StringTok{"ratio"}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"type"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_point(size}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Ratio (}\SpecialCharTok{\% o}\StringTok{f Revenue)"}\NormalTok{, color}\OperatorTok{=}\StringTok{""}\NormalTok{, linetype}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Historical and Forecast Financial Ratios for FPT"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"right"}\NormalTok{)}
\NormalTok{)}

\NormalTok{forecast\_ratios\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{05_discounted_cash_flow_files/figure-pdf/fig-501-output-1.pdf}}

}

\caption{\label{fig-501}Historical ratios (solid lines) and forecast
assumptions (dashed lines) for key financial metrics. The forecast
period begins after the last historical observation.}

\end{figure}%

Figure~\ref{fig-502} shows the revenue growth trajectory, comparing
historical performance with our GDP-linked forecasts.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Prepare growth data}
\NormalTok{historical\_growth\_df }\OperatorTok{=}\NormalTok{ (historical\_ratios}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"revenue\_growth"}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Historical"}\NormalTok{)}
\NormalTok{)}

\NormalTok{forecast\_growth\_df }\OperatorTok{=}\NormalTok{ (forecast\_data}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"revenue\_growth"}\NormalTok{, }\StringTok{"gdp\_growth"}\NormalTok{]]}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Forecast"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Combine for revenue growth}
\NormalTok{growth\_combined }\OperatorTok{=}\NormalTok{ pd.concat([}
\NormalTok{    historical\_growth\_df,}
\NormalTok{    forecast\_growth\_df[[}\StringTok{"year"}\NormalTok{, }\StringTok{"revenue\_growth"}\NormalTok{, }\StringTok{"type"}\NormalTok{]]}
\NormalTok{], ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\NormalTok{growth\_combined[}\StringTok{"type"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{    growth\_combined[}\StringTok{"type"}\NormalTok{],}
\NormalTok{    categories}\OperatorTok{=}\NormalTok{[}\StringTok{"Historical"}\NormalTok{, }\StringTok{"Forecast"}\NormalTok{]}
\NormalTok{)}

\NormalTok{growth\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(growth\_combined, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"revenue\_growth"}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"type"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\DecValTok{1}\NormalTok{, color}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_point(size}\OperatorTok{=}\DecValTok{2}\NormalTok{, color}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Revenue Growth Rate"}\NormalTok{, linetype}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Historical and Forecast Revenue Growth for FPT"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{growth\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{05_discounted_cash_flow_files/figure-pdf/fig-502-output-1.pdf}}

}

\caption{\label{fig-502}Revenue growth rates: historical (realized) and
forecast (GDP-linked with company premium). The forecast assumes FPT
grows at a premium to Vietnam's GDP growth.}

\end{figure}%

Figure~\ref{fig-503} presents the resulting FCF projections alongside
historical values.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Combine historical and forecast FCF}
\NormalTok{fcf\_historical }\OperatorTok{=}\NormalTok{ (historical\_data}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"fcf"}\NormalTok{]]}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Historical"}\NormalTok{)}
\NormalTok{)}

\NormalTok{fcf\_forecast }\OperatorTok{=}\NormalTok{ (forecast\_data}
\NormalTok{    .loc[:, [}\StringTok{"year"}\NormalTok{, }\StringTok{"fcf"}\NormalTok{]]}
\NormalTok{    .assign(}\BuiltInTok{type}\OperatorTok{=}\StringTok{"Forecast"}\NormalTok{)}
\NormalTok{)}

\NormalTok{fcf\_combined }\OperatorTok{=}\NormalTok{ pd.concat([fcf\_historical, fcf\_forecast], ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{fcf\_combined[}\StringTok{"type"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.Categorical(}
\NormalTok{    fcf\_combined[}\StringTok{"type"}\NormalTok{],}
\NormalTok{    categories}\OperatorTok{=}\NormalTok{[}\StringTok{"Historical"}\NormalTok{, }\StringTok{"Forecast"}\NormalTok{]}
\NormalTok{)}

\NormalTok{fcf\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(fcf\_combined, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"fcf/1e12"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"type"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_col()}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{"Free Cash Flow (Trillion VND)"}\NormalTok{, fill}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Historical and Forecast Free Cash Flow for FPT"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{fcf\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{05_discounted_cash_flow_files/figure-pdf/fig-503-output-1.pdf}}

}

\caption{\label{fig-503}Free Cash Flow: historical (realized) and
forecast (projected). The forecast reflects our assumptions about
revenue growth and operating ratios.}

\end{figure}%

\section{Terminal Value: Capturing Long-Term
Value}\label{terminal-value-capturing-long-term-value}

A critical component of DCF analysis is the \textbf{terminal value} (or
continuation value), which represents the company's value beyond the
explicit forecast period. In most valuations, terminal value constitutes
50-80\% of total enterprise value, making its estimation particularly
important.

\subsection{The Perpetuity Growth
Model}\label{the-perpetuity-growth-model}

The most common approach is the \textbf{Perpetuity Growth Model} (also
called the Gordon Growth Model), which assumes FCF grows at a constant
rate forever:

\[
TV_T = \frac{FCF_{T+1}}{r - g} = \frac{FCF_T \times (1 + g)}{r - g}
\]

where:

\begin{itemize}
\tightlist
\item
  \(TV_T\): Terminal value at the end of year \(T\)
\item
  \(FCF_T\): Free cash flow in the final forecast year
\item
  \(g\): Perpetual growth rate
\item
  \(r\): Discount rate (WACC)
\end{itemize}

\subsection{Choosing the Perpetual Growth
Rate}\label{choosing-the-perpetual-growth-rate}

The perpetual growth rate \(g\) should reflect long-term sustainable
growth. Key considerations:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{No company can grow faster than the economy forever}. If it
  did, the company would eventually become larger than GDP, which is an
  impossibility. Long-term GDP growth (nominal, including inflation)
  provides an upper bound.
\item
  \textbf{Mature companies typically grow at or below GDP growth}. The
  perpetual growth rate should reflect the company in its ``steady
  state,'' not its current high-growth phase.
\item
  \textbf{For Vietnam}, long-term nominal GDP growth might be 6-8\%
  given current development stage, but this will moderate over time. A
  perpetual growth rate of 3-5\% is often reasonable.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_terminal\_value(last\_fcf, growth\_rate, discount\_rate):}
    \CommentTok{"""}
\CommentTok{    Compute terminal value using the perpetuity growth model.}
\CommentTok{    }
\CommentTok{    Parameters:}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    last\_fcf : float}
\CommentTok{        Free cash flow in the final forecast year}
\CommentTok{    growth\_rate : float}
\CommentTok{        Perpetual growth rate (g)}
\CommentTok{    discount\_rate : float}
\CommentTok{        Discount rate / WACC (r)}
\CommentTok{        }
\CommentTok{    Returns:}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    float : Terminal value}
\CommentTok{    """}
    \ControlFlowTok{if}\NormalTok{ discount\_rate }\OperatorTok{\textless{}=}\NormalTok{ growth\_rate:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{"Discount rate must exceed growth rate for finite terminal value"}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ last\_fcf }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ growth\_rate) }\OperatorTok{/}\NormalTok{ (discount\_rate }\OperatorTok{{-}}\NormalTok{ growth\_rate)}


\CommentTok{\# Example calculation}
\NormalTok{last\_fcf }\OperatorTok{=}\NormalTok{ forecast\_data[}\StringTok{"fcf"}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{perpetual\_growth }\OperatorTok{=} \FloatTok{0.04}  \CommentTok{\# 4\% perpetual growth}
\NormalTok{discount\_rate }\OperatorTok{=} \FloatTok{0.10}     \CommentTok{\# 10\% WACC (placeholder)}

\NormalTok{terminal\_value }\OperatorTok{=}\NormalTok{ compute\_terminal\_value(last\_fcf, perpetual\_growth, discount\_rate)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Last forecast FCF: }\SpecialCharTok{\{}\NormalTok{last\_fcf}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.2f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Terminal value (at }\SpecialCharTok{\{}\NormalTok{perpetual\_growth}\SpecialCharTok{:.0\%\}}\SpecialStringTok{ growth, }\SpecialCharTok{\{}\NormalTok{discount\_rate}\SpecialCharTok{:.0\%\}}\SpecialStringTok{ WACC): }\SpecialCharTok{\{}\NormalTok{terminal\_value}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Last forecast FCF: 8.43 trillion VND
Terminal value (at 4% growth, 10% WACC): 146.1 trillion VND
\end{verbatim}

\subsection{Alternative: Exit Multiple
Approach}\label{alternative-exit-multiple-approach}

Practitioners often cross-check terminal value using the \textbf{exit
multiple approach}, which assumes the company is sold at the end of the
forecast period at a multiple of EBITDA, EBIT, or revenue comparable to
similar companies today.

For example, if comparable companies trade at 10x EBITDA, the terminal
value would be:

\[
TV_T = \text{EBITDA}_T \times \text{Exit Multiple}
\]

This approach is simpler but embeds the assumption that current market
multiples will persist (a strong assumption that may not hold).

\section{The Discount Rate: Weighted Average Cost of
Capital}\label{the-discount-rate-weighted-average-cost-of-capital}

The discount rate converts future cash flows to present value. For FCF
(which goes to all capital providers), we use the \textbf{Weighted
Average Cost of Capital (WACC)}:

\[
WACC = \frac{E}{E+D} \times r_E + \frac{D}{E+D} \times r_D \times (1 - \tau)
\]

where:

\begin{itemize}
\tightlist
\item
  \(E\): Market value of equity
\item
  \(D\): Market value of debt
\item
  \(r_E\): Cost of equity (typically estimated using CAPM)
\item
  \(r_D\): Cost of debt (pre-tax)
\item
  \(\tau\): Corporate tax rate
\end{itemize}

The \((1-\tau)\) term on debt reflects the tax shield. Interest payments
are tax-deductible, reducing the effective cost of debt.

\subsection{Estimating WACC
Components}\label{estimating-wacc-components}

\textbf{Cost of Equity} is typically estimated using the Capital Asset
Pricing Model. See the \hyperref[the-capital-asset-pricing-model]{CAPM
chapter}:

\[
r_E = r_f + \beta \times (r_m - r_f)
\]

where \(r_f\) is the risk-free rate, \(\beta\) measures systematic risk,
and \((r_m - r_f)\) is the market risk premium.

\textbf{Cost of Debt} can be estimated from:

\begin{itemize}
\tightlist
\item
  Interest expense divided by total debt (effective rate)
\item
  Yields on the company's traded bonds
\item
  Yields on bonds with similar credit ratings
\end{itemize}

\textbf{Capital Structure Weights} should use market values when
available. For equity, market capitalization is straightforward. For
debt, book value is often used when market values aren't observable.

\subsection{Using Industry WACC Data}\label{using-industry-wacc-data}

Professor Aswath Damodaran at NYU Stern maintains comprehensive industry
WACC and country risk premium data. We use these datasets to estimate
appropriate discount rates for Vietnamese companies.

\subsubsection{Downloading the Data}\label{downloading-the-data}

The following code downloads the required datasets. Run this manually
when you need to update the data (typically annually), but it is not
executed during book rendering to avoid dependency on external servers.

\phantomsection\label{download-damodaran-data}
\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ requests}
\ImportTok{from}\NormalTok{ pathlib }\ImportTok{import}\NormalTok{ Path}

\CommentTok{\# Create data directory if needed}
\NormalTok{data\_dir }\OperatorTok{=}\NormalTok{ Path(}\StringTok{"data"}\NormalTok{)}
\NormalTok{data\_dir.mkdir(exist\_ok}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\CommentTok{\# Download WACC data}
\NormalTok{wacc\_url }\OperatorTok{=} \StringTok{"https://pages.stern.nyu.edu/\textasciitilde{}adamodar/pc/datasets/wacc.xls"}
\NormalTok{response }\OperatorTok{=}\NormalTok{ requests.get(wacc\_url, timeout}\OperatorTok{=}\DecValTok{30}\NormalTok{)}
\NormalTok{response.raise\_for\_status()}
\NormalTok{(data\_dir }\OperatorTok{/} \StringTok{"damodaran\_wacc.xls"}\NormalTok{).write\_bytes(response.content)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Downloaded: damodaran\_wacc.xls"}\NormalTok{)}

\CommentTok{\# Download country risk premium data}
\NormalTok{crp\_url }\OperatorTok{=} \StringTok{"https://pages.stern.nyu.edu/\textasciitilde{}adamodar/pc/datasets/ctryprem.xlsx"}
\NormalTok{response }\OperatorTok{=}\NormalTok{ requests.get(crp\_url, timeout}\OperatorTok{=}\DecValTok{30}\NormalTok{)}
\NormalTok{response.raise\_for\_status()}
\NormalTok{(data\_dir }\OperatorTok{/} \StringTok{"damodaran\_crp.xlsx"}\NormalTok{).write\_bytes(response.content)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Downloaded: damodaran\_crp.xlsx"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Industry WACC}\label{industry-wacc}

We extract the cost of capital for the Computer Services industry, which
most closely matches FPT's business profile:

\phantomsection\label{read-industry-wacc}
\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}

\CommentTok{\# Read local WACC data}
\NormalTok{wacc\_data }\OperatorTok{=}\NormalTok{ pd.read\_excel(}
    \StringTok{"data/damodaran\_wacc.xls"}\NormalTok{, }
\NormalTok{    sheet\_name}\OperatorTok{=}\DecValTok{1}\NormalTok{, }
\NormalTok{    skiprows}\OperatorTok{=}\DecValTok{18}
\NormalTok{)}

\CommentTok{\# Find WACC for Computer Services}
\NormalTok{industry\_wacc }\OperatorTok{=}\NormalTok{ wacc\_data.loc[}
\NormalTok{    wacc\_data[}\StringTok{"Industry Name"}\NormalTok{] }\OperatorTok{==} \StringTok{"Computer Services"}\NormalTok{,}
    \StringTok{"Cost of Capital"}
\NormalTok{].values[}\DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Industry WACC (Computer Services): }\SpecialCharTok{\{}\NormalTok{industry\_wacc}\SpecialCharTok{:.2\%\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Industry WACC (Computer Services): 7.83%
\end{verbatim}

\subsubsection{Country Risk Premium}\label{country-risk-premium}

For Vietnamese companies, we must adjust for country-specific risk.
Damodaran calculates country risk premiums based on sovereign credit
ratings and relative equity market volatility:

\phantomsection\label{read-country-risk-premium}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Read local country risk premium data}
\NormalTok{crp\_data }\OperatorTok{=}\NormalTok{ pd.read\_excel(}
    \StringTok{"data/damodaran\_crp.xlsx"}\NormalTok{,}
\NormalTok{    sheet\_name}\OperatorTok{=}\StringTok{"ERPs by country"}\NormalTok{,}
\NormalTok{    skiprows}\OperatorTok{=}\DecValTok{7}
\NormalTok{)}

\CommentTok{\# Find Vietnam\textquotesingle{}s country risk premium}
\NormalTok{vietnam\_row }\OperatorTok{=}\NormalTok{ crp\_data[}
\NormalTok{    crp\_data.iloc[:, }\DecValTok{0}\NormalTok{].}\BuiltInTok{str}\NormalTok{.contains(}\StringTok{"Vietnam"}\NormalTok{, case}\OperatorTok{=}\VariableTok{False}\NormalTok{, na}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{]}

\NormalTok{country\_risk\_premium }\OperatorTok{=}\NormalTok{ vietnam\_row.iloc[}\DecValTok{0}\NormalTok{, }\DecValTok{8}\NormalTok{]}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Vietnam Country Risk Premium: }\SpecialCharTok{\{}\NormalTok{country\_risk\_premium}\SpecialCharTok{:.2\%\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Vietnam Country Risk Premium: 2.09%
\end{verbatim}

\subsubsection{Adjusted WACC for
Vietnam}\label{adjusted-wacc-for-vietnam}

Combining the industry benchmark with the country risk premium gives us
an appropriate discount rate:

\phantomsection\label{calculate-vietnam-wacc}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wacc\_vietnam }\OperatorTok{=}\NormalTok{ industry\_wacc }\OperatorTok{+}\NormalTok{ country\_risk\_premium}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Industry WACC (US):        }\SpecialCharTok{\{}\NormalTok{industry\_wacc}\SpecialCharTok{:.2\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Country Risk Premium:      }\SpecialCharTok{\{}\NormalTok{country\_risk\_premium}\SpecialCharTok{:.2\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Adjusted WACC (Vietnam):   }\SpecialCharTok{\{}\NormalTok{wacc\_vietnam}\SpecialCharTok{:.2\%\}}\SpecialStringTok{"}\NormalTok{)}

\NormalTok{wacc }\OperatorTok{=}\NormalTok{ wacc\_vietnam}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Industry WACC (US):        7.83%
Country Risk Premium:      2.09%
Adjusted WACC (Vietnam):   9.92%
\end{verbatim}

\textbf{Note}: This approach assumes Vietnamese companies in the same
industry face similar operating risks as their US counterparts, with the
country risk premium capturing additional macroeconomic and political
risks. For company-specific analysis, further adjustments for leverage
differences and firm-specific risk factors may be warranted.

\section{Computing Enterprise Value}\label{computing-enterprise-value}

With all components in place, we can now compute enterprise value. The
DCF formula is:

\[
\text{Enterprise Value} = \sum_{t=1}^{T} \frac{FCF_t}{(1 + WACC)^t} + \frac{TV_T}{(1 + WACC)^T}
\]

The first term is the present value of forecast-period cash flows; the
second is the present value of terminal value.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_dcf\_value(fcf\_series, wacc, perpetual\_growth):}
    \CommentTok{"""}
\CommentTok{    Compute enterprise value using DCF analysis.}
\CommentTok{    }
\CommentTok{    Parameters:}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    fcf\_series : array{-}like}
\CommentTok{        Free cash flows for forecast period}
\CommentTok{    wacc : float}
\CommentTok{        Weighted average cost of capital}
\CommentTok{    perpetual\_growth : float}
\CommentTok{        Perpetual growth rate for terminal value}
\CommentTok{        }
\CommentTok{    Returns:}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    dict : Components of DCF valuation}
\CommentTok{    """}
\NormalTok{    fcf }\OperatorTok{=}\NormalTok{ np.array(fcf\_series)}
\NormalTok{    n\_years }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(fcf)}
    
    \CommentTok{\# Discount factors}
\NormalTok{    discount\_factors }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ wacc) }\OperatorTok{**}\NormalTok{ np.arange(}\DecValTok{1}\NormalTok{, n\_years }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Present value of forecast period cash flows}
\NormalTok{    pv\_fcf }\OperatorTok{=}\NormalTok{ fcf }\OperatorTok{/}\NormalTok{ discount\_factors}
\NormalTok{    pv\_fcf\_total }\OperatorTok{=}\NormalTok{ pv\_fcf.}\BuiltInTok{sum}\NormalTok{()}
    
    \CommentTok{\# Terminal value and its present value}
\NormalTok{    terminal\_value }\OperatorTok{=}\NormalTok{ compute\_terminal\_value(fcf[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{], perpetual\_growth, wacc)}
\NormalTok{    pv\_terminal }\OperatorTok{=}\NormalTok{ terminal\_value }\OperatorTok{/}\NormalTok{ discount\_factors[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
    
    \CommentTok{\# Total enterprise value}
\NormalTok{    enterprise\_value }\OperatorTok{=}\NormalTok{ pv\_fcf\_total }\OperatorTok{+}\NormalTok{ pv\_terminal}
    
    \ControlFlowTok{return}\NormalTok{ \{}
        \StringTok{"pv\_fcf"}\NormalTok{: pv\_fcf\_total,}
        \StringTok{"terminal\_value"}\NormalTok{: terminal\_value,}
        \StringTok{"pv\_terminal"}\NormalTok{: pv\_terminal,}
        \StringTok{"enterprise\_value"}\NormalTok{: enterprise\_value,}
        \StringTok{"terminal\_pct"}\NormalTok{: pv\_terminal }\OperatorTok{/}\NormalTok{ enterprise\_value}
\NormalTok{    \}}


\CommentTok{\# Compute DCF value}
\NormalTok{perpetual\_growth }\OperatorTok{=} \FloatTok{0.04}  \CommentTok{\# 4\% perpetual growth}

\NormalTok{dcf\_result }\OperatorTok{=}\NormalTok{ compute\_dcf\_value(}
\NormalTok{    fcf\_series}\OperatorTok{=}\NormalTok{forecast\_data[}\StringTok{"fcf"}\NormalTok{].values,}
\NormalTok{    wacc}\OperatorTok{=}\NormalTok{wacc,}
\NormalTok{    perpetual\_growth}\OperatorTok{=}\NormalTok{perpetual\_growth}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"DCF Valuation Results"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{50}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"PV of Forecast Period FCF: }\SpecialCharTok{\{}\NormalTok{dcf\_result[}\StringTok{\textquotesingle{}pv\_fcf\textquotesingle{}}\NormalTok{]}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Terminal Value: }\SpecialCharTok{\{}\NormalTok{dcf\_result[}\StringTok{\textquotesingle{}terminal\_value\textquotesingle{}}\NormalTok{]}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"PV of Terminal Value: }\SpecialCharTok{\{}\NormalTok{dcf\_result[}\StringTok{\textquotesingle{}pv\_terminal\textquotesingle{}}\NormalTok{]}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Enterprise Value: }\SpecialCharTok{\{}\NormalTok{dcf\_result[}\StringTok{\textquotesingle{}enterprise\_value\textquotesingle{}}\NormalTok{]}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Terminal Value as \% of EV: }\SpecialCharTok{\{}\NormalTok{dcf\_result[}\StringTok{\textquotesingle{}terminal\_pct\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
DCF Valuation Results
==================================================
PV of Forecast Period FCF: 22.7 trillion VND
Terminal Value: 148.1 trillion VND
PV of Terminal Value: 92.3 trillion VND
Enterprise Value: 115.1 trillion VND
Terminal Value as % of EV: 80.2%
\end{verbatim}

Note that terminal value often represents 60-80\% of enterprise value.
This highlights the importance of terminal value assumptions and the
inherent uncertainty in DCF analysis.

\section{Sensitivity Analysis}\label{sensitivity-analysis}

Given the uncertainty in DCF inputs, sensitivity analysis is essential.
We examine how enterprise value changes with different assumptions about
WACC and perpetual growth.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define ranges for sensitivity analysis}
\NormalTok{wacc\_range }\OperatorTok{=}\NormalTok{ np.arange(}\FloatTok{0.08}\NormalTok{, }\FloatTok{0.14}\NormalTok{, }\FloatTok{0.01}\NormalTok{)  }\CommentTok{\# 8\% to 13\%}
\NormalTok{growth\_range }\OperatorTok{=}\NormalTok{ np.arange(}\FloatTok{0.02}\NormalTok{, }\FloatTok{0.06}\NormalTok{, }\FloatTok{0.01}\NormalTok{)  }\CommentTok{\# 2\% to 5\%}

\CommentTok{\# Create all combinations}
\NormalTok{sensitivity\_results }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ w }\KeywordTok{in}\NormalTok{ wacc\_range:}
    \ControlFlowTok{for}\NormalTok{ g }\KeywordTok{in}\NormalTok{ growth\_range:}
        \ControlFlowTok{if}\NormalTok{ w }\OperatorTok{\textgreater{}}\NormalTok{ g:  }\CommentTok{\# Must have WACC \textgreater{} growth for valid terminal value}
\NormalTok{            result }\OperatorTok{=}\NormalTok{ compute\_dcf\_value(}
\NormalTok{                fcf\_series}\OperatorTok{=}\NormalTok{forecast\_data[}\StringTok{"fcf"}\NormalTok{].values,}
\NormalTok{                wacc}\OperatorTok{=}\NormalTok{w,}
\NormalTok{                perpetual\_growth}\OperatorTok{=}\NormalTok{g}
\NormalTok{            )}
\NormalTok{            sensitivity\_results.append(\{}
                \StringTok{"wacc"}\NormalTok{: w,}
                \StringTok{"growth\_rate"}\NormalTok{: g,}
                \StringTok{"enterprise\_value"}\NormalTok{: result[}\StringTok{"enterprise\_value"}\NormalTok{] }\OperatorTok{/} \FloatTok{1e12}  \CommentTok{\# In trillions}
\NormalTok{            \})}

\NormalTok{sensitivity\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(sensitivity\_results)}

\CommentTok{\# Create heatmap}
\NormalTok{sensitivity\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(sensitivity\_df, aes(x}\OperatorTok{=}\StringTok{"wacc"}\NormalTok{, y}\OperatorTok{=}\StringTok{"growth\_rate"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"enterprise\_value"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_tile()}
    \OperatorTok{+}\NormalTok{ geom\_text(}
\NormalTok{        aes(label}\OperatorTok{=}\StringTok{"enterprise\_value"}\NormalTok{),}
\NormalTok{        format\_string}\OperatorTok{=}\StringTok{"}\SpecialCharTok{\{:.0f\}}\StringTok{"}\NormalTok{,}
\NormalTok{        color}\OperatorTok{=}\StringTok{"white"}\NormalTok{,}
\NormalTok{        size}\OperatorTok{=}\DecValTok{9}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
    \OperatorTok{+}\NormalTok{ scale\_fill\_gradient(low}\OperatorTok{=}\StringTok{"darkblue"}\NormalTok{, high}\OperatorTok{=}\StringTok{"lightblue"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"WACC"}\NormalTok{, y}\OperatorTok{=}\StringTok{"Perpetual Growth Rate"}\NormalTok{,}
\NormalTok{        fill}\OperatorTok{=}\StringTok{"EV}\CharTok{\textbackslash{}n}\StringTok{(Trillion VND)"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"DCF Sensitivity: Enterprise Value by WACC and Growth Rate"}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{sensitivity\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{05_discounted_cash_flow_files/figure-pdf/fig-504-output-1.pdf}}

}

\caption{\label{fig-504}Sensitivity of enterprise value to WACC and
perpetual growth rate assumptions. Small changes in these inputs can
substantially affect valuation.}

\end{figure}%

The sensitivity analysis reveals several important insights:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Valuation is highly sensitive to inputs}: Small changes in
  WACC or growth rate produce large changes in enterprise value. A 1
  percentage point change in WACC can shift value by 20\% or more.
\item
  \textbf{The relationship is non-linear}: The impact of growth rate
  changes is amplified at lower WACCs because the terminal value formula
  has \((r-g)\) in the denominator.
\item
  \textbf{Reasonable people can disagree}: Given input uncertainty, DCF
  should be thought of as producing a \emph{range} of values, not a
  single precise number.
\end{enumerate}

\section{From Enterprise Value to Equity
Value}\label{from-enterprise-value-to-equity-value}

Our DCF analysis yields \textbf{enterprise value} (i.e., the total value
of the company's operations to all capital providers). To determine
\textbf{equity value} (what shareholders own), we must adjust for the
claims of debt holders and any non-operating assets:

\[
\text{Equity Value} = \text{Enterprise Value} + \text{Non-Operating Assets} - \text{Debt}
\]

\textbf{Non-Operating Assets} include:

\begin{itemize}
\tightlist
\item
  Excess cash beyond operating needs
\item
  Marketable securities
\item
  Non-core real estate or investments
\end{itemize}

\textbf{Debt} includes:

\begin{itemize}
\tightlist
\item
  Short-term debt
\item
  Long-term debt
\item
  Capital lease obligations
\item
  Preferred stock (if treated as debt-like)
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get most recent balance sheet data for FPT}
\NormalTok{latest\_year }\OperatorTok{=}\NormalTok{ fpt\_data[}\StringTok{"year"}\NormalTok{].}\BuiltInTok{max}\NormalTok{()}
\NormalTok{latest\_data }\OperatorTok{=}\NormalTok{ fpt\_data[fpt\_data[}\StringTok{"year"}\NormalTok{] }\OperatorTok{==}\NormalTok{ latest\_year].iloc[}\DecValTok{0}\NormalTok{]}

\CommentTok{\# Extract debt and cash (column names may vary)}
\NormalTok{total\_debt }\OperatorTok{=}\NormalTok{ latest\_data.get(}\StringTok{"total\_debt"}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{cash }\OperatorTok{=}\NormalTok{ latest\_data.get(}\StringTok{"ca\_cce"}\NormalTok{, }\DecValTok{0}\NormalTok{)}

\CommentTok{\# Compute equity value}
\NormalTok{enterprise\_value }\OperatorTok{=}\NormalTok{ dcf\_result[}\StringTok{"enterprise\_value"}\NormalTok{]}
\NormalTok{equity\_value }\OperatorTok{=}\NormalTok{ enterprise\_value }\OperatorTok{{-}}\NormalTok{ total\_debt }\OperatorTok{+}\NormalTok{ cash}

\BuiltInTok{print}\NormalTok{(}\StringTok{"From Enterprise Value to Equity Value"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{50}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Enterprise Value: }\SpecialCharTok{\{}\NormalTok{enterprise\_value}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Less: Total Debt: }\SpecialCharTok{\{}\NormalTok{total\_debt}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Plus: Cash: }\SpecialCharTok{\{}\NormalTok{cash}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Equity Value: }\SpecialCharTok{\{}\NormalTok{equity\_value}\OperatorTok{/}\FloatTok{1e12}\SpecialCharTok{:.1f\}}\SpecialStringTok{ trillion VND"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
From Enterprise Value to Equity Value
==================================================
Enterprise Value: 115.1 trillion VND
Less: Total Debt: 0.0 trillion VND
Plus: Cash: 8.3 trillion VND
Equity Value: 123.3 trillion VND
\end{verbatim}

\subsection{Implied Share Price}\label{implied-share-price}

If we know the number of shares outstanding, we can compute an implied
share price:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get shares outstanding (this would come from market data)}
\CommentTok{\# Using placeholder {-} in practice, get from exchange data}
\NormalTok{shares\_outstanding }\OperatorTok{=}\NormalTok{ latest\_data.get(}\StringTok{"total\_equity"}\NormalTok{, equity\_value) }\OperatorTok{/} \DecValTok{25000}  \CommentTok{\# Rough estimate}

\NormalTok{implied\_price }\OperatorTok{=}\NormalTok{ equity\_value }\OperatorTok{/}\NormalTok{ shares\_outstanding}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Implied Share Price: }\SpecialCharTok{\{}\NormalTok{implied\_price}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ VND"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Implied Share Price: 103,008 VND
\end{verbatim}

Comparing the implied price to the current market price tells us whether
the stock appears under- or overvalued according to our DCF model.

\section{Limitations and Practical
Considerations}\label{limitations-and-practical-considerations-1}

DCF analysis is powerful but has important limitations:

\subsection{Sensitivity to
Assumptions}\label{sensitivity-to-assumptions}

As our sensitivity analysis showed, small changes in inputs produce
large changes in value. This is particularly problematic because the
most influential inputs (long-term growth, WACC) are the hardest to
estimate accurately.

\subsection{Terminal Value Dominance}\label{terminal-value-dominance}

Terminal value often represents 60-80\% of total value, yet it's based
on assumptions about the very distant future. This concentrates
valuation risk in the most uncertain component.

\subsection{Garbage In, Garbage Out}\label{garbage-in-garbage-out}

DCF is only as good as its inputs. Unrealistic growth assumptions,
optimistic margins, or inappropriate discount rates produce meaningless
valuations. The discipline of DCF lies in forcing analysts to justify
their assumptions.

\subsection{Not Suitable for All
Companies}\label{not-suitable-for-all-companies}

DCF works best for companies with:

\begin{itemize}
\tightlist
\item
  Positive and predictable cash flows
\item
  Stable or predictably changing margins
\item
  Reasonable visibility into future operations
\end{itemize}

It struggles with:

\begin{itemize}
\tightlist
\item
  Early-stage companies with no profits
\item
  Highly cyclical businesses
\item
  Companies undergoing major transitions
\item
  Financial institutions (which require different approaches)
\end{itemize}

\subsection{Complement with Other
Methods}\label{complement-with-other-methods}

Wise practitioners use DCF alongside other valuation methods:

\begin{itemize}
\tightlist
\item
  \textbf{Comparable company analysis}: How do similar companies trade?
\item
  \textbf{Precedent transactions}: What have acquirers paid for similar
  businesses?
\item
  \textbf{Sum-of-the-parts}: Value divisions separately and add
\end{itemize}

When methods converge, confidence increases. When they diverge, it
prompts investigation into why.

\section{Key Takeaways}\label{key-takeaways-3}

This chapter introduced Discounted Cash Flow analysis as a framework for
intrinsic valuation. The main insights are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Free Cash Flow is the foundation}: FCF represents cash
  available to all investors after operating expenses, taxes, and
  investments. It differs from net income by excluding non-cash items
  and including investment needs.
\item
  \textbf{Ratio-based forecasting links components to revenue}: By
  expressing FCF components as percentages of revenue, we can
  systematically forecast cash flows based on revenue growth assumptions
  and operating ratio projections.
\item
  \textbf{Terminal value captures long-term value}: The perpetuity
  growth model assumes FCF grows at a constant rate forever. The
  perpetual growth rate should not exceed long-term economic growth.
\item
  \textbf{WACC is the appropriate discount rate}: The Weighted Average
  Cost of Capital reflects the blended cost of debt and equity
  financing, adjusted for the tax shield on interest.
\item
  \textbf{DCF produces enterprise value}: To derive equity value,
  subtract debt and add non-operating assets. Dividing by shares
  outstanding yields an implied share price.
\item
  \textbf{Sensitivity analysis is essential}: Given input uncertainty,
  presenting a range of values based on different assumptions is more
  honest than a single point estimate.
\item
  \textbf{DCF complements other methods}: No single valuation method is
  definitive. Cross-checking DCF with market multiples and transaction
  comparables provides a more complete picture.
\end{enumerate}

The true value of DCF analysis lies not in producing a precise number
but in forcing rigorous thinking about what drives company value. The
process of building a DCF model (i.e., forecasting growth, projecting
margins, estimating risk) develops deep understanding of the business
being valued.

\bookmarksetup{startatroot}

\chapter{Accessing and Managing VN Financial
Data}\label{accessing-and-managing-vn-financial-data}

This chapter provides a guide to organizing, accessing, and managing
financial data specifically tailored for the Vietnamese market. While
global financial databases such as CRSP and Compustat serve as standard
resources for developed markets, emerging markets like Vietnam require a
different approach due to unique data sources, market structures, and
regulatory environments. Understanding these nuances is essential for
conducting rigorous empirical research on Vietnamese equities, bonds,
and macroeconomic indicators.

Vietnam's financial market has experienced remarkable growth since the
establishment of the Ho Chi Minh City Stock Exchange (HOSE) in 2000 and
the Hanoi Stock Exchange (HNX) in 2005. Today, the market comprises over
1,600 listed companies across three trading venues: HOSE for large-cap
stocks, HNX for mid-cap stocks, and UPCoM (Unlisted Public Company
Market) for smaller companies transitioning to formal listing. This
diversity creates both opportunities and challenges for financial
researchers seeking comprehensive coverage of the Vietnamese equity
universe.

The Vietnamese market presents several distinctive characteristics that
researchers must account for. Foreign ownership limits (typically 49\%
for most sectors, with exceptions for banking and certain strategic
industries), trading band restrictions (e.g., currently \(\pm\) 7\% for
HOSE and \(\pm\) 10\% for HNX), and the T+2 settlement cycle all
influence market microstructure and return dynamics. Additionally, the
market operates in Vietnamese Dong (VND), requiring careful attention to
currency effects when comparing results with international studies.

We begin by loading the essential Python packages that facilitate data
acquisition and management throughout this chapter.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ requests}
\ImportTok{from}\NormalTok{ datetime }\ImportTok{import}\NormalTok{ datetime, timedelta}
\ImportTok{import}\NormalTok{ json}
\ImportTok{import}\NormalTok{ sqlite3}
\end{Highlighting}
\end{Shaded}

We also define the date range for our data collection, which spans from
the early days of the Vietnamese stock market to the present. This
extended timeframe allows us to capture the market's evolution through
various economic cycles, including the 2008 global financial crisis, the
2011-2012 domestic banking crisis, and the COVID-19 pandemic period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=} \StringTok{"2000{-}07{-}28"}  \CommentTok{\# HOSE establishment date}
\NormalTok{end\_date }\OperatorTok{=} \StringTok{"2024{-}12{-}31"}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Overview of Vietnamese Financial Data
Sources}\label{overview-of-vietnamese-financial-data-sources}

Before diving into the technical implementation, it is valuable to
understand the landscape of financial data providers serving the
Vietnamese market. Unlike developed markets where a few dominant
providers (Bloomberg, Refinitiv, FactSet) offer comprehensive coverage,
Vietnamese financial data has historically been fragmented across
multiple sources, each with distinct strengths and limitations.

The primary sources of Vietnamese financial data include official
exchange feeds from HOSE and HNX, which provide real-time and historical
trading data. The State Securities Commission of Vietnam (SSC) publishes
regulatory filings, corporate announcements, and market statistics.
Commercial data vendors such as FiinGroup, StoxPlus (now part of
FiinGroup), and VNDirect offer curated datasets with varying levels of
coverage and data quality. Additionally, the State Bank of Vietnam (SBV)
and the General Statistics Office (GSO) provide macroeconomic indicators
essential for asset pricing research.

For academic researchers, this fragmentation traditionally involved
difficult trade-offs between cost, coverage, data quality, and ease of
access. Commercial providers like FiinGroup offer clean, standardized
data but require subscription fees that may be prohibitive for
individual researchers and smaller institutions. Open-source
alternatives provide free access but often require substantial data
cleaning and validation efforts. Manually collecting data from
government websites is time-consuming and prone to inconsistencies.

Fortunately, this landscape has improved significantly with the
emergence of \href{https://datacore.vn/}{\textbf{Datacore}} as a unified
data platform for Vietnamese financial markets. In our experience
working with Vietnamese financial data across multiple research
projects, Datacore has proven to be the most practical solution for
academic research. The platform consolidates data from multiple sources,
including stock prices, corporate fundamentals, market indices,
macroeconomic indicators, and alternative data, into a single,
accessible interface with a well-documented API.

What distinguishes \href{https://datacore.vn/}{Datacore} from
traditional commercial providers like FiinGroup extends beyond mere data
aggregation. While FiinGroup has long been the institutional incumbent,
several factors make Datacore particularly attractive for rigorous
empirical research:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{API-First Architecture}: Datacore was built from the ground up
  for programmatic access, making it seamlessly integrable with Python,
  R, and other research workflows. FiinGroup's data access, by contrast,
  often requires manual downloads or cumbersome Excel-based interfaces
  that impede reproducibility.
\item
  \textbf{Cost Efficiency}: Academic researchers frequently operate
  under budget constraints. Datacore offers competitive pricing
  structures that make comprehensive market coverage accessible without
  the substantial subscription fees associated with legacy providers.
\item
  \textbf{Corporate Action Handling}: One persistent challenge with
  Vietnamese data is accurate adjustment for stock splits, bonus shares,
  and rights issues. Datacore implements transparent adjustment
  methodologies with clear documentation, whereas legacy providers often
  apply adjustments inconsistently or without adequate explanation.
\item
  \textbf{Update Frequency}: Datacore maintains near real-time data
  updates with clear timestamps, enabling event study research and
  timely portfolio rebalancing. Traditional providers often suffer from
  publication lags that can compromise research requiring current data.
\item
  \textbf{Coverage Breadth}: Beyond standard price and fundamental data,
  Datacore integrates alternative data, and macroeconomic indicators
  into a unified schema. This eliminates the need to merge datasets from
  multiple sources, which is a process that introduces potential errors
  and consumes valuable research time.
\end{enumerate}

Throughout this chapter, we leverage Datacore as our primary data
source. By centralizing our data acquisition through a single platform,
we benefit from consistent data formats, reliable corporate action
adjustments, and comprehensive market coverage spanning HOSE, HNX, and
UPCoM. The code examples that follow demonstrate how straightforward
Vietnamese financial research becomes when data access friction is
minimized.

The following table summarizes the key data sources for Vietnamese
financial research:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2000}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2000}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2000}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2000}}
  >{\raggedright\arraybackslash}p{(\linewidth - 8\tabcolsep) * \real{0.2000}}@{}}
\caption{Vietnamese Financial Data
Sources}\label{tbl-data-sources}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Data Source
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Coverage
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Access Type
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Strengths
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Limitations
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Data Source
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Coverage
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Access Type
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Strengths
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Limitations
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Datacore} & Prices, fundamentals, indices, macro, derivatives &
API & Unified platform, programmatic access, comprehensive coverage,
transparent methodology & Newer platform \\
FiinGroup & Full market coverage & Commercial & Established reputation,
institutional adoption & High cost, manual access, limited API \\
HOSE/HNX websites & Official exchange data & Free (manual) &
Authoritative, real-time & No API, manual collection required \\
GSO (gso.gov.vn) & Macroeconomic indicators & Free (manual) & Official
government statistics & Infrequent updates, no API \\
SBV (sbv.gov.vn) & Monetary policy, rates & Free (manual) & Central bank
data & Manual download only \\
CafeF/VnExpress & News, announcements & Free & Market sentiment, events
& Unstructured, requires NLP processing \\
\end{longtable}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Stock Market Data}\label{stock-market-data}

The resulting DataFrame contains essential security identifiers
including the ticker symbol, company name in both Vietnamese and
English, exchange listing, industry classification according to the
Vietnam Standard Industrial Classification (VSIC), and various flags
indicating special status such as foreign ownership restrictions or
trading suspensions.

\subsection{Historical Price Data}\label{historical-price-data}

\subsection{Fundamental Data and Financial
Statements}\label{fundamental-data-and-financial-statements}

Beyond price data, fundamental analysis requires access to corporate
financial statements including balance sheets, income statements, and
cash flow statements. Vietnamese publicly listed companies are required
to publish quarterly and annual financial reports according to
Vietnamese Accounting Standards (VAS), which differ in certain respects
from International Financial Reporting Standards (IFRS). Understanding
these differences is important when comparing Vietnamese firms with
international peers or applying models developed using US or European
data.

Key differences between VAS and IFRS that affect financial analysis
include:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Revenue recognition}: VAS allows more flexibility in timing of
  revenue recognition compared to IFRS 15
\item
  \textbf{Financial instruments}: VAS has less comprehensive guidance on
  fair value measurement
\item
  \textbf{Lease accounting}: VAS does not require operating lease
  capitalization as under IFRS 16
\item
  \textbf{Goodwill}: VAS requires amortization while IFRS requires
  impairment testing only
\end{enumerate}

\subsection{Corporate Actions and
Events}\label{corporate-actions-and-events}

Accurate treatment of corporate actions is essential for computing
correct returns and maintaining data integrity. Vietnamese companies
frequently engage in corporate actions including cash dividends, stock
dividends (bonus shares), rights issues, and stock splits.

\section{Market Indices and
Benchmarks}\label{market-indices-and-benchmarks}

Constructing appropriate benchmarks is fundamental to performance
evaluation and factor model estimation. The Vietnamese market features
several indices that serve different purposes in financial research.

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.1806}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.1389}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.3472}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.3333}}@{}}
\caption{Vietnamese Market Indices}\label{tbl-indices}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Index
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Exchange
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Description
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Use Case
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Index
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Exchange
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Description
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Use Case
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
VN-Index & HOSE & All HOSE-listed stocks & Broad market benchmark \\
VN30-Index & HOSE & 30 largest, most liquid & Investable benchmark \\
HNX-Index & HNX & All HNX-listed stocks & Mid-cap benchmark \\
HNX30-Index & HNX & 30 largest HNX stocks & HNX large-cap \\
VNAllShare & Combined & HOSE + HNX & Total market \\
VN100 & Combined & Top 100 stocks & Large/mid-cap \\
\end{longtable}

The VN-Index, which tracks all stocks listed on HOSE, is the most widely
followed benchmark and serves as the primary gauge of overall market
performance. The HNX-Index covers stocks on the Hanoi exchange, while
the VN30-Index tracks the thirty largest and most liquid stocks on HOSE.

For asset pricing research, the VN30-Index is particularly valuable as
it represents the investable universe for institutional investors and
serves as the underlying for Vietnam's most liquid derivatives
contracts. The constituent stocks are reviewed semi-annually based on
market capitalization, liquidity, and free-float requirements.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Retrieve VN{-}Index historical data}
\end{Highlighting}
\end{Shaded}

\subsection{Index Constituent Data}\label{index-constituent-data}

For factor model construction and portfolio analysis, access to index
constituent lists and their weights is essential. While official
constituent data requires subscription to exchange data feeds, we can
approximate index membership using market capitalization and liquidity
filters.

\section{Macroeconomic Data from Vietnamese
Sources}\label{macroeconomic-data-from-vietnamese-sources}

Asset pricing models often incorporate macroeconomic variables as
predictors of expected returns or as state variables in conditional
models. For the Vietnamese market, relevant macroeconomic data comes
primarily from two sources: the General Statistics Office (GSO) and the
State Bank of Vietnam (SBV).

\subsection{Key Macroeconomic
Indicators}\label{key-macroeconomic-indicators}

The following macroeconomic variables are particularly relevant for
Vietnamese financial research:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Consumer Price Index (CPI)}: Essential for computing real
  returns and inflation-adjusted valuations. Vietnam experienced periods
  of high inflation, particularly during 2008 and 2011 when annual CPI
  exceeded 20\%.
\item
  \textbf{Industrial Production Index (IPI)}: Proxy for economic
  activity and business cycle conditions.
\item
  \textbf{Money Supply (M2)}: Indicator of monetary policy stance and
  liquidity conditions.
\item
  \textbf{Credit Growth}: Bank lending growth, a key driver of economic
  activity in Vietnam's bank-dominated financial system.
\item
  \textbf{USD/VND Exchange Rate}: Critical for international investors
  and companies with foreign currency exposure.
\item
  \textbf{Foreign Direct Investment (FDI)}: Indicator of international
  capital flows and economic confidence.
\item
  \textbf{Trade Balance}: Export and import dynamics affecting corporate
  earnings.
\end{enumerate}

Unfortunately, unlike the US Federal Reserve's FRED database, Vietnamese
macroeconomic data is not available through standardized APIs.
Researchers must typically download data manually from GSO and SBV
websites or use web scraping techniques.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Structure for Vietnamese macroeconomic data}
\end{Highlighting}
\end{Shaded}

\subsection{Risk-Free Rate
Approximation}\label{risk-free-rate-approximation}

Determining an appropriate risk-free rate for Vietnam presents
challenges not encountered in developed markets. Unlike the US Treasury
market, Vietnam's government bond market is relatively illiquid with
limited secondary trading. Several alternatives exist:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{SBV Refinancing Rate}: The policy rate set by the State Bank
  of Vietnam. Not directly investable but reflects monetary policy
  stance.
\item
  \textbf{Government Bond Yields}: One-year or longer-term government
  bond yields from auction results. More investable but less liquid than
  US Treasuries.
\item
  \textbf{Interbank Rates}: Overnight or term interbank lending rates.
  Reflect short-term funding costs but include credit risk.
\item
  \textbf{Adjusted US Rate}: US Treasury rate plus expected VND
  depreciation, following uncovered interest rate parity.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calculate\_risk\_free\_rate(macro\_data, method}\OperatorTok{=}\StringTok{"refinancing"}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Calculate risk{-}free rate proxy for Vietnamese market.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    macro\_data : pd.DataFrame}
\CommentTok{        DataFrame with macroeconomic data}
\CommentTok{    method : str}
\CommentTok{        Method for risk{-}free rate: \textquotesingle{}refinancing\textquotesingle{}, \textquotesingle{}bond\textquotesingle{}, or \textquotesingle{}adjusted\_us\textquotesingle{}}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        DataFrame with date and monthly risk{-}free rate}
\CommentTok{    """}
    \ControlFlowTok{if}\NormalTok{ method }\OperatorTok{==} \StringTok{"refinancing"}\NormalTok{:}
        \CommentTok{\# Use SBV refinancing rate, convert annual to monthly}
\NormalTok{        rf }\OperatorTok{=}\NormalTok{ macro\_data[[}\StringTok{"date"}\NormalTok{, }\StringTok{"refinancing\_rate"}\NormalTok{]].copy()}
\NormalTok{        rf[}\StringTok{"rf\_monthly"}\NormalTok{] }\OperatorTok{=}\NormalTok{ rf[}\StringTok{"refinancing\_rate"}\NormalTok{] }\OperatorTok{/} \DecValTok{12} \OperatorTok{/} \DecValTok{100}
        
    \ControlFlowTok{elif}\NormalTok{ method }\OperatorTok{==} \StringTok{"adjusted\_us"}\NormalTok{:}
        \CommentTok{\# US rate + expected VND depreciation}
        \CommentTok{\# Requires additional data on US rates and exchange rate expectations}
        \ControlFlowTok{pass}
    
    \ControlFlowTok{return}\NormalTok{ rf[[}\StringTok{"date"}\NormalTok{, }\StringTok{"rf\_monthly"}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\section{Setting Up a Database for Vietnamese Financial
Data}\label{setting-up-a-database-for-vietnamese-financial-data}

Managing financial data across multiple sources and formats requires a
systematic approach to data storage. We recommend using SQLite as the
primary database engine for several reasons: it requires no server
setup, stores the entire database in a single portable file, supports
standard SQL queries, and integrates seamlessly with Python through the
built-in sqlite3 module.

\subsection{Database Schema Design}\label{database-schema-design}

Our database schema is designed to support efficient queries for common
research tasks while maintaining data integrity. We create separate
tables for different data types with appropriate relationships.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ sqlite3}

\CommentTok{\# Create data directory if it doesn\textquotesingle{}t exist}
\ControlFlowTok{if} \KeywordTok{not}\NormalTok{ os.path.exists(}\StringTok{"data"}\NormalTok{):}
\NormalTok{    os.makedirs(}\StringTok{"data"}\NormalTok{)}

\CommentTok{\# Initialize SQLite database connection}
\NormalTok{tidy\_finance\_python }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(}
    \StringTok{"data/tidy\_finance\_python.sqlite"}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Storing Data}\label{storing-data}

With the database schema established, we can store our collected data
using pandas' to\_sql() method.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Store stock listing data}
\NormalTok{common\_stocks.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"stock\_master"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\CommentTok{\# Store stock price data}
\NormalTok{stock\_prices.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"stock\_prices\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\CommentTok{\# Store market indices}
\NormalTok{vn\_index.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"market\_indices"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\CommentTok{\# Store factor returns}
\NormalTok{factors\_vietnam.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"factors\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Querying and Updating the
Database}\label{querying-and-updating-the-database}

Once data is stored in the database, retrieval is straightforward using
SQL queries. The pandas read\_sql\_query() function executes a SQL
statement and returns the results as a DataFrame.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Query stock prices for specific symbols and date range}
\NormalTok{query }\OperatorTok{=} \StringTok{"""}
\StringTok{SELECT date, symbol, close, volume}
\StringTok{FROM stock\_prices\_daily}
\StringTok{WHERE symbol IN (\textquotesingle{}VNM\textquotesingle{}, \textquotesingle{}VIC\textquotesingle{}, \textquotesingle{}FPT\textquotesingle{}, \textquotesingle{}VHM\textquotesingle{}, \textquotesingle{}VCB\textquotesingle{})}
\StringTok{  AND date \textgreater{}= \textquotesingle{}2020{-}01{-}01\textquotesingle{}}
\StringTok{ORDER BY symbol, date}
\StringTok{"""}

\NormalTok{selected\_stocks }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\NormalTok{query,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}

\CommentTok{\# Query factor data merged with market returns}
\NormalTok{query\_factors }\OperatorTok{=} \StringTok{"""}
\StringTok{SELECT f.date, f.mkt\_rf, f.smb, f.hml, f.rf,}
\StringTok{       m.cpi\_yoy, m.credit\_growth}
\StringTok{FROM factors\_monthly f}
\StringTok{LEFT JOIN macro\_monthly m ON f.date = m.date}
\StringTok{WHERE f.date \textgreater{}= \textquotesingle{}2015{-}01{-}01\textquotesingle{}}
\StringTok{ORDER BY f.date}
\StringTok{"""}

\NormalTok{factor\_data }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\NormalTok{query\_factors,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance\_python,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Database Maintenance}\label{database-maintenance}

Regular database maintenance ensures optimal performance and data
integrity.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Optimize database}
\NormalTok{tidy\_finance\_python.execute(}\StringTok{"VACUUM"}\NormalTok{)}

\CommentTok{\# Check database integrity}
\NormalTok{integrity\_check }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
    \StringTok{"PRAGMA integrity\_check"}\NormalTok{,}
\NormalTok{    tidy\_finance\_python}
\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Integrity check: }\SpecialCharTok{\{}\NormalTok{integrity\_check}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}

\CommentTok{\# Get database statistics}
\NormalTok{table\_stats }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}\StringTok{"""}
\StringTok{    SELECT name, }
\StringTok{           (SELECT COUNT(*) FROM stock\_prices\_daily) as price\_rows,}
\StringTok{           (SELECT COUNT(*) FROM stock\_master) as stock\_count,}
\StringTok{           (SELECT COUNT(*) FROM factors\_monthly) as factor\_months}
\StringTok{    FROM sqlite\_master}
\StringTok{    WHERE type=\textquotesingle{}table\textquotesingle{} AND name=\textquotesingle{}stock\_master\textquotesingle{}}
\StringTok{"""}\NormalTok{, tidy\_finance\_python)}

\BuiltInTok{print}\NormalTok{(table\_stats)}

\CommentTok{\# Close connection when done}
\NormalTok{tidy\_finance\_python.close()}
\end{Highlighting}
\end{Shaded}

\section{Alternative Data Sources for Vietnamese
Markets}\label{alternative-data-sources-for-vietnamese-markets}

Beyond traditional price and fundamental data, researchers increasingly
incorporate alternative data sources to gain unique insights into market
dynamics.

\subsection{Foreign Investor Flow
Data}\label{foreign-investor-flow-data}

Foreign investor flow data is particularly valuable given the
significant role of foreign capital in Vietnamese equity markets. The
State Securities Commission publishes daily foreign ownership statistics
by security.

\subsection{News and Sentiment Data}\label{news-and-sentiment-data}

Media sentiment from Vietnamese financial news sources offers another
research avenue. Major outlets such as CafeF, VnExpress Finance, and
Vietstock publish real-time news that can be analyzed for market
sentiment.

\section{Key Takeaways}\label{key-takeaways-4}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Market Structure Understanding}: The Vietnamese financial
  market operates across three exchanges (HOSE, HNX, UPCoM) with
  distinct characteristics including foreign ownership limits, trading
  band restrictions, and a T+2 settlement cycle. Researchers must
  account for these institutional features in empirical analysis.
\item
  \textbf{Macroeconomic Data Challenges}: Unlike developed markets with
  standardized APIs (e.g., FRED), Vietnamese macroeconomic data requires
  manual collection from government sources (GSO, SBV). Researchers
  should plan for this additional data gathering effort and implement
  systematic data management practices.
\item
  \textbf{Database-Centric Workflow}: SQLite provides an efficient and
  portable database solution for managing Vietnamese financial data
  across research projects. The structured database approach enables
  reproducible research workflows, efficient queries, and easy data
  sharing among collaborators.
\item
  \textbf{Data Quality Imperative}: Data quality validation is
  especially important for emerging market data. Implementing systematic
  checks for missing values, extreme returns, duplicate entries, and
  cross-source validation helps ensure research reliability and
  reproducibility.
\item
  \textbf{Alternative Data Opportunities}: Foreign investor flows,
  corporate announcements, and media sentiment provide unique research
  opportunities in the Vietnamese market that can complement traditional
  price and fundamental analysis. These data sources can reveal insights
  about market dynamics not captured in standard datasets.
\item
  \textbf{Continuous Maintenance}: Financial databases require ongoing
  maintenance including incremental updates, integrity checks, and
  optimization. Establishing systematic update procedures ensures data
  currency and database performance over time.
\end{enumerate}

\bookmarksetup{startatroot}

\chapter{Datacore Data}\label{datacore-data}

This chapter introduces \href{https://datacore.vn/}{Datacore}, Vietnam's
data platform for academic, corporate, and government research. Datacore
provides comprehensive financial and economic datasets, including
historical trading data, company fundamentals, and macroeconomic
indicators essential for reproducible finance research. We use Datacore
as the primary data source throughout this book.

\section{Data Access Options}\label{data-access-options}

Readers can access the data used in this book through several channels:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Institutional subscription}: Many universities and research
  institutions subscribe to Datacore. Check with your library or
  research office for access credentials. If your institution does not
  yet have a subscription, consider requesting one through your
  library's acquisition process---Datacore offers institutional pricing
  for academic use.
\item
  \textbf{Demo datasets}: Datacore provides
  \href{https://datacore.vn/demo/dataset-groups}{demo datasets} that
  allow you to run the code examples in this book with sample data.
\end{enumerate}

\section{Chapter Overview}\label{chapter-overview}

The chapter is organized as follows. We first establish the connection
to Datacore's cloud storage infrastructure. Then, we download and
prepare company fundamentals data, including balance sheet items, income
statement variables, and derived metrics essential for asset pricing
research. Next, we retrieve and process stock price data, computing
returns, market capitalizations, and excess returns. We conclude by
merging these datasets and providing descriptive statistics that
characterize the Vietnamese equity market.

\section{Setting Up the Environment}\label{setting-up-the-environment}

We begin by loading the Python packages used throughout this chapter.
The core packages include \texttt{pandas} for data manipulation,
\texttt{numpy} for numerical operations, and \texttt{sqlite3} for local
database management. We also import visualization libraries for creating
publication-quality figures.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ sqlite3}
\ImportTok{from}\NormalTok{ datetime }\ImportTok{import}\NormalTok{ datetime}
\ImportTok{from}\NormalTok{ io }\ImportTok{import}\NormalTok{ BytesIO}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ comma\_format, percent\_format}
\end{Highlighting}
\end{Shaded}

We establish a connection to our local SQLite database, which serves as
the central repository for all processed data. This database was
introduced in the previous chapter and will store the cleaned datasets
for use in subsequent analyses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We define the date range for our data collection. The Vietnamese stock
market began operations in July 2000 with the establishment of the Ho
Chi Minh City Stock Exchange (HOSE), so our sample period starts from
2000 and extends through the end of 2024.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=} \StringTok{"2000{-}01{-}01"}
\NormalTok{end\_date }\OperatorTok{=} \StringTok{"2024{-}12{-}31"}
\end{Highlighting}
\end{Shaded}

\section{Connecting to Datacore}\label{connecting-to-datacore}

Datacore delivers data through a cloud-based object storage system built
on MinIO, an S3-compatible storage infrastructure. This architecture
enables efficient, programmatic access to large datasets without the
limitations of traditional database connections. To access the data, you
need credentials provided by Datacore upon subscription: an endpoint
URL, access key, and secret key.

The following class establishes the connection to Datacore's storage
system. The credentials are stored as environment variables for
security, following best practices for credential management in research
computing environments.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ os}
\ImportTok{import}\NormalTok{ boto3}
\ImportTok{from}\NormalTok{ botocore.client }\ImportTok{import}\NormalTok{ Config}

\KeywordTok{class}\NormalTok{ DatacoreConnection:}
    \CommentTok{"""}
\CommentTok{    Connection handler for Datacore\textquotesingle{}s MinIO{-}based storage system.}
\CommentTok{    }
\CommentTok{    This class manages authentication and provides methods for}
\CommentTok{    accessing financial datasets stored in Datacore\textquotesingle{}s cloud infrastructure.}
\CommentTok{    }
\CommentTok{    Attributes}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    s3 : boto3.client}
\CommentTok{        S3{-}compatible client for interacting with Datacore storage}
\CommentTok{    """}
    
    \KeywordTok{def} \FunctionTok{\_\_init\_\_}\NormalTok{(}\VariableTok{self}\NormalTok{):}
        \CommentTok{"""Initialize connection using environment variables."""}
        \VariableTok{self}\NormalTok{.MINIO\_ENDPOINT }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ENDPOINT"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_ACCESS\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_SECRET\_KEY"}\NormalTok{]}
        \VariableTok{self}\NormalTok{.REGION }\OperatorTok{=}\NormalTok{ os.getenv(}\StringTok{"MINIO\_REGION"}\NormalTok{, }\StringTok{"us{-}east{-}1"}\NormalTok{)}
        
        \VariableTok{self}\NormalTok{.s3 }\OperatorTok{=}\NormalTok{ boto3.client(}
            \StringTok{"s3"}\NormalTok{,}
\NormalTok{            endpoint\_url}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ENDPOINT,}
\NormalTok{            aws\_access\_key\_id}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_ACCESS\_KEY,}
\NormalTok{            aws\_secret\_access\_key}\OperatorTok{=}\VariableTok{self}\NormalTok{.MINIO\_SECRET\_KEY,}
\NormalTok{            region\_name}\OperatorTok{=}\VariableTok{self}\NormalTok{.REGION,}
\NormalTok{            config}\OperatorTok{=}\NormalTok{Config(signature\_version}\OperatorTok{=}\StringTok{"s3v4"}\NormalTok{),}
\NormalTok{        )}
    
    \KeywordTok{def}\NormalTok{ test\_connection(}\VariableTok{self}\NormalTok{):}
        \CommentTok{"""Verify connection by listing available buckets."""}
\NormalTok{        response }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.list\_buckets()}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"Connected successfully. Available buckets:"}\NormalTok{)}
        \ControlFlowTok{for}\NormalTok{ bucket }\KeywordTok{in}\NormalTok{ response.get(}\StringTok{"Buckets"}\NormalTok{, []):}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  {-} }\SpecialCharTok{\{}\NormalTok{bucket[}\StringTok{\textquotesingle{}Name\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
    
    \KeywordTok{def}\NormalTok{ list\_objects(}\VariableTok{self}\NormalTok{, bucket\_name, prefix}\OperatorTok{=}\StringTok{""}\NormalTok{):}
        \CommentTok{"""List objects in a bucket with optional prefix filter."""}
\NormalTok{        response }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.list\_objects\_v2(}
\NormalTok{            Bucket}\OperatorTok{=}\NormalTok{bucket\_name, }
\NormalTok{            Prefix}\OperatorTok{=}\NormalTok{prefix}
\NormalTok{        )}
        \ControlFlowTok{return}\NormalTok{ [obj[}\StringTok{"Key"}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ obj }\KeywordTok{in}\NormalTok{ response.get(}\StringTok{"Contents"}\NormalTok{, [])]}
    
    \KeywordTok{def}\NormalTok{ read\_excel(}\VariableTok{self}\NormalTok{, bucket\_name, key):}
        \CommentTok{"""Read an Excel file from Datacore storage."""}
\NormalTok{        obj }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.get\_object(Bucket}\OperatorTok{=}\NormalTok{bucket\_name, Key}\OperatorTok{=}\NormalTok{key)}
        \ControlFlowTok{return}\NormalTok{ pd.read\_excel(BytesIO(obj[}\StringTok{"Body"}\NormalTok{].read()))}
    
    \KeywordTok{def}\NormalTok{ read\_csv(}\VariableTok{self}\NormalTok{, bucket\_name, key, }\OperatorTok{**}\NormalTok{kwargs):}
        \CommentTok{"""Read a CSV file from Datacore storage."""}
\NormalTok{        obj }\OperatorTok{=} \VariableTok{self}\NormalTok{.s3.get\_object(Bucket}\OperatorTok{=}\NormalTok{bucket\_name, Key}\OperatorTok{=}\NormalTok{key)}
        \ControlFlowTok{return}\NormalTok{ pd.read\_csv(BytesIO(obj[}\StringTok{"Body"}\NormalTok{].read()), }\OperatorTok{**}\NormalTok{kwargs)}
\end{Highlighting}
\end{Shaded}

With the connection class defined, we can establish a connection and
verify access to Datacore's data repositories.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Initialize connection}
\NormalTok{conn }\OperatorTok{=}\NormalTok{ DatacoreConnection()}
\NormalTok{conn.test\_connection()}

\CommentTok{\# Get bucket name from environment}
\NormalTok{bucket\_name }\OperatorTok{=}\NormalTok{ os.environ[}\StringTok{"MINIO\_BUCKET"}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Connected successfully. Available buckets:
  - dsteam-data
  - rawbctc
\end{verbatim}

\section{Company Fundamentals Data}\label{company-fundamentals-data}

Firm accounting data are essential for portfolio analyses, factor
construction, and valuation studies. Datacore hosts comprehensive
fundamentals data for Vietnamese listed companies, including annual and
quarterly financial statements prepared according to Vietnamese
Accounting Standards (VAS).

\subsection{Understanding Vietnamese Financial
Statements}\label{understanding-vietnamese-financial-statements}

Before processing the data, it is important to understand the structure
of Vietnamese financial reports. Vietnamese companies follow VAS, which
shares similarities with International Financial Reporting Standards
(IFRS) but has notable differences:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Fiscal Year}: Most Vietnamese companies use a calendar fiscal
  year ending December 31, though some companies (particularly in retail
  and agriculture) use different fiscal year-ends.
\item
  \textbf{Reporting Frequency}: Listed companies must publish quarterly
  financial statements within 20 days of quarter-end and annual audited
  statements within 90 days of fiscal year-end.
\item
  \textbf{Industry-Specific Formats}: Companies in banking, insurance,
  and securities sectors follow specialized reporting formats that
  differ from the standard industrial format.
\item
  \textbf{Currency}: All figures are reported in Vietnamese Dong (VND).
  Given the large nominal values (millions to trillions of VND), we
  often scale figures to millions or billions for readability.
\end{enumerate}

\subsection{Downloading Fundamentals
Data}\label{downloading-fundamentals-data}

Datacore organizes fundamentals data in Excel files partitioned by time
period for efficient access. We download and concatenate these files to
create a comprehensive dataset spanning our sample period.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define paths to fundamentals data files}
\NormalTok{fundamentals\_paths }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"fundamental\_annual\_1767674486317/fundamental\_annual\_1.xlsx"}\NormalTok{,}
    \StringTok{"fundamental\_annual\_1767674486317/fundamental\_annual\_2.xlsx"}\NormalTok{,}
    \StringTok{"fundamental\_annual\_1767674486317/fundamental\_annual\_3.xlsx"}\NormalTok{,}
\NormalTok{]}

\CommentTok{\# Download and combine all files}
\NormalTok{fundamentals\_list }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ path }\KeywordTok{in}\NormalTok{ fundamentals\_paths:}
\NormalTok{    df\_temp }\OperatorTok{=}\NormalTok{ conn.read\_excel(bucket\_name, path)}
\NormalTok{    fundamentals\_list.append(df\_temp)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Downloaded: }\SpecialCharTok{\{}\NormalTok{path}\SpecialCharTok{\}}\SpecialStringTok{ (}\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df\_temp)}\SpecialCharTok{:,\}}\SpecialStringTok{ rows)"}\NormalTok{)}

\NormalTok{df\_fundamentals\_raw }\OperatorTok{=}\NormalTok{ pd.concat(fundamentals\_list, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Total observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df\_fundamentals\_raw)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Downloaded: fundamental_annual_1767674486317/fundamental_annual_1.xlsx (10,000 rows)
\end{verbatim}

\begin{verbatim}
Downloaded: fundamental_annual_1767674486317/fundamental_annual_2.xlsx (10,000 rows)
\end{verbatim}

\begin{verbatim}
Downloaded: fundamental_annual_1767674486317/fundamental_annual_3.xlsx (2,821 rows)

Total observations: 22,821
\end{verbatim}

\subsection{Cleaning and Standardizing
Fundamentals}\label{cleaning-and-standardizing-fundamentals}

The raw fundamentals data requires several cleaning steps to ensure
consistency and usability. We standardize variable names, handle missing
values, and create derived variables commonly used in asset pricing
research.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ clean\_fundamentals(df):}
    \CommentTok{"""}
\CommentTok{    Clean and standardize company fundamentals data.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Raw fundamentals data from Datacore}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Cleaned fundamentals with standardized column names}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Standardize identifiers}
\NormalTok{    df[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"symbol"}\NormalTok{].astype(}\BuiltInTok{str}\NormalTok{).}\BuiltInTok{str}\NormalTok{.upper().}\BuiltInTok{str}\NormalTok{.strip()}
\NormalTok{    df[}\StringTok{"year"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_numeric(df[}\StringTok{"year"}\NormalTok{], errors}\OperatorTok{=}\StringTok{"coerce"}\NormalTok{).astype(}\StringTok{"Int64"}\NormalTok{)}
    
    \CommentTok{\# Drop rows with missing identifiers}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{])}
    
    \CommentTok{\# Define columns that should be numeric}
\NormalTok{    numeric\_columns }\OperatorTok{=}\NormalTok{ [}
        \StringTok{"total\_asset"}\NormalTok{, }\StringTok{"total\_equity"}\NormalTok{, }\StringTok{"total\_liabilities"}\NormalTok{,}
        \StringTok{"total\_current\_asset"}\NormalTok{, }\StringTok{"total\_current\_liabilities"}\NormalTok{,}
        \StringTok{"is\_net\_revenue"}\NormalTok{, }\StringTok{"is\_cogs"}\NormalTok{, }\StringTok{"is\_manage\_expense"}\NormalTok{,}
        \StringTok{"is\_interest\_expense"}\NormalTok{, }\StringTok{"is\_eat"}\NormalTok{, }\StringTok{"is\_net\_business\_profit"}\NormalTok{,}
        \StringTok{"na\_tax\_deferred"}\NormalTok{, }\StringTok{"nl\_tax\_deferred"}\NormalTok{, }\StringTok{"e\_preferred\_stock"}\NormalTok{,}
        \StringTok{"capex"}\NormalTok{, }\StringTok{"total\_cfo"}\NormalTok{, }\StringTok{"ca\_cce"}\NormalTok{, }\StringTok{"ca\_total\_inventory"}\NormalTok{,}
        \StringTok{"ca\_acc\_receiv"}\NormalTok{, }\StringTok{"cfo\_interest\_expense"}\NormalTok{, }\StringTok{"basic\_eps"}\NormalTok{,}
        \StringTok{"is\_shareholders\_eat"}\NormalTok{, }\StringTok{"cl\_loan"}\NormalTok{, }\StringTok{"cl\_finlease"}\NormalTok{,}
        \StringTok{"cl\_due\_long\_debt"}\NormalTok{, }\StringTok{"nl\_loan"}\NormalTok{, }\StringTok{"nl\_finlease"}\NormalTok{,}
        \StringTok{"is\_cos\_of\_sales"}\NormalTok{, }\StringTok{"e\_equity"}
\NormalTok{    ]}
    
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ numeric\_columns:}
        \ControlFlowTok{if}\NormalTok{ col }\KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{            df[col] }\OperatorTok{=}\NormalTok{ pd.to\_numeric(df[col], errors}\OperatorTok{=}\StringTok{"coerce"}\NormalTok{)}
    
    \CommentTok{\# Handle duplicates: keep row with most non{-}missing values}
\NormalTok{    df[}\StringTok{"\_completeness"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.notna().}\BuiltInTok{sum}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ (df}
\NormalTok{        .sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"\_completeness"}\NormalTok{])}
\NormalTok{        .drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
\NormalTok{        .drop(columns}\OperatorTok{=}\StringTok{"\_completeness"}\NormalTok{)}
\NormalTok{        .reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ clean\_fundamentals(df\_fundamentals\_raw)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"After cleaning: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df\_fundamentals)}\SpecialCharTok{:,\}}\SpecialStringTok{ firm{-}year observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique firms: }\SpecialCharTok{\{}\NormalTok{df\_fundamentals[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
After cleaning: 21,232 firm-year observations
Unique firms: 1,554
\end{verbatim}

\subsection{Creating Standardized
Variables}\label{creating-standardized-variables}

To facilitate comparison with international studies and ensure
compatibility with standard asset pricing methodologies, we create
variables following conventions established in the academic literature.
We map Vietnamese financial statement items to their Compustat
equivalents where possible.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ create\_standard\_variables(df):}
    \CommentTok{"""}
\CommentTok{    Create standardized financial variables for asset pricing research.}
\CommentTok{    }
\CommentTok{    This function maps Vietnamese financial statement items to standard}
\CommentTok{    variable names used in the academic finance literature, following}
\CommentTok{    conventions from Fama and French (1992, 1993, 2015).}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Cleaned fundamentals data}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Fundamentals with standardized variables added}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Fiscal date (assume December year{-}end)}
\NormalTok{    df[}\StringTok{"datadate"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(df[}\StringTok{"year"}\NormalTok{].astype(}\BuiltInTok{str}\NormalTok{) }\OperatorTok{+} \StringTok{"{-}12{-}31"}\NormalTok{)}
    
    \CommentTok{\# === Balance Sheet Items ===}
\NormalTok{    df[}\StringTok{"at"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"total\_asset"}\NormalTok{]                    }\CommentTok{\# Total assets}
\NormalTok{    df[}\StringTok{"lt"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"total\_liabilities"}\NormalTok{]              }\CommentTok{\# Total liabilities}
\NormalTok{    df[}\StringTok{"seq"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"total\_equity"}\NormalTok{]                  }\CommentTok{\# Stockholders\textquotesingle{} equity}
\NormalTok{    df[}\StringTok{"act"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"total\_current\_asset"}\NormalTok{]           }\CommentTok{\# Current assets}
\NormalTok{    df[}\StringTok{"lct"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"total\_current\_liabilities"}\NormalTok{]     }\CommentTok{\# Current liabilities}
    
    \CommentTok{\# Common equity (fallback to total equity if not available)}
\NormalTok{    df[}\StringTok{"ceq"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"e\_equity"}\NormalTok{, df[}\StringTok{"seq"}\NormalTok{])}
    
    \CommentTok{\# === Deferred Taxes ===}
\NormalTok{    df[}\StringTok{"txditc"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"na\_tax\_deferred"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)  }\CommentTok{\# Deferred tax assets}
\NormalTok{    df[}\StringTok{"txdb"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"nl\_tax\_deferred"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)    }\CommentTok{\# Deferred tax liab.}
\NormalTok{    df[}\StringTok{"itcb"}\NormalTok{] }\OperatorTok{=} \DecValTok{0}  \CommentTok{\# Investment tax credit (rare in Vietnam)}
    
    \CommentTok{\# === Preferred Stock ===}
\NormalTok{    pref }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"e\_preferred\_stock"}\NormalTok{, }\DecValTok{0}\NormalTok{)}
    \ControlFlowTok{if} \BuiltInTok{isinstance}\NormalTok{(pref, pd.Series):}
\NormalTok{        pref }\OperatorTok{=}\NormalTok{ pref.fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    df[}\StringTok{"pstk"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pref}
\NormalTok{    df[}\StringTok{"pstkrv"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pref  }\CommentTok{\# Redemption value}
\NormalTok{    df[}\StringTok{"pstkl"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pref   }\CommentTok{\# Liquidating value}
    
    \CommentTok{\# === Income Statement Items ===}
\NormalTok{    df[}\StringTok{"sale"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"is\_net\_revenue"}\NormalTok{]                        }\CommentTok{\# Net sales/revenue}
\NormalTok{    df[}\StringTok{"cogs"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"is\_cogs"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)              }\CommentTok{\# Cost of goods sold}
\NormalTok{    df[}\StringTok{"xsga"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"is\_manage\_expense"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)    }\CommentTok{\# SG\&A expenses}
\NormalTok{    df[}\StringTok{"xint"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"is\_interest\_expense"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)  }\CommentTok{\# Interest expense}
\NormalTok{    df[}\StringTok{"ni"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"is\_eat"}\NormalTok{, np.nan)                      }\CommentTok{\# Net income}
\NormalTok{    df[}\StringTok{"oibdp"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"is\_net\_business\_profit"}\NormalTok{, np.nan)   }\CommentTok{\# Operating income}
    
    \CommentTok{\# === Cash Flow Items ===}
\NormalTok{    df[}\StringTok{"oancf"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"total\_cfo"}\NormalTok{, np.nan)  }\CommentTok{\# Operating cash flow}
\NormalTok{    df[}\StringTok{"capx"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.get(}\StringTok{"capex"}\NormalTok{, np.nan)       }\CommentTok{\# Capital expenditures}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ create\_standard\_variables(df\_fundamentals)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Book Equity and
Profitability}\label{computing-book-equity-and-profitability}

Book equity is a crucial variable for value investing strategies and the
construction of HML (High Minus Low) factor portfolios. We follow the
definition from Kenneth French's data library, which accounts for
deferred taxes and preferred stock.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_book\_equity(df):}
    \CommentTok{"""}
\CommentTok{    Compute book equity following Fama{-}French conventions.}
\CommentTok{    }
\CommentTok{    Book equity = Stockholders\textquotesingle{} equity }
\CommentTok{                  + Deferred taxes and investment tax credit}
\CommentTok{                  {-} Preferred stock}
\CommentTok{    }
\CommentTok{    Negative or zero book equity is set to missing, as book{-}to{-}market}
\CommentTok{    ratios are undefined for such firms.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Fundamentals with standardized variables}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Fundamentals with book equity (be) added}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Primary measure: stockholders\textquotesingle{} equity}
    \CommentTok{\# Fallback 1: common equity + preferred stock}
    \CommentTok{\# Fallback 2: total assets {-} total liabilities}
\NormalTok{    seq\_measure }\OperatorTok{=}\NormalTok{ (df[}\StringTok{"seq"}\NormalTok{]}
\NormalTok{        .combine\_first(df[}\StringTok{"ceq"}\NormalTok{] }\OperatorTok{+}\NormalTok{ df[}\StringTok{"pstk"}\NormalTok{])}
\NormalTok{        .combine\_first(df[}\StringTok{"at"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{"lt"}\NormalTok{])}
\NormalTok{    )}
    
    \CommentTok{\# Add deferred taxes}
\NormalTok{    deferred\_taxes }\OperatorTok{=}\NormalTok{ (df[}\StringTok{"txditc"}\NormalTok{]}
\NormalTok{        .combine\_first(df[}\StringTok{"txdb"}\NormalTok{] }\OperatorTok{+}\NormalTok{ df[}\StringTok{"itcb"}\NormalTok{])}
\NormalTok{        .fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Subtract preferred stock (use redemption value as primary)}
\NormalTok{    preferred }\OperatorTok{=}\NormalTok{ (df[}\StringTok{"pstkrv"}\NormalTok{]}
\NormalTok{        .combine\_first(df[}\StringTok{"pstkl"}\NormalTok{])}
\NormalTok{        .combine\_first(df[}\StringTok{"pstk"}\NormalTok{])}
\NormalTok{        .fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Book equity calculation}
\NormalTok{    df[}\StringTok{"be"}\NormalTok{] }\OperatorTok{=}\NormalTok{ seq\_measure }\OperatorTok{+}\NormalTok{ deferred\_taxes }\OperatorTok{{-}}\NormalTok{ preferred}
    
    \CommentTok{\# Set non{-}positive book equity to missing}
\NormalTok{    df[}\StringTok{"be"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"be"}\NormalTok{].where(df[}\StringTok{"be"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, np.nan)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ compute\_book\_equity(df\_fundamentals)}

\CommentTok{\# Summary statistics for book equity}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Book Equity Summary Statistics (in million VND):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(df\_fundamentals[}\StringTok{"be"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Book Equity Summary Statistics (in million VND):
count    2.023500e+04
mean     1.031884e+12
std      4.705269e+12
min      4.404402e+07
25%      7.267610e+10
50%      1.803885e+11
75%      5.304653e+11
max      1.836314e+14
Name: be, dtype: float64
\end{verbatim}

Operating profitability, introduced by Eugene F. Fama and French (2015),
measures a firm's profits relative to its book equity. Firms with higher
operating profitability tend to have higher expected returns.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_profitability(df):}
    \CommentTok{"""}
\CommentTok{    Compute operating profitability following Fama{-}French (2015).}
\CommentTok{    }
\CommentTok{    Operating profitability = (Revenue {-} COGS {-} SG\&A {-} Interest) / Book Equity}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Fundamentals with book equity computed}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Fundamentals with operating profitability (op) added}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Operating profit before taxes}
\NormalTok{    operating\_profit }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        df[}\StringTok{"sale"}\NormalTok{] }
        \OperatorTok{{-}}\NormalTok{ df[}\StringTok{"cogs"}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{) }
        \OperatorTok{{-}}\NormalTok{ df[}\StringTok{"xsga"}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{) }
        \OperatorTok{{-}}\NormalTok{ df[}\StringTok{"xint"}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Scale by book equity}
\NormalTok{    df[}\StringTok{"op"}\NormalTok{] }\OperatorTok{=}\NormalTok{ operating\_profit }\OperatorTok{/}\NormalTok{ df[}\StringTok{"be"}\NormalTok{]}
    
    \CommentTok{\# Winsorize extreme values (outside 1st and 99th percentiles)}
\NormalTok{    lower }\OperatorTok{=}\NormalTok{ df[}\StringTok{"op"}\NormalTok{].quantile(}\FloatTok{0.01}\NormalTok{)}
\NormalTok{    upper }\OperatorTok{=}\NormalTok{ df[}\StringTok{"op"}\NormalTok{].quantile(}\FloatTok{0.99}\NormalTok{)}
\NormalTok{    df[}\StringTok{"op"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"op"}\NormalTok{].clip(lower}\OperatorTok{=}\NormalTok{lower, upper}\OperatorTok{=}\NormalTok{upper)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ compute\_profitability(df\_fundamentals)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Investment}\label{computing-investment}

Investment, measured as asset growth, captures firms' investment
behavior. Eugene F. Fama and French (2015) document that firms with high
asset growth (aggressive investment) tend to have lower future returns.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_investment(df):}
    \CommentTok{"""}
\CommentTok{    Compute investment (asset growth) following Fama{-}French (2015).}
\CommentTok{    }
\CommentTok{    Investment = (Total Assets\_t / Total Assets\_\{t{-}1\}) {-} 1}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Fundamentals data}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Fundamentals with investment (inv) added}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Create lagged assets}
\NormalTok{    df\_lag }\OperatorTok{=}\NormalTok{ (df[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"at"}\NormalTok{]]}
\NormalTok{        .assign(year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"year"}\NormalTok{] }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{        .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"at"}\NormalTok{: }\StringTok{"at\_lag"}\NormalTok{\})}
\NormalTok{    )}
    
    \CommentTok{\# Merge lagged values}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.merge(df\_lag, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
    
    \CommentTok{\# Compute investment (asset growth)}
\NormalTok{    df[}\StringTok{"inv"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"at"}\NormalTok{] }\OperatorTok{/}\NormalTok{ df[}\StringTok{"at\_lag"}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
    
    \CommentTok{\# Set to missing if lagged assets non{-}positive}
\NormalTok{    df[}\StringTok{"inv"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"inv"}\NormalTok{].where(df[}\StringTok{"at\_lag"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, np.nan)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ compute\_investment(df\_fundamentals)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Total Debt}\label{computing-total-debt}

In Vietnamese financial statements, total liabilities include
non-interest-bearing items such as accounts payable and tax payables.
For leverage analysis, we compute total interest-bearing debt by
aggregating loan and lease obligations.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_total\_debt(df):}
    \CommentTok{"""}
\CommentTok{    Compute total interest{-}bearing debt.}
\CommentTok{    }
\CommentTok{    Total Debt = Short{-}term loans + Finance leases (current)}
\CommentTok{                 + Current portion of long{-}term debt}
\CommentTok{                 + Long{-}term loans + Finance leases (non{-}current)}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        Fundamentals data}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Fundamentals with total\_debt added}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
\NormalTok{    df[}\StringTok{"total\_debt"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        df.get(}\StringTok{"cl\_loan"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{) }\OperatorTok{+}           \CommentTok{\# Short{-}term bank loans}
\NormalTok{        df.get(}\StringTok{"cl\_finlease"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{) }\OperatorTok{+}       \CommentTok{\# Current finance leases}
\NormalTok{        df.get(}\StringTok{"cl\_due\_long\_debt"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{) }\OperatorTok{+}  \CommentTok{\# Current portion LT debt}
\NormalTok{        df.get(}\StringTok{"nl\_loan"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{) }\OperatorTok{+}           \CommentTok{\# Long{-}term bank loans}
\NormalTok{        df.get(}\StringTok{"nl\_finlease"}\NormalTok{, }\DecValTok{0}\NormalTok{).fillna(}\DecValTok{0}\NormalTok{)         }\CommentTok{\# Non{-}current finance leases}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{df\_fundamentals }\OperatorTok{=}\NormalTok{ compute\_total\_debt(df\_fundamentals)}
\end{Highlighting}
\end{Shaded}

\subsection{Applying Filters and Final
Preparation}\label{applying-filters-and-final-preparation}

We apply standard filters to ensure data quality: requiring positive
assets, non-negative sales, and presence of core variables needed for
portfolio construction.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Keep only observations with required variables}
\NormalTok{required\_vars }\OperatorTok{=}\NormalTok{ [}\StringTok{"at"}\NormalTok{, }\StringTok{"lt"}\NormalTok{, }\StringTok{"seq"}\NormalTok{, }\StringTok{"sale"}\NormalTok{]}
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ df\_fundamentals.dropna(subset}\OperatorTok{=}\NormalTok{required\_vars)}

\CommentTok{\# Apply quality filters}
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ comp\_vn.query(}\StringTok{"at \textgreater{} 0"}\NormalTok{)      }\CommentTok{\# Positive assets}
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ comp\_vn.query(}\StringTok{"sale \textgreater{}= 0"}\NormalTok{)   }\CommentTok{\# Non{-}negative sales}

\CommentTok{\# Keep last observation per firm{-}year (in case of restatements)}
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ (comp\_vn}
\NormalTok{    .sort\_values(}\StringTok{"datadate"}\NormalTok{)}
\NormalTok{    .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{])}
\NormalTok{    .tail(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Diagnostic summary}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Final sample: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(comp\_vn)}\SpecialCharTok{:,\}}\SpecialStringTok{ firm{-}year observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique firms: }\SpecialCharTok{\{}\NormalTok{comp\_vn[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Sample period: }\SpecialCharTok{\{}\NormalTok{comp\_vn[}\StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{ {-} }\SpecialCharTok{\{}\NormalTok{comp\_vn[}\StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Final sample: 20,091 firm-year observations
Unique firms: 1,502
Sample period: 1998 - 2023
\end{verbatim}

\subsection{Storing Fundamentals Data}\label{storing-fundamentals-data}

We store the prepared fundamentals data in our local SQLite database for
use in subsequent chapters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{comp\_vn.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"comp\_vn"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Company fundamentals saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Company fundamentals saved to database.
\end{verbatim}

\section{Stock Price Data}\label{stock-price-data}

Stock price data forms the foundation of return-based analyses in
empirical finance. Datacore provides comprehensive historical price data
for all securities traded on HOSE, HNX, and UPCoM, including adjusted
prices that account for corporate actions.

\subsection{Downloading Price Data}\label{downloading-price-data}

We download the historical price data from Datacore's storage system.
The data includes daily observations with open, high, low, close prices,
trading volume, and adjustment factors.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Download historical price data}
\NormalTok{prices\_raw }\OperatorTok{=}\NormalTok{ conn.read\_csv(}
\NormalTok{    bucket\_name,}
    \StringTok{"historycal\_price/dataset\_historical\_price.csv"}\NormalTok{,}
\NormalTok{    low\_memory}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Downloaded }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_raw)}\SpecialCharTok{:,\}}\SpecialStringTok{ daily price observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{prices\_raw[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{prices\_raw[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Downloaded 4,307,791 daily price observations
Date range: 2010-01-04 to 2025-05-12
\end{verbatim}

\subsection{Processing Price Data}\label{processing-price-data}

We clean the price data and compute adjusted prices that account for
stock splits, stock dividends, and other corporate actions.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ process\_price\_data(df):}
    \CommentTok{"""}
\CommentTok{    Process raw price data from Datacore.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Parse dates}
\NormalTok{    df[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(df[}\StringTok{"date"}\NormalTok{])}
    
    \CommentTok{\# Standardize column names}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.rename(columns}\OperatorTok{=}\NormalTok{\{}
        \StringTok{"open\_price"}\NormalTok{: }\StringTok{"open"}\NormalTok{,}
        \StringTok{"high\_price"}\NormalTok{: }\StringTok{"high"}\NormalTok{,}
        \StringTok{"low\_price"}\NormalTok{: }\StringTok{"low"}\NormalTok{,}
        \StringTok{"close\_price"}\NormalTok{: }\StringTok{"close"}\NormalTok{,}
        \StringTok{"vol\_total"}\NormalTok{: }\StringTok{"volume"}
\NormalTok{    \})}
    
    \CommentTok{\# Compute adjusted close price}
\NormalTok{    df[}\StringTok{"adjusted\_close"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"close"}\NormalTok{] }\OperatorTok{*}\NormalTok{ df[}\StringTok{"adj\_ratio"}\NormalTok{]}
    
    \CommentTok{\# Standardize symbol}
\NormalTok{    df[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"symbol"}\NormalTok{].astype(}\BuiltInTok{str}\NormalTok{).}\BuiltInTok{str}\NormalTok{.upper().}\BuiltInTok{str}\NormalTok{.strip()}
    
    \CommentTok{\# Sort for return calculation}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
    
    \CommentTok{\# Add year and month}
\NormalTok{    df[}\StringTok{"year"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"date"}\NormalTok{].dt.year}
\NormalTok{    df[}\StringTok{"month"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"date"}\NormalTok{].dt.month}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{prices }\OperatorTok{=}\NormalTok{ process\_price\_data(prices\_raw)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Shares Outstanding and Market
Capitalization}\label{computing-shares-outstanding-and-market-capitalization}

Market capitalization is computed as the product of price and shares
outstanding. Since Datacore provides earnings per share and net income,
we can infer shares outstanding from these variables.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_shares\_outstanding(fundamentals\_df):}
    \CommentTok{"""}
\CommentTok{    Compute shares outstanding from fundamentals.}
\CommentTok{    """}
\NormalTok{    shares }\OperatorTok{=}\NormalTok{ fundamentals\_df.copy()}
\NormalTok{    shares[}\StringTok{"shrout"}\NormalTok{] }\OperatorTok{=}\NormalTok{ shares[}\StringTok{"is\_shareholders\_eat"}\NormalTok{] }\OperatorTok{/}\NormalTok{ shares[}\StringTok{"basic\_eps"}\NormalTok{]}
\NormalTok{    shares }\OperatorTok{=}\NormalTok{ shares[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"shrout"}\NormalTok{]].dropna()}
    
    \ControlFlowTok{return}\NormalTok{ shares}

\NormalTok{shares\_outstanding }\OperatorTok{=}\NormalTok{ compute\_shares\_outstanding(df\_fundamentals)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ add\_market\_cap(df, shares\_df):}
    \CommentTok{"""}
\CommentTok{    Add market capitalization to price data.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.merge(shares\_df, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
    
    \CommentTok{\# Compute market cap (in million VND)}
\NormalTok{    df[}\StringTok{"mktcap"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{"close"}\NormalTok{] }\OperatorTok{*}\NormalTok{ df[}\StringTok{"shrout"}\NormalTok{]) }\OperatorTok{/} \DecValTok{1\_000\_000}
    
    \CommentTok{\# Set zero or negative market cap to missing}
\NormalTok{    df[}\StringTok{"mktcap"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"mktcap"}\NormalTok{].where(df[}\StringTok{"mktcap"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, np.nan)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{prices }\OperatorTok{=}\NormalTok{ add\_market\_cap(prices, shares\_outstanding)}
\end{Highlighting}
\end{Shaded}

\subsection{Computing Returns and Excess
Returns}\label{computing-returns-and-excess-returns}

We compute returns using adjusted closing prices to ensure returns
correctly reflect total shareholder returns including dividends and
corporate actions.

\subsubsection{Creating Daily Dataset}\label{creating-daily-dataset}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Sequential version
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ create\_daily\_dataset(df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Create daily price dataset with returns and excess returns.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Sort by symbol and date (critical for correct return calculation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Remove duplicate dates within each symbol (keep last observation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
    
    \CommentTok{\# Compute daily returns}
\NormalTok{    df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}
    
    \CommentTok{\# Cap extreme negative returns}
\NormalTok{    df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{0.99}\NormalTok{)}
    
    \CommentTok{\# Daily risk{-}free rate (assuming 252 trading days)}
\NormalTok{    df[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=}\NormalTok{ annual\_rf }\OperatorTok{/} \DecValTok{252}
    
    \CommentTok{\# Excess returns}
\NormalTok{    df[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    df[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret\_excess"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{1.0}\NormalTok{)}
    
    \CommentTok{\# Lagged market cap}
\NormalTok{    df[}\StringTok{"mktcap\_lag"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"mktcap"}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ create\_daily\_dataset(prices)}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Parallel version
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ joblib }\ImportTok{import}\NormalTok{ Parallel, delayed}
\ImportTok{import}\NormalTok{ os}

\KeywordTok{def}\NormalTok{ process\_daily\_symbol(symbol\_df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Process a single symbol\textquotesingle{}s daily data.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ symbol\_df.copy()}
    
    \CommentTok{\# Sort by date (critical for correct return calculation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values(}\StringTok{"date"}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Remove duplicate dates (keep last observation if duplicates exist)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
    
    \CommentTok{\# Compute daily returns}
\NormalTok{    df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}

    \CommentTok{\# Replace infinite values with NaN}
\NormalTok{    df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret"}\NormalTok{].replace([np.inf, }\OperatorTok{{-}}\NormalTok{np.inf], np.nan)}
    
    \CommentTok{\# Cap extreme negative returns}
\NormalTok{    df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{0.99}\NormalTok{)}
    
    \CommentTok{\# Daily risk{-}free rate}
\NormalTok{    df[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=}\NormalTok{ annual\_rf }\OperatorTok{/} \DecValTok{252}
    
    \CommentTok{\# Excess returns}
\NormalTok{    df[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    df[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"ret\_excess"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{1.0}\NormalTok{)}
    
    \CommentTok{\# Lagged market cap}
\NormalTok{    df[}\StringTok{"mktcap\_lag"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{"mktcap"}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ df}

\KeywordTok{def}\NormalTok{ create\_daily\_dataset\_parallel(df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Create daily price dataset using parallel processing.}
\CommentTok{    """}
    \CommentTok{\# Ensure data is sorted before splitting}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
    
    \CommentTok{\# Split by symbol}
\NormalTok{    symbol\_groups }\OperatorTok{=}\NormalTok{ [group }\ControlFlowTok{for}\NormalTok{ \_, group }\KeywordTok{in}\NormalTok{ df.groupby(}\StringTok{"symbol"}\NormalTok{)]}
    
\NormalTok{    n\_jobs }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(}\DecValTok{1}\NormalTok{, os.cpu\_count() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Processing }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(symbol\_groups)}\SpecialCharTok{:,\}}\SpecialStringTok{ symbols using }\SpecialCharTok{\{}\NormalTok{n\_jobs}\SpecialCharTok{\}}\SpecialStringTok{ cores..."}\NormalTok{)}
    
\NormalTok{    results }\OperatorTok{=}\NormalTok{ Parallel(n\_jobs}\OperatorTok{=}\NormalTok{n\_jobs, verbose}\OperatorTok{=}\DecValTok{1}\NormalTok{)(}
\NormalTok{        delayed(process\_daily\_symbol)(group, annual\_rf) }
        \ControlFlowTok{for}\NormalTok{ group }\KeywordTok{in}\NormalTok{ symbol\_groups}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ create\_daily\_dataset\_parallel(prices)}

\CommentTok{\# Quick validation}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Validation checks:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Any duplicate (symbol, date): }\SpecialCharTok{\{}\NormalTok{prices\_daily}\SpecialCharTok{.}\NormalTok{duplicated(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Sample of non{-}zero returns:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_daily[prices\_daily[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{!=} \DecValTok{0}\NormalTok{][[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]].head(}\DecValTok{10}\NormalTok{))}


\NormalTok{prices\_daily.query(}\StringTok{"symbol == \textquotesingle{}FPT\textquotesingle{}"}\NormalTok{)[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]].head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Processing 1,837 symbols using 23 cores...
\end{verbatim}

\begin{verbatim}

Validation checks:
Any duplicate (symbol, date): 0
Sample of non-zero returns:
   symbol       date  adjusted_close       ret
0     A32 2018-10-23       44.574418       NaN
27    A32 2018-11-29       55.072640  0.235521
30    A32 2018-12-04       48.188560 -0.125000
43    A32 2018-12-21       51.974804  0.078571
49    A32 2019-01-02       55.072640  0.059603
53    A32 2019-01-08       50.030370 -0.091557
74    A32 2019-02-13       44.289180 -0.114754
75    A32 2019-02-14       41.008500 -0.074074
78    A32 2019-02-19       36.087480 -0.120000
91    A32 2019-03-08       41.336568  0.145455
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& symbol & date & adjusted\_close & ret \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1146076 & FPT & 2010-01-04 & 1170.9885 & NaN \\
1146077 & FPT & 2010-01-05 & 1170.9885 & 0.000000 \\
1146078 & FPT & 2010-01-06 & 1149.6978 & -0.018182 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select columns}
\NormalTok{daily\_columns }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{,}
    \StringTok{"open"}\NormalTok{, }\StringTok{"high"}\NormalTok{, }\StringTok{"low"}\NormalTok{, }\StringTok{"close"}\NormalTok{, }\StringTok{"volume"}\NormalTok{,}
    \StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"shrout"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{,}
    \StringTok{"ret"}\NormalTok{, }\StringTok{"risk\_free"}\NormalTok{, }\StringTok{"ret\_excess"}
\NormalTok{]}
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ prices\_daily[daily\_columns]}

\CommentTok{\# Remove observations with missing essential variables}
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ prices\_daily.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily Return Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_daily[}\StringTok{"ret"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Final daily sample: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily Return Summary Statistics:
count    3.462157e+06
mean     3.000000e-04
std      4.480000e-02
min     -9.900000e-01
25%     -4.900000e-03
50%      0.000000e+00
75%      4.000000e-03
max      3.250000e+01
Name: ret, dtype: float64

Final daily sample: 3,462,157 observations
\end{verbatim}

\subsubsection{Creating Monthly Dataset}\label{creating-monthly-dataset}

For monthly returns, we compute returns directly from month-end adjusted
prices rather than compounding daily returns. This avoids compounding
errors from missing days and is the standard approach in empirical
finance.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Sequential version
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ create\_monthly\_dataset(df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Create monthly price dataset with returns computed from }
\CommentTok{    month{-}end to month{-}end adjusted prices.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    
    \CommentTok{\# Sort by symbol and date (critical for correct return calculation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Remove duplicate dates within each symbol (keep last observation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
    
    \CommentTok{\# Get month{-}end observations}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ (df}
\NormalTok{        .groupby(}\StringTok{"symbol"}\NormalTok{)}
\NormalTok{        .resample(}\StringTok{"ME"}\NormalTok{, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .agg(\{}
            \StringTok{"open"}\NormalTok{: }\StringTok{"first"}\NormalTok{,           }\CommentTok{\# First day open}
            \StringTok{"high"}\NormalTok{: }\StringTok{"max"}\NormalTok{,             }\CommentTok{\# Monthly high}
            \StringTok{"low"}\NormalTok{: }\StringTok{"min"}\NormalTok{,              }\CommentTok{\# Monthly low}
            \StringTok{"close"}\NormalTok{: }\StringTok{"last"}\NormalTok{,           }\CommentTok{\# Last day close}
            \StringTok{"volume"}\NormalTok{: }\StringTok{"sum"}\NormalTok{,           }\CommentTok{\# Total monthly volume}
            \StringTok{"adjusted\_close"}\NormalTok{: }\StringTok{"last"}\NormalTok{,  }\CommentTok{\# Month{-}end adjusted price}
            \StringTok{"shrout"}\NormalTok{: }\StringTok{"last"}\NormalTok{,          }\CommentTok{\# Month{-}end shares outstanding}
            \StringTok{"mktcap"}\NormalTok{: }\StringTok{"last"}\NormalTok{,          }\CommentTok{\# Month{-}end market cap}
            \StringTok{"year"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
            \StringTok{"month"}\NormalTok{: }\StringTok{"last"}
\NormalTok{        \})}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# Remove duplicate (symbol, date) after resampling (safety check)}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ monthly.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
    
    \CommentTok{\# Sort again after resampling}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ monthly.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Compute monthly returns from month{-}end to month{-}end adjusted prices}
\NormalTok{    monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}
    
    \CommentTok{\# Cap extreme returns}
\NormalTok{    monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{0.99}\NormalTok{)}
    
    \CommentTok{\# Monthly risk{-}free rate}
\NormalTok{    monthly[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=}\NormalTok{ annual\_rf }\OperatorTok{/} \DecValTok{12}
    
    \CommentTok{\# Excess returns}
\NormalTok{    monthly[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ monthly[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    monthly[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret\_excess"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{1.0}\NormalTok{)}
    
    \CommentTok{\# Lagged market cap for portfolio weighting}
\NormalTok{    monthly[}\StringTok{"mktcap\_lag"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"mktcap"}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ monthly}

\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ create\_monthly\_dataset(prices)}
\end{Highlighting}
\end{Shaded}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\setcounter{enumi}{1}
\tightlist
\item
  Parallel version
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ joblib }\ImportTok{import}\NormalTok{ Parallel, delayed}
\ImportTok{import}\NormalTok{ os}

\KeywordTok{def}\NormalTok{ process\_monthly\_symbol(symbol\_df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Process a single symbol\textquotesingle{}s data to monthly frequency.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ symbol\_df.copy()}
    
    \CommentTok{\# Sort by date (critical for correct return calculation)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values(}\StringTok{"date"}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Remove duplicate dates (keep last observation if duplicates exist)}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{], keep}\OperatorTok{=}\StringTok{"last"}\NormalTok{)}
    
    \CommentTok{\# Set date as index for resampling}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.set\_index(}\StringTok{"date"}\NormalTok{)}
    
    \CommentTok{\# Resample to monthly}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ df.resample(}\StringTok{"ME"}\NormalTok{).agg(\{}
        \StringTok{"symbol"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"open"}\NormalTok{: }\StringTok{"first"}\NormalTok{,}
        \StringTok{"high"}\NormalTok{: }\StringTok{"max"}\NormalTok{,}
        \StringTok{"low"}\NormalTok{: }\StringTok{"min"}\NormalTok{,}
        \StringTok{"close"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"volume"}\NormalTok{: }\StringTok{"sum"}\NormalTok{,}
        \StringTok{"adjusted\_close"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"shrout"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"mktcap"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"year"}\NormalTok{: }\StringTok{"last"}\NormalTok{,}
        \StringTok{"month"}\NormalTok{: }\StringTok{"last"}
\NormalTok{    \}).reset\_index()}
    
    \CommentTok{\# Remove rows where symbol is NaN (months with no trading)}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ monthly.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{])}
    
    \CommentTok{\# Sort by date}
\NormalTok{    monthly }\OperatorTok{=}\NormalTok{ monthly.sort\_values(}\StringTok{"date"}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Compute monthly returns}
\NormalTok{    monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"adjusted\_close"}\NormalTok{].pct\_change()}
    
    \CommentTok{\# Replace infinite values with NaN}
\NormalTok{    monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret"}\NormalTok{].replace([np.inf, }\OperatorTok{{-}}\NormalTok{np.inf], np.nan)}
    
    \CommentTok{\# Cap extreme returns}
\NormalTok{    monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{0.99}\NormalTok{)}
    
    \CommentTok{\# Monthly risk{-}free rate}
\NormalTok{    monthly[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=}\NormalTok{ annual\_rf }\OperatorTok{/} \DecValTok{12}
    
    \CommentTok{\# Excess returns}
\NormalTok{    monthly[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ monthly[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    monthly[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"ret\_excess"}\NormalTok{].clip(lower}\OperatorTok{={-}}\FloatTok{1.0}\NormalTok{)}
    
    \CommentTok{\# Lagged market cap}
\NormalTok{    monthly[}\StringTok{"mktcap\_lag"}\NormalTok{] }\OperatorTok{=}\NormalTok{ monthly[}\StringTok{"mktcap"}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ monthly}

\KeywordTok{def}\NormalTok{ create\_monthly\_dataset\_parallel(df, annual\_rf}\OperatorTok{=}\FloatTok{0.04}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Create monthly price dataset using parallel processing.}
\CommentTok{    """}
    \CommentTok{\# Ensure data is sorted before splitting}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
    
    \CommentTok{\# Split by symbol}
\NormalTok{    symbol\_groups }\OperatorTok{=}\NormalTok{ [group }\ControlFlowTok{for}\NormalTok{ \_, group }\KeywordTok{in}\NormalTok{ df.groupby(}\StringTok{"symbol"}\NormalTok{)]}
    
\NormalTok{    n\_jobs }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(}\DecValTok{1}\NormalTok{, os.cpu\_count() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Processing }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(symbol\_groups)}\SpecialCharTok{:,\}}\SpecialStringTok{ symbols using }\SpecialCharTok{\{}\NormalTok{n\_jobs}\SpecialCharTok{\}}\SpecialStringTok{ cores..."}\NormalTok{)}
    
\NormalTok{    results }\OperatorTok{=}\NormalTok{ Parallel(n\_jobs}\OperatorTok{=}\NormalTok{n\_jobs, verbose}\OperatorTok{=}\DecValTok{1}\NormalTok{)(}
\NormalTok{        delayed(process\_monthly\_symbol)(group, annual\_rf) }
        \ControlFlowTok{for}\NormalTok{ group }\KeywordTok{in}\NormalTok{ symbol\_groups}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}

\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ create\_monthly\_dataset\_parallel(prices)}

\CommentTok{\# Validation checks}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Validation checks:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Any duplicate (symbol, date): }\SpecialCharTok{\{}\NormalTok{prices\_monthly}\SpecialCharTok{.}\NormalTok{duplicated(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Sample of non{-}zero returns:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_monthly[prices\_monthly[}\StringTok{"ret"}\NormalTok{] }\OperatorTok{!=} \DecValTok{0}\NormalTok{][[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]].head(}\DecValTok{10}\NormalTok{))}

\NormalTok{prices\_monthly.query(}\StringTok{"symbol == \textquotesingle{}FPT\textquotesingle{}"}\NormalTok{)[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"ret"}\NormalTok{]].head(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Processing 1,837 symbols using 23 cores...
\end{verbatim}

\begin{verbatim}

Validation checks:
Any duplicate (symbol, date): 0

Sample of non-zero returns:
   symbol       date  adjusted_close       ret
0     A32 2018-10-31       44.574418       NaN
1     A32 2018-11-30       55.072640  0.235521
2     A32 2018-12-31       51.974804 -0.056250
3     A32 2019-01-31       50.030370 -0.037411
4     A32 2019-02-28       36.087480 -0.278689
5     A32 2019-03-31       41.828670  0.159091
7     A32 2019-05-31       43.304976  0.035294
8     A32 2019-06-30       35.929125 -0.170323
9     A32 2019-07-31       37.525975  0.044444
10    A32 2019-08-31       38.324400  0.021277
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& symbol & date & adjusted\_close & ret \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
55963 & FPT & 2010-01-31 & 1092.9226 & NaN \\
55964 & FPT & 2010-02-28 & 1107.1164 & 0.012987 \\
55965 & FPT & 2010-03-31 & 1185.1823 & 0.070513 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Select columns (same structure as daily)}
\NormalTok{monthly\_columns }\OperatorTok{=}\NormalTok{ [}
    \StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"month"}\NormalTok{,}
    \StringTok{"open"}\NormalTok{, }\StringTok{"high"}\NormalTok{, }\StringTok{"low"}\NormalTok{, }\StringTok{"close"}\NormalTok{, }\StringTok{"volume"}\NormalTok{,}
    \StringTok{"adjusted\_close"}\NormalTok{, }\StringTok{"shrout"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{,}
    \StringTok{"ret"}\NormalTok{, }\StringTok{"risk\_free"}\NormalTok{, }\StringTok{"ret\_excess"}
\NormalTok{]}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ prices\_monthly[monthly\_columns]}

\CommentTok{\# Remove observations with missing essential variables}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ prices\_monthly.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Monthly Return Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_monthly[}\StringTok{"ret"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Final monthly sample: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Monthly Return Summary Statistics:
count    165499.0000
mean          0.0042
std           0.1862
min          -0.9900
25%          -0.0703
50%           0.0000
75%           0.0553
max          12.7500
Name: ret, dtype: float64

Final monthly sample: 165,499 observations
\end{verbatim}

\subsection{Storing Price Data}\label{storing-price-data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_daily.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"prices\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily price data saved to database."}\NormalTok{)}

\NormalTok{prices\_monthly.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"prices\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Monthly price data saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Descriptive Statistics}\label{descriptive-statistics}

Before proceeding to asset pricing analyses, we examine the
characteristics of our sample to understand the Vietnamese equity
market's evolution and composition.

\subsection{Market Evolution Over
Time}\label{market-evolution-over-time}

We first examine how the number of listed securities has grown over
time.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{securities\_over\_time }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{    .agg(}
\NormalTok{        n\_securities}\OperatorTok{=}\NormalTok{(}\StringTok{"symbol"}\NormalTok{, }\StringTok{"nunique"}\NormalTok{),}
\NormalTok{        total\_mktcap}\OperatorTok{=}\NormalTok{(}\StringTok{"mktcap"}\NormalTok{, }\StringTok{"sum"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{securities\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(securities\_over\_time, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"n\_securities"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(color}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{, size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Number of Securities"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Growth of Vietnamese Stock Market"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{comma\_format())}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{securities\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/fig-securities-over-time-output-1.pdf}}

}

\caption{\label{fig-securities-over-time}The figure shows the monthly
number of securities in the Vietnamese stock market sample.}

\end{figure}%

\subsection{Market Capitalization
Evolution}\label{market-capitalization-evolution}

The aggregate market capitalization reflects the overall size and
development of the Vietnamese equity market.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mktcap\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(securities\_over\_time, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"total\_mktcap / 1000"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(color}\OperatorTok{=}\StringTok{"darkgreen"}\NormalTok{, size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Market Cap (Trillion VND)"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Total Market Capitalization of Vietnamese Equities"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{comma\_format())}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{mktcap\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/fig-market-cap-over-time-output-1.pdf}}

}

\caption{\label{fig-market-cap-over-time}The figure shows the total
market capitalization of Vietnamese listed companies over time.}

\end{figure}%

\subsection{Return Distribution}\label{return-distribution}

Understanding the distribution of monthly returns helps identify
potential data quality issues and characterize market risk.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{return\_distribution }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(prices\_monthly, aes(x}\OperatorTok{=}\StringTok{"ret\_excess"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_histogram(}
\NormalTok{        binwidth}\OperatorTok{=}\FloatTok{0.02}\NormalTok{, }
\NormalTok{        fill}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{, }
\NormalTok{        color}\OperatorTok{=}\StringTok{"white"}\NormalTok{,}
\NormalTok{        alpha}\OperatorTok{=}\FloatTok{0.7}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Monthly Excess Return"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Frequency"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Distribution of Monthly Excess Returns"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_continuous(limits}\OperatorTok{=}\NormalTok{(}\OperatorTok{{-}}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.5}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{return\_distribution.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/fig-return-distribution-output-1.pdf}}

}

\caption{\label{fig-return-distribution}Distribution of monthly excess
returns for Vietnamese stocks.}

\end{figure}%

\subsection{Coverage of Book Equity}\label{coverage-of-book-equity}

Book equity is essential for constructing value portfolios. We examine
what fraction of our sample has book equity data available over time.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Merge prices with fundamentals}
\NormalTok{coverage\_data }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .assign(year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.year)}
\NormalTok{    .groupby([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{])}
\NormalTok{    .tail(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .merge(comp\_vn[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"be"}\NormalTok{]], }
\NormalTok{           on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], }
\NormalTok{           how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Compute coverage by year}
\NormalTok{be\_coverage }\OperatorTok{=}\NormalTok{ (coverage\_data}
\NormalTok{    .groupby(}\StringTok{"year"}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
        \StringTok{"share\_with\_be"}\NormalTok{: x[}\StringTok{"be"}\NormalTok{].notna().mean()}
\NormalTok{    \}))}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\NormalTok{coverage\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(be\_coverage, aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"share\_with\_be"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(color}\OperatorTok{=}\StringTok{"darkorange"}\NormalTok{, size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_point(color}\OperatorTok{=}\StringTok{"darkorange"}\NormalTok{, size}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Year"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Share with Book Equity"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Coverage of Book Equity Data"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format(), limits}\OperatorTok{=}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{coverage\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/fig-book-equity-coverage-output-1.pdf}}

}

\caption{\label{fig-book-equity-coverage}Share of securities with
available book equity data by year.}

\end{figure}%

\section{Merging Stock and Fundamental
Data}\label{merging-stock-and-fundamental-data}

The final step links price data with fundamental data using the stock
symbol as the common identifier. This merged dataset forms the basis for
constructing portfolios sorted on firm characteristics.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Example: Create merged dataset for end{-}of{-}June each year}
\NormalTok{merged\_data }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .query(}\StringTok{"month == 6"}\NormalTok{)}
\NormalTok{    .merge(}
\NormalTok{        comp\_vn[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"be"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{, }\StringTok{"at"}\NormalTok{]],}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}\NormalTok{,}
\NormalTok{        suffixes}\OperatorTok{=}\NormalTok{(}\StringTok{""}\NormalTok{, }\StringTok{"\_fundamental"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}

\CommentTok{\# Convert BE from VND to BILLION VND}
\NormalTok{merged\_data[}\StringTok{"be"}\NormalTok{] }\OperatorTok{=}\NormalTok{ merged\_data[}\StringTok{"be"}\NormalTok{] }\OperatorTok{/} \FloatTok{1e9}

\CommentTok{\# Compute book{-}to{-}market ratio}
\NormalTok{merged\_data[}\StringTok{"bm"}\NormalTok{] }\OperatorTok{=}\NormalTok{ merged\_data[}\StringTok{"be"}\NormalTok{] }\OperatorTok{/}\NormalTok{ merged\_data[}\StringTok{"mktcap"}\NormalTok{]}

\NormalTok{merged\_data.loc[}
\NormalTok{    (merged\_data[}\StringTok{"bm"}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{) }\OperatorTok{|}
\NormalTok{    (merged\_data[}\StringTok{"bm"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{20}\NormalTok{),}
    \StringTok{"bm"}
\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.NA}


\NormalTok{merged\_data[}\StringTok{"bm"}\NormalTok{].describe(percentiles}\OperatorTok{=}\NormalTok{[}\FloatTok{.01}\NormalTok{, }\FloatTok{.1}\NormalTok{, }\FloatTok{.5}\NormalTok{, }\FloatTok{.9}\NormalTok{, }\FloatTok{.99}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Merged observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(merged\_data)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"With book{-}to{-}market: }\SpecialCharTok{\{}\NormalTok{merged\_data[}\StringTok{\textquotesingle{}bm\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{notna()}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{merged\_data.head(}\DecValTok{3}\NormalTok{)}
\NormalTok{merged\_data.describe()}
\NormalTok{merged\_data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Merged observations: 13,756
With book-to-market: 12,859
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& symbol & date & year & month & open & high & low & close & volume &
adjusted\_close & ... & mktcap & mktcap\_lag & ret & risk\_free &
ret\_excess & be & op & inv & at & bm \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & A32 & 2019-06-30 & 2019.0 & 6.0 & 26.4 & 26.4 & 21.0 & 22.5 & 3700 &
35.929125 & ... & 153.000 & 179.52 & -0.170323 & 0.003333 & -0.173657 &
223.612748 & 0.232362 & -0.072329 & 4.349303e+11 & 1.461521 \\
1 & A32 & 2020-06-30 & 2020.0 & 6.0 & 25.0 & 26.3 & 24.5 & 26.3 & 7500 &
38.811173 & ... & 178.840 & 187.00 & -0.067977 & 0.003333 & -0.071311 &
242.216943 & 0.195565 & 0.122698 & 4.882955e+11 & 1.354378 \\
2 & A32 & 2021-06-30 & 2021.0 & 6.0 & 30.2 & 37.0 & 29.5 & 32.0 & 78400
& 45.363520 & ... & 217.600 & 214.20 & 0.015873 & 0.003333 & 0.012540 &
238.385190 & 0.157723 & 0.081581 & 5.281309e+11 & 1.095520 \\
3 & A32 & 2022-06-30 & 2022.0 & 6.0 & 30.9 & 35.5 & 25.0 & 35.3 & 15200
& 47.503210 & ... & 240.040 & 210.12 & 0.142395 & 0.003333 & 0.139061 &
215.399735 & 0.172085 & 0.036584 & 5.474523e+11 & 0.897349 \\
4 & A32 & 2023-06-30 & 2023.0 & 6.0 & 30.1 & 33.5 & 29.2 & 29.4 & 2400 &
35.064204 & ... & 199.920 & 204.68 & -0.023256 & 0.003333 & -0.026589 &
222.024135 & 0.174658 & -0.076752 & 5.054342e+11 & 1.110565 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
13751 & YTC & 2019-06-30 & 2019.0 & 6.0 & 70.0 & 79.9 & 70.0 & 79.9 &
38900 & 171.451817 & ... & 246.092 & 215.60 & 0.141429 & 0.003333 &
0.138095 & 59.901389 & 0.738190 & -0.021758 & 7.521980e+11 & 0.243411 \\
13752 & YTC & 2020-06-30 & 2020.0 & 6.0 & 88.5 & 88.5 & 77.0 & 87.0 &
150640 & 180.966960 & ... & 267.960 & 272.58 & -0.016949 & 0.003333 &
-0.020282 & 13.459082 & -0.458548 & 0.323501 & 9.955348e+11 &
0.050228 \\
13753 & YTC & 2021-06-30 & 2021.0 & 6.0 & 76.0 & 115.5 & 61.0 & 61.0 &
34100 & 126.884880 & ... & 187.880 & 234.08 & -0.197368 & 0.003333 &
-0.200702 & 21.746595 & 0.539521 & -0.215694 & 7.808035e+11 &
0.115747 \\
13754 & YTC & 2022-06-30 & 2022.0 & 6.0 & 68.0 & 68.0 & 65.0 & 65.5 &
200 & 136.245240 & ... & 201.740 & 209.44 & -0.036765 & 0.003333 &
-0.040098 & 32.403055 & 0.483088 & 0.182911 & 9.236206e+11 & 0.160618 \\
13755 & YTC & 2023-06-30 & 2023.0 & 6.0 & 59.0 & 59.0 & 59.0 & 59.0 &
49545 & 122.724720 & ... & 181.720 & 181.72 & 0.000000 & 0.003333 &
-0.003333 & 38.976624 & 0.450157 & 0.017930 & 9.401815e+11 & 0.214487 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}

\NormalTok{bm\_plot\_data }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    merged\_data[[}\StringTok{"bm"}\NormalTok{]]}
\NormalTok{      .dropna()}
\NormalTok{      .assign(bm\_plot}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"bm"}\NormalTok{].clip(upper}\OperatorTok{=}\DecValTok{10}\NormalTok{))}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    ggplot(bm\_plot\_data, aes(x}\OperatorTok{=}\StringTok{"bm\_plot"}\NormalTok{)) }\OperatorTok{+}
\NormalTok{    geom\_histogram(bins}\OperatorTok{=}\DecValTok{80}\NormalTok{) }\OperatorTok{+}
\NormalTok{    labs(}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Distribution of Book to Market Ratios"}\NormalTok{,}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Book to Market (capped at 10 for plotting)"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Number of firms"}
\NormalTok{    ) }\OperatorTok{+}
\NormalTok{    theme\_minimal()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/cell-33-output-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{size\_plot\_data }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    merged\_data[[}\StringTok{"mktcap\_lag"}\NormalTok{]]}
\NormalTok{      .dropna()}
\NormalTok{      .assign(log\_size}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.log(x[}\StringTok{"mktcap\_lag"}\NormalTok{]))}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    ggplot(size\_plot\_data, aes(x}\OperatorTok{=}\StringTok{"log\_size"}\NormalTok{)) }\OperatorTok{+}
\NormalTok{    geom\_histogram(bins}\OperatorTok{=}\DecValTok{80}\NormalTok{) }\OperatorTok{+}
\NormalTok{    labs(}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Distribution of Log Market Capitalization"}\NormalTok{,}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Log Market Cap"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Number of firms"}
\NormalTok{    ) }\OperatorTok{+}
\NormalTok{    theme\_minimal()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/cell-34-output-1.pdf}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{scatter\_data }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    merged\_data[[}\StringTok{"be"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{]]}
\NormalTok{      .dropna()}
\NormalTok{      .assign(}
\NormalTok{          log\_be}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.log(x[}\StringTok{"be"}\NormalTok{]),}
\NormalTok{          log\_me}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.log(x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{      )}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    ggplot(scatter\_data, aes(x}\OperatorTok{=}\StringTok{"log\_me"}\NormalTok{, y}\OperatorTok{=}\StringTok{"log\_be"}\NormalTok{)) }\OperatorTok{+}
\NormalTok{    geom\_point(alpha}\OperatorTok{=}\FloatTok{0.2}\NormalTok{) }\OperatorTok{+}
\NormalTok{    labs(}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Log Book Equity vs Log Market Equity"}\NormalTok{,}
\NormalTok{        x}\OperatorTok{=}\StringTok{"Log Market Cap"}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Log Book Equity"}
\NormalTok{    ) }\OperatorTok{+}
\NormalTok{    theme\_minimal()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{07_datacore_data_files/figure-pdf/cell-35-output-1.pdf}}

\section{Key Takeaways}\label{key-takeaways-5}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Datacore provides unified access} to Vietnamese financial data
  through a modern cloud-based infrastructure, eliminating the need to
  aggregate data from multiple fragmented sources.
\item
  \textbf{Company fundamentals} from Datacore include comprehensive
  balance sheet, income statement, and cash flow data prepared according
  to Vietnamese Accounting Standards, which we map to standard variables
  used in international research.
\item
  \textbf{Book equity computation} follows the Fama-French methodology,
  accounting for deferred taxes and preferred stock to ensure
  comparability with US-based studies.
\item
  \textbf{Stock price data} includes adjustment factors for corporate
  actions, enabling accurate return calculations over long horizons.
\item
  \textbf{Monthly frequency} is standard for asset pricing research,
  reducing noise while maintaining sufficient observations for
  statistical inference.
\item
  \textbf{Risk-free rate approximation} uses Vietnamese government bond
  yields as a proxy, given the absence of a standardized short-term rate
  series comparable to US Treasury bills.
\item
  \textbf{Data quality validation} through descriptive statistics and
  visualization helps identify potential issues before conducting formal
  analyses.
\item
  \textbf{Batch processing} enables efficient handling of large daily
  datasets that would otherwise exceed memory constraints.
\end{enumerate}

\bookmarksetup{startatroot}

\chapter{Beta Estimation}\label{beta-estimation}

This chapter introduces one of the most fundamental concepts in
financial economics: the exposure of an individual stock to systematic
market risk. According to the Capital Asset Pricing Model (CAPM)
developed by Sharpe (1964), Lintner (1965), and Mossin (1966),
cross-sectional variation in expected asset returns should be determined
by the covariance between an asset's excess return and the excess return
on the market portfolio. The regression coefficient that captures this
relationship (commonly known as market beta) serves as the cornerstone
of modern portfolio theory and remains widely used in practice for cost
of capital estimation, performance attribution, and risk management.

In this chapter, we develop a complete framework for estimating market
betas for Vietnamese stocks. We begin with a conceptual overview of the
CAPM and its empirical implementation. We then demonstrate beta
estimation using ordinary least squares regression, first for individual
stocks and then scaled to the entire market using rolling-window
estimation. To handle the computational demands of estimating betas for
hundreds of stocks across many time periods, we introduce
parallelization techniques that dramatically reduce processing time.
Finally, we compare beta estimates derived from monthly versus daily
returns and examine how betas vary across industries and over time in
the Vietnamese market.

The chapter leverages several important computational concepts that
extend beyond beta estimation itself. Rolling-window estimation is a
technique applicable to any time-varying parameter, while
parallelization provides a general solution for computationally
intensive tasks that can be divided into independent subtasks.

\section{Theoretical Foundation}\label{theoretical-foundation}

\subsection{The Capital Asset Pricing
Model}\label{the-capital-asset-pricing-model-1}

The CAPM provides a theoretical framework linking expected returns to
systematic risk. Under the model's assumptions---including mean-variance
optimizing investors, homogeneous expectations, and frictionless
markets---the expected excess return on any asset \(i\) is proportional
to its covariance with the market portfolio:

\[
E[r_i - r_f] = \beta_i \cdot E[r_m - r_f]
\]

where \(r_i\) is the return on asset \(i\), \(r_f\) is the risk-free
rate, \(r_m\) is the return on the market portfolio, and \(\beta_i\) is
defined as:

\[
\beta_i = \frac{\text{Cov}(r_i, r_m)}{\text{Var}(r_m)}
\]

The market beta \(\beta_i\) measures the sensitivity of asset \(i\)'s
returns to market movements. A beta greater than one indicates the asset
amplifies market movements, while a beta less than one indicates
dampened sensitivity. A beta of zero would imply no systematic risk
exposure, leaving only idiosyncratic risk that can be diversified away.

\subsection{Empirical Implementation}\label{empirical-implementation}

In practice, we estimate beta by regressing excess stock returns on
excess market returns:

\begin{equation}\phantomsection\label{eq-capm-regression}{
r_{i,t} - r_{f,t} = \alpha_i + \beta_i(r_{m,t} - r_{f,t}) + \varepsilon_{i,t}
}\end{equation}

where \(\alpha_i\) represents abnormal return (Jensen's alpha),
\(\beta_i\) is the market beta we seek to estimate, and
\(\varepsilon_{i,t}\) is the idiosyncratic error term. Under the CAPM,
\(\alpha_i\) should equal zero for all assets---any non-zero alpha
represents a deviation from the model's predictions.

Several practical considerations affect beta estimation:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Estimation Window}: Longer windows provide more observations
  and thus more precise estimates, but may include outdated information
  if betas change over time. Common choices range from 36 to 60 months
  for monthly data.
\item
  \textbf{Return Frequency}: Monthly returns reduce noise but provide
  fewer observations. Daily returns offer more data points but may
  introduce microstructure effects and non-synchronous trading biases.
\item
  \textbf{Market Proxy}: The theoretical market portfolio includes all
  assets, but in practice we use a broad equity index. For Vietnam, we
  use the value-weighted market return constructed from our stock
  universe.
\item
  \textbf{Minimum Observations}: Requiring a minimum number of
  observations (e.g., 48 out of 60 months) helps avoid unreliable
  estimates from sparse data.
\end{enumerate}

\section{Setting Up the Environment}\label{setting-up-the-environment-1}

We begin by loading the necessary Python packages. The core packages
handle data manipulation, statistical modeling, and database operations.
We also import parallelization tools that will be essential when scaling
our estimation to the full market.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ sqlite3}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{from}\NormalTok{ scipy.stats.mstats }\ImportTok{import}\NormalTok{ winsorize}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format, comma\_format}
\ImportTok{from}\NormalTok{ joblib }\ImportTok{import}\NormalTok{ Parallel, delayed, cpu\_count}
\ImportTok{from}\NormalTok{ dateutil.relativedelta }\ImportTok{import}\NormalTok{ relativedelta}
\end{Highlighting}
\end{Shaded}

We connect to our SQLite database containing the processed Vietnamese
financial data from previous chapters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Loading and Preparing Data}\label{loading-and-preparing-data}

\subsection{Stock Returns Data}\label{stock-returns-data}

We load the monthly stock returns data prepared in the Datacore chapter.
The data includes excess returns (returns minus the risk-free rate) for
all Vietnamese listed stocks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess }
\StringTok{        FROM prices\_monthly}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Add year for merging with fundamentals}
\NormalTok{prices\_monthly[}\StringTok{"year"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices\_monthly[}\StringTok{"date"}\NormalTok{].dt.year}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Loaded }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ monthly observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Covering }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{ unique stocks"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loaded 209,495 monthly observations
Covering 1,837 unique stocks
Date range: 2010-01 to 2025-05
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess }
\StringTok{        FROM prices\_daily}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Company Information}\label{company-information}

We load company information to enable industry-level analysis of beta
estimates.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, datadate, icb\_name\_vi }
\StringTok{        FROM comp\_vn}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"datadate"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Extract year for merging}
\NormalTok{comp\_vn[}\StringTok{"year"}\NormalTok{] }\OperatorTok{=}\NormalTok{ comp\_vn[}\StringTok{"datadate"}\NormalTok{].dt.year}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Company data: }\SpecialCharTok{\{}\NormalTok{comp\_vn[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{ firms"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Company data: 1,502 firms
\end{verbatim}

\subsection{Market Excess Returns}\label{market-excess-returns}

For the market portfolio proxy, we use the value-weighted market excess
return. If you have constructed Fama-French factors in a previous
chapter, load them here. Otherwise, we can construct a simple market
return from our stock data.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Option 1: Load pre{-}computed market factor}
\NormalTok{factors\_ff3\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT date, mkt\_excess FROM factors\_ff3\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Option 2: Construct market return from stock data (if factors not available)}
\CommentTok{\# This computes the value{-}weighted average return across all stocks}
\KeywordTok{def}\NormalTok{ compute\_market\_return(prices\_df):}
    \CommentTok{"""}
\CommentTok{    Compute value{-}weighted market return from individual stock returns.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices\_df : pd.DataFrame}
\CommentTok{        Stock returns with mktcap\_lag for weighting}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Monthly market excess returns}
\CommentTok{    """}
\NormalTok{    market\_return }\OperatorTok{=}\NormalTok{ (prices\_df}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{]))}
\NormalTok{        .reset\_index(name}\OperatorTok{=}\StringTok{"mkt\_excess"}\NormalTok{)}
\NormalTok{    )}
    \ControlFlowTok{return}\NormalTok{ market\_return}
\end{Highlighting}
\end{Shaded}

\subsection{Merging Datasets}\label{merging-datasets}

We combine the stock returns with market returns and company information
to create our estimation dataset.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Merge stock returns with market returns}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ prices\_monthly.merge(}
\NormalTok{    factors\_ff3\_monthly, }
\NormalTok{    on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, }
\NormalTok{    how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{)}

\CommentTok{\# Merge with company information for industry classification}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ prices\_monthly.merge(}
\NormalTok{    comp\_vn[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{, }\StringTok{"icb\_name\_vi"}\NormalTok{]], }
\NormalTok{    on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year"}\NormalTok{], }
\NormalTok{    how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{)}

\CommentTok{\# Remove observations with missing data}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ prices\_monthly.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mkt\_excess"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Final estimation sample: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Final estimation sample: 169,983 observations
\end{verbatim}

\subsection{Handling Outliers}\label{handling-outliers}

Extreme returns can unduly influence regression estimates. We apply
winsorization to limit the impact of outliers while preserving the
general distribution of returns. Winsorization at the 1\% level replaces
values below the 1st percentile with the 1st percentile value, and
values above the 99th percentile with the 99th percentile value.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ winsorize\_returns(df, columns, limits}\OperatorTok{=}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{)):}
    \CommentTok{"""}
\CommentTok{    Apply winsorization to return columns to limit outlier influence.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    df : pd.DataFrame}
\CommentTok{        DataFrame containing return columns}
\CommentTok{    columns : list}
\CommentTok{        Column names to winsorize}
\CommentTok{    limits : tuple}
\CommentTok{        Lower and upper percentile limits for winsorization}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        DataFrame with winsorized columns}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ columns:}
\NormalTok{        df[col] }\OperatorTok{=}\NormalTok{ winsorize(df[col], limits}\OperatorTok{=}\NormalTok{limits)}
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ winsorize\_returns(}
\NormalTok{    prices\_monthly, }
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mkt\_excess"}\NormalTok{],}
\NormalTok{    limits}\OperatorTok{=}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.01}\NormalTok{)}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Return distributions after winsorization:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_monthly[[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mkt\_excess"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Return distributions after winsorization:
        ret_excess   mkt_excess
count  169983.0000  169983.0000
mean        0.0011      -0.0102
std         0.1548       0.0579
min        -0.4078      -0.1794
25%        -0.0700      -0.0384
50%        -0.0033      -0.0084
75%         0.0531       0.0219
max         0.6117       0.1221
\end{verbatim}

\section{Estimating Beta for Individual
Stocks}\label{estimating-beta-for-individual-stocks}

\subsection{Single Stock Example}\label{single-stock-example}

Before scaling to the full market, we demonstrate beta estimation for a
single well-known Vietnamese stock. We use Vingroup (VIC), one of the
largest conglomerates in Vietnam with significant exposure to real
estate, retail, and automotive sectors.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Filter data for Vingroup}
\NormalTok{vic\_data }\OperatorTok{=}\NormalTok{ prices\_monthly.query(}\StringTok{"symbol == \textquotesingle{}VIC\textquotesingle{}"}\NormalTok{).copy()}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"VIC observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(vic\_data)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{vic\_data[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{vic\_data[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
VIC observations: 150
Date range: 2011-07 to 2023-12
\end{verbatim}

We estimate the CAPM regression using ordinary least squares via the
\texttt{statsmodels} package. The formula interface provides a
convenient way to specify regression models.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Estimate CAPM for Vingroup}
\NormalTok{model\_vic }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{"ret\_excess \textasciitilde{} mkt\_excess"}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{vic\_data}
\NormalTok{).fit()}

\CommentTok{\# Display regression results}
\BuiltInTok{print}\NormalTok{(model\_vic.summary())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                            OLS Regression Results                            
==============================================================================
Dep. Variable:             ret_excess   R-squared:                       0.153
Model:                            OLS   Adj. R-squared:                  0.147
Method:                 Least Squares   F-statistic:                     26.67
Date:                Wed, 04 Feb 2026   Prob (F-statistic):           7.66e-07
Time:                        10:20:06   Log-Likelihood:                 131.96
No. Observations:                 150   AIC:                            -259.9
Df Residuals:                     148   BIC:                            -253.9
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P>|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -0.0075      0.008     -0.895      0.372      -0.024       0.009
mkt_excess     0.7503      0.145      5.164      0.000       0.463       1.037
==============================================================================
Omnibus:                       39.111   Durbin-Watson:                   2.039
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              107.620
Skew:                          -1.015   Prob(JB):                     4.27e-24
Kurtosis:                       6.619   Cond. No.                         17.6
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
\end{verbatim}

The regression output provides several important pieces of information:

\begin{itemize}
\tightlist
\item
  \textbf{Beta (mkt\_excess coefficient)}: The estimated market
  sensitivity. A beta above 1 indicates VIC amplifies market movements.
\item
  \textbf{Alpha (Intercept)}: The abnormal return not explained by
  market exposure. Under CAPM, this should be zero.
\item
  \textbf{R-squared}: The proportion of return variation explained by
  market movements.
\item
  \textbf{t-statistics}: Test whether coefficients differ significantly
  from zero.
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extract key estimates}
\NormalTok{coefficients }\OperatorTok{=}\NormalTok{ model\_vic.summary2().tables[}\DecValTok{1}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Key estimates for Vingroup (VIC):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Beta:  }\SpecialCharTok{\{}\NormalTok{coefficients}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}mkt\_excess\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Coef.\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Alpha: }\SpecialCharTok{\{}\NormalTok{coefficients}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Coef.\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  R:    }\SpecialCharTok{\{}\NormalTok{model\_vic}\SpecialCharTok{.}\NormalTok{rsquared}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Key estimates for Vingroup (VIC):
  Beta:  0.750
  Alpha: -0.0075
  R:    0.153
\end{verbatim}

\subsection{CAPM Estimation Function}\label{capm-estimation-function}

We create a reusable function that estimates the CAPM and returns
results in a standardized format. The function includes a minimum
observations requirement to avoid unreliable estimates from sparse data.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ estimate\_capm(data, min\_obs}\OperatorTok{=}\DecValTok{48}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Estimate CAPM regression and return coefficients.}
\CommentTok{    }
\CommentTok{    This function regresses excess stock returns on excess market returns}
\CommentTok{    and extracts the coefficient estimates along with t{-}statistics.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data : pd.DataFrame}
\CommentTok{        DataFrame with \textquotesingle{}ret\_excess\textquotesingle{} and \textquotesingle{}mkt\_excess\textquotesingle{} columns}
\CommentTok{    min\_obs : int}
\CommentTok{        Minimum number of observations required for estimation}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        DataFrame with coefficient estimates and t{-}statistics,}
\CommentTok{        or empty DataFrame if insufficient observations}
\CommentTok{    """}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(data) }\OperatorTok{\textless{}}\NormalTok{ min\_obs:}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
    
    \ControlFlowTok{try}\NormalTok{:}
        \CommentTok{\# Estimate OLS regression}
\NormalTok{        model }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{            formula}\OperatorTok{=}\StringTok{"ret\_excess \textasciitilde{} mkt\_excess"}\NormalTok{, }
\NormalTok{            data}\OperatorTok{=}\NormalTok{data}
\NormalTok{        ).fit()}
        
        \CommentTok{\# Extract coefficient table}
\NormalTok{        coef\_table }\OperatorTok{=}\NormalTok{ model.summary2().tables[}\DecValTok{1}\NormalTok{]}
        
        \CommentTok{\# Format results}
\NormalTok{        results }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
            \StringTok{"coefficient"}\NormalTok{: [}\StringTok{"alpha"}\NormalTok{, }\StringTok{"beta"}\NormalTok{],}
            \StringTok{"estimate"}\NormalTok{: [}
\NormalTok{                coef\_table.loc[}\StringTok{"Intercept"}\NormalTok{, }\StringTok{"Coef."}\NormalTok{],}
\NormalTok{                coef\_table.loc[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"Coef."}\NormalTok{]}
\NormalTok{            ],}
            \StringTok{"t\_statistic"}\NormalTok{: [}
\NormalTok{                coef\_table.loc[}\StringTok{"Intercept"}\NormalTok{, }\StringTok{"t"}\NormalTok{],}
\NormalTok{                coef\_table.loc[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"t"}\NormalTok{]}
\NormalTok{            ],}
            \StringTok{"r\_squared"}\NormalTok{: model.rsquared}
\NormalTok{        \})}
        
        \ControlFlowTok{return}\NormalTok{ results}
        
    \ControlFlowTok{except} \PreprocessorTok{Exception} \ImportTok{as}\NormalTok{ e:}
        \CommentTok{\# Return empty DataFrame if estimation fails}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
\end{Highlighting}
\end{Shaded}

\section{Rolling-Window Estimation}\label{rolling-window-estimation}

\subsection{Motivation for Rolling
Windows}\label{motivation-for-rolling-windows}

Stock betas are not constant over time. A company's business mix,
leverage, and operating environment evolve, causing its systematic risk
exposure to change. To capture this time variation, we use
rolling-window estimation: at each point in time, we estimate beta using
only data from a fixed lookback period (e.g., the past 60 months).

Rolling-window estimation involves a trade-off:

\begin{itemize}
\tightlist
\item
  \textbf{Longer windows} provide more observations and thus more
  precise estimates, but may include stale information.
\item
  \textbf{Shorter windows} are more responsive to changes but produce
  noisier estimates.
\end{itemize}

A common choice in academic research is 60 months (5 years) of monthly
data, requiring at least 48 valid observations for estimation.

\subsection{Rolling Window
Implementation}\label{rolling-window-implementation}

The following function implements rolling-window CAPM estimation. For
each month in the sample, it looks back over the specified window and
estimates beta using all available data within that window.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ roll\_capm\_estimation(data, look\_back}\OperatorTok{=}\DecValTok{60}\NormalTok{, min\_obs}\OperatorTok{=}\DecValTok{48}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Perform rolling{-}window CAPM estimation.}
\CommentTok{    }
\CommentTok{    This function slides a window across time, estimating the CAPM}
\CommentTok{    regression at each point using the most recent \textquotesingle{}look\_back\textquotesingle{} months}
\CommentTok{    of data.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data : pd.DataFrame}
\CommentTok{        DataFrame with \textquotesingle{}date\textquotesingle{}, \textquotesingle{}ret\_excess\textquotesingle{}, and \textquotesingle{}mkt\_excess\textquotesingle{} columns}
\CommentTok{    look\_back : int}
\CommentTok{        Number of months in the estimation window}
\CommentTok{    min\_obs : int}
\CommentTok{        Minimum observations required within each window}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Time series of coefficient estimates with dates}
\CommentTok{    """}
    \CommentTok{\# Ensure data is sorted by date}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ data.sort\_values(}\StringTok{"date"}\NormalTok{).copy()}
    
    \CommentTok{\# Get unique dates}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ data[}\StringTok{"date"}\NormalTok{].drop\_duplicates().sort\_values()}
    
    \CommentTok{\# Container for results}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ []}
    
    \CommentTok{\# Slide window across dates}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(look\_back }\OperatorTok{{-}} \DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(dates)):}
        \CommentTok{\# Define window boundaries}
\NormalTok{        end\_date }\OperatorTok{=}\NormalTok{ dates.iloc[i]}
\NormalTok{        start\_date }\OperatorTok{=}\NormalTok{ end\_date }\OperatorTok{{-}}\NormalTok{ relativedelta(months}\OperatorTok{=}\NormalTok{look\_back }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
        
        \CommentTok{\# Extract data within window}
\NormalTok{        window\_data }\OperatorTok{=}\NormalTok{ data.query(}\StringTok{"date \textgreater{}= @start\_date and date \textless{}= @end\_date"}\NormalTok{)}
        
        \CommentTok{\# Estimate CAPM for this window}
\NormalTok{        window\_results }\OperatorTok{=}\NormalTok{ estimate\_capm(window\_data, min\_obs}\OperatorTok{=}\NormalTok{min\_obs)}
        
        \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ window\_results.empty:}
\NormalTok{            window\_results[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ end\_date}
\NormalTok{            results.append(window\_results)}
    
    \CommentTok{\# Combine all results}
    \ControlFlowTok{if}\NormalTok{ results:}
        \ControlFlowTok{return}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
\end{Highlighting}
\end{Shaded}

\subsection{Example: Rolling Betas for Selected
Stocks}\label{example-rolling-betas-for-selected-stocks}

We demonstrate rolling-window estimation for several well-known
Vietnamese stocks spanning different industries.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Define example stocks}
\NormalTok{examples }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{"symbol"}\NormalTok{: [}\StringTok{"FPT"}\NormalTok{, }\StringTok{"VNM"}\NormalTok{, }\StringTok{"VIC"}\NormalTok{, }\StringTok{"HPG"}\NormalTok{, }\StringTok{"VCB"}\NormalTok{],}
    \StringTok{"company"}\NormalTok{: [}
        \StringTok{"FPT Corporation"}\NormalTok{,      }\CommentTok{\# Technology}
        \StringTok{"Vinamilk"}\NormalTok{,             }\CommentTok{\# Consumer goods}
        \StringTok{"Vingroup"}\NormalTok{,             }\CommentTok{\# Real estate/conglomerate}
        \StringTok{"Hoa Phat Group"}\NormalTok{,       }\CommentTok{\# Steel/materials}
        \StringTok{"Vietcombank"}           \CommentTok{\# Banking}
\NormalTok{    ]}
\NormalTok{\})}

\CommentTok{\# Check data availability for each example}
\NormalTok{data\_availability }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .query(}\StringTok{"symbol in @examples[\textquotesingle{}symbol\textquotesingle{}]"}\NormalTok{)}
\NormalTok{    .groupby(}\StringTok{"symbol"}\NormalTok{)}
\NormalTok{    .agg(}
\NormalTok{        n\_obs}\OperatorTok{=}\NormalTok{(}\StringTok{"date"}\NormalTok{, }\StringTok{"count"}\NormalTok{),}
\NormalTok{        first\_date}\OperatorTok{=}\NormalTok{(}\StringTok{"date"}\NormalTok{, }\StringTok{"min"}\NormalTok{),}
\NormalTok{        last\_date}\OperatorTok{=}\NormalTok{(}\StringTok{"date"}\NormalTok{, }\StringTok{"max"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Data availability for example stocks:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(data\_availability)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Data availability for example stocks:
  symbol  n_obs first_date  last_date
0    FPT    150 2011-07-31 2023-12-31
1    HPG    150 2011-07-31 2023-12-31
2    VCB    150 2011-07-31 2023-12-31
3    VIC    150 2011-07-31 2023-12-31
4    VNM    150 2011-07-31 2023-12-31
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Estimate rolling betas for example stocks}
\NormalTok{example\_data }\OperatorTok{=}\NormalTok{ prices\_monthly.query(}\StringTok{"symbol in @examples[\textquotesingle{}symbol\textquotesingle{}]"}\NormalTok{)}

\NormalTok{capm\_examples }\OperatorTok{=}\NormalTok{ (example\_data}
\NormalTok{    .groupby(}\StringTok{"symbol"}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: roll\_capm\_estimation(x), include\_groups}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .drop(columns}\OperatorTok{=}\StringTok{"level\_1"}\NormalTok{, errors}\OperatorTok{=}\StringTok{"ignore"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Filter to beta estimates only}
\NormalTok{beta\_examples }\OperatorTok{=}\NormalTok{ (capm\_examples}
\NormalTok{    .query(}\StringTok{"coefficient == \textquotesingle{}beta\textquotesingle{}"}\NormalTok{)}
\NormalTok{    .merge(examples, on}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{)}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Rolling beta estimates: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(beta\_examples)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Rolling beta estimates: 455 observations
\end{verbatim}

\subsection{Visualizing Rolling Betas}\label{visualizing-rolling-betas}

Figure~\ref{fig-rolling-betas} displays the time series of beta
estimates for our example stocks. The figure reveals how systematic risk
exposure evolves differently across industries.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rolling\_beta\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        beta\_examples,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"estimate"}\NormalTok{, color}\OperatorTok{=}\StringTok{"company"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_hline(yintercept}\OperatorTok{=}\DecValTok{1}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"dashed"}\NormalTok{, color}\OperatorTok{=}\StringTok{"gray"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Beta"}\NormalTok{,}
\NormalTok{        color}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Rolling Beta Estimates (60{-}Month Window)"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"bottom"}\NormalTok{)}
\NormalTok{)}
\NormalTok{rolling\_beta\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{08_beta_estimation_files/figure-pdf/fig-rolling-betas-output-1.pdf}}

}

\caption{\label{fig-rolling-betas}Monthly rolling beta estimates for
selected Vietnamese stocks using a 60-month estimation window. Different
industries exhibit distinct patterns of market sensitivity over time.}

\end{figure}%

Several patterns emerge from the figure:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Industry differences}: Technology and banking stocks may
  exhibit different beta patterns than real estate or consumer goods
  companies.
\item
  \textbf{Time variation}: Betas are not constant. They respond to
  changes in business conditions, leverage, and market regimes.
\item
  \textbf{Crisis periods}: Market stress periods (e.g., 2008 financial
  crisis, 2020 COVID-19) often see beta estimates change as correlations
  across stocks increase.
\end{enumerate}

\section{Parallelized Estimation for the Full
Market}\label{parallelized-estimation-for-the-full-market}

\subsection{The Computational
Challenge}\label{the-computational-challenge}

Estimating rolling betas for all stocks in our database is
computationally intensive. With hundreds of stocks, each requiring
rolling estimation across many time periods, sequential processing would
take considerable time. Fortunately, beta estimation for different
stocks is independent (i.e., the estimate for stock A does not depend on
the estimate for stock B). This independence makes the problem ideal for
parallelization.

\subsection{Setting Up Parallel
Processing}\label{setting-up-parallel-processing}

We use the \texttt{joblib} library to distribute computation across
multiple CPU cores. The \texttt{Parallel} class manages worker
processes, while \texttt{delayed} wraps function calls for deferred
execution.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Determine available cores (reserve one for system operations)}
\NormalTok{n\_cores }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(}\DecValTok{1}\NormalTok{, cpu\_count() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Available cores for parallel processing: }\SpecialCharTok{\{}\NormalTok{n\_cores}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Available cores for parallel processing: 3
\end{verbatim}

\subsection{Parallel Beta Estimation}\label{parallel-beta-estimation}

The following code estimates rolling betas for all stocks in parallel.
Each stock is processed independently by a separate worker.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ estimate\_all\_betas\_parallel(data, n\_cores, look\_back}\OperatorTok{=}\DecValTok{60}\NormalTok{, min\_obs}\OperatorTok{=}\DecValTok{48}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Estimate rolling betas for all stocks using parallel processing.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data : pd.DataFrame}
\CommentTok{        Full dataset with all stocks}
\CommentTok{    n\_cores : int}
\CommentTok{        Number of CPU cores to use}
\CommentTok{    look\_back : int}
\CommentTok{        Months in estimation window}
\CommentTok{    min\_obs : int}
\CommentTok{        Minimum observations required}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Beta estimates for all stocks and dates}
\CommentTok{    """}
    \CommentTok{\# Group data by stock}
\NormalTok{    grouped }\OperatorTok{=}\NormalTok{ data.groupby(}\StringTok{"symbol"}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
    
    \CommentTok{\# Define worker function}
    \KeywordTok{def}\NormalTok{ process\_stock(name, group):}
\NormalTok{        result }\OperatorTok{=}\NormalTok{ roll\_capm\_estimation(group, look\_back}\OperatorTok{=}\NormalTok{look\_back, min\_obs}\OperatorTok{=}\NormalTok{min\_obs)}
        \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ result.empty:}
\NormalTok{            result[}\StringTok{"symbol"}\NormalTok{] }\OperatorTok{=}\NormalTok{ name}
        \ControlFlowTok{return}\NormalTok{ result}
    
    \CommentTok{\# Execute in parallel}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ Parallel(n\_jobs}\OperatorTok{=}\NormalTok{n\_cores, verbose}\OperatorTok{=}\DecValTok{1}\NormalTok{)(}
\NormalTok{        delayed(process\_stock)(name, group) }
        \ControlFlowTok{for}\NormalTok{ name, group }\KeywordTok{in}\NormalTok{ grouped}
\NormalTok{    )}
    
    \CommentTok{\# Combine results}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ [r }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ results }\ControlFlowTok{if} \KeywordTok{not}\NormalTok{ r.empty]}
    \ControlFlowTok{if}\NormalTok{ results:}
        \ControlFlowTok{return}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Estimate betas for all stocks}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Estimating rolling betas for all stocks..."}\NormalTok{)}
\NormalTok{capm\_monthly }\OperatorTok{=}\NormalTok{ estimate\_all\_betas\_parallel(}
\NormalTok{    prices\_monthly, }
\NormalTok{    n\_cores}\OperatorTok{=}\NormalTok{n\_cores,}
\NormalTok{    look\_back}\OperatorTok{=}\DecValTok{60}\NormalTok{,}
\NormalTok{    min\_obs}\OperatorTok{=}\DecValTok{48}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Completed: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(capm\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ coefficient estimates"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique stocks: }\SpecialCharTok{\{}\NormalTok{capm\_monthly[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Storing Results}\label{storing-results}

We save the CAPM estimates to our database for use in subsequent
chapters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{capm\_monthly.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"capm\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"CAPM estimates saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

For subsequent analysis, we load the pre-computed estimates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{capm\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM capm\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Loaded }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(capm\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ CAPM estimates"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loaded 161,580 CAPM estimates
\end{verbatim}

\section{Beta Estimation Using Daily
Returns}\label{beta-estimation-using-daily-returns}

While monthly returns are standard in academic research, some
applications benefit from higher-frequency data:

\begin{itemize}
\tightlist
\item
  \textbf{Shorter estimation windows}: Daily data allows meaningful
  estimation over shorter periods (e.g., 3 months rather than 5 years).
\item
  \textbf{More responsive estimates}: Daily betas capture changes more
  quickly.
\item
  \textbf{Event studies}: High-frequency betas are useful for analyzing
  market reactions to specific events.
\end{itemize}

However, daily data introduces additional challenges:

\begin{itemize}
\tightlist
\item
  \textbf{Microstructure noise}: Bid-ask bounce and other trading
  frictions add noise to returns.
\item
  \textbf{Non-synchronous trading}: Less liquid stocks may not trade
  every day, biasing beta estimates downward.
\item
  \textbf{Computational burden}: Daily data is roughly 21 times larger
  than monthly data.
\end{itemize}

\subsection{Batch Processing for Daily
Data}\label{batch-processing-for-daily-data}

Given the size of daily data, we process stocks in batches to manage
memory constraints. This approach loads and processes a subset of
stocks, saves results, and proceeds to the next batch.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_market\_return\_daily(tidy\_finance):}
    \CommentTok{"""}
\CommentTok{    Compute daily value{-}weighted market excess return from stock data.}
\CommentTok{    """}
    \CommentTok{\# Load daily prices with market cap for weighting}
\NormalTok{    prices\_daily\_full }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{        sql}\OperatorTok{=}\StringTok{"""}
\StringTok{            SELECT p.symbol, p.date, p.ret\_excess, m.mktcap\_lag}
\StringTok{            FROM prices\_daily p}
\StringTok{            LEFT JOIN prices\_monthly m ON p.symbol = m.symbol }
\StringTok{                AND strftime(\textquotesingle{}\%Y{-}\%m\textquotesingle{}, p.date) = strftime(\textquotesingle{}\%Y{-}\%m\textquotesingle{}, m.date)}
\StringTok{        """}\NormalTok{,}
\NormalTok{        con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{        parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{    )}
    
    \CommentTok{\# Compute value{-}weighted market return each day}
\NormalTok{    mkt\_daily }\OperatorTok{=}\NormalTok{ (prices\_daily\_full}
\NormalTok{        .dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{]))}
\NormalTok{        .reset\_index(name}\OperatorTok{=}\StringTok{"mkt\_excess"}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ mkt\_daily}


\KeywordTok{def}\NormalTok{ roll\_capm\_estimation\_daily(data, look\_back\_days}\OperatorTok{=}\DecValTok{1260}\NormalTok{, min\_obs}\OperatorTok{=}\DecValTok{1000}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Perform rolling{-}window CAPM estimation using daily data.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data : pd.DataFrame}
\CommentTok{        DataFrame with \textquotesingle{}date\textquotesingle{}, \textquotesingle{}ret\_excess\textquotesingle{}, and \textquotesingle{}mkt\_excess\textquotesingle{} columns}
\CommentTok{    look\_back\_days : int}
\CommentTok{        Number of trading days in the estimation window}
\CommentTok{    min\_obs : int}
\CommentTok{        Minimum daily observations required within each window}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Time series of coefficient estimates with dates}
\CommentTok{    """}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ data.sort\_values(}\StringTok{"date"}\NormalTok{).copy()}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ data[}\StringTok{"date"}\NormalTok{].drop\_duplicates().sort\_values().reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
\NormalTok{    results }\OperatorTok{=}\NormalTok{ []}
    
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(look\_back\_days }\OperatorTok{{-}} \DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(dates)):}
\NormalTok{        end\_date }\OperatorTok{=}\NormalTok{ dates.iloc[i]}
\NormalTok{        start\_idx }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(}\DecValTok{0}\NormalTok{, i }\OperatorTok{{-}}\NormalTok{ look\_back\_days }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{        start\_date }\OperatorTok{=}\NormalTok{ dates.iloc[start\_idx]}
        
\NormalTok{        window\_data }\OperatorTok{=}\NormalTok{ data.query(}\StringTok{"date \textgreater{}= @start\_date and date \textless{}= @end\_date"}\NormalTok{)}
\NormalTok{        window\_results }\OperatorTok{=}\NormalTok{ estimate\_capm(window\_data, min\_obs}\OperatorTok{=}\NormalTok{min\_obs)}
        
        \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ window\_results.empty:}
\NormalTok{            window\_results[}\StringTok{"date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ end\_date}
\NormalTok{            results.append(window\_results)}
    
    \ControlFlowTok{if}\NormalTok{ results:}
        \ControlFlowTok{return}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}


\KeywordTok{def}\NormalTok{ estimate\_daily\_betas\_batch(symbols, tidy\_finance, n\_cores, batch\_size}\OperatorTok{=}\DecValTok{500}\NormalTok{, }
\NormalTok{                                look\_back\_days}\OperatorTok{=}\DecValTok{1260}\NormalTok{, min\_obs}\OperatorTok{=}\DecValTok{1000}\NormalTok{):}
    \CommentTok{"""}
\CommentTok{    Estimate rolling betas from daily data using batch processing.}
\CommentTok{    """}
    \CommentTok{\# First, compute or load market return}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Computing daily market excess returns..."}\NormalTok{)}
\NormalTok{    mkt\_daily }\OperatorTok{=}\NormalTok{ compute\_market\_return\_daily(tidy\_finance)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Market returns: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(mkt\_daily)}\SpecialCharTok{\}}\SpecialStringTok{ days"}\NormalTok{)}
    
\NormalTok{    n\_batches }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(np.ceil(}\BuiltInTok{len}\NormalTok{(symbols) }\OperatorTok{/}\NormalTok{ batch\_size))}
\NormalTok{    all\_results }\OperatorTok{=}\NormalTok{ []}
    
    \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(n\_batches):}
\NormalTok{        batch\_start }\OperatorTok{=}\NormalTok{ j }\OperatorTok{*}\NormalTok{ batch\_size}
\NormalTok{        batch\_end }\OperatorTok{=} \BuiltInTok{min}\NormalTok{((j }\OperatorTok{+} \DecValTok{1}\NormalTok{) }\OperatorTok{*}\NormalTok{ batch\_size, }\BuiltInTok{len}\NormalTok{(symbols))}
\NormalTok{        batch\_symbols }\OperatorTok{=}\NormalTok{ symbols[batch\_start:batch\_end]}
        
\NormalTok{        symbol\_list }\OperatorTok{=} \StringTok{", "}\NormalTok{.join(}\SpecialStringTok{f"\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{s}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}"} \ControlFlowTok{for}\NormalTok{ s }\KeywordTok{in}\NormalTok{ batch\_symbols)}
        
\NormalTok{        query }\OperatorTok{=} \SpecialStringTok{f"""}
\SpecialStringTok{            SELECT symbol, date, ret\_excess}
\SpecialStringTok{            FROM prices\_daily}
\SpecialStringTok{            WHERE symbol IN (}\SpecialCharTok{\{}\NormalTok{symbol\_list}\SpecialCharTok{\}}\SpecialStringTok{)}
\SpecialStringTok{        """}
        
\NormalTok{        prices\_daily\_batch }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{            sql}\OperatorTok{=}\NormalTok{query,}
\NormalTok{            con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{            parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{        )}
        
        \CommentTok{\# Merge with market excess return}
\NormalTok{        prices\_daily\_batch }\OperatorTok{=}\NormalTok{ prices\_daily\_batch.merge(}
\NormalTok{            mkt\_daily, }
\NormalTok{            on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, }
\NormalTok{            how}\OperatorTok{=}\StringTok{"inner"}
\NormalTok{        )}
        
        \CommentTok{\# Group by symbol and estimate betas}
\NormalTok{        grouped }\OperatorTok{=}\NormalTok{ prices\_daily\_batch.groupby(}\StringTok{"symbol"}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
        
        \CommentTok{\# Parallel estimation}
\NormalTok{        batch\_results }\OperatorTok{=}\NormalTok{ Parallel(n\_jobs}\OperatorTok{=}\NormalTok{n\_cores)(}
\NormalTok{            delayed(}\KeywordTok{lambda}\NormalTok{ name, group: }
\NormalTok{                roll\_capm\_estimation\_daily(group, look\_back\_days}\OperatorTok{=}\NormalTok{look\_back\_days, min\_obs}\OperatorTok{=}\NormalTok{min\_obs)}
\NormalTok{                .assign(symbol}\OperatorTok{=}\NormalTok{name)}
\NormalTok{            )(name, group)}
            \ControlFlowTok{for}\NormalTok{ name, group }\KeywordTok{in}\NormalTok{ grouped}
\NormalTok{        )}
        
\NormalTok{        batch\_results }\OperatorTok{=}\NormalTok{ [r }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ batch\_results }\ControlFlowTok{if}\NormalTok{ r }\KeywordTok{is} \KeywordTok{not} \VariableTok{None} \KeywordTok{and} \KeywordTok{not}\NormalTok{ r.empty]}
        
        \ControlFlowTok{if}\NormalTok{ batch\_results:}
\NormalTok{            all\_results.append(pd.concat(batch\_results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{))}
        
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Batch }\SpecialCharTok{\{}\NormalTok{j}\OperatorTok{+}\DecValTok{1}\SpecialCharTok{\}}\SpecialStringTok{/}\SpecialCharTok{\{}\NormalTok{n\_batches}\SpecialCharTok{\}}\SpecialStringTok{ complete"}\NormalTok{)}
    
    \ControlFlowTok{if}\NormalTok{ all\_results:}
        \ControlFlowTok{return}\NormalTok{ pd.concat(all\_results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{symbols }\OperatorTok{=}\NormalTok{ prices\_monthly[}\StringTok{"symbol"}\NormalTok{].unique().tolist()}

\NormalTok{capm\_daily }\OperatorTok{=}\NormalTok{ estimate\_daily\_betas\_batch(}
\NormalTok{    symbols}\OperatorTok{=}\NormalTok{symbols,}
\NormalTok{    tidy\_finance}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    n\_cores}\OperatorTok{=}\NormalTok{n\_cores,}
\NormalTok{    batch\_size}\OperatorTok{=}\DecValTok{500}\NormalTok{,}
\NormalTok{    look\_back\_days}\OperatorTok{=}\DecValTok{1260}\NormalTok{,  }\CommentTok{\# \textasciitilde{}5 years of trading days}
\NormalTok{    min\_obs}\OperatorTok{=}\DecValTok{1000}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily beta estimates: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(capm\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{capm\_daily.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"capm\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"CAPM estimates saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

For subsequent analysis, we load the pre-computed estimates:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{capm\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM capm\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Loaded }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(capm\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{ CAPM estimates"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Loaded 3,394,490 CAPM estimates
\end{verbatim}

\section{Analyzing Beta Estimates}\label{analyzing-beta-estimates}

\subsection{Extracting Beta Estimates}\label{extracting-beta-estimates}

We extract the beta coefficient estimates from our CAPM results for
analysis.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Extract monthly betas}
\NormalTok{beta\_monthly }\OperatorTok{=}\NormalTok{ (capm\_monthly}
\NormalTok{    .query(}\StringTok{"coefficient == \textquotesingle{}beta\textquotesingle{}"}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"estimate"}\NormalTok{: }\StringTok{"beta"}\NormalTok{\})}
\NormalTok{    [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"beta"}\NormalTok{]]}
\NormalTok{    .assign(frequency}\OperatorTok{=}\StringTok{"monthly"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Save to database}
\NormalTok{beta\_monthly.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"beta\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Monthly betas: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(beta\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique stocks: }\SpecialCharTok{\{}\NormalTok{beta\_monthly[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Monthly betas: 80,790 observations
Unique stocks: 1,383
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load pre{-}computed betas}
\NormalTok{beta\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM beta\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Summary Statistics}\label{summary-statistics}

We examine the distribution of beta estimates to verify their
reasonableness.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\StringTok{"Beta Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(beta\_monthly[}\StringTok{"beta"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{))}

\CommentTok{\# Additional diagnostics}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Stocks with negative average beta: }\SpecialCharTok{\{}\NormalTok{(beta\_monthly.groupby(}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{].mean() }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{)}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Stocks with beta \textgreater{} 2: }\SpecialCharTok{\{}\NormalTok{(beta\_monthly.groupby(}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}beta\textquotesingle{}}\NormalTok{].mean() }\OperatorTok{\textgreater{}} \DecValTok{2}\NormalTok{)}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Beta Summary Statistics:
count    80790.000
mean         0.501
std          0.539
min         -1.345
25%          0.130
50%          0.447
75%          0.832
max          2.678
Name: beta, dtype: float64

Stocks with negative average beta: 177
Stocks with beta > 2: 5
\end{verbatim}

\subsection{Beta Distribution Across
Industries}\label{beta-distribution-across-industries}

Different industries have different exposures to systematic market risk
based on their business models, operating leverage, and financial
leverage. Figure~\ref{fig-beta-by-industry} shows the distribution of
firm-level average betas across Vietnamese industries.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Merge betas with industry information}
\NormalTok{beta\_with\_industry }\OperatorTok{=}\NormalTok{ (beta\_monthly}
\NormalTok{    .merge(}
\NormalTok{        prices\_monthly[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"icb\_name\_vi"}\NormalTok{]].drop\_duplicates(),}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{    .dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"icb\_name\_vi"}\NormalTok{])}
\NormalTok{)}

\CommentTok{\# Compute firm{-}level average beta by industry}
\NormalTok{beta\_by\_industry }\OperatorTok{=}\NormalTok{ (beta\_with\_industry}
\NormalTok{    .groupby([}\StringTok{"icb\_name\_vi"}\NormalTok{, }\StringTok{"symbol"}\NormalTok{])[}\StringTok{"beta"}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\CommentTok{\# Order industries by median beta}
\NormalTok{industry\_order }\OperatorTok{=}\NormalTok{ (beta\_by\_industry}
\NormalTok{    .groupby(}\StringTok{"icb\_name\_vi"}\NormalTok{)[}\StringTok{"beta"}\NormalTok{]}
\NormalTok{    .median()}
\NormalTok{    .sort\_values()}
\NormalTok{    .index.tolist()}
\NormalTok{)}

\CommentTok{\# Select top 10 industries by number of firms for clearer visualization}
\NormalTok{top\_industries }\OperatorTok{=}\NormalTok{ (beta\_by\_industry}
\NormalTok{    .groupby(}\StringTok{"icb\_name\_vi"}\NormalTok{)}
\NormalTok{    .size()}
\NormalTok{    .nlargest(}\DecValTok{10}\NormalTok{)}
\NormalTok{    .index.tolist()}
\NormalTok{)}

\NormalTok{beta\_by\_industry\_filtered }\OperatorTok{=}\NormalTok{ beta\_by\_industry.query(}\StringTok{"icb\_name\_vi in @top\_industries"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_industry\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        beta\_by\_industry\_filtered,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"icb\_name\_vi"}\NormalTok{, y}\OperatorTok{=}\StringTok{"beta"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_boxplot(fill}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_hline(yintercept}\OperatorTok{=}\DecValTok{1}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"dashed"}\NormalTok{, color}\OperatorTok{=}\StringTok{"red"}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ coord\_flip()}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Beta"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Beta Distribution by Industry"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{beta\_industry\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{08_beta_estimation_files/figure-pdf/fig-beta-by-industry-output-1.pdf}}

}

\caption{\label{fig-beta-by-industry}Distribution of firm-level average
betas across Vietnamese industries. Box plots show the median,
interquartile range, and outliers for each industry.}

\end{figure}%

\subsection{Time Variation in Cross-Sectional Beta
Distribution}\label{time-variation-in-cross-sectional-beta-distribution}

Betas vary not only across stocks but also over time.
Figure~\ref{fig-beta-quantiles} shows how the cross-sectional
distribution of betas has evolved in the Vietnamese market.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Compute monthly quantiles}
\NormalTok{beta\_quantiles }\OperatorTok{=}\NormalTok{ (beta\_monthly}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)[}\StringTok{"beta"}\NormalTok{]}
\NormalTok{    .quantile(q}\OperatorTok{=}\NormalTok{np.arange(}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.0}\NormalTok{, }\FloatTok{0.1}\NormalTok{))}
\NormalTok{    .reset\_index()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"level\_1"}\NormalTok{: }\StringTok{"quantile"}\NormalTok{\})}
\NormalTok{    .assign(quantile}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{"quantile"}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{).astype(}\BuiltInTok{str}\NormalTok{) }\OperatorTok{+} \StringTok{"\%"}\NormalTok{)}
\NormalTok{)}

\NormalTok{beta\_quantiles\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        beta\_quantiles,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"beta"}\NormalTok{, color}\OperatorTok{=}\StringTok{"quantile"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_line(alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ geom\_hline(yintercept}\OperatorTok{=}\DecValTok{1}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"dashed"}\NormalTok{, color}\OperatorTok{=}\StringTok{"gray"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Beta"}\NormalTok{,}
\NormalTok{        color}\OperatorTok{=}\StringTok{"Quantile"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Cross{-}Sectional Distribution of Betas Over Time"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{beta\_quantiles\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{08_beta_estimation_files/figure-pdf/fig-beta-quantiles-output-1.pdf}}

}

\caption{\label{fig-beta-quantiles}Monthly quantiles of beta estimates
over time. Each line represents a decile of the cross-sectional beta
distribution.}

\end{figure}%

The figure reveals several interesting patterns:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Level shifts}: The entire distribution of betas can shift over
  time, reflecting changes in market-wide correlation.
\item
  \textbf{Dispersion changes}: During market stress, the spread between
  high and low beta stocks may change as correlations move.
\item
  \textbf{Trends}: Some periods show trending behavior in betas,
  possibly reflecting structural changes in the economy.
\end{enumerate}

\subsection{Coverage Analysis}\label{coverage-analysis}

We verify that our estimation procedure produces reasonable coverage
across the sample. Figure~\ref{fig-beta-coverage} shows the fraction of
stocks with available beta estimates over time.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Count stocks with and without betas}
\NormalTok{coverage }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{]}
\NormalTok{    .nunique()}
\NormalTok{    .reset\_index(name}\OperatorTok{=}\StringTok{"total\_stocks"}\NormalTok{)}
\NormalTok{    .merge(}
\NormalTok{        beta\_monthly.groupby(}\StringTok{"date"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{].nunique().reset\_index(name}\OperatorTok{=}\StringTok{"with\_beta"}\NormalTok{),}
\NormalTok{        on}\OperatorTok{=}\StringTok{"date"}\NormalTok{,}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{    .fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    .assign(coverage}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"with\_beta"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"total\_stocks"}\NormalTok{])}
\NormalTok{)}

\NormalTok{coverage\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(coverage, aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"coverage"}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ geom\_line(color}\OperatorTok{=}\StringTok{"steelblue"}\NormalTok{, size}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Share with Beta Estimate"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Beta Estimation Coverage Over Time"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format(), limits}\OperatorTok{=}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{))}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
\NormalTok{)}
\NormalTok{coverage\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{08_beta_estimation_files/figure-pdf/fig-beta-coverage-output-1.pdf}}

}

\caption{\label{fig-beta-coverage}Share of stocks with available beta
estimates over time. Coverage increases as more stocks accumulate
sufficient return history.}

\end{figure}%

Coverage is lower in early years because stocks need sufficient return
history (at least 48 months) before their betas can be estimated. As the
market matures and stocks accumulate longer histories, coverage
approaches 100\%.

\section{Comparing Monthly and Daily Beta
Estimates}\label{comparing-monthly-and-daily-beta-estimates}

When both monthly and daily beta estimates are available, we can compare
them to understand how estimation frequency affects results.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Combine monthly and daily estimates}
\NormalTok{beta\_daily }\OperatorTok{=}\NormalTok{ (capm\_daily}
\NormalTok{    .query(}\StringTok{"coefficient == \textquotesingle{}beta\textquotesingle{}"}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"estimate"}\NormalTok{: }\StringTok{"beta"}\NormalTok{\})}
\NormalTok{    [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"beta"}\NormalTok{]]}
\NormalTok{    .assign(frequency}\OperatorTok{=}\StringTok{"daily"}\NormalTok{)}
\NormalTok{)}

\NormalTok{beta\_combined }\OperatorTok{=}\NormalTok{ pd.concat([beta\_monthly, beta\_daily], ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Filter to example stocks}
\NormalTok{beta\_comparison }\OperatorTok{=}\NormalTok{ (beta\_combined}
\NormalTok{    .merge(examples, on}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{)}
\NormalTok{    .query(}\StringTok{"symbol in [\textquotesingle{}VIC\textquotesingle{}, \textquotesingle{}FPT\textquotesingle{}]"}\NormalTok{)  }\CommentTok{\# Select two for clarity}
\NormalTok{)}

\NormalTok{comparison\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ggplot(}
\NormalTok{        beta\_comparison,}
\NormalTok{        aes(x}\OperatorTok{=}\StringTok{"date"}\NormalTok{, y}\OperatorTok{=}\StringTok{"beta"}\NormalTok{, color}\OperatorTok{=}\StringTok{"frequency"}\NormalTok{, linetype}\OperatorTok{=}\StringTok{"frequency"}\NormalTok{)}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ geom\_line(size}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ facet\_wrap(}\StringTok{"\textasciitilde{}company"}\NormalTok{, ncol}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{        x}\OperatorTok{=}\StringTok{""}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{"Beta"}\NormalTok{,}
\NormalTok{        color}\OperatorTok{=}\StringTok{"Data Frequency"}\NormalTok{,}
\NormalTok{        linetype}\OperatorTok{=}\StringTok{"Data Frequency"}\NormalTok{,}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Monthly vs Daily Beta Estimates"}
\NormalTok{    )}
    \OperatorTok{+}\NormalTok{ scale\_x\_datetime(date\_breaks}\OperatorTok{=}\StringTok{"2 years"}\NormalTok{, date\_labels}\OperatorTok{=}\StringTok{"\%Y"}\NormalTok{)}
    \OperatorTok{+}\NormalTok{ theme\_minimal()}
    \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"bottom"}\NormalTok{)}
\NormalTok{)}
\NormalTok{comparison\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{08_beta_estimation_files/figure-pdf/fig-beta-comparison-output-1.pdf}}

}

\caption{\label{fig-beta-comparison}Comparison of beta estimates using
monthly versus daily returns for selected stocks. Daily estimates are
smoother due to more observations per estimation window.}

\end{figure}%

The comparison reveals that daily-based estimates are generally smoother
due to the larger number of observations in each window. However, the
level and trend of estimates are similar across frequencies, providing
validation that both approaches capture the same underlying systematic
risk exposure.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Correlation between monthly and daily estimates}
\NormalTok{correlation\_data }\OperatorTok{=}\NormalTok{ (beta\_combined}
\NormalTok{    .pivot\_table(index}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], columns}\OperatorTok{=}\StringTok{"frequency"}\NormalTok{, values}\OperatorTok{=}\StringTok{"beta"}\NormalTok{)}
\NormalTok{    .dropna()}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Correlation between monthly and daily betas: }\SpecialCharTok{\{}\NormalTok{correlation\_data}\SpecialCharTok{.}\NormalTok{corr()}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Correlation between monthly and daily betas: 0.745
\end{verbatim}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 2\tabcolsep) * \real{0.5000}}
  >{\raggedright\arraybackslash}p{(\linewidth - 2\tabcolsep) * \real{0.5000}}@{}}
\caption{Theoretical Reasons for Imperfect
Correlation}\label{tbl-imperfect-cor}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Factor
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Effect
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Factor
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Effect
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Non-synchronous trading & Daily betas can be biased downward for
illiquid stocks \\
Microstructure noise & Bid-ask bounce adds noise to daily estimates \\
Different effective windows & Same calendar period but
\textasciitilde20x more observations for daily \\
Mean reversion speed & Daily captures faster-moving risk dynamics \\
\end{longtable}

Table~\ref{tbl-imperfect-cor} shows several reasons why we might observe
imperfect correlation.

\section{Key Takeaways}\label{key-takeaways-6}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{CAPM beta} measures a stock's sensitivity to systematic market
  risk and is fundamental to modern portfolio theory, cost of capital
  estimation, and risk management.
\item
  \textbf{Rolling-window estimation} captures time variation in betas,
  which reflects changes in companies' business models, leverage, and
  market conditions.
\item
  \textbf{Parallelization} dramatically reduces computation time for
  large-scale estimation tasks by distributing work across multiple CPU
  cores.
\item
  \textbf{Estimation choices matter}: Window length, return frequency,
  and minimum observation requirements all affect beta estimates.
  Researchers should choose parameters appropriate for their specific
  application.
\item
  \textbf{Industry patterns}: Vietnamese stocks show systematic
  differences in market sensitivity across industries, with cyclical
  sectors exhibiting higher betas than defensive sectors.
\item
  \textbf{Time variation}: The cross-sectional distribution of betas in
  Vietnam has evolved over time, with notable shifts during market
  stress periods.
\item
  \textbf{Frequency comparison}: Monthly and daily beta estimates are
  positively correlated but not identical. Daily estimates are smoother
  while monthly estimates may better capture lower-frequency variation.
\item
  \textbf{Data quality checks}: Coverage analysis and summary statistics
  help identify potential issues in estimation procedures before using
  results in downstream analyses.
\end{enumerate}

\bookmarksetup{startatroot}

\chapter{Univariate Portfolio Sorts}\label{univariate-portfolio-sorts}

In this chapter, we dive into portfolio sorts, one of the most widely
used statistical methodologies in empirical asset pricing (e.g., Bali,
Engle, and Murray 2016). The key application of portfolio sorts is to
examine whether one or more variables can predict future excess returns.
In general, the idea is to sort individual stocks into portfolios, where
the stocks within each portfolio are similar with respect to a sorting
variable, such as firm size. The different portfolios then represent
well-diversified investments that differ in the level of the sorting
variable. You can then attribute the differences in the return
distribution to the impact of the sorting variable. We start by
introducing univariate portfolio sorts (which sort based on only one
characteristic) and tackle bivariate sorting in
\href{11_value_bivariate.qmd}{Value and Bivariate Sorts}.

A univariate portfolio sort considers only one sorting variable
\(x_{i,t-1}\). Here, \(i\) denotes the stock and \(t-1\) indicates that
the characteristic is observable by investors at time \(t\). The
objective is to assess the cross-sectional relation between
\(x_{i,t-1}\) and, typically, stock excess returns \(r_{i,t}\) at time
\(t\) as the outcome variable. To illustrate how portfolio sorts work,
we use estimates for market betas from the previous chapter as our
sorting variable.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ sqlite3}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format}
\ImportTok{from}\NormalTok{ regtabletotext }\ImportTok{import}\NormalTok{ prettify\_result}
\end{Highlighting}
\end{Shaded}

\section{Data Preparation}\label{data-preparation-1}

We start with loading the required data from our SQLite database
introduced in
\hyperref[accessing-and-managing-vn-financial-data]{Accessing and
Managing Financial Data} and \hyperref[datacore-data]{DataCore Data}. In
particular, we use the monthly stock price data as our asset universe.
Once we form our portfolios, we use the market factor returns to compute
the risk-adjusted performance (i.e., alpha). \texttt{beta} is the
dataframe with market betas computed in the previous chapter.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ (pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT symbol, date, ret\_excess, mktcap\_lag FROM prices\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\})}
\NormalTok{)}

\NormalTok{factors\_ff3\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{  sql}\OperatorTok{=}\StringTok{"SELECT date, mkt\_excess FROM factors\_ff3\_monthly"}\NormalTok{,}
\NormalTok{  con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{  parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\NormalTok{beta }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{  sql}\OperatorTok{=}\StringTok{"SELECT symbol, date, beta FROM beta\_monthly"}\NormalTok{,}
\NormalTok{  con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{  parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Sorting by Market Beta}\label{sorting-by-market-beta}

Next, we merge our sorting variable with the return data. We use the
one-month \emph{lagged} betas as a sorting variable to ensure that the
sorts rely only on information available when we create the portfolios.
To lag stock beta by one month, we add one month to the current date and
join the resulting information with our return data. This procedure
ensures that month \(t\) information is available in month \(t+1\). You
may be tempted to simply use a call such as
\texttt{prices\_monthly{[}\textquotesingle{}beta\_lag\textquotesingle{}{]}\ =\ prices\_monthly.groupby(\textquotesingle{}symbol\textquotesingle{}){[}\textquotesingle{}beta\textquotesingle{}{]}.shift(1)}
instead. This procedure, however, does not work correctly if there are
implicit missing values in the time series.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_lag }\OperatorTok{=}\NormalTok{ (beta}
\NormalTok{  .assign(date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{]}\OperatorTok{+}\NormalTok{pd.DateOffset(months}\OperatorTok{=}\DecValTok{1}\NormalTok{))}
\NormalTok{  .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"beta"}\NormalTok{])}
\NormalTok{  .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"beta"}\NormalTok{: }\StringTok{"beta\_lag"}\NormalTok{\})}
\NormalTok{  .dropna()}
\NormalTok{)}

\NormalTok{data\_for\_sorts }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{  .merge(beta\_lag, how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{  .dropna()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The first step to conduct portfolio sorts is to calculate periodic
breakpoints that you can use to group the stocks into portfolios. For
simplicity, we start with the median lagged market beta as the single
breakpoint. We then compute the value-weighted returns for each of the
two resulting portfolios, which means that the lagged market
capitalization determines the weight in \texttt{np.average()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_portfolios }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    data\_for\_sorts}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}
\NormalTok{        x.assign(}
\NormalTok{            portfolio}\OperatorTok{=}\NormalTok{pd.qcut(x[}\StringTok{"beta\_lag"}\NormalTok{], q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\StringTok{"low"}\NormalTok{, }\StringTok{"high"}\NormalTok{]),}
\NormalTok{            date}\OperatorTok{=}\NormalTok{x.name}
\NormalTok{        )}
\NormalTok{    ))}
\NormalTok{    .reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .groupby([}\StringTok{"portfolio"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{]))}
\NormalTok{    .reset\_index(name}\OperatorTok{=}\StringTok{"ret"}\NormalTok{)}
\NormalTok{    .dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\NormalTok{beta\_portfolios.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& portfolio & date & ret \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & low & 2016-08-31 & -0.016507 \\
1 & low & 2016-09-30 & -0.089155 \\
2 & low & 2016-11-30 & -0.015080 \\
3 & low & 2017-01-31 & 0.004113 \\
4 & low & 2017-02-28 & 0.035101 \\
\end{longtable}

\section{Performance Evaluation}\label{performance-evaluation}

We can construct a long-short strategy based on the two portfolios: buy
the high-beta portfolio and, at the same time, short the low-beta
portfolio. Thereby, the overall position in the market is net-zero.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_longshort }\OperatorTok{=}\NormalTok{ (beta\_portfolios}
\NormalTok{  .pivot\_table(index}\OperatorTok{=}\StringTok{"date"}\NormalTok{, columns}\OperatorTok{=}\StringTok{"portfolio"}\NormalTok{, values}\OperatorTok{=}\StringTok{"ret"}\NormalTok{)}
\NormalTok{  .reset\_index()}
\NormalTok{  .assign(long\_short}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"high"}\NormalTok{]}\OperatorTok{{-}}\NormalTok{x[}\StringTok{"low"}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We compute the average return and the corresponding standard error to
test whether the long-short portfolio yields on average positive or
negative excess returns. In the asset pricing literature, one typically
adjusts for autocorrelation by using Newey and West (1987)
\(t\)-statistics to test the null hypothesis that average portfolio
excess returns are equal to zero. One necessary input for Newey-West
standard errors is a chosen bandwidth based on the number of lags
employed for the estimation. Researchers often default to choosing a
pre-specified lag length of six months (which is not a data-driven
approach). We do so in the \texttt{fit()} function by indicating the
\texttt{cov\_type} as \texttt{HAC} and providing the maximum lag length
through an additional keywords dictionary.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_fit }\OperatorTok{=}\NormalTok{ (sm.OLS.from\_formula(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{"long\_short \textasciitilde{} 1"}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{beta\_longshort}
\NormalTok{  )}
\NormalTok{  .fit(cov\_type}\OperatorTok{=}\StringTok{"HAC"}\NormalTok{, cov\_kwds}\OperatorTok{=}\NormalTok{\{}\StringTok{"maxlags"}\NormalTok{: }\DecValTok{6}\NormalTok{\})}
\NormalTok{)}
\NormalTok{prettify\_result(model\_fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
OLS Model:
long_short ~ 1

Coefficients:
           Estimate  Std. Error  t-Statistic  p-Value
Intercept     0.006       0.006        1.018    0.309

Summary statistics:
- Number of observations: 53
- R-squared: 0.000, Adjusted R-squared: 0.000
- F-statistic not available
\end{verbatim}

The results indicate that we cannot reject the null hypothesis of
average returns being equal to zero. Our portfolio strategy using the
median as a breakpoint does not yield any abnormal returns. Is this
finding surprising if you reconsider the CAPM? It certainly is. The CAPM
predicts that high-beta stocks should yield higher expected returns. Our
portfolio sort implicitly mimics an investment strategy that finances
high-beta stocks by shorting low-beta stocks. Therefore, one should
expect that the average excess returns yield a return that is above the
risk-free rate.

\section{Functional Programming for Portfolio
Sorts}\label{functional-programming-for-portfolio-sorts}

Now, we take portfolio sorts to the next level. We want to be able to
sort stocks into an arbitrary number of portfolios. For this case,
functional programming is very handy: we define a function that gives us
flexibility concerning which variable to use for the sorting, denoted by
\texttt{sorting\_variable}. We use \texttt{np.quantile()} to compute
breakpoints for \texttt{n\_portfolios}. Then, we assign portfolios to
stocks using the \texttt{pd.cut()} function. The output of the following
function is a new column that contains the number of the portfolio to
which a stock belongs.

In some applications, the variable used for the sorting might be
clustered (e.g., at a lower bound of 0). Then, multiple breakpoints may
be identical, leading to empty portfolios. Similarly, some portfolios
might have a very small number of stocks at the beginning of the sample.
Cases where the number of portfolio constituents differs substantially
due to the distribution of the characteristics require careful
consideration and, depending on the application, might require
customized sorting approaches.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ assign\_portfolio(data, sorting\_variable, n\_portfolios):}
    \CommentTok{"""Assign portfolios to a bin between breakpoints."""}
    
\NormalTok{    breakpoints }\OperatorTok{=}\NormalTok{ np.quantile(}
\NormalTok{      data[sorting\_variable].dropna(), }
\NormalTok{      np.linspace(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, n\_portfolios }\OperatorTok{+} \DecValTok{1}\NormalTok{), }
\NormalTok{      method}\OperatorTok{=}\StringTok{"linear"}
\NormalTok{    )}
    
\NormalTok{    assigned\_portfolios }\OperatorTok{=}\NormalTok{ pd.cut(}
\NormalTok{      data[sorting\_variable],}
\NormalTok{      bins}\OperatorTok{=}\NormalTok{breakpoints,}
\NormalTok{      labels}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, breakpoints.size),}
\NormalTok{      include\_lowest}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{      right}\OperatorTok{=}\VariableTok{False}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ assigned\_portfolios}
\end{Highlighting}
\end{Shaded}

We can use the above function to sort stocks into ten portfolios each
month using lagged betas and compute value-weighted returns for each
portfolio. Note that we transform the portfolio column to a factor
variable because it provides more convenience for the figure
construction below.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_portfolios }\OperatorTok{=}\NormalTok{ (data\_for\_sorts}
\NormalTok{  .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{  .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: x.assign(}
\NormalTok{      portfolio}\OperatorTok{=}\NormalTok{assign\_portfolio(x, }\StringTok{"beta\_lag"}\NormalTok{, }\DecValTok{10}\NormalTok{)}
\NormalTok{    ), include\_groups}\OperatorTok{=}\VariableTok{False}
\NormalTok{  )}
\NormalTok{  .reset\_index(level}\OperatorTok{=}\StringTok{"date"}\NormalTok{)}
\NormalTok{  .groupby([}\StringTok{"portfolio"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{  .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
      \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{    \}), include\_groups}\OperatorTok{=}\VariableTok{False}
\NormalTok{  )}
\NormalTok{  .reset\_index()}
\NormalTok{  .merge(factors\_ff3\_monthly, how}\OperatorTok{=}\StringTok{"left"}\NormalTok{, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{More Performance Evaluation}\label{more-performance-evaluation}

In the next step, we compute summary statistics for each beta portfolio.
Namely, we compute CAPM-adjusted alphas, the beta of each beta
portfolio, and average returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_portfolios\_summary }\OperatorTok{=}\NormalTok{ (beta\_portfolios}
\NormalTok{  .groupby(}\StringTok{"portfolio"}\NormalTok{)}
\NormalTok{  .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
      \StringTok{"alpha"}\NormalTok{: sm.OLS.from\_formula(}
\NormalTok{          formula}\OperatorTok{=}\StringTok{"ret \textasciitilde{} 1 + mkt\_excess"}\NormalTok{, }
\NormalTok{          data}\OperatorTok{=}\NormalTok{x}
\NormalTok{        ).fit().params[}\StringTok{"Intercept"}\NormalTok{],}
      \StringTok{"beta"}\NormalTok{: sm.OLS.from\_formula(}
\NormalTok{          formula}\OperatorTok{=}\StringTok{"ret \textasciitilde{} 1 + mkt\_excess"}\NormalTok{, }
\NormalTok{          data}\OperatorTok{=}\NormalTok{x}
\NormalTok{        ).fit().params[}\StringTok{"mkt\_excess"}\NormalTok{],}
      \StringTok{"ret"}\NormalTok{: x[}\StringTok{"ret"}\NormalTok{].mean()}
\NormalTok{    \}), include\_groups}\OperatorTok{=}\VariableTok{False}
\NormalTok{  )}
\NormalTok{  .reset\_index()}
\NormalTok{)}
\NormalTok{beta\_portfolios\_summary}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& portfolio & alpha & beta & ret \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 1 & 0.007031 & 0.356225 & 0.003892 \\
1 & 2 & -0.004215 & 0.227882 & -0.005509 \\
2 & 3 & -0.010169 & 0.390216 & -0.011241 \\
3 & 4 & -0.014205 & 0.388342 & -0.015732 \\
4 & 5 & -0.007220 & 0.616833 & -0.009723 \\
5 & 6 & 0.010648 & 0.976502 & 0.006577 \\
6 & 7 & -0.010739 & 0.679145 & -0.012645 \\
7 & 8 & -0.002757 & 0.991774 & -0.006963 \\
8 & 9 & -0.003448 & 0.904886 & -0.007174 \\
9 & 10 & 0.010675 & 1.376356 & 0.004944 \\
\end{longtable}

Figure~\ref{fig-701} illustrates the CAPM alphas of beta-sorted
portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_portfolios\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    beta\_portfolios\_summary, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"portfolio"}\NormalTok{, y}\OperatorTok{=}\StringTok{"alpha"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"portfolio"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_bar(stat}\OperatorTok{=}\StringTok{"identity"}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{"Portfolio"}\NormalTok{, y}\OperatorTok{=}\StringTok{"CAPM alpha"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"Portfolio"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"CAPM alphas of beta{-}sorted portfolios"}
\NormalTok{    )}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}
\NormalTok{beta\_portfolios\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[htb]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{09_univariate_portfolio_sort_files/figure-pdf/fig-701-output-1.pdf}}

}

\caption{\label{fig-701}The figure shows CAPM alphas of beta-sorted
portfolios. Portfolios are sorted into deciles each month based on their
estimated CAPM beta. The bar charts indicate the CAPM alpha of the
resulting portfolio returns during the sample period.}

\end{figure}%

Unlike the well-documented ``betting against beta'' anomaly in US
markets, where low-beta portfolios exhibit positive alphas and high-beta
portfolios exhibit negative alphas in a monotonic pattern, the
Vietnamese market shows no clear relationship between beta and
risk-adjusted returns. The alphas fluctuate without a discernible trend
across deciles. This lack of pattern likely reflects the limited sample
period rather than a definitive conclusion about beta pricing in
Vietnam. With such a short time series, the portfolio-level CAPM
regressions contain substantial estimation noise, making it difficult to
detect subtle anomalies. Longer sample periods would be needed to draw
reliable conclusions about whether the low-beta anomaly exists in the
Vietnamese equity market.

\section{Security Market Line and Beta
Portfolios}\label{security-market-line-and-beta-portfolios}

The CAPM predicts that our portfolios should lie on the security market
line (SML). The slope of the SML is equal to the market risk premium and
reflects the risk-return trade-off at any given time.
Figure~\ref{fig-702} illustrates the security market line: We see that
(not surprisingly) the high-beta portfolio returns have a high
correlation with the market returns. However, it seems like the average
excess returns for high-beta stocks are lower than what the security
market line implies would be an ``appropriate'' compensation for the
high market risk.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sml\_capm }\OperatorTok{=}\NormalTok{ (sm.OLS.from\_formula(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{"ret \textasciitilde{} 1 + beta"}\NormalTok{, }
\NormalTok{    data}\OperatorTok{=}\NormalTok{beta\_portfolios\_summary}
\NormalTok{  )}
\NormalTok{  .fit()}
\NormalTok{  .params}
\NormalTok{)}

\NormalTok{sml\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    beta\_portfolios\_summary,}
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"beta"}\NormalTok{, y}\OperatorTok{=}\StringTok{"ret"}\NormalTok{, color}\OperatorTok{=}\StringTok{"factor(portfolio)"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_point()}
  \OperatorTok{+}\NormalTok{ geom\_abline(}
\NormalTok{      intercept}\OperatorTok{=}\DecValTok{0}\NormalTok{, slope}\OperatorTok{=}\NormalTok{factors\_ff3\_monthly[}\StringTok{"mkt\_excess"}\NormalTok{].mean(), linetype}\OperatorTok{=}\StringTok{"solid"}
\NormalTok{    )}
  \OperatorTok{+}\NormalTok{ geom\_abline(}
\NormalTok{      intercept}\OperatorTok{=}\NormalTok{sml\_capm[}\StringTok{"Intercept"}\NormalTok{], slope}\OperatorTok{=}\NormalTok{sml\_capm[}\StringTok{"beta"}\NormalTok{], linetype}\OperatorTok{=}\StringTok{"dashed"}
\NormalTok{    )}
  \OperatorTok{+}\NormalTok{ labs(}
\NormalTok{      x}\OperatorTok{=}\StringTok{"Beta"}\NormalTok{, y}\OperatorTok{=}\StringTok{"Excess return"}\NormalTok{, color}\OperatorTok{=}\StringTok{"Portfolio"}\NormalTok{,}
\NormalTok{      title}\OperatorTok{=}\StringTok{"Average portfolio excess returns and beta estimates"}
\NormalTok{    )}
  \OperatorTok{+}\NormalTok{ scale\_x\_continuous(limits}\OperatorTok{=}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{2}\NormalTok{))}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
\NormalTok{)}
\NormalTok{sml\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[htb]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{09_univariate_portfolio_sort_files/figure-pdf/fig-702-output-1.pdf}}

}

\caption{\label{fig-702}The figure shows average portfolio excess
returns and beta estimates. Excess returns are computed as CAPM alphas
of the beta-sorted portfolios. The horizontal axis indicates the CAPM
beta of the resulting beta-sorted portfolio return time series. The
dashed line indicates the slope coefficient of a linear regression of
excess returns on portfolio betas.}

\end{figure}%

To provide more evidence against the CAPM predictions, we again form a
long-short strategy that buys the high-beta portfolio and shorts the
low-beta portfolio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_longshort }\OperatorTok{=}\NormalTok{ (beta\_portfolios}
\NormalTok{  .assign(}
\NormalTok{    portfolio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (}
\NormalTok{      x[}\StringTok{"portfolio"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}
        \KeywordTok{lambda}\NormalTok{ y: }\StringTok{"high"} \ControlFlowTok{if}\NormalTok{ y }\OperatorTok{==}\NormalTok{ x[}\StringTok{"portfolio"}\NormalTok{].}\BuiltInTok{max}\NormalTok{()}
        \ControlFlowTok{else}\NormalTok{ (}\StringTok{"low"} \ControlFlowTok{if}\NormalTok{ y }\OperatorTok{==}\NormalTok{ x[}\StringTok{"portfolio"}\NormalTok{].}\BuiltInTok{min}\NormalTok{()}
        \ControlFlowTok{else}\NormalTok{ y)}
\NormalTok{      )}
\NormalTok{    )}
\NormalTok{  )}
\NormalTok{  .query(}\StringTok{"portfolio in [\textquotesingle{}low\textquotesingle{}, \textquotesingle{}high\textquotesingle{}]"}\NormalTok{)}
\NormalTok{  .pivot\_table(index}\OperatorTok{=}\StringTok{"date"}\NormalTok{, columns}\OperatorTok{=}\StringTok{"portfolio"}\NormalTok{, values}\OperatorTok{=}\StringTok{"ret"}\NormalTok{)}
\NormalTok{  .assign(long\_short}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"high"}\NormalTok{]}\OperatorTok{{-}}\NormalTok{x[}\StringTok{"low"}\NormalTok{])}
\NormalTok{  .merge(factors\_ff3\_monthly, how}\OperatorTok{=}\StringTok{"left"}\NormalTok{, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Again, the resulting long-short strategy does not exhibit statistically
significant returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_fit }\OperatorTok{=}\NormalTok{ (sm.OLS.from\_formula(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{"long\_short \textasciitilde{} 1"}\NormalTok{, }
\NormalTok{    data}\OperatorTok{=}\NormalTok{beta\_longshort}
\NormalTok{  )}
\NormalTok{  .fit(cov\_type}\OperatorTok{=}\StringTok{"HAC"}\NormalTok{, cov\_kwds}\OperatorTok{=}\NormalTok{\{}\StringTok{"maxlags"}\NormalTok{: }\DecValTok{1}\NormalTok{\})}
\NormalTok{)}
\NormalTok{prettify\_result(model\_fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
OLS Model:
long_short ~ 1

Coefficients:
           Estimate  Std. Error  t-Statistic  p-Value
Intercept     0.001       0.011        0.095    0.924

Summary statistics:
- Number of observations: 53
- R-squared: 0.000, Adjusted R-squared: 0.000
- F-statistic not available
\end{verbatim}

However, controlling for the effect of beta, the long-short portfolio
yields a CAPM-adjusted alpha. The results can provide evidence regarding
the validity of the CAPM in the Vietnamese market. The
betting-against-beta factor has been documented extensively in developed
markets (Frazzini and Pedersen 2014). Betting-against-beta corresponds
to a strategy that shorts high-beta stocks and takes a (levered) long
position in low-beta stocks. If borrowing constraints prevent investors
from taking positions on the security market line, they are instead
incentivized to buy high-beta stocks, which leads to a relatively higher
price (and therefore lower expected returns than implied by the CAPM)
for such high-beta stocks. As a result, the betting-against-beta
strategy earns from providing liquidity to capital-constrained investors
with lower risk aversion.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model\_fit }\OperatorTok{=}\NormalTok{ (sm.OLS.from\_formula(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{"long\_short \textasciitilde{} 1 + mkt\_excess"}\NormalTok{, }
\NormalTok{    data}\OperatorTok{=}\NormalTok{beta\_longshort}
\NormalTok{  )}
\NormalTok{  .fit(cov\_type}\OperatorTok{=}\StringTok{"HAC"}\NormalTok{, cov\_kwds}\OperatorTok{=}\NormalTok{\{}\StringTok{"maxlags"}\NormalTok{: }\DecValTok{1}\NormalTok{\})}
\NormalTok{)}
\NormalTok{prettify\_result(model\_fit)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
OLS Model:
long_short ~ 1 + mkt_excess

Coefficients:
            Estimate  Std. Error  t-Statistic  p-Value
Intercept      0.004       0.009        0.394    0.694
mkt_excess     1.020       0.116        8.784    0.000

Summary statistics:
- Number of observations: 52
- R-squared: 0.527, Adjusted R-squared: 0.518
- F-statistic: 77.156 on 1 and 50 DF, p-value: 0.000
\end{verbatim}

Figure~\ref{fig-703} shows the annual returns of the extreme beta
portfolios we are mainly interested in. The figure illustrates the
patterns over the sample period; each portfolio exhibits periods with
positive and negative annual returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_longshort\_year }\OperatorTok{=}\NormalTok{ (beta\_longshort}
\NormalTok{  .assign(year}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.year)}
\NormalTok{  .groupby(}\StringTok{"year"}\NormalTok{)}
\NormalTok{  .aggregate(}
\NormalTok{    low}\OperatorTok{=}\NormalTok{(}\StringTok{"low"}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1}\OperatorTok{+}\NormalTok{x).prod()}\OperatorTok{{-}}\DecValTok{1}\NormalTok{),}
\NormalTok{    high}\OperatorTok{=}\NormalTok{(}\StringTok{"high"}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1}\OperatorTok{+}\NormalTok{x).prod()}\OperatorTok{{-}}\DecValTok{1}\NormalTok{),}
\NormalTok{    long\_short}\OperatorTok{=}\NormalTok{(}\StringTok{"long\_short"}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1}\OperatorTok{+}\NormalTok{x).prod()}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{  )}
\NormalTok{  .reset\_index()}
\NormalTok{  .melt(id\_vars}\OperatorTok{=}\StringTok{"year"}\NormalTok{, var\_name}\OperatorTok{=}\StringTok{"name"}\NormalTok{, value\_name}\OperatorTok{=}\StringTok{"value"}\NormalTok{)}
\NormalTok{)}

\NormalTok{beta\_longshort\_figure }\OperatorTok{=}\NormalTok{ (}
\NormalTok{  ggplot(}
\NormalTok{    beta\_longshort\_year, }
\NormalTok{    aes(x}\OperatorTok{=}\StringTok{"year"}\NormalTok{, y}\OperatorTok{=}\StringTok{"value"}\NormalTok{, fill}\OperatorTok{=}\StringTok{"name"}\NormalTok{)}
\NormalTok{  )}
  \OperatorTok{+}\NormalTok{ geom\_col(position}\OperatorTok{=}\StringTok{"dodge"}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ facet\_wrap(}\StringTok{"\textasciitilde{}name"}\NormalTok{, ncol}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ labs(x}\OperatorTok{=}\StringTok{""}\NormalTok{, y}\OperatorTok{=}\StringTok{""}\NormalTok{, title}\OperatorTok{=}\StringTok{"Annual returns of beta portfolios"}\NormalTok{)}
  \OperatorTok{+}\NormalTok{ scale\_y\_continuous(labels}\OperatorTok{=}\NormalTok{percent\_format())}
  \OperatorTok{+}\NormalTok{ theme(legend\_position}\OperatorTok{=}\StringTok{"none"}\NormalTok{)}
\NormalTok{)}
\NormalTok{beta\_longshort\_figure.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[htb]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{09_univariate_portfolio_sort_files/figure-pdf/fig-703-output-1.pdf}}

}

\caption{\label{fig-703}The figure shows annual returns of beta
portfolios. We construct portfolios by sorting stocks into high and low
based on their estimated CAPM beta. Long short indicates a strategy that
goes long into high beta stocks and short low beta stocks.}

\end{figure}%

The high-beta portfolio and low-beta portfolio both exhibit substantial
year-to-year variation. The long-short portfolio, which goes long
high-beta stocks and short low-beta stocks, shows no consistent pattern
of positive returns. This erratic performance reinforces our earlier
finding that the beta-return relationship in the Vietnamese market does
not conform to theoretical CAPM predictions during our sample period.
The high volatility of annual long-short returns highlights the
substantial risk inherent in such a strategy, particularly in an
emerging market context with a limited sample period.

\section{Key Takeaways}\label{key-takeaways-7}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  Univariate portfolio sorts assess whether a single firm
  characteristic, like lagged market beta, can predict future excess
  returns.
\item
  Portfolios are formed each month using quantile breakpoints, with
  returns computed using value-weighted averages to reflect realistic
  investment strategies.
\item
  A long-short strategy based on beta-sorted portfolios fails to
  generate significant positive excess returns in the Vietnamese market,
  contradicting CAPM predictions that higher beta should yield higher
  returns.
\item
  The analysis provides a framework for examining the ``betting against
  beta'' anomaly, where low-beta portfolios may deliver higher alphas
  than high-beta portfolios, offering evidence regarding the validity of
  the CAPM.
\item
  The functional programming capabilities of Python enable scalable and
  flexible portfolio sorting, making it easy to analyze multiple
  characteristics and portfolio configurations.
\item
  Emerging markets like Vietnam may exhibit different beta-return
  relationships compared to developed markets, highlighting the
  importance of conducting market-specific empirical analysis rather
  than assuming universal applicability of asset pricing anomalies.
\end{enumerate}

\bookmarksetup{startatroot}

\chapter{Fama-French Factors}\label{fama-french-factors}

This chapter provides a replication of the Fama-French factor portfolios
for the Vietnamese stock market. The Fama-French factor models represent
a cornerstone of empirical asset pricing, originating from the seminal
work of Eugene F. Fama and French (1992) and later extended in Eugene F.
Fama and French (2015). These models have transformed how academics and
practitioners understand the cross-section of expected stock returns,
moving beyond the single-factor Capital Asset Pricing Model to
incorporate multiple sources of systematic risk.

We construct both the three-factor and five-factor models at monthly and
daily frequencies. The monthly factors serve as the foundation for most
asset pricing tests and portfolio analyses, while the daily factors
enable higher-frequency applications including short-horizon event
studies, market microstructure research, and daily beta estimation. By
constructing factors at both frequencies, we create a complete toolkit
for empirical finance research in the Vietnamese market.

The chapter proceeds as follows. We first discuss the theoretical
motivation for each factor and the economic intuition behind the
Fama-French methodology. We then prepare the necessary data, merging
stock returns with accounting characteristics. Next, we implement the
portfolio sorting procedures that form the basis of factor construction,
carefully following the original Fama-French protocols while adapting
them for Vietnamese market characteristics. We construct the
three-factor model (market, size, and value) before extending to the
five-factor model (adding profitability and investment). Finally, we
construct daily factors and validate our replicated factors through
various diagnostic checks.

\section{Theoretical Background}\label{theoretical-background}

\subsection{The Evolution from CAPM to Multi-Factor
Models}\label{the-evolution-from-capm-to-multi-factor-models}

The Capital Asset Pricing Model of Sharpe (1964) posits that a single
factor---the market portfolio---should explain all cross-sectional
variation in expected returns. However, decades of empirical research
have documented persistent patterns that CAPM cannot explain. Eugene F.
Fama and French (1992) demonstrated that two firm characteristics---size
and book-to-market ratio---capture substantial variation in average
returns that the market beta leaves unexplained.

Small firms tend to earn higher returns than large firms, a pattern
known as the size effect. Similarly, firms with high book-to-market
ratios (value stocks) tend to outperform firms with low book-to-market
ratios (growth stocks), known as the value premium. The three-factor
model formalizes these observations by constructing tradeable factor
portfolios:

\begin{equation}\phantomsection\label{eq-ff3}{
r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}(r_{m,t} - r_{f,t}) + \beta_i^{SMB} \cdot SMB_t + \beta_i^{HML} \cdot HML_t + \varepsilon_{i,t}
}\end{equation}

where:

\begin{itemize}
\tightlist
\item
  \(r_{i,t} - r_{f,t}\) is the excess return on asset \(i\)
\item
  \(r_{m,t} - r_{f,t}\) is the market excess return
\item
  \(SMB_t\) (Small Minus Big) is the size factor
\item
  \(HML_t\) (High Minus Low) is the value factor
\end{itemize}

\subsection{The Five-Factor Extension}\label{the-five-factor-extension}

Eugene F. Fama and French (2015) extended the model to include two
additional factors motivated by the dividend discount model. Firms with
higher profitability should have higher expected returns (all else
equal), and firms with aggressive investment policies should have lower
expected returns:

\begin{equation}\phantomsection\label{eq-ff5}{
r_{i,t} - r_{f,t} = \alpha_i + \beta_i^{MKT}MKT_t + \beta_i^{SMB}SMB_t + \beta_i^{HML}HML_t + \beta_i^{RMW}RMW_t + \beta_i^{CMA}CMA_t + \varepsilon_{i,t}
}\end{equation}

where:

\begin{itemize}
\tightlist
\item
  \(RMW_t\) (Robust Minus Weak) is the profitability factor
\item
  \(CMA_t\) (Conservative Minus Aggressive) is the investment factor
\end{itemize}

\subsection{Factor Construction
Methodology}\label{factor-construction-methodology}

The Fama-French methodology constructs factors through double-sorted
portfolios:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Size sorts}: Stocks are divided into Small and Big groups
  based on median market capitalization.
\item
  \textbf{Characteristic sorts}: Within each size group, stocks are
  sorted into terciles based on book-to-market (for HML), operating
  profitability (for RMW), or investment (for CMA).
\item
  \textbf{Factor returns}: Factors are computed as the difference
  between average returns of portfolios with high versus low
  characteristic values, averaging across size groups to neutralize size
  effects.
\item
  \textbf{Timing}: Portfolios are formed at the end of June each year
  using accounting data from the prior fiscal year, ensuring all
  information was publicly available at formation.
\end{enumerate}

\section{Setting Up the Environment}\label{setting-up-the-environment-2}

We load the required Python packages for data manipulation, statistical
analysis, and visualization.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ sqlite3}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{from}\NormalTok{ scipy.stats.mstats }\ImportTok{import}\NormalTok{ winsorize}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}

\ImportTok{from}\NormalTok{ plotnine }\ImportTok{import} \OperatorTok{*}
\ImportTok{from}\NormalTok{ mizani.formatters }\ImportTok{import}\NormalTok{ percent\_format, comma\_format}
\end{Highlighting}
\end{Shaded}

We connect to our SQLite database containing the processed Vietnamese
financial data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Data Preparation}\label{data-preparation-2}

\subsection{Loading Stock Returns}\label{loading-stock-returns}

We load the monthly stock returns data, which includes excess returns,
market capitalization, and the risk-free rate. These variables are
essential for computing value-weighted portfolio returns and factor
premiums.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess, mktcap, mktcap\_lag, risk\_free}
\StringTok{        FROM prices\_monthly}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{).dropna()}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Monthly returns: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_monthly)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique stocks: }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Monthly returns: 165,499 observations
Unique stocks: 1,457
Date range: 2010-02 to 2023-12
\end{verbatim}

\subsection{Loading Company
Fundamentals}\label{loading-company-fundamentals}

We load the company fundamentals data containing book equity, operating
profitability, and investment---the characteristics needed for
constructing the Fama-French factors.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, datadate, be, op, inv}
\StringTok{        FROM comp\_vn}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"datadate"}\NormalTok{\}}
\NormalTok{).dropna()}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Fundamentals: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(comp\_vn)}\SpecialCharTok{:,\}}\SpecialStringTok{ firm{-}year observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique firms: }\SpecialCharTok{\{}\NormalTok{comp\_vn[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Fundamentals: 18,108 firm-year observations
Unique firms: 1,496
\end{verbatim}

\subsection{Constructing Sorting
Variables}\label{constructing-sorting-variables}

Following Fama-French conventions, we construct the sorting variables
with careful attention to timing. The key principles are:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Size (June Market Cap)}: We use market capitalization at the
  end of June of year \(t\) to sort stocks into size groups. This
  ensures we capture the firm's size at the moment of portfolio
  formation.
\item
  \textbf{Book-to-Market Ratio}: We use book equity from fiscal year
  \(t-1\) divided by market equity at the end of December \(t-1\). This
  creates a six-month gap between the accounting data and portfolio
  formation, ensuring the information was publicly available.
\item
  \textbf{Portfolio Formation Date}: Portfolios are formed on July 1st
  and held for twelve months until the following June.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ construct\_sorting\_variables(prices\_monthly, comp\_vn):}
    \CommentTok{"""}
\CommentTok{    Construct sorting variables following Fama{-}French methodology.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices\_monthly : pd.DataFrame}
\CommentTok{        Monthly stock returns with market cap}
\CommentTok{    comp\_vn : pd.DataFrame}
\CommentTok{        Company fundamentals with book equity, profitability, investment}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Sorting variables aligned with July 1st formation dates}
\CommentTok{    """}
    
    \CommentTok{\# 1. Size: June market capitalization}
    \CommentTok{\# Portfolio formation is July 1st, so we use June market cap}
\NormalTok{    size }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{        .query(}\StringTok{"date.dt.month == 6"}\NormalTok{)}
\NormalTok{        .assign(}
\NormalTok{            sorting\_date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.MonthBegin(}\DecValTok{1}\NormalTok{)}
\NormalTok{        )}
\NormalTok{        [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{]]}
\NormalTok{        .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"mktcap"}\NormalTok{: }\StringTok{"size"}\NormalTok{\})}
\NormalTok{    )}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Size observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(size)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 2. Market Equity: December market cap for B/M calculation}
    \CommentTok{\# December t{-}1 market cap is used with fiscal year t{-}1 book equity}
    \CommentTok{\# This is then used for July t portfolio formation}
\NormalTok{    market\_equity }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{        .query(}\StringTok{"date.dt.month == 12"}\NormalTok{)}
\NormalTok{        .assign(}
            \CommentTok{\# December year t{-}1 maps to July year t formation}
\NormalTok{            sorting\_date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.MonthBegin(}\DecValTok{7}\NormalTok{)}
\NormalTok{        )}
\NormalTok{        [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"mktcap"}\NormalTok{]]}
\NormalTok{        .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{"mktcap"}\NormalTok{: }\StringTok{"me"}\NormalTok{\})}
\NormalTok{    )}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Market equity observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(market\_equity)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 3. Book{-}to{-}Market and other characteristics}
    \CommentTok{\# Fiscal year t{-}1 data is used for July t portfolio formation}
\NormalTok{    book\_to\_market }\OperatorTok{=}\NormalTok{ (comp\_vn}
\NormalTok{        .assign(}
            \CommentTok{\# Fiscal year{-}end + 6 months = July formation}
\NormalTok{            sorting\_date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.to\_datetime(}
\NormalTok{                (x[}\StringTok{"datadate"}\NormalTok{].dt.year }\OperatorTok{+} \DecValTok{1}\NormalTok{).astype(}\BuiltInTok{str}\NormalTok{) }\OperatorTok{+} \StringTok{"{-}07{-}01"}
\NormalTok{            )}
\NormalTok{        )}
\NormalTok{        .merge(market\_equity, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{], how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{        .assign(}
            \CommentTok{\# Scale book equity to match market equity units}
            \CommentTok{\# BE is in VND, ME is in millions VND}
\NormalTok{            bm}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"be"}\NormalTok{] }\OperatorTok{/}\NormalTok{ (x[}\StringTok{"me"}\NormalTok{] }\OperatorTok{*} \FloatTok{1e9}\NormalTok{)}
\NormalTok{        )}
\NormalTok{        [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"me"}\NormalTok{, }\StringTok{"bm"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{]]}
\NormalTok{    )}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Book{-}to{-}market observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(book\_to\_market)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 4. Merge size with characteristics}
\NormalTok{    sorting\_variables }\OperatorTok{=}\NormalTok{ (size}
\NormalTok{        .merge(book\_to\_market, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{], how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{        .dropna()}
\NormalTok{        .drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{])}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ sorting\_variables}

\NormalTok{sorting\_variables }\OperatorTok{=}\NormalTok{ construct\_sorting\_variables(prices\_monthly, comp\_vn)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Final sorting variables: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(sorting\_variables)}\SpecialCharTok{:,\}}\SpecialStringTok{ stock{-}years"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Sorting date range: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}sorting\_date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}sorting\_date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Size observations: 13,756
Market equity observations: 14,286
Book-to-market observations: 13,389

Final sorting variables: 12,046 stock-years
Sorting date range: 2011-07 to 2023-07
\end{verbatim}

\subsection{Validating Sorting
Variables}\label{validating-sorting-variables}

Before proceeding, we validate that our sorting variables have
reasonable distributions. The book-to-market ratio should center around
1.0 for a typical market, though emerging markets may differ.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\StringTok{"Sorting Variable Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(sorting\_variables[[}\StringTok{"size"}\NormalTok{, }\StringTok{"bm"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}

\CommentTok{\# Check for extreme values that might indicate data issues}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{B/M Median: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}bm\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{median()}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"B/M 1st percentile: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}bm\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.01}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"B/M 99th percentile: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}bm\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.99}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sorting Variable Summary Statistics:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.7033      0.1852      0.1322
std     14680.4225      3.8683      0.2782      2.5410
min         0.4864      0.0014     -0.7529     -0.9569
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817    272.1893      1.4256    261.3355

B/M Median: 1.1849
B/M 1st percentile: 0.1710
B/M 99th percentile: 8.0262
\end{verbatim}

\subsection{Handling Outliers}\label{handling-outliers-1}

Extreme values in sorting characteristics can distort portfolio
assignments and factor returns. We apply winsorization to limit the
influence of outliers while preserving the general ranking of stocks.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Check BEFORE winsorization}
\BuiltInTok{print}\NormalTok{(}\StringTok{"BEFORE Winsorization:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(sorting\_variables[[}\StringTok{"size"}\NormalTok{, }\StringTok{"bm"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}

\CommentTok{\# Apply winsorization}
\KeywordTok{def}\NormalTok{ winsorize\_characteristics(df, columns, limits}\OperatorTok{=}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.99}\NormalTok{)):}
    \CommentTok{"""}
\CommentTok{    Apply winsorization using pandas clip.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.copy()}
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ columns:}
        \ControlFlowTok{if}\NormalTok{ col }\KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{            lower }\OperatorTok{=}\NormalTok{ df[col].quantile(limits[}\DecValTok{0}\NormalTok{])}
\NormalTok{            upper }\OperatorTok{=}\NormalTok{ df[col].quantile(limits[}\DecValTok{1}\NormalTok{])}
\NormalTok{            df[col] }\OperatorTok{=}\NormalTok{ df[col].clip(lower}\OperatorTok{=}\NormalTok{lower, upper}\OperatorTok{=}\NormalTok{upper)}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{col}\SpecialCharTok{\}}\SpecialStringTok{: clipped to [}\SpecialCharTok{\{}\NormalTok{lower}\SpecialCharTok{:.4f\}}\SpecialStringTok{, }\SpecialCharTok{\{}\NormalTok{upper}\SpecialCharTok{:.4f\}}\SpecialStringTok{]"}\NormalTok{)}
    \ControlFlowTok{return}\NormalTok{ df}

\NormalTok{sorting\_variables }\OperatorTok{=}\NormalTok{ winsorize\_characteristics(}
\NormalTok{    sorting\_variables,}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{"bm"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{],  }\CommentTok{\# Don\textquotesingle{}t winsorize size}
\NormalTok{    limits}\OperatorTok{=}\NormalTok{(}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.99}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Check AFTER winsorization}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{AFTER Winsorization:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(sorting\_variables[[}\StringTok{"size"}\NormalTok{, }\StringTok{"bm"}\NormalTok{, }\StringTok{"op"}\NormalTok{, }\StringTok{"inv"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
BEFORE Winsorization:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.7033      0.1852      0.1322
std     14680.4225      3.8683      0.2782      2.5410
min         0.4864      0.0014     -0.7529     -0.9569
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817    272.1893      1.4256    261.3355
  bm: clipped to [0.1710, 8.0262]
  op: clipped to [-0.7319, 1.2192]
  inv: clipped to [-0.3990, 1.5195]

AFTER Winsorization:
              size          bm          op         inv
count   12046.0000  12046.0000  12046.0000  12046.0000
mean     2225.5648      1.5544      0.1837      0.0894
std     14680.4225      1.2843      0.2705      0.2721
min         0.4864      0.1710     -0.7319     -0.3990
25%        62.7556      0.7595      0.0309     -0.0495
50%       182.6410      1.1849      0.1367      0.0342
75%       641.8896      1.8853      0.2952      0.1582
max    426020.9817      8.0262      1.2192      1.5195
\end{verbatim}

\section{Portfolio Assignment
Functions}\label{portfolio-assignment-functions}

\subsection{The Portfolio Assignment
Function}\label{the-portfolio-assignment-function}

We create a flexible function for assigning stocks to portfolios based
on quantile breakpoints. This function handles both independent sorts
(where breakpoints are computed across all stocks) and dependent sorts
(where breakpoints are computed within subgroups).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ assign\_portfolio(data, sorting\_variable, percentiles):}
    \CommentTok{"""Assign portfolios to a bin according to a sorting variable."""}
    
    \CommentTok{\# Get the values}
\NormalTok{    values }\OperatorTok{=}\NormalTok{ data[sorting\_variable].dropna()}
    
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(values) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.Series([np.nan] }\OperatorTok{*} \BuiltInTok{len}\NormalTok{(data), index}\OperatorTok{=}\NormalTok{data.index)}
    
    \CommentTok{\# Calculate breakpoints}
\NormalTok{    breakpoints }\OperatorTok{=}\NormalTok{ values.quantile(percentiles, interpolation}\OperatorTok{=}\StringTok{"linear"}\NormalTok{)}
    
    \CommentTok{\# Handle duplicate breakpoints by using unique values}
\NormalTok{    unique\_breakpoints }\OperatorTok{=}\NormalTok{ np.unique(breakpoints)}
    
    \CommentTok{\# If all values are the same, assign all to portfolio 1}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(unique\_breakpoints) }\OperatorTok{\textless{}=} \DecValTok{1}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ pd.Series([}\DecValTok{1}\NormalTok{] }\OperatorTok{*} \BuiltInTok{len}\NormalTok{(data), index}\OperatorTok{=}\NormalTok{data.index)}
    
    \CommentTok{\# Set boundaries to {-}inf and +inf}
\NormalTok{    unique\_breakpoints.iloc[}\DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{{-}}\NormalTok{np.inf}
\NormalTok{    unique\_breakpoints.iloc[unique\_breakpoints.size}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.inf}
    
    \CommentTok{\# Assign to bins}
\NormalTok{    assigned }\OperatorTok{=}\NormalTok{ pd.cut(}
\NormalTok{        data[sorting\_variable],}
\NormalTok{        bins}\OperatorTok{=}\NormalTok{unique\_breakpoints,}
\NormalTok{        labels}\OperatorTok{=}\NormalTok{pd.Series(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, breakpoints.size)),}
\NormalTok{        include\_lowest}\OperatorTok{=}\VariableTok{True}\NormalTok{,}
\NormalTok{        right}\OperatorTok{=}\VariableTok{False}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ assigned}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Check the distribution of characteristics BEFORE portfolio assignment}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Operating Profitability Distribution:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(sorting\_variables[}\StringTok{"op"}\NormalTok{].describe())}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Unique OP values: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}op\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Investment Distribution:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(sorting\_variables[}\StringTok{"inv"}\NormalTok{].describe())}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Unique INV values: }\SpecialCharTok{\{}\NormalTok{sorting\_variables[}\StringTok{\textquotesingle{}inv\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}

\CommentTok{\# Check breakpoints for a specific date}
\NormalTok{test\_date }\OperatorTok{=}\NormalTok{ sorting\_variables[}\StringTok{"sorting\_date"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{test\_data }\OperatorTok{=}\NormalTok{ sorting\_variables.query(}\StringTok{"sorting\_date == @test\_date"}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Breakpoints for }\SpecialCharTok{\{}\NormalTok{test\_date}\SpecialCharTok{\}}\SpecialStringTok{:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"OP 30th percentile: }\SpecialCharTok{\{}\NormalTok{test\_data[}\StringTok{\textquotesingle{}op\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"OP 70th percentile: }\SpecialCharTok{\{}\NormalTok{test\_data[}\StringTok{\textquotesingle{}op\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.7}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"INV 30th percentile: }\SpecialCharTok{\{}\NormalTok{test\_data[}\StringTok{\textquotesingle{}inv\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.3}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"INV 70th percentile: }\SpecialCharTok{\{}\NormalTok{test\_data[}\StringTok{\textquotesingle{}inv\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{quantile(}\FloatTok{0.7}\NormalTok{)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Operating Profitability Distribution:
count    12046.000000
mean         0.183738
std          0.270509
min         -0.731888
25%          0.030913
50%          0.136675
75%          0.295185
max          1.219223
Name: op, dtype: float64

Unique OP values: 11804

Investment Distribution:
count    12046.000000
mean         0.089388
std          0.272147
min         -0.399042
25%         -0.049497
50%          0.034157
75%          0.158155
max          1.519474
Name: inv, dtype: float64

Unique INV values: 11805

Breakpoints for 2019-07-01 00:00:00:
OP 30th percentile: 0.0541
OP 70th percentile: 0.2566
INV 30th percentile: -0.0343
INV 70th percentile: 0.1116
\end{verbatim}

\subsection{Assigning Portfolios for Three-Factor
Model}\label{assigning-portfolios-for-three-factor-model}

For the three-factor model, we perform independent double sorts on size
and book-to-market. Size is split at the median (2 groups), and
book-to-market is split at the 30th and 70th percentiles (3 groups),
creating 6 portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ assign\_ff3\_portfolios(sorting\_variables):}
    \CommentTok{"""}
\CommentTok{    Assign portfolios for Fama{-}French three{-}factor model.}
\CommentTok{    Independent 2x3 sort on size and book{-}to{-}market.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ sorting\_variables.copy()}
    
    \CommentTok{\# Independent size sort (median split)}
\NormalTok{    df[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{"sorting\_date"}\NormalTok{)[}\StringTok{"size"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Independent B/M sort (30/70 split)}
\NormalTok{    df[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{"sorting\_date"}\NormalTok{)[}\StringTok{"bm"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ df}

\CommentTok{\# Assign portfolios}
\NormalTok{portfolios\_ff3 }\OperatorTok{=}\NormalTok{ assign\_ff3\_portfolios(sorting\_variables)}

\CommentTok{\# Validate}
\BuiltInTok{print}\NormalTok{(}\StringTok{"FF3 Book{-}to{-}Market by Portfolio (should be INCREASING):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff3.groupby(}\StringTok{"portfolio\_bm"}\NormalTok{, observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)[}\StringTok{"bm"}\NormalTok{].median().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}


\BuiltInTok{print}\NormalTok{(}\StringTok{"Three{-}Factor Portfolio Assignments:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff3[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{]].head(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
FF3 Book-to-Market by Portfolio (should be INCREASING):
portfolio_bm
1    0.5836
2    1.1891
3    2.4552
Name: bm, dtype: float64
Three-Factor Portfolio Assignments:
  symbol sorting_date portfolio_size portfolio_bm
0    A32   2019-07-01              1            2
1    A32   2020-07-01              1            2
2    A32   2021-07-01              1            2
3    A32   2022-07-01              1            3
4    A32   2023-07-01              1            2
5    AAA   2011-07-01              2            2
6    AAA   2012-07-01              2            3
7    AAA   2013-07-01              2            3
8    AAA   2014-07-01              2            2
9    AAA   2015-07-01              2            3
\end{verbatim}

\subsection{Validating Portfolio
Assignments}\label{validating-portfolio-assignments}

We verify that the portfolio assignments create the expected 23 grid
with reasonable stock counts in each cell.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Check portfolio distribution for most recent year}
\NormalTok{latest\_date }\OperatorTok{=}\NormalTok{ portfolios\_ff3[}\StringTok{"sorting\_date"}\NormalTok{].}\BuiltInTok{max}\NormalTok{()}

\NormalTok{portfolio\_counts }\OperatorTok{=}\NormalTok{ (portfolios\_ff3}
\NormalTok{    .query(}\StringTok{"sorting\_date == @latest\_date"}\NormalTok{)}
\NormalTok{    .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .size()}
\NormalTok{    .unstack(fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Portfolio Counts for }\SpecialCharTok{\{}\NormalTok{latest\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\SpecialCharTok{\}}\SpecialStringTok{:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolio\_counts)}

\CommentTok{\# Verify characteristic monotonicity}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Book{-}to{-}Market by Portfolio (should be increasing):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff3.groupby(}\StringTok{"portfolio\_bm"}\NormalTok{, observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)[}\StringTok{"bm"}\NormalTok{].median().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolio Counts for 2023-07:
portfolio_bm      1    2    3
portfolio_size               
1               113  271  263
2               275  246  125

Book-to-Market by Portfolio (should be increasing):
portfolio_bm
1    0.5836
2    1.1891
3    2.4552
Name: bm, dtype: float64
\end{verbatim}

We verify that for a single stock, the portfolio assignment remains
constant between July of one year and June of the next.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Trace a single symbol (e.g., \textquotesingle{}A32\textquotesingle{}) across a formation window}
\NormalTok{persistence\_check }\OperatorTok{=}\NormalTok{ (portfolios\_ff3}
\NormalTok{    .query(}\StringTok{"symbol == \textquotesingle{}A32\textquotesingle{} \& sorting\_date \textgreater{}= \textquotesingle{}2022{-}01{-}01\textquotesingle{} \& sorting\_date \textless{}= \textquotesingle{}2023{-}12{-}31\textquotesingle{}"}\NormalTok{)}
\NormalTok{    .sort\_values(}\StringTok{"sorting\_date"}\NormalTok{)}
\NormalTok{    [[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sorting\_date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}portfolio\_size\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}portfolio\_bm\textquotesingle{}}\NormalTok{]]}
\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Temporal Persistence Check (Symbol A32):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(persistence\_check.head(}\DecValTok{15}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

Temporal Persistence Check (Symbol A32):
  symbol sorting_date portfolio_size portfolio_bm
3    A32   2022-07-01              1            3
4    A32   2023-07-01              1            2
\end{verbatim}

\section{Fama-French Three-Factor Model
(Monthly)}\label{fama-french-three-factor-model-monthly}

\subsection{Merging Portfolios with
Returns}\label{merging-portfolios-with-returns}

We merge the portfolio assignments with monthly returns. The key insight
is that portfolios formed in July of year \(t\) are held through June of
year \(t+1\). We implement this by computing a \texttt{sorting\_date}
for each monthly return observation.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ merge\_portfolios\_with\_returns(prices\_monthly, portfolio\_assignments):}
    \CommentTok{"""}
\CommentTok{    Merge portfolio assignments with monthly returns.}
\CommentTok{    }
\CommentTok{    Portfolios formed in July t are held through June t+1.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices\_monthly : pd.DataFrame}
\CommentTok{        Monthly stock returns}
\CommentTok{    portfolio\_assignments : pd.DataFrame}
\CommentTok{        Portfolio assignments with sorting\_date}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Returns merged with portfolio assignments}
\CommentTok{    """}
\NormalTok{    portfolios }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{        .assign(}
            \CommentTok{\# Map each return month to its portfolio formation date}
\NormalTok{            sorting\_date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.to\_datetime(}
\NormalTok{                np.where(}
\NormalTok{                    x[}\StringTok{"date"}\NormalTok{].dt.month }\OperatorTok{\textless{}=} \DecValTok{6}\NormalTok{,}
\NormalTok{                    (x[}\StringTok{"date"}\NormalTok{].dt.year }\OperatorTok{{-}} \DecValTok{1}\NormalTok{).astype(}\BuiltInTok{str}\NormalTok{) }\OperatorTok{+} \StringTok{"{-}07{-}01"}\NormalTok{,}
\NormalTok{                    x[}\StringTok{"date"}\NormalTok{].dt.year.astype(}\BuiltInTok{str}\NormalTok{) }\OperatorTok{+} \StringTok{"{-}07{-}01"}
\NormalTok{                )}
\NormalTok{            )}
\NormalTok{        )}
\NormalTok{        .merge(}
\NormalTok{            portfolio\_assignments,}
\NormalTok{            on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{],}
\NormalTok{            how}\OperatorTok{=}\StringTok{"inner"}
\NormalTok{        )}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ portfolios}

\NormalTok{portfolios\_monthly\_ff3 }\OperatorTok{=}\NormalTok{ merge\_portfolios\_with\_returns(}
\NormalTok{    prices\_monthly,}
\NormalTok{    portfolios\_ff3[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{]]}
\NormalTok{)}


\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Merged observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_monthly\_ff3)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Merged observations: 136,444
\end{verbatim}

\subsection{Computing Value-Weighted Portfolio
Returns}\label{computing-value-weighted-portfolio-returns}

We compute value-weighted returns for each of the six portfolios.
Value-weighting uses lagged market capitalization to avoid look-ahead
bias.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_portfolio\_returns(data, grouping\_vars):}
    \CommentTok{"""}
\CommentTok{    Compute value{-}weighted portfolio returns.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data : pd.DataFrame}
\CommentTok{        Returns data with portfolio assignments and mktcap\_lag}
\CommentTok{    grouping\_vars : list}
\CommentTok{        Variables defining portfolio groups}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Value{-}weighted returns for each portfolio{-}date}
\CommentTok{    """}
\NormalTok{    portfolio\_returns }\OperatorTok{=}\NormalTok{ (data}
\NormalTok{        .groupby(grouping\_vars }\OperatorTok{+}\NormalTok{ [}\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{]),}
            \StringTok{"n\_stocks"}\NormalTok{: }\BuiltInTok{len}\NormalTok{(x)}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ portfolio\_returns}


\CommentTok{\# Compute portfolio returns}
\NormalTok{portfolio\_returns\_ff3 }\OperatorTok{=}\NormalTok{ compute\_portfolio\_returns(}
\NormalTok{    portfolios\_monthly\_ff3,}
\NormalTok{    [}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{]}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Portfolio Returns Summary:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolio\_returns\_ff3.groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)[}\StringTok{"ret"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolio Returns Summary:
                             count    mean     std     min     25%     50%  \
portfolio_size portfolio_bm                                                  
1              1             150.0 -0.0052  0.0379 -0.1268 -0.0262 -0.0058   
               2             150.0 -0.0025  0.0414 -0.1080 -0.0236 -0.0053   
               3             150.0  0.0039  0.0601 -0.1612 -0.0269 -0.0004   
2              1             150.0 -0.0124  0.0594 -0.2222 -0.0449 -0.0107   
               2             150.0 -0.0021  0.0671 -0.1701 -0.0403 -0.0046   
               3             150.0  0.0024  0.0879 -0.2359 -0.0527 -0.0012   

                                75%     max  
portfolio_size portfolio_bm                  
1              1             0.0161  0.0849  
               2             0.0180  0.1195  
               3             0.0314  0.2015  
2              1             0.0210  0.1741  
               2             0.0317  0.1770  
               3             0.0437  0.2124  
\end{verbatim}

\subsection{Constructing SMB and HML
Factors}\label{constructing-smb-and-hml-factors}

We now construct the SMB and HML factors from the portfolio returns.

\textbf{SMB (Small Minus Big)}: Average return of three small portfolios
minus average return of three big portfolios.

\textbf{HML (High Minus Low)}: Average return of two high B/M portfolios
minus average return of two low B/M portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ construct\_ff3\_factors(portfolio\_returns):}
    \CommentTok{"""}
\CommentTok{    Construct Fama{-}French three factors from portfolio returns.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    portfolio\_returns : pd.DataFrame}
\CommentTok{        Value{-}weighted returns for 2x3 portfolios}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Monthly SMB and HML factors}
\CommentTok{    """}
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ (portfolio\_returns}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \CommentTok{\# SMB: Small minus Big (average across B/M groups)}
            \StringTok{"smb"}\NormalTok{: (}
\NormalTok{                x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{2}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean()}
\NormalTok{            ),}
            \CommentTok{\# HML: High minus Low B/M (average across size groups)}
            \StringTok{"hml"}\NormalTok{: (}
\NormalTok{                x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean()}
\NormalTok{            )}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ factors}

\NormalTok{factors\_smb\_hml }\OperatorTok{=}\NormalTok{ construct\_ff3\_factors(portfolio\_returns\_ff3)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"SMB and HML Factors:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_smb\_hml.head(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SMB and HML Factors:
        date       smb       hml
0 2011-07-31 -0.007768  0.002754
1 2011-08-31 -0.067309  0.011474
2 2011-09-30  0.014884  0.022854
3 2011-10-31 -0.003743  0.001631
4 2011-11-30  0.063234  0.009103
5 2011-12-31  0.014571  0.015280
6 2012-01-31 -0.026080  0.009672
7 2012-02-29 -0.035721  0.005474
8 2012-03-31 -0.002344  0.032477
9 2012-04-30 -0.033391  0.074191
\end{verbatim}

\subsection{Computing the Market
Factor}\label{computing-the-market-factor}

The market factor is the value-weighted return of all stocks minus the
risk-free rate. We compute this independently from the sorted
portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_market\_factor(prices\_monthly):}
    \CommentTok{"""}
\CommentTok{    Compute value{-}weighted market excess return.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices\_monthly : pd.DataFrame}
\CommentTok{        Monthly stock returns with mktcap\_lag}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Monthly market excess return}
\CommentTok{    """}
\NormalTok{    market\_factor }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"mkt\_excess"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{]),}
            \StringTok{"n\_stocks"}\NormalTok{: }\BuiltInTok{len}\NormalTok{(x)}
\NormalTok{        \}), include\_groups}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ market\_factor}

\NormalTok{market\_factor }\OperatorTok{=}\NormalTok{ compute\_market\_factor(prices\_monthly)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Market Factor Summary:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(market\_factor[}\StringTok{"mkt\_excess"}\NormalTok{].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Market Factor Summary:
count    167.0000
mean      -0.0123
std        0.0595
min       -0.2149
25%       -0.0394
50%       -0.0106
75%        0.0200
max        0.1677
Name: mkt_excess, dtype: float64
\end{verbatim}

\subsection{Combining Three Factors}\label{combining-three-factors}

We combine SMB, HML, and the market factor into the complete
three-factor dataset.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ff3\_monthly }\OperatorTok{=}\NormalTok{ (factors\_smb\_hml}
\NormalTok{    .merge(market\_factor[[}\StringTok{"date"}\NormalTok{, }\StringTok{"mkt\_excess"}\NormalTok{]], on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Add risk{-}free rate for completeness}
\NormalTok{rf\_monthly }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    .groupby(}\StringTok{"date"}\NormalTok{)[}\StringTok{"risk\_free"}\NormalTok{]}
\NormalTok{    .first()}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\NormalTok{factors\_ff3\_monthly }\OperatorTok{=}\NormalTok{ factors\_ff3\_monthly.merge(rf\_monthly, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Fama{-}French Three Factors (Monthly):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff3\_monthly.head(}\DecValTok{10}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Factor Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff3\_monthly[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Fama-French Three Factors (Monthly):
        date       smb       hml  mkt_excess  risk_free
0 2011-07-31 -0.007768  0.002754   -0.078748   0.003333
1 2011-08-31 -0.067309  0.011474    0.029906   0.003333
2 2011-09-30  0.014884  0.022854   -0.002173   0.003333
3 2011-10-31 -0.003743  0.001631   -0.014005   0.003333
4 2011-11-30  0.063234  0.009103   -0.179410   0.003333
5 2011-12-31  0.014571  0.015280   -0.094802   0.003333
6 2012-01-31 -0.026080  0.009672    0.081273   0.003333
7 2012-02-29 -0.035721  0.005474    0.069655   0.003333
8 2012-03-31 -0.002344  0.032477    0.029005   0.003333
9 2012-04-30 -0.033391  0.074191    0.048791   0.003333

Factor Summary Statistics:
       mkt_excess       smb       hml
count    150.0000  150.0000  150.0000
mean      -0.0101    0.0027    0.0120
std        0.0586    0.0420    0.0535
min       -0.2149   -0.1599   -0.1284
25%       -0.0380   -0.0175   -0.0160
50%       -0.0095    0.0070    0.0043
75%        0.0214    0.0261    0.0340
max        0.1677    0.1175    0.1618
\end{verbatim}

\subsection{Saving Three-Factor Data}\label{saving-three-factor-data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ff3\_monthly.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"factors\_ff3\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Three{-}factor monthly data saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Three-factor monthly data saved to database.
\end{verbatim}

\section{Fama-French Five-Factor Model
(Monthly)}\label{fama-french-five-factor-model-monthly}

\subsection{Portfolio Assignments with Dependent
Sorts}\label{portfolio-assignments-with-dependent-sorts}

For the five-factor model, we use dependent sorts: size is sorted
independently, but profitability and investment are sorted within size
groups. This controls for the correlation between size and these
characteristics.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ assign\_ff5\_portfolios(sorting\_variables):}
    \CommentTok{"""}
\CommentTok{    Assign portfolios for Fama{-}French five{-}factor model.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ sorting\_variables.copy()}
    
    \CommentTok{\# Independent size sort}
\NormalTok{    df[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{"sorting\_date"}\NormalTok{)[}\StringTok{"size"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.5}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Dependent sorts within size groups}
\NormalTok{    df[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby([}\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{])[}\StringTok{"bm"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
\NormalTok{    df[}\StringTok{"portfolio\_op"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby([}\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{])[}\StringTok{"op"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
\NormalTok{    df[}\StringTok{"portfolio\_inv"}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby([}\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{])[}\StringTok{"inv"}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, q}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{, }\FloatTok{0.7}\NormalTok{, }\DecValTok{1}\NormalTok{], labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ df}

\CommentTok{\# Run}
\NormalTok{portfolios\_ff5 }\OperatorTok{=}\NormalTok{ assign\_ff5\_portfolios(sorting\_variables)}
\end{Highlighting}
\end{Shaded}

\subsection{Validating Five-Factor
Portfolios}\label{validating-five-factor-portfolios}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Check characteristic monotonicity for each dimension}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Profitability by Portfolio (should be increasing):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff5.groupby(}\StringTok{"portfolio\_op"}\NormalTok{, observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)[}\StringTok{"op"}\NormalTok{].median().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Investment by Portfolio (should be increasing):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff5.groupby(}\StringTok{"portfolio\_inv"}\NormalTok{, observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)[}\StringTok{"inv"}\NormalTok{].median().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}

\CommentTok{\# Check portfolio counts}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Stocks per Size/Profitability Bin:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff5.groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_op"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{).size().unstack(fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{))}

\CommentTok{\# Check number of unique firms per year}
\NormalTok{(portfolios\_ff5}
\NormalTok{ .groupby(}\StringTok{"sorting\_date"}\NormalTok{)[}\StringTok{"symbol"}\NormalTok{]}
\NormalTok{ .nunique())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Profitability by Portfolio (should be increasing):
portfolio_op
1   -0.0053
2    0.1366
3    0.4098
Name: op, dtype: float64

Investment by Portfolio (should be increasing):
portfolio_inv
1   -0.1012
2    0.0329
3    0.2568
Name: inv, dtype: float64

Stocks per Size/Profitability Bin:
portfolio_op       1     2     3
portfolio_size                  
1               1812  2403  1811
2               1811  2401  1808
\end{verbatim}

\begin{verbatim}
sorting_date
2011-07-01     556
2012-07-01     632
2013-07-01     643
2014-07-01     650
2015-07-01     669
2016-07-01     737
2017-07-01     842
2018-07-01    1073
2019-07-01    1183
2020-07-01    1224
2021-07-01    1258
2022-07-01    1286
2023-07-01    1293
Name: symbol, dtype: int64
\end{verbatim}

\subsection{Merging and Computing Portfolio
Returns}\label{merging-and-computing-portfolio-returns}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Merge with returns}
\NormalTok{portfolios\_monthly\_ff5 }\OperatorTok{=}\NormalTok{ merge\_portfolios\_with\_returns(}
\NormalTok{    prices\_monthly,}
\NormalTok{    portfolios\_ff5[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{, }
                    \StringTok{"portfolio\_bm"}\NormalTok{, }\StringTok{"portfolio\_op"}\NormalTok{, }\StringTok{"portfolio\_inv"}\NormalTok{]]}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Five{-}factor merged observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_monthly\_ff5)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Five-factor merged observations: 136,444
\end{verbatim}

\subsection{Constructing All Five
Factors}\label{constructing-all-five-factors}

We construct each factor from the appropriate portfolio sorts.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ construct\_ff5\_factors(portfolios\_monthly):}
    \CommentTok{"""}
\CommentTok{    Construct Fama{-}French five factors from portfolio data.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    portfolios\_monthly : pd.DataFrame}
\CommentTok{        Monthly returns with all portfolio assignments}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Monthly five{-}factor returns}
\CommentTok{    """}
    
    \CommentTok{\# HML: Value factor from B/M sorts}
\NormalTok{    portfolios\_bm }\OperatorTok{=}\NormalTok{ (portfolios\_monthly}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_hml }\OperatorTok{=}\NormalTok{ (portfolios\_bm}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"hml"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# RMW: Profitability factor from OP sorts}
\NormalTok{    portfolios\_op }\OperatorTok{=}\NormalTok{ (portfolios\_monthly}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_op"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_rmw }\OperatorTok{=}\NormalTok{ (portfolios\_op}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"rmw"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_op"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_op"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# CMA: Investment factor from INV sorts}
    \CommentTok{\# Note: CMA is Conservative minus Aggressive (low inv {-} high inv)}
\NormalTok{    portfolios\_inv }\OperatorTok{=}\NormalTok{ (portfolios\_monthly}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_inv"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_cma }\OperatorTok{=}\NormalTok{ (portfolios\_inv}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"cma"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_inv"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_inv"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# SMB: Size factor (average across all characteristic portfolios)}
\NormalTok{    all\_portfolios }\OperatorTok{=}\NormalTok{ pd.concat([portfolios\_bm, portfolios\_op, portfolios\_inv])}
    
\NormalTok{    factors\_smb }\OperatorTok{=}\NormalTok{ (all\_portfolios}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"smb"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{2}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# Combine all factors}
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ (factors\_smb}
\NormalTok{        .merge(factors\_hml, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{        .merge(factors\_rmw, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{        .merge(factors\_cma, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ factors}

\NormalTok{factors\_ff5 }\OperatorTok{=}\NormalTok{ construct\_ff5\_factors(portfolios\_monthly\_ff5)}

\CommentTok{\# Add market factor}
\NormalTok{factors\_ff5\_monthly }\OperatorTok{=}\NormalTok{ (factors\_ff5}
\NormalTok{    .merge(market\_factor[[}\StringTok{"date"}\NormalTok{, }\StringTok{"mkt\_excess"}\NormalTok{]], on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{    .merge(rf\_monthly, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Fama{-}French Five Factors (Monthly):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff5\_monthly.head(}\DecValTok{10}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Factor Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff5\_monthly[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Fama-French Five Factors (Monthly):
        date       smb       hml       rmw       cma  mkt_excess  risk_free
0 2011-07-31 -0.015907 -0.002812  0.060525  0.045291   -0.078748   0.003333
1 2011-08-31 -0.061842  0.006189 -0.022700 -0.023177    0.029906   0.003333
2 2011-09-30  0.014387  0.024301 -0.006005  0.003588   -0.002173   0.003333
3 2011-10-31 -0.006958 -0.006940  0.026694  0.003649   -0.014005   0.003333
4 2011-11-30  0.074369  0.015617 -0.058766  0.044214   -0.179410   0.003333
5 2011-12-31  0.006687  0.022494  0.062655  0.052444   -0.094802   0.003333
6 2012-01-31 -0.016254  0.010513 -0.042191 -0.067170    0.081273   0.003333
7 2012-02-29 -0.026606  0.024465 -0.030849 -0.036383    0.069655   0.003333
8 2012-03-31  0.005096  0.050930 -0.018441  0.043488    0.029005   0.003333
9 2012-04-30  0.000712  0.058214 -0.061434  0.009233    0.048791   0.003333

Factor Summary Statistics:
       mkt_excess       smb       hml       rmw       cma
count    150.0000  150.0000  150.0000  150.0000  150.0000
mean      -0.0101    0.0077    0.0115   -0.0047    0.0083
std        0.0586    0.0419    0.0518    0.0477    0.0335
min       -0.2149   -0.1522   -0.1283   -0.2126   -0.0814
25%       -0.0380   -0.0137   -0.0126   -0.0308   -0.0131
50%       -0.0095    0.0104    0.0046    0.0010    0.0067
75%        0.0214    0.0316    0.0323    0.0178    0.0289
max        0.1677    0.1284    0.1510    0.1297    0.1331
\end{verbatim}

\subsection{Factor Correlations}\label{factor-correlations}

We examine correlations between factors, which should generally be low
for the factors to capture distinct sources of risk.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\StringTok{"Factor Correlation Matrix:"}\NormalTok{)}
\NormalTok{correlation\_matrix }\OperatorTok{=}\NormalTok{ factors\_ff5\_monthly[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]].corr()}
\BuiltInTok{print}\NormalTok{(correlation\_matrix.}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Factor Correlation Matrix:
            mkt_excess    smb    hml    rmw    cma
mkt_excess       1.000 -0.712  0.230 -0.006 -0.104
smb             -0.712  1.000  0.256 -0.373  0.246
hml              0.230  0.256  1.000 -0.694  0.479
rmw             -0.006 -0.373 -0.694  1.000 -0.352
cma             -0.104  0.246  0.479 -0.352  1.000
\end{verbatim}

\subsection{Saving Five-Factor Data}\label{saving-five-factor-data}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ff5\_monthly.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"factors\_ff5\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Five{-}factor monthly data saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Five-factor monthly data saved to database.
\end{verbatim}

\section{Daily Fama-French Factors}\label{daily-fama-french-factors}

\subsection{Motivation for Daily
Factors}\label{motivation-for-daily-factors}

Daily factors are essential for several applications:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Daily beta estimation}: CAPM regressions using daily data
  require daily market excess returns.
\item
  \textbf{Event studies}: Measuring abnormal returns around corporate
  events requires daily factor adjustments.
\item
  \textbf{High-frequency research}: Market microstructure studies need
  daily or intraday factor data.
\end{enumerate}

The construction methodology mirrors the monthly approach, but we
compute portfolio returns at daily frequency while maintaining the same
annual portfolio formation dates.

\subsection{Loading Daily Returns}\label{loading-daily-returns}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load daily price data}
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess}
\StringTok{        FROM prices\_daily}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily returns: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\OperatorTok{{-}\%}\NormalTok{d}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\OperatorTok{{-}\%}\NormalTok{d}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily returns: 3,462,157 observations
Date range: 2010-01-05 to 2023-12-29
\end{verbatim}

\subsection{Adding Market Cap for Daily
Weighting}\label{adding-market-cap-for-daily-weighting}

For value-weighted daily returns, we need market capitalization. We use
the most recent monthly market cap as the weight for daily returns
within that month.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Get monthly market cap to use as weights for daily returns}
\NormalTok{mktcap\_monthly }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{    [[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{]]}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{)}

\CommentTok{\# Add year\_month to daily data for merging}
\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ (prices\_daily}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{    .merge(}
\NormalTok{        mktcap\_monthly[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year\_month"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{]],}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"year\_month"}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{"left"}
\NormalTok{    )}
\NormalTok{    .dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess"}\NormalTok{, }\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily returns with weights: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily returns with weights: 3,443,815 observations
\end{verbatim}

\subsection{Merging Daily Returns with
Portfolios}\label{merging-daily-returns-with-portfolios}

We use the same portfolio assignments (formed annually in July) for
daily returns.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Step 1: Ensure portfolios\_ff3 has correct format}
\NormalTok{portfolios\_ff3\_clean }\OperatorTok{=}\NormalTok{ portfolios\_ff3[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{]].copy()}
\NormalTok{portfolios\_ff3\_clean[}\StringTok{"sorting\_date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(portfolios\_ff3\_clean[}\StringTok{"sorting\_date"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Portfolio sorting dates:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_ff3\_clean[}\StringTok{"sorting\_date"}\NormalTok{].unique()[:}\DecValTok{5}\NormalTok{])}

\CommentTok{\# Step 2: Create sorting\_date for daily data}
\NormalTok{prices\_daily\_with\_sort }\OperatorTok{=}\NormalTok{ prices\_daily.copy()}
\NormalTok{prices\_daily\_with\_sort[}\StringTok{"sorting\_date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices\_daily\_with\_sort[}\StringTok{"date"}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}
    \KeywordTok{lambda}\NormalTok{ x: pd.Timestamp(}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{.}\NormalTok{year}\SpecialCharTok{\}}\SpecialStringTok{{-}07{-}01"}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ x.month }\OperatorTok{\textgreater{}} \DecValTok{6} \ControlFlowTok{else}\NormalTok{ pd.Timestamp(}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{.}\NormalTok{year }\OperatorTok{{-}} \DecValTok{1}\SpecialCharTok{\}}\SpecialStringTok{{-}07{-}01"}\NormalTok{)}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Daily sorting dates:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_daily\_with\_sort[}\StringTok{"sorting\_date"}\NormalTok{].unique()[:}\DecValTok{5}\NormalTok{])}

\CommentTok{\# Step 3: Merge}
\NormalTok{portfolios\_daily\_ff3 }\OperatorTok{=}\NormalTok{ prices\_daily\_with\_sort.merge(}
\NormalTok{    portfolios\_ff3\_clean,}
\NormalTok{    on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{],}
\NormalTok{    how}\OperatorTok{=}\StringTok{"inner"}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Merged daily observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_daily\_ff3)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique dates: }\SpecialCharTok{\{}\NormalTok{portfolios\_daily\_ff3[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}

\CommentTok{\# Step 4: Verify portfolio distribution}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Portfolio distribution in daily data:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_daily\_ff3.groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{).size().unstack(fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolio sorting dates:
<DatetimeArray>
['2019-07-01 00:00:00', '2020-07-01 00:00:00', '2021-07-01 00:00:00',
 '2022-07-01 00:00:00', '2023-07-01 00:00:00']
Length: 5, dtype: datetime64[us]

Daily sorting dates:
<DatetimeArray>
['2018-07-01 00:00:00', '2019-07-01 00:00:00', '2020-07-01 00:00:00',
 '2021-07-01 00:00:00', '2022-07-01 00:00:00']
Length: 5, dtype: datetime64[us]

Merged daily observations: 2,843,570
Unique dates: 3,126

Portfolio distribution in daily data:
portfolio_bm         1       2       3
portfolio_size                        
1               218040  585561  617327
2               636152  552114  234376
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Diagnostic: Check the daily portfolio merge}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"DIAGNOSTIC: Daily Portfolio Merge"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Daily prices rows: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily FF3 portfolios rows: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_daily\_ff3)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Match rate: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_daily\_ff3)}\OperatorTok{/}\BuiltInTok{len}\NormalTok{(prices\_daily)}\OperatorTok{*}\DecValTok{100}\SpecialCharTok{:.1f\}}\SpecialStringTok{\%"}\NormalTok{)}

\CommentTok{\# Check portfolio distribution in daily data}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Daily portfolio distribution:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_daily\_ff3.groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{).size().unstack(fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{))}

\CommentTok{\# Check a specific date}
\NormalTok{test\_date }\OperatorTok{=}\NormalTok{ portfolios\_daily\_ff3[}\StringTok{"date"}\NormalTok{].iloc[}\DecValTok{1000}\NormalTok{]}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Sample date: }\SpecialCharTok{\{}\NormalTok{test\_date}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(portfolios\_daily\_ff3.query(}\StringTok{"date == @test\_date"}\NormalTok{).groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{).size().unstack(fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
==================================================
DIAGNOSTIC: Daily Portfolio Merge
==================================================

Daily prices rows: 3,443,815
Daily FF3 portfolios rows: 2,843,570
Match rate: 82.6%

Daily portfolio distribution:
portfolio_bm         1       2       3
portfolio_size                        
1               218040  585561  617327
2               636152  552114  234376

Sample date: 2023-06-28 00:00:00
portfolio_bm      1    2    3
portfolio_size               
1                93  232  312
2               291  280   67
\end{verbatim}

\subsection{Computing Daily Three
Factors}\label{computing-daily-three-factors}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_daily\_ff3\_factors(portfolios\_daily):}
    \CommentTok{"""}
\CommentTok{    Compute daily Fama{-}French three factors.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    portfolios\_daily : pd.DataFrame}
\CommentTok{        Daily returns with portfolio assignments}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Daily SMB and HML factors}
\CommentTok{    """}
    \CommentTok{\# Compute daily portfolio returns}
\NormalTok{    portfolio\_returns }\OperatorTok{=}\NormalTok{ (portfolios\_daily}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# Compute factors}
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ (portfolio\_returns}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"smb"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{2}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean()),}
            \StringTok{"hml"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ factors}

\NormalTok{factors\_daily\_smb\_hml }\OperatorTok{=}\NormalTok{ compute\_daily\_ff3\_factors(portfolios\_daily\_ff3)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily factor observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(factors\_daily\_smb\_hml)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_daily\_smb\_hml.head(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily factor observations: 3,126
        date       smb       hml
0 2011-07-01  0.008587  0.000967
1 2011-07-04  0.005099 -0.001099
2 2011-07-05 -0.009088  0.010152
3 2011-07-06  0.004875 -0.003918
4 2011-07-07 -0.011239 -0.000584
5 2011-07-08  0.005636 -0.008003
6 2011-07-11  0.003940  0.006172
7 2011-07-12  0.003205  0.006543
8 2011-07-13 -0.000097 -0.001134
9 2011-07-14 -0.001248  0.001669
\end{verbatim}

\subsection{Computing Daily Market
Factor}\label{computing-daily-market-factor}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_daily\_market\_factor(prices\_daily):}
    \CommentTok{"""}
\CommentTok{    Compute daily value{-}weighted market excess return.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices\_daily : pd.DataFrame}
\CommentTok{        Daily returns with mktcap\_lag}
\CommentTok{        }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Daily market excess return}
\CommentTok{    """}
\NormalTok{    market\_daily }\OperatorTok{=}\NormalTok{ (prices\_daily}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"mkt\_excess"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ market\_daily}

\NormalTok{market\_factor\_daily }\OperatorTok{=}\NormalTok{ compute\_daily\_market\_factor(prices\_daily)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Daily market factor: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(market\_factor\_daily)}\SpecialCharTok{:,\}}\SpecialStringTok{ days"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily market factor: 3,474 days
\end{verbatim}

\subsection{Combining Daily Three
Factors}\label{combining-daily-three-factors}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ff3\_daily }\OperatorTok{=}\NormalTok{ (factors\_daily\_smb\_hml}
\NormalTok{    .merge(market\_factor\_daily, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{)}

\CommentTok{\# Add risk{-}free rate (use monthly rate / 21 as daily approximation, or load actual daily rate)}
\NormalTok{factors\_ff3\_daily[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=} \FloatTok{0.04} \OperatorTok{/} \DecValTok{252}  \CommentTok{\# Approximate daily risk{-}free}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily Fama{-}French Three Factors:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff3\_daily.head(}\DecValTok{10}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Daily Factor Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff3\_daily[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{6}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily Fama-French Three Factors:
        date       smb       hml  mkt_excess  risk_free
0 2011-07-01  0.008587  0.000967   -0.019862   0.000159
1 2011-07-04  0.005099 -0.001099   -0.000633   0.000159
2 2011-07-05 -0.009088  0.010152    0.013314   0.000159
3 2011-07-06  0.004875 -0.003918   -0.008045   0.000159
4 2011-07-07 -0.011239 -0.000584    0.003391   0.000159
5 2011-07-08  0.005636 -0.008003    0.000218   0.000159
6 2011-07-11  0.003940  0.006172   -0.013393   0.000159
7 2011-07-12  0.003205  0.006543   -0.017505   0.000159
8 2011-07-13 -0.000097 -0.001134    0.000767   0.000159
9 2011-07-14 -0.001248  0.001669   -0.000695   0.000159

Daily Factor Summary Statistics:
        mkt_excess          smb          hml
count  3126.000000  3126.000000  3126.000000
mean     -0.000479     0.000236     0.000594
std       0.011269     0.008488     0.008585
min      -0.070268    -0.032671    -0.039418
25%      -0.005074    -0.004882    -0.003941
50%       0.000350    -0.000106     0.000522
75%       0.005531     0.004307     0.005233
max       0.043386     0.042686     0.083889
\end{verbatim}

\subsection{Computing Daily Five
Factors}\label{computing-daily-five-factors}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Step 1: Clean portfolios}
\NormalTok{portfolios\_ff5\_clean }\OperatorTok{=}\NormalTok{ portfolios\_ff5[[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{, }\StringTok{"portfolio\_size"}\NormalTok{, }
                                        \StringTok{"portfolio\_bm"}\NormalTok{, }\StringTok{"portfolio\_op"}\NormalTok{, }\StringTok{"portfolio\_inv"}\NormalTok{]].copy()}
\NormalTok{portfolios\_ff5\_clean[}\StringTok{"sorting\_date"}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(portfolios\_ff5\_clean[}\StringTok{"sorting\_date"}\NormalTok{])}

\CommentTok{\# Step 2: Merge with daily prices}
\NormalTok{portfolios\_daily\_ff5 }\OperatorTok{=}\NormalTok{ prices\_daily\_with\_sort.merge(}
\NormalTok{    portfolios\_ff5\_clean,}
\NormalTok{    on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{],}
\NormalTok{    how}\OperatorTok{=}\StringTok{"inner"}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"FF5 Daily merged observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(portfolios\_daily\_ff5)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
FF5 Daily merged observations: 2,843,570
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_daily\_ff5\_factors(portfolios\_daily):}
    \CommentTok{"""Compute daily Fama{-}French five factors."""}
    
    \CommentTok{\# HML from B/M sorts}
\NormalTok{    portfolios\_bm }\OperatorTok{=}\NormalTok{ (portfolios\_daily}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_bm"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_hml }\OperatorTok{=}\NormalTok{ (portfolios\_bm}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"hml"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_bm"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# RMW from OP sorts}
\NormalTok{    portfolios\_op }\OperatorTok{=}\NormalTok{ (portfolios\_daily}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_op"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_rmw }\OperatorTok{=}\NormalTok{ (portfolios\_op}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"rmw"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_op"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_op"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# CMA from INV sorts (note: low minus high)}
\NormalTok{    portfolios\_inv }\OperatorTok{=}\NormalTok{ (portfolios\_daily}
\NormalTok{        .groupby([}\StringTok{"portfolio\_size"}\NormalTok{, }\StringTok{"portfolio\_inv"}\NormalTok{, }\StringTok{"date"}\NormalTok{], observed}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"ret"}\NormalTok{: np.average(x[}\StringTok{"ret\_excess"}\NormalTok{], weights}\OperatorTok{=}\NormalTok{x[}\StringTok{"mktcap\_lag"}\NormalTok{])}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
\NormalTok{    factors\_cma }\OperatorTok{=}\NormalTok{ (portfolios\_inv}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"cma"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_inv"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_inv"}\NormalTok{] }\OperatorTok{==} \DecValTok{3}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# SMB from all sorts}
\NormalTok{    all\_portfolios }\OperatorTok{=}\NormalTok{ pd.concat([portfolios\_bm, portfolios\_op, portfolios\_inv])}
    
\NormalTok{    factors\_smb }\OperatorTok{=}\NormalTok{ (all\_portfolios}
\NormalTok{        .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{        .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: pd.Series(\{}
            \StringTok{"smb"}\NormalTok{: (x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean() }\OperatorTok{{-}}
\NormalTok{                   x.loc[x[}\StringTok{"portfolio\_size"}\NormalTok{] }\OperatorTok{==} \DecValTok{2}\NormalTok{, }\StringTok{"ret"}\NormalTok{].mean())}
\NormalTok{        \}))}
\NormalTok{        .reset\_index()}
\NormalTok{    )}
    
    \CommentTok{\# Combine}
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ (factors\_smb}
\NormalTok{        .merge(factors\_hml, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{        .merge(factors\_rmw, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{        .merge(factors\_cma, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"outer"}\NormalTok{)}
\NormalTok{    )}
    
    \ControlFlowTok{return}\NormalTok{ factors}

\CommentTok{\# Compute daily FF5 factors}
\NormalTok{factors\_daily\_ff5 }\OperatorTok{=}\NormalTok{ compute\_daily\_ff5\_factors(portfolios\_daily\_ff5)}

\CommentTok{\# Add market factor}
\NormalTok{factors\_ff5\_daily }\OperatorTok{=}\NormalTok{ (factors\_daily\_ff5}
\NormalTok{    .merge(market\_factor\_daily, on}\OperatorTok{=}\StringTok{"date"}\NormalTok{, how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}
\NormalTok{)}
\NormalTok{factors\_ff5\_daily[}\StringTok{"risk\_free"}\NormalTok{] }\OperatorTok{=} \FloatTok{0.04} \OperatorTok{/} \DecValTok{252}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily Fama{-}French Five Factors:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff5\_daily.head(}\DecValTok{10}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{Daily Five{-}Factor Summary Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff5\_daily[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{6}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily Fama-French Five Factors:
        date       smb       hml       rmw       cma  mkt_excess  risk_free
0 2011-07-01  0.006295  0.002515  0.013140  0.007680   -0.019862   0.000159
1 2011-07-04  0.002880 -0.002875  0.006560 -0.004886   -0.000633   0.000159
2 2011-07-05 -0.004260  0.009864 -0.012158 -0.004470    0.013314   0.000159
3 2011-07-06  0.001544 -0.009847  0.012977  0.006286   -0.008045   0.000159
4 2011-07-07 -0.009789 -0.003988 -0.000197 -0.006995    0.003391   0.000159
5 2011-07-08  0.001537 -0.006700  0.010841 -0.007661    0.000218   0.000159
6 2011-07-11  0.005396  0.004747  0.000655  0.013375   -0.013393   0.000159
7 2011-07-12  0.004759  0.007367  0.001989  0.014669   -0.017505   0.000159
8 2011-07-13 -0.000009  0.001110 -0.002052 -0.001633    0.000767   0.000159
9 2011-07-14 -0.001668  0.002916 -0.005427  0.005388   -0.000695   0.000159

Daily Five-Factor Summary Statistics:
        mkt_excess          smb          hml          rmw          cma
count  3126.000000  3126.000000  3126.000000  3126.000000  3126.000000
mean     -0.000479     0.000484     0.000549    -0.000136     0.000413
std       0.011269     0.008033     0.008312     0.008538     0.006756
min      -0.070268    -0.036283    -0.039155    -0.154013    -0.047698
25%      -0.005074    -0.004122    -0.003681    -0.004212    -0.003364
50%       0.000350     0.000105     0.000384     0.000030     0.000162
75%       0.005531     0.004358     0.004819     0.004036     0.003800
max       0.043386     0.060307     0.086269     0.102001     0.089907
\end{verbatim}

\subsection{Saving Daily Factors}\label{saving-daily-factors}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{factors\_ff3\_daily.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"factors\_ff3\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\NormalTok{factors\_ff5\_daily.to\_sql(}
\NormalTok{    name}\OperatorTok{=}\StringTok{"factors\_ff5\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    if\_exists}\OperatorTok{=}\StringTok{"replace"}\NormalTok{,}
\NormalTok{    index}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily factor data saved to database."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily factor data saved to database.
\end{verbatim}

\section{Factor Validation and
Diagnostics}\label{factor-validation-and-diagnostics}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Verify all tables are in database}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"} \OperatorTok{+} \StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"DATABASE SUMMARY"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}

\NormalTok{tables }\OperatorTok{=}\NormalTok{ [}\StringTok{"factors\_ff3\_monthly"}\NormalTok{, }\StringTok{"factors\_ff5\_monthly"}\NormalTok{, }
          \StringTok{"factors\_ff3\_daily"}\NormalTok{, }\StringTok{"factors\_ff5\_daily"}\NormalTok{]}

\ControlFlowTok{for}\NormalTok{ table }\KeywordTok{in}\NormalTok{ tables:}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}\SpecialStringTok{f"SELECT COUNT(*) as n FROM }\SpecialCharTok{\{}\NormalTok{table}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{, con}\OperatorTok{=}\NormalTok{tidy\_finance)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{table}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\NormalTok{df[}\StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,\}}\SpecialStringTok{ observations"}\NormalTok{)}

\CommentTok{\# Correlation check: Monthly vs Daily (aggregated)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{"} \OperatorTok{+} \StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"MONTHLY VS DAILY CONSISTENCY CHECK"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="}\OperatorTok{*}\DecValTok{50}\NormalTok{)}

\NormalTok{factors\_daily\_agg }\OperatorTok{=}\NormalTok{ (factors\_ff3\_daily}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{    .groupby(}\StringTok{"year\_month"}\NormalTok{)[[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{]]}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\NormalTok{factors\_monthly\_check }\OperatorTok{=}\NormalTok{ (factors\_ff3\_monthly}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{)}

\NormalTok{comparison }\OperatorTok{=}\NormalTok{ factors\_monthly\_check.merge(}
\NormalTok{    factors\_daily\_agg, on}\OperatorTok{=}\StringTok{"year\_month"}\NormalTok{, suffixes}\OperatorTok{=}\NormalTok{(}\StringTok{"\_monthly"}\NormalTok{, }\StringTok{"\_daily"}\NormalTok{)}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ factor }\KeywordTok{in}\NormalTok{ [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{]:}
\NormalTok{    corr }\OperatorTok{=}\NormalTok{ comparison[}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{\_monthly"}\NormalTok{].corr(comparison[}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{\_daily"}\NormalTok{])}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{: Monthly{-}Daily correlation = }\SpecialCharTok{\{}\NormalTok{corr}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}

==================================================
DATABASE SUMMARY
==================================================
factors_ff3_monthly: 150 observations
factors_ff5_monthly: 150 observations
factors_ff3_daily: 3,126 observations
factors_ff5_daily: 3,126 observations

==================================================
MONTHLY VS DAILY CONSISTENCY CHECK
==================================================
mkt_excess: Monthly-Daily correlation = 0.9980
smb: Monthly-Daily correlation = 0.9953
hml: Monthly-Daily correlation = 0.9936
\end{verbatim}

\subsection{Cumulative Factor Returns}\label{cumulative-factor-returns}

We visualize the cumulative performance of each factor to assess whether
the factors generate meaningful premiums over time.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Compute cumulative returns}
\NormalTok{factors\_cumulative }\OperatorTok{=}\NormalTok{ (factors\_ff5\_monthly}
\NormalTok{    .set\_index(}\StringTok{"date"}\NormalTok{)}
\NormalTok{    [[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{)}

\CommentTok{\# Plot}
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\NormalTok{factors\_cumulative.plot(ax}\OperatorTok{=}\NormalTok{ax)}
\NormalTok{ax.set\_title(}\StringTok{"Cumulative Factor Returns (Vietnam)"}\NormalTok{)}
\NormalTok{ax.set\_xlabel(}\StringTok{""}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Growth of $1"}\NormalTok{)}
\NormalTok{ax.legend(title}\OperatorTok{=}\StringTok{"Factor"}\NormalTok{)}
\NormalTok{ax.axhline(y}\OperatorTok{=}\DecValTok{1}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{plt.tight\_layout()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{12_fama_french_files/figure-pdf/fig-cumulative-factors-output-1.pdf}}

}

\caption{\label{fig-cumulative-factors}Cumulative returns of Fama-French
factors for the Vietnamese market. The figure shows the growth of \$1
invested in each factor portfolio.}

\end{figure}%

\subsection{Average Factor Premiums}\label{average-factor-premiums}

We compute annualized average factor premiums and their statistical
significance.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Annualized average returns (monthly returns * 12)}
\NormalTok{factor\_premiums }\OperatorTok{=}\NormalTok{ (factors\_ff5\_monthly}
\NormalTok{    [[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]]}
\NormalTok{    .mean() }\OperatorTok{*} \DecValTok{12} \OperatorTok{*} \DecValTok{100}  \CommentTok{\# Annualized percentage}
\NormalTok{)}

\CommentTok{\# Standard errors}
\NormalTok{factor\_se }\OperatorTok{=}\NormalTok{ (factors\_ff5\_monthly}
\NormalTok{    [[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]]}
\NormalTok{    .std() }\OperatorTok{/}\NormalTok{ np.sqrt(}\BuiltInTok{len}\NormalTok{(factors\_ff5\_monthly)) }\OperatorTok{*}\NormalTok{ np.sqrt(}\DecValTok{12}\NormalTok{) }\OperatorTok{*} \DecValTok{100}
\NormalTok{)}

\CommentTok{\# T{-}statistics}
\NormalTok{factor\_tstat }\OperatorTok{=}\NormalTok{ factor\_premiums }\OperatorTok{/}\NormalTok{ factor\_se}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Annualized Factor Premiums (\%):"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factor\_premiums.}\BuiltInTok{round}\NormalTok{(}\DecValTok{2}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{T{-}Statistics:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factor\_tstat.}\BuiltInTok{round}\NormalTok{(}\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Annualized Factor Premiums (%):
mkt_excess   -12.09
smb            9.19
hml           13.75
rmw           -5.69
cma            9.94
dtype: float64

T-Statistics:
mkt_excess    -7.30
smb            7.76
hml            9.38
rmw           -4.22
cma           10.49
dtype: float64
\end{verbatim}

\subsection{Comparing Monthly and Daily
Factors}\label{comparing-monthly-and-daily-factors}

We verify consistency between monthly and daily factors by computing
correlations.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Aggregate daily factors to monthly for comparison}
\NormalTok{factors\_daily\_monthly }\OperatorTok{=}\NormalTok{ (factors\_ff5\_daily}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{    .groupby(}\StringTok{"year\_month"}\NormalTok{)}
\NormalTok{    [[}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]]}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()  }\CommentTok{\# Sum daily returns to get monthly}
\NormalTok{    .reset\_index()}
\NormalTok{)}

\CommentTok{\# Merge with actual monthly factors}
\NormalTok{comparison }\OperatorTok{=}\NormalTok{ (factors\_ff5\_monthly}
\NormalTok{    .assign(year\_month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{].dt.to\_period(}\StringTok{"M"}\NormalTok{))}
\NormalTok{    .merge(}
\NormalTok{        factors\_daily\_monthly,}
\NormalTok{        on}\OperatorTok{=}\StringTok{"year\_month"}\NormalTok{,}
\NormalTok{        suffixes}\OperatorTok{=}\NormalTok{(}\StringTok{"\_monthly"}\NormalTok{, }\StringTok{"\_daily"}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}

\CommentTok{\# Correlations}
\ControlFlowTok{for}\NormalTok{ factor }\KeywordTok{in}\NormalTok{ [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{]:}
\NormalTok{    corr }\OperatorTok{=}\NormalTok{ comparison[}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{\_monthly"}\NormalTok{].corr(comparison[}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{\_daily"}\NormalTok{])}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{factor}\SpecialCharTok{\}}\SpecialStringTok{: Monthly{-}Daily correlation = }\SpecialCharTok{\{}\NormalTok{corr}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
mkt_excess: Monthly-Daily correlation = 0.9980
smb: Monthly-Daily correlation = 0.9950
hml: Monthly-Daily correlation = 0.9948
rmw: Monthly-Daily correlation = 0.9929
cma: Monthly-Daily correlation = 0.9884
\end{verbatim}

\section{Key Takeaways}\label{key-takeaways-8}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Factor Models Explained}: The Fama-French three-factor model
  adds size (SMB) and value (HML) factors to the CAPM, while the
  five-factor model further includes profitability (RMW) and investment
  (CMA) factors.
\item
  \textbf{Construction Methodology}: Factors are constructed through
  double-sorted portfolios with careful attention to timing. Portfolios
  are formed in July using accounting data from the prior fiscal year to
  ensure information was publicly available.
\item
  \textbf{Independent vs.~Dependent Sorts}: The three-factor model uses
  independent sorts on size and book-to-market, creating a 23 grid. The
  five-factor model uses dependent sorts where characteristics are
  sorted within size groups.
\item
  \textbf{Value-Weighted Returns}: Portfolio returns are computed using
  value-weighting with lagged market capitalization to avoid look-ahead
  bias.
\item
  \textbf{Daily Factors}: Daily factors use the same annual portfolio
  assignments but compute returns at daily frequency, enabling
  higher-frequency applications like daily beta estimation.
\item
  \textbf{Market Factor}: The market factor is computed independently as
  the value-weighted return of all stocks minus the risk-free rate.
\item
  \textbf{Validation}: Factor quality can be assessed through
  characteristic monotonicity, portfolio diversification, cumulative
  returns, and consistency between daily and monthly frequencies.
\item
  \textbf{Vietnamese Market Adaptation}: While following the original
  Fama-French methodology, we adapt for Vietnamese market
  characteristics including VAS accounting standards, reporting
  timelines, and currency units.
\end{enumerate}

\bookmarksetup{startatroot}

\chapter{Fama-MacBeth Regressions}\label{fama-macbeth-regressions}

In this chapter, we delve into the implementation of the Eugene F. Fama
and MacBeth (1973) regression approach, a cornerstone of empirical asset
pricing. While portfolio sorts provide a robust, non-parametric view of
the relationship between characteristics and returns, they struggle when
we need to control for multiple factors simultaneously. For instance, in
the Vietnamese stock market (HOSE and HNX), small-cap stocks often
exhibit high illiquidity. Does the ``Size effect'' exist because small
stocks are risky, or simply because they are illiquid? Fama-MacBeth (FM)
regressions allow us to disentangle these effects in a linear framework.

We will implement a version of the FM procedure, accounting for:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Weighted Least Squares (WLS):} To prevent micro-cap stocks,
  which are prevalent and volatile in Vietnam, from dominating the
  estimates.
\item
  \textbf{Newey-West Adjustments:} To handle the serial correlation
  often observed in Vietnamese market risk premiums.
\end{enumerate}

\section{The Econometric Framework}\label{the-econometric-framework}

The Fama-MacBeth procedure is essentially a two-step filter that
separates the cross-sectional variation in returns from the time-series
variation.

\subsection{Intuition: Why not Panel
OLS?}\label{intuition-why-not-panel-ols}

A naive approach would be to pool all data (\(N\) stocks \(\times\)
\(T\) months) and run a single Ordinary Least Squares (OLS) regression:

\[ 
r_{i,t+1} = \alpha + \beta_{i,t} \lambda + \epsilon_{i,t+1} 
\]

However, this assumes that the error terms \(\epsilon_{i,t+1}\) are
independent across firms. In reality, stock returns are highly
cross-sectionally correlated (if the VN-Index crashes, most stocks fall
together). A pooled OLS would underestimate the standard errors, leading
to ``false positive'' discoveries of risk factors. Fama-MacBeth solves
this by running \(T\) separate cross-sectional regressions, effectively
treating each month as a single independent observation of the risk
premium.

\subsection{Mathematical Derivation}\label{mathematical-derivation}

\subsubsection{Step 1: Cross-Sectional
Regressions}\label{step-1-cross-sectional-regressions}

For each month \(t\), we estimate the premium \(\lambda_{k,t}\) for
\(K\) factors. Let \(r_{i,t+1}\) be the excess return of asset \(i\) at
time \(t+1\). Let \(\boldsymbol{\beta}_{i,t}\) be a vector of \(K\)
characteristics (e.g., Market Beta, Book-to-Market, Size) known at time
\(t\).

The model for a specific month \(t\) is: \[ 
\mathbf{r}_{t+1} = \mathbf{X}_t \boldsymbol{\lambda}_{t+1} + \boldsymbol{\alpha}_{t+1} + \boldsymbol{\epsilon}_{t+1} 
\]

Where:

\begin{itemize}
\tightlist
\item
  \(\mathbf{r}_{t+1}\) is an \(N \times 1\) vector of returns.
\item
  \(\mathbf{X}_t\) is an \(N \times (K+1)\) matrix of factor exposures
  (including a column of ones for the intercept).
\item
  \(\boldsymbol{\lambda}_{t+1}\) is the vector of risk premiums realized
  in month \(t+1\).
\end{itemize}

To use \textbf{Weighted Least Squares (WLS)}, We define a weighting
matrix \(\mathbf{W}_t\) (typically diagonal with market
capitalizations). The estimator for month \(t\) is: \[ 
\hat{\boldsymbol{\lambda}}_{t+1} = (\mathbf{X}_t^\top \mathbf{W}_t \mathbf{X}_t)^{-1} \mathbf{X}_t^\top \mathbf{W}_t \mathbf{r}_{t+1} 
\]

\subsubsection{Step 2: Time-Series
Aggregation}\label{step-2-time-series-aggregation}

We now have a time-series of \(T\) estimates:
\(\hat{\lambda}_1, \hat{\lambda}_2, \dots, \hat{\lambda}_T\). The final
estimate of the risk premium is the time-series average: \[ 
\hat{\lambda}_k = \frac{1}{T} \sum_{t=1}^T \hat{\lambda}_{k,t} 
\]

The standard error is derived from the standard deviation of these
monthly estimates: \[ 
\sigma(\hat{\lambda}_k) = \sqrt{\frac{1}{T^2} \sum_{t=1}^T (\hat{\lambda}_{k,t} - \hat{\lambda}_k)^2} 
\]

\section{Data Preparation}\label{data-preparation-3}

We utilize data from our local SQLite database. In Vietnam, the fiscal
year typically ends in December, and audited reports are required by
April. To ensure no look-ahead bias, we lag accounting data (Book
Equity) to match returns starting in July (a 6-month conservative lag,
similar to Fama-French, but adapted for Vietnamese reporting delays).

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ sqlite3}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{from}\NormalTok{ pandas.tseries.offsets }\ImportTok{import}\NormalTok{ MonthEnd}

\CommentTok{\# Connect to the Vietnamese data}
\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\CommentTok{\# Load Monthly Prices (HOSE \& HNX)}
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{  sql}\OperatorTok{=}\StringTok{"SELECT symbol, date, ret\_excess, mktcap, mktcap\_lag FROM prices\_monthly"}\NormalTok{,}
\NormalTok{  con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{  parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Load Book Equity (derived from Vietnamese Financial Statements)}
\NormalTok{comp\_vn }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{  sql}\OperatorTok{=}\StringTok{"SELECT datadate, symbol, be FROM comp\_vn"}\NormalTok{,}
\NormalTok{  con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{  parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"datadate"}\NormalTok{\}}
\NormalTok{)}

\CommentTok{\# Load Rolling Market Betas (Pre{-}calculated in Chapter \textquotesingle{}Beta Estimation\textquotesingle{})}
\NormalTok{beta\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{  sql}\OperatorTok{=}\StringTok{"SELECT symbol, date, beta FROM beta\_monthly"}\NormalTok{,}
\NormalTok{  con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{  parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We construct our testing characteristics:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{(Market Beta):} The sensitivity to the VN-Index.
\item
  \textbf{Size (ln(ME)):} The natural log of market capitalization.
\item
  \textbf{Value (BM):} The ratio of Book Equity to Market Equity.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Prepare Characteristics}
\NormalTok{characteristics }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    comp\_vn}
    \CommentTok{\# Align reporting date to month end}
\NormalTok{    .assign(date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.to\_datetime(x[}\StringTok{"datadate"}\NormalTok{]) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{0}\NormalTok{))}
    \CommentTok{\# Merge with price data to get Market Cap at fiscal year end}
\NormalTok{    .merge(prices\_monthly, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{    .merge(beta\_monthly, on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\NormalTok{    .assign(}
        \CommentTok{\# Compute Book{-}to{-}Market}
\NormalTok{        bm}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"be"}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{"mktcap"}\NormalTok{],}
\NormalTok{        log\_mktcap}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.log(x[}\StringTok{"mktcap"}\NormalTok{]),}
        \CommentTok{\# Create sorting date: Financials valid from July of year t+1}
\NormalTok{        sorting\_date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{"date"}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.DateOffset(months}\OperatorTok{=}\DecValTok{6}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{0}\NormalTok{),}
\NormalTok{    )}
\NormalTok{    .get([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"bm"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{]) }
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{characteristics.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& symbol & bm & beta & sorting\_date \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
8729 & VTV & 7.034945e+08 & 0.847809 & 2017-06-30 \\
8732 & MTG & 2.670306e+09 & 1.140066 & 2017-06-30 \\
8739 & MKV & 6.505031e+08 & -0.448319 & 2017-06-30 \\
8740 & MIC & 1.243127e+09 & 0.772140 & 2017-06-30 \\
8742 & MCP & 6.657350e+08 & 0.348139 & 2017-06-30 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Merge back to monthly return panel}
\NormalTok{data\_fm }\OperatorTok{=}\NormalTok{ (prices\_monthly}
\NormalTok{  .merge(characteristics, }
\NormalTok{         left\_on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{], }
\NormalTok{         right\_on}\OperatorTok{=}\NormalTok{[}\StringTok{"symbol"}\NormalTok{, }\StringTok{"sorting\_date"}\NormalTok{], }
\NormalTok{         how}\OperatorTok{=}\StringTok{"left"}\NormalTok{)}
\CommentTok{\#   .merge(beta\_monthly, on=["symbol", "date"], how="left")}
\NormalTok{  .sort\_values([}\StringTok{"symbol"}\NormalTok{, }\StringTok{"date"}\NormalTok{])}
\NormalTok{)}

\CommentTok{\# Forward fill characteristics for 12 months (valid until next report)}
\NormalTok{data\_fm[[}\StringTok{"bm"}\NormalTok{]] }\OperatorTok{=}\NormalTok{ data\_fm.groupby(}\StringTok{"symbol"}\NormalTok{)[[}\StringTok{"bm"}\NormalTok{]].ffill(limit}\OperatorTok{=}\DecValTok{12}\NormalTok{)}

\CommentTok{\# Log Market Cap is updated monthly}
\NormalTok{data\_fm[}\StringTok{"log\_mktcap"}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.log(data\_fm[}\StringTok{"mktcap"}\NormalTok{])}

\CommentTok{\# Lead returns: We use characteristics at t to predict return at t+1}
\NormalTok{data\_fm[}\StringTok{"ret\_excess\_lead"}\NormalTok{] }\OperatorTok{=}\NormalTok{ data\_fm.groupby(}\StringTok{"symbol"}\NormalTok{)[}\StringTok{"ret\_excess"}\NormalTok{].shift(}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}

\CommentTok{\# Cleaning: Remove rows with missing future returns or characteristics}
\NormalTok{data\_fm }\OperatorTok{=}\NormalTok{ data\_fm.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{"ret\_excess\_lead"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"log\_mktcap"}\NormalTok{, }\StringTok{"bm"}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(data\_fm.head())}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Data ready: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(data\_fm)}\SpecialCharTok{:,\}}\SpecialStringTok{ observations from }\SpecialCharTok{\{}\NormalTok{data\_fm}\SpecialCharTok{.}\NormalTok{date}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{data\_fm}\SpecialCharTok{.}\NormalTok{date}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
    symbol       date  ret_excess       mktcap   mktcap_lag            bm  \
163    AAA 2017-06-30    0.129454  2078.455619  1834.816104  7.929854e+08   
175    AAA 2018-06-30   -0.067690  2758.426126  2948.159140  8.161755e+08   
187    AAA 2019-06-30    0.030469  3141.519560  3038.799575  1.389438e+09   
199    AAA 2020-06-30   -0.035462  2311.250278  2387.972279  1.497272e+09   
211    AAA 2021-06-30    0.275355  5423.280296  4241.283308  1.456989e+09   

         beta sorting_date  log_mktcap  ret_excess_lead  
163  1.479060   2017-06-30    7.639380        -0.051090  
175  1.090411   2018-06-30    7.922416        -0.095926  
187  1.099956   2019-06-30    8.052462        -0.027856  
199  0.954144   2020-06-30    7.745544        -0.098769  
211  1.245004   2021-06-30    8.598456        -0.175128  
Data ready: 5,075 observations from 2017-06-30 to 2023-06-30
\end{verbatim}

\section{Step 1: Cross-Sectional Regressions with
WLS}\label{step-1-cross-sectional-regressions-with-wls}

Hou, Xue, and Zhang (2020) argue that micro-cap stocks distorts
inference because they have high transaction costs and idiosyncratic
volatility. In Vietnam, this is exacerbated by ``penny stock''
speculation.

We implement \textbf{Weighted Least Squares (WLS)} where weights are the
market capitalization of the prior month. This tests if the factors are
priced in the \emph{investable} universe, not just the equal-weighted
average of tiny stocks.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ run\_cross\_section(df):}
    \CommentTok{\# Standardize inputs for numerical stability}
    \CommentTok{\# Note: We do NOT standardize the dependent variable (returns)}
    \CommentTok{\# We standardize regressors to interpret coefficients as "per 1 SD change" if desired,}
    \CommentTok{\# BUT for pure risk premium estimation, we usually keep raw units.}
    \CommentTok{\# Here we use raw units to interpret lambda as \% return per unit of characteristic.}
    
    \CommentTok{\# Define Weighted Least Squares}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ smf.wls(}
\NormalTok{        formula}\OperatorTok{=}\StringTok{"ret\_excess\_lead \textasciitilde{} beta + log\_mktcap + bm"}\NormalTok{,}
\NormalTok{        data}\OperatorTok{=}\NormalTok{df,}
\NormalTok{        weights}\OperatorTok{=}\NormalTok{df[}\StringTok{"mktcap\_lag"}\NormalTok{] }\CommentTok{\# Weight by size}
\NormalTok{    )}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ model.fit()}
    
    \ControlFlowTok{return}\NormalTok{ results.params}

\CommentTok{\# Apply to every month}
\NormalTok{risk\_premiums }\OperatorTok{=}\NormalTok{ (data\_fm}
\NormalTok{  .groupby(}\StringTok{"date"}\NormalTok{)}
\NormalTok{  .}\BuiltInTok{apply}\NormalTok{(run\_cross\_section)}
\NormalTok{  .reset\_index()}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(risk\_premiums.head())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
        date  Intercept      beta  log_mktcap            bm
0 2017-06-30  -0.089116 -0.063799    0.010284  2.897813e-11
1 2018-06-30  -0.023221 -0.008252    0.001890  1.377518e-11
2 2019-06-30  -0.079373  0.035622    0.006224 -8.139910e-12
3 2020-06-30  -0.031213 -0.114968    0.008999 -2.306768e-11
4 2021-06-30   0.081397 -0.011407   -0.007330 -5.211290e-11
\end{verbatim}

\section{Step 2: Time-Series Aggregation \& Hypothesis
Testing}\label{step-2-time-series-aggregation-hypothesis-testing}

We now possess the time-series of risk premiums. We calculate the
arithmetic mean and the -statistics.

Crucially, we use \textbf{Newey-West (HAC)} standard errors. Risk
premiums in Vietnam often exhibit autocorrelation (momentum in factor
performance). A simple standard error formula would be invalid.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calculate\_fama\_macbeth\_stats(df, lags}\OperatorTok{=}\DecValTok{6}\NormalTok{):}
\NormalTok{    summary }\OperatorTok{=}\NormalTok{ []}
    
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ [}\StringTok{"Intercept"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"log\_mktcap"}\NormalTok{, }\StringTok{"bm"}\NormalTok{]:}
\NormalTok{        series }\OperatorTok{=}\NormalTok{ df[col]}
        
        \CommentTok{\# 1. Point Estimate (Average Risk Premium)}
\NormalTok{        mean\_premium }\OperatorTok{=}\NormalTok{ series.mean()}
        
        \CommentTok{\# 2. Newey{-}West Standard Error}
        \CommentTok{\# We regress the series on a constant (ones) to get the SE of the mean}
\NormalTok{        exog }\OperatorTok{=}\NormalTok{ sm.add\_constant(np.ones(}\BuiltInTok{len}\NormalTok{(series)))}
\NormalTok{        nw\_model }\OperatorTok{=}\NormalTok{ sm.OLS(series, exog).fit(}
\NormalTok{            cov\_type}\OperatorTok{=}\StringTok{\textquotesingle{}HAC\textquotesingle{}}\NormalTok{, cov\_kwds}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}maxlags\textquotesingle{}}\NormalTok{: lags\}}
\NormalTok{        )}

\NormalTok{        se }\OperatorTok{=}\NormalTok{ nw\_model.bse.iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{        t\_stat }\OperatorTok{=}\NormalTok{ nw\_model.tvalues.iloc[}\DecValTok{0}\NormalTok{]}
        
\NormalTok{        summary.append(\{}
            \StringTok{"Factor"}\NormalTok{: col,}
            \StringTok{"Premium (\%)"}\NormalTok{: mean\_premium }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
            \StringTok{"Std Error"}\NormalTok{: se }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
            \StringTok{"t{-}statistic"}\NormalTok{: t\_stat,}
            \StringTok{"Significance"}\NormalTok{: }\StringTok{"*"} \ControlFlowTok{if} \BuiltInTok{abs}\NormalTok{(t\_stat) }\OperatorTok{\textgreater{}} \FloatTok{1.96} \ControlFlowTok{else} \StringTok{""}
\NormalTok{        \})}
        
    \ControlFlowTok{return}\NormalTok{ pd.DataFrame(summary)}

\NormalTok{price\_of\_risk }\OperatorTok{=}\NormalTok{ calculate\_fama\_macbeth\_stats(risk\_premiums)}
\BuiltInTok{print}\NormalTok{(price\_of\_risk.}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
       Factor  Premium (%)  Std Error  t-statistic Significance
0   Intercept      -1.8174     1.9117      -0.9507             
1        beta      -1.7859     1.0407      -1.7161             
2  log_mktcap       0.2347     0.2048       1.1457             
3          bm      -0.0000     0.0000      -0.0928             
\end{verbatim}

\subsection{Visualizing the Time-Varying Risk
Premium}\label{visualizing-the-time-varying-risk-premium}

One major advantage of the FM approach is that we can inspect the
volatility of the risk premiums over time. In Vietnam, we expect the
``Size'' premium to be highly volatile during periods of retail
liquidity injection (e.g., 2020-2021).

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ mtick}

\CommentTok{\# Calculate cumulative returns of the factors (as if they were tradable portfolios)}
\NormalTok{cumulative\_premiums }\OperatorTok{=}\NormalTok{ (risk\_premiums}
\NormalTok{    .set\_index(}\StringTok{"date"}\NormalTok{)}
\NormalTok{    .drop(columns}\OperatorTok{=}\NormalTok{[}\StringTok{"Intercept"}\NormalTok{])}
\NormalTok{    .cumsum()}
\NormalTok{)}

\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\NormalTok{cumulative\_premiums.plot(ax}\OperatorTok{=}\NormalTok{ax, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\NormalTok{ax.set\_title(}\StringTok{"Cumulative Risk Premiums in Vietnam (Fama{-}MacBeth)"}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Cumulative Coefficient Return"}\NormalTok{)}
\NormalTok{ax.legend(title}\OperatorTok{=}\StringTok{"Factor"}\NormalTok{)}
\NormalTok{ax.grid(}\VariableTok{True}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{13_fama_macbeth_files/figure-pdf/fig-cumulative-premiums-output-1.pdf}}

}

\caption{\label{fig-cumulative-premiums}Cumulative Risk Premiums in
Vietnam.}

\end{figure}%

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Market Beta:} In many empirical studies (including the US),
  the market beta premium is often insignificant or even negative (the
  ``Betting Against Beta'' anomaly). In Vietnam, if the -stat is , it
  implies the CAPM does not explain the cross-section of returns.
\item
  \textbf{Size (Log Mktcap):} A negative coefficient confirms the ``Size
  Effect''---smaller firms have higher expected returns. However, using
  WLS often weakens this result compared to OLS, suggesting the size
  premium is concentrated in micro-caps.
\item
  \textbf{Value (BM):} A positive coefficient confirms the Value
  premium. In Vietnam, value stocks (high B/M) often outperform growth
  stocks, particularly in the manufacturing and banking sectors.
\end{enumerate}

Figure~\ref{fig-cumulative-premiums} plots the cumulative sum of the
monthly Fama MacBeth risk premium estimates for beta, size, and value.
Because these lines cumulate estimated cross sectional prices of risk
rather than actual portfolio returns, the figure should be interpreted
as showing the time variation and persistence of estimated premia, not
investable performance.

The beta premium displays a clear regime shift around 2020, with a sharp
decline that only partially reverses afterward. This pattern suggests
that the pricing of systematic risk in Vietnam is unstable over short
samples and may be heavily influenced by episodic market conditions such
as the post COVID retail trading boom. The size premium is comparatively
smoother but small in magnitude, indicating only weak and time varying
evidence that firm size is priced in the cross section during this
period. The value premium remains close to zero throughout, implying
little consistent cross sectional reward to high book to market firms in
this sample window.

Overall, the figure highlights that estimated risk premia in the
Vietnamese market are highly time varying and sensitive to specific
macro and market regimes, reinforcing the need for caution when drawing
conclusions from short samples.

\section{Sanity Checks}\label{sanity-checks}

\subsection{Time-Series Volatility
Check}\label{time-series-volatility-check}

Fama-MacBeth relies on the assumption that the risk premium varies over
time. If your \texttt{bm} premium is truly near zero every month, the
method fails.

\textbf{Action:} Plot the time series of the estimated coefficients .
You want to see ``noise'' around a mean. If you see a flat line or a
single massive spike, your data is corrupted.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}

\CommentTok{\# Plot the time series of the BM risk premium}
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\NormalTok{risk\_premiums[}\StringTok{"bm"}\NormalTok{].plot(ax}\OperatorTok{=}\NormalTok{ax, title}\OperatorTok{=}\StringTok{"Monthly Value Premium (BM) Coefficient"}\NormalTok{)}
\NormalTok{ax.axhline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{"black"}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{"{-}{-}"}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Slope Coefficient"}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{13_fama_macbeth_files/figure-pdf/cell-8-output-1.pdf}}

\subsection{The ``Predicted vs.~Realized'' Scatter
Plot}\label{the-predicted-vs.-realized-scatter-plot}

The ultimate test of an asset pricing model is whether it can price the
test assets. If you group your stocks into portfolios (e.g., 25
portfolios sorted by Size and Beta), the model's predicted return should
match the actual average return.

\textbf{Action:} Compare the model's prediction against reality.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Calculate the average realized return for each stock .
\item
  Calculate the predicted return: .
\item
  Scatter plot them. They should align along the 45-degree line.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Calculate average characteristics for each stock}
\NormalTok{stock\_means }\OperatorTok{=}\NormalTok{ data\_fm.groupby(}\StringTok{"symbol"}\NormalTok{)[[}\StringTok{"ret\_excess\_lead"}\NormalTok{, }\StringTok{"beta"}\NormalTok{, }\StringTok{"log\_mktcap"}\NormalTok{, }\StringTok{"bm"}\NormalTok{]].mean()}

\CommentTok{\# Note: Ensure you grab the \textquotesingle{}Premium (\%)\textquotesingle{} divided by 100 if it was scaled}
\CommentTok{\# Or use the raw mean from risk\_premiums}
\NormalTok{lambda\_beta }\OperatorTok{=}\NormalTok{ risk\_premiums[}\StringTok{"beta"}\NormalTok{].mean()}
\NormalTok{lambda\_size }\OperatorTok{=}\NormalTok{ risk\_premiums[}\StringTok{"log\_mktcap"}\NormalTok{].mean()}
\NormalTok{lambda\_bm }\OperatorTok{=}\NormalTok{ risk\_premiums[}\StringTok{"bm"}\NormalTok{].mean()}
\NormalTok{const }\OperatorTok{=}\NormalTok{ risk\_premiums[}\StringTok{"Intercept"}\NormalTok{].mean()}

\NormalTok{stock\_means[}\StringTok{"predicted\_ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    const }\OperatorTok{+}
\NormalTok{    stock\_means[}\StringTok{"beta"}\NormalTok{] }\OperatorTok{*}\NormalTok{ lambda\_beta }\OperatorTok{+} 
\NormalTok{    stock\_means[}\StringTok{"log\_mktcap"}\NormalTok{] }\OperatorTok{*}\NormalTok{ lambda\_size }\OperatorTok{+} 
\NormalTok{    stock\_means[}\StringTok{"bm"}\NormalTok{] }\OperatorTok{*}\NormalTok{ lambda\_bm}
\NormalTok{)}

\CommentTok{\# Plot}
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{8}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\NormalTok{ax.scatter(stock\_means[}\StringTok{"predicted\_ret"}\NormalTok{], stock\_means[}\StringTok{"ret\_excess\_lead"}\NormalTok{], alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{)}
\NormalTok{ax.plot([}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{], [}\DecValTok{0}\NormalTok{, }\FloatTok{0.05}\NormalTok{], color}\OperatorTok{=}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{) }\CommentTok{\# 45{-}degree line}
\NormalTok{ax.set\_xlabel(}\StringTok{"Predicted Average Return"}\NormalTok{)}
\NormalTok{ax.set\_ylabel(}\StringTok{"Realized Average Return"}\NormalTok{)}
\NormalTok{ax.set\_title(}\StringTok{"Model Fit: Predicted vs Realized"}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{13_fama_macbeth_files/figure-pdf/cell-9-output-1.pdf}}

The scatter plot compares each stock's average realized excess return to
the return predicted by the estimated risk premia and its
characteristics. If the model priced assets well, the points would
cluster around the 45 degree line. Instead, the cloud is centered near
zero on the horizontal axis, while realized returns vary widely on the
vertical axis. The fitted line is nearly flat, indicating that
differences in predicted returns explain very little of the variation in
realized returns across stocks.

This pattern implies that, over this sample period, the estimated factor
premia have weak cross sectional explanatory power at the individual
stock level. Such weak fit is common in emerging markets and in short
samples, where idiosyncratic volatility, thin trading, and episodic
market regimes dominate the cross section of returns. It also reflects
the well known fact that Fama MacBeth tests tend to have low power when
applied to individual securities rather than diversified portfolios.

\subsection{Correlation of Characteristics
(Multicollinearity)}\label{correlation-of-characteristics-multicollinearity}

In Vietnam, large-cap stocks (high \texttt{log\_mktcap}) are often the
ones with high Book-to-Market ratios (banks/utilities) or specific
Betas. If your factors are highly correlated, the Fama-MacBeth
coefficients will be unstable and insignificant (low t-stats), even if
the factors actually matter.

\textbf{Action:} Check the cross-sectional correlation.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Check correlation of the characteristics}
\NormalTok{corr\_matrix }\OperatorTok{=}\NormalTok{ data\_fm[[}\StringTok{"beta"}\NormalTok{, }\StringTok{"log\_mktcap"}\NormalTok{, }\StringTok{"bm"}\NormalTok{]].corr()}
\BuiltInTok{print}\NormalTok{(corr\_matrix)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
                beta  log_mktcap        bm
beta        1.000000    0.392776 -0.033748
log_mktcap  0.392776    1.000000 -0.203307
bm         -0.033748   -0.203307  1.000000
\end{verbatim}

\textbf{Interpretation:}

\begin{itemize}
\tightlist
\item
  If correlation \textgreater{} 0.7 (absolute value), the regression
  struggles to distinguish between the two factors.
\item
  For example, if \texttt{Size} and \texttt{Liquidity} are -0.8
  correlated, the model cannot tell which one is driving the return,
  often resulting in both having insignificant t-stats.
\end{itemize}

\bookmarksetup{startatroot}

\chapter{Institutional Ownership Analytics in
Vietnam}\label{institutional-ownership-analytics-in-vietnam}

\section{Institutional Ownership in Vietnam: A Distinct
Landscape}\label{institutional-ownership-in-vietnam-a-distinct-landscape}

Vietnam's equity market presents a fundamentally different institutional
ownership landscape from the mature markets of the US, Europe, or Japan.
Since the Ho Chi Minh City Securities Trading Center (now HOSE) opened
on July 28, 2000 with just two listed stocks, the market has grown to
over 1,700 listed companies across three exchanges (HOSE, HNX, and
UPCOM) with a combined market capitalization exceeding 200 billion USD.
Yet the ownership structure remains distinctive in several critical
ways:

\begin{itemize}
\item
  \textbf{Retail dominance.} Individual investors account for
  approximately 85\% of trading value on Vietnamese exchanges, far
  exceeding the institutional share. This contrasts sharply with the US,
  where institutional investors dominate both ownership and trading (Bao
  Dinh and Tran 2024). The implications for market efficiency, price
  discovery, and volatility are profound.
\item
  \textbf{State ownership legacy.} Vietnam's equitization
  (privatization) program, initiated under i Mi reforms in 1986,
  means that the state remains a significant or controlling shareholder
  in many listed companies. As of 2022, SOEs (firms with state ownership
  \textgreater{} 50\%) account for approximately 30\% of total market
  capitalization despite representing less than 10\% of listed firms
  (Huang, Liu, and Shu 2023). State ownership introduces unique agency
  problems, governance dynamics, and liquidity constraints.
\item
  \textbf{Foreign Ownership Limits (FOLs).} Vietnam imposes
  sector-specific caps on aggregate foreign ownership, typically 49\%
  for most sectors, 30\% for banking, and varying limits for aviation,
  media, and telecommunications. When a stock reaches its FOL, foreign
  investors can only buy from other foreign sellers, creating a
  segmented market with distinct pricing dynamics and a well-documented
  ``FOL premium'' (Vo 2015).
\item
  \textbf{Disclosure regime.} Unlike the US quarterly 13F filing system,
  Vietnam's ownership disclosure is event-driven and periodic. Major
  shareholders (5\%) must disclose within 7 business days of crossing
  thresholds. Annual reports contain detailed shareholder registers.
  Semi-annual fund reports provide portfolio snapshots. This creates a
  patchwork of disclosure frequencies that require careful handling.
\end{itemize}

\section{Data Infrastructure: DataCore.vn}\label{sec-datacore}

\textbf{DataCore.vn} is a comprehensive Vietnamese financial data
platform that provides academic-grade datasets for the Vietnamese
market. Throughout this chapter, we assume all data is sourced
exclusively from DataCore.vn, which provides:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.3472}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2639}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.3889}}@{}}
\caption{DataCore.vn Data Tables Used in This
Chapter}\label{tbl-datacore-tables}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
DataCore.vn Dataset
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Content
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Variables
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
DataCore.vn Dataset
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Content
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Variables
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Stock Prices} & Daily/monthly OHLCV for HOSE, HNX, UPCOM &
\texttt{ticker}, \texttt{date}, \texttt{close},
\texttt{adjusted\_close}, \texttt{volume},
\texttt{shares\_outstanding} \\
\textbf{Ownership Structure} & Shareholder composition snapshots &
\texttt{ticker}, \texttt{date}, \texttt{shareholder\_name},
\texttt{shares\_held}, \texttt{ownership\_pct},
\texttt{shareholder\_type} \\
\textbf{Major Shareholders} & Detailed 5\% holders & \texttt{ticker},
\texttt{date}, \texttt{shareholder\_name}, \texttt{shares\_held},
\texttt{is\_foreign}, \texttt{is\_state}, \texttt{is\_institution} \\
\textbf{Corporate Actions} & Dividends, stock splits, bonus shares,
rights issues & \texttt{ticker}, \texttt{ex\_date},
\texttt{action\_type}, \texttt{ratio}, \texttt{record\_date} \\
\textbf{Company Profile} & Sector, exchange, listing date, charter
capital & \texttt{ticker}, \texttt{exchange}, \texttt{industry\_code},
\texttt{listing\_date}, \texttt{fol\_limit} \\
\textbf{Financial Statements} & Quarterly/annual financials &
\texttt{ticker}, \texttt{period}, \texttt{revenue},
\texttt{net\_income}, \texttt{total\_assets}, \texttt{equity} \\
\textbf{Foreign Ownership} & Daily foreign ownership tracking &
\texttt{ticker}, \texttt{date}, \texttt{foreign\_shares},
\texttt{foreign\_pct}, \texttt{fol\_limit}, \texttt{foreign\_room} \\
\textbf{Fund Holdings} & Semi-annual fund portfolio disclosures &
\texttt{fund\_name}, \texttt{report\_date}, \texttt{ticker},
\texttt{shares\_held}, \texttt{market\_value} \\
\end{longtable}

\phantomsection\label{datacore-reader}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{class}\NormalTok{ DataCoreReader:}
    \CommentTok{"""}
\CommentTok{    Unified data reader for DataCore.vn datasets.}
\CommentTok{    }
\CommentTok{    Assumes data has been downloaded from DataCore.vn and stored locally.}
\CommentTok{    Supports both Parquet (recommended for performance) and CSV formats.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    data\_dir : str or Path}
\CommentTok{        Root directory containing DataCore.vn data files}
\CommentTok{    file\_format : str}
\CommentTok{        \textquotesingle{}parquet\textquotesingle{} or \textquotesingle{}csv\textquotesingle{} (default: \textquotesingle{}parquet\textquotesingle{})}
\CommentTok{    """}
    
    \CommentTok{\# Expected file names in the data directory}
\NormalTok{    FILE\_MAP }\OperatorTok{=}\NormalTok{ \{}
        \StringTok{\textquotesingle{}prices\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}stock\_prices\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}ownership\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}ownership\_structure\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}major\_shareholders\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}major\_shareholders\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}corporate\_actions\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}corporate\_actions\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}company\_profile\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}company\_profile\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}financials\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}financial\_statements\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}foreign\_ownership\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}foreign\_ownership\_daily\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}fund\_holdings\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}fund\_holdings\textquotesingle{}}\NormalTok{,}
\NormalTok{    \}}
    
    \KeywordTok{def} \FunctionTok{\_\_init\_\_}\NormalTok{(}\VariableTok{self}\NormalTok{, data\_dir: Union[}\BuiltInTok{str}\NormalTok{, Path], file\_format: }\BuiltInTok{str} \OperatorTok{=} \StringTok{\textquotesingle{}parquet\textquotesingle{}}\NormalTok{):}
        \VariableTok{self}\NormalTok{.data\_dir }\OperatorTok{=}\NormalTok{ Path(data\_dir)}
        \VariableTok{self}\NormalTok{.fmt }\OperatorTok{=}\NormalTok{ file\_format}
        \VariableTok{self}\NormalTok{.\_cache }\OperatorTok{=}\NormalTok{ \{\}}
        
        \CommentTok{\# Verify data directory exists}
        \ControlFlowTok{if} \KeywordTok{not} \VariableTok{self}\NormalTok{.data\_dir.exists():}
            \ControlFlowTok{raise} \PreprocessorTok{FileNotFoundError}\NormalTok{(}
                \SpecialStringTok{f"Data directory not found: }\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{data\_dir}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{"}
                \SpecialStringTok{f"Please download data from DataCore.vn and place it in this directory."}
\NormalTok{            )}
        
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"DataCore.vn reader initialized: }\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{data\_dir}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{        available }\OperatorTok{=}\NormalTok{ [f.stem }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in} \VariableTok{self}\NormalTok{.data\_dir.glob(}\SpecialStringTok{f\textquotesingle{}*.}\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{fmt}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)]}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Available datasets: }\SpecialCharTok{\{}\NormalTok{available}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
    
    \KeywordTok{def}\NormalTok{ \_read(}\VariableTok{self}\NormalTok{, key: }\BuiltInTok{str}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \CommentTok{"""Read and cache a dataset."""}
        \ControlFlowTok{if}\NormalTok{ key }\KeywordTok{in} \VariableTok{self}\NormalTok{.\_cache:}
            \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_cache[key]}
        
\NormalTok{        fname }\OperatorTok{=} \VariableTok{self}\NormalTok{.FILE\_MAP.get(key, key)}
\NormalTok{        filepath }\OperatorTok{=} \VariableTok{self}\NormalTok{.data\_dir }\OperatorTok{/} \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{fname}\SpecialCharTok{\}}\SpecialStringTok{.}\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{fmt}\SpecialCharTok{\}}\SpecialStringTok{"}
        
        \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ filepath.exists():}
            \ControlFlowTok{raise} \PreprocessorTok{FileNotFoundError}\NormalTok{(}
                \SpecialStringTok{f"Dataset not found: }\SpecialCharTok{\{}\NormalTok{filepath}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{"}
                \SpecialStringTok{f"Expected file: }\SpecialCharTok{\{}\NormalTok{fname}\SpecialCharTok{\}}\SpecialStringTok{.}\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{fmt}\SpecialCharTok{\}}\SpecialStringTok{ in }\SpecialCharTok{\{}\VariableTok{self}\SpecialCharTok{.}\NormalTok{data\_dir}\SpecialCharTok{\}}\SpecialStringTok{"}
\NormalTok{            )}
        
        \ControlFlowTok{if} \VariableTok{self}\NormalTok{.fmt }\OperatorTok{==} \StringTok{\textquotesingle{}parquet\textquotesingle{}}\NormalTok{:}
\NormalTok{            df }\OperatorTok{=}\NormalTok{ pd.read\_parquet(filepath)}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            df }\OperatorTok{=}\NormalTok{ pd.read\_csv(filepath, parse\_dates}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
        
        \CommentTok{\# Auto{-}detect and parse date columns}
        \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ df.columns:}
            \ControlFlowTok{if} \StringTok{\textquotesingle{}date\textquotesingle{}} \KeywordTok{in}\NormalTok{ col.lower() }\KeywordTok{or}\NormalTok{ col.lower() }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}record\_date\textquotesingle{}}\NormalTok{]:}
                \ControlFlowTok{try}\NormalTok{:}
\NormalTok{                    df[col] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(df[col])}
                \ControlFlowTok{except}\NormalTok{ (}\PreprocessorTok{ValueError}\NormalTok{, }\PreprocessorTok{TypeError}\NormalTok{):}
                    \ControlFlowTok{pass}
        
        \VariableTok{self}\NormalTok{.\_cache[key] }\OperatorTok{=}\NormalTok{ df}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Loaded }\SpecialCharTok{\{}\NormalTok{key}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df)}\SpecialCharTok{:,\}}\SpecialStringTok{ rows, }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df.columns)}\SpecialCharTok{\}}\SpecialStringTok{ columns"}\NormalTok{)}
        \ControlFlowTok{return}\NormalTok{ df}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ prices(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}prices\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ ownership(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}ownership\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ major\_shareholders(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}major\_shareholders\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ corporate\_actions(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}corporate\_actions\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ company\_profile(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}company\_profile\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ financials(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}financials\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ foreign\_ownership(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}foreign\_ownership\textquotesingle{}}\NormalTok{)}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ fund\_holdings(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.\_read(}\StringTok{\textquotesingle{}fund\_holdings\textquotesingle{}}\NormalTok{)}
    
    \KeywordTok{def}\NormalTok{ clear\_cache(}\VariableTok{self}\NormalTok{):}
        \CommentTok{"""Clear all cached datasets to free memory."""}
        \VariableTok{self}\NormalTok{.\_cache.clear()}

\CommentTok{\# Initialize reader  adjust path to your local DataCore.vn data}
\CommentTok{\# dc = DataCoreReader(\textquotesingle{}/path/to/datacore\_data\textquotesingle{}, file\_format=\textquotesingle{}parquet\textquotesingle{})}
\end{Highlighting}
\end{Shaded}

This chapter proceeds as follows. Section~\ref{sec-data-pipeline} builds
the complete data pipeline from raw DataCore.vn extracts to clean,
analysis-ready datasets, with particular attention to corporate action
adjustments. Section~\ref{sec-ownership-taxonomy} defines Vietnam's
unique ownership taxonomy. Section~\ref{sec-ownership-metrics} computes
institutional ownership ratios, concentration, and breadth for the
Vietnamese market. Section~\ref{sec-foreign-ownership} develops
specialized foreign ownership analytics including FOL utilization and
room premium. Section~\ref{sec-trades} derives institutional trades from
ownership disclosure snapshots. Section~\ref{sec-flows-turnover}
computes fund-level flows and turnover.
Section~\ref{sec-state-ownership} analyzes state ownership dynamics.
Section~\ref{sec-modern-extensions} introduces network analysis, ML
classification, and event-study frameworks.
Section~\ref{sec-empirical-applications} presents complete empirical
applications, and Section~\ref{sec-conclusion} concludes.

\section{Data Pipeline}\label{sec-data-pipeline}

\subsection{Stock Price Data and Corporate Action
Adjustments}\label{sec-price-pipeline}

Vietnam's equity market is notorious for frequent corporate actions,
particularly stock dividends and bonus share issuances, that
dramatically alter share counts. A company issuing a 30\% stock dividend
means every 100 shares become 130 shares, and the reference price
adjusts downward proportionally. Failure to properly adjust historical
shares and prices for these events is the single most common source of
error in Vietnamese equity research.

\phantomsection\label{corporate-actions}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 1: Corporate Action Adjustment Factors}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ build\_adjustment\_factors(corporate\_actions: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Build cumulative adjustment factors from the corporate actions history.}
\CommentTok{    }
\CommentTok{    In Vietnam, the most common share{-}altering corporate actions are:}
\CommentTok{    1. Stock dividends (c tc bng c phiu): e.g., 30\%  ratio = 0.30}
\CommentTok{       Effect: shares  (1 + 0.30), price  (1 / 1.30)}
\CommentTok{    2. Bonus shares (thng c phiu): mechanically identical to stock dividends}
\CommentTok{    3. Stock splits (chia tch): e.g., 2:1  ratio = 2.0}
\CommentTok{       Effect: shares  2, price  0.5}
\CommentTok{    4. Rights issues (pht hnh thm): dilutive, but not all shareholders exercise}
\CommentTok{       We approximate with the subscription ratio}
\CommentTok{    5. Reverse splits (gp c phiu): rare in Vietnam}
\CommentTok{       Effect: shares  ratio, price  ratio}
\CommentTok{    }
\CommentTok{    We construct a FORWARD{-}LOOKING cumulative adjustment factor such that:}
\CommentTok{       adjusted\_shares = raw\_shares  cum\_adj\_factor(from\_date, to\_date)}
\CommentTok{       adjusted\_price = raw\_price / cum\_adj\_factor(from\_date, to\_date)}
\CommentTok{    }
\CommentTok{    This is analogous to CRSP\textquotesingle{}s cfacshr in the US context.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    corporate\_actions : pd.DataFrame}
\CommentTok{        DataCore.vn corporate actions with columns:}
\CommentTok{        ticker, ex\_date, action\_type, ratio}
\CommentTok{        }
\CommentTok{        action\_type values:}
\CommentTok{        {-} \textquotesingle{}stock\_dividend\textquotesingle{}: ratio = dividend rate (e.g., 0.30 for 30\%)}
\CommentTok{        {-} \textquotesingle{}bonus\_shares\textquotesingle{}: ratio = bonus rate (e.g., 0.20 for 20\%)}
\CommentTok{        {-} \textquotesingle{}stock\_split\textquotesingle{}: ratio = split factor (e.g., 2.0 for 2:1)}
\CommentTok{        {-} \textquotesingle{}reverse\_split\textquotesingle{}: ratio = merge factor (e.g., 5.0 for 5:1 merge)}
\CommentTok{        {-} \textquotesingle{}rights\_issue\textquotesingle{}: ratio = subscription rate (e.g., 0.10 for 10:1)}
\CommentTok{        {-} \textquotesingle{}cash\_dividend\textquotesingle{}: ratio = VND per share (no share adjustment needed)}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Adjustment factors: ticker, ex\_date, point\_factor, cum\_factor}
\CommentTok{    """}
    \CommentTok{\# Filter to share{-}altering events only}
\NormalTok{    share\_events }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}stock\_dividend\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bonus\_shares\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}stock\_split\textquotesingle{}}\NormalTok{, }
                    \StringTok{\textquotesingle{}reverse\_split\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}rights\_issue\textquotesingle{}}\NormalTok{]}
\NormalTok{    ca }\OperatorTok{=}\NormalTok{ corporate\_actions[}
\NormalTok{        corporate\_actions[}\StringTok{\textquotesingle{}action\_type\textquotesingle{}}\NormalTok{].isin(share\_events)}
\NormalTok{    ].copy()}
    
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(ca) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"No share{-}altering corporate actions found."}\NormalTok{)}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}cum\_factor\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Compute point adjustment factor for each event}
    \KeywordTok{def}\NormalTok{ compute\_point\_factor(row):}
\NormalTok{        atype }\OperatorTok{=}\NormalTok{ row[}\StringTok{\textquotesingle{}action\_type\textquotesingle{}}\NormalTok{]}
\NormalTok{        ratio }\OperatorTok{=}\NormalTok{ row[}\StringTok{\textquotesingle{}ratio\textquotesingle{}}\NormalTok{]}
        
        \ControlFlowTok{if}\NormalTok{ atype }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}stock\_dividend\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bonus\_shares\textquotesingle{}}\NormalTok{]:}
            \CommentTok{\# 30\% stock dividend: 100 shares  130 shares}
            \ControlFlowTok{return} \DecValTok{1} \OperatorTok{+}\NormalTok{ ratio}
        \ControlFlowTok{elif}\NormalTok{ atype }\OperatorTok{==} \StringTok{\textquotesingle{}stock\_split\textquotesingle{}}\NormalTok{:}
            \CommentTok{\# 2:1 split: 100 shares  200 shares}
            \ControlFlowTok{return}\NormalTok{ ratio}
        \ControlFlowTok{elif}\NormalTok{ atype }\OperatorTok{==} \StringTok{\textquotesingle{}reverse\_split\textquotesingle{}}\NormalTok{:}
            \CommentTok{\# 5:1 reverse: 500 shares  100 shares}
            \ControlFlowTok{return} \FloatTok{1.0} \OperatorTok{/}\NormalTok{ ratio}
        \ControlFlowTok{elif}\NormalTok{ atype }\OperatorTok{==} \StringTok{\textquotesingle{}rights\_issue\textquotesingle{}}\NormalTok{:}
            \CommentTok{\# Approximate: assume all rights exercised}
            \CommentTok{\# In practice, this overestimates the adjustment}
            \ControlFlowTok{return} \DecValTok{1} \OperatorTok{+}\NormalTok{ ratio}
        \ControlFlowTok{else}\NormalTok{:}
            \ControlFlowTok{return} \FloatTok{1.0}
    
\NormalTok{    ca[}\StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ca.}\BuiltInTok{apply}\NormalTok{(compute\_point\_factor, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Sort chronologically within each ticker}
\NormalTok{    ca }\OperatorTok{=}\NormalTok{ ca.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Cumulative factor: product of all point factors from listing to date}
    \CommentTok{\# This gives us a running "total adjustment" for each ticker}
\NormalTok{    ca[}\StringTok{\textquotesingle{}cum\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ca.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{].cumprod()}
    
    \CommentTok{\# Summary statistics}
\NormalTok{    n\_tickers }\OperatorTok{=}\NormalTok{ ca[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].nunique()}
\NormalTok{    n\_events }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(ca)}
\NormalTok{    avg\_events }\OperatorTok{=}\NormalTok{ n\_events }\OperatorTok{/}\NormalTok{ n\_tickers }\ControlFlowTok{if}\NormalTok{ n\_tickers }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else} \DecValTok{0}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Corporate action adjustment factors built:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Tickers with adjustments: }\SpecialCharTok{\{}\NormalTok{n\_tickers}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Total share{-}altering events: }\SpecialCharTok{\{}\NormalTok{n\_events}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Average events per ticker: }\SpecialCharTok{\{}\NormalTok{avg\_events}\SpecialCharTok{:.1f\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Event type distribution:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(ca[}\StringTok{\textquotesingle{}action\_type\textquotesingle{}}\NormalTok{].value\_counts().to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ ca[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}action\_type\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ratio\textquotesingle{}}\NormalTok{, }
               \StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}cum\_factor\textquotesingle{}}\NormalTok{]]}


\KeywordTok{def}\NormalTok{ adjust\_shares(shares: }\BuiltInTok{float}\NormalTok{, ticker: }\BuiltInTok{str}\NormalTok{, from\_date, to\_date, }
\NormalTok{                  adj\_factors: pd.DataFrame) }\OperatorTok{{-}\textgreater{}} \BuiltInTok{float}\NormalTok{:}
    \CommentTok{"""}
\CommentTok{    Adjust a share count from one date to another for corporate actions.}
\CommentTok{    }
\CommentTok{    Example: If a company had a 30\% stock dividend with ex\_date between}
\CommentTok{    from\_date and to\_date, then 1000 shares at from\_date = 1300 shares }
\CommentTok{    at to\_date.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    shares : float}
\CommentTok{        Number of shares at from\_date}
\CommentTok{    ticker : str}
\CommentTok{        Stock ticker}
\CommentTok{    from\_date, to\_date : pd.Timestamp}
\CommentTok{        Period for adjustment}
\CommentTok{    adj\_factors : pd.DataFrame}
\CommentTok{        Output of build\_adjustment\_factors()}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    float}
\CommentTok{        Adjusted shares at to\_date}
\CommentTok{    """}
\NormalTok{    events }\OperatorTok{=}\NormalTok{ adj\_factors[}
\NormalTok{        (adj\_factors[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker) }\OperatorTok{\&}
\NormalTok{        (adj\_factors[}\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ pd.Timestamp(from\_date)) }\OperatorTok{\&}
\NormalTok{        (adj\_factors[}\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=}\NormalTok{ pd.Timestamp(to\_date))}
\NormalTok{    ]}
    
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(events) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ shares}
    
\NormalTok{    total\_factor }\OperatorTok{=}\NormalTok{ events[}\StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{].prod()}
    \ControlFlowTok{return}\NormalTok{ shares }\OperatorTok{*}\NormalTok{ total\_factor}


\CommentTok{\# Example usage:}
\CommentTok{\# adj\_factors = build\_adjustment\_factors(dc.corporate\_actions)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, opacitybacktitle=0.6, opacityback=0, colframe=quarto-callout-important-color-frame, leftrule=.75mm, colback=white, left=2mm, bottomtitle=1mm, colbacktitle=quarto-callout-important-color!10!white, breakable, rightrule=.15mm, toprule=.15mm, bottomrule=.15mm, toptitle=1mm, titlerule=0mm, title=\textcolor{quarto-callout-important-color}{\faExclamation}\hspace{0.5em}{The Stock Dividend Problem in Vietnam}, arc=.35mm, coltitle=black]

Vietnamese companies issue stock dividends with remarkable frequency,
many growth companies do so 2-3 times per year. Consider
\textbf{Vinhomes (VHM)} or \textbf{FPT Corporation}: their share counts
may double or triple over a 5-year period purely from stock dividends.
If you compare raw ownership shares from 2019 to 2024 without
adjustment, you will obtain nonsensical ownership ratios. \textbf{Every
time-series analysis of Vietnamese ownership data must use adjusted
shares.} This is the Vietnamese equivalent of the CRSP cfacshr
adjustment factor problem in US data, but more severe because the events
are more frequent and larger in magnitude.

\end{tcolorbox}

\phantomsection\label{price-processing}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 2: Process Stock Price Data}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ process\_price\_data(prices: pd.DataFrame, }
\NormalTok{                       adj\_factors: pd.DataFrame,}
\NormalTok{                       company\_profile: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Process DataCore.vn stock price data:}
\CommentTok{    1. Align dates to month{-}end and quarter{-}end}
\CommentTok{    2. Merge company metadata (exchange, sector, FOL limit)}
\CommentTok{    3. Compute adjusted prices and shares outstanding}
\CommentTok{    4. Compute market capitalization}
\CommentTok{    5. Create quarter{-}end snapshots}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    prices : pd.DataFrame}
\CommentTok{        Daily/monthly price data from DataCore.vn}
\CommentTok{    adj\_factors : pd.DataFrame}
\CommentTok{        Corporate action adjustment factors}
\CommentTok{    company\_profile : pd.DataFrame}
\CommentTok{        Company metadata including exchange, sector, FOL}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Quarter{-}end processed stock data}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ prices.copy()}
    
    \CommentTok{\# Standardize date}
\NormalTok{    df[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(df[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{    df[}\StringTok{\textquotesingle{}month\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.MonthEnd(}\DecValTok{0}\NormalTok{)}
\NormalTok{    df[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.QuarterEnd(}\DecValTok{0}\NormalTok{)}
    
    \CommentTok{\# Merge company profile}
\NormalTok{    profile\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}exchange\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}industry\_code\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fol\_limit\textquotesingle{}}\NormalTok{, }
                    \StringTok{\textquotesingle{}listing\_date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}company\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{    profile\_cols }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ profile\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ company\_profile.columns]}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.merge(company\_profile[profile\_cols], on}\OperatorTok{=}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Build cumulative adjustment factor for each ticker{-}date}
    \CommentTok{\# For each observation, compute the total adjustment from listing to that date}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Merge adjustment events}
    \CommentTok{\# For each ticker{-}date, find the cumulative factor as of that date}
    \KeywordTok{def}\NormalTok{ get\_cum\_factor\_at\_date(group):}
\NormalTok{        ticker }\OperatorTok{=}\NormalTok{ group.name}
\NormalTok{        ticker\_adj }\OperatorTok{=}\NormalTok{ adj\_factors[adj\_factors[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker].copy()}
        
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(ticker\_adj) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{            group[}\StringTok{\textquotesingle{}cum\_adj\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \FloatTok{1.0}
            \ControlFlowTok{return}\NormalTok{ group}
        
        \CommentTok{\# For each date, find cumulative factor (product of all events up to that date)}
\NormalTok{        group }\OperatorTok{=}\NormalTok{ group.sort\_values(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{)}
\NormalTok{        group[}\StringTok{\textquotesingle{}cum\_adj\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \FloatTok{1.0}
        
        \ControlFlowTok{for}\NormalTok{ \_, event }\KeywordTok{in}\NormalTok{ ticker\_adj.iterrows():}
\NormalTok{            mask }\OperatorTok{=}\NormalTok{ group[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=}\NormalTok{ event[}\StringTok{\textquotesingle{}ex\_date\textquotesingle{}}\NormalTok{]}
\NormalTok{            group.loc[mask, }\StringTok{\textquotesingle{}cum\_adj\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{*=}\NormalTok{ event[}\StringTok{\textquotesingle{}point\_factor\textquotesingle{}}\NormalTok{]}
        
        \ControlFlowTok{return}\NormalTok{ group}
    
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{False}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(get\_cum\_factor\_at\_date)}
    
    \CommentTok{\# Adjusted price and shares}
    \CommentTok{\# adjusted\_close should already be provided by DataCore.vn}
    \CommentTok{\# But we compute our own for consistency}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}adjusted\_close\textquotesingle{}} \KeywordTok{not} \KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{        df[}\StringTok{\textquotesingle{}adjusted\_close\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}cum\_adj\_factor\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# Adjusted shares outstanding}
\NormalTok{    df[}\StringTok{\textquotesingle{}adjusted\_shares\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}shares\_outstanding\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ df[}\StringTok{\textquotesingle{}cum\_adj\_factor\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# Market capitalization (in billion VND)}
\NormalTok{    df[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ df[}\StringTok{\textquotesingle{}shares\_outstanding\textquotesingle{}}\NormalTok{] }\OperatorTok{/} \FloatTok{1e9}
    
    \CommentTok{\# Monthly returns}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{    df[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}adjusted\_close\textquotesingle{}}\NormalTok{].pct\_change()}
    
    \CommentTok{\# Keep quarter{-}end observations}
    \CommentTok{\# For daily data: keep last trading day of each quarter}
\NormalTok{    df\_quarterly }\OperatorTok{=}\NormalTok{ (df.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{                      .groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{])}
\NormalTok{                      .last()}
\NormalTok{                      .reset\_index())}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Processed price data:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Total records (daily): }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Quarter{-}end records: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(df\_quarterly)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Unique tickers: }\SpecialCharTok{\{}\NormalTok{df\_quarterly[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Date range: }\SpecialCharTok{\{}\NormalTok{df\_quarterly[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{ to "}
          \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{df\_quarterly[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Exchange distribution:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(df\_quarterly.groupby(}\StringTok{\textquotesingle{}exchange\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].nunique().to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ df\_quarterly}

\CommentTok{\# prices\_q = process\_price\_data(dc.prices, adj\_factors, dc.company\_profile)}
\end{Highlighting}
\end{Shaded}

\subsection{Ownership Structure Data}\label{sec-ownership-data}

Vietnamese ownership data from DataCore.vn captures the composition of
shareholders as disclosed in annual reports, semi-annual reports, and
event-driven disclosures. The key distinction from US 13F data is that
Vietnamese disclosures provide a \textbf{complete ownership
decomposition}, not just institutional long positions, but the full
breakdown into state, institutional, foreign, and individual ownership.

\phantomsection\label{ownership-processing}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 3: Process Ownership Structure Data}
\CommentTok{\# ============================================================================}

\KeywordTok{class}\NormalTok{ OwnershipType:}
    \CommentTok{"""}
\CommentTok{    Vietnam\textquotesingle{}s ownership taxonomy.}
\CommentTok{    }
\CommentTok{    Unlike the US where 13F captures only institutional long positions,}
\CommentTok{    Vietnamese disclosure provides a complete ownership decomposition.}
\CommentTok{    We classify shareholders into five mutually exclusive categories.}
\CommentTok{    """}
\NormalTok{    STATE }\OperatorTok{=} \StringTok{\textquotesingle{}state\textquotesingle{}}                    \CommentTok{\# Nh nc (government entities, SOE parents)}
\NormalTok{    FOREIGN\_INST }\OperatorTok{=} \StringTok{\textquotesingle{}foreign\_inst\textquotesingle{}}      \CommentTok{\# T chc nc ngoi}
\NormalTok{    DOMESTIC\_INST }\OperatorTok{=} \StringTok{\textquotesingle{}domestic\_inst\textquotesingle{}}    \CommentTok{\# T chc trong nc (non{-}state)}
\NormalTok{    INDIVIDUAL }\OperatorTok{=} \StringTok{\textquotesingle{}individual\textquotesingle{}}          \CommentTok{\# C nhn}
\NormalTok{    TREASURY }\OperatorTok{=} \StringTok{\textquotesingle{}treasury\textquotesingle{}}              \CommentTok{\# C phiu qu}
    
\NormalTok{    ALL\_TYPES }\OperatorTok{=}\NormalTok{ [STATE, FOREIGN\_INST, DOMESTIC\_INST, INDIVIDUAL, TREASURY]}
\NormalTok{    INSTITUTIONAL }\OperatorTok{=}\NormalTok{ [STATE, FOREIGN\_INST, DOMESTIC\_INST]}
\NormalTok{    FOREIGN }\OperatorTok{=}\NormalTok{ [FOREIGN\_INST]  }\CommentTok{\# Can be expanded if foreign individuals are tracked}


\KeywordTok{def}\NormalTok{ classify\_shareholders(ownership: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Classify shareholders into Vietnam\textquotesingle{}s ownership taxonomy.}
\CommentTok{    }
\CommentTok{    DataCore.vn may provide a \textasciigrave{}shareholder\_type\textasciigrave{} field, but naming }
\CommentTok{    conventions vary. This function standardizes the classification }
\CommentTok{    using a combination of provided flags and name{-}based heuristics.}
\CommentTok{    }
\CommentTok{    The classification challenge in Vietnam (noted by @huang2023factors):}
\CommentTok{    DataCore.vn may not always cleanly separate institution types, so we }
\CommentTok{    use a cascading approach:}
\CommentTok{    1. Use explicit flags (is\_state, is\_foreign, is\_institution) if available}
\CommentTok{    2. Apply name{-}based heuristics for Vietnamese entity names}
\CommentTok{    3. Default to \textquotesingle{}individual\textquotesingle{} for unclassified shareholders}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    ownership : pd.DataFrame}
\CommentTok{        Raw ownership data from DataCore.vn}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Ownership data with standardized \textasciigrave{}owner\_type\textasciigrave{} column}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ ownership.copy()}
    
    \CommentTok{\# {-}{-}{-} Method 1: Use explicit flags if available {-}{-}{-}}
    \ControlFlowTok{if} \BuiltInTok{all}\NormalTok{(col }\KeywordTok{in}\NormalTok{ df.columns }\ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}is\_institution\textquotesingle{}}\NormalTok{]):}
\NormalTok{        conditions }\OperatorTok{=}\NormalTok{ [}
\NormalTok{            (df[}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \VariableTok{True}\NormalTok{),}
\NormalTok{            (df[}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \VariableTok{True}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (df[}\StringTok{\textquotesingle{}is\_institution\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \VariableTok{True}\NormalTok{),}
\NormalTok{            (df[}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \VariableTok{True}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (df[}\StringTok{\textquotesingle{}is\_institution\textquotesingle{}}\NormalTok{] }\OperatorTok{!=} \VariableTok{True}\NormalTok{),}
\NormalTok{            (df[}\StringTok{\textquotesingle{}is\_institution\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \VariableTok{True}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (df[}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{!=} \VariableTok{True}\NormalTok{) }\OperatorTok{\&} 
\NormalTok{                (df[}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{!=} \VariableTok{True}\NormalTok{),}
\NormalTok{        ]}
\NormalTok{        choices }\OperatorTok{=}\NormalTok{ [}
\NormalTok{            OwnershipType.STATE,}
\NormalTok{            OwnershipType.FOREIGN\_INST,}
\NormalTok{            OwnershipType.FOREIGN\_INST,  }\CommentTok{\# Foreign individuals often grouped}
\NormalTok{            OwnershipType.DOMESTIC\_INST,}
\NormalTok{        ]}
\NormalTok{        df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.select(conditions, choices, }
\NormalTok{                                      default}\OperatorTok{=}\NormalTok{OwnershipType.INDIVIDUAL)}
    
    \CommentTok{\# {-}{-}{-} Method 2: Name{-}based heuristics {-}{-}{-}}
    \ControlFlowTok{elif} \StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}} \KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{        name }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{].}\BuiltInTok{str}\NormalTok{.lower().fillna(}\StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
        
        \CommentTok{\# State entities: government ministries, SCIC, state corporations}
\NormalTok{        state\_keywords }\OperatorTok{=}\NormalTok{ [}
            \StringTok{\textquotesingle{}b ti chnh\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}tng cng ty u t\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}scic\textquotesingle{}}\NormalTok{, }
            \StringTok{\textquotesingle{}y ban nhn dn\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nh nc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}state capital\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}tng cng ty\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vn nh nc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b cng thng\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}b quc phng\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b giao thng\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vinashin\textquotesingle{}}\NormalTok{,}
\NormalTok{        ]}
\NormalTok{        is\_state }\OperatorTok{=}\NormalTok{ name.}\BuiltInTok{apply}\NormalTok{(}
            \KeywordTok{lambda}\NormalTok{ x: }\BuiltInTok{any}\NormalTok{(kw }\KeywordTok{in}\NormalTok{ x }\ControlFlowTok{for}\NormalTok{ kw }\KeywordTok{in}\NormalTok{ state\_keywords)}
\NormalTok{        )}
        
        \CommentTok{\# Foreign entities: common fund names, foreign company patterns}
\NormalTok{        foreign\_keywords }\OperatorTok{=}\NormalTok{ [}
            \StringTok{\textquotesingle{}fund\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}investment\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}capital\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}limited\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ltd\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}inc\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}corporation\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}holdings\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}asset management\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pte\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}gmbh\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}management\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}partners\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}advisors\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}dragon capital\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vinacapital\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}templeton\textquotesingle{}}\NormalTok{, }
            \StringTok{\textquotesingle{}blackrock\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}jpmorgan\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}samsung\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mirae\textquotesingle{}}\NormalTok{,}
\NormalTok{        ]}
        \CommentTok{\# Also check for non{-}Vietnamese characters as a heuristic}
\NormalTok{        is\_foreign\_name }\OperatorTok{=}\NormalTok{ name.}\BuiltInTok{apply}\NormalTok{(}
            \KeywordTok{lambda}\NormalTok{ x: }\BuiltInTok{any}\NormalTok{(kw }\KeywordTok{in}\NormalTok{ x }\ControlFlowTok{for}\NormalTok{ kw }\KeywordTok{in}\NormalTok{ foreign\_keywords)}
\NormalTok{        )}
        
        \CommentTok{\# Domestic institutions: Vietnamese bank, securities, insurance names}
\NormalTok{        domestic\_inst\_keywords }\OperatorTok{=}\NormalTok{ [}
            \StringTok{\textquotesingle{}ngn hng\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}chng khon\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bo him\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}qu u t\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}cng ty qun l\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bo vit\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}techcombank\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vietcombank\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}bidv\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vietinbank\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vpbank\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mb bank\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ssi\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}hsc\textquotesingle{}}\NormalTok{,}
            \StringTok{\textquotesingle{}vcsc\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}vndirect\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fpt capital\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}manulife\textquotesingle{}}\NormalTok{,}
\NormalTok{        ]}
\NormalTok{        is\_domestic\_inst }\OperatorTok{=}\NormalTok{ name.}\BuiltInTok{apply}\NormalTok{(}
            \KeywordTok{lambda}\NormalTok{ x: }\BuiltInTok{any}\NormalTok{(kw }\KeywordTok{in}\NormalTok{ x }\ControlFlowTok{for}\NormalTok{ kw }\KeywordTok{in}\NormalTok{ domestic\_inst\_keywords)}
\NormalTok{        )}
        
        \CommentTok{\# Treasury shares}
\NormalTok{        is\_treasury }\OperatorTok{=}\NormalTok{ name.}\BuiltInTok{str}\NormalTok{.contains(}\StringTok{\textquotesingle{}c phiu qu|treasury\textquotesingle{}}\NormalTok{, case}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
        
        \CommentTok{\# Apply classification cascade}
\NormalTok{        df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ OwnershipType.INDIVIDUAL  }\CommentTok{\# Default}
\NormalTok{        df.loc[is\_domestic\_inst, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ OwnershipType.DOMESTIC\_INST}
\NormalTok{        df.loc[is\_foreign\_name, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ OwnershipType.FOREIGN\_INST}
\NormalTok{        df.loc[is\_state, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ OwnershipType.STATE}
\NormalTok{        df.loc[is\_treasury, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ OwnershipType.TREASURY}
    
    \CommentTok{\# {-}{-}{-} Method 3: Use shareholder\_type directly {-}{-}{-}}
    \ControlFlowTok{elif} \StringTok{\textquotesingle{}shareholder\_type\textquotesingle{}} \KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{        type\_map }\OperatorTok{=}\NormalTok{ \{}
            \StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{: OwnershipType.STATE,}
            \StringTok{\textquotesingle{}foreign\_institution\textquotesingle{}}\NormalTok{: OwnershipType.FOREIGN\_INST,}
            \StringTok{\textquotesingle{}foreign\_individual\textquotesingle{}}\NormalTok{: OwnershipType.FOREIGN\_INST,}
            \StringTok{\textquotesingle{}domestic\_institution\textquotesingle{}}\NormalTok{: OwnershipType.DOMESTIC\_INST,}
            \StringTok{\textquotesingle{}individual\textquotesingle{}}\NormalTok{: OwnershipType.INDIVIDUAL,}
            \StringTok{\textquotesingle{}treasury\textquotesingle{}}\NormalTok{: OwnershipType.TREASURY,}
\NormalTok{        \}}
\NormalTok{        df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}shareholder\_type\textquotesingle{}}\NormalTok{].}\BuiltInTok{str}\NormalTok{.lower().}\BuiltInTok{map}\NormalTok{(type\_map)}
\NormalTok{        df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].fillna(OwnershipType.INDIVIDUAL)}
    
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}
            \StringTok{"Cannot classify shareholders. Expected one of:}\CharTok{\textbackslash{}n}\StringTok{"}
            \StringTok{"  1. Columns: is\_state, is\_foreign, is\_institution}\CharTok{\textbackslash{}n}\StringTok{"}
            \StringTok{"  2. Column: shareholder\_name (for heuristic classification)}\CharTok{\textbackslash{}n}\StringTok{"}
            \StringTok{"  3. Column: shareholder\_type (pre{-}classified)"}
\NormalTok{        )}
    
    \CommentTok{\# Summary}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Ownership classification results:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(df[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].value\_counts().to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ df}

\CommentTok{\# ownership\_classified = classify\_shareholders(dc.ownership)}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Vietnam's Ownership Taxonomy}\label{sec-ownership-taxonomy}

\subsection{The Five Ownership
Categories}\label{the-five-ownership-categories}

Vietnam's ownership structure is decomposed into five mutually exclusive
categories that together sum to 100\% of shares outstanding:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2603}}@{}}
\caption{Vietnam's Ownership
Taxonomy}\label{tbl-ownership-taxonomy}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Category
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Vietnamese Term
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Description
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Typical Share (2020s)
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Category
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Vietnamese Term
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Description
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Typical Share (2020s)
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{State} & S hu Nh nc & Government entities, SCIC, SOE parent
companies & \textasciitilde15-25\% of market cap \\
\textbf{Foreign Institutional} & T chc nc ngoi & Foreign funds,
banks, corporations & \textasciitilde15-20\% \\
\textbf{Domestic Institutional} & T chc trong nc & Vietnamese funds,
banks, insurance, securities firms & \textasciitilde5-10\% \\
\textbf{Individual} & C nhn & Retail investors (both Vietnamese and
foreign individuals) & \textasciitilde55-65\% \\
\textbf{Treasury} & C phiu qu & Company's own repurchased shares &
\textasciitilde0-2\% \\
\end{longtable}

This taxonomy differs fundamentally from the US 13F framework in several
ways:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Completeness:} We observe 100\% of ownership, not just
  institutional long positions above \$100 million AUM.
\item
  \textbf{State as a category:} State ownership is a first-class
  analytical category, not subsumed under ``All Others'' as in the LSEG
  type code system.
\item
  \textbf{Individual visibility:} We observe aggregate individual
  ownership directly, whereas in the US, individual ownership is merely
  the residual (100\%  institutional ownership).
\item
  \textbf{No short position ambiguity:} Vietnam's market has very
  limited short-selling infrastructure, so ownership data genuinely
  represents long positions.
\end{enumerate}

\phantomsection\label{ownership-decomposition}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 4: Compute Ownership Decomposition}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ compute\_ownership\_decomposition(ownership: pd.DataFrame,}
\NormalTok{                                     prices\_q: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Compute the full ownership decomposition for each stock at each }
\CommentTok{    disclosure date.}
\CommentTok{    }
\CommentTok{    For each stock{-}date combination, aggregates shares held by each }
\CommentTok{    ownership category and computes ownership ratios relative to }
\CommentTok{    total shares outstanding.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    ownership : pd.DataFrame}
\CommentTok{        Classified ownership data (output of classify\_shareholders)}
\CommentTok{    prices\_q : pd.DataFrame}
\CommentTok{        Quarter{-}end price data with shares\_outstanding}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Stock{-}period level ownership decomposition with columns for}
\CommentTok{        each ownership type\textquotesingle{}s share count and percentage}
\CommentTok{    """}
    \CommentTok{\# Aggregate shares by ticker, date, and owner type}
\NormalTok{    agg }\OperatorTok{=}\NormalTok{ (ownership.groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{]}
\NormalTok{                    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{                    .reset\_index())}
    
    \CommentTok{\# Pivot to wide format: one column per ownership type}
\NormalTok{    wide }\OperatorTok{=}\NormalTok{ agg.pivot\_table(}
\NormalTok{        index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{],}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{,}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{,}
\NormalTok{        fill\_value}\OperatorTok{=}\DecValTok{0}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# Rename columns}
\NormalTok{    type\_cols }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ wide.columns }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ OwnershipType.ALL\_TYPES]}
\NormalTok{    rename\_map }\OperatorTok{=}\NormalTok{ \{t: }\SpecialStringTok{f\textquotesingle{}shares\_}\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ type\_cols\}}
\NormalTok{    wide }\OperatorTok{=}\NormalTok{ wide.rename(columns}\OperatorTok{=}\NormalTok{rename\_map)}
    
    \CommentTok{\# Total institutional shares}
\NormalTok{    inst\_cols }\OperatorTok{=}\NormalTok{ [}\SpecialStringTok{f\textquotesingle{}shares\_}\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ OwnershipType.INSTITUTIONAL }
                 \ControlFlowTok{if} \SpecialStringTok{f\textquotesingle{}shares\_}\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \KeywordTok{in}\NormalTok{ wide.columns]}
\NormalTok{    wide[}\StringTok{\textquotesingle{}shares\_institutional\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ wide[inst\_cols].}\BuiltInTok{sum}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Total foreign shares (for FOL tracking)}
\NormalTok{    foreign\_cols }\OperatorTok{=}\NormalTok{ [}\SpecialStringTok{f\textquotesingle{}shares\_}\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ OwnershipType.FOREIGN }
                    \ControlFlowTok{if} \SpecialStringTok{f\textquotesingle{}shares\_}\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \KeywordTok{in}\NormalTok{ wide.columns]}
\NormalTok{    wide[}\StringTok{\textquotesingle{}shares\_foreign\_total\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ wide[foreign\_cols].}\BuiltInTok{sum}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Align with quarter{-}end dates for merging with price data}
\NormalTok{    wide[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ wide[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.QuarterEnd(}\DecValTok{0}\NormalTok{)}
    
    \CommentTok{\# Merge with price data to get shares outstanding}
\NormalTok{    merged }\OperatorTok{=}\NormalTok{ wide.merge(}
\NormalTok{        prices\_q[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shares\_outstanding\textquotesingle{}}\NormalTok{, }
                  \StringTok{\textquotesingle{}adjusted\_shares\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}exchange\textquotesingle{}}\NormalTok{, }
                  \StringTok{\textquotesingle{}industry\_code\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fol\_limit\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{]],}
\NormalTok{        on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}
\NormalTok{    )}
    
    \CommentTok{\# Compute ownership ratios}
\NormalTok{    tso }\OperatorTok{=}\NormalTok{ merged[}\StringTok{\textquotesingle{}shares\_outstanding\textquotesingle{}}\NormalTok{]}
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ merged.columns:}
        \ControlFlowTok{if}\NormalTok{ col.startswith(}\StringTok{\textquotesingle{}shares\_\textquotesingle{}}\NormalTok{) }\KeywordTok{and}\NormalTok{ col }\OperatorTok{!=} \StringTok{\textquotesingle{}shares\_outstanding\textquotesingle{}}\NormalTok{:}
\NormalTok{            ratio\_col }\OperatorTok{=}\NormalTok{ col.replace(}\StringTok{\textquotesingle{}shares\_\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_\textquotesingle{}}\NormalTok{)}
\NormalTok{            merged[ratio\_col] }\OperatorTok{=}\NormalTok{ merged[col] }\OperatorTok{/}\NormalTok{ tso}
\NormalTok{            merged.loc[tso }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, ratio\_col] }\OperatorTok{=}\NormalTok{ np.nan}
    
    \CommentTok{\# Derived measures}
\NormalTok{    merged[}\StringTok{\textquotesingle{}pct\_free\_float\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{1} \OperatorTok{{-}}\NormalTok{ merged.get(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\DecValTok{0}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ merged.get(}\StringTok{\textquotesingle{}pct\_treasury\textquotesingle{}}\NormalTok{, }\DecValTok{0}\NormalTok{)}
    
    \CommentTok{\# SOE flag: state ownership \textgreater{} 50\%}
\NormalTok{    merged[}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (merged.get(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\DecValTok{0}\NormalTok{) }\OperatorTok{\textgreater{}} \FloatTok{0.50}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
    
    \CommentTok{\# FOL utilization}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}fol\_limit\textquotesingle{}} \KeywordTok{in}\NormalTok{ merged.columns }\KeywordTok{and} \StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}} \KeywordTok{in}\NormalTok{ merged.columns:}
\NormalTok{        merged[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ merged[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ merged[}\StringTok{\textquotesingle{}fol\_limit\textquotesingle{}}\NormalTok{]}
\NormalTok{        merged[}\StringTok{\textquotesingle{}foreign\_room\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ merged[}\StringTok{\textquotesingle{}fol\_limit\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ merged[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{]}
\NormalTok{        merged.loc[merged[}\StringTok{\textquotesingle{}fol\_limit\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, [}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foreign\_room\textquotesingle{}}\NormalTok{]] }\OperatorTok{=}\NormalTok{ np.nan}
    
    \CommentTok{\# Number of institutional owners (breadth)}
\NormalTok{    n\_owners }\OperatorTok{=}\NormalTok{ (ownership[ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL)]}
\NormalTok{                .groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{                .nunique()}
\NormalTok{                .reset\_index()}
\NormalTok{                .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{\}))}
    
\NormalTok{    n\_foreign\_owners }\OperatorTok{=}\NormalTok{ (ownership[ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ OwnershipType.FOREIGN\_INST]}
\NormalTok{                        .groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{                        .nunique()}
\NormalTok{                        .reset\_index()}
\NormalTok{                        .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}n\_foreign\_owners\textquotesingle{}}\NormalTok{\}))}
    
\NormalTok{    merged }\OperatorTok{=}\NormalTok{ merged.merge(n\_owners, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{    merged }\OperatorTok{=}\NormalTok{ merged.merge(n\_foreign\_owners, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{    merged[[}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}n\_foreign\_owners\textquotesingle{}}\NormalTok{]] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        merged[[}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}n\_foreign\_owners\textquotesingle{}}\NormalTok{]].fillna(}\DecValTok{0}\NormalTok{)}
\NormalTok{    )}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Ownership decomposition computed:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Stock{-}period observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(merged)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Unique tickers: }\SpecialCharTok{\{}\NormalTok{merged[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Mean ownership structure:"}\NormalTok{)}
\NormalTok{    pct\_cols }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ merged.columns }\ControlFlowTok{if}\NormalTok{ c.startswith(}\StringTok{\textquotesingle{}pct\_\textquotesingle{}}\NormalTok{)]}
    \BuiltInTok{print}\NormalTok{(merged[pct\_cols].mean().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{).to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ merged}

\CommentTok{\# ownership\_decomp = compute\_ownership\_decomposition(}
\CommentTok{\#     ownership\_classified, prices\_q}
\CommentTok{\# )}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Institutional Ownership Measures}\label{sec-ownership-metrics}

\subsection{Ownership Ratio}\label{sec-io-ratio}

The \textbf{Institutional Ownership Ratio (IOR)} for stock \(i\) at time
\(t\) in Vietnam is:

\begin{equation}\phantomsection\label{eq-ior-vn}{
IOR_{i,t} = \frac{S_{i,t}^{state} + S_{i,t}^{foreign\_inst} + S_{i,t}^{domestic\_inst}}{TSO_{i,t}}
}\end{equation}

where \(S_{i,t}^{type}\) denotes adjusted shares held by each ownership
category and \(TSO_{i,t}\) is total shares outstanding. Unlike the US
where the IOR can exceed 100\% due to long-only reporting and short
selling, the Vietnamese IOR is bounded by construction in \([0, 1]\)
because we observe the complete ownership decomposition.

We also compute category-specific ownership ratios:

\begin{equation}\phantomsection\label{eq-ior-components}{
IOR_{i,t}^{foreign} = \frac{S_{i,t}^{foreign\_inst}}{TSO_{i,t}}, \quad
IOR_{i,t}^{state} = \frac{S_{i,t}^{state}}{TSO_{i,t}}, \quad
IOR_{i,t}^{domestic} = \frac{S_{i,t}^{domestic\_inst}}{TSO_{i,t}}
}\end{equation}

\subsection{Concentration: Herfindahl-Hirschman Index}\label{sec-hhi}

The \textbf{Institutional Ownership Concentration} via the
Herfindahl-Hirschman Index is:

\begin{equation}\phantomsection\label{eq-hhi-vn}{
IOC_{i,t}^{HHI} = \sum_{j=1}^{N_{i,t}} \left(\frac{S_{i,j,t}}{\sum_{k=1}^{N_{i,t}} S_{i,k,t}}\right)^2
}\end{equation}

In Vietnam, the HHI is particularly informative because it captures the
dominance of state shareholders. A company where the government holds
65\% will have a mechanically high HHI even if the remaining 35\% is
diversely held.

We therefore compute \textbf{separate HHI measures} for different
ownership categories:

\begin{equation}\phantomsection\label{eq-hhi-decomposed}{
HHI_{i,t}^{total} = \sum_{j} w_{i,j,t}^2, \quad
HHI_{i,t}^{non-state} = \sum_{j \notin state} \left(\frac{S_{i,j,t}}{\sum_{k \notin state} S_{i,k,t}}\right)^2
}\end{equation}

The non-state HHI is more comparable to the US institutional HHI, as it
captures concentration among market-driven investors.

\subsection{Breadth of Ownership}\label{sec-breadth}

Following Chen, Hong, and Stein (2002), \textbf{Institutional Breadth}
(\(N_{i,t}\)) is the number of institutional investors holding stock
\(i\) in period \(t\). The \textbf{Change in Breadth} is:

\begin{equation}\phantomsection\label{eq-dbreadth-vn}{
\Delta Breadth_{i,t} = \frac{N_{i,t}^{cont} - N_{i,t-1}^{cont}}{TotalInstitutions_{t-1}}
}\end{equation}

where \(N_{i,t}^{cont}\) counts only institutions that appear in the
disclosure universe in both periods \(t\) and \(t-1\), following the
Lehavy and Sloan (2008) algorithm. This adjustment is particularly
important in Vietnam where:

\begin{itemize}
\tightlist
\item
  New funds launch frequently (especially ETFs tracking VN30)
\item
  Foreign funds enter and exit the market
\item
  Domestic securities firms consolidate or spin off asset management
  divisions
\end{itemize}

\phantomsection\label{compute-all-metrics}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 5: Compute All IO Metrics}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ compute\_io\_metrics\_vietnam(ownership: pd.DataFrame,}
\NormalTok{                                ownership\_decomp: pd.DataFrame,}
\NormalTok{                                adj\_factors: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Compute security{-}level institutional ownership metrics adapted for Vietnam.}
\CommentTok{    }
\CommentTok{    Computes:}
\CommentTok{    1. Ownership ratios by category (state, foreign, domestic inst, individual)}
\CommentTok{    2. HHI concentration (total, non{-}state, foreign{-}only)}
\CommentTok{    3. Number of institutional owners (total, foreign, domestic)}
\CommentTok{    4. Change in breadth (Lehavy{-}Sloan adjusted)}
\CommentTok{    5. FOL{-}related metrics (utilization, room, near{-}cap indicator)}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    ownership : pd.DataFrame}
\CommentTok{        Classified ownership data with individual shareholder records}
\CommentTok{    ownership\_decomp : pd.DataFrame}
\CommentTok{        Aggregated ownership decomposition (output of compute\_ownership\_decomposition)}
\CommentTok{    adj\_factors : pd.DataFrame}
\CommentTok{        Corporate action adjustment factors}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Stock{-}period level metrics}
\CommentTok{    """}
    \CommentTok{\# Start with the ownership decomposition}
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ ownership\_decomp.copy()}
    
    \CommentTok{\# {-}{-}{-} HHI Concentration {-}{-}{-}}
    \CommentTok{\# Total HHI: across all institutional shareholders}
\NormalTok{    inst\_ownership }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL)}
\NormalTok{    ].copy()}
    
    \KeywordTok{def}\NormalTok{ compute\_hhi\_group(group):}
        \CommentTok{"""Compute HHI for a group of shareholders."""}
\NormalTok{        total }\OperatorTok{=}\NormalTok{ group[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{].}\BuiltInTok{sum}\NormalTok{()}
        \ControlFlowTok{if}\NormalTok{ total }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{:}
            \ControlFlowTok{return}\NormalTok{ np.nan}
\NormalTok{        weights }\OperatorTok{=}\NormalTok{ group[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ total}
        \ControlFlowTok{return}\NormalTok{ (weights }\OperatorTok{**} \DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{()}
    
    \CommentTok{\# Total institutional HHI}
\NormalTok{    hhi\_total }\OperatorTok{=}\NormalTok{ (inst\_ownership.groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{                               .}\BuiltInTok{apply}\NormalTok{(compute\_hhi\_group)}
\NormalTok{                               .reset\_index(name}\OperatorTok{=}\StringTok{\textquotesingle{}hhi\_institutional\textquotesingle{}}\NormalTok{))}
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ metrics.merge(hhi\_total, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Non{-}state HHI (exclude state shareholders)}
\NormalTok{    non\_state }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin([OwnershipType.FOREIGN\_INST, }
\NormalTok{                                       OwnershipType.DOMESTIC\_INST])}
\NormalTok{    ]}
\NormalTok{    hhi\_nonstate }\OperatorTok{=}\NormalTok{ (non\_state.groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{                             .}\BuiltInTok{apply}\NormalTok{(compute\_hhi\_group)}
\NormalTok{                             .reset\_index(name}\OperatorTok{=}\StringTok{\textquotesingle{}hhi\_non\_state\textquotesingle{}}\NormalTok{))}
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ metrics.merge(hhi\_nonstate, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Foreign{-}only HHI}
\NormalTok{    foreign\_only }\OperatorTok{=}\NormalTok{ ownership[ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ OwnershipType.FOREIGN\_INST]}
\NormalTok{    hhi\_foreign }\OperatorTok{=}\NormalTok{ (foreign\_only.groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{                               .}\BuiltInTok{apply}\NormalTok{(compute\_hhi\_group)}
\NormalTok{                               .reset\_index(name}\OperatorTok{=}\StringTok{\textquotesingle{}hhi\_foreign\textquotesingle{}}\NormalTok{))}
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ metrics.merge(hhi\_foreign, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# {-}{-}{-} Change in Breadth (Lehavy{-}Sloan Algorithm) {-}{-}{-}}
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ metrics.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Get list of all institutions filing in each period}
\NormalTok{    inst\_by\_period }\OperatorTok{=}\NormalTok{ (inst\_ownership.groupby(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{                                     .}\BuiltInTok{apply}\NormalTok{(}\BuiltInTok{set}\NormalTok{)}
\NormalTok{                                     .to\_dict())}
    
    \CommentTok{\# For each stock{-}period: count continuing institutions}
    \KeywordTok{def}\NormalTok{ compute\_breadth\_change(group):}
\NormalTok{        group }\OperatorTok{=}\NormalTok{ group.sort\_values(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        group[}\StringTok{\textquotesingle{}dbreadth\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.nan}
        
        \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(group)):}
\NormalTok{            current\_date }\OperatorTok{=}\NormalTok{ group.loc[i, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}
\NormalTok{            prev\_date }\OperatorTok{=}\NormalTok{ group.loc[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}
            
            \CommentTok{\# Institutions in universe for both periods}
\NormalTok{            current\_universe }\OperatorTok{=}\NormalTok{ inst\_by\_period.get(current\_date, }\BuiltInTok{set}\NormalTok{())}
\NormalTok{            prev\_universe }\OperatorTok{=}\NormalTok{ inst\_by\_period.get(prev\_date, }\BuiltInTok{set}\NormalTok{())}
\NormalTok{            continuing\_universe }\OperatorTok{=}\NormalTok{ current\_universe }\OperatorTok{\&}\NormalTok{ prev\_universe}
            
            \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(prev\_universe) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
                \ControlFlowTok{continue}
            
            \CommentTok{\# Count continuing institutions holding this stock in each period}
\NormalTok{            ticker }\OperatorTok{=}\NormalTok{ group.loc[i, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{]}
            
\NormalTok{            current\_holders }\OperatorTok{=} \BuiltInTok{set}\NormalTok{(}
\NormalTok{                inst\_ownership[}
\NormalTok{                    (inst\_ownership[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker) }\OperatorTok{\&} 
\NormalTok{                    (inst\_ownership[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ current\_date)}
\NormalTok{                ][}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{            )}
\NormalTok{            prev\_holders }\OperatorTok{=} \BuiltInTok{set}\NormalTok{(}
\NormalTok{                inst\_ownership[}
\NormalTok{                    (inst\_ownership[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker) }\OperatorTok{\&} 
\NormalTok{                    (inst\_ownership[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ prev\_date)}
\NormalTok{                ][}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{            )}
            
            \CommentTok{\# Count only continuing institutions}
\NormalTok{            n\_current\_cont }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(current\_holders }\OperatorTok{\&}\NormalTok{ continuing\_universe)}
\NormalTok{            n\_prev\_cont }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(prev\_holders }\OperatorTok{\&}\NormalTok{ continuing\_universe)}
            
\NormalTok{            group.loc[i, }\StringTok{\textquotesingle{}dbreadth\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{                (n\_current\_cont }\OperatorTok{{-}}\NormalTok{ n\_prev\_cont) }\OperatorTok{/} \BuiltInTok{len}\NormalTok{(prev\_universe)}
\NormalTok{            )}
        
        \ControlFlowTok{return}\NormalTok{ group}
    
\NormalTok{    metrics }\OperatorTok{=}\NormalTok{ metrics.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, group\_keys}\OperatorTok{=}\VariableTok{False}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(compute\_breadth\_change)}
    
    \CommentTok{\# {-}{-}{-} FOL Indicators {-}{-}{-}}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}} \KeywordTok{in}\NormalTok{ metrics.columns:}
\NormalTok{        metrics[}\StringTok{\textquotesingle{}near\_fol\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (metrics[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \FloatTok{0.90}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{        metrics[}\StringTok{\textquotesingle{}at\_fol\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (metrics[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \FloatTok{0.98}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"IO metrics computed for Vietnam:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(metrics)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Key metric distributions:"}\NormalTok{)}
\NormalTok{    summary\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}pct\_institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{,}
                    \StringTok{\textquotesingle{}hhi\_institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}dbreadth\textquotesingle{}}\NormalTok{]}
\NormalTok{    summary\_cols }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ summary\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ metrics.columns]}
    \BuiltInTok{print}\NormalTok{(metrics[summary\_cols].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{).to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ metrics}

\CommentTok{\# io\_metrics = compute\_io\_metrics\_vietnam(}
\CommentTok{\#     ownership\_classified, ownership\_decomp, adj\_factors}
\CommentTok{\# )}
\end{Highlighting}
\end{Shaded}

\subsection{Time Series Visualization}\label{time-series-visualization}

\begin{figure}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_ownership\_timeseries\_vietnam(metrics: pd.DataFrame):}
    \CommentTok{"""}
\CommentTok{    Create publication{-}quality time series plots of Vietnamese }
\CommentTok{    ownership structure evolution.}
\CommentTok{    """}
\NormalTok{    fig, axes }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{14}\NormalTok{))}
    
    \CommentTok{\# Aggregate across all stocks (market{-}cap weighted)}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ metrics.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(}
        \KeywordTok{lambda}\NormalTok{ g: pd.Series(\{}
            \StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{: np.average(g[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{), }
\NormalTok{                                     weights}\OperatorTok{=}\NormalTok{g[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{1}\NormalTok{)),}
            \StringTok{\textquotesingle{}pct\_foreign\textquotesingle{}}\NormalTok{: np.average(g[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{), }
\NormalTok{                                       weights}\OperatorTok{=}\NormalTok{g[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{1}\NormalTok{)),}
            \StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{: np.average(g[}\StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{), }
\NormalTok{                                             weights}\OperatorTok{=}\NormalTok{g[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{1}\NormalTok{)),}
            \StringTok{\textquotesingle{}pct\_individual\textquotesingle{}}\NormalTok{: np.average(g[}\StringTok{\textquotesingle{}pct\_individual\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{), }
\NormalTok{                                          weights}\OperatorTok{=}\NormalTok{g[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{1}\NormalTok{)),}
            \StringTok{\textquotesingle{}n\_stocks\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].nunique(),}
            \StringTok{\textquotesingle{}total\_mktcap\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].}\BuiltInTok{sum}\NormalTok{(),}
            \StringTok{\textquotesingle{}median\_n\_inst\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{].median(),}
            \StringTok{\textquotesingle{}median\_hhi\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}hhi\_institutional\textquotesingle{}}\NormalTok{].median(),}
            \StringTok{\textquotesingle{}pct\_soe\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{].mean(),}
\NormalTok{        \})}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# {-}{-}{-}{-} Panel A: Ownership Composition (Stacked Area) {-}{-}{-}{-}}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{0}\NormalTok{]}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ ts[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{]}
\NormalTok{    ax.stackplot(dates,}
\NormalTok{                 ts[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{                 ts[}\StringTok{\textquotesingle{}pct\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{                 ts[}\StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{                 ts[}\StringTok{\textquotesingle{}pct\_individual\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{                 labels}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Foreign Institutional\textquotesingle{}}\NormalTok{, }
                         \StringTok{\textquotesingle{}Domestic Institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Individual\textquotesingle{}}\NormalTok{],}
\NormalTok{                 colors}\OperatorTok{=}\NormalTok{[OWNER\_COLORS[}\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{], OWNER\_COLORS[}\StringTok{\textquotesingle{}Foreign Institutional\textquotesingle{}}\NormalTok{],}
\NormalTok{                         OWNER\_COLORS[}\StringTok{\textquotesingle{}Domestic Institutional\textquotesingle{}}\NormalTok{], OWNER\_COLORS[}\StringTok{\textquotesingle{}Individual\textquotesingle{}}\NormalTok{]],}
\NormalTok{                 alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Ownership Share (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Panel A: Ownership Composition of Vietnamese Listed Companies \textquotesingle{}}
                 \StringTok{\textquotesingle{}(Market{-}Cap Weighted)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend(loc}\OperatorTok{=}\StringTok{\textquotesingle{}upper right\textquotesingle{}}\NormalTok{, frameon}\OperatorTok{=}\VariableTok{True}\NormalTok{, framealpha}\OperatorTok{=}\FloatTok{0.9}\NormalTok{)}
\NormalTok{    ax.set\_ylim(}\DecValTok{0}\NormalTok{, }\DecValTok{100}\NormalTok{)}
    
    \CommentTok{\# {-}{-}{-}{-} Panel B: Institutional Ownership by Component {-}{-}{-}{-}}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{1}\NormalTok{]}
\NormalTok{    ax.plot(dates, ts[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{,}
\NormalTok{            color}\OperatorTok{=}\NormalTok{OWNER\_COLORS[}\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{], linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\NormalTok{    ax.plot(dates, ts[}\StringTok{\textquotesingle{}pct\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Foreign Institutional\textquotesingle{}}\NormalTok{,}
\NormalTok{            color}\OperatorTok{=}\NormalTok{OWNER\_COLORS[}\StringTok{\textquotesingle{}Foreign Institutional\textquotesingle{}}\NormalTok{], linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\NormalTok{    ax.plot(dates, ts[}\StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Domestic Institutional\textquotesingle{}}\NormalTok{,}
\NormalTok{            color}\OperatorTok{=}\NormalTok{OWNER\_COLORS[}\StringTok{\textquotesingle{}Domestic Institutional\textquotesingle{}}\NormalTok{], linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\NormalTok{    total\_inst }\OperatorTok{=}\NormalTok{ (ts[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ ts[}\StringTok{\textquotesingle{}pct\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ ts[}\StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{]) }\OperatorTok{*} \DecValTok{100}
\NormalTok{    ax.plot(dates, total\_inst, label}\OperatorTok{=}\StringTok{\textquotesingle{}Total Institutional\textquotesingle{}}\NormalTok{,}
\NormalTok{            color}\OperatorTok{=}\NormalTok{OWNER\_COLORS[}\StringTok{\textquotesingle{}Total Institutional\textquotesingle{}}\NormalTok{], linewidth}\OperatorTok{=}\FloatTok{2.5}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Ownership Ratio (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Panel B: Institutional Ownership Components\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend(loc}\OperatorTok{=}\StringTok{\textquotesingle{}upper left\textquotesingle{}}\NormalTok{, frameon}\OperatorTok{=}\VariableTok{True}\NormalTok{, framealpha}\OperatorTok{=}\FloatTok{0.9}\NormalTok{)}
    
    \CommentTok{\# {-}{-}{-}{-} Panel C: Market Structure {-}{-}{-}{-}}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{2}\NormalTok{]}
\NormalTok{    ax2 }\OperatorTok{=}\NormalTok{ ax.twinx()}
\NormalTok{    ax.plot(dates, ts[}\StringTok{\textquotesingle{}n\_stocks\textquotesingle{}}\NormalTok{], color}\OperatorTok{=}\StringTok{\textquotesingle{}\#1f77b4\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}\# Listed Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.plot(dates, ts[}\StringTok{\textquotesingle{}total\_mktcap\textquotesingle{}}\NormalTok{] }\OperatorTok{/} \DecValTok{1000}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#d62728\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{, }
\NormalTok{             label}\OperatorTok{=}\StringTok{\textquotesingle{}Total Market Cap (Trillion VND)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Number of Listed Stocks\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#1f77b4\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.set\_ylabel(}\StringTok{\textquotesingle{}Market Cap (Trillion VND)\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#d62728\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Panel C: Vietnamese Stock Market Development\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Combine legends}
\NormalTok{    lines1, labels1 }\OperatorTok{=}\NormalTok{ ax.get\_legend\_handles\_labels()}
\NormalTok{    lines2, labels2 }\OperatorTok{=}\NormalTok{ ax2.get\_legend\_handles\_labels()}
\NormalTok{    ax.legend(lines1 }\OperatorTok{+}\NormalTok{ lines2, labels1 }\OperatorTok{+}\NormalTok{ labels2, loc}\OperatorTok{=}\StringTok{\textquotesingle{}upper left\textquotesingle{}}\NormalTok{, framealpha}\OperatorTok{=}\FloatTok{0.9}\NormalTok{)}
    
\NormalTok{    plt.tight\_layout()}
\NormalTok{    plt.savefig(}\StringTok{\textquotesingle{}fig\_ownership\_timeseries\_vn.png\textquotesingle{}}\NormalTok{, dpi}\OperatorTok{=}\DecValTok{300}\NormalTok{, bbox\_inches}\OperatorTok{=}\StringTok{\textquotesingle{}tight\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.show()}

\CommentTok{\# plot\_ownership\_timeseries\_vietnam(io\_metrics)}
\end{Highlighting}
\end{Shaded}

}

\caption{\label{fig-io-timeseries-vn}}

\end{figure}%

\begin{figure}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_io\_by\_exchange\_size(metrics: pd.DataFrame):}
    \CommentTok{"""Plot IO ratios by exchange and size quintile."""}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics[metrics[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].notna() }\OperatorTok{\&}\NormalTok{ (metrics[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{)].copy()}
    
    \CommentTok{\# Size quintiles within each quarter}
\NormalTok{    df[}\StringTok{\textquotesingle{}size\_quintile\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, }\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Q1}\CharTok{\textbackslash{}n}\StringTok{(Small)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q2\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q5}\CharTok{\textbackslash{}n}\StringTok{(Large)\textquotesingle{}}\NormalTok{],}
\NormalTok{                          duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
\NormalTok{    fig, axes }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{15}\NormalTok{, }\DecValTok{5}\NormalTok{), sharey}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
\NormalTok{    metrics\_to\_plot }\OperatorTok{=}\NormalTok{ [}
\NormalTok{        (}\StringTok{\textquotesingle{}pct\_institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Total Institutional\textquotesingle{}}\NormalTok{),}
\NormalTok{        (}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Foreign Institutional\textquotesingle{}}\NormalTok{),}
\NormalTok{        (}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{),}
\NormalTok{    ]}
    
    \ControlFlowTok{for}\NormalTok{ ax, (col, title) }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(axes, metrics\_to\_plot):}
        \ControlFlowTok{for}\NormalTok{ exchange, color }\KeywordTok{in}\NormalTok{ EXCHANGE\_COLORS.items():}
\NormalTok{            data }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}exchange\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ exchange]}
            \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(data) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
                \ControlFlowTok{continue}
\NormalTok{            means }\OperatorTok{=}\NormalTok{ data.groupby(}\StringTok{\textquotesingle{}size\_quintile\textquotesingle{}}\NormalTok{)[col].mean() }\OperatorTok{*} \DecValTok{100}
\NormalTok{            ax.bar(np.arange(}\BuiltInTok{len}\NormalTok{(means)) }\OperatorTok{+} \BuiltInTok{list}\NormalTok{(EXCHANGE\_COLORS.keys()).index(exchange) }\OperatorTok{*} \FloatTok{0.25}\NormalTok{,}
\NormalTok{                   means, width}\OperatorTok{=}\FloatTok{0.25}\NormalTok{, label}\OperatorTok{=}\NormalTok{exchange, color}\OperatorTok{=}\NormalTok{color, alpha}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
        
\NormalTok{        ax.set\_title(title)}
\NormalTok{        ax.set\_xlabel(}\StringTok{\textquotesingle{}Size Quintile\textquotesingle{}}\NormalTok{)}
        \ControlFlowTok{if}\NormalTok{ ax }\OperatorTok{==}\NormalTok{ axes[}\DecValTok{0}\NormalTok{]:}
\NormalTok{            ax.set\_ylabel(}\StringTok{\textquotesingle{}Mean Ownership (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{        ax.legend()}
\NormalTok{        ax.set\_xticks(np.arange(}\DecValTok{5}\NormalTok{) }\OperatorTok{+} \FloatTok{0.25}\NormalTok{)}
\NormalTok{        ax.set\_xticklabels([}\StringTok{\textquotesingle{}Q1}\CharTok{\textbackslash{}n}\StringTok{(Small)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q2\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q5}\CharTok{\textbackslash{}n}\StringTok{(Large)\textquotesingle{}}\NormalTok{])}
    
\NormalTok{    plt.tight\_layout()}
\NormalTok{    plt.savefig(}\StringTok{\textquotesingle{}fig\_io\_by\_exchange\_size.png\textquotesingle{}}\NormalTok{, dpi}\OperatorTok{=}\DecValTok{300}\NormalTok{, bbox\_inches}\OperatorTok{=}\StringTok{\textquotesingle{}tight\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.show()}

\CommentTok{\# plot\_io\_by\_exchange\_size(io\_metrics)}
\end{Highlighting}
\end{Shaded}

}

\caption{\label{fig-io-by-exchange}}

\end{figure}%

\begin{table}

\caption{\label{tbl-io-summary}Summary Statistics of Ownership Structure
in Vietnam by Size Quintile and Exchange (Pooled 2010-2024)}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ tabulate\_io\_summary(metrics: pd.DataFrame, start\_year: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{2010}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Create publication{-}quality summary table of Vietnamese ownership}
\CommentTok{    structure by firm size.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics[}
\NormalTok{        (metrics[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{\textgreater{}=}\NormalTok{ start\_year) }\OperatorTok{\&}
\NormalTok{        (metrics[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].notna()) }\OperatorTok{\&}\NormalTok{ (metrics[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    ].copy()}
    
\NormalTok{    df[}\StringTok{\textquotesingle{}size\_quintile\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, }\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Q1 (Small)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q2\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q3\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q4\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Q5 (Large)\textquotesingle{}}\NormalTok{],}
\NormalTok{                          duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
\NormalTok{    table }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}size\_quintile\textquotesingle{}}\NormalTok{).agg(}
\NormalTok{        N}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}count\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_MktCap}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_IO\_Total}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_State}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_Foreign}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_Domestic\_Inst}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_domestic\_inst\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_Individual}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_individual\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Median\_N\_Owners}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{),}
\NormalTok{        Median\_HHI}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}hhi\_institutional\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{),}
\NormalTok{        Pct\_SOE}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        Mean\_FOL\_Util}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{)}
    
    \CommentTok{\# Format}
\NormalTok{    table[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ table[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:,.0f\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{    table[}\StringTok{\textquotesingle{}Mean\_MktCap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ table[}\StringTok{\textquotesingle{}Mean\_MktCap\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:,.0f\}}\SpecialStringTok{B VND"}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}Mean\_IO\_Total\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mean\_State\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mean\_Foreign\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}Mean\_Domestic\_Inst\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mean\_Individual\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Pct\_SOE\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mean\_FOL\_Util\textquotesingle{}}\NormalTok{]:}
\NormalTok{        table[col] }\OperatorTok{=}\NormalTok{ table[col].}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{""}\NormalTok{)}
\NormalTok{    table[}\StringTok{\textquotesingle{}Median\_N\_Owners\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ table[}\StringTok{\textquotesingle{}Median\_N\_Owners\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.0f\}}\SpecialStringTok{"}\NormalTok{)}
\NormalTok{    table[}\StringTok{\textquotesingle{}Median\_HHI\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ table[}\StringTok{\textquotesingle{}Median\_HHI\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.3f\}}\SpecialStringTok{"} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{""}\NormalTok{)}
    
\NormalTok{    table.columns }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mean Mkt Cap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}IO Total\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}State\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Foreign\textquotesingle{}}\NormalTok{, }
                      \StringTok{\textquotesingle{}Dom. Inst.\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Individual\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Med. \# Owners\textquotesingle{}}\NormalTok{, }
                      \StringTok{\textquotesingle{}Med. HHI\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\% SOE\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}FOL Util.\textquotesingle{}}\NormalTok{]}
    
    \ControlFlowTok{return}\NormalTok{ table}

\CommentTok{\# io\_summary = tabulate\_io\_summary(io\_metrics)}
\CommentTok{\# print(io\_summary.to\_string())}
\end{Highlighting}
\end{Shaded}

}

\end{table}%

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Foreign Ownership Dynamics}\label{sec-foreign-ownership}

\subsection{Foreign Ownership Limits and the FOL Premium}\label{sec-fol}

Vietnam's Foreign Ownership Limits create a unique market segmentation.
When a stock reaches its FOL, the only way for a new foreign investor to
buy is if an existing foreign holder sells. This creates a de facto
``foreign-only'' market for FOL-constrained stocks, with documented
price premiums (Vo 2015).

The \textbf{FOL Utilization Ratio} for stock \(i\) at time \(t\) is:

\begin{equation}\phantomsection\label{eq-fol-util}{
FOL\_Util_{i,t} = \frac{ForeignOwnership_{i,t}}{FOL\_Limit_i}
}\end{equation}

Stocks are classified by FOL proximity (Table~\ref{tbl-fol-zones}).

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2500}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2500}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.5000}}@{}}
\caption{FOL Proximity Zones}\label{tbl-fol-zones}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
FOL Zone
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Utilization Range
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Market Implication
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
FOL Zone
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Utilization Range
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Market Implication
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Green} & \textless{} 50\% & Ample foreign room; normal
trading \\
\textbf{Yellow} & 50-80\% & Moderate room; some foreign interest
pressure \\
\textbf{Orange} & 80-95\% & Limited room; foreign premium emerging \\
\textbf{Red} & 95-100\% & Near cap; significant foreign premium \\
\textbf{Capped} &  100\% & At limit; foreign-only secondary market \\
\end{longtable}

\phantomsection\label{fol-analysis}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 6: Foreign Ownership Limit Analysis}
\CommentTok{\# ============================================================================}

\KeywordTok{class}\NormalTok{ FOLAnalyzer:}
    \CommentTok{"""}
\CommentTok{    Analyze Foreign Ownership Limit dynamics in the Vietnamese market.}
\CommentTok{    }
\CommentTok{    Key analyses:}
\CommentTok{    1. FOL utilization tracking and classification}
\CommentTok{    2. FOL premium estimation (price impact of being near cap)}
\CommentTok{    3. Foreign room dynamics (opening/closing events)}
\CommentTok{    4. Cross{-}sectional determinants of foreign ownership}
\CommentTok{    """}
    
\NormalTok{    FOL\_ZONES }\OperatorTok{=}\NormalTok{ \{}
        \StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{: (}\DecValTok{0}\NormalTok{, }\FloatTok{0.50}\NormalTok{),}
        \StringTok{\textquotesingle{}Yellow\textquotesingle{}}\NormalTok{: (}\FloatTok{0.50}\NormalTok{, }\FloatTok{0.80}\NormalTok{),}
        \StringTok{\textquotesingle{}Orange\textquotesingle{}}\NormalTok{: (}\FloatTok{0.80}\NormalTok{, }\FloatTok{0.95}\NormalTok{),}
        \StringTok{\textquotesingle{}Red\textquotesingle{}}\NormalTok{: (}\FloatTok{0.95}\NormalTok{, }\FloatTok{1.00}\NormalTok{),}
        \StringTok{\textquotesingle{}Capped\textquotesingle{}}\NormalTok{: (}\FloatTok{1.00}\NormalTok{, }\FloatTok{1.50}\NormalTok{),}
\NormalTok{    \}}
    
    \KeywordTok{def} \FunctionTok{\_\_init\_\_}\NormalTok{(}\VariableTok{self}\NormalTok{, io\_metrics: pd.DataFrame,}
\NormalTok{                 foreign\_daily: Optional[pd.DataFrame] }\OperatorTok{=} \VariableTok{None}\NormalTok{):}
        \CommentTok{"""}
\CommentTok{        Parameters}
\CommentTok{        {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{        io\_metrics : pd.DataFrame}
\CommentTok{            Full ownership metrics from compute\_io\_metrics\_vietnam()}
\CommentTok{        foreign\_daily : pd.DataFrame, optional}
\CommentTok{            Daily foreign ownership tracking from DataCore.vn}
\CommentTok{        """}
        \VariableTok{self}\NormalTok{.metrics }\OperatorTok{=}\NormalTok{ io\_metrics.copy()}
        \VariableTok{self}\NormalTok{.foreign\_daily }\OperatorTok{=}\NormalTok{ foreign\_daily}
    
    \KeywordTok{def}\NormalTok{ classify\_fol\_zones(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \CommentTok{"""Classify stocks into FOL proximity zones."""}
\NormalTok{        df }\OperatorTok{=} \VariableTok{self}\NormalTok{.metrics.copy()}
        
        \ControlFlowTok{if} \StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}} \KeywordTok{not} \KeywordTok{in}\NormalTok{ df.columns:}
            \BuiltInTok{print}\NormalTok{(}\StringTok{"FOL utilization not available in metrics."}\NormalTok{)}
            \ControlFlowTok{return}\NormalTok{ df}
        
\NormalTok{        conditions }\OperatorTok{=}\NormalTok{ []}
\NormalTok{        choices }\OperatorTok{=}\NormalTok{ []}
        \ControlFlowTok{for}\NormalTok{ zone, (lo, hi) }\KeywordTok{in} \VariableTok{self}\NormalTok{.FOL\_ZONES.items():}
\NormalTok{            conditions.append(}
\NormalTok{                (df[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=}\NormalTok{ lo) }\OperatorTok{\&}\NormalTok{ (df[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}}\NormalTok{ hi)}
\NormalTok{            )}
\NormalTok{            choices.append(zone)}
        
\NormalTok{        df[}\StringTok{\textquotesingle{}fol\_zone\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.select(conditions, choices, default}\OperatorTok{=}\StringTok{\textquotesingle{}Unknown\textquotesingle{}}\NormalTok{)}
        
        \CommentTok{\# Summary}
\NormalTok{        zone\_dist }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}fol\_zone\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].nunique()}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"FOL Zone Distribution (unique stocks):"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(zone\_dist.to\_string())}
        
        \ControlFlowTok{return}\NormalTok{ df}
    
    \KeywordTok{def}\NormalTok{ estimate\_fol\_premium(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
        \CommentTok{"""}
\CommentTok{        Estimate the FOL premium using a cross{-}sectional approach.}
\CommentTok{        }
\CommentTok{        For each period, regress stock valuations (P/B or P/E) on FOL }
\CommentTok{        utilization, controlling for fundamentals. The coefficient on }
\CommentTok{        FOL utilization captures the premium investors pay for stocks }
\CommentTok{        near their foreign ownership cap.}
\CommentTok{        }
\CommentTok{        Alternative: Compare returns of stocks transitioning between }
\CommentTok{        FOL zones as a natural experiment.}
\CommentTok{        """}
\NormalTok{        df }\OperatorTok{=} \VariableTok{self}\NormalTok{.metrics.copy()}
\NormalTok{        df }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{].notna() }\OperatorTok{\&}\NormalTok{ df[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{].notna()].copy()}
        
        \CommentTok{\# FOL zone dummies}
\NormalTok{        df[}\StringTok{\textquotesingle{}near\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \FloatTok{0.90}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
\NormalTok{        df[}\StringTok{\textquotesingle{}at\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \FloatTok{0.98}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
        
        \CommentTok{\# Price{-}to{-}book as valuation measure}
        \CommentTok{\# (Assumes \textquotesingle{}equity\textquotesingle{} is available from financial data)}
        \ControlFlowTok{if} \StringTok{\textquotesingle{}equity\textquotesingle{}} \KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{            df[}\StringTok{\textquotesingle{}pb\_ratio\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \FloatTok{1e9} \OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}equity\textquotesingle{}}\NormalTok{]}
        \ControlFlowTok{else}\NormalTok{:}
            \CommentTok{\# Use market cap as proxy for cross{-}sectional analysis}
\NormalTok{            df[}\StringTok{\textquotesingle{}log\_mktcap\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.log(df[}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{])}
        
        \CommentTok{\# Fama{-}MacBeth style: run cross{-}sectional regressions each period}
\NormalTok{        results }\OperatorTok{=}\NormalTok{ []}
        \ControlFlowTok{for}\NormalTok{ quarter, group }\KeywordTok{in}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{):}
\NormalTok{            group }\OperatorTok{=}\NormalTok{ group.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}log\_mktcap\textquotesingle{}}\NormalTok{])}
            \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(group) }\OperatorTok{\textless{}} \DecValTok{50}\NormalTok{:}
                \ControlFlowTok{continue}
            
\NormalTok{            y }\OperatorTok{=}\NormalTok{ group[}\StringTok{\textquotesingle{}log\_mktcap\textquotesingle{}}\NormalTok{]}
\NormalTok{            X }\OperatorTok{=}\NormalTok{ sm.add\_constant(group[[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }
                                        \StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{]])}
            \ControlFlowTok{try}\NormalTok{:}
\NormalTok{                model }\OperatorTok{=}\NormalTok{ sm.OLS(y, X).fit()}
\NormalTok{                results.append(\{}
                    \StringTok{\textquotesingle{}quarter\textquotesingle{}}\NormalTok{: quarter,}
                    \StringTok{\textquotesingle{}beta\_fol\textquotesingle{}}\NormalTok{: model.params.get(}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, np.nan),}
                    \StringTok{\textquotesingle{}tstat\_fol\textquotesingle{}}\NormalTok{: model.tvalues.get(}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{, np.nan),}
                    \StringTok{\textquotesingle{}r2\textquotesingle{}}\NormalTok{: model.rsquared,}
                    \StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(group),}
\NormalTok{                \})}
            \ControlFlowTok{except} \PreprocessorTok{Exception}\NormalTok{:}
                \ControlFlowTok{continue}
        
        \ControlFlowTok{if}\NormalTok{ results:}
\NormalTok{            results\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(results)}
            \BuiltInTok{print}\NormalTok{(}\StringTok{"FOL Premium (Fama{-}MacBeth Regression):"}\NormalTok{)}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Mean (FOL\_util): }\SpecialCharTok{\{}\NormalTok{results\_df[}\StringTok{\textquotesingle{}beta\_fol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  t{-}statistic: }\SpecialCharTok{\{}\NormalTok{results\_df[}\StringTok{\textquotesingle{}beta\_fol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean() }\OperatorTok{/} \StringTok{"}
\ErrorTok{                  f"(results\_df[\textquotesingle{}beta\_fol\textquotesingle{}].std() / np.sqrt(len(results\_df))):.2f\}")}
            \ControlFlowTok{return}\NormalTok{ results\_df}
        
        \ControlFlowTok{return}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{DataFrame()}
    
    \KeywordTok{def}\NormalTok{ analyze\_foreign\_room\_events(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{DataFrame}\SpecialCharTok{:}
        \CommentTok{"""}
\CommentTok{        Analyze events where foreign room opens or closes.}
\CommentTok{        }
\CommentTok{        Room{-}opening events (FOL cap raised, foreign seller exits) can}
\CommentTok{        trigger significant price movements as pent{-}up foreign demand }
\CommentTok{        is released. Room{-}closing events (approaching cap) can create}
\CommentTok{        selling pressure as foreign investors anticipate illiquidity.}
\CommentTok{        """}
        \ControlFlowTok{if} \VariableTok{self}\SpecialCharTok{.}\NormalTok{foreign\_daily }\KeywordTok{is} \VariableTok{None}\SpecialCharTok{:}
            \BuiltInTok{print}\NormalTok{(}\StringTok{"Daily foreign ownership data required for event analysis."}\NormalTok{)}
            \ControlFlowTok{return}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{DataFrame()}
        
\NormalTok{        df }\OperatorTok{=} \VariableTok{self}\SpecialCharTok{.}\NormalTok{foreign\_daily}\SpecialCharTok{.}\NormalTok{copy()}
\NormalTok{        df }\OperatorTok{=}\NormalTok{ df}\SpecialCharTok{.}\NormalTok{sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
        
        \CommentTok{\# Compute daily change in foreign room}
\NormalTok{        df[}\StringTok{\textquotesingle{}foreign\_room\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df}\SpecialCharTok{.}\NormalTok{groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}foreign\_room\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{diff()}
        
        \CommentTok{\# Identify room{-}opening events (room increases by \textgreater{} 1 percentage point)}
\NormalTok{        df[}\StringTok{\textquotesingle{}room\_open\_event\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}foreign\_room\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \FloatTok{0.01}\NormalTok{)}\SpecialCharTok{.}\NormalTok{astype(}\BuiltInTok{int}\NormalTok{)}
        
        \CommentTok{\# Identify room{-}closing events (room decreases to \textless{} 2\%)}
\NormalTok{        df[}\StringTok{\textquotesingle{}room\_close\_event\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{            (df[}\StringTok{\textquotesingle{}foreign\_room\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \FloatTok{0.02}\NormalTok{) }\OperatorTok{\&} 
\NormalTok{            (df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}foreign\_room\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=} \FloatTok{0.02}\NormalTok{)}
\NormalTok{        )}\SpecialCharTok{.}\NormalTok{astype(}\BuiltInTok{int}\NormalTok{)}
        
\NormalTok{        events }\OperatorTok{=}\NormalTok{ df[}
\NormalTok{            (df[}\StringTok{\textquotesingle{}room\_open\_event\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{) }\OperatorTok{|}\NormalTok{ (df[}\StringTok{\textquotesingle{}room\_close\_event\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{)}
\NormalTok{        ]}\SpecialCharTok{.}\NormalTok{copy()}
        
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Foreign room events identified:"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Room{-}opening events: }\SpecialCharTok{\{}\NormalTok{df[}\StringTok{\textquotesingle{}room\_open\_event\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Room{-}closing events: }\SpecialCharTok{\{}\NormalTok{df[}\StringTok{\textquotesingle{}room\_close\_event\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{sum}\NormalTok{()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
        
        \ControlFlowTok{return}\NormalTok{ events}

\CommentTok{\# fol\_analyzer = FOLAnalyzer(io\_metrics, dc.foreign\_ownership)}
\CommentTok{\# fol\_classified = fol\_analyzer.classify\_fol\_zones()}
\CommentTok{\# fol\_premium = fol\_analyzer.estimate\_fol\_premium()}
\end{Highlighting}
\end{Shaded}

\begin{figure}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_fol\_utilization(metrics: pd.DataFrame):}
    \CommentTok{"""Plot FOL utilization distribution by sector."""}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics[metrics[}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{].notna()].copy()}
    
    \CommentTok{\# Assign broad sectors}
\NormalTok{    sector\_map }\OperatorTok{=}\NormalTok{ \{}
        \StringTok{\textquotesingle{}Banking\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}VCB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BID\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}CTG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TCB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}VPB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}MBB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ACB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HDB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}STB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TPB\textquotesingle{}}\NormalTok{],}
        \StringTok{\textquotesingle{}Real Estate\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}VHM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}VIC\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}NVL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}KDH\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}DXG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HDG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}VRE\textquotesingle{}}\NormalTok{],}
        \StringTok{\textquotesingle{}Technology\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}FPT\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}CMG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}FOX\textquotesingle{}}\NormalTok{],}
        \StringTok{\textquotesingle{}Consumer\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}VNM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}MSN\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SAB\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}MWG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}PNJ\textquotesingle{}}\NormalTok{],}
\NormalTok{    \}}
    
\NormalTok{    fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{))}
    
    \ControlFlowTok{for}\NormalTok{ sector, tickers }\KeywordTok{in}\NormalTok{ sector\_map.items():}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].isin(tickers)][}\StringTok{\textquotesingle{}fol\_utilization\textquotesingle{}}\NormalTok{]}
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(data) }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{            ax.hist(data }\OperatorTok{*} \DecValTok{100}\NormalTok{, bins}\OperatorTok{=}\DecValTok{30}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.4}\NormalTok{, label}\OperatorTok{=}\NormalTok{sector, density}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
\NormalTok{    ax.axvline(x}\OperatorTok{=}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Banking FOL (30\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.axvline(x}\OperatorTok{=}\DecValTok{49}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}blue\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Standard FOL (49\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_xlabel(}\StringTok{\textquotesingle{}FOL Utilization (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Density\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Foreign Ownership Limit Utilization Distribution\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend()}
    
\NormalTok{    plt.tight\_layout()}
\NormalTok{    plt.savefig(}\StringTok{\textquotesingle{}fig\_fol\_utilization.png\textquotesingle{}}\NormalTok{, dpi}\OperatorTok{=}\DecValTok{300}\NormalTok{, bbox\_inches}\OperatorTok{=}\StringTok{\textquotesingle{}tight\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.show()}

\CommentTok{\# plot\_fol\_utilization(io\_metrics)}
\end{Highlighting}
\end{Shaded}

}

\caption{\label{fig-fol-utilization}}

\end{figure}%

\section{Institutional Trades}\label{sec-trades}

\subsection{Trade Inference in Vietnam}\label{sec-trade-inference}

In the US, institutional trades are inferred from quarterly 13F holding
snapshots. In Vietnam, the challenge is more acute because disclosure
frequency varies:

\begin{itemize}
\tightlist
\item
  \textbf{Major shareholders (}\(\ge\) \textbf{5\%)}: Must disclose
  within 7 business days of crossing ownership thresholds (5\%, 10\%,
  15\%, 20\%, 25\%, 50\%, 65\%, 75\%)
\item
  \textbf{Fund portfolio reports:} Semi-annual disclosure required; some
  funds report quarterly
\item
  \textbf{Annual reports:} Provide complete shareholder register but
  only once per year
\item
  \textbf{Daily foreign ownership:} HOSE/HNX publish aggregate daily
  foreign buy/sell data
\end{itemize}

We derive trades from the \textbf{change in ownership between
consecutive disclosure dates}, applying the same logic as the US
(\textbf{bendavid2012hedge?}) algorithm but adapted for Vietnam's
irregular disclosure intervals.

\phantomsection\label{derive-trades-vn}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 7: Derive Institutional Trades}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ derive\_trades\_vietnam(ownership: pd.DataFrame,}
\NormalTok{                           adj\_factors: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Derive institutional trades from changes in ownership disclosures.}
\CommentTok{    }
\CommentTok{    Adapted from Ben{-}David, Franzoni, and Moussawi (2012) for }
\CommentTok{    Vietnam\textquotesingle{}s irregular disclosure frequency.}
\CommentTok{    }
\CommentTok{    Key differences from US approach:}
\CommentTok{    1. Disclosure intervals are irregular (not always quarterly)}
\CommentTok{    2. We observe ALL institutional types, not just 13F filers}
\CommentTok{    3. No $100M AUM threshold (we see all institutional holders)}
\CommentTok{    4. Must adjust for corporate actions between disclosure dates}
\CommentTok{    }
\CommentTok{    Trade types:}
\CommentTok{    +1: Initiating Buy (new position)}
\CommentTok{    +2: Incremental Buy (increased existing position)}
\CommentTok{    {-}1: Terminating Sale (fully exited position)}
\CommentTok{    {-}2: Incremental Sale (reduced existing position)}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    ownership : pd.DataFrame}
\CommentTok{        Classified ownership with: ticker, date, shareholder\_name, }
\CommentTok{        shares\_held, owner\_type}
\CommentTok{    adj\_factors : pd.DataFrame}
\CommentTok{        Corporate action adjustment factors}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame}
\CommentTok{        Trade{-}level data: date, shareholder\_name, ticker, trade, }
\CommentTok{        buysale, owner\_type}
\CommentTok{    """}
    \CommentTok{\# Focus on institutional shareholders only}
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL)}
\NormalTok{    ].copy()}
    
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ inst.sort\_values([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
\NormalTok{    trades\_list }\OperatorTok{=}\NormalTok{ []}
    
    \ControlFlowTok{for}\NormalTok{ (shareholder, ticker), group }\KeywordTok{in}\NormalTok{ inst.groupby([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{]):}
\NormalTok{        group }\OperatorTok{=}\NormalTok{ group.reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
        
        \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(group)):}
\NormalTok{            current }\OperatorTok{=}\NormalTok{ group.iloc[i]}
\NormalTok{            current\_date }\OperatorTok{=}\NormalTok{ current[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}
\NormalTok{            current\_shares }\OperatorTok{=}\NormalTok{ current[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{]}
\NormalTok{            owner\_type }\OperatorTok{=}\NormalTok{ current[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{]}
            
            \ControlFlowTok{if}\NormalTok{ i }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
                \CommentTok{\# First observation: if institution appears, it\textquotesingle{}s an initiating buy}
                \CommentTok{\# (we don\textquotesingle{}t know if they held before our data starts)}
                \CommentTok{\# Skip the very first observation to avoid false initiating buys}
                \ControlFlowTok{continue}
            
\NormalTok{            prev }\OperatorTok{=}\NormalTok{ group.iloc[i }\OperatorTok{{-}} \DecValTok{1}\NormalTok{]}
\NormalTok{            prev\_date }\OperatorTok{=}\NormalTok{ prev[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}
\NormalTok{            prev\_shares }\OperatorTok{=}\NormalTok{ prev[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{]}
            
            \CommentTok{\# Adjust previous shares for corporate actions between dates}
\NormalTok{            prev\_shares\_adj }\OperatorTok{=}\NormalTok{ adjust\_shares(}
\NormalTok{                prev\_shares, ticker, prev\_date, current\_date, adj\_factors}
\NormalTok{            )}
            
            \CommentTok{\# Compute trade (in adjusted shares)}
\NormalTok{            trade }\OperatorTok{=}\NormalTok{ current\_shares }\OperatorTok{{-}}\NormalTok{ prev\_shares\_adj}
            
            \CommentTok{\# Classify trade type}
            \ControlFlowTok{if} \BuiltInTok{abs}\NormalTok{(trade) }\OperatorTok{\textless{}} \DecValTok{1}\NormalTok{:  }\CommentTok{\# De minimis threshold}
                \ControlFlowTok{continue}
            
            \ControlFlowTok{if}\NormalTok{ prev\_shares\_adj }\OperatorTok{\textless{}=} \DecValTok{0} \KeywordTok{and}\NormalTok{ current\_shares }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{                buysale }\OperatorTok{=} \DecValTok{1}  \CommentTok{\# Initiating buy}
            \ControlFlowTok{elif}\NormalTok{ prev\_shares\_adj }\OperatorTok{\textgreater{}} \DecValTok{0} \KeywordTok{and}\NormalTok{ current\_shares }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{:}
\NormalTok{                buysale }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}  \CommentTok{\# Terminating sale}
            \ControlFlowTok{elif}\NormalTok{ trade }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{                buysale }\OperatorTok{=} \DecValTok{2}  \CommentTok{\# Incremental buy}
            \ControlFlowTok{else}\NormalTok{:}
\NormalTok{                buysale }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{2}  \CommentTok{\# Incremental sale}
            
\NormalTok{            trades\_list.append(\{}
                \StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{: current\_date,}
                \StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{: shareholder,}
                \StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{: ticker,}
                \StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{: trade,}
                \StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{: prev\_shares\_adj,}
                \StringTok{\textquotesingle{}current\_shares\textquotesingle{}}\NormalTok{: current\_shares,}
                \StringTok{\textquotesingle{}buysale\textquotesingle{}}\NormalTok{: buysale,}
                \StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{: owner\_type,}
                \StringTok{\textquotesingle{}days\_between\textquotesingle{}}\NormalTok{: (current\_date }\OperatorTok{{-}}\NormalTok{ prev\_date).days,}
\NormalTok{            \})}
    
\NormalTok{    trades }\OperatorTok{=}\NormalTok{ pd.DataFrame(trades\_list)}
    
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(trades) }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Trades derived: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(trades)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Trade type distribution:"}\NormalTok{)}
\NormalTok{        labels }\OperatorTok{=}\NormalTok{ \{}\DecValTok{1}\NormalTok{: }\StringTok{\textquotesingle{}Initiating Buy\textquotesingle{}}\NormalTok{, }\DecValTok{2}\NormalTok{: }\StringTok{\textquotesingle{}Incremental Buy\textquotesingle{}}\NormalTok{,}
                  \OperatorTok{{-}}\DecValTok{1}\NormalTok{: }\StringTok{\textquotesingle{}Terminating Sale\textquotesingle{}}\NormalTok{, }\OperatorTok{{-}}\DecValTok{2}\NormalTok{: }\StringTok{\textquotesingle{}Incremental Sale\textquotesingle{}}\NormalTok{\}}
        \ControlFlowTok{for}\NormalTok{ bs, label }\KeywordTok{in} \BuiltInTok{sorted}\NormalTok{(labels.items()):}
\NormalTok{            n }\OperatorTok{=}\NormalTok{ (trades[}\StringTok{\textquotesingle{}buysale\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ bs).}\BuiltInTok{sum}\NormalTok{()}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{label}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:,\}}\SpecialStringTok{ (}\SpecialCharTok{\{}\NormalTok{n}\OperatorTok{/}\BuiltInTok{len}\NormalTok{(trades)}\SpecialCharTok{:.1\%\}}\SpecialStringTok{)"}\NormalTok{)}
        
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{By owner type:"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(trades.groupby(}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{].agg([}\StringTok{\textquotesingle{}count\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{])}
\NormalTok{              .}\BuiltInTok{round}\NormalTok{(}\DecValTok{0}\NormalTok{).to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ trades}

\CommentTok{\# trades = derive\_trades\_vietnam(ownership\_classified, adj\_factors)}
\end{Highlighting}
\end{Shaded}

\begin{tcolorbox}[enhanced jigsaw, opacitybacktitle=0.6, opacityback=0, colframe=quarto-callout-warning-color-frame, leftrule=.75mm, colback=white, left=2mm, bottomtitle=1mm, colbacktitle=quarto-callout-warning-color!10!white, breakable, rightrule=.15mm, toprule=.15mm, bottomrule=.15mm, toptitle=1mm, titlerule=0mm, title=\textcolor{quarto-callout-warning-color}{\faExclamationTriangle}\hspace{0.5em}{Corporate Action Adjustment in Trade Derivation}, arc=.35mm, coltitle=black]

When computing trades as \(\Delta Shares = Shares_t - Shares_{t-1}\),
the previous period's shares \textbf{must} be adjusted for any corporate
actions between \(t-1\) and \(t\). If VNM issued a 20\% stock dividend
between the two disclosure dates, then 1,000 shares at \(t-1\) should be
compared to 1,200 adjusted shares, not 1,000 raw shares. Failing to make
this adjustment would create a phantom ``buy'' of 200 shares that never
actually occurred.

\end{tcolorbox}

\phantomsection\label{vectorized-trades-vn}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ derive\_trades\_vectorized\_vietnam(ownership: pd.DataFrame,}
\NormalTok{                                      adj\_factors: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Vectorized version of Vietnamese trade derivation.}
\CommentTok{    }
\CommentTok{    Uses pandas groupby and vectorized operations instead of Python loops.}
\CommentTok{    Approximately 20{-}50x faster for large datasets.}
\CommentTok{    }
\CommentTok{    Note: Corporate action adjustment is applied per{-}group, which still}
\CommentTok{    requires some iteration but is much faster than row{-}by{-}row.}
\CommentTok{    """}
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL) }\OperatorTok{\&}
\NormalTok{        (ownership[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{)}
\NormalTok{    ].copy()}
    
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ inst.sort\_values([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
    
    \CommentTok{\# Lagged values}
\NormalTok{    inst[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst.groupby([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
\NormalTok{    inst[}\StringTok{\textquotesingle{}prev\_shares\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst.groupby([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
\NormalTok{    inst[}\StringTok{\textquotesingle{}is\_first\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{].isna()}
    
    \CommentTok{\# Remove first observations (no prior to compare)}
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ inst[}\OperatorTok{\textasciitilde{}}\NormalTok{inst[}\StringTok{\textquotesingle{}is\_first\textquotesingle{}}\NormalTok{]].copy()}
    
    \CommentTok{\# Adjust previous shares for corporate actions}
    \CommentTok{\# Vectorized: for each row, apply adjustment between prev\_date and date}
    \KeywordTok{def}\NormalTok{ adjust\_row(row):}
        \ControlFlowTok{return}\NormalTok{ adjust\_shares(}
\NormalTok{            row[}\StringTok{\textquotesingle{}prev\_shares\textquotesingle{}}\NormalTok{], row[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{], }
\NormalTok{            row[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{], row[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{], adj\_factors}
\NormalTok{        )}
    
\NormalTok{    inst[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst.}\BuiltInTok{apply}\NormalTok{(adjust\_row, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Compute trade}
\NormalTok{    inst[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ inst[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{]}
\NormalTok{    inst[}\StringTok{\textquotesingle{}days\_between\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (inst[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ inst[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{]).dt.days}
    
    \CommentTok{\# Classify trade type}
\NormalTok{    inst[}\StringTok{\textquotesingle{}buysale\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.select(}
\NormalTok{        [}
\NormalTok{            (inst[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (inst[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{),}
\NormalTok{            (inst[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (inst[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{),}
\NormalTok{            inst[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{,}
\NormalTok{            inst[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{,}
\NormalTok{        ],}
\NormalTok{        [}\DecValTok{1}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\OperatorTok{{-}}\DecValTok{2}\NormalTok{],}
\NormalTok{        default}\OperatorTok{=}\DecValTok{0}
\NormalTok{    )}
    
    \CommentTok{\# Remove zero trades}
\NormalTok{    trades }\OperatorTok{=}\NormalTok{ inst[inst[}\StringTok{\textquotesingle{}buysale\textquotesingle{}}\NormalTok{] }\OperatorTok{!=} \DecValTok{0}\NormalTok{].copy()}
    
\NormalTok{    trades }\OperatorTok{=}\NormalTok{ trades[[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{, }
                     \StringTok{\textquotesingle{}buysale\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}days\_between\textquotesingle{}}\NormalTok{,}
                     \StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{]].copy()}
\NormalTok{    trades }\OperatorTok{=}\NormalTok{ trades.rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}current\_shares\textquotesingle{}}\NormalTok{\})}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Vectorized trades: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(trades)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \ControlFlowTok{return}\NormalTok{ trades}

\CommentTok{\# trades = derive\_trades\_vectorized\_vietnam(ownership\_classified, adj\_factors)}
\end{Highlighting}
\end{Shaded}

\section{Fund-Level Flows and Turnover}\label{sec-flows-turnover}

\subsection{Portfolio Assets and Returns from Fund
Holdings}\label{portfolio-assets-and-returns-from-fund-holdings}

Using DataCore.vn's fund holdings data, we compute fund-level portfolio
analytics analogous to the US 13F approach:

\begin{equation}\phantomsection\label{eq-assets-vn}{
Assets_{j,t} = \sum_{i=1}^{N_{j,t}} S_{i,j,t} \times P_{i,t}
}\end{equation}

\begin{equation}\phantomsection\label{eq-hret-vn}{
R_{j,t \to t+1}^{holdings} = \frac{\sum_{i} S_{i,j,t} \times P_{i,t} \times R_{i,t \to t+1}}{\sum_{i} S_{i,j,t} \times P_{i,t}}
}\end{equation}

\begin{equation}\phantomsection\label{eq-flows-vn}{
NetFlows_{j,t} = Assets_{j,t} - Assets_{j,t-1} \times (1 + R_{j,t-1 \to t}^{holdings})
}\end{equation}

\subsection{Turnover Measures}\label{turnover-measures}

Following Mark M. Carhart (1997a), adapted for Vietnam's fund reporting:

\begin{equation}\phantomsection\label{eq-turnover-vn}{
Turnover_{j,t}^{Carhart} = \frac{\min(TotalBuys_{j,t}, TotalSales_{j,t})}{\overline{Assets}_{j,t}}
}\end{equation}

\phantomsection\label{fund-analytics}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 8: Fund{-}Level Portfolio Analytics}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ compute\_fund\_analytics(fund\_holdings: pd.DataFrame,}
\NormalTok{                            prices\_q: pd.DataFrame,}
\NormalTok{                            adj\_factors: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ Dict:}
    \CommentTok{"""}
\CommentTok{    Compute fund{-}level portfolio analytics from DataCore.vn fund holdings.}
\CommentTok{    }
\CommentTok{    Vietnamese fund disclosure is typically semi{-}annual (some quarterly),}
\CommentTok{    which limits the frequency of these analytics compared to the US}
\CommentTok{    quarterly approach.}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    dict with keys:}
\CommentTok{        \textquotesingle{}fund\_assets\textquotesingle{}: pd.DataFrame of fund{-}level assets and returns}
\CommentTok{        \textquotesingle{}fund\_trades\textquotesingle{}: pd.DataFrame of fund{-}level derived trades}
\CommentTok{        \textquotesingle{}fund\_aggregates\textquotesingle{}: pd.DataFrame of flows and turnover}
\CommentTok{    """}
\NormalTok{    fh }\OperatorTok{=}\NormalTok{ fund\_holdings.copy()}
\NormalTok{    fh }\OperatorTok{=}\NormalTok{ fh[fh[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{].copy()}
    
    \CommentTok{\# Merge with prices}
\NormalTok{    fh }\OperatorTok{=}\NormalTok{ fh.merge(}
\NormalTok{        prices\_q[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}adjusted\_close\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]],}
\NormalTok{        left\_on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{],}
\NormalTok{        right\_on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}
\NormalTok{    )}
    
    \CommentTok{\# Portfolio value}
\NormalTok{    fh[}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ fh[}\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# {-}{-}{-} Fund{-}Level Assets {-}{-}{-}}
\NormalTok{    fund\_assets }\OperatorTok{=}\NormalTok{ fh.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{]).agg(}
\NormalTok{        total\_assets}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/} \FloatTok{1e9}\NormalTok{),  }\CommentTok{\# Billion VND}
\NormalTok{        n\_stocks}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# Holdings return (value{-}weighted)}
\NormalTok{    fh[}\StringTok{\textquotesingle{}weight\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: x }\OperatorTok{/}\NormalTok{ x.}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    )}
\NormalTok{    fund\_hret }\OperatorTok{=}\NormalTok{ (fh.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{])}
\NormalTok{                   .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ g: np.average(g[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{), weights}\OperatorTok{=}\NormalTok{g[}\StringTok{\textquotesingle{}weight\textquotesingle{}}\NormalTok{]))}
\NormalTok{                   .reset\_index(name}\OperatorTok{=}\StringTok{\textquotesingle{}holdings\_return\textquotesingle{}}\NormalTok{))}
    
\NormalTok{    fund\_assets }\OperatorTok{=}\NormalTok{ fund\_assets.merge(fund\_hret, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# {-}{-}{-} Fund{-}Level Trades {-}{-}{-}}
    \CommentTok{\# Derive trades from changes in holdings}
\NormalTok{    fh\_sorted }\OperatorTok{=}\NormalTok{ fh.sort\_values([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{])}
\NormalTok{    fh\_sorted[}\StringTok{\textquotesingle{}prev\_shares\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh\_sorted.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
\NormalTok{    fh\_sorted[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh\_sorted.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Adjust for corporate actions}
\NormalTok{    fh\_sorted[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh\_sorted.}\BuiltInTok{apply}\NormalTok{(}
        \KeywordTok{lambda}\NormalTok{ r: adjust\_shares(r[}\StringTok{\textquotesingle{}prev\_shares\textquotesingle{}}\NormalTok{], r[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{], }
\NormalTok{                                r[}\StringTok{\textquotesingle{}prev\_date\textquotesingle{}}\NormalTok{], r[}\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{], adj\_factors)}
        \ControlFlowTok{if}\NormalTok{ pd.notna(r[}\StringTok{\textquotesingle{}prev\_shares\textquotesingle{}}\NormalTok{]) }\ControlFlowTok{else}\NormalTok{ np.nan,}
\NormalTok{        axis}\OperatorTok{=}\DecValTok{1}
\NormalTok{    )}
    
\NormalTok{    fh\_sorted[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh\_sorted[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ fh\_sorted[}\StringTok{\textquotesingle{}prev\_shares\_adj\textquotesingle{}}\NormalTok{]}
\NormalTok{    fh\_sorted[}\StringTok{\textquotesingle{}trade\_value\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fh\_sorted[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ fh\_sorted[}\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{] }\OperatorTok{/} \FloatTok{1e9}  \CommentTok{\# Billion VND}
    
    \CommentTok{\# Aggregate buys and sells per fund{-}period}
\NormalTok{    fund\_trades }\OperatorTok{=}\NormalTok{ fh\_sorted[fh\_sorted[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{].notna()].copy()}
\NormalTok{    fund\_flows }\OperatorTok{=}\NormalTok{ fund\_trades.groupby([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{]).agg(}
\NormalTok{        total\_buys}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}trade\_value\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: x[x }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{()),}
\NormalTok{        total\_sales}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}trade\_value\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: }\OperatorTok{{-}}\NormalTok{x[x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{()),}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# {-}{-}{-} Fund{-}Level Aggregates {-}{-}{-}}
\NormalTok{    fund\_agg }\OperatorTok{=}\NormalTok{ fund\_assets.merge(fund\_flows, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{    fund\_agg[[}\StringTok{\textquotesingle{}total\_buys\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}total\_sales\textquotesingle{}}\NormalTok{]] }\OperatorTok{=}\NormalTok{ fund\_agg[[}\StringTok{\textquotesingle{}total\_buys\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}total\_sales\textquotesingle{}}\NormalTok{]].fillna(}\DecValTok{0}\NormalTok{)}
    
\NormalTok{    fund\_agg }\OperatorTok{=}\NormalTok{ fund\_agg.sort\_values([}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{])}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}lag\_assets\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fund\_agg.groupby(}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}total\_assets\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}lag\_hret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fund\_agg.groupby(}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}holdings\_return\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Net flows}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}net\_flows\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (fund\_agg[}\StringTok{\textquotesingle{}total\_assets\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}} 
\NormalTok{                              fund\_agg[}\StringTok{\textquotesingle{}lag\_assets\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ fund\_agg[}\StringTok{\textquotesingle{}holdings\_return\textquotesingle{}}\NormalTok{]))}
    
    \CommentTok{\# Turnover (Carhart definition)}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}avg\_assets\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (fund\_agg[}\StringTok{\textquotesingle{}total\_assets\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ fund\_agg[}\StringTok{\textquotesingle{}lag\_assets\textquotesingle{}}\NormalTok{]) }\OperatorTok{/} \DecValTok{2}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}turnover\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        fund\_agg[[}\StringTok{\textquotesingle{}total\_buys\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}total\_sales\textquotesingle{}}\NormalTok{]].}\BuiltInTok{min}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{) }\OperatorTok{/}\NormalTok{ fund\_agg[}\StringTok{\textquotesingle{}avg\_assets\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
    
    \CommentTok{\# Annualize (approximate, since disclosure may be semi{-}annual)}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}periods\_per\_year\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{365} \OperatorTok{/}\NormalTok{ fund\_agg.groupby(}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}report\_date\textquotesingle{}}\NormalTok{].diff().dt.days}
\NormalTok{    fund\_agg[}\StringTok{\textquotesingle{}turnover\_annual\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ fund\_agg[}\StringTok{\textquotesingle{}turnover\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ fund\_agg[}\StringTok{\textquotesingle{}periods\_per\_year\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{2}\NormalTok{)}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Fund analytics computed:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Unique funds: }\SpecialCharTok{\{}\NormalTok{fund\_agg[}\StringTok{\textquotesingle{}fund\_name\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Fund{-}period observations: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(fund\_agg)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Turnover statistics:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(fund\_agg[[}\StringTok{\textquotesingle{}turnover\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}turnover\_annual\textquotesingle{}}\NormalTok{]].describe().}\BuiltInTok{round}\NormalTok{(}\DecValTok{4}\NormalTok{))}
    
    \ControlFlowTok{return}\NormalTok{ \{}
        \StringTok{\textquotesingle{}fund\_assets\textquotesingle{}}\NormalTok{: fund\_assets,}
        \StringTok{\textquotesingle{}fund\_trades\textquotesingle{}}\NormalTok{: fund\_trades,}
        \StringTok{\textquotesingle{}fund\_aggregates\textquotesingle{}}\NormalTok{: fund\_agg,}
\NormalTok{    \}}

\CommentTok{\# fund\_analytics = compute\_fund\_analytics(dc.fund\_holdings, prices\_q, adj\_factors)}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{State Ownership Analysis}\label{sec-state-ownership}

\subsection{Equitization and the Decline of State
Ownership}\label{equitization-and-the-decline-of-state-ownership}

Vietnam's equitization (c phn ha) program has been a defining feature
of the market since the early 2000s. The program converts state-owned
enterprises into joint-stock companies, typically with the state
retaining a controlling or significant minority stake that is then
gradually reduced through secondary offerings.

\phantomsection\label{state-ownership-analysis}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# ============================================================================}
\CommentTok{\# Step 9: State Ownership Analysis}
\CommentTok{\# ============================================================================}

\KeywordTok{def}\NormalTok{ analyze\_state\_ownership(metrics: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ Dict:}
    \CommentTok{"""}
\CommentTok{    Comprehensive analysis of state ownership in Vietnam.}
\CommentTok{    }
\CommentTok{    Computes:}
\CommentTok{    1. Aggregate state ownership trends}
\CommentTok{    2. SOE population dynamics (entry/exit from SOE classification)}
\CommentTok{    3. Equitization event detection (large drops in state ownership)}
\CommentTok{    4. State ownership by sector and size}
\CommentTok{    5. Governance implications (state as blockholder)}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics.copy()}
    
    \CommentTok{\# {-}{-}{-} 1. Aggregate Trends {-}{-}{-}}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{).agg(}
\NormalTok{        n\_soe}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sum\textquotesingle{}}\NormalTok{),}
\NormalTok{        n\_total}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{        pct\_soe}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        mean\_state\_pct}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        median\_state\_pct}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{),}
        \CommentTok{\# Market cap share of SOEs}
\NormalTok{        soe\_mktcap}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: x[df.loc[x.index, }\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{].}\BuiltInTok{sum}\NormalTok{()),}
\NormalTok{        total\_mktcap}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sum\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).reset\_index()}
\NormalTok{    ts[}\StringTok{\textquotesingle{}soe\_mktcap\_share\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ts[}\StringTok{\textquotesingle{}soe\_mktcap\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ ts[}\StringTok{\textquotesingle{}total\_mktcap\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# {-}{-}{-} 2. Equitization Events {-}{-}{-}}
    \CommentTok{\# Detect large drops in state ownership (\textgreater{}10 percentage points)}
\NormalTok{    df\_sorted }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{])}
\NormalTok{    df\_sorted[}\StringTok{\textquotesingle{}state\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df\_sorted.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{].diff()}
    
\NormalTok{    equitization\_events }\OperatorTok{=}\NormalTok{ df\_sorted[}
\NormalTok{        df\_sorted[}\StringTok{\textquotesingle{}state\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \OperatorTok{{-}}\FloatTok{0.10}  \CommentTok{\# \textgreater{} 10pp drop}
\NormalTok{    ][[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}state\_change\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{]].copy()}
    
    \CommentTok{\# {-}{-}{-} 3. By Sector {-}{-}{-}}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}industry\_code\textquotesingle{}} \KeywordTok{in}\NormalTok{ df.columns:}
\NormalTok{        by\_sector }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}industry\_code\textquotesingle{}}\NormalTok{).agg(}
\NormalTok{            mean\_state}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{            pct\_soe}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_soe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{            n\_firms}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{        ).sort\_values(}\StringTok{\textquotesingle{}mean\_state\textquotesingle{}}\NormalTok{, ascending}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        by\_sector }\OperatorTok{=} \VariableTok{None}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"State Ownership Analysis:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Current SOE count: }\SpecialCharTok{\{}\NormalTok{ts}\SpecialCharTok{.}\NormalTok{iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}n\_soe\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.0f\}}\SpecialStringTok{ / }\SpecialCharTok{\{}\NormalTok{ts}\SpecialCharTok{.}\NormalTok{iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}n\_total\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.0f\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  SOE market cap share: }\SpecialCharTok{\{}\NormalTok{ts}\SpecialCharTok{.}\NormalTok{iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}soe\_mktcap\_share\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Mean state ownership: }\SpecialCharTok{\{}\NormalTok{ts}\SpecialCharTok{.}\NormalTok{iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}mean\_state\_pct\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Equitization events detected: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(equitization\_events)}\SpecialCharTok{:,\}}\SpecialStringTok{"}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ \{}
        \StringTok{\textquotesingle{}trends\textquotesingle{}}\NormalTok{: ts,}
        \StringTok{\textquotesingle{}equitization\_events\textquotesingle{}}\NormalTok{: equitization\_events,}
        \StringTok{\textquotesingle{}by\_sector\textquotesingle{}}\NormalTok{: by\_sector,}
\NormalTok{    \}}

\CommentTok{\# state\_analysis = analyze\_state\_ownership(io\_metrics)}
\end{Highlighting}
\end{Shaded}

\begin{figure}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_state\_ownership(state\_analysis: Dict, metrics: pd.DataFrame):}
    \CommentTok{"""Plot state ownership dynamics."""}
\NormalTok{    fig, axes }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ state\_analysis[}\StringTok{\textquotesingle{}trends\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# Panel A: SOE trends}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{0}\NormalTok{]}
\NormalTok{    ax.plot(ts[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{], ts[}\StringTok{\textquotesingle{}pct\_soe\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{, }
\NormalTok{            label}\OperatorTok{=}\StringTok{\textquotesingle{}}\SpecialCharTok{\% o}\StringTok{f Firms that are SOEs\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#d62728\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.plot(ts[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{], ts[}\StringTok{\textquotesingle{}soe\_mktcap\_share\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{            label}\OperatorTok{=}\StringTok{\textquotesingle{}SOE Market Cap Share (\%)\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#1f77b4\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.plot(ts[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{], ts[}\StringTok{\textquotesingle{}mean\_state\_pct\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
\NormalTok{            label}\OperatorTok{=}\StringTok{\textquotesingle{}Mean State Ownership (\%)\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\DecValTok{2}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#2ca02c\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Percentage\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Panel A: State Ownership and SOE Prevalence Over Time\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend(frameon}\OperatorTok{=}\VariableTok{True}\NormalTok{, framealpha}\OperatorTok{=}\FloatTok{0.9}\NormalTok{)}
    
    \CommentTok{\# Panel B: Distribution}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{1}\NormalTok{]}
    \CommentTok{\# Use most recent period}
\NormalTok{    latest }\OperatorTok{=}\NormalTok{ metrics[metrics[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ metrics[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{].}\BuiltInTok{max}\NormalTok{()]}
\NormalTok{    state\_pct }\OperatorTok{=}\NormalTok{ latest[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{].dropna() }\OperatorTok{*} \DecValTok{100}
    
\NormalTok{    ax.hist(state\_pct, bins}\OperatorTok{=}\DecValTok{50}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#d62728\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{, edgecolor}\OperatorTok{=}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.axvline(x}\OperatorTok{=}\DecValTok{50}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}50\% (SOE threshold)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_xlabel(}\StringTok{\textquotesingle{}State Ownership (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Number of Companies\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.set\_title(}\StringTok{\textquotesingle{}Panel B: Distribution of State Ownership (Most Recent Quarter)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend()}
    
\NormalTok{    plt.tight\_layout()}
\NormalTok{    plt.savefig(}\StringTok{\textquotesingle{}fig\_state\_ownership.png\textquotesingle{}}\NormalTok{, dpi}\OperatorTok{=}\DecValTok{300}\NormalTok{, bbox\_inches}\OperatorTok{=}\StringTok{\textquotesingle{}tight\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.show()}

\CommentTok{\# plot\_state\_ownership(state\_analysis, io\_metrics)}
\end{Highlighting}
\end{Shaded}

}

\caption{\label{fig-state-ownership}}

\end{figure}%

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Modern Extensions}\label{sec-modern-extensions}

\subsection{Network Analysis of Co-Ownership}\label{sec-network}

Institutional co-ownership networks capture how stocks are connected
through shared investors. In Vietnam, these networks reveal the
influence structure of major domestic conglomerates (e.g., Vingroup,
Masan, FPT) and the overlap between foreign fund portfolios.

\phantomsection\label{coownership-network}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ construct\_stock\_coownership\_network(ownership: pd.DataFrame,}
\NormalTok{                                         period: }\BuiltInTok{str}\NormalTok{,}
\NormalTok{                                         min\_overlap: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{3}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ Dict:}
    \CommentTok{"""}
\CommentTok{    Construct a stock{-}level co{-}ownership network.}
\CommentTok{    }
\CommentTok{    Two stocks are connected if they share institutional investors.}
\CommentTok{    Edge weight = number of shared institutional investors.}
\CommentTok{    }
\CommentTok{    This is particularly informative in Vietnam where:}
\CommentTok{    {-} Foreign fund portfolios concentrate on the same blue{-}chips}
\CommentTok{    {-} Conglomerate cross{-}holdings create explicit linkages}
\CommentTok{    {-} State ownership creates implicit connections (SCIC holds multiple stocks)}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    ownership : pd.DataFrame}
\CommentTok{        Classified ownership data}
\CommentTok{    period : str}
\CommentTok{        Analysis date}
\CommentTok{    min\_overlap : int}
\CommentTok{        Minimum shared investors to create an edge}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    dict with network statistics and adjacency data}
\CommentTok{    """}
    \ImportTok{import}\NormalTok{ networkx }\ImportTok{as}\NormalTok{ nx}
    
\NormalTok{    date }\OperatorTok{=}\NormalTok{ pd.Timestamp(period)}
    
    \CommentTok{\# Get institutional holders for this period}
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        (ownership[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ date) }\OperatorTok{\&}
\NormalTok{        (ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL))}
\NormalTok{    ][[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{]].copy()}
    
    \CommentTok{\# Create bipartite mapping: institution  set of stocks held}
\NormalTok{    inst\_to\_stocks }\OperatorTok{=}\NormalTok{ inst.groupby(}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\BuiltInTok{set}\NormalTok{).to\_dict()}
    
    \CommentTok{\# Stock  set of institutions}
\NormalTok{    stock\_to\_inst }\OperatorTok{=}\NormalTok{ inst.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(}\BuiltInTok{set}\NormalTok{).to\_dict()}
    
    \CommentTok{\# Build stock{-}level network}
\NormalTok{    stocks }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(stock\_to\_inst.keys())}
\NormalTok{    G }\OperatorTok{=}\NormalTok{ nx.Graph()}
    
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(stocks)):}
        \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(i }\OperatorTok{+} \DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(stocks)):}
\NormalTok{            shared }\OperatorTok{=}\NormalTok{ stock\_to\_inst[stocks[i]] }\OperatorTok{\&}\NormalTok{ stock\_to\_inst[stocks[j]]}
            \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(shared) }\OperatorTok{\textgreater{}=}\NormalTok{ min\_overlap:}
\NormalTok{                G.add\_edge(stocks[i], stocks[j], weight}\OperatorTok{=}\BuiltInTok{len}\NormalTok{(shared),}
\NormalTok{                           shared\_investors}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(shared)[:}\DecValTok{5}\NormalTok{])  }\CommentTok{\# Store sample}
    
    \CommentTok{\# Add node attributes}
    \ControlFlowTok{for}\NormalTok{ stock }\KeywordTok{in}\NormalTok{ stocks:}
        \ControlFlowTok{if}\NormalTok{ stock }\KeywordTok{in}\NormalTok{ G.nodes:}
\NormalTok{            G.nodes[stock][}\StringTok{\textquotesingle{}n\_inst\_holders\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(stock\_to\_inst[stock])}
    
    \CommentTok{\# Network statistics}
\NormalTok{    stats }\OperatorTok{=}\NormalTok{ \{}
        \StringTok{\textquotesingle{}n\_nodes\textquotesingle{}}\NormalTok{: G.number\_of\_nodes(),}
        \StringTok{\textquotesingle{}n\_edges\textquotesingle{}}\NormalTok{: G.number\_of\_edges(),}
        \StringTok{\textquotesingle{}density\textquotesingle{}}\NormalTok{: nx.density(G) }\ControlFlowTok{if}\NormalTok{ G.number\_of\_nodes() }\OperatorTok{\textgreater{}} \DecValTok{1} \ControlFlowTok{else} \DecValTok{0}\NormalTok{,}
        \StringTok{\textquotesingle{}avg\_clustering\textquotesingle{}}\NormalTok{: nx.average\_clustering(G, weight}\OperatorTok{=}\StringTok{\textquotesingle{}weight\textquotesingle{}}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ G.number\_of\_nodes() }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else} \DecValTok{0}\NormalTok{,}
        \StringTok{\textquotesingle{}n\_components\textquotesingle{}}\NormalTok{: nx.number\_connected\_components(G),}
\NormalTok{    \}}
    
    \CommentTok{\# Centrality measures}
    \ControlFlowTok{if}\NormalTok{ G.number\_of\_nodes() }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{        degree\_cent }\OperatorTok{=}\NormalTok{ nx.degree\_centrality(G)}
\NormalTok{        stats[}\StringTok{\textquotesingle{}most\_connected\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \BuiltInTok{sorted}\NormalTok{(degree\_cent.items(), }
\NormalTok{                                          key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:}\DecValTok{10}\NormalTok{]}
        
        \ControlFlowTok{if}\NormalTok{ G.number\_of\_nodes() }\OperatorTok{\textgreater{}} \DecValTok{2}\NormalTok{:}
            \ControlFlowTok{try}\NormalTok{:}
\NormalTok{                eigen\_cent }\OperatorTok{=}\NormalTok{ nx.eigenvector\_centrality\_numpy(G, weight}\OperatorTok{=}\StringTok{\textquotesingle{}weight\textquotesingle{}}\NormalTok{)}
\NormalTok{                stats[}\StringTok{\textquotesingle{}most\_central\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \BuiltInTok{sorted}\NormalTok{(eigen\_cent.items(),}
\NormalTok{                                                key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:}\DecValTok{10}\NormalTok{]}
            \ControlFlowTok{except} \PreprocessorTok{Exception}\NormalTok{:}
\NormalTok{                stats[}\StringTok{\textquotesingle{}most\_central\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ []}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Co{-}Ownership Network (}\SpecialCharTok{\{}\NormalTok{period}\SpecialCharTok{\}}\SpecialStringTok{):"}\NormalTok{)}
    \ControlFlowTok{for}\NormalTok{ k, v }\KeywordTok{in}\NormalTok{ stats.items():}
        \ControlFlowTok{if}\NormalTok{ k }\KeywordTok{not} \KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}most\_connected\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}most\_central\textquotesingle{}}\NormalTok{]:}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{k}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\NormalTok{v}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
    
    \ControlFlowTok{if} \StringTok{\textquotesingle{}most\_connected\textquotesingle{}} \KeywordTok{in}\NormalTok{ stats:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Most connected stocks:"}\NormalTok{)}
        \ControlFlowTok{for}\NormalTok{ stock, cent }\KeywordTok{in}\NormalTok{ stats[}\StringTok{\textquotesingle{}most\_connected\textquotesingle{}}\NormalTok{][:}\DecValTok{5}\NormalTok{]:}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{stock}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\NormalTok{cent}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}graph\textquotesingle{}}\NormalTok{: G, }\StringTok{\textquotesingle{}stats\textquotesingle{}}\NormalTok{: stats\}}

\CommentTok{\# network = construct\_stock\_coownership\_network(}
\CommentTok{\#     ownership\_classified, \textquotesingle{}2024{-}06{-}30\textquotesingle{}}
\CommentTok{\# )}
\end{Highlighting}
\end{Shaded}

\subsection{ML-Enhanced Investor
Classification}\label{sec-ml-classification}

Vietnam's investor classification challenge is distinct from the US.
While the US has the Bushee typology based on portfolio turnover and
concentration, Vietnam requires classification of both investor
\textbf{type} (when not explicitly labeled) and investor
\textbf{behavior} (active vs passive, short-term vs long-term).

\phantomsection\label{ml-classification-vn}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ classify\_investors\_vietnam(ownership: pd.DataFrame,}
\NormalTok{                                prices\_q: pd.DataFrame,}
\NormalTok{                                n\_clusters: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{4}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    ML{-}based classification of Vietnamese institutional investors.}
\CommentTok{    }
\CommentTok{    Features adapted for Vietnam\textquotesingle{}s market:}
\CommentTok{    1. Portfolio concentration (HHI of holdings)}
\CommentTok{    2. Holding duration (average time in positions)}
\CommentTok{    3. Size preference (average market cap of holdings)}
\CommentTok{    4. Sector concentration}
\CommentTok{    5. Foreign/domestic indicator}
\CommentTok{    6. Trading frequency (inverse of average days between disclosures)}
\CommentTok{    }
\CommentTok{    Expected clusters for Vietnam:}
\CommentTok{    {-} Passive State Holders: SOE parents, SCIC {-} low turnover, concentrated}
\CommentTok{    {-} Active Foreign Funds: Dragon Capital, VinaCapital {-} moderate turnover}
\CommentTok{    {-} Domestic Securities Firms: SSI, VNDirect {-} high turnover, diversified}
\CommentTok{    {-} Long{-}Term Foreign: Pension funds, sovereign wealth {-} low turnover}
\CommentTok{    """}
    \ImportTok{from}\NormalTok{ sklearn.cluster }\ImportTok{import}\NormalTok{ KMeans}
    \ImportTok{from}\NormalTok{ sklearn.preprocessing }\ImportTok{import}\NormalTok{ StandardScaler}
    
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ ownership[}
\NormalTok{        ownership[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(OwnershipType.INSTITUTIONAL)}
\NormalTok{    ].copy()}
    
    \CommentTok{\# Merge with price data}
\NormalTok{    inst }\OperatorTok{=}\NormalTok{ inst.merge(}
\NormalTok{        prices\_q[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{]],}
\NormalTok{        left\_on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{],}
\NormalTok{        right\_on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}
\NormalTok{    )}
    
\NormalTok{    inst[}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ inst[}\StringTok{\textquotesingle{}shares\_held\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ inst[}\StringTok{\textquotesingle{}close\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{)}
    
    \CommentTok{\# Compute features per investor{-}period}
\NormalTok{    features }\OperatorTok{=}\NormalTok{ inst.groupby([}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]).agg(}
\NormalTok{        n\_stocks}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{        total\_value}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sum\textquotesingle{}}\NormalTok{),}
\NormalTok{        hhi\_portfolio}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}holding\_value\textquotesingle{}}\NormalTok{, }
                        \KeywordTok{lambda}\NormalTok{ x: ((x}\OperatorTok{/}\NormalTok{x.}\BuiltInTok{sum}\NormalTok{())}\OperatorTok{**}\DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\ControlFlowTok{if}\NormalTok{ x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else}\NormalTok{ np.nan),}
\NormalTok{        avg\_mktcap}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}market\_cap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        is\_foreign}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{, }
                     \KeywordTok{lambda}\NormalTok{ x: (x }\OperatorTok{==}\NormalTok{ OwnershipType.FOREIGN\_INST).}\BuiltInTok{any}\NormalTok{().astype(}\BuiltInTok{int}\NormalTok{)),}
\NormalTok{        is\_state}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{, }
                   \KeywordTok{lambda}\NormalTok{ x: (x }\OperatorTok{==}\NormalTok{ OwnershipType.STATE).}\BuiltInTok{any}\NormalTok{().astype(}\BuiltInTok{int}\NormalTok{)),}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# Average across all periods per investor}
\NormalTok{    investor\_features }\OperatorTok{=}\NormalTok{ features.groupby(}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{).agg(}
\NormalTok{        avg\_n\_stocks}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}n\_stocks\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        avg\_hhi}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}hhi\_portfolio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        avg\_mktcap}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}avg\_mktcap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        avg\_total\_value}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}total\_value\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        is\_foreign}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{),}
\NormalTok{        is\_state}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{),}
\NormalTok{        n\_periods}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).dropna()}
    
    \CommentTok{\# Feature matrix}
\NormalTok{    feature\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}avg\_n\_stocks\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}avg\_hhi\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}avg\_mktcap\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}avg\_total\_value\textquotesingle{}}\NormalTok{]}
\NormalTok{    X }\OperatorTok{=}\NormalTok{ investor\_features[feature\_cols].copy()}
    
    \CommentTok{\# Log{-}transform}
    \ControlFlowTok{for}\NormalTok{ col }\KeywordTok{in}\NormalTok{ feature\_cols:}
\NormalTok{        X[col] }\OperatorTok{=}\NormalTok{ np.log1p(X[col].clip(lower}\OperatorTok{=}\DecValTok{0}\NormalTok{))}
    
    \CommentTok{\# Add binary features}
\NormalTok{    X[}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ investor\_features[}\StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{]}
\NormalTok{    X[}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ investor\_features[}\StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# Standardize}
\NormalTok{    scaler }\OperatorTok{=}\NormalTok{ StandardScaler()}
\NormalTok{    X\_scaled }\OperatorTok{=}\NormalTok{ scaler.fit\_transform(X)}
    
    \CommentTok{\# K{-}means}
\NormalTok{    kmeans }\OperatorTok{=}\NormalTok{ KMeans(n\_clusters}\OperatorTok{=}\NormalTok{n\_clusters, random\_state}\OperatorTok{=}\DecValTok{42}\NormalTok{, n\_init}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{    investor\_features[}\StringTok{\textquotesingle{}cluster\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ kmeans.fit\_predict(X\_scaled)}
    
    \CommentTok{\# Label clusters}
\NormalTok{    cluster\_profiles }\OperatorTok{=}\NormalTok{ investor\_features.groupby(}\StringTok{\textquotesingle{}cluster\textquotesingle{}}\NormalTok{).agg(\{}
        \StringTok{\textquotesingle{}avg\_n\_stocks\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}avg\_hhi\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}avg\_total\_value\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}is\_foreign\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}is\_state\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}count\textquotesingle{}}\NormalTok{,}
\NormalTok{    \}).rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}n\_investors\textquotesingle{}}\NormalTok{\})}
    
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Investor Clusters:"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(cluster\_profiles.}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{).to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ investor\_features}

\CommentTok{\# investor\_classes = classify\_investors\_vietnam(ownership\_classified, prices\_q)}
\end{Highlighting}
\end{Shaded}

\subsection{Event Study: Ownership Disclosure
Shocks}\label{sec-event-study}

Vietnam's threshold-based major shareholder disclosure creates natural
events for studying the price impact of ownership changes.

\phantomsection\label{event-study}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ ownership\_event\_study(major\_shareholders: pd.DataFrame,}
\NormalTok{                           prices: pd.DataFrame,}
\NormalTok{                           event\_window: Tuple[}\BuiltInTok{int}\NormalTok{, }\BuiltInTok{int}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{20}\NormalTok{),}
\NormalTok{                           estimation\_window: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{120}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Event study of ownership disclosure announcements.}
\CommentTok{    }
\CommentTok{    Vietnam requires major shareholders (5\%) to disclose within 7 }
\CommentTok{    business days of crossing ownership thresholds. These disclosures }
\CommentTok{    can be informationally significant, especially:}
\CommentTok{    1. Foreign fund accumulation (signal of quality)}
\CommentTok{    2. State divestiture (equitization signal)}
\CommentTok{    3. Insider purchases (management confidence signal)}
\CommentTok{    }
\CommentTok{    Uses market model for expected returns:}
\CommentTok{    E[R\_i,t] = \_i + \_i  R\_m,t}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    major\_shareholders : pd.DataFrame}
\CommentTok{        Disclosure events from DataCore.vn}
\CommentTok{    prices : pd.DataFrame}
\CommentTok{        Daily stock prices}
\CommentTok{    event\_window : tuple}
\CommentTok{        (pre\_event\_days, post\_event\_days)}
\CommentTok{    estimation\_window : int}
\CommentTok{        Days before event window for market model estimation}
\CommentTok{    """}
\NormalTok{    events }\OperatorTok{=}\NormalTok{ major\_shareholders.copy()}
\NormalTok{    events }\OperatorTok{=}\NormalTok{ events.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Identify significant ownership changes}
\NormalTok{    events[}\StringTok{\textquotesingle{}ownership\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ events.groupby(}
\NormalTok{        [}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
\NormalTok{    )[}\StringTok{\textquotesingle{}ownership\_pct\textquotesingle{}}\NormalTok{].diff()}
    
\NormalTok{    significant\_events }\OperatorTok{=}\NormalTok{ events[}
\NormalTok{        events[}\StringTok{\textquotesingle{}ownership\_change\textquotesingle{}}\NormalTok{].}\BuiltInTok{abs}\NormalTok{() }\OperatorTok{\textgreater{}} \FloatTok{0.01}  \CommentTok{\# \textgreater{} 1 percentage point}
\NormalTok{    ].copy()}
    
\NormalTok{    significant\_events[}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.where(}
\NormalTok{        significant\_events[}\StringTok{\textquotesingle{}ownership\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\StringTok{\textquotesingle{}accumulation\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}divestiture\textquotesingle{}}
\NormalTok{    )}
    
    \CommentTok{\# Merge with daily prices}
\NormalTok{    prices\_daily }\OperatorTok{=}\NormalTok{ prices[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]].copy()}
\NormalTok{    prices\_daily }\OperatorTok{=}\NormalTok{ prices\_daily.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# VN{-}Index as market return (ticker code depends on data provider)}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}VNINDEX\textquotesingle{}} \KeywordTok{in}\NormalTok{ prices\_daily[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].values:}
\NormalTok{        market\_ret }\OperatorTok{=}\NormalTok{ prices\_daily[prices\_daily[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}VNINDEX\textquotesingle{}}\NormalTok{][[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]].copy()}
\NormalTok{        market\_ret }\OperatorTok{=}\NormalTok{ market\_ret.rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{\})}
    \ControlFlowTok{else}\NormalTok{:}
        \CommentTok{\# Use equal{-}weighted market return as proxy}
\NormalTok{        market\_ret }\OperatorTok{=}\NormalTok{ (prices\_daily.groupby(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]}
\NormalTok{                                  .mean()}
\NormalTok{                                  .reset\_index()}
\NormalTok{                                  .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{\}))}
    
    \CommentTok{\# For each event, compute abnormal returns}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ []}
\NormalTok{    pre, post }\OperatorTok{=}\NormalTok{ event\_window}
    
    \ControlFlowTok{for}\NormalTok{ \_, event }\KeywordTok{in}\NormalTok{ significant\_events.iterrows():}
\NormalTok{        ticker }\OperatorTok{=}\NormalTok{ event[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{]}
\NormalTok{        event\_date }\OperatorTok{=}\NormalTok{ event[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}
        
        \CommentTok{\# Get stock returns around the event}
\NormalTok{        stock\_ret }\OperatorTok{=}\NormalTok{ prices\_daily[prices\_daily[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker].copy()}
\NormalTok{        stock\_ret }\OperatorTok{=}\NormalTok{ stock\_ret.merge(market\_ret, on}\OperatorTok{=}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{        stock\_ret }\OperatorTok{=}\NormalTok{ stock\_ret.sort\_values(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
        
        \CommentTok{\# Find event date index}
\NormalTok{        event\_idx }\OperatorTok{=}\NormalTok{ stock\_ret[stock\_ret[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=}\NormalTok{ event\_date].index}
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(event\_idx) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
            \ControlFlowTok{continue}
\NormalTok{        event\_idx }\OperatorTok{=}\NormalTok{ event\_idx[}\DecValTok{0}\NormalTok{]}
        
        \CommentTok{\# Estimation window}
\NormalTok{        est\_start }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(}\DecValTok{0}\NormalTok{, event\_idx }\OperatorTok{{-}}\NormalTok{ estimation\_window }\OperatorTok{+}\NormalTok{ pre)}
\NormalTok{        est\_end }\OperatorTok{=}\NormalTok{ event\_idx }\OperatorTok{+}\NormalTok{ pre}
\NormalTok{        est\_data }\OperatorTok{=}\NormalTok{ stock\_ret.iloc[est\_start:est\_end].dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{])}
        
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(est\_data) }\OperatorTok{\textless{}} \DecValTok{30}\NormalTok{:}
            \ControlFlowTok{continue}
        
        \CommentTok{\# Market model}
\NormalTok{        X }\OperatorTok{=}\NormalTok{ sm.add\_constant(est\_data[}\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{])}
\NormalTok{        y }\OperatorTok{=}\NormalTok{ est\_data[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]}
        \ControlFlowTok{try}\NormalTok{:}
\NormalTok{            model }\OperatorTok{=}\NormalTok{ sm.OLS(y, X).fit()}
        \ControlFlowTok{except} \PreprocessorTok{Exception}\NormalTok{:}
            \ControlFlowTok{continue}
        
        \CommentTok{\# Event window abnormal returns}
\NormalTok{        ew\_start }\OperatorTok{=}\NormalTok{ event\_idx }\OperatorTok{+}\NormalTok{ pre}
\NormalTok{        ew\_end }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(event\_idx }\OperatorTok{+}\NormalTok{ post }\OperatorTok{+} \DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(stock\_ret))}
\NormalTok{        event\_data }\OperatorTok{=}\NormalTok{ stock\_ret.iloc[ew\_start:ew\_end].copy()}
        
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(event\_data) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
            \ControlFlowTok{continue}
        
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}expected\_ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (model.params[}\StringTok{\textquotesingle{}const\textquotesingle{}}\NormalTok{] }\OperatorTok{+} 
\NormalTok{                                       model.params[}\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ event\_data[}\StringTok{\textquotesingle{}mkt\_ret\textquotesingle{}}\NormalTok{])}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}abnormal\_ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event\_data[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ event\_data[}\StringTok{\textquotesingle{}expected\_ret\textquotesingle{}}\NormalTok{]}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}car\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event\_data[}\StringTok{\textquotesingle{}abnormal\_ret\textquotesingle{}}\NormalTok{].cumsum()}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}event\_day\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \BuiltInTok{range}\NormalTok{(pre, pre }\OperatorTok{+} \BuiltInTok{len}\NormalTok{(event\_data))}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ticker}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event\_date}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event[}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{]}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}ownership\_change\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event[}\StringTok{\textquotesingle{}ownership\_change\textquotesingle{}}\NormalTok{]}
\NormalTok{        event\_data[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ event[}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{]}
        
\NormalTok{        results.append(event\_data)}
    
    \ControlFlowTok{if}\NormalTok{ results:}
\NormalTok{        all\_results }\OperatorTok{=}\NormalTok{ pd.concat(results, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
        
        \CommentTok{\# Average CARs by event type}
\NormalTok{        avg\_car }\OperatorTok{=}\NormalTok{ (all\_results.groupby([}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}event\_day\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}car\textquotesingle{}}\NormalTok{]}
\NormalTok{                              .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}count\textquotesingle{}}\NormalTok{])}
\NormalTok{                              .reset\_index())}
\NormalTok{        avg\_car[}\StringTok{\textquotesingle{}t\_stat\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ avg\_car[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ (avg\_car[}\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ np.sqrt(avg\_car[}\StringTok{\textquotesingle{}count\textquotesingle{}}\NormalTok{]))}
        
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Event Study Results:"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Total events: }\SpecialCharTok{\{}\NormalTok{significant\_events[}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{value\_counts()}\SpecialCharTok{.}\NormalTok{to\_string()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
        
        \CommentTok{\# CAR at event day 0, +5, +10, +20}
        \ControlFlowTok{for}\NormalTok{ et }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}accumulation\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}divestiture\textquotesingle{}}\NormalTok{]:}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{  }\SpecialCharTok{\{}\NormalTok{et}\SpecialCharTok{.}\NormalTok{title()}\SpecialCharTok{\}}\SpecialStringTok{ Events:"}\NormalTok{)}
\NormalTok{            subset }\OperatorTok{=}\NormalTok{ avg\_car[avg\_car[}\StringTok{\textquotesingle{}event\_type\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ et]}
            \ControlFlowTok{for}\NormalTok{ day }\KeywordTok{in}\NormalTok{ [}\DecValTok{0}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{]:}
\NormalTok{                row }\OperatorTok{=}\NormalTok{ subset[subset[}\StringTok{\textquotesingle{}event\_day\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ day]}
                \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(row) }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
                    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"    CAR(}\SpecialCharTok{\{}\NormalTok{day}\SpecialCharTok{:+d\}}\SpecialStringTok{): }\SpecialCharTok{\{}\NormalTok{row}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{][}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{ "}
                          \SpecialStringTok{f"(t=}\SpecialCharTok{\{}\NormalTok{row}\SpecialCharTok{.}\NormalTok{iloc[}\DecValTok{0}\NormalTok{][}\StringTok{\textquotesingle{}t\_stat\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.2f\}}\SpecialStringTok{)"}\NormalTok{)}
        
        \ControlFlowTok{return}\NormalTok{ all\_results}
    
    \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}

\CommentTok{\# event\_results = ownership\_event\_study(dc.major\_shareholders, dc.prices)}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Empirical Applications}\label{sec-empirical-applications}

\subsection{Application 1: Foreign Ownership and Stock Returns in
Vietnam}\label{application-1-foreign-ownership-and-stock-returns-in-vietnam}

Does foreign institutional ownership predict returns in Vietnam? Huang,
Liu, and Shu (2023) find evidence consistent with the information
advantage hypothesis.

\phantomsection\label{foreign-io-returns}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ test\_foreign\_io\_returns(metrics: pd.DataFrame) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Test whether changes in foreign institutional ownership predict }
\CommentTok{    future stock returns in Vietnam.}
\CommentTok{    }
\CommentTok{    Methodology:}
\CommentTok{    1. Sort stocks into quintiles by change in foreign IO}
\CommentTok{    2. Compute equal{-}weighted and VN{-}Index{-}adjusted returns}
\CommentTok{    3. Report portfolio returns and long{-}short spread}
\CommentTok{    }
\CommentTok{    This adapts the Chen, Hong, and Stein (2002) breadth test }
\CommentTok{    specifically for Vietnam\textquotesingle{}s foreign ownership component.}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics.copy()}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.sort\_values([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Change in foreign IO}
\NormalTok{    df[}\StringTok{\textquotesingle{}delta\_foreign\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{].diff()}
    
    \CommentTok{\# Forward quarterly return}
\NormalTok{    df[}\StringTok{\textquotesingle{}fwd\_ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{].shift(}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Drop missing}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.dropna(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}delta\_foreign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fwd\_ret\textquotesingle{}}\NormalTok{])}
    
    \CommentTok{\# Quintile portfolios each quarter}
\NormalTok{    df[}\StringTok{\textquotesingle{}foreign\_quintile\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}delta\_foreign\textquotesingle{}}\NormalTok{].transform(}
        \KeywordTok{lambda}\NormalTok{ x: pd.qcut(x, }\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{], duplicates}\OperatorTok{=}\StringTok{\textquotesingle{}drop\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
    
    \CommentTok{\# Portfolio returns}
\NormalTok{    port\_ret }\OperatorTok{=}\NormalTok{ (df.groupby([}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foreign\_quintile\textquotesingle{}}\NormalTok{])[}\StringTok{\textquotesingle{}fwd\_ret\textquotesingle{}}\NormalTok{]}
\NormalTok{                  .mean()}
\NormalTok{                  .reset\_index())}
    
\NormalTok{    port\_wide }\OperatorTok{=}\NormalTok{ port\_ret.pivot(index}\OperatorTok{=}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}foreign\_quintile\textquotesingle{}}\NormalTok{, }
\NormalTok{                                values}\OperatorTok{=}\StringTok{\textquotesingle{}fwd\_ret\textquotesingle{}}\NormalTok{)}
\NormalTok{    port\_wide[}\StringTok{\textquotesingle{}LS\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ port\_wide[}\DecValTok{5}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ port\_wide[}\DecValTok{1}\NormalTok{]}
    
    \CommentTok{\# Test significance}
\NormalTok{    results }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ q }\KeywordTok{in}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{\textquotesingle{}LS\textquotesingle{}}\NormalTok{]:}
\NormalTok{        data }\OperatorTok{=}\NormalTok{ port\_wide[q].dropna()}
\NormalTok{        mean\_ret }\OperatorTok{=}\NormalTok{ data.mean()}
\NormalTok{        t\_stat }\OperatorTok{=}\NormalTok{ mean\_ret }\OperatorTok{/}\NormalTok{ (data.std() }\OperatorTok{/}\NormalTok{ np.sqrt(}\BuiltInTok{len}\NormalTok{(data)))}
\NormalTok{        results[q] }\OperatorTok{=}\NormalTok{ \{}
            \StringTok{\textquotesingle{}Mean Return (\%)\textquotesingle{}}\NormalTok{: mean\_ret }\OperatorTok{*} \DecValTok{100}\NormalTok{,}
            \StringTok{\textquotesingle{}t{-}statistic\textquotesingle{}}\NormalTok{: t\_stat,}
            \StringTok{\textquotesingle{}N quarters\textquotesingle{}}\NormalTok{: }\BuiltInTok{len}\NormalTok{(data),}
\NormalTok{        \}}
    
\NormalTok{    results\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(results).T}
\NormalTok{    results\_df.index.name }\OperatorTok{=} \StringTok{\textquotesingle{}Foreign IO Quintile\textquotesingle{}}
    
    \BuiltInTok{print}\NormalTok{(}\StringTok{"Foreign Ownership Change and Future Returns (Vietnam)"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{60}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(results\_df.}\BuiltInTok{round}\NormalTok{(}\DecValTok{3}\NormalTok{).to\_string())}
    
    \ControlFlowTok{return}\NormalTok{ results\_df}

\CommentTok{\# foreign\_return\_results = test\_foreign\_io\_returns(io\_metrics)}
\end{Highlighting}
\end{Shaded}

\subsection{Application 2: State Divestiture and Value
Creation}\label{application-2-state-divestiture-and-value-creation}

\phantomsection\label{equitization-value}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ analyze\_equitization\_value(metrics: pd.DataFrame, }
\NormalTok{                                state\_analysis: Dict) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Test whether reductions in state ownership are associated with }
\CommentTok{    subsequent value creation (higher returns, improved governance).}
\CommentTok{    }
\CommentTok{    Hypothesis: State divestiture reduces agency costs, improves }
\CommentTok{    operational efficiency, and attracts institutional investors,}
\CommentTok{    leading to positive abnormal returns.}
\CommentTok{    }
\CommentTok{    Uses a difference{-}in{-}differences approach:}
\CommentTok{    Treatment: Firms experiencing \textgreater{}10pp drop in state ownership}
\CommentTok{    Control: Matched firms with stable state ownership}
\CommentTok{    """}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ metrics.copy()}
\NormalTok{    events }\OperatorTok{=}\NormalTok{ state\_analysis[}\StringTok{\textquotesingle{}equitization\_events\textquotesingle{}}\NormalTok{]}
    
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(events) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"No equitization events detected."}\NormalTok{)}
        \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}
    
    \CommentTok{\# Get treated firms and their event quarters}
\NormalTok{    treated }\OperatorTok{=}\NormalTok{ events[[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{]].drop\_duplicates()}
\NormalTok{    treated[}\StringTok{\textquotesingle{}treated\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{1}
    
    \CommentTok{\# Merge with metrics}
\NormalTok{    df }\OperatorTok{=}\NormalTok{ df.merge(treated, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{    df[}\StringTok{\textquotesingle{}treated\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}treated\textquotesingle{}}\NormalTok{].fillna(}\DecValTok{0}\NormalTok{)}
    
    \CommentTok{\# Pre/post comparison for treated firms}
\NormalTok{    treated\_tickers }\OperatorTok{=}\NormalTok{ treated[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{].unique()}
    
\NormalTok{    results }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ ticker }\KeywordTok{in}\NormalTok{ treated\_tickers:}
\NormalTok{        firm }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ ticker].sort\_values(}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{)}
\NormalTok{        event\_row }\OperatorTok{=}\NormalTok{ firm[firm[}\StringTok{\textquotesingle{}treated\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{1}\NormalTok{]}
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(event\_row) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
            \ControlFlowTok{continue}
        
\NormalTok{        event\_q }\OperatorTok{=}\NormalTok{ event\_row.iloc[}\DecValTok{0}\NormalTok{][}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{]}
        
        \CommentTok{\# Pre{-}event (4 quarters before)}
\NormalTok{        pre }\OperatorTok{=}\NormalTok{ firm[firm[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}}\NormalTok{ event\_q].tail(}\DecValTok{4}\NormalTok{)}
        \CommentTok{\# Post{-}event (4 quarters after)}
\NormalTok{        post }\OperatorTok{=}\NormalTok{ firm[firm[}\StringTok{\textquotesingle{}quarter\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ event\_q].head(}\DecValTok{4}\NormalTok{)}
        
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(pre) }\OperatorTok{\textless{}} \DecValTok{2} \KeywordTok{or} \BuiltInTok{len}\NormalTok{(post) }\OperatorTok{\textless{}} \DecValTok{2}\NormalTok{:}
            \ControlFlowTok{continue}
        
\NormalTok{        results.append(\{}
            \StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{: ticker,}
            \StringTok{\textquotesingle{}event\_quarter\textquotesingle{}}\NormalTok{: event\_q,}
            \StringTok{\textquotesingle{}state\_pct\_pre\textquotesingle{}}\NormalTok{: pre[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}state\_pct\_post\textquotesingle{}}\NormalTok{: post[}\StringTok{\textquotesingle{}pct\_state\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}foreign\_pct\_pre\textquotesingle{}}\NormalTok{: pre[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}foreign\_pct\_post\textquotesingle{}}\NormalTok{: post[}\StringTok{\textquotesingle{}pct\_foreign\_total\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}n\_inst\_pre\textquotesingle{}}\NormalTok{: pre[}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}n\_inst\_post\textquotesingle{}}\NormalTok{: post[}\StringTok{\textquotesingle{}n\_inst\_owners\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}ret\_pre\textquotesingle{}}\NormalTok{: pre[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{].mean(),}
            \StringTok{\textquotesingle{}ret\_post\textquotesingle{}}\NormalTok{: post[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{].mean(),}
\NormalTok{        \})}
    
    \ControlFlowTok{if}\NormalTok{ results:}
\NormalTok{        results\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(results)}
        
        \CommentTok{\# Paired t{-}tests}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"Equitization Value Analysis"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{60}\NormalTok{)}
        \ControlFlowTok{for}\NormalTok{ metric }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}state\_pct\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foreign\_pct\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}n\_inst\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{]:}
\NormalTok{            pre\_col }\OperatorTok{=} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{metric}\SpecialCharTok{\}}\SpecialStringTok{\_pre\textquotesingle{}}
\NormalTok{            post\_col }\OperatorTok{=} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{metric}\SpecialCharTok{\}}\SpecialStringTok{\_post\textquotesingle{}}
\NormalTok{            diff }\OperatorTok{=}\NormalTok{ results\_df[post\_col] }\OperatorTok{{-}}\NormalTok{ results\_df[pre\_col]}
\NormalTok{            t\_stat, p\_val }\OperatorTok{=}\NormalTok{ stats.ttest\_1samp(diff.dropna(), }\DecValTok{0}\NormalTok{)}
            \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{metric}\SpecialCharTok{\}}\SpecialStringTok{: }\SpecialCharTok{\{}\NormalTok{diff}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{ (t=}\SpecialCharTok{\{}\NormalTok{t\_stat}\SpecialCharTok{:.2f\}}\SpecialStringTok{, p=}\SpecialCharTok{\{}\NormalTok{p\_val}\SpecialCharTok{:.3f\}}\SpecialStringTok{)"}\NormalTok{)}
        
        \ControlFlowTok{return}\NormalTok{ results\_df}
    
    \ControlFlowTok{return}\NormalTok{ pd.DataFrame()}

\CommentTok{\# equitization\_results = analyze\_equitization\_value(io\_metrics, state\_analysis)}
\end{Highlighting}
\end{Shaded}

\subsection{Application 3: Institutional Herding in
Vietnam}\label{application-3-institutional-herding-in-vietnam}

\phantomsection\label{herding-vn}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_herding\_vietnam(trades: pd.DataFrame,}
\NormalTok{                             owner\_types: Optional[List[}\BuiltInTok{str}\NormalTok{]] }\OperatorTok{=} \VariableTok{None}\NormalTok{) }\OperatorTok{{-}\textgreater{}}\NormalTok{ pd.DataFrame:}
    \CommentTok{"""}
\CommentTok{    Compute the Lakonishok, Shleifer, and Vishny (1992) herding measure}
\CommentTok{    adapted for the Vietnamese market.}
\CommentTok{    }
\CommentTok{    Can be computed separately for:}
\CommentTok{    {-} All institutional investors}
\CommentTok{    {-} Foreign institutions only}
\CommentTok{    {-} Domestic institutions only}
\CommentTok{    }
\CommentTok{    The herding measure captures whether institutions systematically}
\CommentTok{    trade in the same direction beyond what chance would predict.}
\CommentTok{    """}
    \ImportTok{from}\NormalTok{ scipy.stats }\ImportTok{import}\NormalTok{ binom}
    
\NormalTok{    t }\OperatorTok{=}\NormalTok{ trades.copy()}
    
    \ControlFlowTok{if}\NormalTok{ owner\_types:}
\NormalTok{        t }\OperatorTok{=}\NormalTok{ t[t[}\StringTok{\textquotesingle{}owner\_type\textquotesingle{}}\NormalTok{].isin(owner\_types)]}
    
\NormalTok{    t[}\StringTok{\textquotesingle{}is\_buy\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (t[}\StringTok{\textquotesingle{}trade\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{).astype(}\BuiltInTok{int}\NormalTok{)}
    
    \CommentTok{\# For each stock{-}period}
\NormalTok{    stock\_trades }\OperatorTok{=}\NormalTok{ t.groupby([}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]).agg(}
\NormalTok{        n\_traders}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}shareholder\_name\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{        n\_buyers}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}is\_buy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sum\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).reset\_index()}
    
    \CommentTok{\# Minimum traders threshold}
\NormalTok{    stock\_trades }\OperatorTok{=}\NormalTok{ stock\_trades[stock\_trades[}\StringTok{\textquotesingle{}n\_traders\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=} \DecValTok{3}\NormalTok{]}
\NormalTok{    stock\_trades[}\StringTok{\textquotesingle{}p\_buy\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ stock\_trades[}\StringTok{\textquotesingle{}n\_buyers\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ stock\_trades[}\StringTok{\textquotesingle{}n\_traders\textquotesingle{}}\NormalTok{]}
    
    \CommentTok{\# Expected proportion per period}
\NormalTok{    E\_p }\OperatorTok{=}\NormalTok{ stock\_trades.groupby(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(}
        \KeywordTok{lambda}\NormalTok{ g: g[}\StringTok{\textquotesingle{}n\_buyers\textquotesingle{}}\NormalTok{].}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ g[}\StringTok{\textquotesingle{}n\_traders\textquotesingle{}}\NormalTok{].}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    ).reset\_index(name}\OperatorTok{=}\StringTok{\textquotesingle{}E\_p\textquotesingle{}}\NormalTok{)}
    
\NormalTok{    stock\_trades }\OperatorTok{=}\NormalTok{ stock\_trades.merge(E\_p, on}\OperatorTok{=}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Adjustment factor}
    \KeywordTok{def}\NormalTok{ expected\_abs\_dev(n, p):}
\NormalTok{        k }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, n }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{        probs }\OperatorTok{=}\NormalTok{ binom.pmf(k, n, p)}
        \ControlFlowTok{return}\NormalTok{ np.}\BuiltInTok{sum}\NormalTok{(probs }\OperatorTok{*}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(k }\OperatorTok{/}\NormalTok{ n }\OperatorTok{{-}}\NormalTok{ p))}
    
\NormalTok{    stock\_trades[}\StringTok{\textquotesingle{}adj\_factor\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ stock\_trades.}\BuiltInTok{apply}\NormalTok{(}
        \KeywordTok{lambda}\NormalTok{ r: expected\_abs\_dev(}\BuiltInTok{int}\NormalTok{(r[}\StringTok{\textquotesingle{}n\_traders\textquotesingle{}}\NormalTok{]), r[}\StringTok{\textquotesingle{}E\_p\textquotesingle{}}\NormalTok{]), axis}\OperatorTok{=}\DecValTok{1}
\NormalTok{    )}
    
\NormalTok{    stock\_trades[}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (np.}\BuiltInTok{abs}\NormalTok{(stock\_trades[}\StringTok{\textquotesingle{}p\_buy\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ stock\_trades[}\StringTok{\textquotesingle{}E\_p\textquotesingle{}}\NormalTok{]) }\OperatorTok{{-}} 
\NormalTok{                           stock\_trades[}\StringTok{\textquotesingle{}adj\_factor\textquotesingle{}}\NormalTok{])}
    
\NormalTok{    stock\_trades[}\StringTok{\textquotesingle{}buy\_herd\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.where(}
\NormalTok{        stock\_trades[}\StringTok{\textquotesingle{}p\_buy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ stock\_trades[}\StringTok{\textquotesingle{}E\_p\textquotesingle{}}\NormalTok{], stock\_trades[}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{], np.nan}
\NormalTok{    )}
\NormalTok{    stock\_trades[}\StringTok{\textquotesingle{}sell\_herd\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.where(}
\NormalTok{        stock\_trades[}\StringTok{\textquotesingle{}p\_buy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}}\NormalTok{ stock\_trades[}\StringTok{\textquotesingle{}E\_p\textquotesingle{}}\NormalTok{], stock\_trades[}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{], np.nan}
\NormalTok{    )}
    
    \CommentTok{\# Time series of herding}
\NormalTok{    ts\_herding }\OperatorTok{=}\NormalTok{ stock\_trades.groupby(}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{).agg(}
\NormalTok{        mean\_hm}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        mean\_buy\_herd}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}buy\_herd\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        mean\_sell\_herd}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}sell\_herd\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{),}
\NormalTok{        pct\_herding}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: (x }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{).mean()),}
\NormalTok{        n\_stocks}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}nunique\textquotesingle{}}\NormalTok{),}
\NormalTok{    ).reset\_index()}
    
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Herding Analysis (}\SpecialCharTok{\{}\NormalTok{owner\_types }\KeywordTok{or} \StringTok{\textquotesingle{}All Institutions\textquotesingle{}}\SpecialCharTok{\}}\SpecialStringTok{):"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Mean HM: }\SpecialCharTok{\{}\NormalTok{stock\_trades[}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Mean Buy Herding: }\SpecialCharTok{\{}\NormalTok{stock\_trades[}\StringTok{\textquotesingle{}buy\_herd\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Mean Sell Herding: }\SpecialCharTok{\{}\NormalTok{stock\_trades[}\StringTok{\textquotesingle{}sell\_herd\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  \% stocks with herding: }\SpecialCharTok{\{}\NormalTok{(stock\_trades[}\StringTok{\textquotesingle{}hm\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{)}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
    
    \ControlFlowTok{return}\NormalTok{ stock\_trades, ts\_herding}

\CommentTok{\# herding\_all, herding\_ts = compute\_herding\_vietnam(trades)}
\CommentTok{\# herding\_foreign, \_ = compute\_herding\_vietnam(}
\CommentTok{\#     trades, owner\_types=[OwnershipType.FOREIGN\_INST]}
\CommentTok{\# )}
\end{Highlighting}
\end{Shaded}

\section{Conclusion and Practical Recommendations}\label{sec-conclusion}

\subsection{Summary of Measures}\label{summary-of-measures}

Table~\ref{tbl-summary-all} summarizes all institutional ownership
measures developed in this chapter for the Vietnamese market.

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2432}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2432}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2703}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2432}}@{}}
\caption{Summary of All Ownership Measures for
Vietnam}\label{tbl-summary-all}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Measure
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Definition
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Adaptation for Vietnam
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Python Function
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Measure
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Definition
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Adaptation for Vietnam
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Python Function
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
IO Ratio & Inst. shares / TSO & Decomposed into state, foreign, domestic
& \texttt{compute\_ownership\_decomposition()} \\
HHI Concentration & \(\sum w_j^2\) & Separate HHI for total, non-state,
foreign & \texttt{compute\_io\_metrics\_vietnam()} \\
Breadth & Lehavy-Sloan adjusted & Applied to irregular disclosure
intervals & \texttt{compute\_io\_metrics\_vietnam()} \\
FOL Utilization & Foreign \% / FOL limit & Vietnam-specific; no US
equivalent & \texttt{FOLAnalyzer} \\
FOL Premium & Price impact of FOL proximity & Cross-sectional regression
approach & \texttt{FOLAnalyzer.estimate\_fol\_premium()} \\
Trades & Shares (corp-action adjusted) & Critical: adjust for stock
dividends & \texttt{derive\_trades\_vectorized\_vietnam()} \\
Fund Turnover & min(B,S)/avg(A) & Semi-annual frequency; annualized &
\texttt{compute\_fund\_analytics()} \\
SOE Status & State ownership \textgreater{} 50\% & Tracks equitization
program & \texttt{analyze\_state\_ownership()} \\
LSV Herding & \(|p - E[p]| - E[|p - E[p]|]\) & Separate foreign vs
domestic herding & \texttt{compute\_herding\_vietnam()} \\
Co-Ownership Network & Shared institutional holders & Reveals
conglomerate linkages &
\texttt{construct\_stock\_coownership\_network()} \\
\end{longtable}

\subsection{Data Quality Checklist for
Vietnam}\label{data-quality-checklist-for-vietnam}

\begin{tcolorbox}[enhanced jigsaw, opacitybacktitle=0.6, opacityback=0, colframe=quarto-callout-tip-color-frame, leftrule=.75mm, colback=white, left=2mm, bottomtitle=1mm, colbacktitle=quarto-callout-tip-color!10!white, breakable, rightrule=.15mm, toprule=.15mm, bottomrule=.15mm, toptitle=1mm, titlerule=0mm, title=\textcolor{quarto-callout-tip-color}{\faLightbulb}\hspace{0.5em}{Vietnam Data Quality Checklist}, arc=.35mm, coltitle=black]

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
   \textbf{Corporate actions:} Have you built and applied adjustment
  factors for ALL stock dividends, bonus shares, splits, and rights
  issues?
\item
   \textbf{Shareholder classification:} Have you verified the owner
  type classification (state vs foreign vs domestic institutional vs
  individual)?
\item
   \textbf{FOL limits:} Are sector-specific FOL limits correctly
  assigned (30\% for banks, 49\% standard, unlimited for some sectors)?
\item
   \textbf{Disclosure dates:} Are you using the actual disclosure date
  (not the record date or ex-date) for ownership snapshots?
\item
   \textbf{Treasury shares:} Are treasury shares excluded from
  ownership ratio denominators?
\item
   \textbf{UPCOM coverage:} Does your sample include or exclude UPCOM
  stocks (which have weaker disclosure requirements)?
\item
   \textbf{Cross-listings:} Are you handling NVDR (Non-Voting
  Depository Receipts) if applicable after market reforms?
\item
   \textbf{Name consistency:} Are shareholder names standardized across
  disclosure periods (Vietnamese names can have multiple romanization
  forms)?
\item
   \textbf{Trade adjustment:} When deriving trades between periods,
  have you adjusted previous shares for ALL intervening corporate
  actions?
\item
   \textbf{Fund mandate changes:} For fund analytics, have you
  accounted for fund mergers, closures, and mandate changes that affect
  time-series continuity?
\end{enumerate}

\end{tcolorbox}

\subsection{Comparison with US
Framework}\label{comparison-with-us-framework}

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2639}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2917}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.4444}}@{}}
\caption{US vs Vietnam Institutional Ownership Framework
Comparison}\label{tbl-us-vn-comparison}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Dimension
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
US (WRDS/13F)
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Vietnam (DataCore.vn)
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Dimension
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
US (WRDS/13F)
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Vietnam (DataCore.vn)
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Disclosure} & Quarterly 13F (mandatory) & Annual reports +
event-driven \\
\textbf{Coverage} & Institutions \textgreater{} \$100M AUM & All
shareholders in annual reports \\
\textbf{Ownership observed} & Long positions only & Complete
decomposition \\
\textbf{IO can exceed 100\%} & Yes (short selling) & No (by
construction) \\
\textbf{Permanent ID} & CRSP PERMNO & Ticker (with manual tracking of
changes) \\
\textbf{Adjustment factors} & CRSP cfacshr & Must build from corporate
actions \\
\textbf{Investor classification} & LSEG typecode / Bushee &
State/Foreign/Domestic/Individual \\
\textbf{Short selling} & Not in 13F; exists in market & Very limited;
not a concern \\
\textbf{Unique features} & --- & FOL, SOE ownership, stock dividend
frequency \\
\end{longtable}

\bookmarksetup{startatroot}

\chapter{Standardized Earnings Surprises
(SUE)}\label{standardized-earnings-surprises-sue}

In the context of the Ho Chi Minh Stock Exchange (HOSE) and the Hanoi
Stock Exchange (HNX), earnings announcements represent critical
information events. Investors and quantitative analysts continuously
monitor the deviation between reported earnings and market expectations.
This deviation is quantified as the Standardized Earnings Surprise
(SUE).

This chapter details the methodology for calculating SUE using three
distinct approaches frequently utilized in academic literature and
institutional research. We apply these methods to a dataset of
Vietnamese large-cap equities to illustrate the mechanics of the
calculation. The goal is to isolate the ``surprise'' component of
earnings, which is a known predictor of post-earnings announcement drift
(PEAD) (Bernard and Thomas 1989; Livnat and Mendenhall 2006).

\section{Methodology}\label{methodology}

We define three primary methods for calculating SUE. Each method differs
in how it establishes the ``expected'' earnings value.

\subsection{Method 1: Seasonal Random
Walk}\label{method-1-seasonal-random-walk}

This method assumes that earnings follow a seasonal pattern. The best
predictor for the current quarter's earnings per share (EPS) is the EPS
from the same quarter in the previous year. This controls for the
seasonality often seen in Vietnamese sectors like retail and
agriculture.

\[SUE_{1} = \frac{EPS_{t} - EPS_{t-4}}{P_{t}}\]

Where:

\begin{itemize}
\item
  \(EPS_{t}\) is the current quarterly Earnings Per Share.
\item
  \(EPS_{t-4}\) is the Earnings Per Share from the same quarter of the
  prior fiscal year.
\item
  \(P_{t}\) is the stock price at the end of the quarter (used as a
  deflator).
\end{itemize}

\subsection{Method 2: Exclusion of Special
Items}\label{method-2-exclusion-of-special-items}

Reported earnings often contain non-recurring items (e.g., asset sales,
one-time write-offs) that distort the true operating performance. This
method adjusts the reported EPS by removing the after-tax impact of
special items.

In Vietnam, the standard Corporate Income Tax (CIT) rate is generally
20\%. We adjust special items to reflect their impact on net income.

\[Adjusted \ EPS = Reported \ EPS - \frac{Special \ Items \times (1 - CIT)}{Shares \ Outstanding}\]

The SUE calculation then follows the seasonal logic but uses the
adjusted EPS figures:

\[SUE_{2} = \frac{Adj \ EPS_{t} - Adj \ EPS_{t-4}}{P_{t}}\]

\subsection{Method 3: Analyst
Consensus}\label{method-3-analyst-consensus}

This method relies on market consensus rather than historical time
series. It compares the actual reported earnings against the median
analyst forecast provided prior to the announcement.

\[SUE_{3} = \frac{Actual \ EPS - Median \ Estimate}{P_{t}}\]

\section{Data Description}\label{data-description}

For this analysis, we utilize a dataset covering the fiscal years 2023
through 2025. The data includes quarterly financial statements and
analyst consensus estimates for a selection of VN30 index constituents.

The dataset, \texttt{vietnam\_fin\_data.csv}, contains the following
columns:

\begin{itemize}
\item
  \textbf{ticker}: Stock symbol (e.g., VNM, VCB, HPG).
\item
  \textbf{fiscal\_year}: The financial year.
\item
  \textbf{fiscal\_qtr}: The financial quarter (1-4).
\item
  \textbf{eps\_basic}: Basic Earnings Per Share (VND).
\item
  \textbf{price\_close}: Closing price at quarter end (VND).
\item
  \textbf{special\_items}: Pre-tax special items value (VND millions).
  (i.e., \texttt{is\_other\_profit} in DataCore).
\item
  \textbf{shares\_out}: Shares outstanding (millions).
\item
  \textbf{analyst\_med}: Median analyst EPS estimate (VND).
\end{itemize}

\subsection{Visualizing the Core Data}\label{visualizing-the-core-data}

Below is a tabular representation of the raw data we have ingested for
the analysis.

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}
  >{\raggedright\arraybackslash}p{(\linewidth - 14\tabcolsep) * \real{0.1250}}@{}}
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
ticker
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
fiscal\_year
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
fiscal\_qtr
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
eps\_basic
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
price\_close
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
special\_items
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
shares\_out
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
analyst\_med
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
VNM & 2023 & 1 & 1200 & 68000 & 0 & 2090 & 1150 \\
VNM & 2023 & 2 & 1350 & 71000 & 50000 & 2090 & 1300 \\
VNM & 2023 & 3 & 1400 & 74000 & 0 & 2090 & 1450 \\
VNM & 2023 & 4 & 1100 & 69000 & -20000 & 2090 & 1150 \\
VNM & 2024 & 1 & 1300 & 72000 & 0 & 2090 & 1250 \\
VNM & 2024 & 2 & 1500 & 75000 & 0 & 2090 & 1400 \\
VCB & 2023 & 1 & 1800 & 85000 & 10000 & 5500 & 1700 \\
VCB & 2024 & 1 & 2100 & 92000 & 0 & 5500 & 2000 \\
\end{longtable}

\section{Implementation}\label{implementation-2}

\subsection{Python Setup and Data
Loading}\label{python-setup-and-data-loading}

First, we establish our environment and load the dataset. We ensure the
data is sorted by ticker and time to allow for accurate lag
calculations.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}

\CommentTok{\# Creating the dataset directly for this chapter\textquotesingle{}s demonstration}
\NormalTok{data }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}VNM\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{8} \OperatorTok{+}\NormalTok{ [}\StringTok{\textquotesingle{}VCB\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{8} \OperatorTok{+}\NormalTok{ [}\StringTok{\textquotesingle{}HPG\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{8}\NormalTok{,}
    \StringTok{\textquotesingle{}fiscal\_year\textquotesingle{}}\NormalTok{: [}\DecValTok{2023}\NormalTok{, }\DecValTok{2023}\NormalTok{, }\DecValTok{2023}\NormalTok{, }\DecValTok{2023}\NormalTok{, }\DecValTok{2024}\NormalTok{, }\DecValTok{2024}\NormalTok{, }\DecValTok{2024}\NormalTok{, }\DecValTok{2024}\NormalTok{] }\OperatorTok{*} \DecValTok{3}\NormalTok{,}
    \StringTok{\textquotesingle{}fiscal\_qtr\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{] }\OperatorTok{*} \DecValTok{3}\NormalTok{,}
    \StringTok{\textquotesingle{}eps\_basic\textquotesingle{}}\NormalTok{: [}
        \DecValTok{1200}\NormalTok{, }\DecValTok{1350}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\DecValTok{1100}\NormalTok{, }\DecValTok{1300}\NormalTok{, }\DecValTok{1500}\NormalTok{, }\DecValTok{1450}\NormalTok{, }\DecValTok{1250}\NormalTok{, }\CommentTok{\# VNM}
        \DecValTok{1800}\NormalTok{, }\DecValTok{1900}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2200}\NormalTok{, }\DecValTok{2100}\NormalTok{, }\DecValTok{2300}\NormalTok{, }\DecValTok{2400}\NormalTok{, }\DecValTok{2600}\NormalTok{, }\CommentTok{\# VCB}
        \DecValTok{500}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{550}\NormalTok{, }\DecValTok{400}\NormalTok{, }\DecValTok{700}\NormalTok{, }\DecValTok{800}\NormalTok{, }\DecValTok{750}\NormalTok{, }\DecValTok{600}          \CommentTok{\# HPG}
\NormalTok{    ],}
    \StringTok{\textquotesingle{}price\_close\textquotesingle{}}\NormalTok{: [}
        \DecValTok{68000}\NormalTok{, }\DecValTok{71000}\NormalTok{, }\DecValTok{74000}\NormalTok{, }\DecValTok{69000}\NormalTok{, }\DecValTok{72000}\NormalTok{, }\DecValTok{75000}\NormalTok{, }\DecValTok{73000}\NormalTok{, }\DecValTok{70000}\NormalTok{, }\CommentTok{\# VNM}
        \DecValTok{85000}\NormalTok{, }\DecValTok{88000}\NormalTok{, }\DecValTok{90000}\NormalTok{, }\DecValTok{95000}\NormalTok{, }\DecValTok{92000}\NormalTok{, }\DecValTok{96000}\NormalTok{, }\DecValTok{98000}\NormalTok{, }\DecValTok{102000}\NormalTok{, }\CommentTok{\# VCB}
        \DecValTok{20000}\NormalTok{, }\DecValTok{22000}\NormalTok{, }\DecValTok{21000}\NormalTok{, }\DecValTok{19000}\NormalTok{, }\DecValTok{25000}\NormalTok{, }\DecValTok{28000}\NormalTok{, }\DecValTok{27000}\NormalTok{, }\DecValTok{24000} \CommentTok{\# HPG}
\NormalTok{    ],}
    \StringTok{\textquotesingle{}special\_items\textquotesingle{}}\NormalTok{: [}
        \DecValTok{0}\NormalTok{, }\DecValTok{50000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{20000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{10000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\CommentTok{\# VNM (VND Millions)}
        \DecValTok{10000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{50000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{20000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\CommentTok{\# VCB}
        \DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{50000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{100000}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{0} \CommentTok{\# HPG}
\NormalTok{    ],}
    \StringTok{\textquotesingle{}shares\_out\textquotesingle{}}\NormalTok{: [}\DecValTok{2090}\NormalTok{]}\OperatorTok{*}\DecValTok{8} \OperatorTok{+}\NormalTok{ [}\DecValTok{5580}\NormalTok{]}\OperatorTok{*}\DecValTok{8} \OperatorTok{+}\NormalTok{ [}\DecValTok{5810}\NormalTok{]}\OperatorTok{*}\DecValTok{8}\NormalTok{, }\CommentTok{\# In Millions}
    \StringTok{\textquotesingle{}analyst\_med\textquotesingle{}}\NormalTok{: [}
        \DecValTok{1150}\NormalTok{, }\DecValTok{1300}\NormalTok{, }\DecValTok{1450}\NormalTok{, }\DecValTok{1150}\NormalTok{, }\DecValTok{1250}\NormalTok{, }\DecValTok{1400}\NormalTok{, }\DecValTok{1480}\NormalTok{, }\DecValTok{1200}\NormalTok{, }\CommentTok{\# VNM}
        \DecValTok{1700}\NormalTok{, }\DecValTok{1850}\NormalTok{, }\DecValTok{1950}\NormalTok{, }\DecValTok{2150}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2250}\NormalTok{, }\DecValTok{2450}\NormalTok{, }\DecValTok{2550}\NormalTok{, }\CommentTok{\# VCB}
        \DecValTok{450}\NormalTok{, }\DecValTok{550}\NormalTok{, }\DecValTok{600}\NormalTok{, }\DecValTok{450}\NormalTok{, }\DecValTok{650}\NormalTok{, }\DecValTok{750}\NormalTok{, }\DecValTok{800}\NormalTok{, }\DecValTok{650} \CommentTok{\# HPG}
\NormalTok{    ]}
\NormalTok{\}}

\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(data)}

\CommentTok{\# Sort strictly to ensure shift operations work on correct temporal sequence}
\NormalTok{df }\OperatorTok{=}\NormalTok{ df.sort\_values(by}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fiscal\_year\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fiscal\_qtr\textquotesingle{}}\NormalTok{])}
\BuiltInTok{print}\NormalTok{(df.head())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
   ticker  fiscal_year  fiscal_qtr  eps_basic  price_close  special_items  \
16    HPG         2023           1        500        20000              0   
17    HPG         2023           2        600        22000              0   
18    HPG         2023           3        550        21000         -50000   
19    HPG         2023           4        400        19000              0   
20    HPG         2024           1        700        25000         100000   

    shares_out  analyst_med  
16        5810          450  
17        5810          550  
18        5810          600  
19        5810          450  
20        5810          650  
\end{verbatim}

\subsection{Calculation Logic}\label{calculation-logic}

We now apply the functions to calculate the three variations of SUE.

\textbf{Step 1: Handling Seasonality (Lags)}

For Methods 1 and 2, we require the data from the same quarter of the
previous year (lag 4).

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Group by ticker to ensure we don\textquotesingle{}t shift data between companies}
\NormalTok{df[}\StringTok{\textquotesingle{}eps\_lag4\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}eps\_basic\textquotesingle{}}\NormalTok{].shift(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{Step 2: Adjusting for Special Items}

For Method 2, we must strip out non-recurring items. We apply the
Vietnamese Corporate Income Tax (CIT) rate of 20\%.

The formula for the adjustment per share is:
\[ \text{Adjustment} = \frac{\text{Special Items} \times (1 - 0.20)}{\text{Shares Outstanding}} \]

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Constants}
\NormalTok{CIT\_RATE\_VN }\OperatorTok{=} \FloatTok{0.20}

\CommentTok{\# Calculate impact per share}
\CommentTok{\# Note: special\_items are in millions, shares\_out are in millions}
\CommentTok{\# The units cancel out, leaving the result in VND per share.}
\NormalTok{df[}\StringTok{\textquotesingle{}spi\_impact\_per\_share\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}special\_items\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}}\NormalTok{ CIT\_RATE\_VN)) }\OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}shares\_out\textquotesingle{}}\NormalTok{]}

\CommentTok{\# Calculate Adjusted EPS}
\NormalTok{df[}\StringTok{\textquotesingle{}eps\_adjusted\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}eps\_basic\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{\textquotesingle{}spi\_impact\_per\_share\textquotesingle{}}\NormalTok{]}

\CommentTok{\# Create lag for Adjusted EPS}
\NormalTok{df[}\StringTok{\textquotesingle{}eps\_adj\_lag4\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}eps\_adjusted\textquotesingle{}}\NormalTok{].shift(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{Step 3: Computing SUE Variants}

We finalize the calculation by computing the difference between actual
(or adjusted) and expected values, deflated by the stock price.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Method 1: Seasonal Random Walk (Standard EPS)}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_1\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}eps\_basic\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{\textquotesingle{}eps\_lag4\textquotesingle{}}\NormalTok{]) }\OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}price\_close\textquotesingle{}}\NormalTok{]}

\CommentTok{\# Method 2: Seasonal Random Walk (Excluding Special Items)}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_2\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}eps\_adjusted\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{\textquotesingle{}eps\_adj\_lag4\textquotesingle{}}\NormalTok{]) }\OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}price\_close\textquotesingle{}}\NormalTok{]}

\CommentTok{\# Method 3: Analyst Forecasts (IBES Equivalent)}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_3\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (df[}\StringTok{\textquotesingle{}eps\_basic\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ df[}\StringTok{\textquotesingle{}analyst\_med\textquotesingle{}}\NormalTok{]) }\OperatorTok{/}\NormalTok{ df[}\StringTok{\textquotesingle{}price\_close\textquotesingle{}}\NormalTok{]}

\CommentTok{\# Scaling for readability (converting to percentage)}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_1\_pct\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}sue\_1\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_2\_pct\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}sue\_2\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}
\NormalTok{df[}\StringTok{\textquotesingle{}sue\_3\_pct\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}sue\_3\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\section{Results and Analysis}\label{results-and-analysis}

We present the calculated standardized earnings surprises for the fiscal
year 2024. Positive values indicate a positive surprise (beating
expectations), while negative values indicate a miss.

\subsection{Tabular Results (FY 2024)}\label{tabular-results-fy-2024}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Filter for 2024 results where lag data exists}
\NormalTok{results\_2024 }\OperatorTok{=}\NormalTok{ df[df[}\StringTok{\textquotesingle{}fiscal\_year\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \DecValTok{2024}\NormalTok{][[}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fiscal\_qtr\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sue\_1\_pct\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sue\_2\_pct\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sue\_3\_pct\textquotesingle{}}\NormalTok{]]}

\CommentTok{\# Display formatted table}
\ImportTok{from}\NormalTok{ IPython.display }\ImportTok{import}\NormalTok{ display, Markdown}
\NormalTok{markdown\_table }\OperatorTok{=}\NormalTok{ results\_2024.to\_markdown(index}\OperatorTok{=}\VariableTok{False}\NormalTok{, floatfmt}\OperatorTok{=}\StringTok{".4f"}\NormalTok{)}
\NormalTok{display(Markdown(markdown\_table))}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lrrrr@{}}
\toprule\noalign{}
ticker & fiscal\_qtr & sue\_1\_pct & sue\_2\_pct & sue\_3\_pct \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
HPG & 1 & 0.8000 & 0.7449 & 0.2000 \\
HPG & 2 & 0.7143 & 0.7143 & 0.1786 \\
HPG & 3 & 0.7407 & 0.7152 & -0.1852 \\
HPG & 4 & 0.8333 & 0.8333 & -0.2083 \\
VCB & 1 & 0.3261 & 0.3276 & 0.1087 \\
VCB & 2 & 0.4167 & 0.4137 & 0.0521 \\
VCB & 3 & 0.4082 & 0.4082 & -0.0510 \\
VCB & 4 & 0.3922 & 0.3992 & 0.0490 \\
VNM & 1 & 0.1389 & 0.1389 & 0.0694 \\
VNM & 2 & 0.2000 & 0.2255 & 0.1333 \\
VNM & 3 & 0.0685 & 0.0632 & -0.0411 \\
VNM & 4 & 0.2143 & 0.2033 & 0.0714 \\
\end{longtable}

\subsection{Visualization}\label{visualization}

The following figure plots the Analyst-based SUE (Method 3) for the
selected tickers over the 2024 fiscal year.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pivot\_sue }\OperatorTok{=}\NormalTok{ results\_2024.pivot(index}\OperatorTok{=}\StringTok{\textquotesingle{}fiscal\_qtr\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}ticker\textquotesingle{}}\NormalTok{, values}\OperatorTok{=}\StringTok{\textquotesingle{}sue\_3\_pct\textquotesingle{}}\NormalTok{)}

\NormalTok{plt.figure(figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{10}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\ControlFlowTok{for}\NormalTok{ column }\KeywordTok{in}\NormalTok{ pivot\_sue.columns:}
\NormalTok{    plt.plot(pivot\_sue.index, pivot\_sue[column], marker}\OperatorTok{=}\StringTok{\textquotesingle{}o\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\NormalTok{column)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Method 3: Analyst Based SUE (FY 2024)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Fiscal Quarter\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}SUE (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.axhline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}black\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, linewidth}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
\NormalTok{plt.legend(title}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.grid(}\VariableTok{True}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.6}\NormalTok{)}
\NormalTok{plt.xticks([}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{])}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\pandocbounded{\includegraphics[keepaspectratio]{17_sue_files/figure-pdf/cell-7-output-1.pdf}}

\section{Conclusion}\label{conclusion}

In this chapter, we have formalized the calculation of Standardized
Earnings Surprises for the Vietnamese market. By implementing three
distinct methods using Python, we demonstrated that relying solely on
raw EPS growth (Method 1) can be misleading in the presence of
non-recurring items. Furthermore, analyst-based surprises (Method 3)
often provide a cleaner signal of new information reaching the market.

For robust quantitative modeling in Vietnam, we recommend using Method 2
when analyst data is sparse (common in small-cap stocks) and Method 3
for VN30 constituents where analyst coverage is deep and liquid.

\bookmarksetup{startatroot}

\chapter{Event Studies in Finance}\label{event-studies-in-finance}

Event studies constitute one of the most enduring and widely deployed
empirical methodologies in financial economics. At their core, event
studies measure the impact of a specific event on the value of a firm by
examining \textbf{abnormal security returns} around the time the event
occurs. The methodology rests on a simple premise: if capital markets
are informationally efficient, the effect of an event will be reflected
immediately in security prices, and any deviation from ``normal''
expected returns can be attributed to the event itself.

Since the pioneering work of Eugene F. Fama et al. (1969), who studied
how stock prices adjust to new information around stock splits, event
studies have become a cornerstone of empirical research across finance,
accounting, economics, and law. Ball and Brown (2013) demonstrated that
accounting earnings announcements convey information to the market, a
finding that launched decades of research in accounting and disclosure.
The methodology has since been refined through contributions by Brown
and Warner (1980) and Brown and Warner (1985), who established the
statistical properties of event study methods, and MacKinlay (1997)
codified best practices that remain standard today.

The breadth of applications is remarkable. Event studies have been used
to examine the wealth effects of mergers and acquisitions (Jensen and
Ruback 1983; Andrade, Mitchell, and Stafford 2001), earnings
announcements (Bernard and Thomas 1989), dividend changes (Aharony and
Swary 1980), regulatory changes (Schwert 1981), executive turnover
(Warner, Watts, and Wruck 1988), and macroeconomic announcements
(Flannery and Protopapadakis 2002). In law and economics, event studies
serve as the primary tool for measuring damages in securities fraud
litigation (Mitchell and Netter 1993) and assessing the impact of
regulatory interventions (Binder 1998). Kothari and Warner (2007)
documented over 500 published event studies in the top five finance
journals alone between 1974 and 2000.

\subsection{Why Event Studies Matter}\label{why-event-studies-matter}

The enduring popularity of event studies stems from several compelling
properties:

\begin{itemize}
\item
  \textbf{Direct measurement of economic significance.} Unlike
  regression-based approaches that estimate associations, event studies
  directly quantify the dollar impact of events on firm value. A
  cumulative abnormal return (CAR) of 3\% for a firm with \$10 billion
  market capitalization translates to \$300 million in wealth creation,
  which is a tangible, economically meaningful magnitude.
\item
  \textbf{Minimal maintained assumptions.} The methodology requires only
  semi-strong market efficiency (i.e., prices reflect publicly available
  information), a weaker assumption than many alternatives.
\item
  \textbf{Statistical power.} Daily event studies have remarkable power
  to detect abnormal performance, even with modest sample sizes. Brown
  and Warner (1985) demonstrated that the market model detects abnormal
  returns of 1\% or more with high reliability using samples as small as
  20 securities.
\item
  \textbf{Versatility.} The basic framework accommodates events that are
  firm-specific or market-wide, anticipated or surprising, and can be
  adapted to various asset classes and market structures.
\end{itemize}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{Literature Review and Methodological
Evolution}\label{literature-review-and-methodological-evolution}

\subsection{The Classical Framework
(1969-1985)}\label{the-classical-framework-1969-1985}

The modern event study traces its origins to Eugene F. Fama et al.
(1969), hereafter FFJR, who examined monthly stock returns around 940
stock splits between 1927 and 1959. Their key innovation was the use of
the \textbf{market model} to decompose returns into expected (normal)
and unexpected (abnormal) components.

Ball and Brown (2013) independently developed a similar approach to
study earnings announcements, establishing the information content of
accounting data. It was a finding with profound implications for both
the efficient markets hypothesis and the relevance of financial
reporting.

Brown and Warner (1980) provided the first systematic analysis of event
study methodology using simulation. Their study of monthly data
established several important results: (i) the simple market model
performs at least as well as more complex models, (ii) value-weighted
market indices can lead to misspecification when the sample is tilted
toward smaller firms, and (iii) the standard cross-sectional test has
well-specified size under the null hypothesis. Their follow-up study
(Brown and Warner 1985) extended the analysis to daily data, documenting
the importance of non-normality in daily returns and the increased power
of daily versus monthly studies.

\subsection{Risk Model Refinements
(1992-2015)}\label{risk-model-refinements-1992-2015}

The advent of the \textbf{Fama-French three-factor model} (Eugene F.
Fama and French 1993) represented a major advance in modeling expected
returns. Adding size (SMB) and value (HML) factors to the market model
improved the cross-sectional fit of expected returns considerably. Mark
M. Carhart (1997b) augmented this with a momentum factor (UMD), yielding
the four-factor model that became standard in event studies through the
2000s. Eugene F. Fama and French (2015) subsequently introduced
profitability (RMW) and investment (CMA) factors in their five-factor
model.

The choice of risk model matters for event studies primarily in
\textbf{long-horizon settings}. Kothari and Warner (2007) showed that
for short-window studies (3-5 days), the market model and multi-factor
models produce virtually identical results because the incremental
factors explain very little daily return variation for individual firms.
However, for event windows exceeding 20 trading days, model choice can
materially affect inferences.

\subsection{Testing for Abnormal Returns
(1976-2010)}\label{testing-for-abnormal-returns-1976-2010}

The statistical testing of abnormal returns has evolved considerably:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2603}}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2466}}@{}}
\caption{Summary of major event study test
statistics}\label{tbl-tests}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Year
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Property
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Reference
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Year
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Key Property
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Reference
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\textbf{Patell Z} & 1976 & Standardizes by estimation-period \(\sigma\);
weights firms inversely by volatility & Patell (1976) \\
\textbf{Cross-Sectional} \(t\) & 1980 & Allows event-induced variance
change & Brown and Warner (1980) \\
\textbf{BMP} & 1991 & Robust to event-induced variance & Boehmer,
Masumeci, and Poulsen (1991) \\
\textbf{Corrado Rank} & 1989 & Non-parametric; robust to non-normality &
Corrado (1989) \\
\textbf{Generalized Sign} & 1992 & Non-parametric; uses
estimation-window baseline & Cowan (1992) \\
\textbf{Kolari-Pynnnen} & 2010 & Accounts for cross-sectional
dependence & Kolari and Pynnnen (2010) \\
\textbf{Skewness-Adjusted} & 1992 & Corrects for BHAR skewness & Hall
(1992) \\
\end{longtable}

\subsection{CARs versus BHARs}\label{cars-versus-bhars}

Cumulative abnormal returns (CARs) sum daily abnormal returns, while
buy-and-hold abnormal returns (BHARs) compound returns and subtract the
compounded benchmark. Barber and Lyon (1997) demonstrated that BHARs
better capture the actual investor experience, since investors earn
compound, not cumulative, returns. However, Eugene F. Fama (1998) and
Mitchell and Stafford (2000) showed that BHARs exhibit severe
cross-sectional dependence and positive skewness. For \textbf{short
event windows} (under 10 days), the difference between CARs and BHARs is
negligible. For longer windows, both should be reported.

\subsection{Emerging Market
Considerations}\label{emerging-market-considerations}

Event studies in emerging markets face distinct challenges:

\begin{itemize}
\item
  \textbf{Thin trading.} Many emerging market securities trade
  infrequently, inducing bias in market model beta estimates. Scholes
  and Williams (1977) and Dimson (1979) proposed corrections using
  leading and lagging market returns.
\item
  \textbf{Factor availability.} While Fama-French factors are readily
  available for developed markets, emerging market factors must often be
  constructed locally.
\item
  \textbf{Market microstructure.} Price limits (\(\pm\) 7\% on HOSE,
  \(\pm\) 10\% on HNX, \(\pm\) 15\% on UPCOM in Vietnam), T+2
  settlement, and the absence of short-selling affect the speed of price
  adjustment. Researchers should consider wider event windows to
  accommodate slower information incorporation (Bhattacharya et al.
  2000; Griffin, Kelly, and Nardari 2010).
\end{itemize}

\section{Mathematical Framework}\label{mathematical-framework}

This section presents the complete mathematical specification of the
event study methodology. We follow the notation conventions of Campbell
et al. (1998) and Kothari and Warner (2007).

\subsection{Timeline and Windows}\label{timeline-and-windows}

The event study timeline is defined relative to the event date, denoted
\(\tau = 0\). All dates are measured in \textbf{trading days}:

\[
\underbrace{T_0 + 1, \ldots, T_1}_{\text{Estimation Window (L days)}} \quad \underbrace{\quad}_{\text{Gap (G days)}} \quad \underbrace{\tau_1, \ldots, 0, \ldots, \tau_2}_{\text{Event Window (L days)}}
\]

where:

\begin{itemize}
\tightlist
\item
  \textbf{Estimation window}: \(L_1\) trading days over which the risk
  model parameters are estimated
\item
  \textbf{Gap}: \(G\) trading days separating estimation and event
  windows, preventing contamination by pre-event information leakage
\item
  \textbf{Event window}: \(L_2 = \tau_2 - \tau_1 + 1\) trading days
  centered around the event date
\end{itemize}

For example, with \(L_1 = 150\), \(G = 15\), \(\tau_1 = -10\),
\(\tau_2 = +10\): the estimation window covers trading days
\([-175, -25]\) relative to the event, and the event window covers
\([-10, +10]\).

\subsection{Normal Return Models}\label{normal-return-models}

Let \(R_{it}\) denote the return on security \(i\) on trading day \(t\),
\(R_{ft}\) the risk-free rate, and \(R_{mt}\) the market return. We
implement six models:

\textbf{Model 0: Market-Adjusted Returns.} Assumes \(\beta_i = 1\) and
\(\alpha_i = 0\) for all firms:

\[
AR_{it}^{MA} = R_{it} - R_{mt}
\]

\textbf{Model 1: Market Model} (Sharpe 1964):

\[
R_{it} = \alpha_i + \beta_i R_{mt} + \varepsilon_{it}, \quad E[\varepsilon_{it}] = 0, \quad \text{Var}[\varepsilon_{it}] = \sigma^2_{\varepsilon_i}
\]

\[
AR_{it}^{MM} = R_{it} - \hat{\alpha}_i - \hat{\beta}_i R_{mt}
\]

\textbf{Model 2: Fama-French Three-Factor} (Eugene F. Fama and French
1993):

\[
R_{it} - R_{ft} = \alpha_i + \beta_{i,1}(R_{mt} - R_{ft}) + \beta_{i,2} \cdot SMB_t + \beta_{i,3} \cdot HML_t + \varepsilon_{it}
\]

\textbf{Model 3: Carhart Four-Factor} (Mark M. Carhart 1997b):

\[
R_{it} - R_{ft} = \alpha_i + \beta_{i,1}(R_{mt} - R_{ft}) + \beta_{i,2} \cdot SMB_t + \beta_{i,3} \cdot HML_t + \beta_{i,4} \cdot UMD_t + \varepsilon_{it}
\]

\textbf{Model 4: Fama-French Five-Factor} (Eugene F. Fama and French
2015):

\[
R_{it} - R_{ft} = \alpha_i + \beta_{i,1}(R_{mt} - R_{ft}) + \beta_{i,2} \cdot SMB_t + \beta_{i,3} \cdot HML_t + \beta_{i,4} \cdot RMW_t + \beta_{i,5} \cdot CMA_t + \varepsilon_{it}
\]

\textbf{Model 5: User-Specified Factor Model:}

\[
R_{it} - R_{ft} = \alpha_i + \sum_{k=1}^{K} \beta_{i,k} F_{k,t} + \varepsilon_{it}
\]

\subsection{Aggregation: CARs and
BHARs}\label{aggregation-cars-and-bhars}

\textbf{Cumulative Abnormal Returns} sum daily abnormal returns:

\[
CAR_i(\tau_1, \tau_2) = \sum_{t=\tau_1}^{\tau_2} AR_{it}, \qquad \overline{CAR}(\tau_1, \tau_2) = \frac{1}{N} \sum_{i=1}^{N} CAR_i(\tau_1, \tau_2)
\]

\textbf{Buy-and-Hold Abnormal Returns} compound returns:

\[
BHAR_i(\tau_1, \tau_2) = \prod_{t=\tau_1}^{\tau_2}(1 + R_{it}) - \prod_{t=\tau_1}^{\tau_2}(1 + \hat{E}[R_{it}])
\]

\subsection{Standardized Returns}\label{standardized-returns}

The \textbf{standardized abnormal return} for firm \(i\) on day \(t\)
is:

\[
SAR_{it} = \frac{AR_{it}}{\hat{\sigma}_{\varepsilon_i}}
\]

The \textbf{standardized cumulative abnormal return} is:

\[
SCAR_i(\tau_1, \tau_2) = \frac{CAR_i(\tau_1, \tau_2)}{\hat{\sigma}_{\varepsilon_i} \sqrt{L_2}}
\]

\subsection{Test Statistics}\label{test-statistics}

Let \(N\) denote the number of firm-event observations.

\textbf{Test 1: Cross-Sectional} \(t\)-Test. Allows event-induced
variance; assumes cross-sectional independence:

\[
t_{CS} = \frac{\overline{CAR}}{s_{CAR}/\sqrt{N}}, \quad s_{CAR} = \sqrt{\frac{1}{N-1}\sum_{i=1}^{N}(CAR_i - \overline{CAR})^2}
\]

\textbf{Test 2: Patell Z-Test} (Patell 1976). Weights firms inversely by
volatility:

\[
Z_{Patell} = \frac{\sum_{i=1}^{N} SCAR_i}{\sqrt{\sum_{i=1}^{N} \frac{K_i - 2}{K_i - 4}}}
\]

\textbf{Test 3: BMP Test} (Boehmer, Masumeci, and Poulsen 1991). Robust
to event-induced variance:

\[
t_{BMP} = \frac{\overline{SCAR}}{s_{SCAR}/\sqrt{N}}
\]

\textbf{Test 4: Kolari-Pynnnen Adjusted BMP} (Kolari and Pynnnen
2010). Accounts for cross-sectional dependence:

\[
t_{KP} = t_{BMP} \times \sqrt{\frac{1}{1 + (N-1)\bar{r}}}
\]

where \(\bar{r}\) is the mean pairwise cross-correlation of
estimation-period residuals.

\textbf{Test 5: Generalized Sign Test} (Cowan 1992):

\[
Z_{GSign} = \frac{\hat{p} - \hat{p}_0}{\sqrt{\hat{p}_0(1-\hat{p}_0)/N}}
\]

\textbf{Test 6: Sign Test:}

\[
Z_{Sign} = \frac{N^{+} - 0.5N}{\sqrt{0.25N}}
\]

\textbf{Test 7: Skewness-Adjusted} \(t\)-Test (Hall 1992):

\[
t_{SA} = \sqrt{N}\left(\bar{z} + \frac{1}{3}\hat{\gamma}\bar{z}^2 + \frac{1}{27}\hat{\gamma}^2\bar{z}^3 + \frac{1}{6N}\hat{\gamma}\right
\]

\textbf{Test 8: Wilcoxon Signed-Rank Test:} A non-parametric test of
whether the median CAR differs from zero.

The table below summarizes the assumptions of each test:

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2500}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2500}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2500}}
  >{\centering\arraybackslash}p{(\linewidth - 6\tabcolsep) * \real{0.2500}}@{}}
\caption{Assumption requirements for event study test
statistics}\label{tbl-test-assumptions}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Event-Induced Variance
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Cross-Sectional Independence
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Normality
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Test
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Event-Induced Variance
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Cross-Sectional Independence
\end{minipage} & \begin{minipage}[b]{\linewidth}\centering
Normality
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Cross-Sectional \(t\) & Robust &  Assumes &  Assumes \\
Patell Z &  Assumes no change &  Assumes &  Assumes \\
BMP & Robust &  Assumes &  Assumes \\
Kolari-Pynnnen & Robust & Robust &  Assumes \\
Generalized Sign & Robust &  Assumes & Robust \\
Corrado Rank & Robust &  Assumes & Robust \\
Skewness-Adjusted & Robust &  Assumes & Partially \\
Wilcoxon & Robust &  Assumes & Robust \\
\end{longtable}

\section{Python Implementation}\label{python-implementation}

\subsection{Design Philosophy}\label{design-philosophy}

Our implementation follows these principles:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \textbf{Modularity}: Each component (calendar, estimation, AR
  computation, testing) is a separate function.
\item
  \textbf{Vectorization}: All operations use pandas/numpy for
  performance on large datasets.
\item
  \textbf{Configurability}: All parameters are user-configurable via a
  dataclass.
\item
  \textbf{Transparency}: Intermediate outputs are preserved for
  inspection.
\item
  \textbf{Production-ready}: Comprehensive input validation, missing
  data handling, and edge cases.
\end{enumerate}

\subsection{Setup and Imports}\label{setup-and-imports}

\phantomsection\label{setup}
\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{from}\NormalTok{ scipy }\ImportTok{import}\NormalTok{ stats}
\ImportTok{from}\NormalTok{ dataclasses }\ImportTok{import}\NormalTok{ dataclass, field}
\ImportTok{from}\NormalTok{ typing }\ImportTok{import}\NormalTok{ Optional, List, Tuple}
\ImportTok{from}\NormalTok{ enum }\ImportTok{import}\NormalTok{ Enum}
\ImportTok{import}\NormalTok{ warnings}
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ mticker}

\NormalTok{warnings.filterwarnings(}\StringTok{\textquotesingle{}ignore\textquotesingle{}}\NormalTok{)}
\NormalTok{pd.set\_option(}\StringTok{\textquotesingle{}display.float\_format\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}}\SpecialCharTok{\{:.6f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"All libraries loaded."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
All libraries loaded.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ sqlite3}

\NormalTok{tidy\_finance }\OperatorTok{=}\NormalTok{ sqlite3.}\ExtensionTok{connect}\NormalTok{(database}\OperatorTok{=}\StringTok{"data/tidy\_finance\_python.sqlite"}\NormalTok{)}

\NormalTok{factors\_ff3\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM factors\_ff3\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}

\NormalTok{factors\_ff5\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM factors\_ff5\_daily"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}

\NormalTok{factors\_ff3\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM factors\_ff3\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}

\NormalTok{factors\_ff5\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"SELECT * FROM factors\_ff5\_monthly"}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{"date"}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_monthly }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess, mktcap, mktcap\_lag, risk\_free}
\StringTok{        FROM prices\_monthly}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{).dropna()}

\NormalTok{prices\_daily }\OperatorTok{=}\NormalTok{ pd.read\_sql\_query(}
\NormalTok{    sql}\OperatorTok{=}\StringTok{"""}
\StringTok{        SELECT symbol, date, ret\_excess, mktcap, mktcap\_lag, risk\_free}
\StringTok{        FROM prices\_daily}
\StringTok{    """}\NormalTok{,}
\NormalTok{    con}\OperatorTok{=}\NormalTok{tidy\_finance,}
\NormalTok{    parse\_dates}\OperatorTok{=}\NormalTok{\{}\StringTok{"date"}\NormalTok{\}}
\NormalTok{).dropna()}
\end{Highlighting}
\end{Shaded}

\subsection{Configuration}\label{configuration}

\phantomsection\label{config}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{class}\NormalTok{ RiskModel(Enum):}
    \CommentTok{"""Supported risk models for expected return computation."""}
\NormalTok{    MARKET\_ADJ }\OperatorTok{=} \StringTok{"market\_adjusted"}
\NormalTok{    MARKET\_MODEL }\OperatorTok{=} \StringTok{"market\_model"}
\NormalTok{    FF3 }\OperatorTok{=} \StringTok{"ff3"}
\NormalTok{    CARHART }\OperatorTok{=} \StringTok{"carhart"}
\NormalTok{    FF5 }\OperatorTok{=} \StringTok{"ff5"}
\NormalTok{    CUSTOM }\OperatorTok{=} \StringTok{"custom"}

\AttributeTok{@dataclass}
\KeywordTok{class}\NormalTok{ EventStudyConfig:}
    \CommentTok{"""Complete configuration for an event study.}
\CommentTok{    }
\CommentTok{    Attributes}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    estimation\_window : int}
\CommentTok{        Length of estimation period in trading days. Brown and Warner (1985)}
\CommentTok{        suggest 100 days; MacKinlay (1997) recommends 120 as standard.}
\CommentTok{    event\_window\_start : int}
\CommentTok{        Start of event window relative to event date (e.g., {-}10).}
\CommentTok{    event\_window\_end : int}
\CommentTok{        End of event window relative to event date (e.g., +10).}
\CommentTok{    gap : int}
\CommentTok{        Trading days between estimation and event windows. Prevents}
\CommentTok{        contamination from pre{-}event information leakage.}
\CommentTok{    min\_estimation\_obs : int}
\CommentTok{        Minimum non{-}missing returns required in estimation period.}
\CommentTok{    risk\_model : RiskModel}
\CommentTok{        Risk model for computing expected returns.}
\CommentTok{    custom\_factors : list}
\CommentTok{        Column names for user{-}specified factors (CUSTOM model only).}
\CommentTok{    thin\_trading\_adj : str or None}
\CommentTok{        None, \textquotesingle{}scholes\_williams\textquotesingle{}, or \textquotesingle{}dimson\textquotesingle{}.}
\CommentTok{    dimson\_lags : int}
\CommentTok{        Number of leads/lags for Dimson (1979) correction.}
\CommentTok{    """}
\NormalTok{    estimation\_window: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{150}
\NormalTok{    event\_window\_start: }\BuiltInTok{int} \OperatorTok{=} \OperatorTok{{-}}\DecValTok{10}
\NormalTok{    event\_window\_end: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{10}
\NormalTok{    gap: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{15}
\NormalTok{    min\_estimation\_obs: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{120}
\NormalTok{    risk\_model: RiskModel }\OperatorTok{=}\NormalTok{ RiskModel.MARKET\_MODEL}
\NormalTok{    custom\_factors: List[}\BuiltInTok{str}\NormalTok{] }\OperatorTok{=}\NormalTok{ field(default\_factory}\OperatorTok{=}\BuiltInTok{list}\NormalTok{)}
\NormalTok{    thin\_trading\_adj: Optional[}\BuiltInTok{str}\NormalTok{] }\OperatorTok{=} \VariableTok{None}
\NormalTok{    dimson\_lags: }\BuiltInTok{int} \OperatorTok{=} \DecValTok{1}
    
    \AttributeTok{@property}
    \KeywordTok{def}\NormalTok{ event\_window\_length(}\VariableTok{self}\NormalTok{) }\OperatorTok{{-}\textgreater{}} \BuiltInTok{int}\NormalTok{:}
        \ControlFlowTok{return} \VariableTok{self}\NormalTok{.event\_window\_end }\OperatorTok{{-}} \VariableTok{self}\NormalTok{.event\_window\_start }\OperatorTok{+} \DecValTok{1}
    
    \KeywordTok{def}\NormalTok{ validate(}\VariableTok{self}\NormalTok{):}
        \ControlFlowTok{assert} \VariableTok{self}\NormalTok{.estimation\_window }\OperatorTok{\textgreater{}} \DecValTok{0}
        \ControlFlowTok{assert} \VariableTok{self}\NormalTok{.event\_window\_start }\OperatorTok{\textless{}=} \VariableTok{self}\NormalTok{.event\_window\_end}
        \ControlFlowTok{assert} \VariableTok{self}\NormalTok{.gap }\OperatorTok{\textgreater{}=} \DecValTok{0}
        \ControlFlowTok{assert} \VariableTok{self}\NormalTok{.min\_estimation\_obs }\OperatorTok{\textless{}=} \VariableTok{self}\NormalTok{.estimation\_window}
        \ControlFlowTok{if} \VariableTok{self}\NormalTok{.risk\_model }\OperatorTok{==}\NormalTok{ RiskModel.CUSTOM:}
            \ControlFlowTok{assert} \BuiltInTok{len}\NormalTok{(}\VariableTok{self}\NormalTok{.custom\_factors) }\OperatorTok{\textgreater{}} \DecValTok{0}
        \ControlFlowTok{return} \VariableTok{True}

\CommentTok{\# Demonstrate}
\NormalTok{config\_demo }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{, event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{, event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{15}\NormalTok{, min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{, risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{)}
\NormalTok{config\_demo.validate()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Event window length: }\SpecialCharTok{\{}\NormalTok{config\_demo}\SpecialCharTok{.}\NormalTok{event\_window\_length}\SpecialCharTok{\}}\SpecialStringTok{ days"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Model: }\SpecialCharTok{\{}\NormalTok{config\_demo}\SpecialCharTok{.}\NormalTok{risk\_model}\SpecialCharTok{.}\NormalTok{value}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Event window length: 21 days
Model: ff3
\end{verbatim}

\subsection{Step 1: Trading Calendar
Construction}\label{step-1-trading-calendar-construction}

A correct trading calendar is fundamental. It maps any event date to the
exact calendar dates for the start/end of estimation and event windows,
accounting for weekends, holidays, and non-trading days.

\phantomsection\label{calendar}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ build\_trading\_calendar(trading\_dates, config):}
    \CommentTok{"""Build a trading calendar mapping event dates to window boundaries.}
\CommentTok{    }
\CommentTok{    For each potential event date, identifies the calendar dates for the}
\CommentTok{    start/end of the estimation period and event window using only actual}
\CommentTok{    trading days.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    trading\_dates : array{-}like}
\CommentTok{        Sorted unique trading dates in the market.}
\CommentTok{    config : EventStudyConfig}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame with columns: estper\_beg, estper\_end, evtwin\_beg,}
\CommentTok{        evtdate, evtwin\_end, cal\_index}
\CommentTok{    """}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ pd.Series(}\BuiltInTok{sorted}\NormalTok{(pd.to\_datetime(trading\_dates).unique()))}
\NormalTok{    n }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(dates)}
    
\NormalTok{    L1 }\OperatorTok{=}\NormalTok{ config.estimation\_window}
\NormalTok{    G }\OperatorTok{=}\NormalTok{ config.gap}
\NormalTok{    s }\OperatorTok{=}\NormalTok{ config.event\_window\_start}
\NormalTok{    L2 }\OperatorTok{=}\NormalTok{ config.event\_window\_length}
    
    \CommentTok{\# Offsets (FIRSTOBS logic)}
\NormalTok{    o0 }\OperatorTok{=} \DecValTok{0}                      \CommentTok{\# estper\_beg}
\NormalTok{    o1 }\OperatorTok{=}\NormalTok{ L1 }\OperatorTok{{-}} \DecValTok{1}                 \CommentTok{\# estper\_end}
\NormalTok{    o2 }\OperatorTok{=}\NormalTok{ L1 }\OperatorTok{+}\NormalTok{ G                 }\CommentTok{\# evtwin\_beg}
\NormalTok{    o3 }\OperatorTok{=}\NormalTok{ L1 }\OperatorTok{+}\NormalTok{ G }\OperatorTok{{-}}\NormalTok{ s             }\CommentTok{\# evtdate}
\NormalTok{    o4 }\OperatorTok{=}\NormalTok{ L1 }\OperatorTok{+}\NormalTok{ G }\OperatorTok{+}\NormalTok{ L2 }\OperatorTok{{-}} \DecValTok{1}        \CommentTok{\# evtwin\_end}
    
\NormalTok{    max\_offset }\OperatorTok{=}\NormalTok{ o4}
\NormalTok{    valid }\OperatorTok{=}\NormalTok{ n }\OperatorTok{{-}}\NormalTok{ max\_offset}
    \ControlFlowTok{if}\NormalTok{ valid }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\SpecialStringTok{f"Need }\SpecialCharTok{\{}\NormalTok{max\_offset}\OperatorTok{+}\DecValTok{1}\SpecialCharTok{\}}\SpecialStringTok{ trading dates, have }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
    
\NormalTok{    cal }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
        \StringTok{\textquotesingle{}estper\_beg\textquotesingle{}}\NormalTok{: dates.iloc[o0:o0}\OperatorTok{+}\NormalTok{valid].values,}
        \StringTok{\textquotesingle{}estper\_end\textquotesingle{}}\NormalTok{: dates.iloc[o1:o1}\OperatorTok{+}\NormalTok{valid].values,}
        \StringTok{\textquotesingle{}evtwin\_beg\textquotesingle{}}\NormalTok{: dates.iloc[o2:o2}\OperatorTok{+}\NormalTok{valid].values,}
        \StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{:    dates.iloc[o3:o3}\OperatorTok{+}\NormalTok{valid].values,}
        \StringTok{\textquotesingle{}evtwin\_end\textquotesingle{}}\NormalTok{: dates.iloc[o4:o4}\OperatorTok{+}\NormalTok{valid].values,}
\NormalTok{    \})}
\NormalTok{    cal[}\StringTok{\textquotesingle{}cal\_index\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(cal)}\OperatorTok{+}\DecValTok{1}\NormalTok{)}
    
    \CommentTok{\# Validate window lengths using a sample row}
\NormalTok{    idx }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(}\DecValTok{10}\NormalTok{, }\BuiltInTok{len}\NormalTok{(cal)}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}
\NormalTok{    row }\OperatorTok{=}\NormalTok{ cal.iloc[idx]}
\NormalTok{    est\_n }\OperatorTok{=}\NormalTok{ dates[(dates }\OperatorTok{\textgreater{}=}\NormalTok{ row[}\StringTok{\textquotesingle{}estper\_beg\textquotesingle{}}\NormalTok{]) }\OperatorTok{\&}\NormalTok{ (dates }\OperatorTok{\textless{}=}\NormalTok{ row[}\StringTok{\textquotesingle{}estper\_end\textquotesingle{}}\NormalTok{])].shape[}\DecValTok{0}\NormalTok{]}
\NormalTok{    evt\_n }\OperatorTok{=}\NormalTok{ dates[(dates }\OperatorTok{\textgreater{}=}\NormalTok{ row[}\StringTok{\textquotesingle{}evtwin\_beg\textquotesingle{}}\NormalTok{]) }\OperatorTok{\&}\NormalTok{ (dates }\OperatorTok{\textless{}=}\NormalTok{ row[}\StringTok{\textquotesingle{}evtwin\_end\textquotesingle{}}\NormalTok{])].shape[}\DecValTok{0}\NormalTok{]}
    \ControlFlowTok{assert}\NormalTok{ est\_n }\OperatorTok{==}\NormalTok{ L1, }\SpecialStringTok{f"Estimation window: }\SpecialCharTok{\{}\NormalTok{est\_n}\SpecialCharTok{\}}\SpecialStringTok{  }\SpecialCharTok{\{}\NormalTok{L1}\SpecialCharTok{\}}\SpecialStringTok{"}
    \ControlFlowTok{assert}\NormalTok{ evt\_n }\OperatorTok{==}\NormalTok{ L2, }\SpecialStringTok{f"Event window: }\SpecialCharTok{\{}\NormalTok{evt\_n}\SpecialCharTok{\}}\SpecialStringTok{  }\SpecialCharTok{\{}\NormalTok{L2}\SpecialCharTok{\}}\SpecialStringTok{"}
    
    \ControlFlowTok{return}\NormalTok{ cal}

\CommentTok{\# Demo}
\NormalTok{demo\_dates }\OperatorTok{=}\NormalTok{ pd.bdate\_range(}\StringTok{\textquotesingle{}2018{-}01{-}01\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2023{-}12{-}31\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{)}
\NormalTok{demo\_cal }\OperatorTok{=}\NormalTok{ build\_trading\_calendar(demo\_dates, config\_demo)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Calendar: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(demo\_cal)}\SpecialCharTok{\}}\SpecialStringTok{ potential event dates"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(demo\_cal.head(}\DecValTok{3}\NormalTok{).to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Calendar: 1380 potential event dates
estper_beg estper_end evtwin_beg    evtdate evtwin_end  cal_index
2018-01-01 2018-07-27 2018-08-20 2018-09-03 2018-09-17          1
2018-01-02 2018-07-30 2018-08-21 2018-09-04 2018-09-18          2
2018-01-03 2018-07-31 2018-08-22 2018-09-05 2018-09-19          3
\end{verbatim}

\subsection{Step 2: Event Date
Alignment}\label{step-2-event-date-alignment}

When an event occurs on a non-trading day, align to the \textbf{next}
available trading day.

\phantomsection\label{alignment}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ align\_events(events, calendar, id\_col}\OperatorTok{=}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, date\_col}\OperatorTok{=}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{):}
    \CommentTok{"""Align event dates to trading calendar.}
\CommentTok{    }
\CommentTok{    Non{-}trading{-}day events are shifted forward to the next trading day.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    events : pd.DataFrame with [id\_col, date\_col] and optional \textquotesingle{}group\textquotesingle{}}
\CommentTok{    calendar : pd.DataFrame from build\_trading\_calendar()}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    pd.DataFrame with window boundaries for each firm{-}event}
\CommentTok{    """}
\NormalTok{    events }\OperatorTok{=}\NormalTok{ events.copy()}
\NormalTok{    events[date\_col] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(events[date\_col])}
    
\NormalTok{    cal\_dates }\OperatorTok{=}\NormalTok{ calendar[[}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{]].drop\_duplicates().sort\_values(}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{)}
    
\NormalTok{    merged }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{        events.sort\_values(date\_col),}
\NormalTok{        cal\_dates.rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}aligned\_date\textquotesingle{}}\NormalTok{\}),}
\NormalTok{        left\_on}\OperatorTok{=}\NormalTok{date\_col, right\_on}\OperatorTok{=}\StringTok{\textquotesingle{}aligned\_date\textquotesingle{}}\NormalTok{,}
\NormalTok{        direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{    )}
    
\NormalTok{    result }\OperatorTok{=}\NormalTok{ merged.merge(calendar, left\_on}\OperatorTok{=}\StringTok{\textquotesingle{}aligned\_date\textquotesingle{}}\NormalTok{, right\_on}\OperatorTok{=}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{, how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}\NormalTok{)}
    
\NormalTok{    shifted }\OperatorTok{=}\NormalTok{ (result[date\_col] }\OperatorTok{!=}\NormalTok{ result[}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{]).}\BuiltInTok{sum}\NormalTok{()}
    \ControlFlowTok{if}\NormalTok{ shifted }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\NormalTok{shifted}\SpecialCharTok{\}}\SpecialStringTok{ event(s) shifted to next trading day"}\NormalTok{)}
    
\NormalTok{    result }\OperatorTok{=}\NormalTok{ result.rename(columns}\OperatorTok{=}\NormalTok{\{date\_col: }\StringTok{\textquotesingle{}original\_date\textquotesingle{}}\NormalTok{\})}
\NormalTok{    result }\OperatorTok{=}\NormalTok{ result.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[id\_col, }\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{])}
    
    \ControlFlowTok{return}\NormalTok{ result}
\end{Highlighting}
\end{Shaded}

\subsection{Step 3: Data Extraction and Factor
Merging}\label{step-3-data-extraction-and-factor-merging}

Extract returns for each security-event across the full estimation +
event window and merge risk factors.

\phantomsection\label{extraction}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ extract\_returns(aligned\_events, prices, factors, config,}
\NormalTok{                    id\_col}\OperatorTok{=}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, date\_col}\OperatorTok{=}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, ret\_col}\OperatorTok{=}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{,}
\NormalTok{                    mkt\_col}\OperatorTok{=}\StringTok{\textquotesingle{}mkt\_excess\textquotesingle{}}\NormalTok{, rf\_col}\OperatorTok{=}\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{):}
    \CommentTok{"""Extract stock returns and merge risk factors for each event.}
\CommentTok{    }
\CommentTok{    For each security{-}event, retrieves daily returns from estper\_beg}
\CommentTok{    through evtwin\_end and merges appropriate risk factors.}
\CommentTok{    """}
\NormalTok{    prices }\OperatorTok{=}\NormalTok{ prices.copy()}
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ factors.copy()}
\NormalTok{    prices[date\_col] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(prices[date\_col])}
\NormalTok{    factors[date\_col] }\OperatorTok{=}\NormalTok{ pd.to\_datetime(factors[date\_col])}
    
    \CommentTok{\# Recover raw return from excess return if needed}
    \ControlFlowTok{if}\NormalTok{ ret\_col }\KeywordTok{not} \KeywordTok{in}\NormalTok{ prices.columns }\KeywordTok{and} \StringTok{\textquotesingle{}ret\_excess\textquotesingle{}} \KeywordTok{in}\NormalTok{ prices.columns:}
        \ControlFlowTok{if}\NormalTok{ rf\_col }\KeywordTok{in}\NormalTok{ factors.columns:}
\NormalTok{            prices }\OperatorTok{=}\NormalTok{ prices.merge(factors[[date\_col, rf\_col]].drop\_duplicates(),}
\NormalTok{                                  on}\OperatorTok{=}\NormalTok{date\_col, how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\NormalTok{        prices[ret\_col] }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ prices[rf\_col]}
    
    \CommentTok{\# Factor columns based on model}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ config.risk\_model}
\NormalTok{    fac\_cols }\OperatorTok{=}\NormalTok{ [mkt\_col] }\ControlFlowTok{if}\NormalTok{ mkt\_col }\KeywordTok{in}\NormalTok{ factors.columns }\ControlFlowTok{else}\NormalTok{ []}
    \ControlFlowTok{if}\NormalTok{ rf\_col }\KeywordTok{in}\NormalTok{ factors.columns:}
\NormalTok{        fac\_cols.append(rf\_col)}
    
\NormalTok{    model\_factors }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{        RiskModel.FF3: [}\StringTok{\textquotesingle{}smb\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}hml\textquotesingle{}}\NormalTok{],}
\NormalTok{        RiskModel.CARHART: [}\StringTok{\textquotesingle{}smb\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}hml\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}umd\textquotesingle{}}\NormalTok{],}
\NormalTok{        RiskModel.FF5: [}\StringTok{\textquotesingle{}smb\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}hml\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}rmw\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}cma\textquotesingle{}}\NormalTok{],}
\NormalTok{        RiskModel.CUSTOM: config.custom\_factors,}
\NormalTok{    \}}
    \ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ model\_factors.get(model, []):}
        \ControlFlowTok{if}\NormalTok{ f }\KeywordTok{in}\NormalTok{ factors.columns:}
\NormalTok{            fac\_cols.append(f)}
    
\NormalTok{    fac\_cols }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{set}\NormalTok{([date\_col] }\OperatorTok{+}\NormalTok{ fac\_cols))}
    
    \CommentTok{\# Vectorized merge approach: join events with prices on id + date range}
\NormalTok{    frames }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ \_, evt }\KeywordTok{in}\NormalTok{ aligned\_events.iterrows():}
\NormalTok{        mask }\OperatorTok{=}\NormalTok{ ((prices[id\_col] }\OperatorTok{==}\NormalTok{ evt[id\_col]) }\OperatorTok{\&}
\NormalTok{                (prices[date\_col] }\OperatorTok{\textgreater{}=}\NormalTok{ evt[}\StringTok{\textquotesingle{}estper\_beg\textquotesingle{}}\NormalTok{]) }\OperatorTok{\&}
\NormalTok{                (prices[date\_col] }\OperatorTok{\textless{}=}\NormalTok{ evt[}\StringTok{\textquotesingle{}evtwin\_end\textquotesingle{}}\NormalTok{]))}
\NormalTok{        fd }\OperatorTok{=}\NormalTok{ prices.loc[mask, [id\_col, date\_col, ret\_col]].copy()}
        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(fd) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
            \ControlFlowTok{continue}
\NormalTok{        fd[}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{]}
\NormalTok{        fd[}\StringTok{\textquotesingle{}estper\_beg\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}estper\_beg\textquotesingle{}}\NormalTok{]}
\NormalTok{        fd[}\StringTok{\textquotesingle{}estper\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}estper\_end\textquotesingle{}}\NormalTok{]}
\NormalTok{        fd[}\StringTok{\textquotesingle{}evtwin\_beg\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}evtwin\_beg\textquotesingle{}}\NormalTok{]}
\NormalTok{        fd[}\StringTok{\textquotesingle{}evtwin\_end\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}evtwin\_end\textquotesingle{}}\NormalTok{]}
        \ControlFlowTok{if} \StringTok{\textquotesingle{}group\textquotesingle{}} \KeywordTok{in}\NormalTok{ evt.index:}
\NormalTok{            fd[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{]}
\NormalTok{        frames.append(fd)}
    
    \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ frames:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{"No return data found for any events"}\NormalTok{)}
    
\NormalTok{    result }\OperatorTok{=}\NormalTok{ pd.concat(frames, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    result }\OperatorTok{=}\NormalTok{ result.merge(factors[fac\_cols].drop\_duplicates(), on}\OperatorTok{=}\NormalTok{date\_col, how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
    
    \CommentTok{\# Excess and market{-}adjusted returns}
    \ControlFlowTok{if}\NormalTok{ rf\_col }\KeywordTok{in}\NormalTok{ result.columns:}
\NormalTok{        result[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ result[ret\_col] }\OperatorTok{{-}}\NormalTok{ result[rf\_col]}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        result[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ result[ret\_col]}
    \ControlFlowTok{if}\NormalTok{ mkt\_col }\KeywordTok{in}\NormalTok{ result.columns:}
\NormalTok{        result[}\StringTok{\textquotesingle{}ret\_mktadj\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ result[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ result[mkt\_col]}
    
\NormalTok{    result }\OperatorTok{=}\NormalTok{ result.sort\_values([id\_col, }\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{, date\_col]).reset\_index(drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    n\_evts }\OperatorTok{=}\NormalTok{ result.groupby([id\_col, }\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{]).ngroups}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Extracted }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(result)}\SpecialCharTok{:,\}}\SpecialStringTok{ obs for }\SpecialCharTok{\{}\NormalTok{n\_evts}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}events"}\NormalTok{)}
    \ControlFlowTok{return}\NormalTok{ result}
\end{Highlighting}
\end{Shaded}

\subsection{Step 4: Risk Model
Estimation}\label{step-4-risk-model-estimation}

Estimate risk model parameters over the estimation window.

\phantomsection\label{estimation}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ estimate\_model(}
\NormalTok{    event\_returns, config, id\_col}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, date\_col}\OperatorTok{=}\StringTok{"date"}\NormalTok{, ret\_col}\OperatorTok{=}\StringTok{"ret"}
\NormalTok{):}
    \CommentTok{"""Estimate risk model parameters for each firm{-}event.}

\CommentTok{    Runs OLS over the estimation window. Returns alpha, betas, sigma,}
\CommentTok{    R, nobs, and residuals for cross{-}correlation computation.}
\CommentTok{    """}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ config.risk\_model}

    \CommentTok{\# Define regression specification}
\NormalTok{    dep\_var\_map }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{        RiskModel.MARKET\_ADJ: }\StringTok{"ret\_mktadj"}\NormalTok{,}
\NormalTok{        RiskModel.MARKET\_MODEL: ret\_col,}
\NormalTok{        RiskModel.FF3: }\StringTok{"ret\_excess"}\NormalTok{,}
\NormalTok{        RiskModel.CARHART: }\StringTok{"ret\_excess"}\NormalTok{,}
\NormalTok{        RiskModel.FF5: }\StringTok{"ret\_excess"}\NormalTok{,}
\NormalTok{        RiskModel.CUSTOM: }\StringTok{"ret\_excess"}\NormalTok{,}
\NormalTok{    \}}
\NormalTok{    indep\_var\_map }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{        RiskModel.MARKET\_ADJ: [],}
\NormalTok{        RiskModel.MARKET\_MODEL: [}\StringTok{"mkt\_excess"}\NormalTok{],}
\NormalTok{        RiskModel.FF3: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{],}
\NormalTok{        RiskModel.CARHART: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"umd"}\NormalTok{],}
\NormalTok{        RiskModel.FF5: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{],}
\NormalTok{        RiskModel.CUSTOM: config.custom\_factors,}
\NormalTok{    \}}

\NormalTok{    dep\_var }\OperatorTok{=}\NormalTok{ dep\_var\_map[model]}
\NormalTok{    indep\_vars }\OperatorTok{=}\NormalTok{ indep\_var\_map[model]}

\NormalTok{    est }\OperatorTok{=}\NormalTok{ event\_returns[}
\NormalTok{        (event\_returns[date\_col] }\OperatorTok{\textgreater{}=}\NormalTok{ event\_returns[}\StringTok{"estper\_beg"}\NormalTok{])}
        \OperatorTok{\&}\NormalTok{ (event\_returns[date\_col] }\OperatorTok{\textless{}=}\NormalTok{ event\_returns[}\StringTok{"estper\_end"}\NormalTok{])}
\NormalTok{    ].copy()}

\NormalTok{    params\_list }\OperatorTok{=}\NormalTok{ []}

    \ControlFlowTok{for}\NormalTok{ (firm, evtdate), grp }\KeywordTok{in}\NormalTok{ est.groupby([id\_col, }\StringTok{"evtdate"}\NormalTok{]):}
\NormalTok{        valid }\OperatorTok{=}\NormalTok{ grp.dropna(subset}\OperatorTok{=}\NormalTok{[dep\_var] }\OperatorTok{+}\NormalTok{ indep\_vars)}
\NormalTok{        nobs }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(valid)}
        \ControlFlowTok{if}\NormalTok{ nobs }\OperatorTok{\textless{}}\NormalTok{ config.min\_estimation\_obs:}
            \ControlFlowTok{continue}

\NormalTok{        y }\OperatorTok{=}\NormalTok{ valid[dep\_var].values}

        \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(indep\_vars) }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
            \CommentTok{\# Market{-}adjusted: intercept{-}only for variance}
\NormalTok{            p }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{                id\_col: firm,}
                \StringTok{"evtdate"}\NormalTok{: evtdate,}
                \StringTok{"alpha"}\NormalTok{: y.mean(),}
                \StringTok{"sigma"}\NormalTok{: y.std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
                \StringTok{"variance"}\NormalTok{: y.var(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
                \StringTok{"nobs"}\NormalTok{: nobs,}
                \StringTok{"r\_squared"}\NormalTok{: }\FloatTok{0.0}\NormalTok{,}
                \StringTok{"\_residuals"}\NormalTok{: y }\OperatorTok{{-}}\NormalTok{ y.mean(),}
\NormalTok{            \}}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            X }\OperatorTok{=}\NormalTok{ sm.add\_constant(valid[indep\_vars].values)}
\NormalTok{            res }\OperatorTok{=}\NormalTok{ sm.OLS(y, X).fit()}
\NormalTok{            p }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{                id\_col: firm,}
                \StringTok{"evtdate"}\NormalTok{: evtdate,}
                \StringTok{"alpha"}\NormalTok{: res.params[}\DecValTok{0}\NormalTok{],}
                \StringTok{"sigma"}\NormalTok{: np.sqrt(res.mse\_resid),}
                \StringTok{"variance"}\NormalTok{: res.mse\_resid,}
                \StringTok{"nobs"}\NormalTok{: nobs,}
                \StringTok{"r\_squared"}\NormalTok{: res.rsquared }\ControlFlowTok{if}\NormalTok{ np.isfinite(res.rsquared) }\ControlFlowTok{else}\NormalTok{ np.nan,}
                \StringTok{"\_residuals"}\NormalTok{: res.resid,}
\NormalTok{            \}}
            \ControlFlowTok{for}\NormalTok{ j, var }\KeywordTok{in} \BuiltInTok{enumerate}\NormalTok{(indep\_vars):}
\NormalTok{                p[}\SpecialStringTok{f"beta\_}\SpecialCharTok{\{}\NormalTok{var}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{] }\OperatorTok{=}\NormalTok{ res.params[j }\OperatorTok{+} \DecValTok{1}\NormalTok{]}
        
        \CommentTok{\# Skip degenerate firms (zero or near{-}zero variance)}
        \ControlFlowTok{if}\NormalTok{ p[}\StringTok{"sigma"}\NormalTok{] }\OperatorTok{\textless{}} \FloatTok{1e{-}6}\NormalTok{:}
            \ControlFlowTok{continue}

\NormalTok{        params\_list.append(p)}

    \ControlFlowTok{if} \KeywordTok{not}\NormalTok{ params\_list:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{"No firm{-}events passed minimum observation filter"}\NormalTok{)}

\NormalTok{    params\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(params\_list)}
\NormalTok{    n\_total }\OperatorTok{=}\NormalTok{ event\_returns.groupby([id\_col, }\StringTok{"evtdate"}\NormalTok{]).ngroups}
    \BuiltInTok{print}\NormalTok{(}
        \SpecialStringTok{f"  Estimated }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(params\_df)}\SpecialCharTok{\}}\SpecialStringTok{/}\SpecialCharTok{\{}\NormalTok{n\_total}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}events "}
        \SpecialStringTok{f"(mean R = }\SpecialCharTok{\{}\NormalTok{params\_df[}\StringTok{\textquotesingle{}r\_squared\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{dropna()}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}
\NormalTok{    )}
    \ControlFlowTok{return}\NormalTok{ params\_df}
\end{Highlighting}
\end{Shaded}

\subsection{Step 5: Abnormal Return
Computation}\label{step-5-abnormal-return-computation}

Compute AR, CAR, BHAR, SAR, SCAR for each firm-event-date.

\phantomsection\label{abnormal-returns}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_abnormal\_returns(}
\NormalTok{    event\_returns, params, config, id\_col}\OperatorTok{=}\StringTok{"symbol"}\NormalTok{, date\_col}\OperatorTok{=}\StringTok{"date"}\NormalTok{, ret\_col}\OperatorTok{=}\StringTok{"ret"}
\NormalTok{):}
    \CommentTok{"""Compute abnormal returns and aggregate to CARs/BHARs.}

\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    daily\_ar : pd.DataFrame {-} daily AR/SAR/CAR/BHAR per firm{-}event{-}date}
\CommentTok{    event\_ar : pd.DataFrame {-} event{-}level CAR/BHAR/SCAR per firm{-}event}
\CommentTok{    """}
\NormalTok{    model }\OperatorTok{=}\NormalTok{ config.risk\_model}

\NormalTok{    factor\_map }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{        RiskModel.MARKET\_ADJ: [],}
\NormalTok{        RiskModel.MARKET\_MODEL: [}\StringTok{"mkt\_excess"}\NormalTok{],}
\NormalTok{        RiskModel.FF3: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{],}
\NormalTok{        RiskModel.CARHART: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"umd"}\NormalTok{],}
\NormalTok{        RiskModel.FF5: [}\StringTok{"mkt\_excess"}\NormalTok{, }\StringTok{"smb"}\NormalTok{, }\StringTok{"hml"}\NormalTok{, }\StringTok{"rmw"}\NormalTok{, }\StringTok{"cma"}\NormalTok{],}
\NormalTok{        RiskModel.CUSTOM: config.custom\_factors,}
\NormalTok{    \}}
\NormalTok{    factor\_cols }\OperatorTok{=}\NormalTok{ factor\_map[model]}

    \CommentTok{\# Filter to event window}
\NormalTok{    evt }\OperatorTok{=}\NormalTok{ event\_returns[}
\NormalTok{        (event\_returns[date\_col] }\OperatorTok{\textgreater{}=}\NormalTok{ event\_returns[}\StringTok{"evtwin\_beg"}\NormalTok{])}
        \OperatorTok{\&}\NormalTok{ (event\_returns[date\_col] }\OperatorTok{\textless{}=}\NormalTok{ event\_returns[}\StringTok{"evtwin\_end"}\NormalTok{])}
\NormalTok{    ].copy()}

    \CommentTok{\# Merge params (drop residuals column for merge)}
\NormalTok{    merge\_cols }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ params.columns }\ControlFlowTok{if}\NormalTok{ c }\OperatorTok{!=} \StringTok{"\_residuals"}\NormalTok{]}
\NormalTok{    evt }\OperatorTok{=}\NormalTok{ evt.merge(params[merge\_cols], on}\OperatorTok{=}\NormalTok{[id\_col, }\StringTok{"evtdate"}\NormalTok{], how}\OperatorTok{=}\StringTok{"inner"}\NormalTok{)}

    \CommentTok{\# Expected returns}
    \ControlFlowTok{if}\NormalTok{ model }\OperatorTok{==}\NormalTok{ RiskModel.MARKET\_ADJ:}
\NormalTok{        evt[}\StringTok{"expected\_ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt.get(}\StringTok{"mkt\_excess"}\NormalTok{, }\DecValTok{0}\NormalTok{) }\OperatorTok{+}\NormalTok{ evt.get(}\StringTok{"risk\_free"}\NormalTok{, }\DecValTok{0}\NormalTok{)}
\NormalTok{        evt[}\StringTok{"AR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[ret\_col] }\OperatorTok{{-}}\NormalTok{ evt[}\StringTok{"expected\_ret"}\NormalTok{]}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        evt[}\StringTok{"expected\_ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{"alpha"}\NormalTok{]}
        \ControlFlowTok{for}\NormalTok{ fc }\KeywordTok{in}\NormalTok{ factor\_cols:}
\NormalTok{            bcol }\OperatorTok{=} \SpecialStringTok{f"beta\_}\SpecialCharTok{\{}\NormalTok{fc}\SpecialCharTok{\}}\SpecialStringTok{"}
            \ControlFlowTok{if}\NormalTok{ bcol }\KeywordTok{in}\NormalTok{ evt.columns:}
\NormalTok{                evt[}\StringTok{"expected\_ret"}\NormalTok{] }\OperatorTok{+=}\NormalTok{ evt[bcol] }\OperatorTok{*}\NormalTok{ evt[fc]}

        \ControlFlowTok{if}\NormalTok{ model }\OperatorTok{==}\NormalTok{ RiskModel.MARKET\_MODEL:}
\NormalTok{            evt[}\StringTok{"AR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[ret\_col] }\OperatorTok{{-}}\NormalTok{ evt[}\StringTok{"expected\_ret"}\NormalTok{]}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            evt[}\StringTok{"AR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{"ret\_excess"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ evt[}\StringTok{"expected\_ret"}\NormalTok{]}

\NormalTok{    evt[}\StringTok{"SAR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[}\StringTok{"AR"}\NormalTok{] }\OperatorTok{/}\NormalTok{ evt[}\StringTok{"sigma"}\NormalTok{]}
\NormalTok{    evt }\OperatorTok{=}\NormalTok{ evt.sort\_values([id\_col, }\StringTok{"evtdate"}\NormalTok{, date\_col])}

    \CommentTok{\# Compute event time}
\NormalTok{    all\_dates }\OperatorTok{=} \BuiltInTok{sorted}\NormalTok{(event\_returns[date\_col].unique())}
\NormalTok{    d2i }\OperatorTok{=}\NormalTok{ \{d: i }\ControlFlowTok{for}\NormalTok{ i, d }\KeywordTok{in} \BuiltInTok{enumerate}\NormalTok{(all\_dates)\}}
\NormalTok{    evt[}\StringTok{"evttime"}\NormalTok{] }\OperatorTok{=}\NormalTok{ evt[date\_col].}\BuiltInTok{map}\NormalTok{(d2i) }\OperatorTok{{-}}\NormalTok{ evt[}\StringTok{"evtdate"}\NormalTok{].}\BuiltInTok{map}\NormalTok{(d2i)}

    \CommentTok{\# Cumulative measures per firm{-}event}
\NormalTok{    daily\_recs }\OperatorTok{=}\NormalTok{ []}
\NormalTok{    event\_recs }\OperatorTok{=}\NormalTok{ []}

    \ControlFlowTok{for}\NormalTok{ (firm, evtdate), g }\KeywordTok{in}\NormalTok{ evt.groupby([id\_col, }\StringTok{"evtdate"}\NormalTok{]):}
\NormalTok{        g }\OperatorTok{=}\NormalTok{ g.sort\_values(date\_col).copy()}
\NormalTok{        nd }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(g)}

\NormalTok{        g[}\StringTok{"CAR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ g[}\StringTok{"AR"}\NormalTok{].cumsum()}
\NormalTok{        g[}\StringTok{"cum\_ret"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ g[ret\_col]).cumprod() }\OperatorTok{{-}} \DecValTok{1}
\NormalTok{        g[}\StringTok{"cum\_expected"}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ g[}\StringTok{"expected\_ret"}\NormalTok{]).cumprod() }\OperatorTok{{-}} \DecValTok{1}
\NormalTok{        g[}\StringTok{"BHAR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ g[}\StringTok{"cum\_ret"}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ g[}\StringTok{"cum\_expected"}\NormalTok{]}
\NormalTok{        g[}\StringTok{"SCAR"}\NormalTok{] }\OperatorTok{=}\NormalTok{ g[}\StringTok{"CAR"}\NormalTok{] }\OperatorTok{/}\NormalTok{ (g[}\StringTok{"sigma"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{] }\OperatorTok{*}\NormalTok{ np.sqrt(np.arange(}\DecValTok{1}\NormalTok{, nd }\OperatorTok{+} \DecValTok{1}\NormalTok{)))}

\NormalTok{        daily\_recs.append(g)}

\NormalTok{        last }\OperatorTok{=}\NormalTok{ g.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        sigma }\OperatorTok{=}\NormalTok{ g[}\StringTok{"sigma"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{        nobs }\OperatorTok{=}\NormalTok{ g[}\StringTok{"nobs"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}

\NormalTok{        rec }\OperatorTok{=}\NormalTok{ \{}
\NormalTok{            id\_col: firm,}
            \StringTok{"evtdate"}\NormalTok{: evtdate,}
            \StringTok{"CAR"}\NormalTok{: last[}\StringTok{"CAR"}\NormalTok{],}
            \StringTok{"BHAR"}\NormalTok{: last[}\StringTok{"BHAR"}\NormalTok{],}
            \StringTok{"cum\_ret"}\NormalTok{: last[}\StringTok{"cum\_ret"}\NormalTok{],}
            \StringTok{"SCAR"}\NormalTok{: last[}\StringTok{"CAR"}\NormalTok{] }\OperatorTok{/}\NormalTok{ (sigma }\OperatorTok{*}\NormalTok{ np.sqrt(nd)),}
            \StringTok{"sigma"}\NormalTok{: sigma,}
            \StringTok{"variance"}\NormalTok{: g[}\StringTok{"variance"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{],}
            \StringTok{"nobs"}\NormalTok{: nobs,}
            \StringTok{"n\_event\_days"}\NormalTok{: nd,}
            \StringTok{"alpha"}\NormalTok{: g[}\StringTok{"alpha"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{],}
            \StringTok{"pat\_scale"}\NormalTok{: (nobs }\OperatorTok{{-}} \DecValTok{2}\NormalTok{) }\OperatorTok{/}\NormalTok{ (nobs }\OperatorTok{{-}} \DecValTok{4}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ nobs }\OperatorTok{\textgreater{}} \DecValTok{4} \ControlFlowTok{else}\NormalTok{ np.nan,}
            \StringTok{"pos\_car"}\NormalTok{: }\BuiltInTok{int}\NormalTok{(last[}\StringTok{"CAR"}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{),}
\NormalTok{        \}}

        \ControlFlowTok{for}\NormalTok{ fc }\KeywordTok{in}\NormalTok{ factor\_cols:}
\NormalTok{            bcol }\OperatorTok{=} \SpecialStringTok{f"beta\_}\SpecialCharTok{\{}\NormalTok{fc}\SpecialCharTok{\}}\SpecialStringTok{"}
            \ControlFlowTok{if}\NormalTok{ bcol }\KeywordTok{in}\NormalTok{ g.columns:}
\NormalTok{                rec[bcol] }\OperatorTok{=}\NormalTok{ g[bcol].iloc[}\DecValTok{0}\NormalTok{]}
        \ControlFlowTok{if} \StringTok{"group"} \KeywordTok{in}\NormalTok{ g.columns:}
\NormalTok{            rec[}\StringTok{"group"}\NormalTok{] }\OperatorTok{=}\NormalTok{ g[}\StringTok{"group"}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}

\NormalTok{        event\_recs.append(rec)}

\NormalTok{    daily\_ar }\OperatorTok{=}\NormalTok{ pd.concat(daily\_recs, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    event\_ar }\OperatorTok{=}\NormalTok{ pd.DataFrame(event\_recs)}

    \BuiltInTok{print}\NormalTok{(}
        \SpecialStringTok{f"  }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(event\_ar)}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}events | Mean CAR: }\SpecialCharTok{\{}\NormalTok{event\_ar[}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.6f\}}\SpecialStringTok{ | "}
        \SpecialStringTok{f"Mean BHAR: }\SpecialCharTok{\{}\NormalTok{event\_ar[}\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.6f\}}\SpecialStringTok{ | "}
        \SpecialStringTok{f"\% positive: }\SpecialCharTok{\{}\NormalTok{event\_ar[}\StringTok{\textquotesingle{}pos\_car\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}
\NormalTok{    )}
    \ControlFlowTok{return}\NormalTok{ daily\_ar, event\_ar}
\end{Highlighting}
\end{Shaded}

\subsection{Step 6: Comprehensive Test
Statistics}\label{step-6-comprehensive-test-statistics}

Eight tests covering parametric, non-parametric, and
cross-correlation-robust approaches.

\phantomsection\label{tests}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ compute\_test\_statistics(event\_ar, params}\OperatorTok{=}\VariableTok{None}\NormalTok{, group\_col}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \CommentTok{"""Compute comprehensive test statistics for abnormal returns.}
\CommentTok{    }
\CommentTok{    Implements 8 tests with varying assumptions about variance,}
\CommentTok{    cross{-}dependence, and distributional form.}
\CommentTok{    """}
    \KeywordTok{def}\NormalTok{ \_stats(data, label}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
\NormalTok{        N }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(data)}
        \ControlFlowTok{if}\NormalTok{ N }\OperatorTok{\textless{}} \DecValTok{3}\NormalTok{:}
            \ControlFlowTok{return} \VariableTok{None}
        
\NormalTok{        cars }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{].values}
\NormalTok{        bhars }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{].values}
\NormalTok{        scars }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}SCAR\textquotesingle{}}\NormalTok{].values}
\NormalTok{        pos }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}pos\_car\textquotesingle{}}\NormalTok{].values}
        
\NormalTok{        m\_car, s\_car }\OperatorTok{=}\NormalTok{ np.mean(cars), np.std(cars, ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{        m\_scar, s\_scar }\OperatorTok{=}\NormalTok{ np.mean(scars), np.std(scars, ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
        
\NormalTok{        r }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{: label }\KeywordTok{or} \StringTok{\textquotesingle{}All\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: N,}
             \StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{: m\_car, }\StringTok{\textquotesingle{}median\_CAR\textquotesingle{}}\NormalTok{: np.median(cars),}
             \StringTok{\textquotesingle{}std\_CAR\textquotesingle{}}\NormalTok{: s\_car, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{: np.mean(bhars),}
             \StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{: np.mean(pos)\}}
        
        \CommentTok{\# 1. Cross{-}sectional t}
\NormalTok{        t1 }\OperatorTok{=}\NormalTok{ m\_car }\OperatorTok{/}\NormalTok{ (s\_car }\OperatorTok{/}\NormalTok{ np.sqrt(N)) }\ControlFlowTok{if}\NormalTok{ s\_car }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else}\NormalTok{ np.nan}
\NormalTok{        r[}\StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ t1}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2} \OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}}\NormalTok{ stats.t.cdf(}\BuiltInTok{abs}\NormalTok{(t1), N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)) }\ControlFlowTok{if}\NormalTok{ np.isfinite(t1) }\ControlFlowTok{else}\NormalTok{ np.nan}
        
        \CommentTok{\# 2. Patell Z}
        \ControlFlowTok{if} \StringTok{\textquotesingle{}pat\_scale\textquotesingle{}} \KeywordTok{in}\NormalTok{ data.columns:}
\NormalTok{            ps }\OperatorTok{=}\NormalTok{ data[}\StringTok{\textquotesingle{}pat\_scale\textquotesingle{}}\NormalTok{].dropna().values}
\NormalTok{            z2 }\OperatorTok{=}\NormalTok{ np.}\BuiltInTok{sum}\NormalTok{(scars[:}\BuiltInTok{len}\NormalTok{(ps)]) }\OperatorTok{/}\NormalTok{ np.sqrt(np.}\BuiltInTok{sum}\NormalTok{(ps)) }\ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(ps) }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else}\NormalTok{ np.nan}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            z2 }\OperatorTok{=}\NormalTok{ m\_scar }\OperatorTok{*}\NormalTok{ np.sqrt(N)}
\NormalTok{        r[}\StringTok{\textquotesingle{}Z\_Patell\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ z2}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{stats.norm.cdf(}\BuiltInTok{abs}\NormalTok{(z2))) }\ControlFlowTok{if}\NormalTok{ np.isfinite(z2) }\ControlFlowTok{else}\NormalTok{ np.nan}
        
        \CommentTok{\# 3. BMP}
\NormalTok{        t3 }\OperatorTok{=}\NormalTok{ m\_scar }\OperatorTok{/}\NormalTok{ (s\_scar }\OperatorTok{/}\NormalTok{ np.sqrt(N)) }\ControlFlowTok{if}\NormalTok{ s\_scar }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else}\NormalTok{ np.nan}
\NormalTok{        r[}\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ t3}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{stats.t.cdf(}\BuiltInTok{abs}\NormalTok{(t3), N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)) }\ControlFlowTok{if}\NormalTok{ np.isfinite(t3) }\ControlFlowTok{else}\NormalTok{ np.nan}
        
        \CommentTok{\# 4. Kolari{-}Pynnnen}
\NormalTok{        rbar }\OperatorTok{=} \FloatTok{0.0}
        \ControlFlowTok{if}\NormalTok{ params }\KeywordTok{is} \KeywordTok{not} \VariableTok{None} \KeywordTok{and} \StringTok{\textquotesingle{}\_residuals\textquotesingle{}} \KeywordTok{in}\NormalTok{ params.columns:}
\NormalTok{            resids }\OperatorTok{=}\NormalTok{ [row[}\StringTok{\textquotesingle{}\_residuals\textquotesingle{}}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ \_, row }\KeywordTok{in}\NormalTok{ params.iterrows()}
                      \ControlFlowTok{if} \BuiltInTok{isinstance}\NormalTok{(row.get(}\StringTok{\textquotesingle{}\_residuals\textquotesingle{}}\NormalTok{), np.ndarray)]}
            \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(resids) }\OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{:}
\NormalTok{                ml }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(}\BuiltInTok{len}\NormalTok{(x) }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ resids)}
\NormalTok{                aligned }\OperatorTok{=}\NormalTok{ np.column\_stack([x[:ml] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ resids])}
\NormalTok{                cm }\OperatorTok{=}\NormalTok{ np.corrcoef(aligned.T)}
\NormalTok{                np.fill\_diagonal(cm, }\DecValTok{0}\NormalTok{)}
\NormalTok{                rbar }\OperatorTok{=}\NormalTok{ cm.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(resids) }\OperatorTok{*}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(resids)}\OperatorTok{{-}}\DecValTok{1}\NormalTok{))}
        
\NormalTok{        adj }\OperatorTok{=}\NormalTok{ np.sqrt(}\DecValTok{1}\OperatorTok{/}\NormalTok{(}\DecValTok{1}\OperatorTok{+}\NormalTok{(N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}\OperatorTok{*}\NormalTok{rbar)) }\ControlFlowTok{if}\NormalTok{ (}\DecValTok{1}\OperatorTok{+}\NormalTok{(N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}\OperatorTok{*}\NormalTok{rbar) }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else} \DecValTok{1}
\NormalTok{        t4 }\OperatorTok{=}\NormalTok{ t3 }\OperatorTok{*}\NormalTok{ adj }\ControlFlowTok{if}\NormalTok{ np.isfinite(t3) }\ControlFlowTok{else}\NormalTok{ np.nan}
\NormalTok{        r[}\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ t4}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{stats.t.cdf(}\BuiltInTok{abs}\NormalTok{(t4), N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)) }\ControlFlowTok{if}\NormalTok{ np.isfinite(t4) }\ControlFlowTok{else}\NormalTok{ np.nan}
\NormalTok{        r[}\StringTok{\textquotesingle{}r\_bar\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ rbar}
        
        \CommentTok{\# 5. Generalized sign test}
\NormalTok{        p\_hat }\OperatorTok{=}\NormalTok{ np.mean(pos)}
\NormalTok{        z5 }\OperatorTok{=}\NormalTok{ (p\_hat }\OperatorTok{{-}} \FloatTok{0.5}\NormalTok{) }\OperatorTok{/}\NormalTok{ np.sqrt(}\FloatTok{0.25} \OperatorTok{/}\NormalTok{ N)}
\NormalTok{        r[}\StringTok{\textquotesingle{}Z\_GSign\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ z5}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{stats.norm.cdf(}\BuiltInTok{abs}\NormalTok{(z5)))}
        
        \CommentTok{\# 6. Sign test}
\NormalTok{        r[}\StringTok{\textquotesingle{}Z\_Sign\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ z5  }\CommentTok{\# Same formula with p0=0.5}
\NormalTok{        r[}\StringTok{\textquotesingle{}p\_Sign\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ r[}\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{]}
        
        \CommentTok{\# 7. Skewness{-}adjusted t}
        \ControlFlowTok{if}\NormalTok{ s\_scar }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{            zb }\OperatorTok{=}\NormalTok{ m\_scar }\OperatorTok{/}\NormalTok{ s\_scar}
\NormalTok{            gam }\OperatorTok{=}\NormalTok{ stats.skew(scars)}
\NormalTok{            t7 }\OperatorTok{=}\NormalTok{ np.sqrt(N) }\OperatorTok{*}\NormalTok{ (zb }\OperatorTok{+}\NormalTok{ gam}\OperatorTok{*}\NormalTok{zb}\OperatorTok{**}\DecValTok{2}\OperatorTok{/}\DecValTok{3} \OperatorTok{+}\NormalTok{ gam}\OperatorTok{**}\DecValTok{2}\OperatorTok{*}\NormalTok{zb}\OperatorTok{**}\DecValTok{3}\OperatorTok{/}\DecValTok{27} \OperatorTok{+}\NormalTok{ gam}\OperatorTok{/}\NormalTok{(}\DecValTok{6}\OperatorTok{*}\NormalTok{N))}
\NormalTok{            r[}\StringTok{\textquotesingle{}t\_SkAdj\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ t7}
\NormalTok{            r[}\StringTok{\textquotesingle{}p\_SkAdj\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2}\OperatorTok{*}\NormalTok{(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{stats.t.cdf(}\BuiltInTok{abs}\NormalTok{(t7), N}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)) }\ControlFlowTok{if}\NormalTok{ np.isfinite(t7) }\ControlFlowTok{else}\NormalTok{ np.nan}
        
        \CommentTok{\# 8. Wilcoxon signed{-}rank}
        \ControlFlowTok{try}\NormalTok{:}
\NormalTok{            w, pw }\OperatorTok{=}\NormalTok{ stats.wilcoxon(cars, alternative}\OperatorTok{=}\StringTok{\textquotesingle{}two{-}sided\textquotesingle{}}\NormalTok{)}
\NormalTok{            r[}\StringTok{\textquotesingle{}W\_Wilcoxon\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ w}
\NormalTok{            r[}\StringTok{\textquotesingle{}p\_Wilcoxon\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ pw}
        \ControlFlowTok{except}\NormalTok{:}
\NormalTok{            r[}\StringTok{\textquotesingle{}W\_Wilcoxon\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ r[}\StringTok{\textquotesingle{}p\_Wilcoxon\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.nan}
        
        \ControlFlowTok{return}\NormalTok{ r}
    
\NormalTok{    results }\OperatorTok{=}\NormalTok{ [\_stats(event\_ar)]}
    \ControlFlowTok{if}\NormalTok{ group\_col }\KeywordTok{and}\NormalTok{ group\_col }\KeywordTok{in}\NormalTok{ event\_ar.columns:}
        \ControlFlowTok{for}\NormalTok{ gv, gd }\KeywordTok{in}\NormalTok{ event\_ar.groupby(group\_col):}
\NormalTok{            s }\OperatorTok{=}\NormalTok{ \_stats(gd, label}\OperatorTok{=}\NormalTok{gv)}
            \ControlFlowTok{if}\NormalTok{ s:}
\NormalTok{                results.append(s)}
    
    \ControlFlowTok{return}\NormalTok{ pd.DataFrame([r }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ results }\ControlFlowTok{if}\NormalTok{ r }\KeywordTok{is} \KeywordTok{not} \VariableTok{None}\NormalTok{])}


\KeywordTok{def}\NormalTok{ compute\_daily\_stats(daily\_ar, id\_col}\OperatorTok{=}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{):}
    \CommentTok{"""Compute test statistics at each event time t."""}
\NormalTok{    rows }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ t, g }\KeywordTok{in}\NormalTok{ daily\_ar.groupby(}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{):}
\NormalTok{        n }\OperatorTok{=}\NormalTok{ g[id\_col].nunique()}
        \ControlFlowTok{if}\NormalTok{ n }\OperatorTok{\textless{}} \DecValTok{2}\NormalTok{:}
            \ControlFlowTok{continue}
\NormalTok{        m\_ar }\OperatorTok{=}\NormalTok{ g[}\StringTok{\textquotesingle{}AR\textquotesingle{}}\NormalTok{].mean()}
\NormalTok{        s\_ar }\OperatorTok{=}\NormalTok{ g[}\StringTok{\textquotesingle{}AR\textquotesingle{}}\NormalTok{].std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{        t\_ar }\OperatorTok{=}\NormalTok{ m\_ar }\OperatorTok{/}\NormalTok{ (s\_ar}\OperatorTok{/}\NormalTok{np.sqrt(n)) }\ControlFlowTok{if}\NormalTok{ s\_ar }\OperatorTok{\textgreater{}} \DecValTok{0} \ControlFlowTok{else}\NormalTok{ np.nan}
\NormalTok{        rows.append(\{}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{: t, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: n, }\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{: m\_ar,}
                     \StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{].mean(), }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{: g[}\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{].mean(),}
                     \StringTok{\textquotesingle{}mean\_cum\_ret\textquotesingle{}}\NormalTok{: g.get(}\StringTok{\textquotesingle{}cum\_ret\textquotesingle{}}\NormalTok{, pd.Series()).mean(),}
                     \StringTok{\textquotesingle{}t\_AR\textquotesingle{}}\NormalTok{: t\_ar\})}
    \ControlFlowTok{return}\NormalTok{ pd.DataFrame(rows).sort\_values(}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Step 7: Publication-Ready
Visualization}\label{step-7-publication-ready-visualization}

\phantomsection\label{visualization}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_event\_study(daily\_stats, title}\OperatorTok{=}\StringTok{"Cumulative Abnormal Returns Around Event Date"}\NormalTok{,}
\NormalTok{                     figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{7}\NormalTok{), save\_path}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \CommentTok{"""Publication{-}ready event study plot with CAR, BHAR, and daily AR panels."""}
\NormalTok{    fig, axes }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{figsize, height\_ratios}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{],}
\NormalTok{                              gridspec\_kw}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}hspace\textquotesingle{}}\NormalTok{: }\FloatTok{0.05}\NormalTok{\})}
\NormalTok{    ds }\OperatorTok{=}\NormalTok{ daily\_stats.sort\_values(}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{)}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ ds[}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{].values}
    
    \CommentTok{\# Top: cumulative returns}
\NormalTok{    ax }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{0}\NormalTok{]}
\NormalTok{    ax.plot(t, ds[}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{100}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#2166AC\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{2.5}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Mean CAR\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.plot(t, ds[}\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{100}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#B2182B\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\DecValTok{2}\NormalTok{, ls}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Mean BHAR\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}mean\_cum\_ret\textquotesingle{}} \KeywordTok{in}\NormalTok{ ds.columns:}
\NormalTok{        ax.plot(t, ds[}\StringTok{\textquotesingle{}mean\_cum\_ret\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{100}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#666\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{1.5}\NormalTok{, ls}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{, }
\NormalTok{                label}\OperatorTok{=}\StringTok{\textquotesingle{}Mean Cum. Return\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
\NormalTok{    ax.axvline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{0.8}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{    ax.axhline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{0.5}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{)}
\NormalTok{    ax.set\_ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{)}
\NormalTok{    ax.set\_title(title, fontsize}\OperatorTok{=}\DecValTok{14}\NormalTok{, fontweight}\OperatorTok{=}\StringTok{\textquotesingle{}bold\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax.legend(loc}\OperatorTok{=}\StringTok{\textquotesingle{}upper left\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{10}\NormalTok{)}
\NormalTok{    ax.grid(}\VariableTok{True}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.2}\NormalTok{)}
\NormalTok{    ax.set\_xticklabels([])}
    
    \CommentTok{\# Bottom: daily AR bars}
\NormalTok{    ax2 }\OperatorTok{=}\NormalTok{ axes[}\DecValTok{1}\NormalTok{]}
\NormalTok{    colors }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}\#2166AC\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ v }\OperatorTok{\textgreater{}=} \DecValTok{0} \ControlFlowTok{else} \StringTok{\textquotesingle{}\#B2182B\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ v }\KeywordTok{in}\NormalTok{ ds[}\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{]]}
\NormalTok{    ax2.bar(t, ds[}\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{]}\OperatorTok{*}\DecValTok{100}\NormalTok{, color}\OperatorTok{=}\NormalTok{colors, alpha}\OperatorTok{=}\FloatTok{0.7}\NormalTok{, width}\OperatorTok{=}\FloatTok{0.8}\NormalTok{)}
    \ControlFlowTok{if} \StringTok{\textquotesingle{}t\_AR\textquotesingle{}} \KeywordTok{in}\NormalTok{ ds.columns:}
\NormalTok{        sig }\OperatorTok{=}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(ds[}\StringTok{\textquotesingle{}t\_AR\textquotesingle{}}\NormalTok{].values) }\OperatorTok{\textgreater{}} \FloatTok{1.96}
        \ControlFlowTok{if}\NormalTok{ sig.}\BuiltInTok{any}\NormalTok{():}
\NormalTok{            ax2.scatter(t[sig], ds[}\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{].values[sig]}\OperatorTok{*}\DecValTok{100}\NormalTok{, }
\NormalTok{                       color}\OperatorTok{=}\StringTok{\textquotesingle{}gold\textquotesingle{}}\NormalTok{, s}\OperatorTok{=}\DecValTok{40}\NormalTok{, marker}\OperatorTok{=}\StringTok{\textquotesingle{}*\textquotesingle{}}\NormalTok{, zorder}\OperatorTok{=}\DecValTok{4}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}p\textless{}0.05\textquotesingle{}}\NormalTok{)}
\NormalTok{            ax2.legend(fontsize}\OperatorTok{=}\DecValTok{9}\NormalTok{)}
\NormalTok{    ax2.axvline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{0.8}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{    ax2.axhline(}\DecValTok{0}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{0.5}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.3}\NormalTok{)}
\NormalTok{    ax2.set\_xlabel(}\StringTok{\textquotesingle{}Event Time (Trading Periods)\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{12}\NormalTok{)}
\NormalTok{    ax2.set\_ylabel(}\StringTok{\textquotesingle{}Mean AR (\%)\textquotesingle{}}\NormalTok{, fontsize}\OperatorTok{=}\DecValTok{10}\NormalTok{)}
\NormalTok{    ax2.grid(}\VariableTok{True}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.2}\NormalTok{)}
    
    \ControlFlowTok{for}\NormalTok{ a }\KeywordTok{in}\NormalTok{ axes:}
\NormalTok{        a.spines[}\StringTok{\textquotesingle{}top\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
\NormalTok{        a.spines[}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
\NormalTok{    plt.tight\_layout()}
    \ControlFlowTok{if}\NormalTok{ save\_path:}
\NormalTok{        fig.savefig(save\_path, dpi}\OperatorTok{=}\DecValTok{300}\NormalTok{, bbox\_inches}\OperatorTok{=}\StringTok{\textquotesingle{}tight\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{return}\NormalTok{ fig}


\KeywordTok{def}\NormalTok{ plot\_car\_distribution(event\_ar, var}\OperatorTok{=}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{(}\DecValTok{12}\NormalTok{, }\DecValTok{5}\NormalTok{)):}
    \CommentTok{"""Cross{-}sectional distribution of CARs with histogram and QQ plot."""}
\NormalTok{    fig, (ax1, ax2) }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, figsize}\OperatorTok{=}\NormalTok{figsize)}
\NormalTok{    data }\OperatorTok{=}\NormalTok{ event\_ar[var].dropna() }\OperatorTok{*} \DecValTok{100}
    
\NormalTok{    ax1.hist(data, bins}\OperatorTok{=}\DecValTok{50}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.6}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#2166AC\textquotesingle{}}\NormalTok{, edgecolor}\OperatorTok{=}\StringTok{\textquotesingle{}white\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.axvline(data.mean(), color}\OperatorTok{=}\StringTok{\textquotesingle{}k\textquotesingle{}}\NormalTok{, ls}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{1.5}\NormalTok{, }
\NormalTok{                label}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}Mean=}\SpecialCharTok{\{}\NormalTok{data}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:.2f\}}\SpecialStringTok{\%\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.axvline(data.median(), color}\OperatorTok{=}\StringTok{\textquotesingle{}gray\textquotesingle{}}\NormalTok{, ls}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\FloatTok{1.5}\NormalTok{,}
\NormalTok{                label}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}Median=}\SpecialCharTok{\{}\NormalTok{data}\SpecialCharTok{.}\NormalTok{median()}\SpecialCharTok{:.2f\}}\SpecialStringTok{\%\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.set\_xlabel(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{var}\SpecialCharTok{\}}\SpecialStringTok{ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.set\_ylabel(}\StringTok{\textquotesingle{}Density\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.set\_title(}\SpecialStringTok{f\textquotesingle{}Distribution of }\SpecialCharTok{\{}\NormalTok{var}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{, fontweight}\OperatorTok{=}\StringTok{\textquotesingle{}bold\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax1.legend()}
\NormalTok{    ax1.spines[}\StringTok{\textquotesingle{}top\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
\NormalTok{    ax1.spines[}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
    
    \CommentTok{\# QQ plot}
\NormalTok{    (osm, osr), (slope, intercept, r) }\OperatorTok{=}\NormalTok{ stats.probplot(data, dist}\OperatorTok{=}\StringTok{\textquotesingle{}norm\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.scatter(osm, osr, alpha}\OperatorTok{=}\FloatTok{0.4}\NormalTok{, s}\OperatorTok{=}\DecValTok{10}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}\#2166AC\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.plot(osm, slope}\OperatorTok{*}\NormalTok{np.array(osm)}\OperatorTok{+}\NormalTok{intercept, }\StringTok{\textquotesingle{}r{-}{-}\textquotesingle{}}\NormalTok{, lw}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{    ax2.set\_xlabel(}\StringTok{\textquotesingle{}Theoretical Quantiles\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.set\_ylabel(}\StringTok{\textquotesingle{}Sample Quantiles\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.set\_title(}\StringTok{\textquotesingle{}Q{-}Q Plot (Normal)\textquotesingle{}}\NormalTok{, fontweight}\OperatorTok{=}\StringTok{\textquotesingle{}bold\textquotesingle{}}\NormalTok{)}
\NormalTok{    ax2.spines[}\StringTok{\textquotesingle{}top\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
\NormalTok{    ax2.spines[}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{].set\_visible(}\VariableTok{False}\NormalTok{)}
    
\NormalTok{    plt.tight\_layout()}
    \ControlFlowTok{return}\NormalTok{ fig}
\end{Highlighting}
\end{Shaded}

\subsection{The Master Pipeline}\label{the-master-pipeline}

Combine all components into one function:

\phantomsection\label{master}
\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ run\_event\_study(events, prices, factors, config,}
\NormalTok{                    id\_col}\OperatorTok{=}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, date\_col}\OperatorTok{=}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, ret\_col}\OperatorTok{=}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{,}
\NormalTok{                    event\_date\_col}\OperatorTok{=}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{, mkt\_col}\OperatorTok{=}\StringTok{\textquotesingle{}mkt\_excess\textquotesingle{}}\NormalTok{,}
\NormalTok{                    rf\_col}\OperatorTok{=}\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{, group\_col}\OperatorTok{=}\VariableTok{None}\NormalTok{, verbose}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
    \CommentTok{"""Run a complete event study from raw inputs to test statistics.}
\CommentTok{    }
\CommentTok{    This is the main entry point. Provide your events, price data,}
\CommentTok{    factor data, and configurationget back everything you need.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    events : pd.DataFrame}
\CommentTok{        Columns: [id\_col, event\_date\_col], optional \textquotesingle{}group\textquotesingle{}.}
\CommentTok{    prices : pd.DataFrame}
\CommentTok{        Daily returns: [id\_col, date\_col, ret\_col or \textquotesingle{}ret\_excess\textquotesingle{}, rf\_col].}
\CommentTok{    factors : pd.DataFrame}
\CommentTok{        Factor returns: [date\_col, mkt\_col, \textquotesingle{}smb\textquotesingle{}, \textquotesingle{}hml\textquotesingle{}, ...].}
\CommentTok{    config : EventStudyConfig}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    dict with keys: \textquotesingle{}config\textquotesingle{}, \textquotesingle{}daily\_ar\textquotesingle{}, \textquotesingle{}event\_ar\textquotesingle{}, \textquotesingle{}daily\_stats\textquotesingle{},}
\CommentTok{        \textquotesingle{}test\_stats\textquotesingle{}, \textquotesingle{}params\textquotesingle{}}
\CommentTok{    """}
\NormalTok{    config.validate()}
    
    \ControlFlowTok{if}\NormalTok{ verbose:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f" Event Study: }\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{risk\_model}\SpecialCharTok{.}\NormalTok{value}\SpecialCharTok{\}}\SpecialStringTok{ model "}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Windows: estimation=}\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{estimation\_window}\SpecialCharTok{\}}\SpecialStringTok{, "}
              \SpecialStringTok{f"gap=}\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{gap}\SpecialCharTok{\}}\SpecialStringTok{, event=(}\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{event\_window\_start}\SpecialCharTok{\}}\SpecialStringTok{,}\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{event\_window\_end}\SpecialCharTok{\}}\SpecialStringTok{)"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Min obs: }\SpecialCharTok{\{}\NormalTok{config}\SpecialCharTok{.}\NormalTok{min\_estimation\_obs}\SpecialCharTok{\}}\CharTok{\textbackslash{}n}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 1. Trading calendar}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 1: Building trading calendar..."}\NormalTok{)}
\NormalTok{    trading\_dates }\OperatorTok{=}\NormalTok{ pd.Series(}\BuiltInTok{sorted}\NormalTok{(prices[date\_col].unique()))}
\NormalTok{    calendar }\OperatorTok{=}\NormalTok{ build\_trading\_calendar(trading\_dates, config)}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(calendar)}\SpecialCharTok{\}}\SpecialStringTok{ potential event dates}\CharTok{\textbackslash{}n}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 2. Align events}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 2: Aligning events to trading calendar..."}\NormalTok{)}
\NormalTok{    aligned }\OperatorTok{=}\NormalTok{ align\_events(events, calendar, id\_col, event\_date\_col)}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(aligned)}\SpecialCharTok{\}}\SpecialStringTok{ aligned events}\CharTok{\textbackslash{}n}\SpecialStringTok{"}\NormalTok{)}
    
    \CommentTok{\# 3. Extract returns}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 3: Extracting returns and merging factors..."}\NormalTok{)}
\NormalTok{    evt\_rets }\OperatorTok{=}\NormalTok{ extract\_returns(aligned, prices, factors, config,}
\NormalTok{                               id\_col, date\_col, ret\_col, mkt\_col, rf\_col)}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{()}
    
    \CommentTok{\# 4. Estimate model}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 4: Estimating risk model parameters..."}\NormalTok{)}
\NormalTok{    params }\OperatorTok{=}\NormalTok{ estimate\_model(evt\_rets, config, id\_col, date\_col, ret\_col)}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{()}
    
    \CommentTok{\# 5. Compute abnormal returns}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 5: Computing abnormal returns..."}\NormalTok{)}
\NormalTok{    daily\_ar, event\_ar }\OperatorTok{=}\NormalTok{ compute\_abnormal\_returns(}
\NormalTok{        evt\_rets, params, config, id\_col, date\_col, ret\_col)}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{()}
    
    \CommentTok{\# 6. Test statistics}
    \ControlFlowTok{if}\NormalTok{ verbose: }\BuiltInTok{print}\NormalTok{(}\StringTok{"Step 6: Computing test statistics..."}\NormalTok{)}
\NormalTok{    test\_stats }\OperatorTok{=}\NormalTok{ compute\_test\_statistics(event\_ar, params, group\_col)}
\NormalTok{    daily\_stats }\OperatorTok{=}\NormalTok{ compute\_daily\_stats(daily\_ar, id\_col)}
    \ControlFlowTok{if}\NormalTok{ verbose:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Done.}\CharTok{\textbackslash{}n}\SpecialStringTok{"}\NormalTok{)}
        \BuiltInTok{print}\NormalTok{(}\StringTok{" Results Summary "}\NormalTok{)}
\NormalTok{        cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{]}
\NormalTok{        avail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ test\_stats.columns]}
        \BuiltInTok{print}\NormalTok{(test\_stats[avail].to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
    
    \ControlFlowTok{return}\NormalTok{ \{}
        \StringTok{\textquotesingle{}config\textquotesingle{}}\NormalTok{: config,}
        \StringTok{\textquotesingle{}params\textquotesingle{}}\NormalTok{: params,}
        \StringTok{\textquotesingle{}daily\_ar\textquotesingle{}}\NormalTok{: daily\_ar,}
        \StringTok{\textquotesingle{}event\_ar\textquotesingle{}}\NormalTok{: event\_ar,}
        \StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{: daily\_stats,}
        \StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{: test\_stats,}
        \StringTok{\textquotesingle{}calendar\textquotesingle{}}\NormalTok{: calendar,}
\NormalTok{    \}}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Master pipeline ready."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Master pipeline ready.
\end{verbatim}

\section{Demonstration with Simulated
Data}\label{demonstration-with-simulated-data}

Since we are building a general-purpose framework (the actual event data
will be supplied later), we demonstrate the full pipeline with
\textbf{realistic simulated data} that mirrors the Vietnamese market
structure.

\phantomsection\label{simulation}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{2024}\NormalTok{)}

\CommentTok{\# {-}{-}{-} Simulated trading calendar (Vietnamese market: \textasciitilde{}245 days/year) {-}{-}{-}}
\NormalTok{dates }\OperatorTok{=}\NormalTok{ pd.bdate\_range(}\StringTok{\textquotesingle{}2019{-}01{-}01\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2023{-}12{-}31\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{)}
\CommentTok{\# Remove Tet + national holidays (simplified)}
\NormalTok{tet\_holidays }\OperatorTok{=}\NormalTok{ pd.to\_datetime([}
    \StringTok{\textquotesingle{}2019{-}02{-}04\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2019{-}02{-}05\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2019{-}02{-}06\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2019{-}02{-}07\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2019{-}02{-}08\textquotesingle{}}\NormalTok{,}
    \StringTok{\textquotesingle{}2020{-}01{-}23\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2020{-}01{-}24\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2020{-}01{-}27\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2020{-}01{-}28\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2020{-}01{-}29\textquotesingle{}}\NormalTok{,}
    \StringTok{\textquotesingle{}2021{-}02{-}10\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2021{-}02{-}11\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2021{-}02{-}12\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2021{-}02{-}15\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2021{-}02{-}16\textquotesingle{}}\NormalTok{,}
    \StringTok{\textquotesingle{}2022{-}01{-}31\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2022{-}02{-}01\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2022{-}02{-}02\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2022{-}02{-}03\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2022{-}02{-}04\textquotesingle{}}\NormalTok{,}
    \StringTok{\textquotesingle{}2023{-}01{-}20\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2023{-}01{-}23\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2023{-}01{-}24\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2023{-}01{-}25\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}2023{-}01{-}26\textquotesingle{}}\NormalTok{,}
\NormalTok{])}
\NormalTok{dates }\OperatorTok{=}\NormalTok{ dates.difference(tet\_holidays)}
\NormalTok{T }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(dates)}

\CommentTok{\# {-}{-}{-} Simulated factors (realistic Vietnamese market parameters) {-}{-}{-}}
\NormalTok{rf\_daily }\OperatorTok{=} \FloatTok{0.04} \OperatorTok{/} \DecValTok{252}  \CommentTok{\# \textasciitilde{}4\% annual risk{-}free}
\NormalTok{mkt\_excess }\OperatorTok{=}\NormalTok{ np.random.normal(}\FloatTok{0.0003}\NormalTok{, }\FloatTok{0.012}\NormalTok{, T)  }\CommentTok{\# \textasciitilde{}7.5\% annual, \textasciitilde{}19\% vol}
\NormalTok{smb }\OperatorTok{=}\NormalTok{ np.random.normal(}\FloatTok{0.0001}\NormalTok{, }\FloatTok{0.006}\NormalTok{, T)}
\NormalTok{hml }\OperatorTok{=}\NormalTok{ np.random.normal(}\FloatTok{0.0001}\NormalTok{, }\FloatTok{0.005}\NormalTok{, T)}
\NormalTok{rmw }\OperatorTok{=}\NormalTok{ np.random.normal(}\FloatTok{0.00005}\NormalTok{, }\FloatTok{0.004}\NormalTok{, T)}
\NormalTok{cma }\OperatorTok{=}\NormalTok{ np.random.normal(}\FloatTok{0.00005}\NormalTok{, }\FloatTok{0.004}\NormalTok{, T)}

\NormalTok{factors\_sim }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{: dates, }\StringTok{\textquotesingle{}mkt\_excess\textquotesingle{}}\NormalTok{: mkt\_excess, }\StringTok{\textquotesingle{}smb\textquotesingle{}}\NormalTok{: smb, }\StringTok{\textquotesingle{}hml\textquotesingle{}}\NormalTok{: hml,}
    \StringTok{\textquotesingle{}rmw\textquotesingle{}}\NormalTok{: rmw, }\StringTok{\textquotesingle{}cma\textquotesingle{}}\NormalTok{: cma, }\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{: rf\_daily}
\NormalTok{\})}

\CommentTok{\# {-}{-}{-} 100 simulated stocks {-}{-}{-}}
\NormalTok{n\_stocks }\OperatorTok{=} \DecValTok{100}
\NormalTok{symbols }\OperatorTok{=}\NormalTok{ [}\SpecialStringTok{f\textquotesingle{}SIM}\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{:03d\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(n\_stocks)]}
\NormalTok{betas }\OperatorTok{=}\NormalTok{ np.random.uniform(}\FloatTok{0.5}\NormalTok{, }\FloatTok{1.5}\NormalTok{, n\_stocks)}
\NormalTok{alphas }\OperatorTok{=}\NormalTok{ np.random.normal(}\DecValTok{0}\NormalTok{, }\FloatTok{0.0002}\NormalTok{, n\_stocks)}
\NormalTok{idio\_vols }\OperatorTok{=}\NormalTok{ np.random.uniform(}\FloatTok{0.015}\NormalTok{, }\FloatTok{0.035}\NormalTok{, n\_stocks)}

\NormalTok{price\_rows }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i, sym }\KeywordTok{in} \BuiltInTok{enumerate}\NormalTok{(symbols):}
\NormalTok{    eps }\OperatorTok{=}\NormalTok{ np.random.normal(}\DecValTok{0}\NormalTok{, idio\_vols[i], T)}
\NormalTok{    rets }\OperatorTok{=}\NormalTok{ alphas[i] }\OperatorTok{+}\NormalTok{ betas[i] }\OperatorTok{*}\NormalTok{ mkt\_excess }\OperatorTok{+} \FloatTok{0.3}\OperatorTok{*}\NormalTok{smb }\OperatorTok{+} \FloatTok{0.2}\OperatorTok{*}\NormalTok{hml }\OperatorTok{+}\NormalTok{ eps}
    \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(T):}
\NormalTok{        price\_rows.append(\{}
            \StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{: sym, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{: dates[j], }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{: rets[j],}
            \StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{: rets[j] }\OperatorTok{{-}}\NormalTok{ rf\_daily,}
            \StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{: rf\_daily,}
            \StringTok{\textquotesingle{}mktcap\textquotesingle{}}\NormalTok{: np.random.uniform(}\DecValTok{100}\NormalTok{, }\DecValTok{5000}\NormalTok{),}
\NormalTok{        \})}

\NormalTok{prices\_sim }\OperatorTok{=}\NormalTok{ pd.DataFrame(price\_rows)}

\CommentTok{\# {-}{-}{-} Simulated events: 50 random firm{-}dates with KNOWN positive AR {-}{-}{-}}
\NormalTok{event\_indices }\OperatorTok{=}\NormalTok{ np.random.choice(}\BuiltInTok{range}\NormalTok{(}\DecValTok{250}\NormalTok{, T}\OperatorTok{{-}}\DecValTok{50}\NormalTok{), }\DecValTok{50}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{event\_firms }\OperatorTok{=}\NormalTok{ np.random.choice(symbols, }\DecValTok{50}\NormalTok{, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{event\_dates\_sim }\OperatorTok{=}\NormalTok{ [dates[i] }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ event\_indices]}

\CommentTok{\# Inject abnormal returns on event date (2\% positive shock)}
\ControlFlowTok{for}\NormalTok{ firm, edate }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(event\_firms, event\_dates\_sim):}
\NormalTok{    mask }\OperatorTok{=}\NormalTok{ (prices\_sim[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ firm) }\OperatorTok{\&}\NormalTok{ (prices\_sim[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{] }\OperatorTok{==}\NormalTok{ edate)}
\NormalTok{    prices\_sim.loc[mask, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{] }\OperatorTok{+=} \FloatTok{0.02}
\NormalTok{    prices\_sim.loc[mask, }\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{+=} \FloatTok{0.02}

\NormalTok{events\_sim }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{: event\_firms,}
    \StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{: event\_dates\_sim,}
    \StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{: np.random.choice([}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], }\DecValTok{50}\NormalTok{)}
\NormalTok{\})}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Simulated data: }\SpecialCharTok{\{}\NormalTok{n\_stocks}\SpecialCharTok{\}}\SpecialStringTok{ stocks  }\SpecialCharTok{\{}\NormalTok{T}\SpecialCharTok{\}}\SpecialStringTok{ days = }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(prices\_sim)}\SpecialCharTok{:,\}}\SpecialStringTok{ obs"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Events: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(events\_sim)}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}event pairs"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Injected abnormal return: +2\% on event date"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Simulated data: 100 stocks  1279 days = 127,900 obs
Events: 50 firm-event pairs
Injected abnormal return: +2% on event date
\end{verbatim}

\subsection{Running the Full Pipeline}\label{running-the-full-pipeline}

\phantomsection\label{run-pipeline}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{config }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{,}
\NormalTok{    event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{,}
\NormalTok{    event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{15}\NormalTok{,}
\NormalTok{    min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{,}
\NormalTok{    risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{)}

\NormalTok{results }\OperatorTok{=}\NormalTok{ run\_event\_study(}
\NormalTok{    events}\OperatorTok{=}\NormalTok{events\_sim,}
\NormalTok{    prices}\OperatorTok{=}\NormalTok{prices\_sim,}
\NormalTok{    factors}\OperatorTok{=}\NormalTok{factors\_sim,}
\NormalTok{    config}\OperatorTok{=}\NormalTok{config,}
\NormalTok{    group\_col}\OperatorTok{=}\StringTok{\textquotesingle{}group\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 Event Study: ff3 model 
  Windows: estimation=150, gap=15, event=(-10,10)
  Min obs: 120

Step 1: Building trading calendar...
  1094 potential event dates

Step 2: Aligning events to trading calendar...
  50 aligned events

Step 3: Extracting returns and merging factors...
  Extracted 9,300 obs for 50 firm-events

Step 4: Estimating risk model parameters...
  Estimated 50/50 firm-events (mean R = 0.2368)

Step 5: Computing abnormal returns...
  50 firm-events | Mean CAR: 0.033009 | Mean BHAR: 0.032498 | % positive: 60.0%

Step 6: Computing test statistics...
  Done.

 Results Summary 
group  N  mean_CAR  mean_BHAR  pct_positive     t_CS     p_CS    t_BMP    p_BMP     t_KP     p_KP
  All 50  0.033009   0.032498      0.600000 2.288362 0.026468 2.157106 0.035929 2.161291 0.035587
    1 20  0.030704   0.028326      0.650000 1.568676 0.133227 1.248382 0.227056 1.249320 0.226720
    2 30  0.034545   0.035280      0.566667 1.688848 0.101975 1.734699 0.093413 1.736689 0.093055
\end{verbatim}

\subsection{Visualizing Results}\label{visualizing-results}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig1 }\OperatorTok{=}\NormalTok{ plot\_event\_study(}
\NormalTok{    results[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{],}
\NormalTok{    title}\OperatorTok{=}\StringTok{"Event Study: FF3 Model  Simulated Vietnamese Market"}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{18_event_studies_files/figure-pdf/fig-car-dynamics-output-1.pdf}}

}

\caption{\label{fig-car-dynamics}Dynamics of cumulative abnormal returns
(CARs) and buy-and-hold abnormal returns (BHARs) around the event date.
The positive jump at t=0 reflects the injected 2\% abnormal return.}

\end{figure}%

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig2 }\OperatorTok{=}\NormalTok{ plot\_car\_distribution(results[}\StringTok{\textquotesingle{}event\_ar\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{18_event_studies_files/figure-pdf/fig-car-distribution-output-1.pdf}}

}

\caption{\label{fig-car-distribution}Cross-sectional distribution of
cumulative abnormal returns. The rightward shift from zero and positive
skewness are consistent with the injected positive event effect.}

\end{figure}%

\subsection{Complete Test Statistics}\label{complete-test-statistics}

\begin{table}

\caption{\label{tbl-test-results}Event study test statistics for the
full sample and by subgroup}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Format for display}
\NormalTok{ts }\OperatorTok{=}\NormalTok{ results[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{].copy()}

\CommentTok{\# Select key columns}
\NormalTok{display\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Z\_Patell\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Z\_GSign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_SkAdj\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_SkAdj\textquotesingle{}}\NormalTok{]}
\NormalTok{avail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ display\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ts.columns]}
\NormalTok{display\_df }\OperatorTok{=}\NormalTok{ ts[avail].copy()}

\CommentTok{\# Format}
\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ display\_df.columns:}
    \ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{]:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].astype(}\BuiltInTok{int}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c.startswith(}\StringTok{\textquotesingle{}p\_\textquotesingle{}}\NormalTok{):}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4\%\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c }\OperatorTok{==} \StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.1\%\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif} \BuiltInTok{isinstance}\NormalTok{(display\_df[c].iloc[}\DecValTok{0}\NormalTok{], (}\BuiltInTok{int}\NormalTok{, }\BuiltInTok{float}\NormalTok{, np.floating)):}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.3f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(display\_df.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
group  N mean_CAR mean_BHAR pct_positive  t_CS   p_CS Z_Patell p_Patell t_BMP  p_BMP  t_KP   p_KP Z_GSign p_GSign t_SkAdj p_SkAdj
  All 50  3.3009%   3.2498%        60.0% 2.288 0.0265    1.832   0.0669 2.157 0.0359 2.161 0.0356   1.414  0.1573   2.074  0.0434
    1 20  3.0704%   2.8326%        65.0% 1.569 0.1332    1.020   0.3075 1.248 0.2271 1.249 0.2267   1.342  0.1797   1.103  0.2836
    2 30  3.4545%   3.5280%        56.7% 1.689 0.1020    1.532   0.1255 1.735 0.0934 1.737 0.0931   0.730  0.4652   1.727  0.0949
\end{verbatim}

}

\end{table}%

\subsection{Running Multiple Models for
Robustness}\label{running-multiple-models-for-robustness}

A key best practice is to report results across multiple risk models. If
conclusions are robust across models, this strengthens the findings:

\phantomsection\label{multi-model}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{models\_to\_run }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    (}\StringTok{"Market{-}Adjusted"}\NormalTok{, RiskModel.MARKET\_ADJ),}
\NormalTok{    (}\StringTok{"Market Model"}\NormalTok{, RiskModel.MARKET\_MODEL),}
\NormalTok{    (}\StringTok{"Fama{-}French 3"}\NormalTok{, RiskModel.FF3),}
\NormalTok{    (}\StringTok{"Fama{-}French 5"}\NormalTok{, RiskModel.FF5),}
\NormalTok{]}

\NormalTok{robustness }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ name, mdl }\KeywordTok{in}\NormalTok{ models\_to\_run:}
\NormalTok{    cfg }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{        estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{, event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{, event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{        gap}\OperatorTok{=}\DecValTok{15}\NormalTok{, min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{, risk\_model}\OperatorTok{=}\NormalTok{mdl}
\NormalTok{    )}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ run\_event\_study(events\_sim, prices\_sim, factors\_sim, cfg, verbose}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ res[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{]}
\NormalTok{    full }\OperatorTok{=}\NormalTok{ ts[ts[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}All\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{    robustness.append(\{}
        \StringTok{\textquotesingle{}Model\textquotesingle{}}\NormalTok{: name,}
        \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{int}\NormalTok{(full[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{]),}
        \StringTok{\textquotesingle{}Mean CAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}Mean BHAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}\% Positive\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (CS)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.2f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (BMP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.2f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (KP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full}\SpecialCharTok{.}\NormalTok{get(}\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{, np.nan)}\SpecialCharTok{:.2f\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{    \})}

\NormalTok{rob\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(robustness)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Robustness Across Risk Models:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(rob\_df.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Extracted 9,300 obs for 50 firm-events
  Estimated 50/50 firm-events (mean R = 0.0000)
  50 firm-events | Mean CAR: 0.029672 | Mean BHAR: 0.026468 | % positive: 62.0%
  Extracted 9,300 obs for 50 firm-events
  Estimated 50/50 firm-events (mean R = 0.2198)
  50 firm-events | Mean CAR: 0.033785 | Mean BHAR: 0.029974 | % positive: 62.0%
  Extracted 9,300 obs for 50 firm-events
  Estimated 50/50 firm-events (mean R = 0.2368)
  50 firm-events | Mean CAR: 0.033009 | Mean BHAR: 0.032498 | % positive: 60.0%
  Extracted 9,300 obs for 50 firm-events
  Estimated 50/50 firm-events (mean R = 0.2516)
  50 firm-events | Mean CAR: 0.036479 | Mean BHAR: 0.036000 | % positive: 64.0%
Robustness Across Risk Models:
          Model  N Mean CAR Mean BHAR % Positive t (CS) t (BMP) t (KP)
Market-Adjusted 50  2.9672%   2.6468%      62.0%   2.12    2.03   2.01
   Market Model 50  3.3785%   2.9974%      62.0%   2.37    2.26   2.28
  Fama-French 3 50  3.3009%   3.2498%      60.0%   2.29    2.16   2.16
  Fama-French 5 50  3.6479%   3.6000%      64.0%   2.51    2.36   2.41
\end{verbatim}

\section{How to Use This Framework with Your Data}\label{sec-usage}

\subsection{Required Data Format}\label{required-data-format}

To run the event study on real Vietnamese market data, prepare three
inputs:

\textbf{1. Stock Returns} (\texttt{prices} DataFrame):

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
Column & Description & Example \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\texttt{symbol} & Stock ticker &
\texttt{\textquotesingle{}VNM\textquotesingle{}} \\
\texttt{date} & Trading date & \texttt{2023-06-15} \\
\texttt{ret} or \texttt{ret\_excess} & Daily return (decimal) &
\texttt{0.0123} \\
\texttt{risk\_free} & Daily risk-free rate & \texttt{0.000159} \\
\end{longtable}

\textbf{2. Factor Returns} (\texttt{factors} DataFrame):

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
Column & Description \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\texttt{date} & Trading date \\
\texttt{mkt\_excess} & Market excess return \\
\texttt{smb} & Size factor (FF3/FF5) \\
\texttt{hml} & Value factor (FF3/FF5) \\
\texttt{rmw} & Profitability factor (FF5) \\
\texttt{cma} & Investment factor (FF5) \\
\texttt{risk\_free} & Risk-free rate \\
\end{longtable}

\textbf{3. Event File} (\texttt{events} DataFrame):

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
Column & Description & Example \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\texttt{symbol} & Stock ticker &
\texttt{\textquotesingle{}VNM\textquotesingle{}} \\
\texttt{event\_date} & Event date & \texttt{2023-03-15} \\
\texttt{group} & (Optional) subgroup & \texttt{1} \\
\end{longtable}

\subsection{Minimal Usage Example}\label{minimal-usage-example}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Load your data}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}prices\_daily.csv\textquotesingle{}}\NormalTok{, parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{factors }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}factors\_ff3\_daily.csv\textquotesingle{}}\NormalTok{, parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{])}
\NormalTok{events }\OperatorTok{=}\NormalTok{ pd.read\_csv(}\StringTok{\textquotesingle{}my\_events.csv\textquotesingle{}}\NormalTok{, parse\_dates}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{])}

\CommentTok{\# Configure}
\NormalTok{config }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{,}
\NormalTok{    event\_window\_start}\OperatorTok{={-}}\DecValTok{5}\NormalTok{,}
\NormalTok{    event\_window\_end}\OperatorTok{=}\DecValTok{5}\NormalTok{,}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{15}\NormalTok{,}
\NormalTok{    min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{,}
\NormalTok{    risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{)}

\CommentTok{\# Run}
\NormalTok{results }\OperatorTok{=}\NormalTok{ run\_event\_study(events, prices, factors, config)}

\CommentTok{\# Access outputs}
\NormalTok{results[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{]    }\CommentTok{\# Test statistics}
\NormalTok{results[}\StringTok{\textquotesingle{}event\_ar\textquotesingle{}}\NormalTok{]      }\CommentTok{\# Firm{-}level CARs/BHARs}
\NormalTok{results[}\StringTok{\textquotesingle{}daily\_ar\textquotesingle{}}\NormalTok{]      }\CommentTok{\# Daily abnormal returns}
\NormalTok{results[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{]   }\CommentTok{\# Event{-}time aggregates}

\CommentTok{\# Plot}
\NormalTok{plot\_event\_study(results[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{], title}\OperatorTok{=}\StringTok{"My Event Study"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\section{Practical Recommendations}\label{practical-recommendations}

Based on the literature and our implementation experience:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\item
  \textbf{Estimation window}: Use 150 trading days (\textasciitilde7
  months) for daily studies. This balances parameter precision against
  structural breaks. For monthly studies, 60 months is standard (Kothari
  and Warner 2007).
\item
  \textbf{Gap}: 15 trading days is standard. Increase to 30 if
  information leakage is a concern.
\item
  \textbf{Event window}: Start with (-1, +1) for short-window tests,
  then expand to (-5, +5) and (-10, +10) for robustness. Report all
  windows.
\item
  \textbf{Model choice}: Always report market model as the baseline. Add
  FF3 or FF5 for robustness. For Vietnam, local factors are preferable
  to global factors.
\item
  \textbf{Test statistics}: Report at minimum: cross-sectional t (for
  ease of interpretation), BMP (robust to event-induced variance), and
  one non-parametric test (sign or Wilcoxon). Report Kolari-Pynnnen if
  events cluster in calendar time.
\item
  \textbf{Thin trading}: For Vietnamese small-caps, consider Dimson
  (1979) with 1 lead/lag or increase \texttt{min\_estimation\_obs} to
  filter out illiquid stocks.
\item
  \textbf{Multiple testing}: If testing multiple event windows or
  subgroups, apply Bonferroni or Holm corrections to control family-wise
  error rate.
\end{enumerate}

\section{Demonstration with Vietnamese Market
Data}\label{demonstration-with-vietnamese-market-data}

We now demonstrate the full event study pipeline using actual Vietnamese
stock market data. The datasets available are:

\begin{itemize}
\tightlist
\item
  \texttt{prices\_daily} --- 3.46 million rows: \texttt{symbol},
  \texttt{date}, \texttt{ret\_excess}, \texttt{mktcap},
  \texttt{mktcap\_lag}, \texttt{risk\_free}
\item
  \texttt{prices\_monthly} --- 165,000 rows: same structure
\item
  \texttt{factors\_ff3\_daily} --- 3,126 rows: \texttt{date},
  \texttt{smb}, \texttt{hml}, \texttt{mkt\_excess}, \texttt{risk\_free}
\item
  \texttt{factors\_ff3\_monthly} --- monthly frequency version
\item
  \texttt{factors\_ff5\_daily} --- 3,126 rows: \texttt{date},
  \texttt{smb}, \texttt{hml}, \texttt{mkt\_excess}, \texttt{risk\_free},
  \texttt{rmw}, \texttt{cma}
\item
  \texttt{factors\_ff5\_monthly} --- 150 rows
\end{itemize}

Since our data provides \texttt{ret\_excess} rather than raw returns, we
recover raw returns as \(R_{it} = R^e_{it} + R_{f,t}\), and the market
return as \(R_{m,t} = R^e_{m,t} + R_{f,t}\). The
\texttt{extract\_event\_returns()} function handles this automatically.

\subsection{Loading the Data}\label{loading-the-data}

\phantomsection\label{load-data}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# {-}{-}{-} Recover raw returns {-}{-}{-}}
\CommentTok{\# ret = ret\_excess + risk\_free}
\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices\_daily[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ prices\_daily[}\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{]}
\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ prices\_monthly[}\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ prices\_monthly[}\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{]}

\CommentTok{\# {-}{-}{-} Inspect the data {-}{-}{-}}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{70}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"VIETNAMESE MARKET DATA SUMMARY"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{70}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{prices\_daily: }\SpecialCharTok{\{}\NormalTok{prices\_daily}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,\}}\SpecialStringTok{ rows, "}
      \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{\}}\SpecialStringTok{ stocks, "}
      \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{prices\_daily[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"prices\_monthly: }\SpecialCharTok{\{}\NormalTok{prices\_monthly}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,\}}\SpecialStringTok{ rows, "}
      \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{prices\_monthly[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{\}}\SpecialStringTok{ stocks"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{factors\_ff3\_daily: }\SpecialCharTok{\{}\NormalTok{factors\_ff3\_daily}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,\}}\SpecialStringTok{ trading days"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Columns: }\SpecialCharTok{\{}\BuiltInTok{list}\NormalTok{(factors\_ff3\_daily.columns)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"factors\_ff5\_daily: }\SpecialCharTok{\{}\NormalTok{factors\_ff5\_daily}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,\}}\SpecialStringTok{ trading days"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"  Columns: }\SpecialCharTok{\{}\BuiltInTok{list}\NormalTok{(factors\_ff5\_daily.columns)}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Sample daily returns:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(prices\_daily[[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\_excess\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}ret\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}risk\_free\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mktcap\textquotesingle{}}\NormalTok{]]}
\NormalTok{      .head(}\DecValTok{5}\NormalTok{).to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Sample daily factors:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(factors\_ff3\_daily.head(}\DecValTok{5}\NormalTok{).to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
======================================================================
VIETNAMESE MARKET DATA SUMMARY
======================================================================

prices_daily: 3,462,157 rows, 1459 stocks, 2010-01-05 to 2023-12-29
prices_monthly: 165,499 rows, 1457 stocks

factors_ff3_daily: 3,126 trading days
  Columns: ['date', 'smb', 'hml', 'mkt_excess', 'risk_free']
factors_ff5_daily: 3,126 trading days
  Columns: ['date', 'smb', 'hml', 'rmw', 'cma', 'mkt_excess', 'risk_free']

Sample daily returns:
symbol       date  ret_excess      ret  risk_free     mktcap
   A32 2018-10-24   -0.000159 0.000000   0.000159 176.120000
   A32 2018-10-25   -0.000159 0.000000   0.000159 176.120000
   A32 2018-10-26   -0.000159 0.000000   0.000159 176.120000
   A32 2018-10-29   -0.000159 0.000000   0.000159 176.120000
   A32 2018-10-30   -0.000159 0.000000   0.000159 176.120000

Sample daily factors:
      date       smb       hml  mkt_excess  risk_free
2011-07-01  0.008587  0.000967   -0.019862   0.000159
2011-07-04  0.005099 -0.001099   -0.000633   0.000159
2011-07-05 -0.009088  0.010152    0.013314   0.000159
2011-07-06  0.004875 -0.003918   -0.008045   0.000159
2011-07-07 -0.011239 -0.000584    0.003391   0.000159
\end{verbatim}

\subsection{Creating Sample Events}\label{creating-sample-events}

For this demonstration, we create a sample event file. In practice,
events would come from corporate announcements (earnings, M\&A,
dividends), regulatory changes, or other information shocks. Here we
select 50 large-cap Vietnamese stocks and assign random event dates from
the most recent two years of data to illustrate the pipeline mechanics.

\phantomsection\label{create-events}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{2024}\NormalTok{)}

\CommentTok{\# Select the 50 largest stocks by median market cap}
\NormalTok{largest }\OperatorTok{=}\NormalTok{ (prices\_daily.groupby(}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}mktcap\textquotesingle{}}\NormalTok{]}
\NormalTok{           .median()}
\NormalTok{           .nlargest(}\DecValTok{50}\NormalTok{)}
\NormalTok{           .index.tolist())}

\CommentTok{\# Date range for events: last 2 years of data, with buffer for windows}
\NormalTok{date\_range }\OperatorTok{=}\NormalTok{ prices\_daily[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{].sort\_values().unique()}
\NormalTok{n\_dates }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(date\_range)}
\CommentTok{\# Events from the middle portion (need room for estimation + event windows)}
\NormalTok{event\_eligible }\OperatorTok{=}\NormalTok{ date\_range[}\BuiltInTok{int}\NormalTok{(n\_dates }\OperatorTok{*} \FloatTok{0.3}\NormalTok{):}\BuiltInTok{int}\NormalTok{(n\_dates }\OperatorTok{*} \FloatTok{0.85}\NormalTok{)]}

\CommentTok{\# Generate 50 random firm{-}event pairs}
\NormalTok{event\_firms }\OperatorTok{=}\NormalTok{ np.random.choice(largest, }\DecValTok{50}\NormalTok{, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{event\_dates }\OperatorTok{=}\NormalTok{ np.random.choice(event\_eligible, }\DecValTok{50}\NormalTok{, replace}\OperatorTok{=}\VariableTok{False}\NormalTok{)}

\NormalTok{events\_demo }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{: event\_firms,}
    \StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{: pd.to\_datetime(event\_dates),}
    \StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{: np.random.choice([}\StringTok{\textquotesingle{}Group\_A\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Group\_B\textquotesingle{}}\NormalTok{], }\DecValTok{50}\NormalTok{)}
\NormalTok{\})}

\CommentTok{\# Remove any duplicate firm{-}date pairs}
\NormalTok{events\_demo }\OperatorTok{=}\NormalTok{ events\_demo.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{])}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Sample event file: }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(events\_demo)}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}event observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Unique firms: }\SpecialCharTok{\{}\NormalTok{events\_demo[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{nunique()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Date range: }\SpecialCharTok{\{}\NormalTok{events\_demo[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{ to "}
      \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{events\_demo[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{.}\NormalTok{date()}\SpecialCharTok{\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Group distribution:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(events\_demo[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{].value\_counts().to\_string())}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{First 10 events:"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(events\_demo.sort\_values(}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{).head(}\DecValTok{10}\NormalTok{).to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sample event file: 50 firm-event observations
Unique firms: 35
Date range: 2014-06-25 to 2021-10-29

Group distribution:
group
Group_B    26
Group_A    24

First 10 events:
symbol event_date   group
   MCH 2014-06-25 Group_B
   SIP 2014-10-23 Group_B
   VRE 2014-11-14 Group_B
   QNS 2014-12-25 Group_A
   FOX 2015-01-16 Group_B
   THD 2015-01-26 Group_A
   QNS 2015-02-12 Group_A
   HNG 2015-05-07 Group_B
   MML 2015-08-17 Group_B
   ACV 2015-10-15 Group_A
\end{verbatim}

\subsection{Daily Event Study: Fama-French 3-Factor
Model}\label{daily-event-study-fama-french-3-factor-model}

\phantomsection\label{run-daily-ff3}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{config\_ff3 }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{,}
\NormalTok{    event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{,}
\NormalTok{    event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{15}\NormalTok{,}
\NormalTok{    min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{,}
\NormalTok{    risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{)}

\NormalTok{results\_ff3 }\OperatorTok{=}\NormalTok{ run\_event\_study(}
\NormalTok{    events}\OperatorTok{=}\NormalTok{events\_demo,}
\NormalTok{    prices}\OperatorTok{=}\NormalTok{prices\_daily,}
\NormalTok{    factors}\OperatorTok{=}\NormalTok{factors\_ff3\_daily,}
\NormalTok{    config}\OperatorTok{=}\NormalTok{config\_ff3,}
\NormalTok{    group\_col}\OperatorTok{=}\StringTok{\textquotesingle{}group\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 Event Study: ff3 model 
  Windows: estimation=150, gap=15, event=(-10,10)
  Min obs: 120

Step 1: Building trading calendar...
  3308 potential event dates

Step 2: Aligning events to trading calendar...
  50 aligned events

Step 3: Extracting returns and merging factors...
  Extracted 5,421 obs for 30 firm-events

Step 4: Estimating risk model parameters...
  Estimated 26/30 firm-events (mean R = 0.2245)

Step 5: Computing abnormal returns...
  26 firm-events | Mean CAR: 0.021513 | Mean BHAR: 0.024885 | % positive: 61.5%

Step 6: Computing test statistics...
  Done.

 Results Summary 
  group  N  mean_CAR  mean_BHAR  pct_positive     t_CS     p_CS    t_BMP    p_BMP     t_KP     p_KP
    All 26  0.021513   0.024885      0.615385 0.774999 0.445609 0.726797 0.474101 0.699973 0.490407
Group_A 13  0.008601   0.006783      0.538462 0.211606 0.835966 0.577574 0.574229 0.567041 0.581138
Group_B 13  0.034425   0.042987      0.692308 0.879892 0.396197 0.437902 0.669236 0.429917 0.674875
\end{verbatim}

\subsection{Visualizing Daily Results}\label{visualizing-daily-results}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig1 }\OperatorTok{=}\NormalTok{ plot\_event\_study(}
\NormalTok{    results\_ff3[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{],}
\NormalTok{    title}\OperatorTok{=}\StringTok{"Event Study: Fama{-}French 3{-}Factor Model  Vietnamese Market (Daily)"}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{18_event_studies_files/figure-pdf/fig-daily-car-output-1.pdf}}

}

\caption{\label{fig-daily-car}Cumulative abnormal returns around event
dates for Vietnamese stocks using the Fama-French 3-factor model. The
event window spans {[}-10, +10{]} trading days.}

\end{figure}%

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig2 }\OperatorTok{=}\NormalTok{ plot\_car\_distribution(results\_ff3[}\StringTok{\textquotesingle{}event\_ar\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{18_event_studies_files/figure-pdf/fig-daily-dist-output-1.pdf}}

}

\caption{\label{fig-daily-dist}Cross-sectional distribution of
cumulative abnormal returns (CARs) across firm-events. The histogram and
Q-Q plot assess normality assumptions underlying parametric tests.}

\end{figure}%

\subsection{Complete Test Statistics
(Daily)}\label{complete-test-statistics-daily}

\begin{table}

\caption{\label{tbl-daily-tests}Event study test statistics for the full
sample and by subgroup --- Daily frequency, FF3 model}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts }\OperatorTok{=}\NormalTok{ results\_ff3[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{].copy()}

\NormalTok{display\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Z\_Patell\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Z\_GSign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_SkAdj\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_SkAdj\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}W\_Wilcoxon\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_Wilcoxon\textquotesingle{}}\NormalTok{]}
\NormalTok{avail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ display\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ts.columns]}
\NormalTok{display\_df }\OperatorTok{=}\NormalTok{ ts[avail].copy()}

\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ display\_df.columns:}
    \ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{]:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].astype(}\BuiltInTok{int}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c }\OperatorTok{==} \StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{:}
        \ControlFlowTok{continue}
    \ControlFlowTok{elif}\NormalTok{ c.startswith(}\StringTok{\textquotesingle{}p\_\textquotesingle{}}\NormalTok{):}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4\%\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ c }\OperatorTok{==} \StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{:}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.1\%\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif} \BuiltInTok{isinstance}\NormalTok{(display\_df[c].iloc[}\DecValTok{0}\NormalTok{], (}\BuiltInTok{int}\NormalTok{, }\BuiltInTok{float}\NormalTok{, np.floating)):}
\NormalTok{        display\_df[c] }\OperatorTok{=}\NormalTok{ display\_df[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.3f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(display\_df.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  group  N mean_CAR median_CAR mean_BHAR pct_positive  t_CS   p_CS Z_Patell p_Patell t_BMP  p_BMP  t_KP   p_KP Z_GSign p_GSign t_SkAdj p_SkAdj W_Wilcoxon p_Wilcoxon
    All 26  2.1513%    1.5701%   2.4885%        61.5% 0.775 0.4456    0.961   0.3364 0.727 0.4741 0.700 0.4904   1.177  0.2393   0.738  0.4676    158.000     0.6710
Group_A 13  0.8601%    2.5330%   0.6783%        53.8% 0.212 0.8360    0.739   0.4596 0.578 0.5742 0.567 0.5811   0.277  0.7815   0.597  0.5618     45.000     1.0000
Group_B 13  3.4425%    1.4169%   4.2987%        69.2% 0.880 0.3962    0.620   0.5352 0.438 0.6692 0.430 0.6749   1.387  0.1655   0.444  0.6647     35.000     0.4973
\end{verbatim}

}

\end{table}%

\subsection{Robustness: Multiple Risk Models
(Daily)}\label{robustness-multiple-risk-models-daily}

\begin{table}

\caption{\label{tbl-robustness-daily}Robustness of event study results
across risk models --- Daily frequency}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{models\_daily }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    (}\StringTok{"Market{-}Adjusted"}\NormalTok{,  RiskModel.MARKET\_ADJ,    factors\_ff3\_daily),}
\NormalTok{    (}\StringTok{"Market Model"}\NormalTok{,     RiskModel.MARKET\_MODEL,   factors\_ff3\_daily),}
\NormalTok{    (}\StringTok{"Fama{-}French 3"}\NormalTok{,    RiskModel.FF3,            factors\_ff3\_daily),}
\NormalTok{    (}\StringTok{"Fama{-}French 5"}\NormalTok{,    RiskModel.FF5,            factors\_ff5\_daily),}
\NormalTok{]}

\NormalTok{robustness\_daily }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ name, mdl, facs }\KeywordTok{in}\NormalTok{ models\_daily:}
\NormalTok{    cfg }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{        estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{, event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{, event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{        gap}\OperatorTok{=}\DecValTok{15}\NormalTok{, min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{, risk\_model}\OperatorTok{=}\NormalTok{mdl}
\NormalTok{    )}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ run\_event\_study(events\_demo, prices\_daily, facs, cfg, verbose}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ res[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{]}
\NormalTok{    full }\OperatorTok{=}\NormalTok{ ts[ts[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}All\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{    robustness\_daily.append(\{}
        \StringTok{\textquotesingle{}Model\textquotesingle{}}\NormalTok{: name,}
        \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{int}\NormalTok{(full[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{]),}
        \StringTok{\textquotesingle{}Mean CAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}Median CAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}median\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}Mean BHAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}\% Positive\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (CS)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}p (CS)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (BMP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}p (BMP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (KP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full}\SpecialCharTok{.}\NormalTok{get(}\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{, np.nan)}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}p (KP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full}\SpecialCharTok{.}\NormalTok{get(}\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{, np.nan)}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{    \})}

\NormalTok{rob\_daily\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(robustness\_daily)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Robustness Across Risk Models (Daily Frequency)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{100}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(rob\_daily\_df.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Extracted 5,421 obs for 30 firm-events
  Estimated 28/30 firm-events (mean R = 0.0000)
  28 firm-events | Mean CAR: 0.035338 | Mean BHAR: 0.036936 | % positive: 50.0%
  Extracted 5,421 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.1960)
  26 firm-events | Mean CAR: 0.032107 | Mean BHAR: 0.033221 | % positive: 61.5%
  Extracted 5,421 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2245)
  26 firm-events | Mean CAR: 0.021513 | Mean BHAR: 0.024885 | % positive: 61.5%
  Extracted 5,421 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2675)
  26 firm-events | Mean CAR: 0.025684 | Mean BHAR: 0.028399 | % positive: 57.7%
Robustness Across Risk Models (Daily Frequency)
====================================================================================================
          Model  N Mean CAR Median CAR Mean BHAR % Positive t (CS) p (CS) t (BMP) p (BMP) t (KP) p (KP)
Market-Adjusted 28  3.5338%    0.2610%   3.6936%      50.0%  1.390 0.1758   1.103  0.2798  1.062 0.2975
   Market Model 26  3.2107%    0.6925%   3.3221%      61.5%  1.198 0.2422   1.146  0.2625  1.107 0.2789
  Fama-French 3 26  2.1513%    1.5701%   2.4885%      61.5%  0.775 0.4456   0.727  0.4741  0.700 0.4904
  Fama-French 5 26  2.5684%    2.3619%   2.8399%      57.7%  0.968 0.3422   0.987  0.3332  0.962 0.3451
\end{verbatim}

}

\end{table}%

\subsection{Robustness: Multiple Event
Windows}\label{robustness-multiple-event-windows}

A key practice is to examine sensitivity to the event window
specification:

\begin{table}

\caption{\label{tbl-robustness-windows}Sensitivity of results to event
window specification}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{windows }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    (}\StringTok{"({-}1, +1)"}\NormalTok{,  }\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{),}
\NormalTok{    (}\StringTok{"({-}3, +3)"}\NormalTok{,  }\OperatorTok{{-}}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{),}
\NormalTok{    (}\StringTok{"({-}5, +5)"}\NormalTok{,  }\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{),}
\NormalTok{    (}\StringTok{"({-}10, +10)"}\NormalTok{, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{, }\DecValTok{10}\NormalTok{),}
\NormalTok{    (}\StringTok{"({-}1, +5)"}\NormalTok{,  }\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{),}
\NormalTok{    (}\StringTok{"({-}5, +1)"}\NormalTok{,  }\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{),}
\NormalTok{    (}\StringTok{"(0, 0)"}\NormalTok{,     }\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{),}
\NormalTok{]}

\NormalTok{window\_results }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ label, ws, we }\KeywordTok{in}\NormalTok{ windows:}
\NormalTok{    cfg }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{        estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{, event\_window\_start}\OperatorTok{=}\NormalTok{ws, event\_window\_end}\OperatorTok{=}\NormalTok{we,}
\NormalTok{        gap}\OperatorTok{=}\DecValTok{15}\NormalTok{, min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{, risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{    )}
\NormalTok{    res }\OperatorTok{=}\NormalTok{ run\_event\_study(events\_demo, prices\_daily, factors\_ff3\_daily, cfg, verbose}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{    ts }\OperatorTok{=}\NormalTok{ res[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{]}
\NormalTok{    full }\OperatorTok{=}\NormalTok{ ts[ts[}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}All\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\NormalTok{    window\_results.append(\{}
        \StringTok{\textquotesingle{}Window\textquotesingle{}}\NormalTok{: label,}
        \StringTok{\textquotesingle{}Days\textquotesingle{}}\NormalTok{: we }\OperatorTok{{-}}\NormalTok{ ws }\OperatorTok{+} \DecValTok{1}\NormalTok{,}
        \StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{: }\BuiltInTok{int}\NormalTok{(full[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{]),}
        \StringTok{\textquotesingle{}Mean CAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}Mean BHAR\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}\% Positive\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (CS)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}t (BMP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{"}\NormalTok{,}
        \StringTok{\textquotesingle{}p (BMP)\textquotesingle{}}\NormalTok{: }\SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{full[}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{"}\NormalTok{,}
\NormalTok{    \})}

\NormalTok{win\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(window\_results)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"Sensitivity to Event Window Specification (FF3 Model)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{90}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(win\_df.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  Extracted 4,899 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2147)
  26 firm-events | Mean CAR: 0.004074 | Mean BHAR: 0.004648 | % positive: 50.0%
  Extracted 5,015 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2155)
  26 firm-events | Mean CAR: 0.003761 | Mean BHAR: 0.004327 | % positive: 42.3%
  Extracted 5,131 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2217)
  26 firm-events | Mean CAR: -0.001133 | Mean BHAR: 0.001027 | % positive: 42.3%
  Extracted 5,421 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2245)
  26 firm-events | Mean CAR: 0.021513 | Mean BHAR: 0.024885 | % positive: 61.5%
  Extracted 5,019 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2147)
  26 firm-events | Mean CAR: -0.005096 | Mean BHAR: -0.005148 | % positive: 42.3%
  Extracted 5,011 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2217)
  26 firm-events | Mean CAR: 0.008600 | Mean BHAR: 0.010441 | % positive: 46.2%
  Extracted 4,841 obs for 30 firm-events
  Estimated 26/30 firm-events (mean R = 0.2150)
  26 firm-events | Mean CAR: 0.000344 | Mean BHAR: 0.000502 | % positive: 46.2%
Sensitivity to Event Window Specification (FF3 Model)
==========================================================================================
    Window  Days  N Mean CAR Mean BHAR % Positive t (CS) t (BMP) p (BMP)
  (-1, +1)     3 26  0.4074%   0.4648%      50.0%  0.456   0.601  0.5535
  (-3, +3)     7 26  0.3761%   0.4327%      42.3%  0.198   0.361  0.7211
  (-5, +5)    11 26 -0.1133%   0.1027%      42.3% -0.049   0.030  0.9761
(-10, +10)    21 26  2.1513%   2.4885%      61.5%  0.775   0.727  0.4741
  (-1, +5)     7 26 -0.5096%  -0.5148%      42.3% -0.385  -0.068  0.9460
  (-5, +1)     7 26  0.8600%   1.0441%      46.2%  0.439   0.429  0.6715
    (0, 0)     1 26  0.0344%   0.0502%      46.2%  0.064  -0.020  0.9840
\end{verbatim}

}

\end{table}%

\subsection{Monthly Event Study: Fama-French 3-Factor
Model}\label{monthly-event-study-fama-french-3-factor-model}

For longer-horizon studies, monthly frequency is appropriate. Note that
the estimation window is specified in months rather than days:

\phantomsection\label{run-monthly-ff3}
\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# Create monthly events aligned to the monthly data}
\CommentTok{\# Map daily event dates to the corresponding month{-}end}
\NormalTok{events\_monthly }\OperatorTok{=}\NormalTok{ events\_demo.copy()}
\NormalTok{events\_monthly[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ events\_monthly[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{].dt.to\_period(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{).dt.to\_timestamp(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}

\CommentTok{\# Use month{-}end dates from monthly prices}
\NormalTok{monthly\_dates }\OperatorTok{=}\NormalTok{ prices\_monthly[}\StringTok{\textquotesingle{}date\textquotesingle{}}\NormalTok{].sort\_values().unique()}

\CommentTok{\# Filter events to dates present in monthly data}
\NormalTok{events\_monthly }\OperatorTok{=}\NormalTok{ events\_monthly[events\_monthly[}\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{].isin(monthly\_dates)]}
\NormalTok{events\_monthly }\OperatorTok{=}\NormalTok{ events\_monthly.drop\_duplicates(subset}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}event\_date\textquotesingle{}}\NormalTok{])}

\NormalTok{config\_monthly }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{36}\NormalTok{,     }\CommentTok{\# 36 months}
\NormalTok{    event\_window\_start}\OperatorTok{={-}}\DecValTok{3}\NormalTok{,    }\CommentTok{\# 3 months before}
\NormalTok{    event\_window\_end}\OperatorTok{=}\DecValTok{3}\NormalTok{,       }\CommentTok{\# 3 months after}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{3}\NormalTok{,                    }\CommentTok{\# 3{-}month gap}
\NormalTok{    min\_estimation\_obs}\OperatorTok{=}\DecValTok{24}\NormalTok{,    }\CommentTok{\# At least 24 months}
\NormalTok{    risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF3}
\NormalTok{)}

\ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(events\_monthly) }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{:}
\NormalTok{    results\_monthly }\OperatorTok{=}\NormalTok{ run\_event\_study(}
\NormalTok{        events}\OperatorTok{=}\NormalTok{events\_monthly,}
\NormalTok{        prices}\OperatorTok{=}\NormalTok{prices\_monthly,}
\NormalTok{        factors}\OperatorTok{=}\NormalTok{factors\_ff3\_monthly,}
\NormalTok{        config}\OperatorTok{=}\NormalTok{config\_monthly,}
\NormalTok{        group\_col}\OperatorTok{=}\StringTok{\textquotesingle{}group\textquotesingle{}}
\NormalTok{    )}
    
    \BuiltInTok{print}\NormalTok{(}\StringTok{"}\CharTok{\textbackslash{}n}\StringTok{{-}{-}{-} Monthly Test Statistics {-}{-}{-}"}\NormalTok{)}
\NormalTok{    ts\_m }\OperatorTok{=}\NormalTok{ results\_monthly[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{]}
\NormalTok{    mcols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{,}
             \StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{]}
\NormalTok{    mavail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ mcols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ts\_m.columns]}
    \BuiltInTok{print}\NormalTok{(ts\_m[mavail].to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"No monthly events could be aligned. Skipping monthly study."}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 Event Study: ff3 model 
  Windows: estimation=36, gap=3, event=(-3,3)
  Min obs: 24

Step 1: Building trading calendar...
  122 potential event dates

Step 2: Aligning events to trading calendar...
  50 aligned events

Step 3: Extracting returns and merging factors...
  Extracted 1,036 obs for 33 firm-events

Step 4: Estimating risk model parameters...
  Estimated 18/33 firm-events (mean R = 0.3218)

Step 5: Computing abnormal returns...
  18 firm-events | Mean CAR: -0.005257 | Mean BHAR: -0.014576 | % positive: 55.6%

Step 6: Computing test statistics...
  Done.

 Results Summary 
  group  N  mean_CAR  mean_BHAR  pct_positive      t_CS     p_CS     t_BMP    p_BMP      t_KP     p_KP
    All 18 -0.005257  -0.014576      0.555556 -0.081058 0.936342 -0.249547 0.805928 -0.320212 0.752709
Group_A  7 -0.141756  -0.135084      0.428571 -1.102110 0.312648 -1.357452 0.223472 -1.462577 0.193905
Group_B 11  0.081606   0.062111      0.636364  1.390317 0.194599  1.177372 0.266309  1.342593 0.209085

--- Monthly Test Statistics ---
  group  N  mean_CAR  mean_BHAR  pct_positive      t_CS     p_CS     t_BMP    p_BMP
    All 18 -0.005257  -0.014576      0.555556 -0.081058 0.936342 -0.249547 0.805928
Group_A  7 -0.141756  -0.135084      0.428571 -1.102110 0.312648 -1.357452 0.223472
Group_B 11  0.081606   0.062111      0.636364  1.390317 0.194599  1.177372 0.266309
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(events\_monthly) }\OperatorTok{\textgreater{}} \DecValTok{0} \KeywordTok{and} \StringTok{\textquotesingle{}daily\_stats\textquotesingle{}} \KeywordTok{in}\NormalTok{ results\_monthly:}
\NormalTok{    fig3 }\OperatorTok{=}\NormalTok{ plot\_event\_study(}
\NormalTok{        results\_monthly[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{],}
\NormalTok{        title}\OperatorTok{=}\StringTok{"Event Study: FF3 Model  Vietnamese Market (Monthly)"}
\NormalTok{    )}
\NormalTok{    plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{figure}[H]

\centering{

\pandocbounded{\includegraphics[keepaspectratio]{18_event_studies_files/figure-pdf/fig-monthly-car-output-1.pdf}}

}

\caption{\label{fig-monthly-car}Monthly cumulative abnormal returns
around event dates. Wider windows capture slower information
incorporation typical of emerging markets.}

\end{figure}%

\subsection{Daily Event Study: Fama-French 5-Factor
Model}\label{daily-event-study-fama-french-5-factor-model}

\phantomsection\label{run-daily-ff5}
\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{config\_ff5 }\OperatorTok{=}\NormalTok{ EventStudyConfig(}
\NormalTok{    estimation\_window}\OperatorTok{=}\DecValTok{150}\NormalTok{,}
\NormalTok{    event\_window\_start}\OperatorTok{={-}}\DecValTok{10}\NormalTok{,}
\NormalTok{    event\_window\_end}\OperatorTok{=}\DecValTok{10}\NormalTok{,}
\NormalTok{    gap}\OperatorTok{=}\DecValTok{15}\NormalTok{,}
\NormalTok{    min\_estimation\_obs}\OperatorTok{=}\DecValTok{120}\NormalTok{,}
\NormalTok{    risk\_model}\OperatorTok{=}\NormalTok{RiskModel.FF5}
\NormalTok{)}

\NormalTok{results\_ff5 }\OperatorTok{=}\NormalTok{ run\_event\_study(}
\NormalTok{    events}\OperatorTok{=}\NormalTok{events\_demo,}
\NormalTok{    prices}\OperatorTok{=}\NormalTok{prices\_daily,}
\NormalTok{    factors}\OperatorTok{=}\NormalTok{factors\_ff5\_daily,}
\NormalTok{    config}\OperatorTok{=}\NormalTok{config\_ff5,}
\NormalTok{    group\_col}\OperatorTok{=}\StringTok{\textquotesingle{}group\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 Event Study: ff5 model 
  Windows: estimation=150, gap=15, event=(-10,10)
  Min obs: 120

Step 1: Building trading calendar...
  3308 potential event dates

Step 2: Aligning events to trading calendar...
  50 aligned events

Step 3: Extracting returns and merging factors...
  Extracted 5,421 obs for 30 firm-events

Step 4: Estimating risk model parameters...
  Estimated 26/30 firm-events (mean R = 0.2675)

Step 5: Computing abnormal returns...
  26 firm-events | Mean CAR: 0.025684 | Mean BHAR: 0.028399 | % positive: 57.7%

Step 6: Computing test statistics...
  Done.

 Results Summary 
  group  N  mean_CAR  mean_BHAR  pct_positive     t_CS     p_CS    t_BMP    p_BMP     t_KP     p_KP
    All 26  0.025684   0.028399      0.576923 0.968332 0.342154 0.986788 0.333201 0.962252 0.345139
Group_A 13  0.015352   0.013489      0.461538 0.393655 0.700741 0.786232 0.446980 0.776663 0.452395
Group_B 13  0.036016   0.043309      0.692308 0.965100 0.353542 0.585915 0.568789 0.578785 0.573438
\end{verbatim}

\subsection{Comparing FF3 vs FF5 Estimation
Quality}\label{comparing-ff3-vs-ff5-estimation-quality}

\begin{table}

\caption{\label{tbl-model-comparison}Comparison of estimation quality
between FF3 and FF5 models}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params\_ff3 }\OperatorTok{=}\NormalTok{ results\_ff3[}\StringTok{\textquotesingle{}params\textquotesingle{}}\NormalTok{]}
\NormalTok{params\_ff5 }\OperatorTok{=}\NormalTok{ results\_ff5[}\StringTok{\textquotesingle{}params\textquotesingle{}}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Model Estimation Diagnostics"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{60}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Metric\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}FF3\textquotesingle{}}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}FF5\textquotesingle{}}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"{-}"} \OperatorTok{*} \DecValTok{54}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Firm{-}events estimated\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(params\_ff3)}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{ }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(params\_ff5)}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean R\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}r\_squared\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}r\_squared\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Median R\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}r\_squared\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{median()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}r\_squared\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{median()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean ()\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}sigma\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.6f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}sigma\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.6f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean ||\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}alpha\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{abs}\NormalTok{()}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.6f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}alpha\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\BuiltInTok{abs}\NormalTok{()}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.6f\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean (MKT)\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}beta\_mkt\_excess\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}beta\_mkt\_excess\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\ControlFlowTok{if} \StringTok{\textquotesingle{}beta\_smb\textquotesingle{}} \KeywordTok{in}\NormalTok{ params\_ff3.columns:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean (SMB)\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}beta\_smb\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}beta\_smb\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\ControlFlowTok{if} \StringTok{\textquotesingle{}beta\_hml\textquotesingle{}} \KeywordTok{in}\NormalTok{ params\_ff3.columns:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean (HML)\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff3[}\StringTok{\textquotesingle{}beta\_hml\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}beta\_hml\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\ControlFlowTok{if} \StringTok{\textquotesingle{}beta\_rmw\textquotesingle{}} \KeywordTok{in}\NormalTok{ params\_ff5.columns:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean (RMW)\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}\textquotesingle{}}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}beta\_rmw\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\ControlFlowTok{if} \StringTok{\textquotesingle{}beta\_cma\textquotesingle{}} \KeywordTok{in}\NormalTok{ params\_ff5.columns:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\SpecialCharTok{\{}\StringTok{\textquotesingle{}Mean (CMA)\textquotesingle{}}\SpecialCharTok{:\textless{}30\}}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}\textquotesingle{}}\SpecialCharTok{:\textgreater{}12\}}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{params\_ff5[}\StringTok{\textquotesingle{}beta\_cma\textquotesingle{}}\NormalTok{]}\SpecialCharTok{.}\NormalTok{mean()}\SpecialCharTok{:\textgreater{}12.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Model Estimation Diagnostics
============================================================

Metric                                  FF3          FF5
------------------------------------------------------
Firm-events estimated                    26           26
Mean R                              0.2245       0.2675
Median R                            0.1943       0.2692
Mean ()                          0.021753     0.021351
Mean ||                           0.001022     0.001130
Mean (MKT)                          0.8867       0.9721
Mean (SMB)                         -0.0434       0.0265
Mean (HML)                          0.2489       0.1493
Mean (RMW)                                     -0.0934
Mean (CMA)                                      0.1070
\end{verbatim}

}

\end{table}%

\subsection{Event-Level Detail}\label{event-level-detail}

\begin{table}

\caption{\label{tbl-event-detail}Event-level detail: CARs and BHARs for
each firm-event (FF3 model)}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{detail }\OperatorTok{=}\NormalTok{ results\_ff3[}\StringTok{\textquotesingle{}event\_ar\textquotesingle{}}\NormalTok{].copy()}
\NormalTok{detail\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}symbol\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}evtdate\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SCAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}sigma\textquotesingle{}}\NormalTok{,}
               \StringTok{\textquotesingle{}nobs\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}alpha\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}beta\_mkt\_excess\textquotesingle{}}\NormalTok{]}
\NormalTok{detail\_avail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ detail\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ detail.columns]}
\NormalTok{detail\_show }\OperatorTok{=}\NormalTok{ detail[detail\_avail].copy()}
\NormalTok{detail\_show[}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ detail\_show[}\StringTok{\textquotesingle{}CAR\textquotesingle{}}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4\%\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{detail\_show[}\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ detail\_show[}\StringTok{\textquotesingle{}BHAR\textquotesingle{}}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4\%\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{detail\_show[}\StringTok{\textquotesingle{}SCAR\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ detail\_show[}\StringTok{\textquotesingle{}SCAR\textquotesingle{}}\NormalTok{].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.3f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Event{-}Level Results (first 20 firm{-}events)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{100}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(detail\_show.head(}\DecValTok{20}\NormalTok{).to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Event-Level Results (first 20 firm-events)
====================================================================================================
symbol    evtdate       CAR      BHAR   SCAR    sigma  nobs     alpha  beta_mkt_excess
   BVH 2016-10-20 -12.6456% -11.6522% -1.603 0.017219   150  0.001193         1.449182
   DHG 2016-01-25  16.1151%  17.1149%  2.273 0.015472   150 -0.000224         0.754245
   DNH 2019-10-14   1.7233%   1.8068%  0.104 0.036035   150 -0.000781         1.861996
   DPM 2020-07-30  -5.9576%  -6.2025% -0.545 0.023873   150  0.001279         0.313932
   FOX 2021-01-13   2.7478%   2.9194%  0.329 0.018243   150 -0.000696         0.148058
   GAS 2020-02-11   0.5371%   0.7801%  0.100 0.011694   150  0.000501         1.851155
   GEX 2020-08-20  11.9985%  13.5843%  1.197 0.021883   150  0.000944         1.583418
   IDC 2018-10-01   1.3889%   0.5651%  0.094 0.032120   150 -0.000674         0.809305
   MML 2021-10-29 -12.0139% -12.3759% -1.141 0.022985   150  0.002976         0.260588
   MSN 2015-10-23  -5.7205%  -5.5645% -0.718 0.017375   150  0.001177         0.453951
   PGV 2019-06-26  -7.5892%  -9.1366% -0.359 0.046165   150  0.000502         0.151377
   PLX 2020-01-07   2.5330%   2.7847%  0.423 0.013067   150 -0.000176         0.917578
   PLX 2020-06-01  -6.1517%  -6.0085% -0.739 0.018168   150 -0.000465         1.815178
   POW 2020-12-23   7.7751%   9.1225%  1.130 0.015014   150 -0.000575         0.774423
   PVD 2020-05-25   4.8827%   5.6674%  0.510 0.020875   150 -0.001522         1.316102
   PVS 2017-08-07   2.1360%   2.1918%  0.297 0.015715   150 -0.000341         1.136273
   QNS 2018-01-18   4.3001%   3.4011%  0.530 0.017703   150 -0.003716         0.128328
   SAB 2017-08-24   6.0347%   6.7732%  0.748 0.017614   150  0.003284         2.123751
   SNZ 2019-03-12  34.5230%  33.1105%  2.145 0.035121   150  0.000235        -1.015554
   VCI 2020-01-20  -3.3191%  -2.9072% -0.458 0.015797   150  0.000335        -0.086268
\end{verbatim}

}

\end{table}%

\subsection{Daily Abnormal Return
Dynamics}\label{daily-abnormal-return-dynamics}

\begin{table}

\caption{\label{tbl-daily-dynamics}Daily dynamics of mean abnormal
returns and test statistics within the event window}

\centering{

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ds }\OperatorTok{=}\NormalTok{ results\_ff3[}\StringTok{\textquotesingle{}daily\_stats\textquotesingle{}}\NormalTok{].copy()}
\NormalTok{ds\_cols }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}evttime\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_AR\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_AR\_BMP\textquotesingle{}}\NormalTok{]}
\NormalTok{ds\_avail }\OperatorTok{=}\NormalTok{ [c }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ds\_cols }\ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ds.columns]}
\NormalTok{ds\_show }\OperatorTok{=}\NormalTok{ ds[ds\_avail].copy()}

\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}mean\_AR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]:}
    \ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ds\_show.columns:}
\NormalTok{        ds\_show[c] }\OperatorTok{=}\NormalTok{ ds\_show[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.4\%\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}t\_AR\_CS\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}t\_AR\_BMP\textquotesingle{}}\NormalTok{]:}
    \ControlFlowTok{if}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ds\_show.columns:}
\NormalTok{        ds\_show[c] }\OperatorTok{=}\NormalTok{ ds\_show[c].}\BuiltInTok{map}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: }\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:.3f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ pd.notna(x) }\ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\StringTok{"Daily Event{-}Window Dynamics (FF3 Model)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{80}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(ds\_show.to\_string(index}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Daily Event-Window Dynamics (FF3 Model)
================================================================================
 evttime  N  mean_AR mean_CAR mean_BHAR
     -10 23  0.3571%  0.3571%   0.3729%
      -9 23  0.0337%  0.3907%   0.4209%
      -8 23 -0.1581%  0.2326%   0.2766%
      -7 23  0.3691%  0.6018%   0.6581%
      -6 23  1.3416%  1.9433%   2.0278%
      -5 23  0.1509%  2.0942%   2.2313%
      -4 23  0.5512%  2.6454%   2.9187%
      -3 23 -0.4641%  2.1814%   2.4297%
      -2 23  0.2412%  2.4225%   2.8028%
      -1 23  0.5660%  2.9885%   3.3240%
       0 23 -0.0281%  2.9604%   3.4926%
       1 23 -0.2564%  2.7040%   3.1039%
       2 23 -0.4421%  2.2619%   2.5764%
       3 23  0.6337%  2.8956%   3.4659%
       4 23 -0.8432%  2.0524%   2.4738%
       5 23 -0.4174%  1.6350%   2.1339%
       6 23 -0.2272%  1.4078%   1.8085%
       7 23 -0.2085%  1.1993%   1.6819%
       8 23  0.0893%  1.2886%   1.8609%
       9 23  0.3307%  1.6193%   2.1658%
      10 23  0.5320%  2.1513%   2.4885%
\end{verbatim}

}

\end{table}%

\subsection{Summary of Key Findings}\label{summary-of-key-findings}

\phantomsection\label{summary}
\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{70}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"EVENT STUDY RESULTS SUMMARY  Vietnamese Market"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\StringTok{"="} \OperatorTok{*} \DecValTok{70}\NormalTok{)}

\NormalTok{ff3\_all }\OperatorTok{=}\NormalTok{ results\_ff3[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{][results\_ff3[}\StringTok{\textquotesingle{}test\_stats\textquotesingle{}}\NormalTok{][}\StringTok{\textquotesingle{}group\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}All\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Sample: }\SpecialCharTok{\{}\BuiltInTok{int}\NormalTok{(ff3\_all[}\StringTok{\textquotesingle{}N\textquotesingle{}}\NormalTok{])}\SpecialCharTok{\}}\SpecialStringTok{ firm{-}event observations"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Frequency: Daily"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Primary Model: Fama{-}French 3{-}Factor"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Estimation Window: }\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{estimation\_window}\SpecialCharTok{\}}\SpecialStringTok{ trading days"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Event Window: (}\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{event\_window\_start}\SpecialCharTok{\}}\SpecialStringTok{, }\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{event\_window\_end}\SpecialCharTok{\}}\SpecialStringTok{)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Gap: }\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{gap}\SpecialCharTok{\}}\SpecialStringTok{ trading days"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{{-}{-}{-} Abnormal Return Measures {-}{-}{-}"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Mean CAR(}\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{event\_window\_start}\SpecialCharTok{\}}\SpecialStringTok{,}\SpecialCharTok{\{}\NormalTok{config\_ff3}\SpecialCharTok{.}\NormalTok{event\_window\_end}\SpecialCharTok{\}}\SpecialStringTok{): "}
      \SpecialStringTok{f"}\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}mean\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Median CAR: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}median\_CAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Mean BHAR: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}mean\_BHAR\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Fraction positive CARs: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}pct\_positive\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.1\%\}}\SpecialStringTok{"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{{-}{-}{-} Statistical Significance {-}{-}{-}"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Cross{-}Sectional t: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}t\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{ (p = }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Patell Z: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}Z\_Patell\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{ (p = }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"BMP t: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}t\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{ (p = }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Kolari{-}Pynnnen t: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}t\_KP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{ (p = }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Generalized Sign Z: }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}Z\_GSign\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.3f\}}\SpecialStringTok{ (p = }\SpecialCharTok{\{}\NormalTok{ff3\_all[}\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:.4f\}}\SpecialStringTok{)"}\NormalTok{)}

\NormalTok{sig\_005 }\OperatorTok{=} \BuiltInTok{sum}\NormalTok{(}\DecValTok{1} \ControlFlowTok{for}\NormalTok{ k }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_SkAdj\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_Wilcoxon\textquotesingle{}}\NormalTok{]}
              \ControlFlowTok{if}\NormalTok{ k }\KeywordTok{in}\NormalTok{ ff3\_all }\KeywordTok{and}\NormalTok{ pd.notna(ff3\_all[k]) }\KeywordTok{and}\NormalTok{ ff3\_all[k] }\OperatorTok{\textless{}} \FloatTok{0.05}\NormalTok{)}
\NormalTok{total\_tests }\OperatorTok{=} \BuiltInTok{sum}\NormalTok{(}\DecValTok{1} \ControlFlowTok{for}\NormalTok{ k }\KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}p\_CS\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_Patell\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_BMP\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_KP\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_GSign\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_SkAdj\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}p\_Wilcoxon\textquotesingle{}}\NormalTok{]}
                  \ControlFlowTok{if}\NormalTok{ k }\KeywordTok{in}\NormalTok{ ff3\_all }\KeywordTok{and}\NormalTok{ pd.notna(ff3\_all[k]))}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{sig\_005}\SpecialCharTok{\}}\SpecialStringTok{/}\SpecialCharTok{\{}\NormalTok{total\_tests}\SpecialCharTok{\}}\SpecialStringTok{ tests significant at 5\% level"}\NormalTok{)}

\CommentTok{\# Robustness note}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"}\CharTok{\textbackslash{}n}\SpecialStringTok{Robustness: Results checked across }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(models\_daily)}\SpecialCharTok{\}}\SpecialStringTok{ risk models "}
      \SpecialStringTok{f"and }\SpecialCharTok{\{}\BuiltInTok{len}\NormalTok{(windows)}\SpecialCharTok{\}}\SpecialStringTok{ event windows"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
======================================================================
EVENT STUDY RESULTS SUMMARY  Vietnamese Market
======================================================================

Sample: 26 firm-event observations
Frequency: Daily
Primary Model: Fama-French 3-Factor
Estimation Window: 150 trading days
Event Window: (-10, 10)
Gap: 15 trading days

--- Abnormal Return Measures ---
Mean CAR(-10,10): 2.1513%
Median CAR: 1.5701%
Mean BHAR: 2.4885%
Fraction positive CARs: 61.5%

--- Statistical Significance ---
Cross-Sectional t: 0.775 (p = 0.4456)
Patell Z: 0.961 (p = 0.3364)
BMP t: 0.727 (p = 0.4741)
Kolari-Pynnnen t: 0.700 (p = 0.4904)
Generalized Sign Z: 1.177 (p = 0.2393)

0/7 tests significant at 5% level

Robustness: Results checked across 4 risk models and 7 event windows
\end{verbatim}

\bookmarksetup{startatroot}

\chapter{Conclusion}\label{conclusion-1}

Empirical finance in emerging and frontier markets is often judged less
by the elegance of an estimator than by the credibility of its inputs
and the transparency of its decisions. Vietnam makes this point vividly:
trading venues and regulatory regimes have evolved quickly, firm
coverage can be uneven across time, corporate actions need careful
treatment, and accounting conventions require close attention to timing
and comparability. Those features do not prevent high-quality research;
they simply shift the center of gravity toward \emph{reproducible data
engineering}, \emph{auditable transformations}, and \emph{clear
identification of assumptions}.

\section{What you should take away}\label{what-you-should-take-away}

\subsection{Reproducibility is an identification
strategy}\label{reproducibility-is-an-identification-strategy}

In textbook settings, identification focuses on variation and
exogeneity. In real-world market data, identification also depends on
whether your dataset is \emph{the same dataset} when you rerun the work
next month or next year. The practical discipline of versioned inputs,
deterministic transformations, and documented filters reduces the scope
for accidental \(p\)-hacking and silent sample drift (e.g., survivorship
bias from symbol changes or late-arriving delistings). Reproducible
workflows are not administrative overhead; they are a commitment device
that makes results more trustworthy and easier to challenge
constructively (Peng 2011; Sandve et al. 2013).

\subsection{Vietnam rewards ``microstructure
humility''}\label{vietnam-rewards-microstructure-humility}

The chapters on returns, beta estimation, and factor construction
emphasized that nave carryover of developed-market defaults can be
costly. Thin trading, price limits, lot-size rules, and regime changes
mean that decisions like (i) return interval, (ii) stale-price handling,
(iii) corporate-action adjustment, and (iv) portfolio formation
frequency can materially change inference. This is not a Vietnam-only
phenomenon, but it is more visible there, and therefore a useful
laboratory for best practices in emerging markets.

\section{A reproducibility checklist you can actually
use}\label{a-reproducibility-checklist-you-can-actually-use}

The list below is designed to be operational: each item can be verified
in a repository review.

\begin{longtable}[]{@{}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.2329}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.4521}}
  >{\raggedright\arraybackslash}p{(\linewidth - 4\tabcolsep) * \real{0.3151}}@{}}
\caption{Reproducibility deliverables for
research}\label{tbl-repro-checklist}\tabularnewline
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Deliverable
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
What ``done'' looks like
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Where it lives
\end{minipage} \\
\midrule\noalign{}
\endfirsthead
\toprule\noalign{}
\begin{minipage}[b]{\linewidth}\raggedright
Deliverable
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
What ``done'' looks like
\end{minipage} & \begin{minipage}[b]{\linewidth}\raggedright
Where it lives
\end{minipage} \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Deterministic transforms & Same raw inputs yield identical normalized
outputs & \texttt{R/transform\_*.R} (or
\texttt{python/transform\_*.py}) \\
Test suite & Coverage, identity, and corporate-action tests run in CI &
\texttt{tests/} + CI config \\
Data dictionary & Tables/fields documented with units, timing, and keys
& \texttt{docs/dictionary.qmd} \\
Research log & All key design choices recorded (filters, winsorization,
periods) & \texttt{notes/research\_log.md} \\
Artifact registry & Every figure/table has a script and a checksum &
\texttt{artifacts/manifest.json} \\
\end{longtable}

\bookmarksetup{startatroot}

\chapter{Closing perspective}\label{closing-perspective}

Vietnam is not ``hard mode'' finance; it is \emph{real mode} finance.
The market's growth, institutional evolution, and data idiosyncrasies
force the habits that modern empirical finance increasingly requires
everywhere: transparent datasets, careful treatment of identities and
corporate actions, and codebases that can be rerun and audited.

\bookmarksetup{startatroot}

\chapter*{References}\label{references}
\addcontentsline{toc}{chapter}{References}

\markboth{References}{References}

\phantomsection\label{refs}
\begin{CSLReferences}{1}{0}
\bibitem[\citeproctext]{ref-aharony1980quarterly}
Aharony, Joseph, and Itzhak Swary. 1980. {``Quarterly Dividend and
Earnings Announcements and Stockholders' Returns: An Empirical
Analysis.''} \emph{The Journal of Finance} 35 (1): 1--12.

\bibitem[\citeproctext]{ref-andrade2001new}
Andrade, Gregor, Mark Mitchell, and Erik Stafford. 2001. {``New Evidence
and Perspectives on Mergers.''} \emph{Journal of Economic Perspectives}
15 (2): 103--20.

\bibitem[\citeproctext]{ref-BaliEngleMurray2016}
Bali, Turan G, Robert F Engle, and Scott Murray. 2016. \emph{{Empirical
asset pricing: The cross section of stock returns}}. John Wiley \& Sons.
\url{https://doi.org/10.1002/9781118445112.stat07954}.

\bibitem[\citeproctext]{ref-ball2013empirical}
Ball, Ray, and Philip Brown. 2013. {``An Empirical Evaluation of
Accounting Income Numbers.''} In \emph{Financial Accounting and Equity
Markets}, 27--46. Routledge.

\bibitem[\citeproctext]{ref-bao2024institutional}
Bao Dinh, Ngoc, and Van Nguyen Hong Tran. 2024. {``Institutional
Ownership and Stock Liquidity: Evidence from an Emerging Market.''}
\emph{SAGE Open} 14 (1): 21582440241239116.

\bibitem[\citeproctext]{ref-barber1997detecting}
Barber, Brad M, and John D Lyon. 1997. {``Detecting Long-Run Abnormal
Stock Returns: The Empirical Power and Specification of Test
Statistics.''} \emph{Journal of Financial Economics} 43 (3): 341--72.

\bibitem[\citeproctext]{ref-bernard1989post}
Bernard, Victor L, and Jacob K Thomas. 1989.
{``Post-Earnings-Announcement Drift: Delayed Price Response or Risk
Premium?''} \emph{Journal of Accounting Research} 27: 1--36.

\bibitem[\citeproctext]{ref-bhattacharya2000event}
Bhattacharya, Utpal, Hazem Daouk, Brian Jorgenson, and Carl-Heinrich
Kehr. 2000. {``When an Event Is Not an Event: The Curious Case of an
Emerging Market.''} \emph{Journal of Financial Economics} 55 (1):
69--101.

\bibitem[\citeproctext]{ref-binder1998event}
Binder, John. 1998. {``The Event Study Methodology Since 1969.''}
\emph{Review of Quantitative Finance and Accounting} 11 (2): 111--37.

\bibitem[\citeproctext]{ref-boehmer1991event}
Boehmer, Ekkehart, Jim Masumeci, and Annette B Poulsen. 1991.
{``Event-Study Methodology Under Conditions of Event-Induced
Variance.''} \emph{Journal of Financial Economics} 30 (2): 253--72.

\bibitem[\citeproctext]{ref-brown1980measuring}
Brown, Stephen J, and Jerold B Warner. 1980. {``Measuring Security Price
Performance.''} \emph{Journal of Financial Economics} 8 (3): 205--58.

\bibitem[\citeproctext]{ref-brown1985using}
---------. 1985. {``Using Daily Stock Returns: The Case of Event
Studies.''} \emph{Journal of Financial Economics} 14 (1): 3--31.

\bibitem[\citeproctext]{ref-campbell1998econometrics}
Campbell, John Y, Andrew W Lo, A Craig MacKinlay, and Robert F Whitelaw.
1998. {``The Econometrics of Financial Markets.''} \emph{Macroeconomic
Dynamics} 2 (4): 559--62.

\bibitem[\citeproctext]{ref-carhart1997persistence}
Carhart, Mark M. 1997a. {``On Persistence in Mutual Fund Performance.''}
\emph{The Journal of Finance} 52 (1): 57--82.

\bibitem[\citeproctext]{ref-Carhart1997}
Carhart, Mark M. 1997b. {``{On persistence in mutual fund
performance}.''} \emph{{The Journal of Finance}} 52 (1): 57--82.
\url{https://doi.org/10.1111/j.1540-6261.1997.tb03808.x}.

\bibitem[\citeproctext]{ref-chen2002breadth}
Chen, Joseph, Harrison Hong, and Jeremy C Stein. 2002. {``Breadth of
Ownership and Stock Returns.''} \emph{Journal of Financial Economics} 66
(2-3): 171--205.

\bibitem[\citeproctext]{ref-corrado1989nonparametric}
Corrado, Charles J. 1989. {``A Nonparametric Test for Abnormal
Security-Price Performance in Event Studies.''} \emph{Journal of
Financial Economics} 23 (2): 385--95.

\bibitem[\citeproctext]{ref-cowan1992nonparametric}
Cowan, Arnold Richard. 1992. {``Nonparametric Event Study Tests.''}
\emph{Review of Quantitative Finance and Accounting} 2 (4): 343--58.

\bibitem[\citeproctext]{ref-dimson1979risk}
Dimson, Elroy. 1979. {``Risk Measurement When Shares Are Subject to
Infrequent Trading.''} \emph{Journal of Financial Economics} 7 (2):
197--226.

\bibitem[\citeproctext]{ref-fama1998market}
Fama, Eugene F. 1998. {``Market Efficiency, Long-Term Returns, and
Behavioral Finance.''} \emph{Journal of Financial Economics} 49 (3):
283--306.

\bibitem[\citeproctext]{ref-fama1969adjustment}
Fama, Eugene F, Lawrence Fisher, Michael C Jensen, and Richard Roll.
1969. {``The Adjustment of Stock Prices to New Information.''}
\emph{International Economic Review} 10 (1): 1--21.

\bibitem[\citeproctext]{ref-Fama1992}
Fama, Eugene F., and Kenneth R. French. 1992. {``{The cross-section of
expected stock returns}.''} \emph{{The Journal of Finance}} 47 (2):
427--65. \url{https://doi.org/2329112}.

\bibitem[\citeproctext]{ref-Fama1993}
---------. 1993. {``{Common risk factors in the returns on stocks and
bonds}.''} \emph{{Journal of Financial Economics}} 33 (1): 3--56.
\url{https://doi.org/10.1016/0304-405X(93)90023-5}.

\bibitem[\citeproctext]{ref-FamaFrench2015}
---------. 2015. {``A Five-Factor Asset Pricing Model.''} \emph{Journal
of Financial Economics} 116 (1): 1--22.
\url{https://doi.org/10.1016/j.jfineco.2014.10.010}.

\bibitem[\citeproctext]{ref-Fama1973}
Fama, Eugene F., and James D. MacBeth. 1973. {``{Risk, return, and
equilibrium: Empirical tests}.''} \emph{{Journal of Political Economy}}
81 (3): 607--36. \url{https://doi.org/10.1086/260061}.

\bibitem[\citeproctext]{ref-flannery2002macroeconomic}
Flannery, Mark J, and Aris A Protopapadakis. 2002. {``Macroeconomic
Factors Do Influence Aggregate Stock Returns.''} \emph{The Review of
Financial Studies} 15 (3): 751--82.

\bibitem[\citeproctext]{ref-Frazzini2014}
Frazzini, Andrea, and Lasse Heje Pedersen. 2014. {``{Betting against
beta}.''} \emph{{Journal of Financial Economics}} 111 (1): 1--25.
\url{https://doi.org/10.1016/j.jfineco.2013.10.005}.

\bibitem[\citeproctext]{ref-gentzkow2014code}
Gentzkow, Matthew, and Jesse M Shapiro. 2014. {``Code and Data for the
Social Sciences: A Practitioner's Guide.''} Working Paper, University of
Chicago.

\bibitem[\citeproctext]{ref-griffin2010market}
Griffin, John M, Patrick J Kelly, and Federico Nardari. 2010. {``Do
Market Efficiency Measures Yield Correct Inferences? A Comparison of
Developed and Emerging Markets.''} \emph{The Review of Financial
Studies} 23 (8): 3225--77.

\bibitem[\citeproctext]{ref-hall1992removal}
Hall, Peter. 1992. {``On the Removal of Skewness by Transformation.''}
\emph{Journal of the Royal Statistical Society Series B: Statistical
Methodology} 54 (1): 221--28.

\bibitem[\citeproctext]{ref-Hou2015}
Hou, Kewei, Chen Xue, and Lu Zhang. 2014. {``{Digesting anomalies: An
investment approach}.''} \emph{{Review of Financial Studies}} 28 (3):
650--705. \url{https://doi.org/10.1093/rfs/hhu068}.

\bibitem[\citeproctext]{ref-Hou2020}
---------. 2020. {``{Replicating anomalies}.''} \emph{{Review of
Financial Studies}} 33 (5): 2019--2133.
\url{https://doi.org/10.1093/rfs/hhy131}.

\bibitem[\citeproctext]{ref-huang2023factors}
Huang, Xiangqian, Clark Liu, and Tao Shu. 2023. {``Factors and Anomalies
in the Vietnamese Stock Market.''} \emph{Pacific-Basin Finance Journal}
82: 102176.

\bibitem[\citeproctext]{ref-Jagannathan1996}
Jagannathan, Ravi, and Zhenyu Wang. 1996. {``{The conditional CAPM and
the cross-section of expected returns}.''} \emph{{The Journal of
Finance}} 51 (1): 3--53. \url{https://doi.org/10.2307/2329301}.

\bibitem[\citeproctext]{ref-jensen1983market}
Jensen, Michael C, and Richard S Ruback. 1983. {``The Market for
Corporate Control: The Scientific Evidence.''} \emph{Journal of
Financial Economics} 11 (1-4): 5--50.

\bibitem[\citeproctext]{ref-kolari2010event}
Kolari, James W, and Seppo Pynnnen. 2010. {``Event Study Testing with
Cross-Sectional Correlation of Abnormal Returns.''} \emph{The Review of
Financial Studies} 23 (11): 3996--4025.

\bibitem[\citeproctext]{ref-kothari2007econometrics}
Kothari, Sagar P, and Jerold B Warner. 2007. {``Econometrics of Event
Studies.''} In \emph{Handbook of Empirical Corporate Finance}, 3--36.
Elsevier.

\bibitem[\citeproctext]{ref-lehavy2008investor}
Lehavy, Reuven, and Richard G Sloan. 2008. {``Investor Recognition and
Stock Returns.''} \emph{Review of Accounting Studies} 13 (2): 327--61.

\bibitem[\citeproctext]{ref-Lintner1965}
Lintner, John. 1965. {``{Security prices, risk, and maximal gains from
diversification}.''} \emph{{The Journal of Finance}} 20 (4): 587--615.
\url{https://doi.org/10.1111/j.1540-6261.1965.tb02930.x}.

\bibitem[\citeproctext]{ref-livnat2006comparing}
Livnat, Joshua, and Richard R Mendenhall. 2006. {``Comparing the
Post--Earnings Announcement Drift for Surprises Calculated from Analyst
and Time Series Forecasts.''} \emph{Journal of Accounting Research} 44
(1): 177--205.

\bibitem[\citeproctext]{ref-mackinlay1997event}
MacKinlay, A Craig. 1997. {``Event Studies in Economics and Finance.''}
\emph{Journal of Economic Literature} 35 (1): 13--39.

\bibitem[\citeproctext]{ref-Markowitz1952}
Markowitz, Harry. 1952. {``{Portfolio selection}.''} \emph{{The Journal
of Finance}} 7 (1): 77--91.
\url{https://doi.org/10.1111/j.1540-6261.1952.tb01525.x}.

\bibitem[\citeproctext]{ref-mitchell1993role}
Mitchell, Mark L, and Jeffry M Netter. 1993. {``The Role of Financial
Economics in Securities Fraud Cases: Applications at the Securities and
Exchange Commission.''} \emph{Bus. Law.} 49: 545.

\bibitem[\citeproctext]{ref-mitchell2000managerial}
Mitchell, Mark L, and Erik Stafford. 2000. {``Managerial Decisions and
Long-Term Stock Price Performance.''} \emph{The Journal of Business} 73
(3): 287--329.

\bibitem[\citeproctext]{ref-Mossin1966}
Mossin, Jan. 1966. {``{Equilibrium in a capital asset market}.''}
\emph{{Econometrica}} 34 (4): 768--83.
\url{https://doi.org/10.2307/1910098}.

\bibitem[\citeproctext]{ref-Newey1987}
Newey, Whitney K., and Kenneth D. West. 1987. {``{A simple, positive
semi-definite, heteroskedasticity and autocorrelation consistent
covariance Matrix}.''} \emph{{Econometrica}} 55 (3): 703--8.
\url{http://www.jstor.org/stable/1913610}.

\bibitem[\citeproctext]{ref-patell1976corporate}
Patell, James M. 1976. {``Corporate Forecasts of Earnings Per Share and
Stock Price Behavior: Empirical Test.''} \emph{Journal of Accounting
Research}, 246--76.

\bibitem[\citeproctext]{ref-peng2011reproducible}
Peng, Roger D. 2011. {``Reproducible Research in Computational
Science.''} \emph{Science} 334 (6060): 1226--27.

\bibitem[\citeproctext]{ref-sandve2013ten}
Sandve, Geir Kjetil, Anton Nekrutenko, James Taylor, and Eivind Hovig.
2013. {``Ten Simple Rules for Reproducible Computational Research.''}
\emph{PLoS Computational Biology} 9 (10): e1003285.

\bibitem[\citeproctext]{ref-scheuch2023tidy}
Scheuch, Christoph, Stefan Voigt, and Patrick Weiss. 2023. \emph{Tidy
Finance with r}. CRC Press.

\bibitem[\citeproctext]{ref-scheuch2024tidy}
Scheuch, Christoph, Stefan Voigt, Patrick Weiss, and Christoph Frey.
2024. \emph{Tidy Finance with Python}. Chapman; Hall/CRC.

\bibitem[\citeproctext]{ref-scholes1977estimating}
Scholes, Myron, and Joseph Williams. 1977. {``Estimating Betas from
Nonsynchronous Data.''} \emph{Journal of Financial Economics} 5 (3):
309--27.

\bibitem[\citeproctext]{ref-schwert1981using}
Schwert, G William. 1981. {``Using Financial Data to Measure Effects of
Regulation.''} \emph{The Journal of Law and Economics} 24 (1): 121--58.

\bibitem[\citeproctext]{ref-Sharpe1964}
Sharpe, William F. 1964. {``{Capital asset prices: A theory of market
equilibrium under conditions of risk }.''} \emph{{The Journal of
Finance}} 19 (3): 425--42.
\url{https://doi.org/10.1111/j.1540-6261.1964.tb02865.x}.

\bibitem[\citeproctext]{ref-vilhuber2020reproducibility}
Vilhuber, Lars. 2020. {``Reproducibility and Replicability in
Economics.''} \emph{Harvard Data Science Review} 2 (4): 1--39.

\bibitem[\citeproctext]{ref-vo2015foreign}
Vo, Xuan Vinh. 2015. {``Foreign Ownership and Stock Return
Volatility--Evidence from Vietnam.''} \emph{Journal of Multinational
Financial Management} 30: 101--9.

\bibitem[\citeproctext]{ref-warner1988stock}
Warner, Jerold B, Ross L Watts, and Karen H Wruck. 1988. {``Stock Prices
and Top Management Changes.''} \emph{Journal of Financial Economics} 20:
461--92.

\end{CSLReferences}




\end{document}
