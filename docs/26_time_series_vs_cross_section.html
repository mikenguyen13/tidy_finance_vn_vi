<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>22&nbsp; Time-Series vs.&nbsp;Cross-Sectional Factor Tests ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./30_financial_statement_analysis.html" rel="next">
<link href="./25_factor_zoo_and_multiple_testing.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="22&nbsp; Time-Series vs.&nbsp;Cross-Sectional Factor Tests ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:title" content="22&nbsp; Time-Series vs.&nbsp;Cross-Sectional Factor Tests ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</a></li><li class="breadcrumb-item"><a href="./26_time_series_vs_cross_section.html"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L·ªùi n√≥i ƒë·∫ßu</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Truy c·∫≠p v√† qu·∫£n l√Ω d·ªØ li·ªáu t√†i ch√≠nh VN</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-ts-cs-framework" id="toc-sec-ts-cs-framework" class="nav-link active" data-scroll-target="#sec-ts-cs-framework"><span class="header-section-number">22.1</span> The Two Testing Frameworks</a>
  <ul class="collapse">
  <li><a href="#time-series-regressions" id="toc-time-series-regressions" class="nav-link" data-scroll-target="#time-series-regressions"><span class="header-section-number">22.1.1</span> Time-Series Regressions</a></li>
  <li><a href="#cross-sectional-regressions-fama-macbeth" id="toc-cross-sectional-regressions-fama-macbeth" class="nav-link" data-scroll-target="#cross-sectional-regressions-fama-macbeth"><span class="header-section-number">22.1.2</span> Cross-Sectional Regressions (Fama-MacBeth)</a></li>
  <li><a href="#key-differences" id="toc-key-differences" class="nav-link" data-scroll-target="#key-differences"><span class="header-section-number">22.1.3</span> Key Differences</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-data" id="toc-sec-ts-cs-data" class="nav-link" data-scroll-target="#sec-ts-cs-data"><span class="header-section-number">22.2</span> Data Construction</a></li>
  <li><a href="#sec-ts-cs-ts-tests" id="toc-sec-ts-cs-ts-tests" class="nav-link" data-scroll-target="#sec-ts-cs-ts-tests"><span class="header-section-number">22.3</span> Time-Series Tests</a>
  <ul class="collapse">
  <li><a href="#full-sample-time-series-regressions" id="toc-full-sample-time-series-regressions" class="nav-link" data-scroll-target="#full-sample-time-series-regressions"><span class="header-section-number">22.3.1</span> Full-Sample Time-Series Regressions</a></li>
  <li><a href="#the-grs-test" id="toc-the-grs-test" class="nav-link" data-scroll-target="#the-grs-test"><span class="header-section-number">22.3.2</span> The GRS Test</a></li>
  <li><a href="#model-comparison-via-grs" id="toc-model-comparison-via-grs" class="nav-link" data-scroll-target="#model-comparison-via-grs"><span class="header-section-number">22.3.3</span> Model Comparison via GRS</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-cs-tests" id="toc-sec-ts-cs-cs-tests" class="nav-link" data-scroll-target="#sec-ts-cs-cs-tests"><span class="header-section-number">22.4</span> Cross-Sectional Tests</a>
  <ul class="collapse">
  <li><a href="#fama-macbeth-with-portfolio-test-assets" id="toc-fama-macbeth-with-portfolio-test-assets" class="nav-link" data-scroll-target="#fama-macbeth-with-portfolio-test-assets"><span class="header-section-number">22.4.1</span> Fama-MacBeth with Portfolio Test Assets</a></li>
  <li><a href="#the-shanken-correction" id="toc-the-shanken-correction" class="nav-link" data-scroll-target="#the-shanken-correction"><span class="header-section-number">22.4.2</span> The Shanken Correction</a></li>
  <li><a href="#fama-macbeth-with-individual-stocks" id="toc-fama-macbeth-with-individual-stocks" class="nav-link" data-scroll-target="#fama-macbeth-with-individual-stocks"><span class="header-section-number">22.4.3</span> Fama-MacBeth with Individual Stocks</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-disagreement" id="toc-sec-ts-cs-disagreement" class="nav-link" data-scroll-target="#sec-ts-cs-disagreement"><span class="header-section-number">22.5</span> When Do the Tests Disagree?</a>
  <ul class="collapse">
  <li><a href="#theoretical-sources-of-disagreement" id="toc-theoretical-sources-of-disagreement" class="nav-link" data-scroll-target="#theoretical-sources-of-disagreement"><span class="header-section-number">22.5.1</span> Theoretical Sources of Disagreement</a></li>
  <li><a href="#empirical-comparison-for-vietnam" id="toc-empirical-comparison-for-vietnam" class="nav-link" data-scroll-target="#empirical-comparison-for-vietnam"><span class="header-section-number">22.5.2</span> Empirical Comparison for Vietnam</a></li>
  <li><a href="#the-lewellen-nagel-shanken-critique" id="toc-the-lewellen-nagel-shanken-critique" class="nav-link" data-scroll-target="#the-lewellen-nagel-shanken-critique"><span class="header-section-number">22.5.3</span> The Lewellen-Nagel-Shanken Critique</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-gmm" id="toc-sec-ts-cs-gmm" class="nav-link" data-scroll-target="#sec-ts-cs-gmm"><span class="header-section-number">22.6</span> GMM-Based Tests</a>
  <ul class="collapse">
  <li><a href="#the-stochastic-discount-factor-framework" id="toc-the-stochastic-discount-factor-framework" class="nav-link" data-scroll-target="#the-stochastic-discount-factor-framework"><span class="header-section-number">22.6.1</span> The Stochastic Discount Factor Framework</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-model-comparison" id="toc-sec-ts-cs-model-comparison" class="nav-link" data-scroll-target="#sec-ts-cs-model-comparison"><span class="header-section-number">22.7</span> Model Comparison</a>
  <ul class="collapse">
  <li><a href="#the-barillas-shanken-framework" id="toc-the-barillas-shanken-framework" class="nav-link" data-scroll-target="#the-barillas-shanken-framework"><span class="header-section-number">22.7.1</span> The Barillas-Shanken Framework</a></li>
  <li><a href="#comprehensive-model-scorecard" id="toc-comprehensive-model-scorecard" class="nav-link" data-scroll-target="#comprehensive-model-scorecard"><span class="header-section-number">22.7.2</span> Comprehensive Model Scorecard</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-conditional" id="toc-sec-ts-cs-conditional" class="nav-link" data-scroll-target="#sec-ts-cs-conditional"><span class="header-section-number">22.8</span> Conditional vs.&nbsp;Unconditional Tests</a>
  <ul class="collapse">
  <li><a href="#time-varying-betas" id="toc-time-varying-betas" class="nav-link" data-scroll-target="#time-varying-betas"><span class="header-section-number">22.8.1</span> Time-Varying Betas</a></li>
  </ul></li>
  <li><a href="#sec-ts-cs-recommendations" id="toc-sec-ts-cs-recommendations" class="nav-link" data-scroll-target="#sec-ts-cs-recommendations"><span class="header-section-number">22.9</span> Practical Recommendations</a></li>
  <li><a href="#sec-ts-cs-summary" id="toc-sec-ts-cs-summary" class="nav-link" data-scroll-target="#sec-ts-cs-summary"><span class="header-section-number">22.10</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/26_time_series_vs_cross_section.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</a></li><li class="breadcrumb-item"><a href="./26_time_series_vs_cross_section.html"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we implement and compare the two dominant approaches to testing asset pricing models: time-series regressions (do factors explain individual stock or portfolio returns?) and cross-sectional regressions (do factor exposures explain expected returns?), and develop the diagnostic tools to understand when and why they disagree.</p>
</div>
</div>
<p>Every factor model makes two distinct claims. The <strong>time-series claim</strong> is that a set of factors explains the common variation in individual stock returns (i.e., when the factors move, stocks move with them in proportion to their exposures). The <strong>cross-sectional claim</strong> is that differences in average returns across stocks are explained by differences in their factor exposures (i.e., stocks that load more heavily on a factor earn higher (or lower) average returns in proportion to the factor‚Äôs risk premium).</p>
<p>These claims are logically related but empirically distinct. A factor can explain time-series variation without explaining the cross-section (if the factor‚Äôs risk premium is zero, exposure to it creates no return differential). Conversely, a characteristic can predict the cross-section of returns without operating through a traded factor (if the characteristic captures mispricing rather than risk).</p>
<p><span class="citation" data-cites="fama2020comparing">Fama and French (<a href="references.html#ref-fama2020comparing" role="doc-biblioref">2020</a>)</span> formalize this distinction and show that the two approaches can give materially different answers about which factors matter. <span class="citation" data-cites="goyal2018cross">Goyal and Jegadeesh (<a href="references.html#ref-goyal2018cross" role="doc-biblioref">2018</a>)</span> go further and demonstrate that time-series and cross-sectional tests can disagree about the same model (e.g., a factor can have a significant time-series alpha in one test and an insignificant cross-sectional premium in the other, or vice versa). Understanding <em>why</em> they disagree is essential for interpreting asset pricing evidence.</p>
<p>This chapter equips the reader with both toolkits, applied to Vietnamese data, and develops the intuition for when each is appropriate.</p>
<section id="sec-ts-cs-framework" class="level2" data-number="22.1">
<h2 data-number="22.1" class="anchored" data-anchor-id="sec-ts-cs-framework"><span class="header-section-number">22.1</span> The Two Testing Frameworks</h2>
<section id="time-series-regressions" class="level3" data-number="22.1.1">
<h3 data-number="22.1.1" class="anchored" data-anchor-id="time-series-regressions"><span class="header-section-number">22.1.1</span> Time-Series Regressions</h3>
<p>The time-series approach tests whether a factor model explains the returns of a set of test assets (typically portfolios). For each test asset <span class="math inline">\(i\)</span>, estimate:</p>
<p><span id="eq-ts-regression"><span class="math display">\[
R_{i,t} - R_{f,t} = \alpha_i + \beta_{i,1} f_{1,t} + \beta_{i,2} f_{2,t} + \ldots + \beta_{i,K} f_{K,t} + \varepsilon_{i,t}
\tag{22.1}\]</span></span></p>
<p>where <span class="math inline">\(f_{k,t}\)</span> are the <span class="math inline">\(K\)</span> factor returns. The intercept <span class="math inline">\(\alpha_i\)</span> measures the average return of asset <span class="math inline">\(i\)</span> that is <em>not</em> explained by the factors. Under the null that the model correctly prices asset <span class="math inline">\(i\)</span>, <span class="math inline">\(\alpha_i = 0\)</span>.</p>
<p>The joint test of <span class="math inline">\(H_0: \alpha_1 = \alpha_2 = \ldots = \alpha_N = 0\)</span> across all <span class="math inline">\(N\)</span> test assets is performed using the <span class="citation" data-cites="gibbons1989test">Gibbons, Ross, and Shanken (<a href="references.html#ref-gibbons1989test" role="doc-biblioref">1989</a>)</span> (GRS) test statistic:</p>
<p><span id="eq-grs"><span class="math display">\[
\text{GRS} = \frac{T - N - K}{N} \cdot \frac{1}{1 + \bar{f}' \hat{\Sigma}_f^{-1} \bar{f}} \cdot \hat{\alpha}' \hat{\Sigma}_\varepsilon^{-1} \hat{\alpha} \sim F(N, T - N - K)
\tag{22.2}\]</span></span></p>
<p>where <span class="math inline">\(\bar{f}\)</span> is the vector of factor means, <span class="math inline">\(\hat{\Sigma}_f\)</span> is the factor covariance matrix, and <span class="math inline">\(\hat{\Sigma}_\varepsilon\)</span> is the residual covariance matrix. A large GRS statistic rejects the model.</p>
</section>
<section id="cross-sectional-regressions-fama-macbeth" class="level3" data-number="22.1.2">
<h3 data-number="22.1.2" class="anchored" data-anchor-id="cross-sectional-regressions-fama-macbeth"><span class="header-section-number">22.1.2</span> Cross-Sectional Regressions (Fama-MacBeth)</h3>
<p>The <span class="citation" data-cites="fama1973risk">Fama and MacBeth (<a href="references.html#ref-fama1973risk" role="doc-biblioref">1973</a>)</span> cross-sectional approach tests whether factor exposures are priced (i.e., whether stocks with higher betas on a factor earn higher average returns). The procedure has two stages:</p>
<p><strong>Stage 1 (Time-Series).</strong> For each asset, estimate factor betas from a time-series regression over a rolling or full-sample window:</p>
<p><span id="eq-fm-stage1"><span class="math display">\[
R_{i,t} - R_{f,t} = \alpha_i + \beta_{i,1} f_{1,t} + \ldots + \beta_{i,K} f_{K,t} + \varepsilon_{i,t}
\tag{22.3}\]</span></span></p>
<p><strong>Stage 2 (Cross-Section).</strong> Each month <span class="math inline">\(t\)</span>, regress the cross-section of realized excess returns on the estimated betas:</p>
<p><span id="eq-fm-stage2"><span class="math display">\[
R_{i,t} - R_{f,t} = \gamma_{0,t} + \gamma_{1,t} \hat{\beta}_{i,1} + \ldots + \gamma_{K,t} \hat{\beta}_{i,K} + \eta_{i,t}
\tag{22.4}\]</span></span></p>
<p>The time-series averages <span class="math inline">\(\bar{\gamma}_k = \frac{1}{T} \sum_t \gamma_{k,t}\)</span> estimate the risk premia, and the standard errors use the time-series standard deviation of <span class="math inline">\(\{\gamma_{k,t}\}\)</span>.</p>
</section>
<section id="key-differences" class="level3" data-number="22.1.3">
<h3 data-number="22.1.3" class="anchored" data-anchor-id="key-differences"><span class="header-section-number">22.1.3</span> Key Differences</h3>
<div id="tbl-ts-cs-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ts-cs-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.1: Comparison of time-series and cross-sectional testing frameworks.
</figcaption>
<div aria-describedby="tbl-ts-cs-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Dimension</th>
<th>Time-Series</th>
<th>Cross-Section</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>What it tests</td>
<td>Do factors explain return variation?</td>
<td>Do factor exposures explain average returns?</td>
</tr>
<tr class="even">
<td>Key statistic</td>
<td>Alpha (intercept)</td>
<td>Risk premium (<span class="math inline">\(\gamma\)</span>)</td>
</tr>
<tr class="odd">
<td>Joint test</td>
<td>GRS F-test</td>
<td>Chi-squared on <span class="math inline">\(\gamma\)</span>‚Äôs</td>
</tr>
<tr class="even">
<td>Test assets</td>
<td>Portfolios (usually)</td>
<td>Individual stocks or portfolios</td>
</tr>
<tr class="odd">
<td>Factors</td>
<td>Must be traded returns</td>
<td>Can be non-traded (macro, characteristics)</td>
</tr>
<tr class="even">
<td>Null hypothesis</td>
<td><span class="math inline">\(\alpha_i = 0\)</span> for all <span class="math inline">\(i\)</span></td>
<td><span class="math inline">\(\gamma_k\)</span> equals factor mean return</td>
</tr>
<tr class="odd">
<td>Errors-in-variables</td>
<td>Not an issue (factors observed)</td>
<td>Estimated betas create EIV bias</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-ts-cs-data" class="level2" data-number="22.2">
<h2 data-number="22.2" class="anchored" data-anchor-id="sec-ts-cs-data"><span class="header-section-number">22.2</span> Data Construction</h2>
<div id="setup" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.linalg <span class="im">import</span> inv</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="data-load" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>factors[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(factors[<span class="st">'month_end'</span>])</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> factors.set_index(<span class="st">'month_end'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 25 size-BM portfolios (5x5 independent sorts)</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>test_portfolios_25 <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'size'</span>, <span class="st">'bm'</span>],</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">5</span>, <span class="dv">5</span>],</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 25 size-momentum portfolios</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>test_portfolios_mom <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'size'</span>, <span class="st">'momentum_12_2'</span>],</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">5</span>, <span class="dv">5</span>],</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 10 industry portfolios</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>test_portfolios_ind <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'icb_sector'</span>],</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">10</span>],</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly individual stock returns for Fama-MacBeth</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>stock_returns <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk-free rate</span></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> client.get_risk_free_rate(</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'monthly'</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factor months: </span><span class="sc">{</span><span class="bu">len</span>(factors)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"25 Size-BM portfolios: </span><span class="sc">{</span>test_portfolios_25<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"25 Size-Mom portfolios: </span><span class="sc">{</span>test_portfolios_mom<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"10 Industry portfolios: </span><span class="sc">{</span>test_portfolios_ind<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stock-months: </span><span class="sc">{</span><span class="bu">len</span>(stock_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="prepare-test-assets" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert test portfolios to excess returns</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Each portfolio set is a DataFrame: rows = months, columns = portfolios</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_test_assets(port_df, rf_df):</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert portfolio returns to excess returns matrix."""</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    port <span class="op">=</span> port_df.set_index(<span class="st">'month_end'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    rf_aligned <span class="op">=</span> rf_df.set_index(<span class="st">'month_end'</span>)[<span class="st">'rf'</span>].reindex(port.index)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> port.subtract(rf_aligned, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess.dropna()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>excess_25_bm <span class="op">=</span> prepare_test_assets(test_portfolios_25, rf)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>excess_25_mom <span class="op">=</span> prepare_test_assets(test_portfolios_mom, rf)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>excess_10_ind <span class="op">=</span> prepare_test_assets(test_portfolios_ind, rf)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size-BM test assets: </span><span class="sc">{</span>excess_25_bm<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_25_bm<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size-Mom test assets: </span><span class="sc">{</span>excess_25_mom<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_25_mom<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Industry test assets: </span><span class="sc">{</span>excess_10_ind<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_10_ind<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-ts-cs-ts-tests" class="level2" data-number="22.3">
<h2 data-number="22.3" class="anchored" data-anchor-id="sec-ts-cs-ts-tests"><span class="header-section-number">22.3</span> Time-Series Tests</h2>
<section id="full-sample-time-series-regressions" class="level3" data-number="22.3.1">
<h3 data-number="22.3.1" class="anchored" data-anchor-id="full-sample-time-series-regressions"><span class="header-section-number">22.3.1</span> Full-Sample Time-Series Regressions</h3>
<p>We begin by running full-sample time-series regressions of each test portfolio on the Fama-French five-factor model plus momentum:</p>
<div id="ts-regressions" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> time_series_regressions(excess_returns, factor_df, factor_cols,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>                              cov_type<span class="op">=</span><span class="st">'HAC'</span>, maxlags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Run time-series regressions of test assets on factors.</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns DataFrame of alphas, betas, t-stats, and R-squared.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align dates</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    X_const <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> Y[col].dropna()</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> X_const.loc[y.index]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(y, x).fit(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            cov_type<span class="op">=</span>cov_type,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>            cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: maxlags} <span class="cf">if</span> cov_type <span class="op">==</span> <span class="st">'HAC'</span> <span class="cf">else</span> {}</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>],</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha_t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha_p'</span>: model.pvalues[<span class="st">'const'</span>],</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r_squared'</span>: model.rsquared,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r_squared_adj'</span>: model.rsquared_adj</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f'beta_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[f]</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f't_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.tvalues[f]</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        results[col] <span class="op">=</span> result</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).T</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Define models to test</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CAPM'</span>: [<span class="st">'mkt_excess'</span>],</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF3'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>],</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF5'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF5+WML'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>],</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Run for 25 Size-BM portfolios</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Time-Series Alphas: 25 Size-BM Portfolios"</span>)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>ts_results <span class="op">=</span> {}</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> time_series_regressions(</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        excess_25_bm, factors, factor_cols</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    ts_results[model_name] <span class="op">=</span> result</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    mean_alpha <span class="op">=</span> result[<span class="st">'alpha'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    mean_abs_alpha <span class="op">=</span> result[<span class="st">'alpha'</span>].<span class="bu">abs</span>().mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    pct_sig <span class="op">=</span> (result[<span class="st">'alpha_p'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>).mean()</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    mean_r2 <span class="op">=</span> result[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean alpha (ann.): </span><span class="sc">{</span>mean_alpha<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean |alpha| (ann.): </span><span class="sc">{</span>mean_abs_alpha<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  % sig. at 5%: </span><span class="sc">{</span>pct_sig<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean R¬≤: </span><span class="sc">{</span>mean_r2<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="the-grs-test" class="level3" data-number="22.3.2">
<h3 data-number="22.3.2" class="anchored" data-anchor-id="the-grs-test"><span class="header-section-number">22.3.2</span> The GRS Test</h3>
<div id="grs-test" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grs_test(excess_returns, factor_df, factor_cols):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Gibbons, Ross, Shanken (1989) test of H0: all alphas = 0.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns GRS statistic, p-value, and related diagnostics.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common].values  <span class="co"># T x N</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols].values  <span class="co"># T x K</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    T, N <span class="op">=</span> Y.shape</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> F.shape[<span class="dv">1</span>]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add constant and run OLS for each asset</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    F_const <span class="op">=</span> np.column_stack([np.ones(T), F])</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OLS: beta = (X'X)^-1 X'Y</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    XtX_inv <span class="op">=</span> inv(F_const.T <span class="op">@</span> F_const)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> XtX_inv <span class="op">@</span> F_const.T <span class="op">@</span> Y  <span class="co"># (K+1) x N</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> B[<span class="dv">0</span>, :]  <span class="co"># N-vector of intercepts</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> Y <span class="op">-</span> F_const <span class="op">@</span> B  <span class="co"># T x N</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual covariance matrix</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    Sigma_eps <span class="op">=</span> residuals.T <span class="op">@</span> residuals <span class="op">/</span> (T <span class="op">-</span> K <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Factor mean and covariance</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    f_bar <span class="op">=</span> F.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    Sigma_f <span class="op">=</span> np.cov(F, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GRS statistic</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    Sigma_eps_inv <span class="op">=</span> inv(Sigma_eps)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    Sigma_f_inv <span class="op">=</span> inv(Sigma_f) <span class="cf">if</span> K <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> np.array([[<span class="dv">1</span> <span class="op">/</span> Sigma_f]])</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    sharpe_sq_alpha <span class="op">=</span> alpha <span class="op">@</span> Sigma_eps_inv <span class="op">@</span> alpha</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    sharpe_sq_f <span class="op">=</span> f_bar <span class="op">@</span> Sigma_f_inv <span class="op">@</span> f_bar <span class="cf">if</span> K <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> (f_bar[<span class="dv">0</span>] <span class="op">**</span> <span class="dv">2</span> <span class="op">/</span> Sigma_f)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    grs_stat <span class="op">=</span> ((T <span class="op">-</span> N <span class="op">-</span> K) <span class="op">/</span> N) <span class="op">*</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> sharpe_sq_f)) <span class="op">*</span> sharpe_sq_alpha</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># p-value from F distribution</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.f.cdf(grs_stat, N, T <span class="op">-</span> N <span class="op">-</span> K)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional diagnostics</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio of tangency portfolio of factors</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    sr_factors <span class="op">=</span> np.sqrt(sharpe_sq_f)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio of tangency portfolio including alphas</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    sr_alpha <span class="op">=</span> np.sqrt(sharpe_sq_alpha <span class="op">+</span> sharpe_sq_f)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GRS'</span>: grs_stat,</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'p_value'</span>: p_value,</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">'df1'</span>: N,</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">'df2'</span>: T <span class="op">-</span> N <span class="op">-</span> K,</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_abs_alpha'</span>: np.<span class="bu">abs</span>(alpha).mean(),</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_factors'</span>: sr_factors,</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_alpha_plus_factors'</span>: sr_alpha,</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_improvement'</span>: sr_alpha <span class="op">-</span> sr_factors,</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'T'</span>: T, <span class="st">'N'</span>: N, <span class="st">'K'</span>: K</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GRS for each model on each set of test assets</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GRS Test Results"</span>)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'GRS'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'p-value'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'|Œ±| ann'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'SR(f)'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'SR(Œ±+f)'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>test_asset_sets <span class="op">=</span> {</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 Size-BM'</span>: excess_25_bm,</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 Size-Mom'</span>: excess_25_mom,</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 Industry'</span>: excess_10_ind</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>grs_all <span class="op">=</span> {}</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>ta_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> grs_test(ta_data, factors, factor_cols)</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>        grs_all[key] <span class="op">=</span> result</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'GRS'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'p_value'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mean_abs_alpha'</span>]<span class="op">*</span><span class="dv">12</span><span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'sr_factors'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'sr_alpha_plus_factors'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-alpha-patterns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alpha-patterns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>ff5_result <span class="op">=</span> ts_results[<span class="st">'FF5'</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape alphas into 5x5 matrix</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>alpha_matrix <span class="op">=</span> ff5_result[<span class="st">'alpha'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>) <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>t_matrix <span class="op">=</span> ff5_result[<span class="st">'alpha_t'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Alpha magnitudes</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> axes[<span class="dv">0</span>].imshow(alpha_matrix, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>                     vmin<span class="op">=-</span>np.<span class="bu">max</span>(np.<span class="bu">abs</span>(alpha_matrix)),</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                     vmax<span class="op">=</span>np.<span class="bu">max</span>(np.<span class="bu">abs</span>(alpha_matrix)))</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        sig <span class="op">=</span> <span class="st">'*'</span> <span class="cf">if</span> <span class="bu">abs</span>(t_matrix[i, j]) <span class="op">&gt;</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>alpha_matrix[i, j]<span class="sc">:.1f}{</span>sig<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>                     ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'white'</span> <span class="cf">if</span> <span class="bu">abs</span>(alpha_matrix[i, j]) <span class="op">&gt;</span> <span class="dv">3</span> <span class="cf">else</span> <span class="st">'black'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels([<span class="st">'Growth'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Value'</span>])</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_yticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_yticklabels([<span class="st">'Small'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Big'</span>])</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Book-to-Market'</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Size'</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: FF5 Alphas (% ann.)'</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, ax<span class="op">=</span>axes[<span class="dv">0</span>], label<span class="op">=</span><span class="st">'Alpha (% ann.)'</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: R-squared</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>r2_matrix <span class="op">=</span> ff5_result[<span class="st">'r_squared'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>im2 <span class="op">=</span> axes[<span class="dv">1</span>].imshow(r2_matrix, cmap<span class="op">=</span><span class="st">'YlGn'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                       vmin<span class="op">=</span><span class="dv">50</span>, vmax<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>r2_matrix[i, j]<span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>                     ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels([<span class="st">'Growth'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Value'</span>])</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels([<span class="st">'Small'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Big'</span>])</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Book-to-Market'</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Size'</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: R-squared (%)'</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im2, ax<span class="op">=</span>axes[<span class="dv">1</span>], label<span class="op">=</span><span class="st">'R¬≤ (%)'</span>)</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-alpha-patterns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.1
</figcaption>
</figure>
</div>
</section>
<section id="model-comparison-via-grs" class="level3" data-number="22.3.3">
<h3 data-number="22.3.3" class="anchored" data-anchor-id="model-comparison-via-grs"><span class="header-section-number">22.3.3</span> Model Comparison via GRS</h3>
<div id="fig-grs-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-grs-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">list</span>(models.keys())</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>ta_names <span class="op">=</span> <span class="bu">list</span>(test_asset_sets.keys())</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(model_names))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>colors_ta <span class="op">=</span> [<span class="st">'#2C5F8A'</span>, <span class="st">'#C0392B'</span>, <span class="st">'#27AE60'</span>]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ta_name <span class="kw">in</span> <span class="bu">enumerate</span>(ta_names):</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    grs_vals <span class="op">=</span> [grs_all[<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>ta_name<span class="sc">}</span><span class="ss">"</span>][<span class="st">'GRS'</span>] <span class="cf">for</span> m <span class="kw">in</span> model_names]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax.bar(x <span class="op">+</span> i <span class="op">*</span> width, grs_vals, width, alpha<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>colors_ta[i], label<span class="op">=</span>ta_name, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x <span class="op">+</span> width)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(model_names)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'GRS Statistic'</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'GRS Test: Model Comparison Across Test Asset Sets'</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Add critical value line (5% significance)</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximate: depends on N, T, K</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="fl">1.8</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">'~5</span><span class="sc">% c</span><span class="st">ritical value'</span>)</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-grs-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.2
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-ts-cs-cs-tests" class="level2" data-number="22.4">
<h2 data-number="22.4" class="anchored" data-anchor-id="sec-ts-cs-cs-tests"><span class="header-section-number">22.4</span> Cross-Sectional Tests</h2>
<section id="fama-macbeth-with-portfolio-test-assets" class="level3" data-number="22.4.1">
<h3 data-number="22.4.1" class="anchored" data-anchor-id="fama-macbeth-with-portfolio-test-assets"><span class="header-section-number">22.4.1</span> Fama-MacBeth with Portfolio Test Assets</h3>
<p>We implement the Fama-MacBeth two-pass procedure using the 25 size-BM portfolios as test assets:</p>
<div id="fama-macbeth-portfolios" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_two_pass(excess_returns, factor_df, factor_cols,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                            beta_window<span class="op">=</span><span class="st">'full'</span>, rolling_window<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                            shanken_correction<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Fama-MacBeth (1973) two-pass cross-sectional regression.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    beta_window : str</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'full' for full-sample betas, 'rolling' for rolling betas.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    shanken_correction : bool</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply Shanken (1992) errors-in-variables correction.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Dictionary with estimated risk premia, t-statistics, and diagnostics.</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> Y.shape[<span class="dv">1</span>]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> <span class="bu">len</span>(factor_cols)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(common)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== STAGE 1: Estimate betas =====</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> beta_window <span class="op">==</span> <span class="st">'full'</span>:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Full-sample betas (simpler, used in GRS context)</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        F_const <span class="op">=</span> sm.add_constant(F)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        betas <span class="op">=</span> {}</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(Y[col], F_const).fit()</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            betas[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        beta_df <span class="op">=</span> pd.DataFrame(betas).T  <span class="co"># N x K</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Same betas used every month</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        beta_by_month <span class="op">=</span> {m: beta_df <span class="cf">for</span> m <span class="kw">in</span> months}</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> beta_window <span class="op">==</span> <span class="st">'rolling'</span>:</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rolling betas (more realistic, avoids look-ahead)</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        beta_by_month <span class="op">=</span> {}</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t_idx <span class="kw">in</span> <span class="bu">range</span>(rolling_window, T):</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            month <span class="op">=</span> months[t_idx]</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            window_start <span class="op">=</span> months[t_idx <span class="op">-</span> rolling_window]</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            Y_win <span class="op">=</span> Y.loc[window_start:months[t_idx <span class="op">-</span> <span class="dv">1</span>]]</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            F_win <span class="op">=</span> sm.add_constant(F.loc[window_start:months[t_idx <span class="op">-</span> <span class="dv">1</span>]])</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            betas_t <span class="op">=</span> {}</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                y <span class="op">=</span> Y_win[col].dropna()</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                x <span class="op">=</span> F_win.loc[y.index]</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(y) <span class="op">&lt;</span> <span class="dv">24</span>:</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>                    betas_t[col] <span class="op">=</span> {f: np.nan <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y, x).fit()</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>                betas_t[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            beta_by_month[month] <span class="op">=</span> pd.DataFrame(betas_t).T</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== STAGE 2: Cross-sectional regressions =====</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    gamma_list <span class="op">=</span> []</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> beta_by_month:</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        betas_t <span class="op">=</span> beta_by_month[month]</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        returns_t <span class="op">=</span> Y.loc[month]</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> betas_t.dropna().index.intersection(returns_t.dropna().index)</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&lt;</span> K <span class="op">+</span> <span class="dv">5</span>:</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> returns_t[valid].values</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(betas_t.loc[valid, factor_cols].values)</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>            gammas <span class="op">=</span> {<span class="st">'month'</span>: month, <span class="st">'gamma_0'</span>: model.params[<span class="dv">0</span>]}</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>                gammas[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'r_squared'</span>] <span class="op">=</span> model.rsquared</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'n_assets'</span>] <span class="op">=</span> <span class="bu">len</span>(valid)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>            gamma_list.append(gammas)</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>    gamma_df <span class="op">=</span> pd.DataFrame(gamma_list)</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(gamma_df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== INFERENCE =====</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series averages of gammas</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    gamma_cols <span class="op">=</span> [<span class="st">'gamma_0'</span>] <span class="op">+</span> [<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> f <span class="kw">in</span> factor_cols]</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> gamma_df[col]</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> g.mean()</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>        se_fm <span class="op">=</span> g.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(g))</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>        t_fm <span class="op">=</span> mean <span class="op">/</span> se_fm <span class="cf">if</span> se_fm <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        results[col] <span class="op">=</span> {</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimate'</span>: mean,</span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">'se_fm'</span>: se_fm,</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t_fm'</span>: t_fm,</span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shanken (1992) correction for errors-in-variables</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shanken_correction <span class="kw">and</span> beta_window <span class="op">==</span> <span class="st">'full'</span>:</span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        Sigma_f <span class="op">=</span> F[factor_cols].cov().values</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shanken correction factor: (1 + lambda' Sigma_f^-1 lambda)</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>        gamma_factor <span class="op">=</span> np.array([results[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>][<span class="st">'estimate'</span>]</span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>                                  <span class="cf">for</span> f <span class="kw">in</span> factor_cols])</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>            Sigma_f_inv <span class="op">=</span> inv(Sigma_f)</span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>            c_shanken <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> gamma_factor <span class="op">@</span> Sigma_f_inv <span class="op">@</span> gamma_factor</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>            c_shanken <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>            results[col][<span class="st">'se_shanken'</span>] <span class="op">=</span> results[col][<span class="st">'se_fm'</span>] <span class="op">*</span> np.sqrt(c_shanken)</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>            results[col][<span class="st">'t_shanken'</span>] <span class="op">=</span> (results[col][<span class="st">'estimate'</span>]</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>                                          <span class="op">/</span> results[col][<span class="st">'se_shanken'</span>]</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>                                          <span class="cf">if</span> results[col][<span class="st">'se_shanken'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare estimated premia to factor mean returns</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    factor_means <span class="op">=</span> F[factor_cols].mean()</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>        results[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>][<span class="st">'factor_mean'</span>] <span class="op">=</span> factor_means[f]</span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-sectional R-squared</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'avg_cs_r2'</span>] <span class="op">=</span> gamma_df[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>        <span class="st">'results'</span>: pd.DataFrame(results).T,</span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_ts'</span>: gamma_df,</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_df'</span>: beta_by_month.get(months[<span class="op">-</span><span class="dv">1</span>], <span class="va">None</span>)</span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Fama-MacBeth for each model</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth Cross-Sectional Results: 25 Size-BM Portfolios"</span>)</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>fm_results <span class="op">=</span> {}</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> beta_type <span class="kw">in</span> [<span class="st">'full'</span>, <span class="st">'rolling'</span>]:</span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>beta_type<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>        fm <span class="op">=</span> fama_macbeth_two_pass(</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a>            excess_25_bm, factors, factor_cols,</span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>            beta_window<span class="op">=</span>beta_type,</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>            rolling_window<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>            shanken_correction<span class="op">=</span>(beta_type <span class="op">==</span> <span class="st">'full'</span>)</span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fm <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>        fm_results[key] <span class="op">=</span> fm</span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> (betas: </span><span class="sc">{</span>beta_type<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> fm[<span class="st">'results'</span>]</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> res.iterrows():</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'gamma'</span> <span class="kw">in</span> idx:</span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>                t_col <span class="op">=</span> <span class="st">'t_shanken'</span> <span class="cf">if</span> <span class="st">'t_shanken'</span> <span class="kw">in</span> row <span class="kw">and</span> pd.notna(row.get(<span class="st">'t_shanken'</span>)) <span class="cf">else</span> <span class="st">'t_fm'</span></span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>                f_mean <span class="op">=</span> row.get(<span class="st">'factor_mean'</span>, <span class="st">''</span>)</span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>                f_str <span class="op">=</span> <span class="ss">f"  f_mean=</span><span class="sc">{</span>f_mean<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="bu">isinstance</span>(f_mean, <span class="bu">float</span>) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>idx<span class="sc">:&lt;16}</span><span class="ss">: Œ≥ = </span><span class="sc">{</span>row[<span class="st">'estimate'</span>]<span class="sc">:.5f}</span><span class="ss">, "</span></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>                      <span class="ss">f"t = </span><span class="sc">{</span>row[t_col]<span class="sc">:.2f}{</span>f_str<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'avg_cs_r2'</span> <span class="kw">in</span> res.index:</span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Avg CS R¬≤: </span><span class="sc">{</span>res<span class="sc">.</span>loc[<span class="st">'avg_cs_r2'</span>, <span class="st">'estimate'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="the-shanken-correction" class="level3" data-number="22.4.2">
<h3 data-number="22.4.2" class="anchored" data-anchor-id="the-shanken-correction"><span class="header-section-number">22.4.2</span> The Shanken Correction</h3>
<p>The <span class="citation" data-cites="shanken1992estimation">Shanken (<a href="references.html#ref-shanken1992estimation" role="doc-biblioref">1992</a>)</span> correction addresses the errors-in-variables (EIV) problem inherent in the two-pass procedure. Because betas are estimated with error in Stage 1, the Stage 2 standard errors are understated. The correction inflates the standard errors by a factor that depends on the estimated risk premia and the factor covariance matrix:</p>
<p><span id="eq-shanken"><span class="math display">\[
\text{Var}(\hat{\gamma})_{\text{Shanken}} = \text{Var}(\hat{\gamma})_{\text{FM}} \times \left(1 + \hat{\gamma}' \hat{\Sigma}_f^{-1} \hat{\gamma}\right)
\tag{22.5}\]</span></span></p>
<div id="shanken-impact" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Impact of Shanken Correction on t-statistics:"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t (FM)'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t (Shanken)'</span><span class="sc">:&gt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ratio'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">54</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name <span class="kw">in</span> models:</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_full"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> fm_results:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> fm_results[key][<span class="st">'results'</span>]</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> res.iterrows():</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'gamma_'</span> <span class="kw">in</span> <span class="bu">str</span>(idx) <span class="kw">and</span> idx <span class="op">!=</span> <span class="st">'gamma_0'</span>:</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            t_fm <span class="op">=</span> row.get(<span class="st">'t_fm'</span>, np.nan)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            t_sh <span class="op">=</span> row.get(<span class="st">'t_shanken'</span>, np.nan)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>            ratio <span class="op">=</span> t_fm <span class="op">/</span> t_sh <span class="cf">if</span> pd.notna(t_sh) <span class="kw">and</span> t_sh <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            factor_name <span class="op">=</span> idx.replace(<span class="st">'gamma_'</span>, <span class="st">''</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>factor_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>t_fm<span class="sc">:&gt;10.2f}</span><span class="ss"> "</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span>t_sh<span class="sc">:&gt;12.2f}</span><span class="ss"> </span><span class="sc">{</span>ratio<span class="sc">:&gt;8.2f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="fama-macbeth-with-individual-stocks" class="level3" data-number="22.4.3">
<h3 data-number="22.4.3" class="anchored" data-anchor-id="fama-macbeth-with-individual-stocks"><span class="header-section-number">22.4.3</span> Fama-MacBeth with Individual Stocks</h3>
<p>Using individual stocks instead of portfolios as test assets avoids the <span class="citation" data-cites="lewellen2010skeptical">Lewellen, Nagel, and Shanken (<a href="references.html#ref-lewellen2010skeptical" role="doc-biblioref">2010</a>)</span> critique that sorted portfolios create artificially strong factor structure:</p>
<div id="fm-individual" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_individual(stock_df, factor_df, factor_cols,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                              beta_window<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                              min_stocks<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Fama-MacBeth with individual stocks and rolling betas.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    stock_df <span class="op">=</span> stock_df.copy()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(stock_df[<span class="st">'month_end'</span>])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    factor_df <span class="op">=</span> factor_df.copy()</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(stock_df[<span class="st">'month_end'</span>].unique())</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre-compute rolling betas for all stocks</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    gamma_list <span class="op">=</span> []</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t_idx, month <span class="kw">in</span> <span class="bu">enumerate</span>(months):</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t_idx <span class="op">&lt;</span> beta_window:</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        window_months <span class="op">=</span> months[t_idx <span class="op">-</span> beta_window:t_idx]</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get betas for each stock from rolling window</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        betas_t <span class="op">=</span> {}</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> stock_df[stock_df[<span class="st">'month_end'</span>].isin(window_months)]</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> window_data.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> min_obs:</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> group.set_index(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> factor_df.loc[y.index, factor_cols]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> sm.add_constant(x)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>            valid <span class="op">=</span> y.index.intersection(x.index)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&lt;</span> min_obs:</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y[valid], x.loc[valid]).fit()</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                betas_t[ticker] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(betas_t) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        beta_df <span class="op">=</span> pd.DataFrame(betas_t).T</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current month returns</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> stock_df[stock_df[<span class="st">'month_end'</span>] <span class="op">==</span> month]</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current.set_index(<span class="st">'ticker'</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        valid_tickers <span class="op">=</span> beta_df.index.intersection(current.index)</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_tickers) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> current.loc[valid_tickers, <span class="st">'monthly_return'</span>].values</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(beta_df.loc[valid_tickers].values)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>            gammas <span class="op">=</span> {<span class="st">'month'</span>: month, <span class="st">'gamma_0'</span>: model.params[<span class="dv">0</span>]}</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                gammas[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'n_stocks'</span>] <span class="op">=</span> <span class="bu">len</span>(valid_tickers)</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'r_squared'</span>] <span class="op">=</span> model.rsquared</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>            gamma_list.append(gammas)</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    gamma_df <span class="op">=</span> pd.DataFrame(gamma_list)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>    gamma_cols <span class="op">=</span> [<span class="st">'gamma_0'</span>] <span class="op">+</span> [<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> f <span class="kw">in</span> factor_cols]</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> {}</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> gamma_df[col]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> g.mean()</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> g.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(g))</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        summary[col] <span class="op">=</span> {<span class="st">'estimate'</span>: mean, <span class="st">'se'</span>: se, <span class="st">'t'</span>: t}</span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    summary[<span class="st">'avg_n_stocks'</span>] <span class="op">=</span> gamma_df[<span class="st">'n_stocks'</span>].mean()</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>    summary[<span class="st">'avg_cs_r2'</span>] <span class="op">=</span> gamma_df[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(summary).T, gamma_df</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="co"># Run for FF5</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Fama-MacBeth with Individual Stocks (FF5):"</span>)</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>fm_ind_results, fm_ind_gamma <span class="op">=</span> fama_macbeth_individual(</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>    stock_returns, factors,</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>    beta_window<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fm_ind_results.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-ts-cs-disagreement" class="level2" data-number="22.5">
<h2 data-number="22.5" class="anchored" data-anchor-id="sec-ts-cs-disagreement"><span class="header-section-number">22.5</span> When Do the Tests Disagree?</h2>
<section id="theoretical-sources-of-disagreement" class="level3" data-number="22.5.1">
<h3 data-number="22.5.1" class="anchored" data-anchor-id="theoretical-sources-of-disagreement"><span class="header-section-number">22.5.1</span> Theoretical Sources of Disagreement</h3>
<p><span class="citation" data-cites="goyal2018cross">Goyal and Jegadeesh (<a href="references.html#ref-goyal2018cross" role="doc-biblioref">2018</a>)</span> identify three sources of discrepancy between time-series and cross-sectional tests:</p>
<p><strong>1. Factor structure of test assets.</strong> If test assets have a strong factor structure (as sorted portfolios do by construction), the cross-sectional <span class="math inline">\(R^2\)</span> will be high regardless of whether the factors truly price the assets. <span class="citation" data-cites="lewellen2010skeptical">Lewellen, Nagel, and Shanken (<a href="references.html#ref-lewellen2010skeptical" role="doc-biblioref">2010</a>)</span> show that even random factors can achieve high cross-sectional <span class="math inline">\(R^2\)</span> when test assets are size-BM sorted portfolios, because such portfolios have a strong linear structure in the size-value space.</p>
<p><strong>2. Time-variation in betas.</strong> The time-series regression assumes constant betas. If betas vary over time and co-move with the factor risk premium, the unconditional time-series alpha can be nonzero even if the conditional model holds <span class="citation" data-cites="jagannathan1996conditional">(<a href="references.html#ref-jagannathan1996conditional" role="doc-biblioref">Jagannathan and Wang 1996</a>)</span>.</p>
<p><strong>3. Misspecified risk premia.</strong> The Fama-MacBeth cross-sectional regression estimates the risk premium from the data. The time-series regression implicitly sets the risk premium equal to the factor‚Äôs sample mean return. When these differ (e.g., because the factor is not a perfect proxy for the underlying risk), the two approaches disagree.</p>
</section>
<section id="empirical-comparison-for-vietnam" class="level3" data-number="22.5.2">
<h3 data-number="22.5.2" class="anchored" data-anchor-id="empirical-comparison-for-vietnam"><span class="header-section-number">22.5.2</span> Empirical Comparison for Vietnam</h3>
<div id="ts-vs-cs" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For FF5 on 25 Size-BM portfolios:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-series: alpha from OLS regression</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-section: pricing error from Fama-MacBeth</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>ts_alphas <span class="op">=</span> ts_results[<span class="st">'FF5'</span>][<span class="st">'alpha'</span>].values <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ts_names <span class="op">=</span> ts_results[<span class="st">'FF5'</span>].index.tolist()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional pricing errors:</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted return = beta' * estimated_gamma</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Pricing error = actual mean return - predicted</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>fm_full <span class="op">=</span> fm_results.get(<span class="st">'FF5_full'</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> fm_full[<span class="st">'beta_df'</span>]  <span class="co"># N x K</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    factor_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.array([fm_full[<span class="st">'results'</span>].loc[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>, <span class="st">'estimate'</span>]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> f <span class="kw">in</span> factor_cols])</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    gamma_0 <span class="op">=</span> fm_full[<span class="st">'results'</span>].loc[<span class="st">'gamma_0'</span>, <span class="st">'estimate'</span>]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    actual_means <span class="op">=</span> excess_25_bm.mean() <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    predicted <span class="op">=</span> (gamma_0 <span class="op">+</span> betas[factor_cols].values <span class="op">@</span> gammas) <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    cs_errors <span class="op">=</span> actual_means.values <span class="op">-</span> predicted</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-ts-vs-cs" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ts-vs-cs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: TS alpha vs CS pricing error</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].scatter(ts_alphas <span class="op">*</span> <span class="dv">100</span>, cs_errors <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'#2C5F8A'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    lim <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(ts_alphas)), np.<span class="bu">max</span>(np.<span class="bu">abs</span>(cs_errors))) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="op">-</span>lim, lim], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="dv">0</span>, <span class="dv">0</span>], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="dv">0</span>, <span class="dv">0</span>], [<span class="op">-</span>lim, lim], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Time-Series Alpha (% ann.)'</span>)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Cross-Sectional Pricing Error (% ann.)'</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: TS Alpha vs CS Pricing Error'</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correlation</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    rho <span class="op">=</span> np.corrcoef(ts_alphas, cs_errors)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="ss">f'œÅ = </span><span class="sc">{</span>rho<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>                  transform<span class="op">=</span>axes[<span class="dv">0</span>].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Actual vs Predicted (CS)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].scatter(predicted <span class="op">*</span> <span class="dv">100</span>, actual_means.values <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'#C0392B'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    lim2 <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(predicted)), np.<span class="bu">max</span>(np.<span class="bu">abs</span>(actual_means))) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot([<span class="op">-</span><span class="dv">5</span>, lim2], [<span class="op">-</span><span class="dv">5</span>, lim2], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Average Return (% ann.)'</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Actual Average Return (% ann.)'</span>)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Actual vs Predicted (FM Cross-Section)'</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CS R-squared</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    ss_res <span class="op">=</span> np.<span class="bu">sum</span>((actual_means.values <span class="op">-</span> predicted) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((actual_means.values <span class="op">-</span> actual_means.values.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    r2_cs <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="ss">f'CS R¬≤ = </span><span class="sc">{</span>r2_cs<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>                  transform<span class="op">=</span>axes[<span class="dv">1</span>].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-ts-vs-cs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.3
</figcaption>
</figure>
</div>
</section>
<section id="the-lewellen-nagel-shanken-critique" class="level3" data-number="22.5.3">
<h3 data-number="22.5.3" class="anchored" data-anchor-id="the-lewellen-nagel-shanken-critique"><span class="header-section-number">22.5.3</span> The Lewellen-Nagel-Shanken Critique</h3>
<p><span class="citation" data-cites="lewellen2010skeptical">Lewellen, Nagel, and Shanken (<a href="references.html#ref-lewellen2010skeptical" role="doc-biblioref">2010</a>)</span> demonstrate that the high cross-sectional <span class="math inline">\(R^2\)</span> from Fama-MacBeth regressions on sorted portfolios can be misleading. Sorted portfolios have a strong factor structure by construction, so even irrelevant factors can produce high <span class="math inline">\(R^2\)</span>. They recommend:</p>
<ol type="1">
<li>Including industry portfolios alongside sorted portfolios to break the mechanical factor structure.</li>
<li>Constraining the estimated risk premia to equal the factor mean returns (this is what the time-series test implicitly does).</li>
<li>Reporting the cross-sectional <span class="math inline">\(R^2\)</span> from the <em>constrained</em> model alongside the unconstrained estimate.</li>
</ol>
<div id="lns-critique" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lns_diagnostic(excess_returns, factor_df, factor_cols):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Lewellen-Nagel-Shanken (2010) diagnostic:</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare unconstrained CS R¬≤ to constrained (factor mean = premium).</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Full-sample betas</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> {}</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    F_const <span class="op">=</span> sm.add_constant(F)</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(Y[col], F_const).fit()</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        betas[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    beta_mat <span class="op">=</span> pd.DataFrame(betas).T  <span class="co"># N x K</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    actual <span class="op">=</span> Y.mean() <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unconstrained: FM regression</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(beta_mat.values)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    fm_model <span class="op">=</span> sm.OLS(actual.values, X).fit()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    predicted_unc <span class="op">=</span> fm_model.fittedvalues</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    r2_unconstrained <span class="op">=</span> fm_model.rsquared</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Constrained: premium = factor mean return</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    factor_means <span class="op">=</span> F.mean().values <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    predicted_con <span class="op">=</span> beta_mat.values <span class="op">@</span> factor_means</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add best-fitting intercept</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    intercept_con <span class="op">=</span> np.mean(actual.values <span class="op">-</span> predicted_con)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    predicted_con <span class="op">+=</span> intercept_con</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    ss_res_con <span class="op">=</span> np.<span class="bu">sum</span>((actual.values <span class="op">-</span> predicted_con) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((actual.values <span class="op">-</span> actual.values.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    r2_constrained <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res_con <span class="op">/</span> ss_tot</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_unconstrained'</span>: r2_unconstrained,</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_constrained'</span>: r2_constrained,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_drop'</span>: r2_unconstrained <span class="op">-</span> r2_constrained,</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_unconstrained'</span>: fm_model.params[<span class="dv">1</span>:],</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_constrained'</span>: factor_means</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Lewellen-Nagel-Shanken Diagnostic:"</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R¬≤ (unc)'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R¬≤ (con)'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'Drop'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">58</span>)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        diag <span class="op">=</span> lns_diagnostic(ta_data, factors, factor_cols)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_unconstrained'</span>]<span class="sc">:&gt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_constrained'</span>]<span class="sc">:&gt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_drop'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-lns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="14">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-lns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>diag_ff5 <span class="op">=</span> lns_diagnostic(excess_25_bm, factors,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                            [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>])</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> excess_25_bm.mean().values <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Unconstrained</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>F_const <span class="op">=</span> sm.add_constant(factors[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]])</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>betas_full <span class="op">=</span> {}</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> excess_25_bm.columns:</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_25_bm.index.intersection(factors.index)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(excess_25_bm.loc[common, col],</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>                    F_const.loc[common]).fit()</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    betas_full[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                        [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]}</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>beta_mat <span class="op">=</span> pd.DataFrame(betas_full).T</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>X_cs <span class="op">=</span> sm.add_constant(beta_mat.values)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>fm_mod <span class="op">=</span> sm.OLS(actual, X_cs).fit()</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>pred_unc <span class="op">=</span> fm_mod.fittedvalues</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].scatter(pred_unc, actual, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>                 edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>rng_plot <span class="op">=</span> [<span class="bu">min</span>(pred_unc.<span class="bu">min</span>(), actual.<span class="bu">min</span>()) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">max</span>(pred_unc.<span class="bu">max</span>(), actual.<span class="bu">max</span>()) <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(rng_plot, rng_plot, <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted (% ann.)'</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Actual (% ann.)'</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="ss">f"Panel A: Unconstrained (R¬≤ = "</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"</span><span class="sc">{</span>diag_ff5[<span class="st">'r2_unconstrained'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Constrained</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>factor_means <span class="op">=</span> factors[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]].mean().values <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>pred_con <span class="op">=</span> beta_mat.values <span class="op">@</span> factor_means</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>pred_con <span class="op">+=</span> np.mean(actual <span class="op">-</span> pred_con)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].scatter(pred_con, actual, color<span class="op">=</span><span class="st">'#C0392B'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                 edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>rng2 <span class="op">=</span> [<span class="bu">min</span>(pred_con.<span class="bu">min</span>(), actual.<span class="bu">min</span>()) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>(pred_con.<span class="bu">max</span>(), actual.<span class="bu">max</span>()) <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(rng2, rng2, <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted (% ann.)'</span>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Actual (% ann.)'</span>)</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="ss">f"Panel B: Constrained (R¬≤ = "</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"</span><span class="sc">{</span>diag_ff5[<span class="st">'r2_constrained'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-lns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.4
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-ts-cs-gmm" class="level2" data-number="22.6">
<h2 data-number="22.6" class="anchored" data-anchor-id="sec-ts-cs-gmm"><span class="header-section-number">22.6</span> GMM-Based Tests</h2>
<section id="the-stochastic-discount-factor-framework" class="level3" data-number="22.6.1">
<h3 data-number="22.6.1" class="anchored" data-anchor-id="the-stochastic-discount-factor-framework"><span class="header-section-number">22.6.1</span> The Stochastic Discount Factor Framework</h3>
<p>Both time-series and cross-sectional tests are special cases of the <span class="citation" data-cites="hansen1982large">Hansen (<a href="references.html#ref-hansen1982large" role="doc-biblioref">1982</a>)</span> Generalized Method of Moments (GMM) framework. The fundamental pricing equation is:</p>
<p><span id="eq-sdf"><span class="math display">\[
E[M_t R_{i,t}^e] = 0 \quad \text{for all } i
\tag{22.6}\]</span></span></p>
<p>where <span class="math inline">\(M_t\)</span> is the stochastic discount factor (SDF) and <span class="math inline">\(R_{i,t}^e\)</span> is the excess return of asset <span class="math inline">\(i\)</span>. A linear factor model parameterizes the SDF as:</p>
<p><span id="eq-linear-sdf"><span class="math display">\[
M_t = 1 - b' (f_t - \mu_f)
\tag{22.7}\]</span></span></p>
<p>where <span class="math inline">\(b\)</span> is the vector of SDF loadings and <span class="math inline">\(f_t\)</span> are the factors. The GMM approach estimates <span class="math inline">\(b\)</span> by minimizing the quadratic form of the pricing errors:</p>
<p><span id="eq-gmm-objective"><span class="math display">\[
\hat{b} = \arg\min_b \ g(b)' W \ g(b)
\tag{22.8}\]</span></span></p>
<p>where <span class="math inline">\(g(b) = \frac{1}{T} \sum_t M_t(b) R_t^e\)</span> is the sample analog of the moment conditions.</p>
<div id="gmm-sdf" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gmm_sdf(excess_returns, factor_df, factor_cols,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>              weighting<span class="op">=</span><span class="st">'identity'</span>, n_iter<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    GMM estimation of the linear SDF model.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    weighting : str</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">        'identity': first-stage identity weighting matrix</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'optimal': Hansen optimal weighting (iterated)</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : int</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of GMM iterations (2 = efficient two-step)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    Re <span class="op">=</span> excess_returns.loc[common].values  <span class="co"># T x N</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols].values  <span class="co"># T x K</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    T, N <span class="op">=</span> Re.shape</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> F.shape[<span class="dv">1</span>]</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demean factors</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    F_dm <span class="op">=</span> F <span class="op">-</span> F.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Moment conditions: E[M * Re] = 0</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M = 1 - b' (f - mu_f) = 1 - b' F_dm</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> pricing_errors(b):</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        M <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> F_dm <span class="op">@</span> b  <span class="co"># T-vector</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> (M[:, np.newaxis] <span class="op">*</span> Re).mean(axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># N-vector</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> g</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GMM objective</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> np.eye(N)  <span class="co"># Initial weighting matrix</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> objective(b):</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>            g <span class="op">=</span> pricing_errors(b)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> T <span class="op">*</span> g <span class="op">@</span> W <span class="op">@</span> g</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> minimize(objective, np.zeros(K), method<span class="op">=</span><span class="st">'L-BFGS-B'</span>)</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        b_hat <span class="op">=</span> result.x</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iteration <span class="op">&lt;</span> n_iter <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update weighting matrix (Hansen optimal)</span></span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>            g_t <span class="op">=</span> np.array([(<span class="dv">1</span> <span class="op">-</span> F_dm[t] <span class="op">@</span> b_hat) <span class="op">*</span> Re[t]</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>                             <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T)])  <span class="co"># T x N</span></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            S <span class="op">=</span> np.cov(g_t, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Newey-West adjustment for serial correlation</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            max_lag <span class="op">=</span> <span class="bu">int</span>(np.floor(<span class="dv">4</span> <span class="op">*</span> (T <span class="op">/</span> <span class="dv">100</span>) <span class="op">**</span> (<span class="dv">2</span> <span class="op">/</span> <span class="dv">9</span>)))</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_lag <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> lag <span class="op">/</span> (max_lag <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>                Gamma <span class="op">=</span> np.cov(g_t[lag:].T, g_t[:<span class="op">-</span>lag].T, ddof<span class="op">=</span><span class="dv">0</span>)[:N, N:]</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>                S <span class="op">+=</span> w <span class="op">*</span> (Gamma <span class="op">+</span> Gamma.T)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>                W <span class="op">=</span> inv(S)</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>                W <span class="op">=</span> np.eye(N)</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pricing errors at optimum</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>    g_hat <span class="op">=</span> pricing_errors(b_hat)</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implied risk premia: lambda = Sigma_f @ b</span></span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    Sigma_f <span class="op">=</span> np.cov(F, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    lambda_hat <span class="op">=</span> Sigma_f <span class="op">@</span> b_hat</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># J-test (overidentification)</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> T <span class="op">*</span> g_hat <span class="op">@</span> W <span class="op">@</span> g_hat</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a>    df_J <span class="op">=</span> N <span class="op">-</span> K</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>    p_J <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.chi2.cdf(J, df_J) <span class="cf">if</span> df_J <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HJ distance (model misspecification)</span></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>    hj_dist <span class="op">=</span> np.sqrt(g_hat <span class="op">@</span> inv(np.cov(Re, rowvar<span class="op">=</span><span class="va">False</span>)) <span class="op">@</span> g_hat)</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'b_hat'</span>: b_hat,</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">'lambda_hat'</span>: lambda_hat,</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pricing_errors'</span>: g_hat,</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_stat'</span>: J,</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_pvalue'</span>: p_J,</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_df'</span>: df_J,</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hj_distance'</span>: hj_dist,</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_abs_error'</span>: np.<span class="bu">abs</span>(g_hat).mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-88"><a href="#cb15-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GMM SDF Estimation:"</span>)</span>
<span id="cb15-89"><a href="#cb15-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'J-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'J p-val'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb15-90"><a href="#cb15-90" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'HJ dist'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'|e| ann'</span><span class="sc">:&gt;10}</span><span class="ss">"</span>)</span>
<span id="cb15-91"><a href="#cb15-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">66</span>)</span>
<span id="cb15-92"><a href="#cb15-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-93"><a href="#cb15-93" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb15-94"><a href="#cb15-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb15-95"><a href="#cb15-95" aria-hidden="true" tabindex="-1"></a>        gmm <span class="op">=</span> gmm_sdf(ta_data, factors, factor_cols, n_iter<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb15-96"><a href="#cb15-96" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb15-97"><a href="#cb15-97" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>gmm[<span class="st">'J_stat'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>gmm[<span class="st">'J_pvalue'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb15-98"><a href="#cb15-98" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>gmm[<span class="st">'hj_distance'</span>]<span class="sc">:&gt;8.4f}</span><span class="ss"> </span><span class="sc">{</span>gmm[<span class="st">'mean_abs_error'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss">"</span>)</span>
<span id="cb15-99"><a href="#cb15-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb15-100"><a href="#cb15-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print implied risk premia</span></span>
<span id="cb15-101"><a href="#cb15-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb15-102"><a href="#cb15-102" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Œª_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>gmm[<span class="st">'lambda_hat'</span>][j]<span class="op">*</span><span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb15-103"><a href="#cb15-103" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"(factor mean: </span><span class="sc">{</span>factors[f]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">12</span><span class="sc">:.4f}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-ts-cs-model-comparison" class="level2" data-number="22.7">
<h2 data-number="22.7" class="anchored" data-anchor-id="sec-ts-cs-model-comparison"><span class="header-section-number">22.7</span> Model Comparison</h2>
<section id="the-barillas-shanken-framework" class="level3" data-number="22.7.1">
<h3 data-number="22.7.1" class="anchored" data-anchor-id="the-barillas-shanken-framework"><span class="header-section-number">22.7.1</span> The Barillas-Shanken Framework</h3>
<p><span class="citation" data-cites="barillas2018comparing">Barillas and Shanken (<a href="references.html#ref-barillas2018comparing" role="doc-biblioref">2018</a>)</span> propose a Bayesian framework for comparing non-nested factor models. The key insight is that model comparison should be based on the factors‚Äô ability to explain each other‚Äôs returns, not on their ability to price a fixed set of test assets. Two models differ only in their excluded factors, so the relevant comparison is whether the factors unique to each model have alpha with respect to the other model.</p>
<div id="barillas-shanken" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> barillas_shanken_compare(factor_df, model_a_cols, model_b_cols):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Barillas-Shanken (2018) pairwise model comparison.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare Model A vs Model B by testing whether the factors</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">    unique to each model have alpha with respect to the other.</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Factors unique to each model</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    unique_a <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> model_a_cols <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> model_b_cols]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    unique_b <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> model_b_cols <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> model_a_cols]</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test: do factors unique to A have alpha w.r.t. B?</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If yes, A adds value beyond B</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unique_a:</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> unique_a:</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> factor_df[f]</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(factor_df[model_b_cols])</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            common <span class="op">=</span> y.dropna().index.intersection(X.dropna().index)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y[common], X.loc[common]).fit(</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>                cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>}</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>            results[<span class="ss">f'alpha_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">_vs_B'</span>] <span class="op">=</span> {</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r2'</span>: model.rsquared</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unique_b:</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> unique_b:</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> factor_df[f]</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(factor_df[model_a_cols])</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>            common <span class="op">=</span> y.dropna().index.intersection(X.dropna().index)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y[common], X.loc[common]).fit(</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>                cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>}</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>            results[<span class="ss">f'alpha_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">_vs_A'</span>] <span class="op">=</span> {</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r2'</span>: model.rsquared</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).T</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF3 vs FF5</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Barillas-Shanken: FF3 vs FF5"</span>)</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>bs_3v5 <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>],</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_3v5.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF5 vs FF5+WML</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Barillas-Shanken: FF5 vs FF5+WML"</span>)</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>bs_5vw <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_5vw.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF3+WML vs FF5+WML</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Barillas-Shanken: FF3+WML vs FF5+WML"</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>bs_3wv5w <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>],</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_3wv5w.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="comprehensive-model-scorecard" class="level3" data-number="22.7.2">
<h3 data-number="22.7.2" class="anchored" data-anchor-id="comprehensive-model-scorecard"><span class="header-section-number">22.7.2</span> Comprehensive Model Scorecard</h3>
<div id="fig-scorecard" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="17">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scorecard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>scorecard <span class="op">=</span> {}</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {<span class="st">'Model'</span>: model_name}</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series (25 Size-BM)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    grs_result <span class="op">=</span> grs_all.get(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_25 Size-BM"</span>)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> grs_result:</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'GRS (BM)'</span>] <span class="op">=</span> grs_result[<span class="st">'GRS'</span>]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'GRS p'</span>] <span class="op">=</span> grs_result[<span class="st">'p_value'</span>]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'|Œ±| (BM)'</span>] <span class="op">=</span> grs_result[<span class="st">'mean_abs_alpha'</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-section</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    fm_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_full"</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fm_key <span class="kw">in</span> fm_results:</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'CS R¬≤ (unc)'</span>] <span class="op">=</span> fm_results[fm_key][<span class="st">'results'</span>].get(</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'avg_cs_r2'</span>, {}).get(<span class="st">'estimate'</span>, np.nan)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LNS constrained</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    lns <span class="op">=</span> lns_diagnostic(excess_25_bm, factors, factor_cols)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'CS R¬≤ (con)'</span>] <span class="op">=</span> lns[<span class="st">'r2_constrained'</span>]</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GMM</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    gmm <span class="op">=</span> gmm_sdf(excess_25_bm, factors, factor_cols, n_iter<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'HJ dist'</span>] <span class="op">=</span> gmm[<span class="st">'hj_distance'</span>]</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'J p-val'</span>] <span class="op">=</span> gmm[<span class="st">'J_pvalue'</span>]</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series R¬≤</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    ts_res <span class="op">=</span> time_series_regressions(excess_25_bm, factors, factor_cols)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'Avg R¬≤'</span>] <span class="op">=</span> ts_res[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    scorecard[model_name] <span class="op">=</span> metrics</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>scorecard_df <span class="op">=</span> pd.DataFrame(scorecard).T</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Model Scorecard:"</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scorecard_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-scorecard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.5
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-ts-cs-conditional" class="level2" data-number="22.8">
<h2 data-number="22.8" class="anchored" data-anchor-id="sec-ts-cs-conditional"><span class="header-section-number">22.8</span> Conditional vs.&nbsp;Unconditional Tests</h2>
<section id="time-varying-betas" class="level3" data-number="22.8.1">
<h3 data-number="22.8.1" class="anchored" data-anchor-id="time-varying-betas"><span class="header-section-number">22.8.1</span> Time-Varying Betas</h3>
<p>Unconditional tests assume constant betas. In practice, Vietnamese stock betas vary substantially over time due to changing market conditions, foreign ownership shifts, and sectoral rotations. We estimate rolling betas to assess the degree of time-variation:</p>
<div id="rolling-betas" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 36-month betas for the 25 Size-BM portfolios on FF5</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>rolling_window <span class="op">=</span> <span class="dv">36</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>factor_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a few representative portfolios</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>representative <span class="op">=</span> [excess_25_bm.columns[<span class="dv">0</span>],   <span class="co"># Small-Growth</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">4</span>],   <span class="co"># Small-Value</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">20</span>],  <span class="co"># Big-Growth</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">24</span>]]  <span class="co"># Big-Value</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>rolling_betas <span class="op">=</span> {}</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>common <span class="op">=</span> excess_25_bm.index.intersection(factors.index)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> port <span class="kw">in</span> representative:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    betas_t <span class="op">=</span> []</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(rolling_window, <span class="bu">len</span>(common)):</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        window <span class="op">=</span> common[t <span class="op">-</span> rolling_window:t]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> excess_25_bm.loc[window, port]</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(factors.loc[window, factor_cols])</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>            entry <span class="op">=</span> {<span class="st">'month'</span>: common[t]}</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                entry[<span class="ss">f'beta_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[f]</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            betas_t.append(entry)</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    rolling_betas[port] <span class="op">=</span> pd.DataFrame(betas_t)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-rolling-betas" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="19">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rolling-betas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'Small-Growth'</span>, <span class="st">'Small-Value'</span>, <span class="st">'Big-Growth'</span>, <span class="st">'Big-Value'</span>]</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>colors_port <span class="op">=</span> [<span class="st">'#C0392B'</span>, <span class="st">'#2C5F8A'</span>, <span class="st">'#E67E22'</span>, <span class="st">'#27AE60'</span>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (port, label, color) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(representative, labels, colors_port)):</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    rb <span class="op">=</span> rolling_betas[port]</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(pd.to_datetime(rb[<span class="st">'month'</span>]), rb[<span class="st">'beta_mkt_excess'</span>],</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">'Market Œ≤'</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    axes[i].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add HML beta</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(pd.to_datetime(rb[<span class="st">'month'</span>]), rb[<span class="st">'beta_hml'</span>],</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'HML Œ≤'</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Beta'</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(label)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    axes[i].legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Rolling 36-Month Factor Betas'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantify time-variation</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Beta Time-Variation (Std Dev of Rolling Betas):"</span>)</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> port, label <span class="kw">in</span> <span class="bu">zip</span>(representative, labels):</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    rb <span class="op">=</span> rolling_betas[port]</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    mkt_std <span class="op">=</span> rb[<span class="st">'beta_mkt_excess'</span>].std()</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    hml_std <span class="op">=</span> rb[<span class="st">'beta_hml'</span>].std()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>label<span class="sc">:&lt;15}</span><span class="ss">: œÉ(Œ≤_MKT) = </span><span class="sc">{</span>mkt_std<span class="sc">:.3f}</span><span class="ss">, œÉ(Œ≤_HML) = </span><span class="sc">{</span>hml_std<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rolling-betas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.6
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-ts-cs-recommendations" class="level2" data-number="22.9">
<h2 data-number="22.9" class="anchored" data-anchor-id="sec-ts-cs-recommendations"><span class="header-section-number">22.9</span> Practical Recommendations</h2>
<p>The analysis in this chapter yields the following guidelines for Vietnamese asset pricing research:</p>
<p><strong>Use both approaches.</strong> Time-series tests (GRS) and cross-sectional tests (Fama-MacBeth) answer different questions. Always report both. If they disagree, investigate <em>why</em> rather than cherry-picking the more favorable result.</p>
<p><strong>Be cautious with cross-sectional</strong> <span class="math inline">\(R^2\)</span>. High <span class="math inline">\(R^2\)</span> from Fama-MacBeth on sorted portfolios is nearly guaranteed by the test asset structure. Always report the <span class="citation" data-cites="lewellen2010skeptical">Lewellen, Nagel, and Shanken (<a href="references.html#ref-lewellen2010skeptical" role="doc-biblioref">2010</a>)</span> constrained <span class="math inline">\(R^2\)</span> alongside the unconstrained value. Include industry portfolios as additional test assets.</p>
<p><strong>Apply the Shanken correction.</strong> The EIV bias from estimated betas inflates Fama-MacBeth t-statistics. Always report Shanken-corrected standard errors for full-sample betas. For rolling betas, the correction is not straightforward, but the bias is smaller because beta estimation error averages out over time.</p>
<p><strong>Use individual stocks with caution.</strong> Fama-MacBeth with individual stocks avoids the Lewellen-Nagel-Shanken critique but introduces severe noise: individual Vietnamese stocks are thin, volatile, and the monthly cross-section is small (500-700). The resulting risk premia will have wide confidence intervals. Report the average number of stocks per cross-section and the cross-sectional <span class="math inline">\(R^2\)</span>.</p>
<p><strong>Examine conditional models.</strong> Rolling betas reveal substantial time-variation in Vietnamese stock exposures. If the research question is about risk compensation (does beta predict returns?), use rolling betas and control for time-variation. If the question is about model adequacy (do the factors span the mean-variance frontier?), full-sample betas and the GRS test are appropriate.</p>
<p><strong>For model selection, use Barillas-Shanken.</strong> When comparing competing factor models (e.g., FF3 vs.&nbsp;FF5), the <span class="citation" data-cites="barillas2018comparing">Barillas and Shanken (<a href="references.html#ref-barillas2018comparing" role="doc-biblioref">2018</a>)</span> approach (i.e., testing whether each model‚Äôs unique factors have alpha with respect to the other) is more informative than comparing GRS statistics on the same test assets.</p>
</section>
<section id="sec-ts-cs-summary" class="level2" data-number="22.10">
<h2 data-number="22.10" class="anchored" data-anchor-id="sec-ts-cs-summary"><span class="header-section-number">22.10</span> Summary</h2>
<div id="tbl-ts-cs-summary-tests" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ts-cs-summary-tests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.2: Summary of testing approaches for factor models.
</figcaption>
<div aria-describedby="tbl-ts-cs-summary-tests-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Test</th>
<th>Question</th>
<th>Statistic</th>
<th>Strength</th>
<th>Weakness</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>TS regression (GRS)</td>
<td>Do all alphas = 0?</td>
<td>F-statistic</td>
<td>Clean null; joint test</td>
<td>Depends on test assets</td>
</tr>
<tr class="even">
<td>Fama-MacBeth (portfolios)</td>
<td>Are betas priced?</td>
<td><span class="math inline">\(\bar{\gamma}\)</span>, t-stat</td>
<td>Estimates risk premia</td>
<td>EIV bias; LNS critique</td>
</tr>
<tr class="odd">
<td>FM (individual stocks)</td>
<td>Are betas priced?</td>
<td><span class="math inline">\(\bar{\gamma}\)</span>, t-stat</td>
<td>Avoids sorted portfolios</td>
<td>Noisy; small cross-section</td>
</tr>
<tr class="even">
<td>LNS diagnostic</td>
<td>Is CS R¬≤ spurious?</td>
<td>Constrained R¬≤</td>
<td>Reveals false positives</td>
<td>Only applicable to portfolios</td>
</tr>
<tr class="odd">
<td>GMM / SDF</td>
<td>Pricing errors jointly</td>
<td>J-stat, HJ distance</td>
<td>Flexible; model-free</td>
<td>Requires large N relative to K</td>
</tr>
<tr class="even">
<td>Barillas-Shanken</td>
<td>Which model is better?</td>
<td>Alpha of unique factors</td>
<td>Model comparison</td>
<td>Requires traded factors</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The gap between time-series and cross-sectional evidence is not a technicality‚Äîit reflects a fundamental ambiguity in what ‚Äúa factor model works‚Äù means. In a market like Vietnam, where the cross-section is small, betas are time-varying, and test assets are inherently noisy, the two approaches will often disagree. The honest researcher reports both, investigates the source of disagreement, and treats any single test result with appropriate humility.</p>
<!-- ## Exercises {#sec-ts-cs-exercises}

1.  **Characteristic vs. covariance.** Run Fama-MacBeth regressions that include both estimated factor betas *and* the raw characteristics (log market cap, book-to-market, past returns) as independent variables. Which has more explanatory power‚Äîthe betas or the characteristics? This tests the @goyal2018cross hypothesis that characteristics dominate covariances in explaining the cross-section.

2.  **Spanning with anomaly portfolios.** Use the 10 highest-t-statistic anomalies from the factor zoo chapter as test assets (instead of size-BM sorted portfolios). Run GRS tests for the CAPM, FF3, and FF5 models. Which anomalies remain unspanned?

3.  **Conditional Fama-MacBeth.** Interact factor betas with a conditioning variable (VIX, VN-Index volatility, or the SBV policy rate) to create time-varying risk premia. Does the conditional model outperform the unconditional model in cross-sectional $R^2$?

4.  **Bootstrap GRS.** The GRS test assumes multivariate normality of returns. Implement a bootstrap version: resample the time series 10,000 times and compute the empirical distribution of the GRS statistic under the null. Compare the bootstrap p-value to the asymptotic p-value. How much do they differ for Vietnamese data?

5.  **Instrumented PCA.** Implement the @kelly2019characteristics instrumented PCA (IPCA) model, which allows betas to vary with observable characteristics. Estimate the latent factors and their time-varying loadings. How many factors does IPCA select for the Vietnamese market?

6.  **Test asset sensitivity.** Run the full battery of tests (GRS, Fama-MacBeth, GMM) separately for three test asset sets: (a) 25 size-BM, (b) 25 size-momentum, (c) 25 size-profitability. Do the same models win across all test asset sets, or is model ranking test-asset-dependent?

7.  **Small-sample adjustment.** With only \~200 months of Vietnamese data, small-sample bias in the GRS test may be severe. Implement the @kan2013pricing finite-sample correction. How does the corrected GRS compare to the asymptotic version?

8.  **Global vs. local factors.** Augment the Vietnamese FF5 model with global factors (MSCI World excess return, global SMB, global HML from Kenneth French's data library). Run GRS tests with and without the global factors. Does adding global factors improve pricing of Vietnamese portfolios, as @griffin2002fama would predict? -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-barillas2018comparing" class="csl-entry" role="listitem">
Barillas, Francisco, and Jay Shanken. 2018. <span>‚ÄúComparing Asset Pricing Models.‚Äù</span> <em>The Journal of Finance</em> 73 (2): 715‚Äì54.
</div>
<div id="ref-fama2020comparing" class="csl-entry" role="listitem">
Fama, Eugene F, and Kenneth R French. 2020. <span>‚ÄúComparing Cross-Section and Time-Series Factor Models.‚Äù</span> <em>The Review of Financial Studies</em> 33 (5): 1891‚Äì1926.
</div>
<div id="ref-fama1973risk" class="csl-entry" role="listitem">
Fama, Eugene F, and James D MacBeth. 1973. <span>‚ÄúRisk, Return, and Equilibrium: Empirical Tests.‚Äù</span> <em>Journal of Political Economy</em> 81 (3): 607‚Äì36.
</div>
<div id="ref-gibbons1989test" class="csl-entry" role="listitem">
Gibbons, Michael R, Stephen A Ross, and Jay Shanken. 1989. <span>‚ÄúA Test of the Efficiency of a Given Portfolio.‚Äù</span> <em>Econometrica: Journal of the Econometric Society</em>, 1121‚Äì52.
</div>
<div id="ref-goyal2018cross" class="csl-entry" role="listitem">
Goyal, Amit, and Narasimhan Jegadeesh. 2018. <span>‚ÄúCross-Sectional and Time-Series Tests of Return Predictability: What Is the Difference?‚Äù</span> <em>The Review of Financial Studies</em> 31 (5): 1784‚Äì824.
</div>
<div id="ref-hansen1982large" class="csl-entry" role="listitem">
Hansen, Lars Peter. 1982. <span>‚ÄúLarge Sample Properties of Generalized Method of Moments Estimators.‚Äù</span> <em>Econometrica: Journal of the Econometric Society</em>, 1029‚Äì54.
</div>
<div id="ref-jagannathan1996conditional" class="csl-entry" role="listitem">
Jagannathan, Ravi, and Zhenyu Wang. 1996. <span>‚ÄúThe Conditional CAPM and the Cross-Section of Expected Returns.‚Äù</span> <em>The Journal of Finance</em> 51 (1): 3‚Äì53.
</div>
<div id="ref-lewellen2010skeptical" class="csl-entry" role="listitem">
Lewellen, Jonathan, Stefan Nagel, and Jay Shanken. 2010. <span>‚ÄúA Skeptical Appraisal of Asset Pricing Tests.‚Äù</span> <em>Journal of Financial Economics</em> 96 (2): 175‚Äì94.
</div>
<div id="ref-shanken1992estimation" class="csl-entry" role="listitem">
Shanken, Jay. 1992. <span>‚ÄúOn the Estimation of Beta-Pricing Models.‚Äù</span> <em>The Review of Financial Studies</em> 5 (1): 1‚Äì33.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LG91D0C6RB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LG91D0C6RB');
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./25_factor_zoo_and_multiple_testing.html" class="pagination-link" aria-label="Factor Zoo and Multiple Testing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./30_financial_statement_analysis.html" class="pagination-link" aria-label="Financial Statement Analysis">
        <span class="nav-page-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Time-Series vs. Cross-Sectional Factor Tests</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>In this chapter, we implement and compare the two dominant approaches to testing asset pricing models: time-series regressions (do factors explain individual stock or portfolio returns?) and cross-sectional regressions (do factor exposures explain expected returns?), and develop the diagnostic tools to understand when and why they disagree.</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>Every factor model makes two distinct claims. The **time-series claim** is that a set of factors explains the common variation in individual stock returns (i.e., when the factors move, stocks move with them in proportion to their exposures). The **cross-sectional claim** is that differences in average returns across stocks are explained by differences in their factor exposures (i.e., stocks that load more heavily on a factor earn higher (or lower) average returns in proportion to the factor's risk premium).</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>These claims are logically related but empirically distinct. A factor can explain time-series variation without explaining the cross-section (if the factor's risk premium is zero, exposure to it creates no return differential). Conversely, a characteristic can predict the cross-section of returns without operating through a traded factor (if the characteristic captures mispricing rather than risk).</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>@fama2020comparing formalize this distinction and show that the two approaches can give materially different answers about which factors matter. @goyal2018cross go further and demonstrate that time-series and cross-sectional tests can disagree about the same model (e.g., a factor can have a significant time-series alpha in one test and an insignificant cross-sectional premium in the other, or vice versa). Understanding *why* they disagree is essential for interpreting asset pricing evidence.</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>This chapter equips the reader with both toolkits, applied to Vietnamese data, and develops the intuition for when each is appropriate.</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Two Testing Frameworks {#sec-ts-cs-framework}</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time-Series Regressions</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>The time-series approach tests whether a factor model explains the returns of a set of test assets (typically portfolios). For each test asset $i$, estimate:</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>R_{i,t} - R_{f,t} = \alpha_i + \beta_{i,1} f_{1,t} + \beta_{i,2} f_{2,t} + \ldots + \beta_{i,K} f_{K,t} + \varepsilon_{i,t}</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ts-regression}</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>where $f_{k,t}$ are the $K$ factor returns. The intercept $\alpha_i$ measures the average return of asset $i$ that is *not* explained by the factors. Under the null that the model correctly prices asset $i$, $\alpha_i = 0$.</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>The joint test of $H_0: \alpha_1 = \alpha_2 = \ldots = \alpha_N = 0$ across all $N$ test assets is performed using the @gibbons1989test (GRS) test statistic:</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>\text{GRS} = \frac{T - N - K}{N} \cdot \frac{1}{1 + \bar{f}' \hat{\Sigma}_f^{-1} \bar{f}} \cdot \hat{\alpha}' \hat{\Sigma}_\varepsilon^{-1} \hat{\alpha} \sim F(N, T - N - K)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>$$ {#eq-grs}</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>where $\bar{f}$ is the vector of factor means, $\hat{\Sigma}_f$ is the factor covariance matrix, and $\hat{\Sigma}_\varepsilon$ is the residual covariance matrix. A large GRS statistic rejects the model.</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cross-Sectional Regressions (Fama-MacBeth)</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>The @fama1973risk cross-sectional approach tests whether factor exposures are priced (i.e., whether stocks with higher betas on a factor earn higher average returns). The procedure has two stages:</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>**Stage 1 (Time-Series).** For each asset, estimate factor betas from a time-series regression over a rolling or full-sample window:</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>R_{i,t} - R_{f,t} = \alpha_i + \beta_{i,1} f_{1,t} + \ldots + \beta_{i,K} f_{K,t} + \varepsilon_{i,t}</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fm-stage1}</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>**Stage 2 (Cross-Section).** Each month $t$, regress the cross-section of realized excess returns on the estimated betas:</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>R_{i,t} - R_{f,t} = \gamma_{0,t} + \gamma_{1,t} \hat{\beta}_{i,1} + \ldots + \gamma_{K,t} \hat{\beta}_{i,K} + \eta_{i,t}</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fm-stage2}</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>The time-series averages $\bar{\gamma}_k = \frac{1}{T} \sum_t \gamma_{k,t}$ estimate the risk premia, and the standard errors use the time-series standard deviation of $\{\gamma_{k,t}<span class="sc">\}</span>$.</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Differences</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Dimension <span class="pp">|</span> Time-Series <span class="pp">|</span> Cross-Section <span class="pp">|</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------------|------------------------|------------------------|</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> What it tests <span class="pp">|</span> Do factors explain return variation? <span class="pp">|</span> Do factor exposures explain average returns? <span class="pp">|</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Key statistic <span class="pp">|</span> Alpha (intercept) <span class="pp">|</span> Risk premium ($\gamma$) <span class="pp">|</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Joint test <span class="pp">|</span> GRS F-test <span class="pp">|</span> Chi-squared on $\gamma$'s <span class="pp">|</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Test assets <span class="pp">|</span> Portfolios (usually) <span class="pp">|</span> Individual stocks or portfolios <span class="pp">|</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Factors <span class="pp">|</span> Must be traded returns <span class="pp">|</span> Can be non-traded (macro, characteristics) <span class="pp">|</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Null hypothesis <span class="pp">|</span> $\alpha_i = 0$ for all $i$ <span class="pp">|</span> $\gamma_k$ equals factor mean return <span class="pp">|</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Errors-in-variables <span class="pp">|</span> Not an issue (factors observed) <span class="pp">|</span> Estimated betas create EIV bias <span class="pp">|</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>: Comparison of time-series and cross-sectional testing frameworks. {#tbl-ts-cs-comparison}</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Construction {#sec-ts-cs-data}</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure environment"</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.linalg <span class="im">import</span> inv</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-load</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load factor returns, test portfolios, and individual stock data"</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns</span></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>factors[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(factors[<span class="st">'month_end'</span>])</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> factors.set_index(<span class="st">'month_end'</span>)</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 25 size-BM portfolios (5x5 independent sorts)</span></span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>test_portfolios_25 <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'size'</span>, <span class="st">'bm'</span>],</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">5</span>, <span class="dv">5</span>],</span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 25 size-momentum portfolios</span></span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>test_portfolios_mom <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'size'</span>, <span class="st">'momentum_12_2'</span>],</span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">5</span>, <span class="dv">5</span>],</span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a><span class="co"># Test portfolios: 10 industry portfolios</span></span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>test_portfolios_ind <span class="op">=</span> client.get_sorted_portfolios(</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>    sort_vars<span class="op">=</span>[<span class="st">'icb_sector'</span>],</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a>    n_groups<span class="op">=</span>[<span class="dv">10</span>],</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly individual stock returns for Fama-MacBeth</span></span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>stock_returns <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-147"><a href="#cb20-147" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-148"><a href="#cb20-148" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-149"><a href="#cb20-149" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]</span>
<span id="cb20-150"><a href="#cb20-150" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-151"><a href="#cb20-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-152"><a href="#cb20-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Risk-free rate</span></span>
<span id="cb20-153"><a href="#cb20-153" aria-hidden="true" tabindex="-1"></a>rf <span class="op">=</span> client.get_risk_free_rate(</span>
<span id="cb20-154"><a href="#cb20-154" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb20-155"><a href="#cb20-155" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb20-156"><a href="#cb20-156" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'monthly'</span></span>
<span id="cb20-157"><a href="#cb20-157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-158"><a href="#cb20-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-159"><a href="#cb20-159" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factor months: </span><span class="sc">{</span><span class="bu">len</span>(factors)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-160"><a href="#cb20-160" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"25 Size-BM portfolios: </span><span class="sc">{</span>test_portfolios_25<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-161"><a href="#cb20-161" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"25 Size-Mom portfolios: </span><span class="sc">{</span>test_portfolios_mom<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-162"><a href="#cb20-162" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"10 Industry portfolios: </span><span class="sc">{</span>test_portfolios_ind<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-163"><a href="#cb20-163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stock-months: </span><span class="sc">{</span><span class="bu">len</span>(stock_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb20-164"><a href="#cb20-164" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-165"><a href="#cb20-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-168"><a href="#cb20-168" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-169"><a href="#cb20-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prepare-test-assets</span></span>
<span id="cb20-170"><a href="#cb20-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-171"><a href="#cb20-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Prepare excess return matrices for test portfolios"</span></span>
<span id="cb20-172"><a href="#cb20-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert test portfolios to excess returns</span></span>
<span id="cb20-173"><a href="#cb20-173" aria-hidden="true" tabindex="-1"></a><span class="co"># Each portfolio set is a DataFrame: rows = months, columns = portfolios</span></span>
<span id="cb20-174"><a href="#cb20-174" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_test_assets(port_df, rf_df):</span>
<span id="cb20-175"><a href="#cb20-175" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Convert portfolio returns to excess returns matrix."""</span></span>
<span id="cb20-176"><a href="#cb20-176" aria-hidden="true" tabindex="-1"></a>    port <span class="op">=</span> port_df.set_index(<span class="st">'month_end'</span>)</span>
<span id="cb20-177"><a href="#cb20-177" aria-hidden="true" tabindex="-1"></a>    rf_aligned <span class="op">=</span> rf_df.set_index(<span class="st">'month_end'</span>)[<span class="st">'rf'</span>].reindex(port.index)</span>
<span id="cb20-178"><a href="#cb20-178" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> port.subtract(rf_aligned, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-179"><a href="#cb20-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> excess.dropna()</span>
<span id="cb20-180"><a href="#cb20-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-181"><a href="#cb20-181" aria-hidden="true" tabindex="-1"></a>excess_25_bm <span class="op">=</span> prepare_test_assets(test_portfolios_25, rf)</span>
<span id="cb20-182"><a href="#cb20-182" aria-hidden="true" tabindex="-1"></a>excess_25_mom <span class="op">=</span> prepare_test_assets(test_portfolios_mom, rf)</span>
<span id="cb20-183"><a href="#cb20-183" aria-hidden="true" tabindex="-1"></a>excess_10_ind <span class="op">=</span> prepare_test_assets(test_portfolios_ind, rf)</span>
<span id="cb20-184"><a href="#cb20-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-185"><a href="#cb20-185" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size-BM test assets: </span><span class="sc">{</span>excess_25_bm<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb20-186"><a href="#cb20-186" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_25_bm<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb20-187"><a href="#cb20-187" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Size-Mom test assets: </span><span class="sc">{</span>excess_25_mom<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb20-188"><a href="#cb20-188" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_25_mom<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb20-189"><a href="#cb20-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Industry test assets: </span><span class="sc">{</span>excess_10_ind<span class="sc">.</span>shape[<span class="dv">1</span>]<span class="sc">}</span><span class="ss"> portfolios, "</span></span>
<span id="cb20-190"><a href="#cb20-190" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>excess_10_ind<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb20-191"><a href="#cb20-191" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-192"><a href="#cb20-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-193"><a href="#cb20-193" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time-Series Tests {#sec-ts-cs-ts-tests}</span></span>
<span id="cb20-194"><a href="#cb20-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-195"><a href="#cb20-195" aria-hidden="true" tabindex="-1"></a><span class="fu">### Full-Sample Time-Series Regressions</span></span>
<span id="cb20-196"><a href="#cb20-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-197"><a href="#cb20-197" aria-hidden="true" tabindex="-1"></a>We begin by running full-sample time-series regressions of each test portfolio on the Fama-French five-factor model plus momentum:</span>
<span id="cb20-198"><a href="#cb20-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-201"><a href="#cb20-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-202"><a href="#cb20-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ts-regressions</span></span>
<span id="cb20-203"><a href="#cb20-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-204"><a href="#cb20-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Run time-series regressions for all test portfolios"</span></span>
<span id="cb20-205"><a href="#cb20-205" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> time_series_regressions(excess_returns, factor_df, factor_cols,</span>
<span id="cb20-206"><a href="#cb20-206" aria-hidden="true" tabindex="-1"></a>                              cov_type<span class="op">=</span><span class="st">'HAC'</span>, maxlags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb20-207"><a href="#cb20-207" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-208"><a href="#cb20-208" aria-hidden="true" tabindex="-1"></a><span class="co">    Run time-series regressions of test assets on factors.</span></span>
<span id="cb20-209"><a href="#cb20-209" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-210"><a href="#cb20-210" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns DataFrame of alphas, betas, t-stats, and R-squared.</span></span>
<span id="cb20-211"><a href="#cb20-211" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-212"><a href="#cb20-212" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align dates</span></span>
<span id="cb20-213"><a href="#cb20-213" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb20-214"><a href="#cb20-214" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb20-215"><a href="#cb20-215" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb20-216"><a href="#cb20-216" aria-hidden="true" tabindex="-1"></a>    X_const <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb20-217"><a href="#cb20-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-218"><a href="#cb20-218" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb20-219"><a href="#cb20-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb20-220"><a href="#cb20-220" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> Y[col].dropna()</span>
<span id="cb20-221"><a href="#cb20-221" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> X_const.loc[y.index]</span>
<span id="cb20-222"><a href="#cb20-222" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-223"><a href="#cb20-223" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(y, x).fit(</span>
<span id="cb20-224"><a href="#cb20-224" aria-hidden="true" tabindex="-1"></a>            cov_type<span class="op">=</span>cov_type,</span>
<span id="cb20-225"><a href="#cb20-225" aria-hidden="true" tabindex="-1"></a>            cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: maxlags} <span class="cf">if</span> cov_type <span class="op">==</span> <span class="st">'HAC'</span> <span class="cf">else</span> {}</span>
<span id="cb20-226"><a href="#cb20-226" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-227"><a href="#cb20-227" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-228"><a href="#cb20-228" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> {</span>
<span id="cb20-229"><a href="#cb20-229" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>],</span>
<span id="cb20-230"><a href="#cb20-230" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha_t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb20-231"><a href="#cb20-231" aria-hidden="true" tabindex="-1"></a>            <span class="st">'alpha_p'</span>: model.pvalues[<span class="st">'const'</span>],</span>
<span id="cb20-232"><a href="#cb20-232" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r_squared'</span>: model.rsquared,</span>
<span id="cb20-233"><a href="#cb20-233" aria-hidden="true" tabindex="-1"></a>            <span class="st">'r_squared_adj'</span>: model.rsquared_adj</span>
<span id="cb20-234"><a href="#cb20-234" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-235"><a href="#cb20-235" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb20-236"><a href="#cb20-236" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f'beta_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[f]</span>
<span id="cb20-237"><a href="#cb20-237" aria-hidden="true" tabindex="-1"></a>            result[<span class="ss">f't_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.tvalues[f]</span>
<span id="cb20-238"><a href="#cb20-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-239"><a href="#cb20-239" aria-hidden="true" tabindex="-1"></a>        results[col] <span class="op">=</span> result</span>
<span id="cb20-240"><a href="#cb20-240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-241"><a href="#cb20-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).T</span>
<span id="cb20-242"><a href="#cb20-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-243"><a href="#cb20-243" aria-hidden="true" tabindex="-1"></a><span class="co"># Define models to test</span></span>
<span id="cb20-244"><a href="#cb20-244" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> {</span>
<span id="cb20-245"><a href="#cb20-245" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CAPM'</span>: [<span class="st">'mkt_excess'</span>],</span>
<span id="cb20-246"><a href="#cb20-246" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF3'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>],</span>
<span id="cb20-247"><a href="#cb20-247" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF5'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb20-248"><a href="#cb20-248" aria-hidden="true" tabindex="-1"></a>    <span class="st">'FF5+WML'</span>: [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>],</span>
<span id="cb20-249"><a href="#cb20-249" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-250"><a href="#cb20-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-251"><a href="#cb20-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Run for 25 Size-BM portfolios</span></span>
<span id="cb20-252"><a href="#cb20-252" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Time-Series Alphas: 25 Size-BM Portfolios"</span>)</span>
<span id="cb20-253"><a href="#cb20-253" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb20-254"><a href="#cb20-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-255"><a href="#cb20-255" aria-hidden="true" tabindex="-1"></a>ts_results <span class="op">=</span> {}</span>
<span id="cb20-256"><a href="#cb20-256" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-257"><a href="#cb20-257" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> time_series_regressions(</span>
<span id="cb20-258"><a href="#cb20-258" aria-hidden="true" tabindex="-1"></a>        excess_25_bm, factors, factor_cols</span>
<span id="cb20-259"><a href="#cb20-259" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-260"><a href="#cb20-260" aria-hidden="true" tabindex="-1"></a>    ts_results[model_name] <span class="op">=</span> result</span>
<span id="cb20-261"><a href="#cb20-261" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-262"><a href="#cb20-262" aria-hidden="true" tabindex="-1"></a>    mean_alpha <span class="op">=</span> result[<span class="st">'alpha'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-263"><a href="#cb20-263" aria-hidden="true" tabindex="-1"></a>    mean_abs_alpha <span class="op">=</span> result[<span class="st">'alpha'</span>].<span class="bu">abs</span>().mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-264"><a href="#cb20-264" aria-hidden="true" tabindex="-1"></a>    pct_sig <span class="op">=</span> (result[<span class="st">'alpha_p'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>).mean()</span>
<span id="cb20-265"><a href="#cb20-265" aria-hidden="true" tabindex="-1"></a>    mean_r2 <span class="op">=</span> result[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb20-266"><a href="#cb20-266" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-267"><a href="#cb20-267" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb20-268"><a href="#cb20-268" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean alpha (ann.): </span><span class="sc">{</span>mean_alpha<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-269"><a href="#cb20-269" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean |alpha| (ann.): </span><span class="sc">{</span>mean_abs_alpha<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-270"><a href="#cb20-270" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  % sig. at 5%: </span><span class="sc">{</span>pct_sig<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb20-271"><a href="#cb20-271" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean R¬≤: </span><span class="sc">{</span>mean_r2<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-272"><a href="#cb20-272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-273"><a href="#cb20-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-274"><a href="#cb20-274" aria-hidden="true" tabindex="-1"></a><span class="fu">### The GRS Test</span></span>
<span id="cb20-275"><a href="#cb20-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-278"><a href="#cb20-278" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-279"><a href="#cb20-279" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: grs-test</span></span>
<span id="cb20-280"><a href="#cb20-280" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-281"><a href="#cb20-281" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement and compute the GRS test statistic"</span></span>
<span id="cb20-282"><a href="#cb20-282" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> grs_test(excess_returns, factor_df, factor_cols):</span>
<span id="cb20-283"><a href="#cb20-283" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-284"><a href="#cb20-284" aria-hidden="true" tabindex="-1"></a><span class="co">    Gibbons, Ross, Shanken (1989) test of H0: all alphas = 0.</span></span>
<span id="cb20-285"><a href="#cb20-285" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-286"><a href="#cb20-286" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns GRS statistic, p-value, and related diagnostics.</span></span>
<span id="cb20-287"><a href="#cb20-287" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-288"><a href="#cb20-288" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb20-289"><a href="#cb20-289" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common].values  <span class="co"># T x N</span></span>
<span id="cb20-290"><a href="#cb20-290" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols].values  <span class="co"># T x K</span></span>
<span id="cb20-291"><a href="#cb20-291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-292"><a href="#cb20-292" aria-hidden="true" tabindex="-1"></a>    T, N <span class="op">=</span> Y.shape</span>
<span id="cb20-293"><a href="#cb20-293" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> F.shape[<span class="dv">1</span>]</span>
<span id="cb20-294"><a href="#cb20-294" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-295"><a href="#cb20-295" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add constant and run OLS for each asset</span></span>
<span id="cb20-296"><a href="#cb20-296" aria-hidden="true" tabindex="-1"></a>    F_const <span class="op">=</span> np.column_stack([np.ones(T), F])</span>
<span id="cb20-297"><a href="#cb20-297" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-298"><a href="#cb20-298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># OLS: beta = (X'X)^-1 X'Y</span></span>
<span id="cb20-299"><a href="#cb20-299" aria-hidden="true" tabindex="-1"></a>    XtX_inv <span class="op">=</span> inv(F_const.T <span class="op">@</span> F_const)</span>
<span id="cb20-300"><a href="#cb20-300" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> XtX_inv <span class="op">@</span> F_const.T <span class="op">@</span> Y  <span class="co"># (K+1) x N</span></span>
<span id="cb20-301"><a href="#cb20-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-302"><a href="#cb20-302" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> B[<span class="dv">0</span>, :]  <span class="co"># N-vector of intercepts</span></span>
<span id="cb20-303"><a href="#cb20-303" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> Y <span class="op">-</span> F_const <span class="op">@</span> B  <span class="co"># T x N</span></span>
<span id="cb20-304"><a href="#cb20-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-305"><a href="#cb20-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Residual covariance matrix</span></span>
<span id="cb20-306"><a href="#cb20-306" aria-hidden="true" tabindex="-1"></a>    Sigma_eps <span class="op">=</span> residuals.T <span class="op">@</span> residuals <span class="op">/</span> (T <span class="op">-</span> K <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb20-307"><a href="#cb20-307" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-308"><a href="#cb20-308" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Factor mean and covariance</span></span>
<span id="cb20-309"><a href="#cb20-309" aria-hidden="true" tabindex="-1"></a>    f_bar <span class="op">=</span> F.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-310"><a href="#cb20-310" aria-hidden="true" tabindex="-1"></a>    Sigma_f <span class="op">=</span> np.cov(F, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-311"><a href="#cb20-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-312"><a href="#cb20-312" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GRS statistic</span></span>
<span id="cb20-313"><a href="#cb20-313" aria-hidden="true" tabindex="-1"></a>    Sigma_eps_inv <span class="op">=</span> inv(Sigma_eps)</span>
<span id="cb20-314"><a href="#cb20-314" aria-hidden="true" tabindex="-1"></a>    Sigma_f_inv <span class="op">=</span> inv(Sigma_f) <span class="cf">if</span> K <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> np.array([[<span class="dv">1</span> <span class="op">/</span> Sigma_f]])</span>
<span id="cb20-315"><a href="#cb20-315" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-316"><a href="#cb20-316" aria-hidden="true" tabindex="-1"></a>    sharpe_sq_alpha <span class="op">=</span> alpha <span class="op">@</span> Sigma_eps_inv <span class="op">@</span> alpha</span>
<span id="cb20-317"><a href="#cb20-317" aria-hidden="true" tabindex="-1"></a>    sharpe_sq_f <span class="op">=</span> f_bar <span class="op">@</span> Sigma_f_inv <span class="op">@</span> f_bar <span class="cf">if</span> K <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> (f_bar[<span class="dv">0</span>] <span class="op">**</span> <span class="dv">2</span> <span class="op">/</span> Sigma_f)</span>
<span id="cb20-318"><a href="#cb20-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-319"><a href="#cb20-319" aria-hidden="true" tabindex="-1"></a>    grs_stat <span class="op">=</span> ((T <span class="op">-</span> N <span class="op">-</span> K) <span class="op">/</span> N) <span class="op">*</span> (<span class="dv">1</span> <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> sharpe_sq_f)) <span class="op">*</span> sharpe_sq_alpha</span>
<span id="cb20-320"><a href="#cb20-320" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-321"><a href="#cb20-321" aria-hidden="true" tabindex="-1"></a>    <span class="co"># p-value from F distribution</span></span>
<span id="cb20-322"><a href="#cb20-322" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.f.cdf(grs_stat, N, T <span class="op">-</span> N <span class="op">-</span> K)</span>
<span id="cb20-323"><a href="#cb20-323" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-324"><a href="#cb20-324" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Additional diagnostics</span></span>
<span id="cb20-325"><a href="#cb20-325" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio of tangency portfolio of factors</span></span>
<span id="cb20-326"><a href="#cb20-326" aria-hidden="true" tabindex="-1"></a>    sr_factors <span class="op">=</span> np.sqrt(sharpe_sq_f)</span>
<span id="cb20-327"><a href="#cb20-327" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio of tangency portfolio including alphas</span></span>
<span id="cb20-328"><a href="#cb20-328" aria-hidden="true" tabindex="-1"></a>    sr_alpha <span class="op">=</span> np.sqrt(sharpe_sq_alpha <span class="op">+</span> sharpe_sq_f)</span>
<span id="cb20-329"><a href="#cb20-329" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-330"><a href="#cb20-330" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-331"><a href="#cb20-331" aria-hidden="true" tabindex="-1"></a>        <span class="st">'GRS'</span>: grs_stat,</span>
<span id="cb20-332"><a href="#cb20-332" aria-hidden="true" tabindex="-1"></a>        <span class="st">'p_value'</span>: p_value,</span>
<span id="cb20-333"><a href="#cb20-333" aria-hidden="true" tabindex="-1"></a>        <span class="st">'df1'</span>: N,</span>
<span id="cb20-334"><a href="#cb20-334" aria-hidden="true" tabindex="-1"></a>        <span class="st">'df2'</span>: T <span class="op">-</span> N <span class="op">-</span> K,</span>
<span id="cb20-335"><a href="#cb20-335" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_abs_alpha'</span>: np.<span class="bu">abs</span>(alpha).mean(),</span>
<span id="cb20-336"><a href="#cb20-336" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_factors'</span>: sr_factors,</span>
<span id="cb20-337"><a href="#cb20-337" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_alpha_plus_factors'</span>: sr_alpha,</span>
<span id="cb20-338"><a href="#cb20-338" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sr_improvement'</span>: sr_alpha <span class="op">-</span> sr_factors,</span>
<span id="cb20-339"><a href="#cb20-339" aria-hidden="true" tabindex="-1"></a>        <span class="st">'T'</span>: T, <span class="st">'N'</span>: N, <span class="st">'K'</span>: K</span>
<span id="cb20-340"><a href="#cb20-340" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-341"><a href="#cb20-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-342"><a href="#cb20-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Run GRS for each model on each set of test assets</span></span>
<span id="cb20-343"><a href="#cb20-343" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GRS Test Results"</span>)</span>
<span id="cb20-344"><a href="#cb20-344" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb20-345"><a href="#cb20-345" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'GRS'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'p-value'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb20-346"><a href="#cb20-346" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'|Œ±| ann'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'SR(f)'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'SR(Œ±+f)'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb20-347"><a href="#cb20-347" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb20-348"><a href="#cb20-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-349"><a href="#cb20-349" aria-hidden="true" tabindex="-1"></a>test_asset_sets <span class="op">=</span> {</span>
<span id="cb20-350"><a href="#cb20-350" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 Size-BM'</span>: excess_25_bm,</span>
<span id="cb20-351"><a href="#cb20-351" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 Size-Mom'</span>: excess_25_mom,</span>
<span id="cb20-352"><a href="#cb20-352" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 Industry'</span>: excess_10_ind</span>
<span id="cb20-353"><a href="#cb20-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-354"><a href="#cb20-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-355"><a href="#cb20-355" aria-hidden="true" tabindex="-1"></a>grs_all <span class="op">=</span> {}</span>
<span id="cb20-356"><a href="#cb20-356" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-357"><a href="#cb20-357" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb20-358"><a href="#cb20-358" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>ta_name<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb20-359"><a href="#cb20-359" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> grs_test(ta_data, factors, factor_cols)</span>
<span id="cb20-360"><a href="#cb20-360" aria-hidden="true" tabindex="-1"></a>        grs_all[key] <span class="op">=</span> result</span>
<span id="cb20-361"><a href="#cb20-361" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-362"><a href="#cb20-362" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb20-363"><a href="#cb20-363" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'GRS'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>result[<span class="st">'p_value'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb20-364"><a href="#cb20-364" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'mean_abs_alpha'</span>]<span class="op">*</span><span class="dv">12</span><span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb20-365"><a href="#cb20-365" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'sr_factors'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss"> "</span></span>
<span id="cb20-366"><a href="#cb20-366" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>result[<span class="st">'sr_alpha_plus_factors'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-367"><a href="#cb20-367" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-368"><a href="#cb20-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-371"><a href="#cb20-371" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-372"><a href="#cb20-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-alpha-patterns</span></span>
<span id="cb20-373"><a href="#cb20-373" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-374"><a href="#cb20-374" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Time-series alphas from the Fama-French five-factor model for the 25 size-BM portfolios. Each cell represents a portfolio formed by independently sorting on size (rows, small to big) and book-to-market (columns, growth to value). Significant alphas (|t| &gt; 2) are marked with asterisks. Systematic patterns in the alpha matrix reveal dimensions of expected returns that the model fails to capture."</span></span>
<span id="cb20-375"><a href="#cb20-375" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot the alpha matrix for Size-BM portfolios"</span></span>
<span id="cb20-376"><a href="#cb20-376" aria-hidden="true" tabindex="-1"></a>ff5_result <span class="op">=</span> ts_results[<span class="st">'FF5'</span>]</span>
<span id="cb20-377"><a href="#cb20-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-378"><a href="#cb20-378" aria-hidden="true" tabindex="-1"></a><span class="co"># Reshape alphas into 5x5 matrix</span></span>
<span id="cb20-379"><a href="#cb20-379" aria-hidden="true" tabindex="-1"></a>alpha_matrix <span class="op">=</span> ff5_result[<span class="st">'alpha'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>) <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-380"><a href="#cb20-380" aria-hidden="true" tabindex="-1"></a>t_matrix <span class="op">=</span> ff5_result[<span class="st">'alpha_t'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>)</span>
<span id="cb20-381"><a href="#cb20-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-382"><a href="#cb20-382" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb20-383"><a href="#cb20-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-384"><a href="#cb20-384" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Alpha magnitudes</span></span>
<span id="cb20-385"><a href="#cb20-385" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> axes[<span class="dv">0</span>].imshow(alpha_matrix, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb20-386"><a href="#cb20-386" aria-hidden="true" tabindex="-1"></a>                     vmin<span class="op">=-</span>np.<span class="bu">max</span>(np.<span class="bu">abs</span>(alpha_matrix)),</span>
<span id="cb20-387"><a href="#cb20-387" aria-hidden="true" tabindex="-1"></a>                     vmax<span class="op">=</span>np.<span class="bu">max</span>(np.<span class="bu">abs</span>(alpha_matrix)))</span>
<span id="cb20-388"><a href="#cb20-388" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb20-389"><a href="#cb20-389" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb20-390"><a href="#cb20-390" aria-hidden="true" tabindex="-1"></a>        sig <span class="op">=</span> <span class="st">'*'</span> <span class="cf">if</span> <span class="bu">abs</span>(t_matrix[i, j]) <span class="op">&gt;</span> <span class="dv">2</span> <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb20-391"><a href="#cb20-391" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">0</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>alpha_matrix[i, j]<span class="sc">:.1f}{</span>sig<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb20-392"><a href="#cb20-392" aria-hidden="true" tabindex="-1"></a>                     ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb20-393"><a href="#cb20-393" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'white'</span> <span class="cf">if</span> <span class="bu">abs</span>(alpha_matrix[i, j]) <span class="op">&gt;</span> <span class="dv">3</span> <span class="cf">else</span> <span class="st">'black'</span>)</span>
<span id="cb20-394"><a href="#cb20-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-395"><a href="#cb20-395" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb20-396"><a href="#cb20-396" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels([<span class="st">'Growth'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Value'</span>])</span>
<span id="cb20-397"><a href="#cb20-397" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_yticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb20-398"><a href="#cb20-398" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_yticklabels([<span class="st">'Small'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Big'</span>])</span>
<span id="cb20-399"><a href="#cb20-399" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Book-to-Market'</span>)</span>
<span id="cb20-400"><a href="#cb20-400" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Size'</span>)</span>
<span id="cb20-401"><a href="#cb20-401" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: FF5 Alphas (% ann.)'</span>)</span>
<span id="cb20-402"><a href="#cb20-402" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, ax<span class="op">=</span>axes[<span class="dv">0</span>], label<span class="op">=</span><span class="st">'Alpha (% ann.)'</span>)</span>
<span id="cb20-403"><a href="#cb20-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-404"><a href="#cb20-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: R-squared</span></span>
<span id="cb20-405"><a href="#cb20-405" aria-hidden="true" tabindex="-1"></a>r2_matrix <span class="op">=</span> ff5_result[<span class="st">'r_squared'</span>].values.reshape(<span class="dv">5</span>, <span class="dv">5</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-406"><a href="#cb20-406" aria-hidden="true" tabindex="-1"></a>im2 <span class="op">=</span> axes[<span class="dv">1</span>].imshow(r2_matrix, cmap<span class="op">=</span><span class="st">'YlGn'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb20-407"><a href="#cb20-407" aria-hidden="true" tabindex="-1"></a>                       vmin<span class="op">=</span><span class="dv">50</span>, vmax<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb20-408"><a href="#cb20-408" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb20-409"><a href="#cb20-409" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb20-410"><a href="#cb20-410" aria-hidden="true" tabindex="-1"></a>        axes[<span class="dv">1</span>].text(j, i, <span class="ss">f'</span><span class="sc">{</span>r2_matrix[i, j]<span class="sc">:.0f}</span><span class="ss">%'</span>,</span>
<span id="cb20-411"><a href="#cb20-411" aria-hidden="true" tabindex="-1"></a>                     ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb20-412"><a href="#cb20-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-413"><a href="#cb20-413" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb20-414"><a href="#cb20-414" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels([<span class="st">'Growth'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Value'</span>])</span>
<span id="cb20-415"><a href="#cb20-415" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="dv">5</span>))</span>
<span id="cb20-416"><a href="#cb20-416" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels([<span class="st">'Small'</span>, <span class="st">'2'</span>, <span class="st">'3'</span>, <span class="st">'4'</span>, <span class="st">'Big'</span>])</span>
<span id="cb20-417"><a href="#cb20-417" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Book-to-Market'</span>)</span>
<span id="cb20-418"><a href="#cb20-418" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Size'</span>)</span>
<span id="cb20-419"><a href="#cb20-419" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: R-squared (%)'</span>)</span>
<span id="cb20-420"><a href="#cb20-420" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im2, ax<span class="op">=</span>axes[<span class="dv">1</span>], label<span class="op">=</span><span class="st">'R¬≤ (%)'</span>)</span>
<span id="cb20-421"><a href="#cb20-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-422"><a href="#cb20-422" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-423"><a href="#cb20-423" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-424"><a href="#cb20-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-425"><a href="#cb20-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-426"><a href="#cb20-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### Model Comparison via GRS</span></span>
<span id="cb20-427"><a href="#cb20-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-430"><a href="#cb20-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-431"><a href="#cb20-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-grs-comparison</span></span>
<span id="cb20-432"><a href="#cb20-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-433"><a href="#cb20-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "GRS test statistics across models and test asset sets. Lower GRS values indicate better model performance (fewer unexplained pricing errors). The FF5+WML model generally produces the lowest GRS, but no model fully prices all test asset sets‚Äîconsistent with the U.S. evidence that no existing model eliminates all alphas."</span></span>
<span id="cb20-434"><a href="#cb20-434" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize GRS statistics across models and test assets"</span></span>
<span id="cb20-435"><a href="#cb20-435" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb20-436"><a href="#cb20-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-437"><a href="#cb20-437" aria-hidden="true" tabindex="-1"></a>model_names <span class="op">=</span> <span class="bu">list</span>(models.keys())</span>
<span id="cb20-438"><a href="#cb20-438" aria-hidden="true" tabindex="-1"></a>ta_names <span class="op">=</span> <span class="bu">list</span>(test_asset_sets.keys())</span>
<span id="cb20-439"><a href="#cb20-439" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(model_names))</span>
<span id="cb20-440"><a href="#cb20-440" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb20-441"><a href="#cb20-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-442"><a href="#cb20-442" aria-hidden="true" tabindex="-1"></a>colors_ta <span class="op">=</span> [<span class="st">'#2C5F8A'</span>, <span class="st">'#C0392B'</span>, <span class="st">'#27AE60'</span>]</span>
<span id="cb20-443"><a href="#cb20-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-444"><a href="#cb20-444" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ta_name <span class="kw">in</span> <span class="bu">enumerate</span>(ta_names):</span>
<span id="cb20-445"><a href="#cb20-445" aria-hidden="true" tabindex="-1"></a>    grs_vals <span class="op">=</span> [grs_all[<span class="ss">f"</span><span class="sc">{</span>m<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>ta_name<span class="sc">}</span><span class="ss">"</span>][<span class="st">'GRS'</span>] <span class="cf">for</span> m <span class="kw">in</span> model_names]</span>
<span id="cb20-446"><a href="#cb20-446" aria-hidden="true" tabindex="-1"></a>    bars <span class="op">=</span> ax.bar(x <span class="op">+</span> i <span class="op">*</span> width, grs_vals, width, alpha<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb20-447"><a href="#cb20-447" aria-hidden="true" tabindex="-1"></a>                   color<span class="op">=</span>colors_ta[i], label<span class="op">=</span>ta_name, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-448"><a href="#cb20-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-449"><a href="#cb20-449" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x <span class="op">+</span> width)</span>
<span id="cb20-450"><a href="#cb20-450" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(model_names)</span>
<span id="cb20-451"><a href="#cb20-451" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'GRS Statistic'</span>)</span>
<span id="cb20-452"><a href="#cb20-452" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'GRS Test: Model Comparison Across Test Asset Sets'</span>)</span>
<span id="cb20-453"><a href="#cb20-453" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb20-454"><a href="#cb20-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-455"><a href="#cb20-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Add critical value line (5% significance)</span></span>
<span id="cb20-456"><a href="#cb20-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximate: depends on N, T, K</span></span>
<span id="cb20-457"><a href="#cb20-457" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="fl">1.8</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb20-458"><a href="#cb20-458" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">'~5</span><span class="sc">% c</span><span class="st">ritical value'</span>)</span>
<span id="cb20-459"><a href="#cb20-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-460"><a href="#cb20-460" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-461"><a href="#cb20-461" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-462"><a href="#cb20-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-463"><a href="#cb20-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-464"><a href="#cb20-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross-Sectional Tests {#sec-ts-cs-cs-tests}</span></span>
<span id="cb20-465"><a href="#cb20-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-466"><a href="#cb20-466" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fama-MacBeth with Portfolio Test Assets</span></span>
<span id="cb20-467"><a href="#cb20-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-468"><a href="#cb20-468" aria-hidden="true" tabindex="-1"></a>We implement the Fama-MacBeth two-pass procedure using the 25 size-BM portfolios as test assets:</span>
<span id="cb20-469"><a href="#cb20-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-472"><a href="#cb20-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-473"><a href="#cb20-473" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fama-macbeth-portfolios</span></span>
<span id="cb20-474"><a href="#cb20-474" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-475"><a href="#cb20-475" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Full Fama-MacBeth two-pass procedure on portfolio test assets"</span></span>
<span id="cb20-476"><a href="#cb20-476" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_two_pass(excess_returns, factor_df, factor_cols,</span>
<span id="cb20-477"><a href="#cb20-477" aria-hidden="true" tabindex="-1"></a>                            beta_window<span class="op">=</span><span class="st">'full'</span>, rolling_window<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb20-478"><a href="#cb20-478" aria-hidden="true" tabindex="-1"></a>                            shanken_correction<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb20-479"><a href="#cb20-479" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-480"><a href="#cb20-480" aria-hidden="true" tabindex="-1"></a><span class="co">    Fama-MacBeth (1973) two-pass cross-sectional regression.</span></span>
<span id="cb20-481"><a href="#cb20-481" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-482"><a href="#cb20-482" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-483"><a href="#cb20-483" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-484"><a href="#cb20-484" aria-hidden="true" tabindex="-1"></a><span class="co">    beta_window : str</span></span>
<span id="cb20-485"><a href="#cb20-485" aria-hidden="true" tabindex="-1"></a><span class="co">        'full' for full-sample betas, 'rolling' for rolling betas.</span></span>
<span id="cb20-486"><a href="#cb20-486" aria-hidden="true" tabindex="-1"></a><span class="co">    shanken_correction : bool</span></span>
<span id="cb20-487"><a href="#cb20-487" aria-hidden="true" tabindex="-1"></a><span class="co">        Apply Shanken (1992) errors-in-variables correction.</span></span>
<span id="cb20-488"><a href="#cb20-488" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-489"><a href="#cb20-489" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-490"><a href="#cb20-490" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-491"><a href="#cb20-491" aria-hidden="true" tabindex="-1"></a><span class="co">    Dictionary with estimated risk premia, t-statistics, and diagnostics.</span></span>
<span id="cb20-492"><a href="#cb20-492" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-493"><a href="#cb20-493" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb20-494"><a href="#cb20-494" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb20-495"><a href="#cb20-495" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb20-496"><a href="#cb20-496" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-497"><a href="#cb20-497" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common)</span>
<span id="cb20-498"><a href="#cb20-498" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> Y.shape[<span class="dv">1</span>]</span>
<span id="cb20-499"><a href="#cb20-499" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> <span class="bu">len</span>(factor_cols)</span>
<span id="cb20-500"><a href="#cb20-500" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(common)</span>
<span id="cb20-501"><a href="#cb20-501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-502"><a href="#cb20-502" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== STAGE 1: Estimate betas =====</span></span>
<span id="cb20-503"><a href="#cb20-503" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> beta_window <span class="op">==</span> <span class="st">'full'</span>:</span>
<span id="cb20-504"><a href="#cb20-504" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Full-sample betas (simpler, used in GRS context)</span></span>
<span id="cb20-505"><a href="#cb20-505" aria-hidden="true" tabindex="-1"></a>        F_const <span class="op">=</span> sm.add_constant(F)</span>
<span id="cb20-506"><a href="#cb20-506" aria-hidden="true" tabindex="-1"></a>        betas <span class="op">=</span> {}</span>
<span id="cb20-507"><a href="#cb20-507" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb20-508"><a href="#cb20-508" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(Y[col], F_const).fit()</span>
<span id="cb20-509"><a href="#cb20-509" aria-hidden="true" tabindex="-1"></a>            betas[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb20-510"><a href="#cb20-510" aria-hidden="true" tabindex="-1"></a>        beta_df <span class="op">=</span> pd.DataFrame(betas).T  <span class="co"># N x K</span></span>
<span id="cb20-511"><a href="#cb20-511" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-512"><a href="#cb20-512" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Same betas used every month</span></span>
<span id="cb20-513"><a href="#cb20-513" aria-hidden="true" tabindex="-1"></a>        beta_by_month <span class="op">=</span> {m: beta_df <span class="cf">for</span> m <span class="kw">in</span> months}</span>
<span id="cb20-514"><a href="#cb20-514" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-515"><a href="#cb20-515" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> beta_window <span class="op">==</span> <span class="st">'rolling'</span>:</span>
<span id="cb20-516"><a href="#cb20-516" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Rolling betas (more realistic, avoids look-ahead)</span></span>
<span id="cb20-517"><a href="#cb20-517" aria-hidden="true" tabindex="-1"></a>        beta_by_month <span class="op">=</span> {}</span>
<span id="cb20-518"><a href="#cb20-518" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t_idx <span class="kw">in</span> <span class="bu">range</span>(rolling_window, T):</span>
<span id="cb20-519"><a href="#cb20-519" aria-hidden="true" tabindex="-1"></a>            month <span class="op">=</span> months[t_idx]</span>
<span id="cb20-520"><a href="#cb20-520" aria-hidden="true" tabindex="-1"></a>            window_start <span class="op">=</span> months[t_idx <span class="op">-</span> rolling_window]</span>
<span id="cb20-521"><a href="#cb20-521" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-522"><a href="#cb20-522" aria-hidden="true" tabindex="-1"></a>            Y_win <span class="op">=</span> Y.loc[window_start:months[t_idx <span class="op">-</span> <span class="dv">1</span>]]</span>
<span id="cb20-523"><a href="#cb20-523" aria-hidden="true" tabindex="-1"></a>            F_win <span class="op">=</span> sm.add_constant(F.loc[window_start:months[t_idx <span class="op">-</span> <span class="dv">1</span>]])</span>
<span id="cb20-524"><a href="#cb20-524" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-525"><a href="#cb20-525" aria-hidden="true" tabindex="-1"></a>            betas_t <span class="op">=</span> {}</span>
<span id="cb20-526"><a href="#cb20-526" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb20-527"><a href="#cb20-527" aria-hidden="true" tabindex="-1"></a>                y <span class="op">=</span> Y_win[col].dropna()</span>
<span id="cb20-528"><a href="#cb20-528" aria-hidden="true" tabindex="-1"></a>                x <span class="op">=</span> F_win.loc[y.index]</span>
<span id="cb20-529"><a href="#cb20-529" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(y) <span class="op">&lt;</span> <span class="dv">24</span>:</span>
<span id="cb20-530"><a href="#cb20-530" aria-hidden="true" tabindex="-1"></a>                    betas_t[col] <span class="op">=</span> {f: np.nan <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb20-531"><a href="#cb20-531" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb20-532"><a href="#cb20-532" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y, x).fit()</span>
<span id="cb20-533"><a href="#cb20-533" aria-hidden="true" tabindex="-1"></a>                betas_t[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb20-534"><a href="#cb20-534" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-535"><a href="#cb20-535" aria-hidden="true" tabindex="-1"></a>            beta_by_month[month] <span class="op">=</span> pd.DataFrame(betas_t).T</span>
<span id="cb20-536"><a href="#cb20-536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-537"><a href="#cb20-537" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== STAGE 2: Cross-sectional regressions =====</span></span>
<span id="cb20-538"><a href="#cb20-538" aria-hidden="true" tabindex="-1"></a>    gamma_list <span class="op">=</span> []</span>
<span id="cb20-539"><a href="#cb20-539" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-540"><a href="#cb20-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb20-541"><a href="#cb20-541" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> beta_by_month:</span>
<span id="cb20-542"><a href="#cb20-542" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-543"><a href="#cb20-543" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-544"><a href="#cb20-544" aria-hidden="true" tabindex="-1"></a>        betas_t <span class="op">=</span> beta_by_month[month]</span>
<span id="cb20-545"><a href="#cb20-545" aria-hidden="true" tabindex="-1"></a>        returns_t <span class="op">=</span> Y.loc[month]</span>
<span id="cb20-546"><a href="#cb20-546" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-547"><a href="#cb20-547" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align</span></span>
<span id="cb20-548"><a href="#cb20-548" aria-hidden="true" tabindex="-1"></a>        valid <span class="op">=</span> betas_t.dropna().index.intersection(returns_t.dropna().index)</span>
<span id="cb20-549"><a href="#cb20-549" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&lt;</span> K <span class="op">+</span> <span class="dv">5</span>:</span>
<span id="cb20-550"><a href="#cb20-550" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-551"><a href="#cb20-551" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-552"><a href="#cb20-552" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> returns_t[valid].values</span>
<span id="cb20-553"><a href="#cb20-553" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(betas_t.loc[valid, factor_cols].values)</span>
<span id="cb20-554"><a href="#cb20-554" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-555"><a href="#cb20-555" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-556"><a href="#cb20-556" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb20-557"><a href="#cb20-557" aria-hidden="true" tabindex="-1"></a>            gammas <span class="op">=</span> {<span class="st">'month'</span>: month, <span class="st">'gamma_0'</span>: model.params[<span class="dv">0</span>]}</span>
<span id="cb20-558"><a href="#cb20-558" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb20-559"><a href="#cb20-559" aria-hidden="true" tabindex="-1"></a>                gammas[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb20-560"><a href="#cb20-560" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'r_squared'</span>] <span class="op">=</span> model.rsquared</span>
<span id="cb20-561"><a href="#cb20-561" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'n_assets'</span>] <span class="op">=</span> <span class="bu">len</span>(valid)</span>
<span id="cb20-562"><a href="#cb20-562" aria-hidden="true" tabindex="-1"></a>            gamma_list.append(gammas)</span>
<span id="cb20-563"><a href="#cb20-563" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-564"><a href="#cb20-564" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb20-565"><a href="#cb20-565" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-566"><a href="#cb20-566" aria-hidden="true" tabindex="-1"></a>    gamma_df <span class="op">=</span> pd.DataFrame(gamma_list)</span>
<span id="cb20-567"><a href="#cb20-567" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-568"><a href="#cb20-568" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(gamma_df) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb20-569"><a href="#cb20-569" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb20-570"><a href="#cb20-570" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-571"><a href="#cb20-571" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ===== INFERENCE =====</span></span>
<span id="cb20-572"><a href="#cb20-572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series averages of gammas</span></span>
<span id="cb20-573"><a href="#cb20-573" aria-hidden="true" tabindex="-1"></a>    gamma_cols <span class="op">=</span> [<span class="st">'gamma_0'</span>] <span class="op">+</span> [<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> f <span class="kw">in</span> factor_cols]</span>
<span id="cb20-574"><a href="#cb20-574" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-575"><a href="#cb20-575" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb20-576"><a href="#cb20-576" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb20-577"><a href="#cb20-577" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> gamma_df[col]</span>
<span id="cb20-578"><a href="#cb20-578" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> g.mean()</span>
<span id="cb20-579"><a href="#cb20-579" aria-hidden="true" tabindex="-1"></a>        se_fm <span class="op">=</span> g.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(g))</span>
<span id="cb20-580"><a href="#cb20-580" aria-hidden="true" tabindex="-1"></a>        t_fm <span class="op">=</span> mean <span class="op">/</span> se_fm <span class="cf">if</span> se_fm <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-581"><a href="#cb20-581" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-582"><a href="#cb20-582" aria-hidden="true" tabindex="-1"></a>        results[col] <span class="op">=</span> {</span>
<span id="cb20-583"><a href="#cb20-583" aria-hidden="true" tabindex="-1"></a>            <span class="st">'estimate'</span>: mean,</span>
<span id="cb20-584"><a href="#cb20-584" aria-hidden="true" tabindex="-1"></a>            <span class="st">'se_fm'</span>: se_fm,</span>
<span id="cb20-585"><a href="#cb20-585" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t_fm'</span>: t_fm,</span>
<span id="cb20-586"><a href="#cb20-586" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-587"><a href="#cb20-587" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-588"><a href="#cb20-588" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Shanken (1992) correction for errors-in-variables</span></span>
<span id="cb20-589"><a href="#cb20-589" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> shanken_correction <span class="kw">and</span> beta_window <span class="op">==</span> <span class="st">'full'</span>:</span>
<span id="cb20-590"><a href="#cb20-590" aria-hidden="true" tabindex="-1"></a>        Sigma_f <span class="op">=</span> F[factor_cols].cov().values</span>
<span id="cb20-591"><a href="#cb20-591" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-592"><a href="#cb20-592" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Shanken correction factor: (1 + lambda' Sigma_f^-1 lambda)</span></span>
<span id="cb20-593"><a href="#cb20-593" aria-hidden="true" tabindex="-1"></a>        gamma_factor <span class="op">=</span> np.array([results[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>][<span class="st">'estimate'</span>]</span>
<span id="cb20-594"><a href="#cb20-594" aria-hidden="true" tabindex="-1"></a>                                  <span class="cf">for</span> f <span class="kw">in</span> factor_cols])</span>
<span id="cb20-595"><a href="#cb20-595" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-596"><a href="#cb20-596" aria-hidden="true" tabindex="-1"></a>            Sigma_f_inv <span class="op">=</span> inv(Sigma_f)</span>
<span id="cb20-597"><a href="#cb20-597" aria-hidden="true" tabindex="-1"></a>            c_shanken <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> gamma_factor <span class="op">@</span> Sigma_f_inv <span class="op">@</span> gamma_factor</span>
<span id="cb20-598"><a href="#cb20-598" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-599"><a href="#cb20-599" aria-hidden="true" tabindex="-1"></a>            c_shanken <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb20-600"><a href="#cb20-600" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-601"><a href="#cb20-601" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb20-602"><a href="#cb20-602" aria-hidden="true" tabindex="-1"></a>            results[col][<span class="st">'se_shanken'</span>] <span class="op">=</span> results[col][<span class="st">'se_fm'</span>] <span class="op">*</span> np.sqrt(c_shanken)</span>
<span id="cb20-603"><a href="#cb20-603" aria-hidden="true" tabindex="-1"></a>            results[col][<span class="st">'t_shanken'</span>] <span class="op">=</span> (results[col][<span class="st">'estimate'</span>]</span>
<span id="cb20-604"><a href="#cb20-604" aria-hidden="true" tabindex="-1"></a>                                          <span class="op">/</span> results[col][<span class="st">'se_shanken'</span>]</span>
<span id="cb20-605"><a href="#cb20-605" aria-hidden="true" tabindex="-1"></a>                                          <span class="cf">if</span> results[col][<span class="st">'se_shanken'</span>] <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan)</span>
<span id="cb20-606"><a href="#cb20-606" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-607"><a href="#cb20-607" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compare estimated premia to factor mean returns</span></span>
<span id="cb20-608"><a href="#cb20-608" aria-hidden="true" tabindex="-1"></a>    factor_means <span class="op">=</span> F[factor_cols].mean()</span>
<span id="cb20-609"><a href="#cb20-609" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb20-610"><a href="#cb20-610" aria-hidden="true" tabindex="-1"></a>        results[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>][<span class="st">'factor_mean'</span>] <span class="op">=</span> factor_means[f]</span>
<span id="cb20-611"><a href="#cb20-611" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-612"><a href="#cb20-612" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-sectional R-squared</span></span>
<span id="cb20-613"><a href="#cb20-613" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'avg_cs_r2'</span>] <span class="op">=</span> gamma_df[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb20-614"><a href="#cb20-614" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-615"><a href="#cb20-615" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-616"><a href="#cb20-616" aria-hidden="true" tabindex="-1"></a>        <span class="st">'results'</span>: pd.DataFrame(results).T,</span>
<span id="cb20-617"><a href="#cb20-617" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_ts'</span>: gamma_df,</span>
<span id="cb20-618"><a href="#cb20-618" aria-hidden="true" tabindex="-1"></a>        <span class="st">'beta_df'</span>: beta_by_month.get(months[<span class="op">-</span><span class="dv">1</span>], <span class="va">None</span>)</span>
<span id="cb20-619"><a href="#cb20-619" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-620"><a href="#cb20-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-621"><a href="#cb20-621" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Fama-MacBeth for each model</span></span>
<span id="cb20-622"><a href="#cb20-622" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth Cross-Sectional Results: 25 Size-BM Portfolios"</span>)</span>
<span id="cb20-623"><a href="#cb20-623" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb20-624"><a href="#cb20-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-625"><a href="#cb20-625" aria-hidden="true" tabindex="-1"></a>fm_results <span class="op">=</span> {}</span>
<span id="cb20-626"><a href="#cb20-626" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-627"><a href="#cb20-627" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> beta_type <span class="kw">in</span> [<span class="st">'full'</span>, <span class="st">'rolling'</span>]:</span>
<span id="cb20-628"><a href="#cb20-628" aria-hidden="true" tabindex="-1"></a>        key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>beta_type<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb20-629"><a href="#cb20-629" aria-hidden="true" tabindex="-1"></a>        fm <span class="op">=</span> fama_macbeth_two_pass(</span>
<span id="cb20-630"><a href="#cb20-630" aria-hidden="true" tabindex="-1"></a>            excess_25_bm, factors, factor_cols,</span>
<span id="cb20-631"><a href="#cb20-631" aria-hidden="true" tabindex="-1"></a>            beta_window<span class="op">=</span>beta_type,</span>
<span id="cb20-632"><a href="#cb20-632" aria-hidden="true" tabindex="-1"></a>            rolling_window<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb20-633"><a href="#cb20-633" aria-hidden="true" tabindex="-1"></a>            shanken_correction<span class="op">=</span>(beta_type <span class="op">==</span> <span class="st">'full'</span>)</span>
<span id="cb20-634"><a href="#cb20-634" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-635"><a href="#cb20-635" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fm <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb20-636"><a href="#cb20-636" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-637"><a href="#cb20-637" aria-hidden="true" tabindex="-1"></a>        fm_results[key] <span class="op">=</span> fm</span>
<span id="cb20-638"><a href="#cb20-638" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-639"><a href="#cb20-639" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss"> (betas: </span><span class="sc">{</span>beta_type<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb20-640"><a href="#cb20-640" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> fm[<span class="st">'results'</span>]</span>
<span id="cb20-641"><a href="#cb20-641" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, row <span class="kw">in</span> res.iterrows():</span>
<span id="cb20-642"><a href="#cb20-642" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'gamma'</span> <span class="kw">in</span> idx:</span>
<span id="cb20-643"><a href="#cb20-643" aria-hidden="true" tabindex="-1"></a>                t_col <span class="op">=</span> <span class="st">'t_shanken'</span> <span class="cf">if</span> <span class="st">'t_shanken'</span> <span class="kw">in</span> row <span class="kw">and</span> pd.notna(row.get(<span class="st">'t_shanken'</span>)) <span class="cf">else</span> <span class="st">'t_fm'</span></span>
<span id="cb20-644"><a href="#cb20-644" aria-hidden="true" tabindex="-1"></a>                f_mean <span class="op">=</span> row.get(<span class="st">'factor_mean'</span>, <span class="st">''</span>)</span>
<span id="cb20-645"><a href="#cb20-645" aria-hidden="true" tabindex="-1"></a>                f_str <span class="op">=</span> <span class="ss">f"  f_mean=</span><span class="sc">{</span>f_mean<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">if</span> <span class="bu">isinstance</span>(f_mean, <span class="bu">float</span>) <span class="cf">else</span> <span class="st">""</span></span>
<span id="cb20-646"><a href="#cb20-646" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>idx<span class="sc">:&lt;16}</span><span class="ss">: Œ≥ = </span><span class="sc">{</span>row[<span class="st">'estimate'</span>]<span class="sc">:.5f}</span><span class="ss">, "</span></span>
<span id="cb20-647"><a href="#cb20-647" aria-hidden="true" tabindex="-1"></a>                      <span class="ss">f"t = </span><span class="sc">{</span>row[t_col]<span class="sc">:.2f}{</span>f_str<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-648"><a href="#cb20-648" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'avg_cs_r2'</span> <span class="kw">in</span> res.index:</span>
<span id="cb20-649"><a href="#cb20-649" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Avg CS R¬≤: </span><span class="sc">{</span>res<span class="sc">.</span>loc[<span class="st">'avg_cs_r2'</span>, <span class="st">'estimate'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-650"><a href="#cb20-650" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-651"><a href="#cb20-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-652"><a href="#cb20-652" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Shanken Correction</span></span>
<span id="cb20-653"><a href="#cb20-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-654"><a href="#cb20-654" aria-hidden="true" tabindex="-1"></a>The @shanken1992estimation correction addresses the errors-in-variables (EIV) problem inherent in the two-pass procedure. Because betas are estimated with error in Stage 1, the Stage 2 standard errors are understated. The correction inflates the standard errors by a factor that depends on the estimated risk premia and the factor covariance matrix:</span>
<span id="cb20-655"><a href="#cb20-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-656"><a href="#cb20-656" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-657"><a href="#cb20-657" aria-hidden="true" tabindex="-1"></a>\text{Var}(\hat{\gamma})_{\text{Shanken}} = \text{Var}(\hat{\gamma})_{\text{FM}} \times \left(1 + \hat{\gamma}' \hat{\Sigma}_f^{-1} \hat{\gamma}\right)</span>
<span id="cb20-658"><a href="#cb20-658" aria-hidden="true" tabindex="-1"></a>$$ {#eq-shanken}</span>
<span id="cb20-659"><a href="#cb20-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-662"><a href="#cb20-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-663"><a href="#cb20-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shanken-impact</span></span>
<span id="cb20-664"><a href="#cb20-664" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-665"><a href="#cb20-665" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare FM t-statistics with and without Shanken correction"</span></span>
<span id="cb20-666"><a href="#cb20-666" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Impact of Shanken Correction on t-statistics:"</span>)</span>
<span id="cb20-667"><a href="#cb20-667" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t (FM)'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t (Shanken)'</span><span class="sc">:&gt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ratio'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb20-668"><a href="#cb20-668" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">54</span>)</span>
<span id="cb20-669"><a href="#cb20-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-670"><a href="#cb20-670" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name <span class="kw">in</span> models:</span>
<span id="cb20-671"><a href="#cb20-671" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_full"</span></span>
<span id="cb20-672"><a href="#cb20-672" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key <span class="kw">not</span> <span class="kw">in</span> fm_results:</span>
<span id="cb20-673"><a href="#cb20-673" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb20-674"><a href="#cb20-674" aria-hidden="true" tabindex="-1"></a>    res <span class="op">=</span> fm_results[key][<span class="st">'results'</span>]</span>
<span id="cb20-675"><a href="#cb20-675" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, row <span class="kw">in</span> res.iterrows():</span>
<span id="cb20-676"><a href="#cb20-676" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'gamma_'</span> <span class="kw">in</span> <span class="bu">str</span>(idx) <span class="kw">and</span> idx <span class="op">!=</span> <span class="st">'gamma_0'</span>:</span>
<span id="cb20-677"><a href="#cb20-677" aria-hidden="true" tabindex="-1"></a>            t_fm <span class="op">=</span> row.get(<span class="st">'t_fm'</span>, np.nan)</span>
<span id="cb20-678"><a href="#cb20-678" aria-hidden="true" tabindex="-1"></a>            t_sh <span class="op">=</span> row.get(<span class="st">'t_shanken'</span>, np.nan)</span>
<span id="cb20-679"><a href="#cb20-679" aria-hidden="true" tabindex="-1"></a>            ratio <span class="op">=</span> t_fm <span class="op">/</span> t_sh <span class="cf">if</span> pd.notna(t_sh) <span class="kw">and</span> t_sh <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-680"><a href="#cb20-680" aria-hidden="true" tabindex="-1"></a>            factor_name <span class="op">=</span> idx.replace(<span class="st">'gamma_'</span>, <span class="st">''</span>)</span>
<span id="cb20-681"><a href="#cb20-681" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>factor_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>t_fm<span class="sc">:&gt;10.2f}</span><span class="ss"> "</span></span>
<span id="cb20-682"><a href="#cb20-682" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"</span><span class="sc">{</span>t_sh<span class="sc">:&gt;12.2f}</span><span class="ss"> </span><span class="sc">{</span>ratio<span class="sc">:&gt;8.2f}</span><span class="ss">"</span>)</span>
<span id="cb20-683"><a href="#cb20-683" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-684"><a href="#cb20-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-685"><a href="#cb20-685" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fama-MacBeth with Individual Stocks</span></span>
<span id="cb20-686"><a href="#cb20-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-687"><a href="#cb20-687" aria-hidden="true" tabindex="-1"></a>Using individual stocks instead of portfolios as test assets avoids the @lewellen2010skeptical critique that sorted portfolios create artificially strong factor structure:</span>
<span id="cb20-688"><a href="#cb20-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-691"><a href="#cb20-691" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-692"><a href="#cb20-692" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fm-individual</span></span>
<span id="cb20-693"><a href="#cb20-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-694"><a href="#cb20-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Fama-MacBeth regressions using individual stocks"</span></span>
<span id="cb20-695"><a href="#cb20-695" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_individual(stock_df, factor_df, factor_cols,</span>
<span id="cb20-696"><a href="#cb20-696" aria-hidden="true" tabindex="-1"></a>                              beta_window<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span>,</span>
<span id="cb20-697"><a href="#cb20-697" aria-hidden="true" tabindex="-1"></a>                              min_stocks<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb20-698"><a href="#cb20-698" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-699"><a href="#cb20-699" aria-hidden="true" tabindex="-1"></a><span class="co">    Fama-MacBeth with individual stocks and rolling betas.</span></span>
<span id="cb20-700"><a href="#cb20-700" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-701"><a href="#cb20-701" aria-hidden="true" tabindex="-1"></a>    stock_df <span class="op">=</span> stock_df.copy()</span>
<span id="cb20-702"><a href="#cb20-702" aria-hidden="true" tabindex="-1"></a>    stock_df[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(stock_df[<span class="st">'month_end'</span>])</span>
<span id="cb20-703"><a href="#cb20-703" aria-hidden="true" tabindex="-1"></a>    factor_df <span class="op">=</span> factor_df.copy()</span>
<span id="cb20-704"><a href="#cb20-704" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-705"><a href="#cb20-705" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(stock_df[<span class="st">'month_end'</span>].unique())</span>
<span id="cb20-706"><a href="#cb20-706" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-707"><a href="#cb20-707" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre-compute rolling betas for all stocks</span></span>
<span id="cb20-708"><a href="#cb20-708" aria-hidden="true" tabindex="-1"></a>    gamma_list <span class="op">=</span> []</span>
<span id="cb20-709"><a href="#cb20-709" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-710"><a href="#cb20-710" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t_idx, month <span class="kw">in</span> <span class="bu">enumerate</span>(months):</span>
<span id="cb20-711"><a href="#cb20-711" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t_idx <span class="op">&lt;</span> beta_window:</span>
<span id="cb20-712"><a href="#cb20-712" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-713"><a href="#cb20-713" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-714"><a href="#cb20-714" aria-hidden="true" tabindex="-1"></a>        window_months <span class="op">=</span> months[t_idx <span class="op">-</span> beta_window:t_idx]</span>
<span id="cb20-715"><a href="#cb20-715" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-716"><a href="#cb20-716" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get betas for each stock from rolling window</span></span>
<span id="cb20-717"><a href="#cb20-717" aria-hidden="true" tabindex="-1"></a>        betas_t <span class="op">=</span> {}</span>
<span id="cb20-718"><a href="#cb20-718" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> stock_df[stock_df[<span class="st">'month_end'</span>].isin(window_months)]</span>
<span id="cb20-719"><a href="#cb20-719" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-720"><a href="#cb20-720" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> window_data.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb20-721"><a href="#cb20-721" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> min_obs:</span>
<span id="cb20-722"><a href="#cb20-722" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb20-723"><a href="#cb20-723" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-724"><a href="#cb20-724" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> group.set_index(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb20-725"><a href="#cb20-725" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> factor_df.loc[y.index, factor_cols]</span>
<span id="cb20-726"><a href="#cb20-726" aria-hidden="true" tabindex="-1"></a>            x <span class="op">=</span> sm.add_constant(x)</span>
<span id="cb20-727"><a href="#cb20-727" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-728"><a href="#cb20-728" aria-hidden="true" tabindex="-1"></a>            valid <span class="op">=</span> y.index.intersection(x.index)</span>
<span id="cb20-729"><a href="#cb20-729" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(valid) <span class="op">&lt;</span> min_obs:</span>
<span id="cb20-730"><a href="#cb20-730" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb20-731"><a href="#cb20-731" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-732"><a href="#cb20-732" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb20-733"><a href="#cb20-733" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y[valid], x.loc[valid]).fit()</span>
<span id="cb20-734"><a href="#cb20-734" aria-hidden="true" tabindex="-1"></a>                betas_t[ticker] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb20-735"><a href="#cb20-735" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-736"><a href="#cb20-736" aria-hidden="true" tabindex="-1"></a>                <span class="cf">pass</span></span>
<span id="cb20-737"><a href="#cb20-737" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-738"><a href="#cb20-738" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(betas_t) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb20-739"><a href="#cb20-739" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-740"><a href="#cb20-740" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-741"><a href="#cb20-741" aria-hidden="true" tabindex="-1"></a>        beta_df <span class="op">=</span> pd.DataFrame(betas_t).T</span>
<span id="cb20-742"><a href="#cb20-742" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-743"><a href="#cb20-743" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Current month returns</span></span>
<span id="cb20-744"><a href="#cb20-744" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> stock_df[stock_df[<span class="st">'month_end'</span>] <span class="op">==</span> month]</span>
<span id="cb20-745"><a href="#cb20-745" aria-hidden="true" tabindex="-1"></a>        current <span class="op">=</span> current.set_index(<span class="st">'ticker'</span>)</span>
<span id="cb20-746"><a href="#cb20-746" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-747"><a href="#cb20-747" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align</span></span>
<span id="cb20-748"><a href="#cb20-748" aria-hidden="true" tabindex="-1"></a>        valid_tickers <span class="op">=</span> beta_df.index.intersection(current.index)</span>
<span id="cb20-749"><a href="#cb20-749" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(valid_tickers) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb20-750"><a href="#cb20-750" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-751"><a href="#cb20-751" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-752"><a href="#cb20-752" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> current.loc[valid_tickers, <span class="st">'monthly_return'</span>].values</span>
<span id="cb20-753"><a href="#cb20-753" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(beta_df.loc[valid_tickers].values)</span>
<span id="cb20-754"><a href="#cb20-754" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-755"><a href="#cb20-755" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-756"><a href="#cb20-756" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb20-757"><a href="#cb20-757" aria-hidden="true" tabindex="-1"></a>            gammas <span class="op">=</span> {<span class="st">'month'</span>: month, <span class="st">'gamma_0'</span>: model.params[<span class="dv">0</span>]}</span>
<span id="cb20-758"><a href="#cb20-758" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb20-759"><a href="#cb20-759" aria-hidden="true" tabindex="-1"></a>                gammas[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[j <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb20-760"><a href="#cb20-760" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'n_stocks'</span>] <span class="op">=</span> <span class="bu">len</span>(valid_tickers)</span>
<span id="cb20-761"><a href="#cb20-761" aria-hidden="true" tabindex="-1"></a>            gammas[<span class="st">'r_squared'</span>] <span class="op">=</span> model.rsquared</span>
<span id="cb20-762"><a href="#cb20-762" aria-hidden="true" tabindex="-1"></a>            gamma_list.append(gammas)</span>
<span id="cb20-763"><a href="#cb20-763" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-764"><a href="#cb20-764" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb20-765"><a href="#cb20-765" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-766"><a href="#cb20-766" aria-hidden="true" tabindex="-1"></a>    gamma_df <span class="op">=</span> pd.DataFrame(gamma_list)</span>
<span id="cb20-767"><a href="#cb20-767" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-768"><a href="#cb20-768" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Inference</span></span>
<span id="cb20-769"><a href="#cb20-769" aria-hidden="true" tabindex="-1"></a>    gamma_cols <span class="op">=</span> [<span class="st">'gamma_0'</span>] <span class="op">+</span> [<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> f <span class="kw">in</span> factor_cols]</span>
<span id="cb20-770"><a href="#cb20-770" aria-hidden="true" tabindex="-1"></a>    summary <span class="op">=</span> {}</span>
<span id="cb20-771"><a href="#cb20-771" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> gamma_cols:</span>
<span id="cb20-772"><a href="#cb20-772" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> gamma_df[col]</span>
<span id="cb20-773"><a href="#cb20-773" aria-hidden="true" tabindex="-1"></a>        mean <span class="op">=</span> g.mean()</span>
<span id="cb20-774"><a href="#cb20-774" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> g.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(g))</span>
<span id="cb20-775"><a href="#cb20-775" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-776"><a href="#cb20-776" aria-hidden="true" tabindex="-1"></a>        summary[col] <span class="op">=</span> {<span class="st">'estimate'</span>: mean, <span class="st">'se'</span>: se, <span class="st">'t'</span>: t}</span>
<span id="cb20-777"><a href="#cb20-777" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-778"><a href="#cb20-778" aria-hidden="true" tabindex="-1"></a>    summary[<span class="st">'avg_n_stocks'</span>] <span class="op">=</span> gamma_df[<span class="st">'n_stocks'</span>].mean()</span>
<span id="cb20-779"><a href="#cb20-779" aria-hidden="true" tabindex="-1"></a>    summary[<span class="st">'avg_cs_r2'</span>] <span class="op">=</span> gamma_df[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb20-780"><a href="#cb20-780" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-781"><a href="#cb20-781" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(summary).T, gamma_df</span>
<span id="cb20-782"><a href="#cb20-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-783"><a href="#cb20-783" aria-hidden="true" tabindex="-1"></a><span class="co"># Run for FF5</span></span>
<span id="cb20-784"><a href="#cb20-784" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Fama-MacBeth with Individual Stocks (FF5):"</span>)</span>
<span id="cb20-785"><a href="#cb20-785" aria-hidden="true" tabindex="-1"></a>fm_ind_results, fm_ind_gamma <span class="op">=</span> fama_macbeth_individual(</span>
<span id="cb20-786"><a href="#cb20-786" aria-hidden="true" tabindex="-1"></a>    stock_returns, factors,</span>
<span id="cb20-787"><a href="#cb20-787" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb20-788"><a href="#cb20-788" aria-hidden="true" tabindex="-1"></a>    beta_window<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span></span>
<span id="cb20-789"><a href="#cb20-789" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-790"><a href="#cb20-790" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fm_ind_results.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb20-791"><a href="#cb20-791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-792"><a href="#cb20-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-793"><a href="#cb20-793" aria-hidden="true" tabindex="-1"></a><span class="fu">## When Do the Tests Disagree? {#sec-ts-cs-disagreement}</span></span>
<span id="cb20-794"><a href="#cb20-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-795"><a href="#cb20-795" aria-hidden="true" tabindex="-1"></a><span class="fu">### Theoretical Sources of Disagreement</span></span>
<span id="cb20-796"><a href="#cb20-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-797"><a href="#cb20-797" aria-hidden="true" tabindex="-1"></a>@goyal2018cross identify three sources of discrepancy between time-series and cross-sectional tests:</span>
<span id="cb20-798"><a href="#cb20-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-799"><a href="#cb20-799" aria-hidden="true" tabindex="-1"></a>**1. Factor structure of test assets.** If test assets have a strong factor structure (as sorted portfolios do by construction), the cross-sectional $R^2$ will be high regardless of whether the factors truly price the assets. @lewellen2010skeptical show that even random factors can achieve high cross-sectional $R^2$ when test assets are size-BM sorted portfolios, because such portfolios have a strong linear structure in the size-value space.</span>
<span id="cb20-800"><a href="#cb20-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-801"><a href="#cb20-801" aria-hidden="true" tabindex="-1"></a>**2. Time-variation in betas.** The time-series regression assumes constant betas. If betas vary over time and co-move with the factor risk premium, the unconditional time-series alpha can be nonzero even if the conditional model holds <span class="co">[</span><span class="ot">@jagannathan1996conditional</span><span class="co">]</span>.</span>
<span id="cb20-802"><a href="#cb20-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-803"><a href="#cb20-803" aria-hidden="true" tabindex="-1"></a>**3. Misspecified risk premia.** The Fama-MacBeth cross-sectional regression estimates the risk premium from the data. The time-series regression implicitly sets the risk premium equal to the factor's sample mean return. When these differ (e.g., because the factor is not a perfect proxy for the underlying risk), the two approaches disagree.</span>
<span id="cb20-804"><a href="#cb20-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-805"><a href="#cb20-805" aria-hidden="true" tabindex="-1"></a><span class="fu">### Empirical Comparison for Vietnam</span></span>
<span id="cb20-806"><a href="#cb20-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-809"><a href="#cb20-809" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-810"><a href="#cb20-810" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ts-vs-cs</span></span>
<span id="cb20-811"><a href="#cb20-811" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-812"><a href="#cb20-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare time-series alphas with cross-sectional pricing errors"</span></span>
<span id="cb20-813"><a href="#cb20-813" aria-hidden="true" tabindex="-1"></a><span class="co"># For FF5 on 25 Size-BM portfolios:</span></span>
<span id="cb20-814"><a href="#cb20-814" aria-hidden="true" tabindex="-1"></a><span class="co"># Time-series: alpha from OLS regression</span></span>
<span id="cb20-815"><a href="#cb20-815" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-section: pricing error from Fama-MacBeth</span></span>
<span id="cb20-816"><a href="#cb20-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-817"><a href="#cb20-817" aria-hidden="true" tabindex="-1"></a>ts_alphas <span class="op">=</span> ts_results[<span class="st">'FF5'</span>][<span class="st">'alpha'</span>].values <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb20-818"><a href="#cb20-818" aria-hidden="true" tabindex="-1"></a>ts_names <span class="op">=</span> ts_results[<span class="st">'FF5'</span>].index.tolist()</span>
<span id="cb20-819"><a href="#cb20-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-820"><a href="#cb20-820" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional pricing errors:</span></span>
<span id="cb20-821"><a href="#cb20-821" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted return = beta' * estimated_gamma</span></span>
<span id="cb20-822"><a href="#cb20-822" aria-hidden="true" tabindex="-1"></a><span class="co"># Pricing error = actual mean return - predicted</span></span>
<span id="cb20-823"><a href="#cb20-823" aria-hidden="true" tabindex="-1"></a>fm_full <span class="op">=</span> fm_results.get(<span class="st">'FF5_full'</span>)</span>
<span id="cb20-824"><a href="#cb20-824" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb20-825"><a href="#cb20-825" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> fm_full[<span class="st">'beta_df'</span>]  <span class="co"># N x K</span></span>
<span id="cb20-826"><a href="#cb20-826" aria-hidden="true" tabindex="-1"></a>    factor_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb20-827"><a href="#cb20-827" aria-hidden="true" tabindex="-1"></a>    gammas <span class="op">=</span> np.array([fm_full[<span class="st">'results'</span>].loc[<span class="ss">f'gamma_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>, <span class="st">'estimate'</span>]</span>
<span id="cb20-828"><a href="#cb20-828" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> f <span class="kw">in</span> factor_cols])</span>
<span id="cb20-829"><a href="#cb20-829" aria-hidden="true" tabindex="-1"></a>    gamma_0 <span class="op">=</span> fm_full[<span class="st">'results'</span>].loc[<span class="st">'gamma_0'</span>, <span class="st">'estimate'</span>]</span>
<span id="cb20-830"><a href="#cb20-830" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-831"><a href="#cb20-831" aria-hidden="true" tabindex="-1"></a>    actual_means <span class="op">=</span> excess_25_bm.mean() <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb20-832"><a href="#cb20-832" aria-hidden="true" tabindex="-1"></a>    predicted <span class="op">=</span> (gamma_0 <span class="op">+</span> betas[factor_cols].values <span class="op">@</span> gammas) <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-833"><a href="#cb20-833" aria-hidden="true" tabindex="-1"></a>    cs_errors <span class="op">=</span> actual_means.values <span class="op">-</span> predicted</span>
<span id="cb20-834"><a href="#cb20-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-835"><a href="#cb20-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-838"><a href="#cb20-838" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-839"><a href="#cb20-839" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ts-vs-cs</span></span>
<span id="cb20-840"><a href="#cb20-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-841"><a href="#cb20-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of time-series alphas and cross-sectional pricing errors for the 25 size-BM portfolios under the FF5 model. Panel A plots the two measures against each other; perfect agreement would place all points on the 45-degree line. Panel B shows actual vs predicted average returns from the Fama-MacBeth second pass. Systematic deviations reveal where the two approaches disagree about model adequacy."</span></span>
<span id="cb20-842"><a href="#cb20-842" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Scatter plot comparing TS alphas and CS pricing errors"</span></span>
<span id="cb20-843"><a href="#cb20-843" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb20-844"><a href="#cb20-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-845"><a href="#cb20-845" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: TS alpha vs CS pricing error</span></span>
<span id="cb20-846"><a href="#cb20-846" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb20-847"><a href="#cb20-847" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].scatter(ts_alphas <span class="op">*</span> <span class="dv">100</span>, cs_errors <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb20-848"><a href="#cb20-848" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'#2C5F8A'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-849"><a href="#cb20-849" aria-hidden="true" tabindex="-1"></a>    lim <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(ts_alphas)), np.<span class="bu">max</span>(np.<span class="bu">abs</span>(cs_errors))) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb20-850"><a href="#cb20-850" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="op">-</span>lim, lim], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-851"><a href="#cb20-851" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="dv">0</span>, <span class="dv">0</span>], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb20-852"><a href="#cb20-852" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot([<span class="dv">0</span>, <span class="dv">0</span>], [<span class="op">-</span>lim, lim], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb20-853"><a href="#cb20-853" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Time-Series Alpha (% ann.)'</span>)</span>
<span id="cb20-854"><a href="#cb20-854" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Cross-Sectional Pricing Error (% ann.)'</span>)</span>
<span id="cb20-855"><a href="#cb20-855" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: TS Alpha vs CS Pricing Error'</span>)</span>
<span id="cb20-856"><a href="#cb20-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-857"><a href="#cb20-857" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Correlation</span></span>
<span id="cb20-858"><a href="#cb20-858" aria-hidden="true" tabindex="-1"></a>    rho <span class="op">=</span> np.corrcoef(ts_alphas, cs_errors)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb20-859"><a href="#cb20-859" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="ss">f'œÅ = </span><span class="sc">{</span>rho<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb20-860"><a href="#cb20-860" aria-hidden="true" tabindex="-1"></a>                  transform<span class="op">=</span>axes[<span class="dv">0</span>].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb20-861"><a href="#cb20-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-862"><a href="#cb20-862" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Actual vs Predicted (CS)</span></span>
<span id="cb20-863"><a href="#cb20-863" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> fm_full:</span>
<span id="cb20-864"><a href="#cb20-864" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].scatter(predicted <span class="op">*</span> <span class="dv">100</span>, actual_means.values <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb20-865"><a href="#cb20-865" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span><span class="st">'#C0392B'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-866"><a href="#cb20-866" aria-hidden="true" tabindex="-1"></a>    lim2 <span class="op">=</span> <span class="bu">max</span>(np.<span class="bu">max</span>(np.<span class="bu">abs</span>(predicted)), np.<span class="bu">max</span>(np.<span class="bu">abs</span>(actual_means))) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb20-867"><a href="#cb20-867" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot([<span class="op">-</span><span class="dv">5</span>, lim2], [<span class="op">-</span><span class="dv">5</span>, lim2], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-868"><a href="#cb20-868" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted Average Return (% ann.)'</span>)</span>
<span id="cb20-869"><a href="#cb20-869" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Actual Average Return (% ann.)'</span>)</span>
<span id="cb20-870"><a href="#cb20-870" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Actual vs Predicted (FM Cross-Section)'</span>)</span>
<span id="cb20-871"><a href="#cb20-871" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-872"><a href="#cb20-872" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CS R-squared</span></span>
<span id="cb20-873"><a href="#cb20-873" aria-hidden="true" tabindex="-1"></a>    ss_res <span class="op">=</span> np.<span class="bu">sum</span>((actual_means.values <span class="op">-</span> predicted) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb20-874"><a href="#cb20-874" aria-hidden="true" tabindex="-1"></a>    ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((actual_means.values <span class="op">-</span> actual_means.values.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb20-875"><a href="#cb20-875" aria-hidden="true" tabindex="-1"></a>    r2_cs <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot</span>
<span id="cb20-876"><a href="#cb20-876" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="ss">f'CS R¬≤ = </span><span class="sc">{</span>r2_cs<span class="sc">:.2f}</span><span class="ss">'</span>,</span>
<span id="cb20-877"><a href="#cb20-877" aria-hidden="true" tabindex="-1"></a>                  transform<span class="op">=</span>axes[<span class="dv">1</span>].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb20-878"><a href="#cb20-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-879"><a href="#cb20-879" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-880"><a href="#cb20-880" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-881"><a href="#cb20-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-882"><a href="#cb20-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-883"><a href="#cb20-883" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Lewellen-Nagel-Shanken Critique</span></span>
<span id="cb20-884"><a href="#cb20-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-885"><a href="#cb20-885" aria-hidden="true" tabindex="-1"></a>@lewellen2010skeptical demonstrate that the high cross-sectional $R^2$ from Fama-MacBeth regressions on sorted portfolios can be misleading. Sorted portfolios have a strong factor structure by construction, so even irrelevant factors can produce high $R^2$. They recommend:</span>
<span id="cb20-886"><a href="#cb20-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-887"><a href="#cb20-887" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Including industry portfolios alongside sorted portfolios to break the mechanical factor structure.</span>
<span id="cb20-888"><a href="#cb20-888" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Constraining the estimated risk premia to equal the factor mean returns (this is what the time-series test implicitly does).</span>
<span id="cb20-889"><a href="#cb20-889" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Reporting the cross-sectional $R^2$ from the *constrained* model alongside the unconstrained estimate.</span>
<span id="cb20-890"><a href="#cb20-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-893"><a href="#cb20-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-894"><a href="#cb20-894" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lns-critique</span></span>
<span id="cb20-895"><a href="#cb20-895" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-896"><a href="#cb20-896" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement the Lewellen-Nagel-Shanken diagnostic"</span></span>
<span id="cb20-897"><a href="#cb20-897" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> lns_diagnostic(excess_returns, factor_df, factor_cols):</span>
<span id="cb20-898"><a href="#cb20-898" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-899"><a href="#cb20-899" aria-hidden="true" tabindex="-1"></a><span class="co">    Lewellen-Nagel-Shanken (2010) diagnostic:</span></span>
<span id="cb20-900"><a href="#cb20-900" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare unconstrained CS R¬≤ to constrained (factor mean = premium).</span></span>
<span id="cb20-901"><a href="#cb20-901" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-902"><a href="#cb20-902" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb20-903"><a href="#cb20-903" aria-hidden="true" tabindex="-1"></a>    Y <span class="op">=</span> excess_returns.loc[common]</span>
<span id="cb20-904"><a href="#cb20-904" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols]</span>
<span id="cb20-905"><a href="#cb20-905" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-906"><a href="#cb20-906" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Full-sample betas</span></span>
<span id="cb20-907"><a href="#cb20-907" aria-hidden="true" tabindex="-1"></a>    betas <span class="op">=</span> {}</span>
<span id="cb20-908"><a href="#cb20-908" aria-hidden="true" tabindex="-1"></a>    F_const <span class="op">=</span> sm.add_constant(F)</span>
<span id="cb20-909"><a href="#cb20-909" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> Y.columns:</span>
<span id="cb20-910"><a href="#cb20-910" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(Y[col], F_const).fit()</span>
<span id="cb20-911"><a href="#cb20-911" aria-hidden="true" tabindex="-1"></a>        betas[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span> factor_cols}</span>
<span id="cb20-912"><a href="#cb20-912" aria-hidden="true" tabindex="-1"></a>    beta_mat <span class="op">=</span> pd.DataFrame(betas).T  <span class="co"># N x K</span></span>
<span id="cb20-913"><a href="#cb20-913" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-914"><a href="#cb20-914" aria-hidden="true" tabindex="-1"></a>    actual <span class="op">=</span> Y.mean() <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb20-915"><a href="#cb20-915" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-916"><a href="#cb20-916" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Unconstrained: FM regression</span></span>
<span id="cb20-917"><a href="#cb20-917" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(beta_mat.values)</span>
<span id="cb20-918"><a href="#cb20-918" aria-hidden="true" tabindex="-1"></a>    fm_model <span class="op">=</span> sm.OLS(actual.values, X).fit()</span>
<span id="cb20-919"><a href="#cb20-919" aria-hidden="true" tabindex="-1"></a>    predicted_unc <span class="op">=</span> fm_model.fittedvalues</span>
<span id="cb20-920"><a href="#cb20-920" aria-hidden="true" tabindex="-1"></a>    r2_unconstrained <span class="op">=</span> fm_model.rsquared</span>
<span id="cb20-921"><a href="#cb20-921" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-922"><a href="#cb20-922" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Constrained: premium = factor mean return</span></span>
<span id="cb20-923"><a href="#cb20-923" aria-hidden="true" tabindex="-1"></a>    factor_means <span class="op">=</span> F.mean().values <span class="op">*</span> <span class="dv">12</span>  <span class="co"># Annualized</span></span>
<span id="cb20-924"><a href="#cb20-924" aria-hidden="true" tabindex="-1"></a>    predicted_con <span class="op">=</span> beta_mat.values <span class="op">@</span> factor_means</span>
<span id="cb20-925"><a href="#cb20-925" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add best-fitting intercept</span></span>
<span id="cb20-926"><a href="#cb20-926" aria-hidden="true" tabindex="-1"></a>    intercept_con <span class="op">=</span> np.mean(actual.values <span class="op">-</span> predicted_con)</span>
<span id="cb20-927"><a href="#cb20-927" aria-hidden="true" tabindex="-1"></a>    predicted_con <span class="op">+=</span> intercept_con</span>
<span id="cb20-928"><a href="#cb20-928" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-929"><a href="#cb20-929" aria-hidden="true" tabindex="-1"></a>    ss_res_con <span class="op">=</span> np.<span class="bu">sum</span>((actual.values <span class="op">-</span> predicted_con) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb20-930"><a href="#cb20-930" aria-hidden="true" tabindex="-1"></a>    ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((actual.values <span class="op">-</span> actual.values.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb20-931"><a href="#cb20-931" aria-hidden="true" tabindex="-1"></a>    r2_constrained <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res_con <span class="op">/</span> ss_tot</span>
<span id="cb20-932"><a href="#cb20-932" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-933"><a href="#cb20-933" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-934"><a href="#cb20-934" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_unconstrained'</span>: r2_unconstrained,</span>
<span id="cb20-935"><a href="#cb20-935" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_constrained'</span>: r2_constrained,</span>
<span id="cb20-936"><a href="#cb20-936" aria-hidden="true" tabindex="-1"></a>        <span class="st">'r2_drop'</span>: r2_unconstrained <span class="op">-</span> r2_constrained,</span>
<span id="cb20-937"><a href="#cb20-937" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_unconstrained'</span>: fm_model.params[<span class="dv">1</span>:],</span>
<span id="cb20-938"><a href="#cb20-938" aria-hidden="true" tabindex="-1"></a>        <span class="st">'gamma_constrained'</span>: factor_means</span>
<span id="cb20-939"><a href="#cb20-939" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-940"><a href="#cb20-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-941"><a href="#cb20-941" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Lewellen-Nagel-Shanken Diagnostic:"</span>)</span>
<span id="cb20-942"><a href="#cb20-942" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R¬≤ (unc)'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R¬≤ (con)'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb20-943"><a href="#cb20-943" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'Drop'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb20-944"><a href="#cb20-944" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">58</span>)</span>
<span id="cb20-945"><a href="#cb20-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-946"><a href="#cb20-946" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-947"><a href="#cb20-947" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb20-948"><a href="#cb20-948" aria-hidden="true" tabindex="-1"></a>        diag <span class="op">=</span> lns_diagnostic(ta_data, factors, factor_cols)</span>
<span id="cb20-949"><a href="#cb20-949" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb20-950"><a href="#cb20-950" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_unconstrained'</span>]<span class="sc">:&gt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb20-951"><a href="#cb20-951" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_constrained'</span>]<span class="sc">:&gt;10.3f}</span><span class="ss"> "</span></span>
<span id="cb20-952"><a href="#cb20-952" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>diag[<span class="st">'r2_drop'</span>]<span class="sc">:&gt;8.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-953"><a href="#cb20-953" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-954"><a href="#cb20-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-957"><a href="#cb20-957" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-958"><a href="#cb20-958" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-lns</span></span>
<span id="cb20-959"><a href="#cb20-959" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-960"><a href="#cb20-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Lewellen-Nagel-Shanken diagnostic for the FF5 model. Panel A shows the unconstrained cross-sectional fit (estimated risk premia), where high R¬≤ may be spurious. Panel B shows the constrained fit (premia set to factor means). A large drop in R¬≤ from unconstrained to constrained indicates that the model's apparent success relies on implausible risk premia, and the factors are not truly pricing the test assets."</span></span>
<span id="cb20-961"><a href="#cb20-961" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize constrained vs unconstrained cross-sectional fit"</span></span>
<span id="cb20-962"><a href="#cb20-962" aria-hidden="true" tabindex="-1"></a>diag_ff5 <span class="op">=</span> lns_diagnostic(excess_25_bm, factors,</span>
<span id="cb20-963"><a href="#cb20-963" aria-hidden="true" tabindex="-1"></a>                            [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>])</span>
<span id="cb20-964"><a href="#cb20-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-965"><a href="#cb20-965" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb20-966"><a href="#cb20-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-967"><a href="#cb20-967" aria-hidden="true" tabindex="-1"></a>actual <span class="op">=</span> excess_25_bm.mean().values <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-968"><a href="#cb20-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-969"><a href="#cb20-969" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Unconstrained</span></span>
<span id="cb20-970"><a href="#cb20-970" aria-hidden="true" tabindex="-1"></a>F_const <span class="op">=</span> sm.add_constant(factors[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]])</span>
<span id="cb20-971"><a href="#cb20-971" aria-hidden="true" tabindex="-1"></a>betas_full <span class="op">=</span> {}</span>
<span id="cb20-972"><a href="#cb20-972" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> excess_25_bm.columns:</span>
<span id="cb20-973"><a href="#cb20-973" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_25_bm.index.intersection(factors.index)</span>
<span id="cb20-974"><a href="#cb20-974" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(excess_25_bm.loc[common, col],</span>
<span id="cb20-975"><a href="#cb20-975" aria-hidden="true" tabindex="-1"></a>                    F_const.loc[common]).fit()</span>
<span id="cb20-976"><a href="#cb20-976" aria-hidden="true" tabindex="-1"></a>    betas_full[col] <span class="op">=</span> {f: model.params[f] <span class="cf">for</span> f <span class="kw">in</span></span>
<span id="cb20-977"><a href="#cb20-977" aria-hidden="true" tabindex="-1"></a>                        [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]}</span>
<span id="cb20-978"><a href="#cb20-978" aria-hidden="true" tabindex="-1"></a>beta_mat <span class="op">=</span> pd.DataFrame(betas_full).T</span>
<span id="cb20-979"><a href="#cb20-979" aria-hidden="true" tabindex="-1"></a>X_cs <span class="op">=</span> sm.add_constant(beta_mat.values)</span>
<span id="cb20-980"><a href="#cb20-980" aria-hidden="true" tabindex="-1"></a>fm_mod <span class="op">=</span> sm.OLS(actual, X_cs).fit()</span>
<span id="cb20-981"><a href="#cb20-981" aria-hidden="true" tabindex="-1"></a>pred_unc <span class="op">=</span> fm_mod.fittedvalues</span>
<span id="cb20-982"><a href="#cb20-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-983"><a href="#cb20-983" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].scatter(pred_unc, actual, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb20-984"><a href="#cb20-984" aria-hidden="true" tabindex="-1"></a>                 edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-985"><a href="#cb20-985" aria-hidden="true" tabindex="-1"></a>rng_plot <span class="op">=</span> [<span class="bu">min</span>(pred_unc.<span class="bu">min</span>(), actual.<span class="bu">min</span>()) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb20-986"><a href="#cb20-986" aria-hidden="true" tabindex="-1"></a>            <span class="bu">max</span>(pred_unc.<span class="bu">max</span>(), actual.<span class="bu">max</span>()) <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb20-987"><a href="#cb20-987" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(rng_plot, rng_plot, <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-988"><a href="#cb20-988" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Predicted (% ann.)'</span>)</span>
<span id="cb20-989"><a href="#cb20-989" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Actual (% ann.)'</span>)</span>
<span id="cb20-990"><a href="#cb20-990" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="ss">f"Panel A: Unconstrained (R¬≤ = "</span></span>
<span id="cb20-991"><a href="#cb20-991" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"</span><span class="sc">{</span>diag_ff5[<span class="st">'r2_unconstrained'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb20-992"><a href="#cb20-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-993"><a href="#cb20-993" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Constrained</span></span>
<span id="cb20-994"><a href="#cb20-994" aria-hidden="true" tabindex="-1"></a>factor_means <span class="op">=</span> factors[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]].mean().values <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb20-995"><a href="#cb20-995" aria-hidden="true" tabindex="-1"></a>pred_con <span class="op">=</span> beta_mat.values <span class="op">@</span> factor_means</span>
<span id="cb20-996"><a href="#cb20-996" aria-hidden="true" tabindex="-1"></a>pred_con <span class="op">+=</span> np.mean(actual <span class="op">-</span> pred_con)</span>
<span id="cb20-997"><a href="#cb20-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-998"><a href="#cb20-998" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].scatter(pred_con, actual, color<span class="op">=</span><span class="st">'#C0392B'</span>, s<span class="op">=</span><span class="dv">60</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb20-999"><a href="#cb20-999" aria-hidden="true" tabindex="-1"></a>                 edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb20-1000"><a href="#cb20-1000" aria-hidden="true" tabindex="-1"></a>rng2 <span class="op">=</span> [<span class="bu">min</span>(pred_con.<span class="bu">min</span>(), actual.<span class="bu">min</span>()) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb20-1001"><a href="#cb20-1001" aria-hidden="true" tabindex="-1"></a>        <span class="bu">max</span>(pred_con.<span class="bu">max</span>(), actual.<span class="bu">max</span>()) <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb20-1002"><a href="#cb20-1002" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(rng2, rng2, <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-1003"><a href="#cb20-1003" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Predicted (% ann.)'</span>)</span>
<span id="cb20-1004"><a href="#cb20-1004" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Actual (% ann.)'</span>)</span>
<span id="cb20-1005"><a href="#cb20-1005" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="ss">f"Panel B: Constrained (R¬≤ = "</span></span>
<span id="cb20-1006"><a href="#cb20-1006" aria-hidden="true" tabindex="-1"></a>                    <span class="ss">f"</span><span class="sc">{</span>diag_ff5[<span class="st">'r2_constrained'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb20-1007"><a href="#cb20-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1008"><a href="#cb20-1008" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-1009"><a href="#cb20-1009" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-1010"><a href="#cb20-1010" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1011"><a href="#cb20-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1012"><a href="#cb20-1012" aria-hidden="true" tabindex="-1"></a><span class="fu">## GMM-Based Tests {#sec-ts-cs-gmm}</span></span>
<span id="cb20-1013"><a href="#cb20-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1014"><a href="#cb20-1014" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Stochastic Discount Factor Framework</span></span>
<span id="cb20-1015"><a href="#cb20-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1016"><a href="#cb20-1016" aria-hidden="true" tabindex="-1"></a>Both time-series and cross-sectional tests are special cases of the @hansen1982large Generalized Method of Moments (GMM) framework. The fundamental pricing equation is:</span>
<span id="cb20-1017"><a href="#cb20-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1018"><a href="#cb20-1018" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-1019"><a href="#cb20-1019" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">M_t R_{i,t}^e</span><span class="co">]</span> = 0 \quad \text{for all } i</span>
<span id="cb20-1020"><a href="#cb20-1020" aria-hidden="true" tabindex="-1"></a>$$ {#eq-sdf}</span>
<span id="cb20-1021"><a href="#cb20-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1022"><a href="#cb20-1022" aria-hidden="true" tabindex="-1"></a>where $M_t$ is the stochastic discount factor (SDF) and $R_{i,t}^e$ is the excess return of asset $i$. A linear factor model parameterizes the SDF as:</span>
<span id="cb20-1023"><a href="#cb20-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1024"><a href="#cb20-1024" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-1025"><a href="#cb20-1025" aria-hidden="true" tabindex="-1"></a>M_t = 1 - b' (f_t - \mu_f)</span>
<span id="cb20-1026"><a href="#cb20-1026" aria-hidden="true" tabindex="-1"></a>$$ {#eq-linear-sdf}</span>
<span id="cb20-1027"><a href="#cb20-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1028"><a href="#cb20-1028" aria-hidden="true" tabindex="-1"></a>where $b$ is the vector of SDF loadings and $f_t$ are the factors. The GMM approach estimates $b$ by minimizing the quadratic form of the pricing errors:</span>
<span id="cb20-1029"><a href="#cb20-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1030"><a href="#cb20-1030" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb20-1031"><a href="#cb20-1031" aria-hidden="true" tabindex="-1"></a>\hat{b} = \arg\min_b \ g(b)' W \ g(b)</span>
<span id="cb20-1032"><a href="#cb20-1032" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gmm-objective}</span>
<span id="cb20-1033"><a href="#cb20-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1034"><a href="#cb20-1034" aria-hidden="true" tabindex="-1"></a>where $g(b) = \frac{1}{T} \sum_t M_t(b) R_t^e$ is the sample analog of the moment conditions.</span>
<span id="cb20-1035"><a href="#cb20-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1038"><a href="#cb20-1038" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-1039"><a href="#cb20-1039" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gmm-sdf</span></span>
<span id="cb20-1040"><a href="#cb20-1040" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1041"><a href="#cb20-1041" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement GMM estimation of the linear SDF model"</span></span>
<span id="cb20-1042"><a href="#cb20-1042" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> gmm_sdf(excess_returns, factor_df, factor_cols,</span>
<span id="cb20-1043"><a href="#cb20-1043" aria-hidden="true" tabindex="-1"></a>              weighting<span class="op">=</span><span class="st">'identity'</span>, n_iter<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb20-1044"><a href="#cb20-1044" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-1045"><a href="#cb20-1045" aria-hidden="true" tabindex="-1"></a><span class="co">    GMM estimation of the linear SDF model.</span></span>
<span id="cb20-1046"><a href="#cb20-1046" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-1047"><a href="#cb20-1047" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-1048"><a href="#cb20-1048" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-1049"><a href="#cb20-1049" aria-hidden="true" tabindex="-1"></a><span class="co">    weighting : str</span></span>
<span id="cb20-1050"><a href="#cb20-1050" aria-hidden="true" tabindex="-1"></a><span class="co">        'identity': first-stage identity weighting matrix</span></span>
<span id="cb20-1051"><a href="#cb20-1051" aria-hidden="true" tabindex="-1"></a><span class="co">        'optimal': Hansen optimal weighting (iterated)</span></span>
<span id="cb20-1052"><a href="#cb20-1052" aria-hidden="true" tabindex="-1"></a><span class="co">    n_iter : int</span></span>
<span id="cb20-1053"><a href="#cb20-1053" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of GMM iterations (2 = efficient two-step)</span></span>
<span id="cb20-1054"><a href="#cb20-1054" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-1055"><a href="#cb20-1055" aria-hidden="true" tabindex="-1"></a>    common <span class="op">=</span> excess_returns.index.intersection(factor_df.index)</span>
<span id="cb20-1056"><a href="#cb20-1056" aria-hidden="true" tabindex="-1"></a>    Re <span class="op">=</span> excess_returns.loc[common].values  <span class="co"># T x N</span></span>
<span id="cb20-1057"><a href="#cb20-1057" aria-hidden="true" tabindex="-1"></a>    F <span class="op">=</span> factor_df.loc[common, factor_cols].values  <span class="co"># T x K</span></span>
<span id="cb20-1058"><a href="#cb20-1058" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1059"><a href="#cb20-1059" aria-hidden="true" tabindex="-1"></a>    T, N <span class="op">=</span> Re.shape</span>
<span id="cb20-1060"><a href="#cb20-1060" aria-hidden="true" tabindex="-1"></a>    K <span class="op">=</span> F.shape[<span class="dv">1</span>]</span>
<span id="cb20-1061"><a href="#cb20-1061" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1062"><a href="#cb20-1062" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Demean factors</span></span>
<span id="cb20-1063"><a href="#cb20-1063" aria-hidden="true" tabindex="-1"></a>    F_dm <span class="op">=</span> F <span class="op">-</span> F.mean(axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-1064"><a href="#cb20-1064" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1065"><a href="#cb20-1065" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Moment conditions: E[M * Re] = 0</span></span>
<span id="cb20-1066"><a href="#cb20-1066" aria-hidden="true" tabindex="-1"></a>    <span class="co"># M = 1 - b' (f - mu_f) = 1 - b' F_dm</span></span>
<span id="cb20-1067"><a href="#cb20-1067" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> pricing_errors(b):</span>
<span id="cb20-1068"><a href="#cb20-1068" aria-hidden="true" tabindex="-1"></a>        M <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> F_dm <span class="op">@</span> b  <span class="co"># T-vector</span></span>
<span id="cb20-1069"><a href="#cb20-1069" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> (M[:, np.newaxis] <span class="op">*</span> Re).mean(axis<span class="op">=</span><span class="dv">0</span>)  <span class="co"># N-vector</span></span>
<span id="cb20-1070"><a href="#cb20-1070" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> g</span>
<span id="cb20-1071"><a href="#cb20-1071" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1072"><a href="#cb20-1072" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GMM objective</span></span>
<span id="cb20-1073"><a href="#cb20-1073" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> np.eye(N)  <span class="co"># Initial weighting matrix</span></span>
<span id="cb20-1074"><a href="#cb20-1074" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1075"><a href="#cb20-1075" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb20-1076"><a href="#cb20-1076" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1077"><a href="#cb20-1077" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> iteration <span class="kw">in</span> <span class="bu">range</span>(n_iter):</span>
<span id="cb20-1078"><a href="#cb20-1078" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> objective(b):</span>
<span id="cb20-1079"><a href="#cb20-1079" aria-hidden="true" tabindex="-1"></a>            g <span class="op">=</span> pricing_errors(b)</span>
<span id="cb20-1080"><a href="#cb20-1080" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> T <span class="op">*</span> g <span class="op">@</span> W <span class="op">@</span> g</span>
<span id="cb20-1081"><a href="#cb20-1081" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1082"><a href="#cb20-1082" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> minimize(objective, np.zeros(K), method<span class="op">=</span><span class="st">'L-BFGS-B'</span>)</span>
<span id="cb20-1083"><a href="#cb20-1083" aria-hidden="true" tabindex="-1"></a>        b_hat <span class="op">=</span> result.x</span>
<span id="cb20-1084"><a href="#cb20-1084" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1085"><a href="#cb20-1085" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> iteration <span class="op">&lt;</span> n_iter <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb20-1086"><a href="#cb20-1086" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update weighting matrix (Hansen optimal)</span></span>
<span id="cb20-1087"><a href="#cb20-1087" aria-hidden="true" tabindex="-1"></a>            g_t <span class="op">=</span> np.array([(<span class="dv">1</span> <span class="op">-</span> F_dm[t] <span class="op">@</span> b_hat) <span class="op">*</span> Re[t]</span>
<span id="cb20-1088"><a href="#cb20-1088" aria-hidden="true" tabindex="-1"></a>                             <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T)])  <span class="co"># T x N</span></span>
<span id="cb20-1089"><a href="#cb20-1089" aria-hidden="true" tabindex="-1"></a>            S <span class="op">=</span> np.cov(g_t, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-1090"><a href="#cb20-1090" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-1091"><a href="#cb20-1091" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Newey-West adjustment for serial correlation</span></span>
<span id="cb20-1092"><a href="#cb20-1092" aria-hidden="true" tabindex="-1"></a>            max_lag <span class="op">=</span> <span class="bu">int</span>(np.floor(<span class="dv">4</span> <span class="op">*</span> (T <span class="op">/</span> <span class="dv">100</span>) <span class="op">**</span> (<span class="dv">2</span> <span class="op">/</span> <span class="dv">9</span>)))</span>
<span id="cb20-1093"><a href="#cb20-1093" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_lag <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb20-1094"><a href="#cb20-1094" aria-hidden="true" tabindex="-1"></a>                w <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> lag <span class="op">/</span> (max_lag <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb20-1095"><a href="#cb20-1095" aria-hidden="true" tabindex="-1"></a>                Gamma <span class="op">=</span> np.cov(g_t[lag:].T, g_t[:<span class="op">-</span>lag].T, ddof<span class="op">=</span><span class="dv">0</span>)[:N, N:]</span>
<span id="cb20-1096"><a href="#cb20-1096" aria-hidden="true" tabindex="-1"></a>                S <span class="op">+=</span> w <span class="op">*</span> (Gamma <span class="op">+</span> Gamma.T)</span>
<span id="cb20-1097"><a href="#cb20-1097" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb20-1098"><a href="#cb20-1098" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb20-1099"><a href="#cb20-1099" aria-hidden="true" tabindex="-1"></a>                W <span class="op">=</span> inv(S)</span>
<span id="cb20-1100"><a href="#cb20-1100" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-1101"><a href="#cb20-1101" aria-hidden="true" tabindex="-1"></a>                W <span class="op">=</span> np.eye(N)</span>
<span id="cb20-1102"><a href="#cb20-1102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1103"><a href="#cb20-1103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pricing errors at optimum</span></span>
<span id="cb20-1104"><a href="#cb20-1104" aria-hidden="true" tabindex="-1"></a>    g_hat <span class="op">=</span> pricing_errors(b_hat)</span>
<span id="cb20-1105"><a href="#cb20-1105" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1106"><a href="#cb20-1106" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implied risk premia: lambda = Sigma_f @ b</span></span>
<span id="cb20-1107"><a href="#cb20-1107" aria-hidden="true" tabindex="-1"></a>    Sigma_f <span class="op">=</span> np.cov(F, rowvar<span class="op">=</span><span class="va">False</span>, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb20-1108"><a href="#cb20-1108" aria-hidden="true" tabindex="-1"></a>    lambda_hat <span class="op">=</span> Sigma_f <span class="op">@</span> b_hat</span>
<span id="cb20-1109"><a href="#cb20-1109" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1110"><a href="#cb20-1110" aria-hidden="true" tabindex="-1"></a>    <span class="co"># J-test (overidentification)</span></span>
<span id="cb20-1111"><a href="#cb20-1111" aria-hidden="true" tabindex="-1"></a>    J <span class="op">=</span> T <span class="op">*</span> g_hat <span class="op">@</span> W <span class="op">@</span> g_hat</span>
<span id="cb20-1112"><a href="#cb20-1112" aria-hidden="true" tabindex="-1"></a>    df_J <span class="op">=</span> N <span class="op">-</span> K</span>
<span id="cb20-1113"><a href="#cb20-1113" aria-hidden="true" tabindex="-1"></a>    p_J <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.chi2.cdf(J, df_J) <span class="cf">if</span> df_J <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb20-1114"><a href="#cb20-1114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1115"><a href="#cb20-1115" aria-hidden="true" tabindex="-1"></a>    <span class="co"># HJ distance (model misspecification)</span></span>
<span id="cb20-1116"><a href="#cb20-1116" aria-hidden="true" tabindex="-1"></a>    hj_dist <span class="op">=</span> np.sqrt(g_hat <span class="op">@</span> inv(np.cov(Re, rowvar<span class="op">=</span><span class="va">False</span>)) <span class="op">@</span> g_hat)</span>
<span id="cb20-1117"><a href="#cb20-1117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1118"><a href="#cb20-1118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-1119"><a href="#cb20-1119" aria-hidden="true" tabindex="-1"></a>        <span class="st">'b_hat'</span>: b_hat,</span>
<span id="cb20-1120"><a href="#cb20-1120" aria-hidden="true" tabindex="-1"></a>        <span class="st">'lambda_hat'</span>: lambda_hat,</span>
<span id="cb20-1121"><a href="#cb20-1121" aria-hidden="true" tabindex="-1"></a>        <span class="st">'pricing_errors'</span>: g_hat,</span>
<span id="cb20-1122"><a href="#cb20-1122" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_stat'</span>: J,</span>
<span id="cb20-1123"><a href="#cb20-1123" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_pvalue'</span>: p_J,</span>
<span id="cb20-1124"><a href="#cb20-1124" aria-hidden="true" tabindex="-1"></a>        <span class="st">'J_df'</span>: df_J,</span>
<span id="cb20-1125"><a href="#cb20-1125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'hj_distance'</span>: hj_dist,</span>
<span id="cb20-1126"><a href="#cb20-1126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'mean_abs_error'</span>: np.<span class="bu">abs</span>(g_hat).mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-1127"><a href="#cb20-1127" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-1128"><a href="#cb20-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1129"><a href="#cb20-1129" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GMM SDF Estimation:"</span>)</span>
<span id="cb20-1130"><a href="#cb20-1130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Model'</span><span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Test Assets'</span><span class="sc">:&lt;18}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'J-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'J p-val'</span><span class="sc">:&gt;10}</span><span class="ss"> "</span></span>
<span id="cb20-1131"><a href="#cb20-1131" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'HJ dist'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'|e| ann'</span><span class="sc">:&gt;10}</span><span class="ss">"</span>)</span>
<span id="cb20-1132"><a href="#cb20-1132" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">66</span>)</span>
<span id="cb20-1133"><a href="#cb20-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1134"><a href="#cb20-1134" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-1135"><a href="#cb20-1135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ta_name, ta_data <span class="kw">in</span> test_asset_sets.items():</span>
<span id="cb20-1136"><a href="#cb20-1136" aria-hidden="true" tabindex="-1"></a>        gmm <span class="op">=</span> gmm_sdf(ta_data, factors, factor_cols, n_iter<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb20-1137"><a href="#cb20-1137" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">:&lt;12}</span><span class="ss"> </span><span class="sc">{</span>ta_name<span class="sc">:&lt;18}</span><span class="ss"> "</span></span>
<span id="cb20-1138"><a href="#cb20-1138" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>gmm[<span class="st">'J_stat'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>gmm[<span class="st">'J_pvalue'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb20-1139"><a href="#cb20-1139" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"</span><span class="sc">{</span>gmm[<span class="st">'hj_distance'</span>]<span class="sc">:&gt;8.4f}</span><span class="ss"> </span><span class="sc">{</span>gmm[<span class="st">'mean_abs_error'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss">"</span>)</span>
<span id="cb20-1140"><a href="#cb20-1140" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1141"><a href="#cb20-1141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print implied risk premia</span></span>
<span id="cb20-1142"><a href="#cb20-1142" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j, f <span class="kw">in</span> <span class="bu">enumerate</span>(factor_cols):</span>
<span id="cb20-1143"><a href="#cb20-1143" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Œª_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>gmm[<span class="st">'lambda_hat'</span>][j]<span class="op">*</span><span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb20-1144"><a href="#cb20-1144" aria-hidden="true" tabindex="-1"></a>                  <span class="ss">f"(factor mean: </span><span class="sc">{</span>factors[f]<span class="sc">.</span>mean()<span class="op">*</span><span class="dv">12</span><span class="sc">:.4f}</span><span class="ss">)"</span>)</span>
<span id="cb20-1145"><a href="#cb20-1145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1146"><a href="#cb20-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1147"><a href="#cb20-1147" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Comparison {#sec-ts-cs-model-comparison}</span></span>
<span id="cb20-1148"><a href="#cb20-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1149"><a href="#cb20-1149" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Barillas-Shanken Framework</span></span>
<span id="cb20-1150"><a href="#cb20-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1151"><a href="#cb20-1151" aria-hidden="true" tabindex="-1"></a>@barillas2018comparing propose a Bayesian framework for comparing non-nested factor models. The key insight is that model comparison should be based on the factors' ability to explain each other's returns, not on their ability to price a fixed set of test assets. Two models differ only in their excluded factors, so the relevant comparison is whether the factors unique to each model have alpha with respect to the other model.</span>
<span id="cb20-1152"><a href="#cb20-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1155"><a href="#cb20-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-1156"><a href="#cb20-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: barillas-shanken</span></span>
<span id="cb20-1157"><a href="#cb20-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1158"><a href="#cb20-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement Barillas-Shanken model comparison"</span></span>
<span id="cb20-1159"><a href="#cb20-1159" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> barillas_shanken_compare(factor_df, model_a_cols, model_b_cols):</span>
<span id="cb20-1160"><a href="#cb20-1160" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-1161"><a href="#cb20-1161" aria-hidden="true" tabindex="-1"></a><span class="co">    Barillas-Shanken (2018) pairwise model comparison.</span></span>
<span id="cb20-1162"><a href="#cb20-1162" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-1163"><a href="#cb20-1163" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare Model A vs Model B by testing whether the factors</span></span>
<span id="cb20-1164"><a href="#cb20-1164" aria-hidden="true" tabindex="-1"></a><span class="co">    unique to each model have alpha with respect to the other.</span></span>
<span id="cb20-1165"><a href="#cb20-1165" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-1166"><a href="#cb20-1166" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Factors unique to each model</span></span>
<span id="cb20-1167"><a href="#cb20-1167" aria-hidden="true" tabindex="-1"></a>    unique_a <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> model_a_cols <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> model_b_cols]</span>
<span id="cb20-1168"><a href="#cb20-1168" aria-hidden="true" tabindex="-1"></a>    unique_b <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> model_b_cols <span class="cf">if</span> f <span class="kw">not</span> <span class="kw">in</span> model_a_cols]</span>
<span id="cb20-1169"><a href="#cb20-1169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1170"><a href="#cb20-1170" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb20-1171"><a href="#cb20-1171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1172"><a href="#cb20-1172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test: do factors unique to A have alpha w.r.t. B?</span></span>
<span id="cb20-1173"><a href="#cb20-1173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If yes, A adds value beyond B</span></span>
<span id="cb20-1174"><a href="#cb20-1174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unique_a:</span>
<span id="cb20-1175"><a href="#cb20-1175" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> unique_a:</span>
<span id="cb20-1176"><a href="#cb20-1176" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> factor_df[f]</span>
<span id="cb20-1177"><a href="#cb20-1177" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(factor_df[model_b_cols])</span>
<span id="cb20-1178"><a href="#cb20-1178" aria-hidden="true" tabindex="-1"></a>            common <span class="op">=</span> y.dropna().index.intersection(X.dropna().index)</span>
<span id="cb20-1179"><a href="#cb20-1179" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y[common], X.loc[common]).fit(</span>
<span id="cb20-1180"><a href="#cb20-1180" aria-hidden="true" tabindex="-1"></a>                cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>}</span>
<span id="cb20-1181"><a href="#cb20-1181" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-1182"><a href="#cb20-1182" aria-hidden="true" tabindex="-1"></a>            results[<span class="ss">f'alpha_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">_vs_B'</span>] <span class="op">=</span> {</span>
<span id="cb20-1183"><a href="#cb20-1183" aria-hidden="true" tabindex="-1"></a>                <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb20-1184"><a href="#cb20-1184" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb20-1185"><a href="#cb20-1185" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r2'</span>: model.rsquared</span>
<span id="cb20-1186"><a href="#cb20-1186" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb20-1187"><a href="#cb20-1187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1188"><a href="#cb20-1188" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> unique_b:</span>
<span id="cb20-1189"><a href="#cb20-1189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> f <span class="kw">in</span> unique_b:</span>
<span id="cb20-1190"><a href="#cb20-1190" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> factor_df[f]</span>
<span id="cb20-1191"><a href="#cb20-1191" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(factor_df[model_a_cols])</span>
<span id="cb20-1192"><a href="#cb20-1192" aria-hidden="true" tabindex="-1"></a>            common <span class="op">=</span> y.dropna().index.intersection(X.dropna().index)</span>
<span id="cb20-1193"><a href="#cb20-1193" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y[common], X.loc[common]).fit(</span>
<span id="cb20-1194"><a href="#cb20-1194" aria-hidden="true" tabindex="-1"></a>                cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>}</span>
<span id="cb20-1195"><a href="#cb20-1195" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-1196"><a href="#cb20-1196" aria-hidden="true" tabindex="-1"></a>            results[<span class="ss">f'alpha_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">_vs_A'</span>] <span class="op">=</span> {</span>
<span id="cb20-1197"><a href="#cb20-1197" aria-hidden="true" tabindex="-1"></a>                <span class="st">'alpha'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb20-1198"><a href="#cb20-1198" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb20-1199"><a href="#cb20-1199" aria-hidden="true" tabindex="-1"></a>                <span class="st">'r2'</span>: model.rsquared</span>
<span id="cb20-1200"><a href="#cb20-1200" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb20-1201"><a href="#cb20-1201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1202"><a href="#cb20-1202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).T</span>
<span id="cb20-1203"><a href="#cb20-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1204"><a href="#cb20-1204" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF3 vs FF5</span></span>
<span id="cb20-1205"><a href="#cb20-1205" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Barillas-Shanken: FF3 vs FF5"</span>)</span>
<span id="cb20-1206"><a href="#cb20-1206" aria-hidden="true" tabindex="-1"></a>bs_3v5 <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb20-1207"><a href="#cb20-1207" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb20-1208"><a href="#cb20-1208" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>],</span>
<span id="cb20-1209"><a href="#cb20-1209" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb20-1210"><a href="#cb20-1210" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-1211"><a href="#cb20-1211" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_3v5.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb20-1212"><a href="#cb20-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1213"><a href="#cb20-1213" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF5 vs FF5+WML</span></span>
<span id="cb20-1214"><a href="#cb20-1214" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Barillas-Shanken: FF5 vs FF5+WML"</span>)</span>
<span id="cb20-1215"><a href="#cb20-1215" aria-hidden="true" tabindex="-1"></a>bs_5vw <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb20-1216"><a href="#cb20-1216" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb20-1217"><a href="#cb20-1217" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>],</span>
<span id="cb20-1218"><a href="#cb20-1218" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb20-1219"><a href="#cb20-1219" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-1220"><a href="#cb20-1220" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_5vw.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb20-1221"><a href="#cb20-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1222"><a href="#cb20-1222" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare FF3+WML vs FF5+WML</span></span>
<span id="cb20-1223"><a href="#cb20-1223" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Barillas-Shanken: FF3+WML vs FF5+WML"</span>)</span>
<span id="cb20-1224"><a href="#cb20-1224" aria-hidden="true" tabindex="-1"></a>bs_3wv5w <span class="op">=</span> barillas_shanken_compare(</span>
<span id="cb20-1225"><a href="#cb20-1225" aria-hidden="true" tabindex="-1"></a>    factors,</span>
<span id="cb20-1226"><a href="#cb20-1226" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>],</span>
<span id="cb20-1227"><a href="#cb20-1227" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb20-1228"><a href="#cb20-1228" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-1229"><a href="#cb20-1229" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bs_3wv5w.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb20-1230"><a href="#cb20-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1231"><a href="#cb20-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1232"><a href="#cb20-1232" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comprehensive Model Scorecard</span></span>
<span id="cb20-1233"><a href="#cb20-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1236"><a href="#cb20-1236" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-1237"><a href="#cb20-1237" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-scorecard</span></span>
<span id="cb20-1238"><a href="#cb20-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1239"><a href="#cb20-1239" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comprehensive model comparison scorecard across all test statistics and test asset sets. Each cell reports the value of the diagnostic; color intensity reflects performance (green = better, red = worse). The scorecard integrates time-series (GRS, mean |Œ±|, mean R¬≤), cross-sectional (CS R¬≤, constrained CS R¬≤), and GMM (J-stat, HJ distance) evidence."</span></span>
<span id="cb20-1240"><a href="#cb20-1240" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Build comprehensive model comparison table"</span></span>
<span id="cb20-1241"><a href="#cb20-1241" aria-hidden="true" tabindex="-1"></a>scorecard <span class="op">=</span> {}</span>
<span id="cb20-1242"><a href="#cb20-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1243"><a href="#cb20-1243" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model_name, factor_cols <span class="kw">in</span> models.items():</span>
<span id="cb20-1244"><a href="#cb20-1244" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> {<span class="st">'Model'</span>: model_name}</span>
<span id="cb20-1245"><a href="#cb20-1245" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1246"><a href="#cb20-1246" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series (25 Size-BM)</span></span>
<span id="cb20-1247"><a href="#cb20-1247" aria-hidden="true" tabindex="-1"></a>    grs_result <span class="op">=</span> grs_all.get(<span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_25 Size-BM"</span>)</span>
<span id="cb20-1248"><a href="#cb20-1248" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> grs_result:</span>
<span id="cb20-1249"><a href="#cb20-1249" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'GRS (BM)'</span>] <span class="op">=</span> grs_result[<span class="st">'GRS'</span>]</span>
<span id="cb20-1250"><a href="#cb20-1250" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'GRS p'</span>] <span class="op">=</span> grs_result[<span class="st">'p_value'</span>]</span>
<span id="cb20-1251"><a href="#cb20-1251" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'|Œ±| (BM)'</span>] <span class="op">=</span> grs_result[<span class="st">'mean_abs_alpha'</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-1252"><a href="#cb20-1252" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1253"><a href="#cb20-1253" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-section</span></span>
<span id="cb20-1254"><a href="#cb20-1254" aria-hidden="true" tabindex="-1"></a>    fm_key <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>model_name<span class="sc">}</span><span class="ss">_full"</span></span>
<span id="cb20-1255"><a href="#cb20-1255" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> fm_key <span class="kw">in</span> fm_results:</span>
<span id="cb20-1256"><a href="#cb20-1256" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'CS R¬≤ (unc)'</span>] <span class="op">=</span> fm_results[fm_key][<span class="st">'results'</span>].get(</span>
<span id="cb20-1257"><a href="#cb20-1257" aria-hidden="true" tabindex="-1"></a>            <span class="st">'avg_cs_r2'</span>, {}).get(<span class="st">'estimate'</span>, np.nan)</span>
<span id="cb20-1258"><a href="#cb20-1258" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1259"><a href="#cb20-1259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># LNS constrained</span></span>
<span id="cb20-1260"><a href="#cb20-1260" aria-hidden="true" tabindex="-1"></a>    lns <span class="op">=</span> lns_diagnostic(excess_25_bm, factors, factor_cols)</span>
<span id="cb20-1261"><a href="#cb20-1261" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'CS R¬≤ (con)'</span>] <span class="op">=</span> lns[<span class="st">'r2_constrained'</span>]</span>
<span id="cb20-1262"><a href="#cb20-1262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1263"><a href="#cb20-1263" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GMM</span></span>
<span id="cb20-1264"><a href="#cb20-1264" aria-hidden="true" tabindex="-1"></a>    gmm <span class="op">=</span> gmm_sdf(excess_25_bm, factors, factor_cols, n_iter<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb20-1265"><a href="#cb20-1265" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'HJ dist'</span>] <span class="op">=</span> gmm[<span class="st">'hj_distance'</span>]</span>
<span id="cb20-1266"><a href="#cb20-1266" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'J p-val'</span>] <span class="op">=</span> gmm[<span class="st">'J_pvalue'</span>]</span>
<span id="cb20-1267"><a href="#cb20-1267" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1268"><a href="#cb20-1268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time-series R¬≤</span></span>
<span id="cb20-1269"><a href="#cb20-1269" aria-hidden="true" tabindex="-1"></a>    ts_res <span class="op">=</span> time_series_regressions(excess_25_bm, factors, factor_cols)</span>
<span id="cb20-1270"><a href="#cb20-1270" aria-hidden="true" tabindex="-1"></a>    metrics[<span class="st">'Avg R¬≤'</span>] <span class="op">=</span> ts_res[<span class="st">'r_squared'</span>].mean()</span>
<span id="cb20-1271"><a href="#cb20-1271" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1272"><a href="#cb20-1272" aria-hidden="true" tabindex="-1"></a>    scorecard[model_name] <span class="op">=</span> metrics</span>
<span id="cb20-1273"><a href="#cb20-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1274"><a href="#cb20-1274" aria-hidden="true" tabindex="-1"></a>scorecard_df <span class="op">=</span> pd.DataFrame(scorecard).T</span>
<span id="cb20-1275"><a href="#cb20-1275" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Model Scorecard:"</span>)</span>
<span id="cb20-1276"><a href="#cb20-1276" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(scorecard_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb20-1277"><a href="#cb20-1277" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1278"><a href="#cb20-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1279"><a href="#cb20-1279" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conditional vs. Unconditional Tests {#sec-ts-cs-conditional}</span></span>
<span id="cb20-1280"><a href="#cb20-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1281"><a href="#cb20-1281" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time-Varying Betas</span></span>
<span id="cb20-1282"><a href="#cb20-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1283"><a href="#cb20-1283" aria-hidden="true" tabindex="-1"></a>Unconditional tests assume constant betas. In practice, Vietnamese stock betas vary substantially over time due to changing market conditions, foreign ownership shifts, and sectoral rotations. We estimate rolling betas to assess the degree of time-variation:</span>
<span id="cb20-1284"><a href="#cb20-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1287"><a href="#cb20-1287" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-1288"><a href="#cb20-1288" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-betas</span></span>
<span id="cb20-1289"><a href="#cb20-1289" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1290"><a href="#cb20-1290" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Estimate and visualize time-varying betas"</span></span>
<span id="cb20-1291"><a href="#cb20-1291" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 36-month betas for the 25 Size-BM portfolios on FF5</span></span>
<span id="cb20-1292"><a href="#cb20-1292" aria-hidden="true" tabindex="-1"></a>rolling_window <span class="op">=</span> <span class="dv">36</span></span>
<span id="cb20-1293"><a href="#cb20-1293" aria-hidden="true" tabindex="-1"></a>factor_cols <span class="op">=</span> [<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>]</span>
<span id="cb20-1294"><a href="#cb20-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1295"><a href="#cb20-1295" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a few representative portfolios</span></span>
<span id="cb20-1296"><a href="#cb20-1296" aria-hidden="true" tabindex="-1"></a>representative <span class="op">=</span> [excess_25_bm.columns[<span class="dv">0</span>],   <span class="co"># Small-Growth</span></span>
<span id="cb20-1297"><a href="#cb20-1297" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">4</span>],   <span class="co"># Small-Value</span></span>
<span id="cb20-1298"><a href="#cb20-1298" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">20</span>],  <span class="co"># Big-Growth</span></span>
<span id="cb20-1299"><a href="#cb20-1299" aria-hidden="true" tabindex="-1"></a>                   excess_25_bm.columns[<span class="dv">24</span>]]  <span class="co"># Big-Value</span></span>
<span id="cb20-1300"><a href="#cb20-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1301"><a href="#cb20-1301" aria-hidden="true" tabindex="-1"></a>rolling_betas <span class="op">=</span> {}</span>
<span id="cb20-1302"><a href="#cb20-1302" aria-hidden="true" tabindex="-1"></a>common <span class="op">=</span> excess_25_bm.index.intersection(factors.index)</span>
<span id="cb20-1303"><a href="#cb20-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1304"><a href="#cb20-1304" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> port <span class="kw">in</span> representative:</span>
<span id="cb20-1305"><a href="#cb20-1305" aria-hidden="true" tabindex="-1"></a>    betas_t <span class="op">=</span> []</span>
<span id="cb20-1306"><a href="#cb20-1306" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(rolling_window, <span class="bu">len</span>(common)):</span>
<span id="cb20-1307"><a href="#cb20-1307" aria-hidden="true" tabindex="-1"></a>        window <span class="op">=</span> common[t <span class="op">-</span> rolling_window:t]</span>
<span id="cb20-1308"><a href="#cb20-1308" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> excess_25_bm.loc[window, port]</span>
<span id="cb20-1309"><a href="#cb20-1309" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(factors.loc[window, factor_cols])</span>
<span id="cb20-1310"><a href="#cb20-1310" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-1311"><a href="#cb20-1311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-1312"><a href="#cb20-1312" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb20-1313"><a href="#cb20-1313" aria-hidden="true" tabindex="-1"></a>            entry <span class="op">=</span> {<span class="st">'month'</span>: common[t]}</span>
<span id="cb20-1314"><a href="#cb20-1314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> f <span class="kw">in</span> factor_cols:</span>
<span id="cb20-1315"><a href="#cb20-1315" aria-hidden="true" tabindex="-1"></a>                entry[<span class="ss">f'beta_</span><span class="sc">{</span>f<span class="sc">}</span><span class="ss">'</span>] <span class="op">=</span> model.params[f]</span>
<span id="cb20-1316"><a href="#cb20-1316" aria-hidden="true" tabindex="-1"></a>            betas_t.append(entry)</span>
<span id="cb20-1317"><a href="#cb20-1317" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-1318"><a href="#cb20-1318" aria-hidden="true" tabindex="-1"></a>            <span class="cf">pass</span></span>
<span id="cb20-1319"><a href="#cb20-1319" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1320"><a href="#cb20-1320" aria-hidden="true" tabindex="-1"></a>    rolling_betas[port] <span class="op">=</span> pd.DataFrame(betas_t)</span>
<span id="cb20-1321"><a href="#cb20-1321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1322"><a href="#cb20-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1325"><a href="#cb20-1325" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb20-1326"><a href="#cb20-1326" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rolling-betas</span></span>
<span id="cb20-1327"><a href="#cb20-1327" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb20-1328"><a href="#cb20-1328" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rolling 36-month market betas for four representative portfolios (corners of the 5√ó5 size-BM sort). Betas vary substantially over time, particularly for the small-cap portfolios. This time-variation means that unconditional time-series tests may reject a correctly specified conditional model, and that cross-sectional Fama-MacBeth regressions with rolling betas may give different results from those with full-sample betas."</span></span>
<span id="cb20-1329"><a href="#cb20-1329" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot rolling betas over time"</span></span>
<span id="cb20-1330"><a href="#cb20-1330" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>))</span>
<span id="cb20-1331"><a href="#cb20-1331" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb20-1332"><a href="#cb20-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1333"><a href="#cb20-1333" aria-hidden="true" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">'Small-Growth'</span>, <span class="st">'Small-Value'</span>, <span class="st">'Big-Growth'</span>, <span class="st">'Big-Value'</span>]</span>
<span id="cb20-1334"><a href="#cb20-1334" aria-hidden="true" tabindex="-1"></a>colors_port <span class="op">=</span> [<span class="st">'#C0392B'</span>, <span class="st">'#2C5F8A'</span>, <span class="st">'#E67E22'</span>, <span class="st">'#27AE60'</span>]</span>
<span id="cb20-1335"><a href="#cb20-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1336"><a href="#cb20-1336" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (port, label, color) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(representative, labels, colors_port)):</span>
<span id="cb20-1337"><a href="#cb20-1337" aria-hidden="true" tabindex="-1"></a>    rb <span class="op">=</span> rolling_betas[port]</span>
<span id="cb20-1338"><a href="#cb20-1338" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1339"><a href="#cb20-1339" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(pd.to_datetime(rb[<span class="st">'month'</span>]), rb[<span class="st">'beta_mkt_excess'</span>],</span>
<span id="cb20-1340"><a href="#cb20-1340" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">'Market Œ≤'</span>)</span>
<span id="cb20-1341"><a href="#cb20-1341" aria-hidden="true" tabindex="-1"></a>    axes[i].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb20-1342"><a href="#cb20-1342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1343"><a href="#cb20-1343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add HML beta</span></span>
<span id="cb20-1344"><a href="#cb20-1344" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(pd.to_datetime(rb[<span class="st">'month'</span>]), rb[<span class="st">'beta_hml'</span>],</span>
<span id="cb20-1345"><a href="#cb20-1345" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">':'</span>, label<span class="op">=</span><span class="st">'HML Œ≤'</span>)</span>
<span id="cb20-1346"><a href="#cb20-1346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-1347"><a href="#cb20-1347" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Beta'</span>)</span>
<span id="cb20-1348"><a href="#cb20-1348" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(label)</span>
<span id="cb20-1349"><a href="#cb20-1349" aria-hidden="true" tabindex="-1"></a>    axes[i].legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb20-1350"><a href="#cb20-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1351"><a href="#cb20-1351" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Rolling 36-Month Factor Betas'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb20-1352"><a href="#cb20-1352" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-1353"><a href="#cb20-1353" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb20-1354"><a href="#cb20-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1355"><a href="#cb20-1355" aria-hidden="true" tabindex="-1"></a><span class="co"># Quantify time-variation</span></span>
<span id="cb20-1356"><a href="#cb20-1356" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Beta Time-Variation (Std Dev of Rolling Betas):"</span>)</span>
<span id="cb20-1357"><a href="#cb20-1357" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> port, label <span class="kw">in</span> <span class="bu">zip</span>(representative, labels):</span>
<span id="cb20-1358"><a href="#cb20-1358" aria-hidden="true" tabindex="-1"></a>    rb <span class="op">=</span> rolling_betas[port]</span>
<span id="cb20-1359"><a href="#cb20-1359" aria-hidden="true" tabindex="-1"></a>    mkt_std <span class="op">=</span> rb[<span class="st">'beta_mkt_excess'</span>].std()</span>
<span id="cb20-1360"><a href="#cb20-1360" aria-hidden="true" tabindex="-1"></a>    hml_std <span class="op">=</span> rb[<span class="st">'beta_hml'</span>].std()</span>
<span id="cb20-1361"><a href="#cb20-1361" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>label<span class="sc">:&lt;15}</span><span class="ss">: œÉ(Œ≤_MKT) = </span><span class="sc">{</span>mkt_std<span class="sc">:.3f}</span><span class="ss">, œÉ(Œ≤_HML) = </span><span class="sc">{</span>hml_std<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb20-1362"><a href="#cb20-1362" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb20-1363"><a href="#cb20-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1364"><a href="#cb20-1364" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Recommendations {#sec-ts-cs-recommendations}</span></span>
<span id="cb20-1365"><a href="#cb20-1365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1366"><a href="#cb20-1366" aria-hidden="true" tabindex="-1"></a>The analysis in this chapter yields the following guidelines for Vietnamese asset pricing research:</span>
<span id="cb20-1367"><a href="#cb20-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1368"><a href="#cb20-1368" aria-hidden="true" tabindex="-1"></a>**Use both approaches.** Time-series tests (GRS) and cross-sectional tests (Fama-MacBeth) answer different questions. Always report both. If they disagree, investigate *why* rather than cherry-picking the more favorable result.</span>
<span id="cb20-1369"><a href="#cb20-1369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1370"><a href="#cb20-1370" aria-hidden="true" tabindex="-1"></a>**Be cautious with cross-sectional** $R^2$. High $R^2$ from Fama-MacBeth on sorted portfolios is nearly guaranteed by the test asset structure. Always report the @lewellen2010skeptical constrained $R^2$ alongside the unconstrained value. Include industry portfolios as additional test assets.</span>
<span id="cb20-1371"><a href="#cb20-1371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1372"><a href="#cb20-1372" aria-hidden="true" tabindex="-1"></a>**Apply the Shanken correction.** The EIV bias from estimated betas inflates Fama-MacBeth t-statistics. Always report Shanken-corrected standard errors for full-sample betas. For rolling betas, the correction is not straightforward, but the bias is smaller because beta estimation error averages out over time.</span>
<span id="cb20-1373"><a href="#cb20-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1374"><a href="#cb20-1374" aria-hidden="true" tabindex="-1"></a>**Use individual stocks with caution.** Fama-MacBeth with individual stocks avoids the Lewellen-Nagel-Shanken critique but introduces severe noise: individual Vietnamese stocks are thin, volatile, and the monthly cross-section is small (500-700). The resulting risk premia will have wide confidence intervals. Report the average number of stocks per cross-section and the cross-sectional $R^2$.</span>
<span id="cb20-1375"><a href="#cb20-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1376"><a href="#cb20-1376" aria-hidden="true" tabindex="-1"></a>**Examine conditional models.** Rolling betas reveal substantial time-variation in Vietnamese stock exposures. If the research question is about risk compensation (does beta predict returns?), use rolling betas and control for time-variation. If the question is about model adequacy (do the factors span the mean-variance frontier?), full-sample betas and the GRS test are appropriate.</span>
<span id="cb20-1377"><a href="#cb20-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1378"><a href="#cb20-1378" aria-hidden="true" tabindex="-1"></a>**For model selection, use Barillas-Shanken.** When comparing competing factor models (e.g., FF3 vs. FF5), the @barillas2018comparing approach (i.e., testing whether each model's unique factors have alpha with respect to the other) is more informative than comparing GRS statistics on the same test assets.</span>
<span id="cb20-1379"><a href="#cb20-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1380"><a href="#cb20-1380" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary {#sec-ts-cs-summary}</span></span>
<span id="cb20-1381"><a href="#cb20-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1382"><a href="#cb20-1382" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Test <span class="pp">|</span> Question <span class="pp">|</span> Statistic <span class="pp">|</span> Strength <span class="pp">|</span> Weakness <span class="pp">|</span></span>
<span id="cb20-1383"><a href="#cb20-1383" aria-hidden="true" tabindex="-1"></a><span class="pp">|---------------|---------------|---------------|---------------|---------------|</span></span>
<span id="cb20-1384"><a href="#cb20-1384" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> TS regression (GRS) <span class="pp">|</span> Do all alphas = 0? <span class="pp">|</span> F-statistic <span class="pp">|</span> Clean null; joint test <span class="pp">|</span> Depends on test assets <span class="pp">|</span></span>
<span id="cb20-1385"><a href="#cb20-1385" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fama-MacBeth (portfolios) <span class="pp">|</span> Are betas priced? <span class="pp">|</span> $\bar{\gamma}$, t-stat <span class="pp">|</span> Estimates risk premia <span class="pp">|</span> EIV bias; LNS critique <span class="pp">|</span></span>
<span id="cb20-1386"><a href="#cb20-1386" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> FM (individual stocks) <span class="pp">|</span> Are betas priced? <span class="pp">|</span> $\bar{\gamma}$, t-stat <span class="pp">|</span> Avoids sorted portfolios <span class="pp">|</span> Noisy; small cross-section <span class="pp">|</span></span>
<span id="cb20-1387"><a href="#cb20-1387" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> LNS diagnostic <span class="pp">|</span> Is CS R¬≤ spurious? <span class="pp">|</span> Constrained R¬≤ <span class="pp">|</span> Reveals false positives <span class="pp">|</span> Only applicable to portfolios <span class="pp">|</span></span>
<span id="cb20-1388"><a href="#cb20-1388" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> GMM / SDF <span class="pp">|</span> Pricing errors jointly <span class="pp">|</span> J-stat, HJ distance <span class="pp">|</span> Flexible; model-free <span class="pp">|</span> Requires large N relative to K <span class="pp">|</span></span>
<span id="cb20-1389"><a href="#cb20-1389" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Barillas-Shanken <span class="pp">|</span> Which model is better? <span class="pp">|</span> Alpha of unique factors <span class="pp">|</span> Model comparison <span class="pp">|</span> Requires traded factors <span class="pp">|</span></span>
<span id="cb20-1390"><a href="#cb20-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1391"><a href="#cb20-1391" aria-hidden="true" tabindex="-1"></a>: Summary of testing approaches for factor models. {#tbl-ts-cs-summary-tests}</span>
<span id="cb20-1392"><a href="#cb20-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1393"><a href="#cb20-1393" aria-hidden="true" tabindex="-1"></a>The gap between time-series and cross-sectional evidence is not a technicality‚Äîit reflects a fundamental ambiguity in what "a factor model works" means. In a market like Vietnam, where the cross-section is small, betas are time-varying, and test assets are inherently noisy, the two approaches will often disagree. The honest researcher reports both, investigates the source of disagreement, and treats any single test result with appropriate humility.</span>
<span id="cb20-1394"><a href="#cb20-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1395"><a href="#cb20-1395" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises {#sec-ts-cs-exercises}</span></span>
<span id="cb20-1396"><a href="#cb20-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1397"><a href="#cb20-1397" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Characteristic vs. covariance.** Run Fama-MacBeth regressions that include both estimated factor betas *and* the raw characteristics (log market cap, book-to-market, past returns) as independent variables. Which has more explanatory power‚Äîthe betas or the characteristics? This tests the @goyal2018cross hypothesis that characteristics dominate covariances in explaining the cross-section.</span></span>
<span id="cb20-1398"><a href="#cb20-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1399"><a href="#cb20-1399" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Spanning with anomaly portfolios.** Use the 10 highest-t-statistic anomalies from the factor zoo chapter as test assets (instead of size-BM sorted portfolios). Run GRS tests for the CAPM, FF3, and FF5 models. Which anomalies remain unspanned?</span></span>
<span id="cb20-1400"><a href="#cb20-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1401"><a href="#cb20-1401" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Conditional Fama-MacBeth.** Interact factor betas with a conditioning variable (VIX, VN-Index volatility, or the SBV policy rate) to create time-varying risk premia. Does the conditional model outperform the unconditional model in cross-sectional $R^2$?</span></span>
<span id="cb20-1402"><a href="#cb20-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1403"><a href="#cb20-1403" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Bootstrap GRS.** The GRS test assumes multivariate normality of returns. Implement a bootstrap version: resample the time series 10,000 times and compute the empirical distribution of the GRS statistic under the null. Compare the bootstrap p-value to the asymptotic p-value. How much do they differ for Vietnamese data?</span></span>
<span id="cb20-1404"><a href="#cb20-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1405"><a href="#cb20-1405" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Instrumented PCA.** Implement the @kelly2019characteristics instrumented PCA (IPCA) model, which allows betas to vary with observable characteristics. Estimate the latent factors and their time-varying loadings. How many factors does IPCA select for the Vietnamese market?</span></span>
<span id="cb20-1406"><a href="#cb20-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1407"><a href="#cb20-1407" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Test asset sensitivity.** Run the full battery of tests (GRS, Fama-MacBeth, GMM) separately for three test asset sets: (a) 25 size-BM, (b) 25 size-momentum, (c) 25 size-profitability. Do the same models win across all test asset sets, or is model ranking test-asset-dependent?</span></span>
<span id="cb20-1408"><a href="#cb20-1408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1409"><a href="#cb20-1409" aria-hidden="true" tabindex="-1"></a><span class="co">7.  **Small-sample adjustment.** With only \~200 months of Vietnamese data, small-sample bias in the GRS test may be severe. Implement the @kan2013pricing finite-sample correction. How does the corrected GRS compare to the asymptotic version?</span></span>
<span id="cb20-1410"><a href="#cb20-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-1411"><a href="#cb20-1411" aria-hidden="true" tabindex="-1"></a><span class="co">8.  **Global vs. local factors.** Augment the Vietnamese FF5 model with global factors (MSCI World excess return, global SMB, global HML from Kenneth French's data library). Run GRS tests with and without the global factors. Does adding global factors improve pricing of Vietnamese portfolios, as @griffin2002fama would predict? --&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/26_time_series_vs_cross_section.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>