<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7&nbsp; Compound Returns ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./10_modern_portfolio_theory.html" rel="next">
<link href="./05_working_with_stock_returns.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="7&nbsp; Compound Returns ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:image" content="https://mikenguyen13.github.io/tidy_finance_vn_vi/06_compound_return_files/figure-html/fig-wealth-index-output-1.png">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:image:alt" content="Line chart showing the growth of 1 VND invested in five different Vietnamese stocks over time.">
<meta property="og:image:height" content="959">
<meta property="og:image:width" content="1919">
<meta name="twitter:title" content="7&nbsp; Compound Returns ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://mikenguyen13.github.io/tidy_finance_vn_vi/06_compound_return_files/figure-html/fig-wealth-index-output-1.png">
<meta name="twitter:image:alt" content="Line chart showing the growth of 1 VND invested in five different Vietnamese stocks over time.">
<meta name="twitter:image-height" content="959">
<meta name="twitter:image-width" content="1919">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_institutional_background.html">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</a></li><li class="breadcrumb-item"><a href="./06_compound_return.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#simple-returns-versus-log-returns" id="toc-simple-returns-versus-log-returns" class="nav-link active" data-scroll-target="#simple-returns-versus-log-returns"><span class="header-section-number">7.1</span> Simple Returns versus Log Returns</a>
  <ul class="collapse">
  <li><a href="#simple-arithmetic-returns" id="toc-simple-arithmetic-returns" class="nav-link" data-scroll-target="#simple-arithmetic-returns"><span class="header-section-number">7.1.1</span> Simple (Arithmetic) Returns</a></li>
  <li><a href="#continuously-compounded-log-returns" id="toc-continuously-compounded-log-returns" class="nav-link" data-scroll-target="#continuously-compounded-log-returns"><span class="header-section-number">7.1.2</span> Continuously Compounded (Log) Returns</a></li>
  <li><a href="#when-do-they-diverge" id="toc-when-do-they-diverge" class="nav-link" data-scroll-target="#when-do-they-diverge"><span class="header-section-number">7.1.3</span> When Do They Diverge?</a></li>
  </ul></li>
  <li><a href="#mathematical-foundations-of-compounding" id="toc-mathematical-foundations-of-compounding" class="nav-link" data-scroll-target="#mathematical-foundations-of-compounding"><span class="header-section-number">7.2</span> Mathematical Foundations of Compounding</a>
  <ul class="collapse">
  <li><a href="#geometric-mean-return" id="toc-geometric-mean-return" class="nav-link" data-scroll-target="#geometric-mean-return"><span class="header-section-number">7.2.1</span> Geometric Mean Return</a></li>
  <li><a href="#wealth-index-and-drawdowns" id="toc-wealth-index-and-drawdowns" class="nav-link" data-scroll-target="#wealth-index-and-drawdowns"><span class="header-section-number">7.2.2</span> Wealth Index and Drawdowns</a></li>
  <li><a href="#annualization" id="toc-annualization" class="nav-link" data-scroll-target="#annualization"><span class="header-section-number">7.2.3</span> Annualization</a></li>
  </ul></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">7.3</span> Data Preparation</a></li>
  <li><a href="#method-1-cumulative-product-via-groupby" id="toc-method-1-cumulative-product-via-groupby" class="nav-link" data-scroll-target="#method-1-cumulative-product-via-groupby"><span class="header-section-number">7.4</span> Method 1: Cumulative Product via GroupBy</a>
  <ul class="collapse">
  <li><a href="#handling-missing-returns" id="toc-handling-missing-returns" class="nav-link" data-scroll-target="#handling-missing-returns"><span class="header-section-number">7.4.1</span> Handling Missing Returns</a></li>
  </ul></li>
  <li><a href="#method-2-log-sum-exp-approach" id="toc-method-2-log-sum-exp-approach" class="nav-link" data-scroll-target="#method-2-log-sum-exp-approach"><span class="header-section-number">7.5</span> Method 2: Log-Sum-Exp Approach</a>
  <ul class="collapse">
  <li><a href="#period-specific-compound-returns" id="toc-period-specific-compound-returns" class="nav-link" data-scroll-target="#period-specific-compound-returns"><span class="header-section-number">7.5.1</span> Period-Specific Compound Returns</a></li>
  </ul></li>
  <li><a href="#method-3-iterative-compounding-with-retain-logic" id="toc-method-3-iterative-compounding-with-retain-logic" class="nav-link" data-scroll-target="#method-3-iterative-compounding-with-retain-logic"><span class="header-section-number">7.6</span> Method 3: Iterative Compounding with Retain Logic</a>
  <ul class="collapse">
  <li><a href="#comparison-of-missing-value-treatments" id="toc-comparison-of-missing-value-treatments" class="nav-link" data-scroll-target="#comparison-of-missing-value-treatments"><span class="header-section-number">7.6.1</span> Comparison of Missing Value Treatments</a></li>
  </ul></li>
  <li><a href="#method-4-rolling-compound-returns" id="toc-method-4-rolling-compound-returns" class="nav-link" data-scroll-target="#method-4-rolling-compound-returns"><span class="header-section-number">7.7</span> Method 4: Rolling Compound Returns</a>
  <ul class="collapse">
  <li><a href="#rolling-window-via-log-returns" id="toc-rolling-window-via-log-returns" class="nav-link" data-scroll-target="#rolling-window-via-log-returns"><span class="header-section-number">7.7.1</span> Rolling Window via Log Returns</a></li>
  <li><a href="#verifying-rolling-returns" id="toc-verifying-rolling-returns" class="nav-link" data-scroll-target="#verifying-rolling-returns"><span class="header-section-number">7.7.2</span> Verifying Rolling Returns</a></li>
  </ul></li>
  <li><a href="#delisting-returns-and-survivorship-bias" id="toc-delisting-returns-and-survivorship-bias" class="nav-link" data-scroll-target="#delisting-returns-and-survivorship-bias"><span class="header-section-number">7.8</span> Delisting Returns and Survivorship Bias</a>
  <ul class="collapse">
  <li><a href="#the-vietnamese-context" id="toc-the-vietnamese-context" class="nav-link" data-scroll-target="#the-vietnamese-context"><span class="header-section-number">7.8.1</span> The Vietnamese Context</a></li>
  <li><a href="#incorporating-delisting-returns" id="toc-incorporating-delisting-returns" class="nav-link" data-scroll-target="#incorporating-delisting-returns"><span class="header-section-number">7.8.2</span> Incorporating Delisting Returns</a></li>
  <li><a href="#impact-of-delisting-adjustment" id="toc-impact-of-delisting-adjustment" class="nav-link" data-scroll-target="#impact-of-delisting-adjustment"><span class="header-section-number">7.8.3</span> Impact of Delisting Adjustment</a></li>
  </ul></li>
  <li><a href="#rolling-volatility-estimation" id="toc-rolling-volatility-estimation" class="nav-link" data-scroll-target="#rolling-volatility-estimation"><span class="header-section-number">7.9</span> Rolling Volatility Estimation</a>
  <ul class="collapse">
  <li><a href="#month-rolling-volatility" id="toc-month-rolling-volatility" class="nav-link" data-scroll-target="#month-rolling-volatility"><span class="header-section-number">7.9.1</span> 24-Month Rolling Volatility</a></li>
  <li><a href="#volatility-and-compound-returns-the-variance-drain" id="toc-volatility-and-compound-returns-the-variance-drain" class="nav-link" data-scroll-target="#volatility-and-compound-returns-the-variance-drain"><span class="header-section-number">7.9.2</span> Volatility and Compound Returns: The Variance Drain</a></li>
  </ul></li>
  <li><a href="#compound-returns-around-fiscal-year-ends" id="toc-compound-returns-around-fiscal-year-ends" class="nav-link" data-scroll-target="#compound-returns-around-fiscal-year-ends"><span class="header-section-number">7.10</span> Compound Returns Around Fiscal Year Ends</a>
  <ul class="collapse">
  <li><a href="#aligning-returns-to-fiscal-periods" id="toc-aligning-returns-to-fiscal-periods" class="nav-link" data-scroll-target="#aligning-returns-to-fiscal-periods"><span class="header-section-number">7.10.1</span> Aligning Returns to Fiscal Periods</a></li>
  <li><a href="#buy-and-hold-abnormal-returns-versus-cumulative-abnormal-returns" id="toc-buy-and-hold-abnormal-returns-versus-cumulative-abnormal-returns" class="nav-link" data-scroll-target="#buy-and-hold-abnormal-returns-versus-cumulative-abnormal-returns"><span class="header-section-number">7.10.2</span> Buy-and-Hold Abnormal Returns versus Cumulative Abnormal Returns</a></li>
  </ul></li>
  <li><a href="#book-value-of-equity" id="toc-book-value-of-equity" class="nav-link" data-scroll-target="#book-value-of-equity"><span class="header-section-number">7.11</span> Book Value of Equity</a></li>
  <li><a href="#maximum-drawdown" id="toc-maximum-drawdown" class="nav-link" data-scroll-target="#maximum-drawdown"><span class="header-section-number">7.12</span> Maximum Drawdown</a></li>
  <li><a href="#putting-it-all-together-a-comprehensive-pipeline" id="toc-putting-it-all-together-a-comprehensive-pipeline" class="nav-link" data-scroll-target="#putting-it-all-together-a-comprehensive-pipeline"><span class="header-section-number">7.13</span> Putting It All Together: A Comprehensive Pipeline</a></li>
  <li><a href="#cross-sectional-distribution-of-compound-returns" id="toc-cross-sectional-distribution-of-compound-returns" class="nav-link" data-scroll-target="#cross-sectional-distribution-of-compound-returns"><span class="header-section-number">7.14</span> Cross-Sectional Distribution of Compound Returns</a></li>
  <li><a href="#vietnam-specific-considerations" id="toc-vietnam-specific-considerations" class="nav-link" data-scroll-target="#vietnam-specific-considerations"><span class="header-section-number">7.15</span> Vietnam-Specific Considerations</a>
  <ul class="collapse">
  <li><a href="#price-limits-and-their-effect-on-compounding" id="toc-price-limits-and-their-effect-on-compounding" class="nav-link" data-scroll-target="#price-limits-and-their-effect-on-compounding"><span class="header-section-number">7.15.1</span> Price Limits and Their Effect on Compounding</a></li>
  <li><a href="#foreign-ownership-limits" id="toc-foreign-ownership-limits" class="nav-link" data-scroll-target="#foreign-ownership-limits"><span class="header-section-number">7.15.2</span> Foreign Ownership Limits</a></li>
  <li><a href="#the-vn-index-and-market-benchmarks" id="toc-the-vn-index-and-market-benchmarks" class="nav-link" data-scroll-target="#the-vn-index-and-market-benchmarks"><span class="header-section-number">7.15.3</span> The VN-Index and Market Benchmarks</a></li>
  </ul></li>
  <li><a href="#performance-considerations" id="toc-performance-considerations" class="nav-link" data-scroll-target="#performance-considerations"><span class="header-section-number">7.16</span> Performance Considerations</a></li>
  <li><a href="#common-pitfalls-and-best-practices" id="toc-common-pitfalls-and-best-practices" class="nav-link" data-scroll-target="#common-pitfalls-and-best-practices"><span class="header-section-number">7.17</span> Common Pitfalls and Best Practices</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/06_compound_return.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_institutional_background.html">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</a></li><li class="breadcrumb-item"><a href="./06_compound_return.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>In this chapter, we provide a treatment of compound returns. Whether constructing buy-and-hold portfolios, evaluating fund performance, computing cumulative wealth indices, or estimating long-horizon risk measures, the ability to correctly compound returns over arbitrary horizons is indispensable. We begin with the mathematical foundations: the distinction between simple and log returns, the relationship between arithmetic and geometric means, and the properties of continuously compounded returns. Along the way, we address practical complications that arise in real-world equity data, such as trading halts, price limit mechanisms, partial-period returns, and delisting events, and show how to handle them in the Vietnamese context.</p>
<p>The chapter proceeds to rolling compound returns over standard horizons (3, 6, 9, and 12 months), compound returns aligned to fiscal period ends, forward-looking cumulative returns for event studies, and rolling volatility estimation.</p>
<div id="e520cf80" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format, date_format</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="simple-returns-versus-log-returns" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="simple-returns-versus-log-returns"><span class="header-section-number">7.1</span> Simple Returns versus Log Returns</h2>
<p>Before discussing compounding, we must distinguish between the two fundamental return conventions used in finance.</p>
<section id="simple-arithmetic-returns" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1" class="anchored" data-anchor-id="simple-arithmetic-returns"><span class="header-section-number">7.1.1</span> Simple (Arithmetic) Returns</h3>
<p>The simple gross return on an asset from period <span class="math inline">\(t-1\)</span> to <span class="math inline">\(t\)</span> is defined as</p>
<p><span id="eq-simple-return"><span class="math display">\[
1 + R_t = \frac{P_t + D_t}{P_{t-1}},
\tag{7.1}\]</span></span></p>
<p>where <span class="math inline">\(P_t\)</span> denotes the price at the end of period <span class="math inline">\(t\)</span> and <span class="math inline">\(D_t\)</span> denotes any cash distributions (dividends, coupons) paid during period <span class="math inline">\(t\)</span>. The simple net return is <span class="math inline">\(R_t\)</span> itself. When we speak of ‚Äúreturns‚Äù without qualification, we typically mean simple net returns.</p>
<p>The key property of simple returns is that <strong>multi-period compounding is multiplicative</strong>:</p>
<p><span id="eq-compound-simple"><span class="math display">\[
1 + R_t(k) = \prod_{j=0}^{k-1} (1 + R_{t-j}) = (1 + R_t)(1 + R_{t-1}) \cdots (1 + R_{t-k+1}),
\tag{7.2}\]</span></span></p>
<p>where <span class="math inline">\(R_t(k)\)</span> is the <span class="math inline">\(k\)</span>-period compound return ending at time <span class="math inline">\(t\)</span>. This multiplicative structure is the foundation of all compounding methods discussed in this chapter.</p>
</section>
<section id="continuously-compounded-log-returns" class="level3" data-number="7.1.2">
<h3 data-number="7.1.2" class="anchored" data-anchor-id="continuously-compounded-log-returns"><span class="header-section-number">7.1.2</span> Continuously Compounded (Log) Returns</h3>
<p>The continuously compounded return, or log return, is defined as</p>
<p><span id="eq-log-return"><span class="math display">\[
r_t = \ln(1 + R_t) = \ln\!\left(\frac{P_t + D_t}{P_{t-1}}\right).
\tag{7.3}\]</span></span></p>
<p>The central advantage of log returns for compounding is that <strong>multi-period compounding becomes additive</strong>:</p>
<p><span id="eq-compound-log"><span class="math display">\[
r_t(k) = \ln(1 + R_t(k)) = \sum_{j=0}^{k-1} r_{t-j} = r_t + r_{t-1} + \cdots + r_{t-k+1}.
\tag{7.4}\]</span></span></p>
<p>This additive property follows directly from the logarithmic identity <span class="math inline">\(\ln(ab) = \ln(a) + \ln(b)\)</span>. It is computationally convenient because summation is numerically more stable than iterated multiplication, and because many statistical procedures (means, variances, regressions) operate naturally on additive quantities.</p>
<p>To recover the simple compound return from the sum of log returns, we apply the exponential function:</p>
<p><span id="eq-recover-simple"><span class="math display">\[
R_t(k) = \exp\!\left(\sum_{j=0}^{k-1} r_{t-j}\right) - 1.
\tag{7.5}\]</span></span></p>
</section>
<section id="when-do-they-diverge" class="level3" data-number="7.1.3">
<h3 data-number="7.1.3" class="anchored" data-anchor-id="when-do-they-diverge"><span class="header-section-number">7.1.3</span> When Do They Diverge?</h3>
<p>For small returns, the approximation <span class="math inline">\(r_t \approx R_t\)</span> holds to first order (via the Taylor expansion <span class="math inline">\(\ln(1+x) \approx x\)</span> for <span class="math inline">\(|x| \ll 1\)</span>). However, for large returns, which is common in emerging markets, small-cap stocks, or crisis periods, the two can diverge substantially. Consider a stock that doubles in price (<span class="math inline">\(R_t = 1.0\)</span>): the log return is <span class="math inline">\(r_t = \ln(2) \approx 0.693\)</span>, a 31% discrepancy. Conversely, for a stock that loses half its value (<span class="math inline">\(R_t = -0.5\)</span>): the log return is <span class="math inline">\(r_t = \ln(0.5) \approx -0.693\)</span>, which is 39% larger in magnitude.</p>
<p>This divergence is especially relevant in Vietnam, where daily price limits of <span class="math inline">\(\pm 7\%\)</span> on HOSE, <span class="math inline">\(\pm 10\%\)</span> on HNX, and <span class="math inline">\(\pm 15\%\)</span> on UPCoM can produce sequences of limit-up or limit-down days. Over a week of consecutive limit-up days on HOSE, the simple return is <span class="math inline">\((1.07)^5 - 1 = 40.3\%\)</span> while the log return is <span class="math inline">\(5 \times \ln(1.07) = 33.8\%\)</span>, which is a meaningful gap.</p>
<p><a href="#tbl-return-comparison" class="quarto-xref">Table&nbsp;<span>7.1</span></a> illustrates this divergence across a range of return magnitudes.</p>
<div class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>simple_returns <span class="op">=</span> [<span class="op">-</span><span class="fl">0.50</span>, <span class="op">-</span><span class="fl">0.30</span>, <span class="op">-</span><span class="fl">0.15</span>, <span class="op">-</span><span class="fl">0.10</span>, <span class="op">-</span><span class="fl">0.07</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.01</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.00</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.07</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.30</span>, <span class="fl">0.50</span>, <span class="fl">1.00</span>]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple Return"</span>: [<span class="ss">f"</span><span class="sc">{</span>r<span class="sc">:.2%}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Log Return"</span>: [<span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>log(<span class="dv">1</span><span class="op">+</span>r)<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Difference"</span>: [<span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>log(<span class="dv">1</span><span class="op">+</span>r) <span class="op">-</span> r<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Relative Error (%)"</span>: [</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>((np.log(<span class="dv">1</span><span class="op">+</span>r) <span class="op">-</span> r) <span class="op">/</span> <span class="bu">abs</span>(r) <span class="op">*</span> <span class="dv">100</span>)<span class="sc">:.2f}</span><span class="ss">"</span> <span class="cf">if</span> r <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"‚Äî"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> simple_returns</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>comparison_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-return-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="3">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-return-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.1: Comparison of simple and log returns for various price changes. The divergence grows with the magnitude of the simple return, which is particularly relevant for volatile emerging market stocks.
</figcaption>
<div aria-describedby="tbl-return-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Simple Return</th>
<th data-quarto-table-cell-role="th">Log Return</th>
<th data-quarto-table-cell-role="th">Difference</th>
<th data-quarto-table-cell-role="th">Relative Error (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>-50.00%</td>
<td>-0.6931</td>
<td>-0.1931</td>
<td>-38.63</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>-30.00%</td>
<td>-0.3567</td>
<td>-0.0567</td>
<td>-18.89</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>-15.00%</td>
<td>-0.1625</td>
<td>-0.0125</td>
<td>-8.35</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>-10.00%</td>
<td>-0.1054</td>
<td>-0.0054</td>
<td>-5.36</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>-7.00%</td>
<td>-0.0726</td>
<td>-0.0026</td>
<td>-3.67</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>-5.00%</td>
<td>-0.0513</td>
<td>-0.0013</td>
<td>-2.59</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>-1.00%</td>
<td>-0.0101</td>
<td>-0.0001</td>
<td>-0.50</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>0.00%</td>
<td>0.0000</td>
<td>0.0000</td>
<td>‚Äî</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>1.00%</td>
<td>0.0100</td>
<td>-0.0000</td>
<td>-0.50</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>5.00%</td>
<td>0.0488</td>
<td>-0.0012</td>
<td>-2.42</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">10</th>
<td>7.00%</td>
<td>0.0677</td>
<td>-0.0023</td>
<td>-3.34</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">11</th>
<td>10.00%</td>
<td>0.0953</td>
<td>-0.0047</td>
<td>-4.69</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">12</th>
<td>15.00%</td>
<td>0.1398</td>
<td>-0.0102</td>
<td>-6.83</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13</th>
<td>30.00%</td>
<td>0.2624</td>
<td>-0.0376</td>
<td>-12.55</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">14</th>
<td>50.00%</td>
<td>0.4055</td>
<td>-0.0945</td>
<td>-18.91</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">15</th>
<td>100.00%</td>
<td>0.6931</td>
<td>-0.3069</td>
<td>-30.69</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<blockquote class="blockquote">
<p><strong>Key takeaway</strong>: log returns are convenient for compounding (additive aggregation), but portfolio returns aggregate cross-sectionally in simple return space. In practice, we often transform to log returns for temporal compounding, then convert back to simple returns for reporting.</p>
</blockquote>
</section>
</section>
<section id="mathematical-foundations-of-compounding" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="mathematical-foundations-of-compounding"><span class="header-section-number">7.2</span> Mathematical Foundations of Compounding</h2>
<section id="geometric-mean-return" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="geometric-mean-return"><span class="header-section-number">7.2.1</span> Geometric Mean Return</h3>
<p>The geometric mean return over <span class="math inline">\(T\)</span> periods is</p>
<p><span id="eq-geometric-mean"><span class="math display">\[
\bar{R}_g = \left(\prod_{t=1}^{T} (1 + R_t)\right)^{1/T} - 1,
\tag{7.6}\]</span></span></p>
<p>which represents the constant per-period return that would yield the same terminal wealth as the actual return sequence. It is always less than or equal to the arithmetic mean <span class="math inline">\(\bar{R}_a = \frac{1}{T}\sum_{t=1}^{T} R_t\)</span>, with equality only when all returns are identical. The relationship between the two is approximately:</p>
<p><span id="eq-arithmetic-geometric"><span class="math display">\[
\bar{R}_g \approx \bar{R}_a - \frac{\sigma^2}{2},
\tag{7.7}\]</span></span></p>
<p>where <span class="math inline">\(\sigma^2\)</span> is the variance of returns. This approximation, sometimes called the ‚Äúvolatility drag,‚Äù has important implications: high-volatility assets have a larger wedge between their arithmetic and geometric means, meaning their actual compound growth understates what a naive average would suggest. In a market like Vietnam‚Äôs, where individual stock volatility is often two to three times that of developed-market equities, the volatility drag can be substantial.</p>
</section>
<section id="wealth-index-and-drawdowns" class="level3" data-number="7.2.2">
<h3 data-number="7.2.2" class="anchored" data-anchor-id="wealth-index-and-drawdowns"><span class="header-section-number">7.2.2</span> Wealth Index and Drawdowns</h3>
<p>Given an initial investment of <span class="math inline">\(W_0\)</span>, the wealth at time <span class="math inline">\(T\)</span> is</p>
<p><span id="eq-wealth-index"><span class="math display">\[
W_T = W_0 \prod_{t=1}^{T} (1 + R_t).
\tag{7.8}\]</span></span></p>
<p>The cumulative return (net) is simply <span class="math inline">\(W_T / W_0 - 1\)</span>. The maximum drawdown, a widely used risk measure, is defined as</p>
<p><span id="eq-max-drawdown"><span class="math display">\[
\text{MDD} = \max_{0 \le s \le t \le T} \left(\frac{W_s - W_t}{W_s}\right),
\tag{7.9}\]</span></span></p>
<p>which measures the largest peak-to-trough decline in the wealth index. We will compute this quantity alongside compound returns below. Drawdowns are particularly informative in emerging markets that experience sharp corrections, as occurred during the global financial crisis of 2008 when the VN-Index fell roughly 66% from its 2007 peak.</p>
<!--# Show the data here -->
</section>
<section id="annualization" class="level3" data-number="7.2.3">
<h3 data-number="7.2.3" class="anchored" data-anchor-id="annualization"><span class="header-section-number">7.2.3</span> Annualization</h3>
<p>For a <span class="math inline">\(k\)</span>-period compound return <span class="math inline">\(R_t(k)\)</span> where each period has length <span class="math inline">\(\Delta\)</span> (e.g., <span class="math inline">\(\Delta = 1/12\)</span> for monthly data), the annualized return is</p>
<p><span id="eq-annualize"><span class="math display">\[
R_{\text{ann}} = (1 + R_t(k))^{1/(k\Delta)} - 1.
\tag{7.10}\]</span></span></p>
<p>Similarly, for volatility estimated from <span class="math inline">\(k\)</span>-period returns with period length <span class="math inline">\(\Delta\)</span>:</p>
<p><span id="eq-annualize-vol"><span class="math display">\[
\sigma_{\text{ann}} = \sigma / \sqrt{\Delta},
\tag{7.11}\]</span></span></p>
<p>so monthly volatility is annualized by multiplying by <span class="math inline">\(\sqrt{12}\)</span> and daily volatility by approximately <span class="math inline">\(\sqrt{252}\)</span> (assuming 252 trading days per year). For Vietnam specifically, the HOSE typically has around 245‚Äì250 trading days per year after accounting for Vietnamese public holidays, which is close enough that the <span class="math inline">\(\sqrt{252}\)</span> convention is standard.</p>
</section>
</section>
<section id="data-preparation" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">7.3</span> Data Preparation</h2>
<p>We start by loading monthly stock return data from our SQLite database. As prepared in previous chapters, this database contains monthly returns sourced from <a href="https://datacore.vn/">DataCore.vn</a> for all securities listed on the Ho Chi Minh Stock Exchange (HOSE), Hanoi Stock Exchange (HNX), and the Unlisted Public Company Market (UPCoM). Returns are adjusted for stock splits, bonus issues, and rights offerings, and include reinvested cash dividends.</p>
<div id="2a57032d" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess, ret, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess FROM factors_ff3_monthly"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    factors_ff3_monthly,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"ret_total"</span>] <span class="op">=</span> prices_monthly[<span class="st">"ret"</span>]</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"mkt_total"</span>] <span class="op">=</span> (</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"mkt_excess"</span>] <span class="op">+</span> prices_monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let us inspect the sample:</p>
<div id="53d00e60" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample period: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Exchanges: {prices_monthly['exchange'].unique()}")</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Sample period: 2010-02-28 00:00:00 to 2023-12-31 00:00:00
Number of stocks: 1,457
Total observations: 165,499</code></pre>
</div>
</div>
<p><a href="#tbl-sample-overview" class="quarto-xref">Table&nbsp;<span>7.2</span></a> provides summary statistics for the raw monthly returns, broken down by exchange. Differences across exchanges reflect the size and liquidity gradient: HOSE lists the largest and most liquid firms, HNX covers mid-cap companies, and UPCoM hosts smaller and more thinly traded securities.</p>
<div id="tbl-sample-overview" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sample-overview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.2: Summary statistics of monthly stock returns by exchange. HOSE firms tend to have lower return dispersion and fewer extreme observations compared to HNX and UPCoM, consistent with their larger market capitalization and greater liquidity.
</figcaption>
<div aria-describedby="tbl-sample-overview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>sample_stats <span class="op">=</span> (</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"exchange"</span>)[<span class="st">"ret_total"</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    .describe(percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>])</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>sample_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
<section id="method-1-cumulative-product-via-groupby" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="method-1-cumulative-product-via-groupby"><span class="header-section-number">7.4</span> Method 1: Cumulative Product via GroupBy</h2>
<p>The most direct approach to compound returns uses the multiplicative property in <a href="#eq-compound-simple" class="quarto-xref">Equation&nbsp;<span>7.2</span></a>. For each security, we compute the cumulative product of gross returns <span class="math inline">\((1 + R_t)\)</span> over the desired window.</p>
<div id="9405ae63" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_cumprod(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                           group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns using cumulative product.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain `group_col`, 'date', and `ret_col`.</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Column name for period returns.</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Column name for grouping (e.g., security identifier).</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Original DataFrame augmented with 'cumret' and 'wealth_index'.</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col]</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index"</span>] <span class="op">=</span> (</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>]</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth_index"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let us apply this to the full sample and examine the resulting wealth indices for a few selected stocks:</p>
<div id="6d079c26" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>stock_cumret <span class="op">=</span> compute_cumret_cumprod(prices_monthly)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Select stocks with long histories for illustration</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>stock_counts <span class="op">=</span> (</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    stock_cumret.groupby(<span class="st">"symbol"</span>)[<span class="st">"date"</span>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    .count()</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>long_history_stocks <span class="op">=</span> (</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    stock_counts.nlargest(<span class="dv">5</span>, <span class="st">"n_obs"</span>)[<span class="st">"symbol"</span>].tolist()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>sample_wealth <span class="op">=</span> stock_cumret[</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    stock_cumret[<span class="st">"symbol"</span>].isin(long_history_stocks)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-wealth-index" class="quarto-xref">Figure&nbsp;<span>7.1</span></a> plots the wealth indices (value of 1 VND invested) for these five securities over the full sample period.</p>
<div id="cell-fig-wealth-index" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>plot_wealth <span class="op">=</span> (</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    ggplot(sample_wealth, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"wealth_index"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                              color<span class="op">=</span><span class="st">"factor(symbol)"</span>)) <span class="op">+</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="fl">0.6</span>) <span class="op">+</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Wealth index (1 VND invested)"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Stock"</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>          figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>plot_wealth.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div id="fig-wealth-index" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="htbp" alt="Line chart showing the growth of 1 VND invested in five different Vietnamese stocks over time.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-wealth-index-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06_compound_return_files/figure-html/fig-wealth-index-output-1.png" data-fig-pos="htbp" alt="Line chart showing the growth of 1 VND invested in five different Vietnamese stocks over time." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-wealth-index-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.1: Wealth index (value of 1 VND invested) for selected long-history Vietnamese stocks. Each line represents the cumulative value of a 1 VND investment in a single stock, with all dividends reinvested. The divergence in terminal wealth illustrates the power of compounding over long horizons.
</figcaption>
</figure>
</div>
</div>
</div>
<section id="handling-missing-returns" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="handling-missing-returns"><span class="header-section-number">7.4.1</span> Handling Missing Returns</h3>
<p>The cumulative product approach propagates missing values: if any <span class="math inline">\(R_t\)</span> is <code>NaN</code>, the entire cumulative product from that point onward becomes <code>NaN</code>. This is conservative because it effectively assumes that a missing return renders the subsequent wealth index undefined. In many applications, this is the desired behavior because a missing return may indicate a data error or a period during which the stock was not trading.</p>
<p>However, in the Vietnamese market, missing returns can arise from extended trading halts. The State Securities Commission (SSC) and exchanges may suspend trading in a stock for various regulatory reasons, such as financial reporting delays, pending corporate restructuring announcements, or suspected market manipulation. These halts can last days, weeks, or even months. During such halts, the stock‚Äôs value has not changed (the last traded price remains the reference), so treating the missing return as zero (i.e., no price change) may be more appropriate than propagating <code>NaN</code>.</p>
<div id="12742c34" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_skipna(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns, treating missing returns as zero."""</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col].fillna(<span class="dv">0</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index"</span>] <span class="op">=</span> (</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth_index"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Treating missing returns as zero is an assumption that may or may not be appropriate. If returns are missing because the stock was halted, zero may be reasonable. If returns are missing due to data errors or because the stock was genuinely not trading (e.g., awaiting relisting after a corporate event), imputing zero can introduce bias. Always investigate the reason for missing values before deciding on a treatment.</p>
</div>
</div>
<!--# The DataCore.vn documentation provides flags for different types of trading suspensions that can guide this decision. -->
</section>
</section>
<section id="method-2-log-sum-exp-approach" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="method-2-log-sum-exp-approach"><span class="header-section-number">7.5</span> Method 2: Log-Sum-Exp Approach</h2>
<p>The log-sum-exp method exploits the additive property of log returns (<a href="#eq-compound-log" class="quarto-xref">Equation&nbsp;<span>7.4</span></a>). This approach is particularly useful when computing compound returns over fixed windows (e.g., annual returns from monthly data) because summation is both computationally efficient and numerically stable.</p>
<div id="979286f1" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_logsum(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                          date_col<span class="op">=</span><span class="st">"date"</span>):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns using the log-sum-exp approach.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Steps:</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Transform to log returns: r_t = ln(1 + R_t)</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Cumulative sum of log returns within each group</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Exponentiate to recover simple cumulative return</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    date_col : str</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, date_col]).copy()</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_log_ret"</span>] <span class="op">=</span> (</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"log_ret"</span>].cumsum()</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index_log"</span>] <span class="op">=</span> np.exp(df[<span class="st">"cum_log_ret"</span>])</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret_log"</span>] <span class="op">=</span> df[<span class="st">"wealth_index_log"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"log_ret"</span>, <span class="st">"cum_log_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let us verify that the two methods produce identical results (up to floating-point precision):</p>
<div id="ffd42322" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>stock_both <span class="op">=</span> compute_cumret_cumprod(prices_monthly)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>stock_both <span class="op">=</span> compute_cumret_logsum(stock_both)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare on non-missing observations</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (stock_both[<span class="st">"cumret"</span>].notna()</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> stock_both[<span class="st">"cumret_log"</span>].notna())</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>max_diff <span class="op">=</span> (stock_both.loc[mask, <span class="st">"cumret"</span>] <span class="op">-</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            stock_both.loc[mask, <span class="st">"cumret_log"</span>]).<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Maximum absolute difference between methods: </span><span class="sc">{</span>max_diff<span class="sc">:.2e}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Maximum absolute difference between methods: 1.78e-14</code></pre>
</div>
</div>
<p>The difference is at the level of machine epsilon (<span class="math inline">\(\approx 10^{-15}\)</span>), confirming numerical equivalence.</p>
<section id="period-specific-compound-returns" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="period-specific-compound-returns"><span class="header-section-number">7.5.1</span> Period-Specific Compound Returns</h3>
<p>A common task is to compute compound returns within calendar periods (months, quarters, years). The log-sum-exp approach lends itself naturally to grouped aggregation:</p>
<div id="e6fe20d6" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compound_return_by_period(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>                              group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                              period<span class="op">=</span><span class="st">"year"</span>):</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute compound returns within calendar periods.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain 'date' and `ret_col`.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    period : str</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">        One of 'year', 'quarter', 'month'.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with compound returns per group-period.</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> period <span class="op">==</span> <span class="st">"year"</span>:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> period <span class="op">==</span> <span class="st">"quarter"</span>:</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.to_period(<span class="st">"Q"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> period <span class="op">==</span> <span class="st">"month"</span>:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> (</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        df.groupby([group_col, <span class="st">"period"</span>])</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            cumret<span class="op">=</span>(</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"log_ret"</span>,</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: np.exp(x.<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>            n_obs<span class="op">=</span>(<span class="st">"log_ret"</span>, <span class="st">"count"</span>),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>            n_miss<span class="op">=</span>(ret_col, <span class="kw">lambda</span> x: x.isna().<span class="bu">sum</span>()),</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>            start_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>            end_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#tbl-annual-returns" class="quarto-xref">Table&nbsp;<span>7.3</span></a> shows annual compound returns for a subset of securities.</p>
<div class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>annual_returns <span class="op">=</span> compound_return_by_period(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly[</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        prices_monthly[<span class="st">"symbol"</span>].isin(long_history_stocks)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    period<span class="op">=</span><span class="st">"year"</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>recent_annual <span class="op">=</span> (</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    annual_returns</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"symbol"</span>, <span class="st">"period"</span>])</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">5</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>recent_annual.head(<span class="dv">20</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_2229780/2619242959.py:13: UserWarning: obj.round has no effect with datetime, timedelta, or period dtypes. Use obj.dt.round(...) instead.</code></pre>
</div>
<div id="tbl-annual-returns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="14">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-annual-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.3: Annual compound returns for selected Vietnamese securities. The number of non-missing monthly observations (n_obs) and missing observations (n_miss) are reported to flag potentially incomplete years. A stock-year with n_obs substantially below 12 indicates either partial listing or extended trading halts.
</figcaption>
<div aria-describedby="tbl-annual-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">period</th>
<th data-quarto-table-cell-role="th">cumret</th>
<th data-quarto-table-cell-role="th">n_obs</th>
<th data-quarto-table-cell-role="th">n_miss</th>
<th data-quarto-table-cell-role="th">start_date</th>
<th data-quarto-table-cell-role="th">end_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>AAM</td>
<td>2019</td>
<td>-0.2810</td>
<td>12</td>
<td>0</td>
<td>2019-01-31</td>
<td>2019-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>AAM</td>
<td>2020</td>
<td>-0.1622</td>
<td>12</td>
<td>0</td>
<td>2020-01-31</td>
<td>2020-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">11</th>
<td>AAM</td>
<td>2021</td>
<td>0.1250</td>
<td>12</td>
<td>0</td>
<td>2021-01-31</td>
<td>2021-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">12</th>
<td>AAM</td>
<td>2022</td>
<td>-0.0913</td>
<td>12</td>
<td>0</td>
<td>2022-01-31</td>
<td>2022-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13</th>
<td>AAM</td>
<td>2023</td>
<td>-0.2337</td>
<td>12</td>
<td>0</td>
<td>2023-01-31</td>
<td>2023-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">23</th>
<td>ABI</td>
<td>2019</td>
<td>0.1946</td>
<td>12</td>
<td>0</td>
<td>2019-01-31</td>
<td>2019-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">24</th>
<td>ABI</td>
<td>2020</td>
<td>0.2418</td>
<td>12</td>
<td>0</td>
<td>2020-01-31</td>
<td>2020-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">25</th>
<td>ABI</td>
<td>2021</td>
<td>0.2896</td>
<td>12</td>
<td>0</td>
<td>2021-01-31</td>
<td>2021-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">26</th>
<td>ABI</td>
<td>2022</td>
<td>-0.5085</td>
<td>12</td>
<td>0</td>
<td>2022-01-31</td>
<td>2022-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">27</th>
<td>ABI</td>
<td>2023</td>
<td>-0.5042</td>
<td>12</td>
<td>0</td>
<td>2023-01-31</td>
<td>2023-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">37</th>
<td>ABT</td>
<td>2019</td>
<td>-0.1893</td>
<td>12</td>
<td>0</td>
<td>2019-01-31</td>
<td>2019-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">38</th>
<td>ABT</td>
<td>2020</td>
<td>-0.1400</td>
<td>12</td>
<td>0</td>
<td>2020-01-31</td>
<td>2020-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">39</th>
<td>ABT</td>
<td>2021</td>
<td>0.0842</td>
<td>12</td>
<td>0</td>
<td>2021-01-31</td>
<td>2021-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">40</th>
<td>ABT</td>
<td>2022</td>
<td>-0.0789</td>
<td>12</td>
<td>0</td>
<td>2022-01-31</td>
<td>2022-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">41</th>
<td>ABT</td>
<td>2023</td>
<td>-0.0768</td>
<td>12</td>
<td>0</td>
<td>2023-01-31</td>
<td>2023-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">51</th>
<td>ACC</td>
<td>2019</td>
<td>-0.1875</td>
<td>12</td>
<td>0</td>
<td>2019-01-31</td>
<td>2019-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">52</th>
<td>ACC</td>
<td>2020</td>
<td>-0.4923</td>
<td>12</td>
<td>0</td>
<td>2020-01-31</td>
<td>2020-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">53</th>
<td>ACC</td>
<td>2021</td>
<td>1.2339</td>
<td>12</td>
<td>0</td>
<td>2021-01-31</td>
<td>2021-12-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">54</th>
<td>ACC</td>
<td>2022</td>
<td>-0.8538</td>
<td>12</td>
<td>0</td>
<td>2022-01-31</td>
<td>2022-12-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">55</th>
<td>ACC</td>
<td>2023</td>
<td>0.1027</td>
<td>12</td>
<td>0</td>
<td>2023-01-31</td>
<td>2023-12-31</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>When the number of non-missing observations (<code>n_obs</code>) is less than 12 for an annual return, the compound return represents only a partial year. This commonly occurs in the first and last years of a security‚Äôs listing on HOSE, HNX, or UPCoM, or when a stock transfers between exchanges (e.g., from UPCoM to HOSE upon meeting listing requirements). Users should decide whether to retain or exclude such partial-year observations depending on their research design.</p>
</div>
</div>
</section>
</section>
<section id="method-3-iterative-compounding-with-retain-logic" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="method-3-iterative-compounding-with-retain-logic"><span class="header-section-number">7.6</span> Method 3: Iterative Compounding with Retain Logic</h2>
<p>In some applications, we need fine-grained control over how missing values, delisting events, or other special conditions affect the compounding process. The iterative approach processes each observation sequentially, carrying forward the cumulative return and applying conditional logic at each step.</p>
<div id="1e01f705" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_iterative(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                              group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                              handle_missing<span class="op">=</span><span class="st">"carry"</span>):</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns iteratively with flexible</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    missing value handling.</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    handle_missing : str</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">        'carry' : treat missing as zero return (carry forward)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">        'propagate' : propagate NaN (conservative)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">        'reset' : reset wealth index to 1 after missing spell</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, group <span class="kw">in</span> df.groupby(group_col):</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        cumret <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        cumrets <span class="op">=</span> []</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> group.iterrows():</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>            ret <span class="op">=</span> row[ret_col]</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(ret):</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> cumret <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> ret)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> handle_missing <span class="op">==</span> <span class="st">"propagate"</span>:</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>                    cumret <span class="op">=</span> np.nan</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> handle_missing <span class="op">==</span> <span class="st">"reset"</span>:</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>                    cumret <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 'carry' does nothing (cumret unchanged)</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>            cumrets.append(cumret)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.copy()</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">"wealth_iter"</span>] <span class="op">=</span> cumrets</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">"cumret_iter"</span>] <span class="op">=</span> group[<span class="st">"wealth_iter"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        results.append(group)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The iterative method is the slowest of the four approaches because it cannot leverage NumPy‚Äôs vectorized operations. For large datasets, prefer Method 1 or 2 unless the conditional logic in Method 3 is essential. On a dataset with 1 million observations, Method 1 runs in approximately 0.1 seconds versus 10+ seconds for Method 3.</p>
</div>
</div>
<section id="comparison-of-missing-value-treatments" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="comparison-of-missing-value-treatments"><span class="header-section-number">7.6.1</span> Comparison of Missing Value Treatments</h3>
<p>To illustrate how the three missing-value strategies differ, consider a hypothetical stock with one missing return in the middle of its history:</p>
<div class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: [<span class="dv">1</span>]<span class="op">*</span><span class="dv">6</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: pd.date_range(<span class="st">"2024-01-31"</span>, periods<span class="op">=</span><span class="dv">6</span>, freq<span class="op">=</span><span class="st">"ME"</span>),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret_total"</span>: [<span class="fl">0.05</span>, <span class="fl">0.03</span>, np.nan, <span class="fl">0.04</span>, <span class="op">-</span><span class="fl">0.02</span>, <span class="fl">0.06</span>]</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>carry <span class="op">=</span> compute_cumret_iterative(example, handle_missing<span class="op">=</span><span class="st">"carry"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>propagate <span class="op">=</span> compute_cumret_iterative(</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    example, handle_missing<span class="op">=</span><span class="st">"propagate"</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>reset <span class="op">=</span> compute_cumret_iterative(example, handle_missing<span class="op">=</span><span class="st">"reset"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> pd.DataFrame({</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Date"</span>: example[<span class="st">"date"</span>].dt.strftime(<span class="st">"%Y-%m"</span>),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Return"</span>: example[<span class="st">"ret_total"</span>],</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Carry"</span>: carry[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Propagate"</span>: propagate[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reset"</span>: reset[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>comparison</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-missing-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="16">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-missing-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.4: Effect of different missing value treatments on cumulative returns. The ‚Äòcarry‚Äô strategy assumes zero return for missing periods (appropriate for trading halts); ‚Äòpropagate‚Äô makes all subsequent values undefined (conservative); ‚Äòreset‚Äô restarts the cumulative product after the missing spell.
</figcaption>
<div aria-describedby="tbl-missing-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="14">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">Return</th>
<th data-quarto-table-cell-role="th">Carry</th>
<th data-quarto-table-cell-role="th">Propagate</th>
<th data-quarto-table-cell-role="th">Reset</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2024-01</td>
<td>0.05</td>
<td>0.050000</td>
<td>0.0500</td>
<td>0.050000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2024-02</td>
<td>0.03</td>
<td>0.081500</td>
<td>0.0815</td>
<td>0.081500</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>2024-03</td>
<td>NaN</td>
<td>0.081500</td>
<td>NaN</td>
<td>0.000000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>2024-04</td>
<td>0.04</td>
<td>0.124760</td>
<td>NaN</td>
<td>0.040000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>2024-05</td>
<td>-0.02</td>
<td>0.102265</td>
<td>NaN</td>
<td>0.019200</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>2024-06</td>
<td>0.06</td>
<td>0.168401</td>
<td>NaN</td>
<td>0.080352</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="method-4-rolling-compound-returns" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="method-4-rolling-compound-returns"><span class="header-section-number">7.7</span> Method 4: Rolling Compound Returns</h2>
<p>For many empirical applications, including momentum strategies, performance evaluation, and risk estimation, we need compound returns over rolling windows of fixed length. This section implements efficient rolling compounding using pandas.</p>
<section id="rolling-window-via-log-returns" class="level3" data-number="7.7.1">
<h3 data-number="7.7.1" class="anchored" data-anchor-id="rolling-window-via-log-returns"><span class="header-section-number">7.7.1</span> Rolling Window via Log Returns</h3>
<p>The most efficient approach combines the log-sum-exp method with rolling sums:</p>
<div id="ae4233a3" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_compound_return(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                             group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                             windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]):</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling compound returns over specified windows.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Must be sorted by [group_col, 'date'] with no gaps.</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    windows : list of int</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling window lengths (in periods).</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with new columns ret_{k} for each window k.</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> windows:</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        rolling_logsum <span class="op">=</span> (</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>            df.groupby(group_col)[<span class="st">"log_ret"</span>]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            .transform(</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>                    window<span class="op">=</span>k, min_periods<span class="op">=</span>k</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>                ).<span class="bu">sum</span>()</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(rolling_logsum) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"log_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We apply this to our full sample to compute 3-, 6-, 9-, and 12-month trailing compound returns:</p>
<div id="7b76caae" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>stock_rolling <span class="op">=</span> rolling_compound_return(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let us also compute the same rolling returns for the market index, which serves as a benchmark for excess return calculations:</p>
<div id="bd652585" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute market rolling returns</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>market_monthly <span class="op">=</span> (</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    prices_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_total"</span>]]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    .drop_duplicates()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"date"</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>market_monthly[<span class="st">"log_mkt"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> market_monthly[<span class="st">"mkt_total"</span>])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    market_monthly[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        np.exp(</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            market_monthly[<span class="st">"log_mkt"</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            .rolling(window<span class="op">=</span>k, min_periods<span class="op">=</span>k)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">sum</span>()</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>market_monthly.drop(columns<span class="op">=</span>[<span class="st">"log_mkt"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge market rolling returns back</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>stock_rolling <span class="op">=</span> stock_rolling.merge(</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    market_monthly[</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]]</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="53_governance.html#fig-rolling-returns" class="quarto-xref">Figure&nbsp;<span>35.4</span></a> displays the distribution of 12-month rolling compound returns over time.</p>
<div id="cell-fig-rolling-returns" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>rolling_stats <span class="op">=</span> (</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    stock_rolling</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret_12"</span>])</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"ret_12"</span>]</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>           <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>rolling_stats.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"median"</span>, <span class="st">"p25"</span>, <span class="st">"p75"</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>plot_rolling <span class="op">=</span> (</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    ggplot(rolling_stats, aes(x<span class="op">=</span><span class="st">"date"</span>)) <span class="op">+</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    geom_ribbon(aes(ymin<span class="op">=</span><span class="st">"p25"</span>, ymax<span class="op">=</span><span class="st">"p75"</span>),</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.3</span>, fill<span class="op">=</span><span class="st">"#2166ac"</span>) <span class="op">+</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    geom_line(aes(y<span class="op">=</span><span class="st">"median"</span>), color<span class="op">=</span><span class="st">"#2166ac"</span>, size<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"12-month compound return"</span>) <span class="op">+</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>plot_rolling.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<div id="fig-rolling-returns" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="htbp" alt="Time series chart showing the distribution of 12-month rolling stock returns in Vietnam.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rolling-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06_compound_return_files/figure-html/fig-rolling-returns-output-1.png" data-fig-pos="htbp" alt="Time series chart showing the distribution of 12-month rolling stock returns in Vietnam." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rolling-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.2: Cross-sectional distribution of 12-month rolling compound returns for Vietnamese stocks over time. The shaded band represents the interquartile range (25th‚Äì75th percentiles), while the solid line shows the median. Sharp market-wide events‚Äîsuch as the 2008 global financial crisis and the 2020 COVID-19 shock‚Äîare visible as periods when even the median return turns sharply negative.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="verifying-rolling-returns" class="level3" data-number="7.7.2">
<h3 data-number="7.7.2" class="anchored" data-anchor-id="verifying-rolling-returns"><span class="header-section-number">7.7.2</span> Verifying Rolling Returns</h3>
<p>It is prudent to verify rolling compound returns against a direct calculation. We select one stock and recompute its 12-month return manually:</p>
<div class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>test_stock <span class="op">=</span> long_history_stocks[<span class="dv">0</span>]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> (</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    stock_rolling[stock_rolling[<span class="st">"symbol"</span>] <span class="op">==</span> test_stock]</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"date"</span>)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">15</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct computation</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">"direct_ret_12"</span>] <span class="op">=</span> (</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    test_data[<span class="st">"ret_total"</span>]</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    .transform(</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.add(<span class="dv">1</span>).rolling(</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            <span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>verify <span class="op">=</span> (</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    test_data[[<span class="st">"date"</span>, <span class="st">"ret_12"</span>, <span class="st">"direct_ret_12"</span>]]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">5</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>verify[<span class="st">"difference"</span>] <span class="op">=</span> (</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    verify[<span class="st">"ret_12"</span>] <span class="op">-</span> verify[<span class="st">"direct_ret_12"</span>]</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>).<span class="bu">abs</span>()</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>verify.<span class="bu">round</span>(<span class="dv">8</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_2229780/922053246.py:28: UserWarning: obj.round has no effect with datetime, timedelta, or period dtypes. Use obj.dt.round(...) instead.</code></pre>
</div>
<div id="tbl-rolling-verify" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rolling-verify-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.5: Verification of rolling compound return calculation. The ‚ÄòDirect‚Äô column computes the product of the preceding 12 monthly gross returns minus one; ‚ÄòRolling‚Äô uses our log-sum-exp function. Differences are at machine precision.
</figcaption>
<div aria-describedby="tbl-rolling-verify-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">ret_12</th>
<th data-quarto-table-cell-role="th">direct_ret_12</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">386</th>
<td>2023-09-30</td>
<td>-0.152407</td>
<td>-0.152407</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">387</th>
<td>2023-10-31</td>
<td>-0.208836</td>
<td>-0.208836</td>
<td>0.0</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">388</th>
<td>2023-11-30</td>
<td>-0.199018</td>
<td>-0.199018</td>
<td>0.0</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">389</th>
<td>2023-12-31</td>
<td>-0.233698</td>
<td>-0.233698</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="delisting-returns-and-survivorship-bias" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="delisting-returns-and-survivorship-bias"><span class="header-section-number">7.8</span> Delisting Returns and Survivorship Bias</h2>
<p>A critical practical concern when computing compound returns is the treatment of securities that are removed from an exchange. Delisting occurs for various reasons: mergers and acquisitions, bankruptcy, failure to meet listing requirements, voluntary withdrawal, or transfer to another exchange. If delisting returns are not incorporated, the resulting compound returns suffer from survivorship bias: they overstate performance because the worst outcomes (bankruptcies, forced delistings) are excluded <span class="citation" data-cites="shumway1997delisting">(<a href="references.html#ref-shumway1997delisting" role="doc-biblioref">Shumway 1997</a>)</span>.</p>
<section id="the-vietnamese-context" class="level3" data-number="7.8.1">
<h3 data-number="7.8.1" class="anchored" data-anchor-id="the-vietnamese-context"><span class="header-section-number">7.8.1</span> The Vietnamese Context</h3>
<p>In Vietnam, securities can be removed from their exchange listing for several reasons as specified by the SSC and exchange regulations:</p>
<ul>
<li><strong>Mandatory delisting</strong>: when a firm has accumulated losses exceeding its charter capital, fails to meet financial reporting obligations for three consecutive years, or has its business license revoked.</li>
<li><strong>Voluntary delisting</strong>: when a firm‚Äôs shareholders vote to withdraw from the exchange.</li>
<li><strong>Transfer</strong>: when a firm moves from UPCoM to HOSE/HNX (upgrade) or from HOSE/HNX to UPCoM (downgrade). These transfers are not true delistings in the economic sense but require careful handling in return calculations.</li>
</ul>
<p>Unlike more developed markets where detailed delisting return data is systematically compiled, Vietnamese market data may not always provide an explicit delisting return. When a stock is delisted for cause (e.g., bankruptcy), the last traded price may significantly overstate the security‚Äôs recovery value. Researchers should be aware of this limitation and consider imputing delisting returns based on the delisting reason, following the methodology of <span class="citation" data-cites="shumway1997delisting">Shumway (<a href="references.html#ref-shumway1997delisting" role="doc-biblioref">1997</a>)</span>.</p>
</section>
<section id="incorporating-delisting-returns" class="level3" data-number="7.8.2">
<h3 data-number="7.8.2" class="anchored" data-anchor-id="incorporating-delisting-returns"><span class="header-section-number">7.8.2</span> Incorporating Delisting Returns</h3>
<p>When a security is delisted, a final ‚Äúdelisting return‚Äù captures the value change between the last regular trading day and the realization of value after delisting. This return must be combined with the regular return in the delisting month:</p>
<p><span id="eq-delisting-adj"><span class="math display">\[
R_t^{\text{adj}} = (1 + R_t)(1 + R_t^{\text{delist}}) - 1,
\tag{7.12}\]</span></span></p>
<p>where <span class="math inline">\(R_t\)</span> is the regular return and <span class="math inline">\(R_t^{\text{delist}}\)</span> is the delisting return. If the regular return is missing (the stock ceased trading before month end), we use the delisting return alone.</p>
<div id="a4f8f18d" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_for_delisting(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>                          dlret_col<span class="op">=</span><span class="st">"dlret"</span>):</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adjust returns for delisting events.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain `ret_col` and `dlret_col`.</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with adjusted return column 'ret_adj'.</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_adj"</span>] <span class="op">=</span> df[ret_col]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Case 1: Both regular and delisting returns available</span></span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    mask_both <span class="op">=</span> df[ret_col].notna() <span class="op">&amp;</span> df[dlret_col].notna()</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    df.loc[mask_both, <span class="st">"ret_adj"</span>] <span class="op">=</span> (</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">+</span> df.loc[mask_both, ret_col]) <span class="op">*</span></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">+</span> df.loc[mask_both, dlret_col]) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Case 2: Only delisting return available</span></span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    mask_dlret_only <span class="op">=</span> (</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>        df[ret_col].isna() <span class="op">&amp;</span> df[dlret_col].notna()</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    df.loc[mask_dlret_only, <span class="st">"ret_adj"</span>] <span class="op">=</span> (</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>        df.loc[mask_dlret_only, dlret_col]</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="impact-of-delisting-adjustment" class="level3" data-number="7.8.3">
<h3 data-number="7.8.3" class="anchored" data-anchor-id="impact-of-delisting-adjustment"><span class="header-section-number">7.8.3</span> Impact of Delisting Adjustment</h3>
<p>The magnitude of the delisting bias depends on the frequency and severity of delisting events. <span class="citation" data-cites="shumway1997delisting">Shumway (<a href="references.html#ref-shumway1997delisting" role="doc-biblioref">1997</a>)</span> showed that, in developed markets, ignoring delisting returns introduces an upward bias of approximately 1% per year in equal-weighted portfolio returns. The bias is larger for small-cap stocks and value stocks, which are more prone to financial distress. In Vietnam, where smaller firms on HNX and UPCoM face tighter liquidity constraints and higher default risk, the bias may be even more pronounced. In emerging market delistings, mandatory delistings often involve firms with severe financial distress where residual equity value is near zero, implying delisting returns close to <span class="math inline">\(-100\%\)</span> in the worst cases.</p>
</section>
</section>
<section id="rolling-volatility-estimation" class="level2" data-number="7.9">
<h2 data-number="7.9" class="anchored" data-anchor-id="rolling-volatility-estimation"><span class="header-section-number">7.9</span> Rolling Volatility Estimation</h2>
<p>Stock return volatility is a key input for risk management, option pricing, and many empirical asset pricing models. A common approach is to estimate rolling standard deviations of returns over a trailing window.</p>
<section id="month-rolling-volatility" class="level3" data-number="7.9.1">
<h3 data-number="7.9.1" class="anchored" data-anchor-id="month-rolling-volatility"><span class="header-section-number">7.9.1</span> 24-Month Rolling Volatility</h3>
<p>Following <span class="citation" data-cites="ben2012hedge">Ben-David, Franzoni, and Moussawi (<a href="references.html#ref-ben2012hedge" role="doc-biblioref">2012</a>)</span>, we compute the total stock return volatility as the rolling standard deviation of monthly returns over a 24-month window:</p>
<p><span id="eq-rolling-vol"><span class="math display">\[
\hat{\sigma}_{i,t}^{24} = \sqrt{\frac{1}{23}\sum_{j=0}^{23}(R_{i,t-j} - \bar{R}_{i,t}^{24})^2},
\tag{7.13}\]</span></span></p>
<p>where <span class="math inline">\(\bar{R}_{i,t}^{24} = \frac{1}{24}\sum_{j=0}^{23} R_{i,t-j}\)</span> is the trailing 24-month mean return.</p>
<div id="a2ea1355" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_volatility(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>                        group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>                        window<span class="op">=</span><span class="dv">24</span>):</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling return volatility.</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="co">    window : int</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling window length in periods.</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'vol_{window}' column (annualized).</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[ret_col]</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        .transform(</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>                window<span class="op">=</span>window, min_periods<span class="op">=</span>window</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>            ).std()</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualize (monthly to annual)</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">_ann"</span>] <span class="op">=</span> df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="14b9540c" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>stock_vol <span class="op">=</span> rolling_volatility(stock_rolling)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-vol-distribution" class="quarto-xref">Figure&nbsp;<span>7.3</span></a> shows the cross-sectional distribution of annualized 24-month volatility over time.</p>
<div id="cell-fig-vol-distribution" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>vol_stats <span class="op">=</span> (</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    stock_vol</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"vol_24_ann"</span>])</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"vol_24_ann"</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>),</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>           <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>vol_stats.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"median"</span>, <span class="st">"p25"</span>, <span class="st">"p75"</span>]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>plot_vol <span class="op">=</span> (</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    ggplot(vol_stats, aes(x<span class="op">=</span><span class="st">"date"</span>)) <span class="op">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    geom_ribbon(aes(ymin<span class="op">=</span><span class="st">"p25"</span>, ymax<span class="op">=</span><span class="st">"p75"</span>),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.3</span>, fill<span class="op">=</span><span class="st">"#b2182b"</span>) <span class="op">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    geom_line(aes(y<span class="op">=</span><span class="st">"median"</span>), color<span class="op">=</span><span class="st">"#b2182b"</span>, size<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Annualized 24-month volatility"</span>) <span class="op">+</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>plot_vol.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<div id="fig-vol-distribution" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="htbp" alt="Time series of the cross-sectional distribution of stock return volatility in Vietnam.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-vol-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06_compound_return_files/figure-html/fig-vol-distribution-output-1.png" data-fig-pos="htbp" alt="Time series of the cross-sectional distribution of stock return volatility in Vietnam." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vol-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.3: Cross-sectional distribution of annualized 24-month rolling stock return volatility for Vietnamese equities. The median volatility (solid line) and interquartile range (shaded band) capture both secular trends and crisis episodes. Vietnamese stocks exhibit structurally higher volatility than developed-market peers, with the median annualized volatility typically ranging between 30% and 50%.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="volatility-and-compound-returns-the-variance-drain" class="level3" data-number="7.9.2">
<h3 data-number="7.9.2" class="anchored" data-anchor-id="volatility-and-compound-returns-the-variance-drain"><span class="header-section-number">7.9.2</span> Volatility and Compound Returns: The Variance Drain</h3>
<p>As noted in <a href="#eq-arithmetic-geometric" class="quarto-xref">Equation&nbsp;<span>7.7</span></a>, the geometric mean return falls below the arithmetic mean by approximately <span class="math inline">\(\sigma^2/2\)</span>. This ‚Äúvariance drain‚Äù or ‚Äúvolatility drag‚Äù means that two portfolios with the same arithmetic mean return but different volatilities will have different compound returns: the lower-volatility portfolio will compound to greater terminal wealth.</p>
<p>This effect is quantitatively important in Vietnam. A stock with an arithmetic mean monthly return of 1.5% and a monthly standard deviation of 10% suffers a volatility drag of approximately <span class="math inline">\(0.10^2/2 = 0.5\%\)</span> per month, or roughly 6% per year. This is consistent with the observation that Vietnamese investors face substantial erosion of compound wealth from the high idiosyncratic volatility of individual stocks. We can verify this empirically by sorting stocks into volatility quintiles and comparing compound returns:</p>
<div class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>annual_data <span class="op">=</span> compound_return_by_period(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly, period<span class="op">=</span><span class="st">"year"</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>annual_data <span class="op">=</span> annual_data[annual_data[<span class="st">"n_obs"</span>] <span class="op">&gt;=</span> <span class="dv">10</span>].copy()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>vol_annual <span class="op">=</span> (</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    prices_monthly</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, prices_monthly[<span class="st">"date"</span>].dt.year])[</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ret_total"</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"std"</span>, <span class="st">"mean"</span>, <span class="st">"count"</span>])</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>vol_annual.columns <span class="op">=</span> [<span class="st">"symbol"</span>, <span class="st">"period"</span>, <span class="st">"monthly_std"</span>,</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"monthly_mean"</span>, <span class="st">"n_months"</span>]</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>vol_annual <span class="op">=</span> vol_annual[vol_annual[<span class="st">"n_months"</span>] <span class="op">&gt;=</span> <span class="dv">10</span>].copy()</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>vol_annual[<span class="st">"ann_vol"</span>] <span class="op">=</span> vol_annual[<span class="st">"monthly_std"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>vol_annual[<span class="st">"arith_mean_ann"</span>] <span class="op">=</span> vol_annual[<span class="st">"monthly_mean"</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>vol_analysis <span class="op">=</span> annual_data.merge(</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    vol_annual, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"period"</span>]</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>vol_analysis[<span class="st">"vol_quintile"</span>] <span class="op">=</span> (</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    vol_analysis.groupby(<span class="st">"period"</span>)[<span class="st">"ann_vol"</span>]</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    .transform(</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>            x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>vol_summary <span class="op">=</span> (</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    vol_analysis</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"vol_quintile"</span>)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        arithmetic_mean<span class="op">=</span>(<span class="st">"arith_mean_ann"</span>, <span class="st">"mean"</span>),</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        geometric_mean<span class="op">=</span>(<span class="st">"cumret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        avg_volatility<span class="op">=</span>(<span class="st">"ann_vol"</span>, <span class="st">"mean"</span>),</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        n_stockyears<span class="op">=</span>(<span class="st">"cumret"</span>, <span class="st">"count"</span>)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>vol_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-vol-drag" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="26">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-vol-drag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.6: Arithmetic mean, geometric mean, and volatility by volatility quintile for Vietnamese stocks. The difference between arithmetic and geometric mean increases with volatility, confirming the variance drain effect. The magnitude of the drag is notably large for the highest-volatility quintile, typical of small and illiquid stocks on HNX and UPCoM.
</figcaption>
<div aria-describedby="tbl-vol-drag-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="24">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">vol_quintile</th>
<th data-quarto-table-cell-role="th">arithmetic_mean</th>
<th data-quarto-table-cell-role="th">geometric_mean</th>
<th data-quarto-table-cell-role="th">avg_volatility</th>
<th data-quarto-table-cell-role="th">n_stockyears</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>1</td>
<td>-0.0908</td>
<td>-0.0763</td>
<td>0.1887</td>
<td>2708</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>2</td>
<td>-0.0754</td>
<td>-0.0610</td>
<td>0.3312</td>
<td>2700</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>3</td>
<td>-0.0388</td>
<td>-0.0169</td>
<td>0.4493</td>
<td>2701</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>4</td>
<td>0.0404</td>
<td>0.0494</td>
<td>0.6005</td>
<td>2700</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>5</td>
<td>0.4411</td>
<td>0.3389</td>
<td>1.0288</td>
<td>2705</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
</section>
<section id="compound-returns-around-fiscal-year-ends" class="level2" data-number="7.10">
<h2 data-number="7.10" class="anchored" data-anchor-id="compound-returns-around-fiscal-year-ends"><span class="header-section-number">7.10</span> Compound Returns Around Fiscal Year Ends</h2>
<p>A widely used approach in accounting and finance research aligns compound returns to firm-specific fiscal period end dates. This is essential for computing buy-and-hold abnormal returns (BHARs) for event studies, post-earnings-announcement drift, and other studies where the event date varies by firm.</p>
<p>In Vietnam, the majority of listed firms follow a calendar fiscal year (January‚ÄìDecember), as required by the Law on Accounting unless the Ministry of Finance grants an exemption. However, firms in certain industries (e.g., agriculture, tourism) may use non-standard fiscal years ending in March, June, or September.</p>
<!--# The DataCore.vn financial statements database records the firm-specific fiscal year end for each firm-year. -->
<section id="aligning-returns-to-fiscal-periods" class="level3" data-number="7.10.1">
<h3 data-number="7.10.1" class="anchored" data-anchor-id="aligning-returns-to-fiscal-periods"><span class="header-section-number">7.10.1</span> Aligning Returns to Fiscal Periods</h3>
<p>The key challenge is that fiscal year ends differ across firms. We need to compute compound returns over windows anchored at these firm-specific dates.</p>
<div id="2b6c1da9" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compound_returns_around_event(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    returns_df, events_df,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    id_col<span class="op">=</span><span class="st">"symbol"</span>, date_col<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    event_date_col<span class="op">=</span><span class="st">"datadate"</span>, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    pre_windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>],</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    post_windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>]</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute compound returns in windows around firm-specific</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">    event dates.</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : pd.DataFrame</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns with [id_col, date_col, ret_col].</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">    events_df : pd.DataFrame</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Event dates with [id_col, event_date_col].</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">    pre_windows : list of int</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Trailing window lengths (months before event).</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co">    post_windows : list of int</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Forward window lengths (months after event).</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with compound returns for each window.</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    returns_df <span class="op">=</span> returns_df.sort_values(</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>        [id_col, date_col]</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    ).copy()</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> events_df.copy()</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align event dates to month ends</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    events_df[<span class="st">"event_month"</span>] <span class="op">=</span> (</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>        pd.to_datetime(events_df[event_date_col])</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> events_df.iterrows():</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        sid <span class="op">=</span> event[id_col]</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>        edate <span class="op">=</span> event[<span class="st">"event_month"</span>]</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>        sec_rets <span class="op">=</span> returns_df[</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>            returns_df[id_col] <span class="op">==</span> sid</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>        ].copy()</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>        sec_rets <span class="op">=</span> sec_rets.set_index(date_col)[ret_col]</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {id_col: sid,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>               event_date_col: event[event_date_col]}</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-event compound returns</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> pre_windows:</span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> edate <span class="op">-</span> pd.DateOffset(months<span class="op">=</span>k<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> (start <span class="op">-</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>                     <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>))</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>            window_rets <span class="op">=</span> sec_rets[</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>                (sec_rets.index <span class="op">&gt;=</span> start)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span> (sec_rets.index <span class="op">&lt;=</span> edate)</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(window_rets) <span class="op">&gt;=</span> k <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> (</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>                    np.exp(np.log(<span class="dv">1</span> <span class="op">+</span> window_rets).<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> np.nan</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f"ret_pre_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> cumret</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-event compound returns</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> post_windows:</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> edate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> (edate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>k)</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>                   <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>))</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>            window_rets <span class="op">=</span> sec_rets[</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>                (sec_rets.index <span class="op">&gt;=</span> start)</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span> (sec_rets.index <span class="op">&lt;=</span> end)</span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(window_rets) <span class="op">&gt;=</span> k <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> (</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>                    np.exp(np.log(<span class="dv">1</span> <span class="op">+</span> window_rets).<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> np.nan</span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f"ret_post_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> cumret</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="buy-and-hold-abnormal-returns-versus-cumulative-abnormal-returns" class="level3" data-number="7.10.2">
<h3 data-number="7.10.2" class="anchored" data-anchor-id="buy-and-hold-abnormal-returns-versus-cumulative-abnormal-returns"><span class="header-section-number">7.10.2</span> Buy-and-Hold Abnormal Returns versus Cumulative Abnormal Returns</h3>
<p>For event studies and performance evaluation, we often want the <strong>excess</strong> compound return, which is the stock‚Äôs compound return minus a benchmark‚Äôs compound return over the same window. The buy-and-hold abnormal return (BHAR) is defined as</p>
<p><span id="eq-bhar"><span class="math display">\[
\text{BHAR}_{i,t}(k) = \prod_{j=1}^{k}(1 + R_{i,t+j}) - \prod_{j=1}^{k}(1 + R_{b,t+j}),
\tag{7.14}\]</span></span></p>
<p>where <span class="math inline">\(R_{b,t}\)</span> is the benchmark return (market index, size-matched portfolio, etc.). This differs from the cumulative abnormal return (CAR), which sums simple abnormal returns:</p>
<p><span id="eq-car"><span class="math display">\[
\text{CAR}_{i,t}(k) = \sum_{j=1}^{k}(R_{i,t+j} - R_{b,t+j}).
\tag{7.15}\]</span></span></p>
<p>The BHAR better captures the actual investor experience because it reflects the compounding of returns, whereas the CAR implicitly assumes daily rebalancing to maintain equal dollar positions in the stock and benchmark <span class="citation" data-cites="barber1997detecting">(<a href="references.html#ref-barber1997detecting" role="doc-biblioref">Barber and Lyon 1997</a>)</span>. The distinction is particularly important in Vietnam, where individual stock returns can be highly volatile and the compounding effect is therefore magnified. <span class="citation" data-cites="lyon1999improved">Lyon, Barber, and Tsai (<a href="references.html#ref-lyon1999improved" role="doc-biblioref">1999</a>)</span> provide further analysis of the statistical properties of BHARs and recommend bootstrapped critical values for inference.</p>
<div id="3ac1fc31" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_bhar(stock_returns, benchmark_returns):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute buy-and-hold abnormal return.</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_returns : array-like</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of stock returns.</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    benchmark_returns : array-like</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of benchmark returns (same length).</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">    float : BHAR</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    stock_cumret <span class="op">=</span> (</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        np.prod(<span class="dv">1</span> <span class="op">+</span> np.array(stock_returns)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    bench_cumret <span class="op">=</span> (</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        np.prod(<span class="dv">1</span> <span class="op">+</span> np.array(benchmark_returns)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stock_cumret <span class="op">-</span> bench_cumret</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="book-value-of-equity" class="level2" data-number="7.11">
<h2 data-number="7.11" class="anchored" data-anchor-id="book-value-of-equity"><span class="header-section-number">7.11</span> Book Value of Equity</h2>
<p>Many empirical applications that use compound returns also require firm-level accounting variables. A commonly used variable is the book value of equity, computed following <span class="citation" data-cites="daniel1997evidence">Daniel and Titman (<a href="references.html#ref-daniel1997evidence" role="doc-biblioref">1997</a>)</span>:</p>
<p><span id="eq-book-equity"><span class="math display">\[
\text{BE} = \text{SE} + \text{DT} + \text{ITC} - \text{PS},
\tag{7.16}\]</span></span></p>
<p>where SE is stockholders‚Äô equity, DT is deferred taxes, ITC is investment tax credit, and PS is the preferred stock value. For preferred stock, the hierarchy is: redemption value if available, then liquidating value, then carrying value.</p>
<p>In Vietnam, the accounting standards (Vietnamese Accounting Standards, VAS, and increasingly IFRS adoption) provide a somewhat different chart of accounts. Stockholders‚Äô equity is reported on the balance sheet as <em>V·ªën ch·ªß s·ªü h·ªØu</em>, which includes contributed capital (<em>V·ªën g√≥p c·ªßa ch·ªß s·ªü h·ªØu</em>), share premium (<em>Th·∫∑ng d∆∞ v·ªën c·ªï ph·∫ßn</em>), treasury stock adjustments, retained earnings (<em>L·ª£i nhu·∫≠n sau thu·∫ø ch∆∞a ph√¢n ph·ªëi</em>), and other reserves. Deferred tax assets and liabilities are reported separately. Preferred stock is rare among Vietnamese listed firms (most issue only common shares), but when present, its book value should be subtracted from total equity.</p>
<div id="f0fc2913" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_book_equity(df):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute book value of equity for Vietnamese firms.</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain at minimum: equity (stockholders' equity),</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">        deferred_tax (deferred tax liabilities, net),</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">        pref_stock (preferred stock, if applicable).</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'be' column.</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pref"</span>] <span class="op">=</span> df.get(</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pref_stock"</span>, pd.Series(<span class="dv">0</span>, index<span class="op">=</span>df.index)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dt"</span>] <span class="op">=</span> df.get(</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deferred_tax"</span>, pd.Series(<span class="dv">0</span>, index<span class="op">=</span>df.index)</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> (</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"equity"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> df[<span class="st">"dt"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"pref"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set non-positive book equity to NaN</span></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">"be"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">"be"</span>] <span class="op">=</span> np.nan</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="maximum-drawdown" class="level2" data-number="7.12">
<h2 data-number="7.12" class="anchored" data-anchor-id="maximum-drawdown"><span class="header-section-number">7.12</span> Maximum Drawdown</h2>
<p>The maximum drawdown is a key risk metric that complements volatility. While volatility measures the dispersion of returns symmetrically, the maximum drawdown captures the worst cumulative loss an investor could experience: a measure that aligns more closely with how investors psychologically experience risk <span class="citation" data-cites="kahneman2013prospect">(<a href="references.html#ref-kahneman2013prospect" role="doc-biblioref">Kahneman and Tversky 2013</a>)</span>.</p>
<div id="23db4a1f" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_max_drawdown(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute maximum drawdown for each security.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'max_drawdown' and running drawdown.</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col]</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth"</span>] <span class="op">=</span> (</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>].cumprod()</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"peak"</span>] <span class="op">=</span> df.groupby(group_col)[<span class="st">"wealth"</span>].cummax()</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"drawdown"</span>] <span class="op">=</span> (</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">"wealth"</span>] <span class="op">-</span> df[<span class="st">"peak"</span>]) <span class="op">/</span> df[<span class="st">"peak"</span>]</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> (</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"drawdown"</span>]</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">min</span>()</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"max_drawdown"</span>)</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(max_dd, on<span class="op">=</span>group_col)</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="53_governance.html#fig-drawdown" class="quarto-xref">Figure&nbsp;<span>35.7</span></a> illustrates the drawdown profile for a selected stock.</p>
<div id="cell-fig-drawdown" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dd_data <span class="op">=</span> compute_max_drawdown(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    prices_monthly[</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        prices_monthly[<span class="st">"symbol"</span>] <span class="op">==</span> long_history_stocks[<span class="dv">0</span>]</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>mdd <span class="op">=</span> dd_data[<span class="st">"max_drawdown"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>plot_dd <span class="op">=</span> (</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    ggplot(dd_data, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"drawdown"</span>)) <span class="op">+</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    geom_area(fill<span class="op">=</span><span class="st">"#b2182b"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#b2182b"</span>, size<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span>mdd, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Drawdown from peak"</span>) <span class="op">+</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>plot_dd.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div id="fig-drawdown" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="htbp" alt="Time series chart of drawdowns for a single Vietnamese stock.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-drawdown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06_compound_return_files/figure-html/fig-drawdown-output-1.png" data-fig-pos="htbp" alt="Time series chart of drawdowns for a single Vietnamese stock." width="960" height="384" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-drawdown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.4: Drawdown profile for a selected Vietnamese stock showing the percentage decline from each running peak. The maximum drawdown (horizontal dashed line) represents the worst peak-to-trough loss over the full sample. Vietnamese stocks frequently exhibit drawdowns exceeding 50%, reflecting the market‚Äôs high volatility and susceptibility to sentiment-driven corrections.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="putting-it-all-together-a-comprehensive-pipeline" class="level2" data-number="7.13">
<h2 data-number="7.13" class="anchored" data-anchor-id="putting-it-all-together-a-comprehensive-pipeline"><span class="header-section-number">7.13</span> Putting It All Together: A Comprehensive Pipeline</h2>
<p>We now combine all the methods into a single pipeline that produces a research-ready dataset with rolling compound returns, market returns, volatility, and drawdown measures.</p>
<div id="09cd9cbd" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_compound_return_dataset(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    stock_df, windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>], vol_window<span class="op">=</span><span class="dv">24</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Build comprehensive compound return dataset.</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_df : pd.DataFrame</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock return data with columns:</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co">        symbol, date, ret_total, mkt_total.</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co">    windows : list of int</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling compound return windows.</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="co">    vol_window : int</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling volatility window.</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> stock_df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Log returns</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret_total"</span>])</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_mkt"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[<span class="st">"mkt_total"</span>])</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Rolling compound returns (stock and market)</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> windows:</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>            df.groupby(<span class="st">"symbol"</span>)[<span class="st">"log_ret"</span>]</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>            .transform(</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: x.rolling(k, min_periods<span class="op">=</span>k).<span class="bu">sum</span>()</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"log_mkt"</span>]</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>            .rolling(k, min_periods<span class="op">=</span>k)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">sum</span>()</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Excess compound return (BHAR vs market)</span></span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"exret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">-</span> df[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Cumulative return (full history)</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth"</span>] <span class="op">=</span> (</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"log_ret"</span>]</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>        .cumsum()</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.exp)</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Rolling volatility</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>vol_window<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"ret_total"</span>]</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>        .transform(</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>                vol_window, min_periods<span class="op">=</span>vol_window</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>            ).std()</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">*</span> np.sqrt(<span class="dv">12</span>)  <span class="co"># annualize</span></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Drawdown</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"peak"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"wealth"</span>].cummax()</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"drawdown"</span>] <span class="op">=</span> (df[<span class="st">"wealth"</span>] <span class="op">-</span> df[<span class="st">"peak"</span>]) <span class="op">/</span> df[<span class="st">"peak"</span>]</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up</span></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    df.drop(</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">"log_ret"</span>, <span class="st">"log_mkt"</span>, <span class="st">"peak"</span>], inplace<span class="op">=</span><span class="va">True</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fda21717" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the full dataset</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>compound_dataset <span class="op">=</span> build_compound_return_dataset(prices_monthly)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#tbl-summary-stats" class="quarto-xref">Table&nbsp;<span>7.7</span></a> provides summary statistics for the key variables in our compound return dataset.</p>
<div class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>summary_cols <span class="op">=</span> [<span class="st">"ret_total"</span>, <span class="st">"ret_3"</span>, <span class="st">"ret_6"</span>, <span class="st">"ret_12"</span>,</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>                <span class="st">"exret_3"</span>, <span class="st">"exret_12"</span>, <span class="st">"vol_24"</span>, <span class="st">"drawdown"</span>]</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>available_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> summary_cols</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> c <span class="kw">in</span> compound_dataset.columns]</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> (</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    compound_dataset[available_cols]</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    .describe(percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>])</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    .T</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-summary-stats" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="34">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.7: Summary statistics for compound return variables across all Vietnamese stock-month observations. Returns are in decimal form (0.10 = 10%). The wide dispersion of 12-month compound returns and the high median volatility reflect the emerging market characteristics of the Vietnamese equity market.
</figcaption>
<div aria-describedby="tbl-summary-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">5%</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">95%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ret_total</th>
<td>165499.0</td>
<td>0.0042</td>
<td>0.1862</td>
<td>-0.9900</td>
<td>-0.2381</td>
<td>-0.0703</td>
<td>0.0000</td>
<td>0.0553</td>
<td>0.2773</td>
<td>12.7500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ret_3</th>
<td>162586.0</td>
<td>0.0094</td>
<td>0.3393</td>
<td>-0.9999</td>
<td>-0.3889</td>
<td>-0.1436</td>
<td>-0.0126</td>
<td>0.0987</td>
<td>0.5000</td>
<td>27.2911</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">ret_6</th>
<td>158227.0</td>
<td>0.0171</td>
<td>0.5053</td>
<td>-0.9999</td>
<td>-0.5095</td>
<td>-0.2196</td>
<td>-0.0400</td>
<td>0.1404</td>
<td>0.7320</td>
<td>35.7136</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ret_12</th>
<td>149520.0</td>
<td>0.0375</td>
<td>0.8136</td>
<td>-0.9999</td>
<td>-0.6522</td>
<td>-0.3191</td>
<td>-0.0877</td>
<td>0.1807</td>
<td>1.0767</td>
<td>47.9515</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">exret_3</th>
<td>153637.0</td>
<td>0.0385</td>
<td>0.3343</td>
<td>-1.1691</td>
<td>-0.3420</td>
<td>-0.1163</td>
<td>0.0067</td>
<td>0.1378</td>
<td>0.4992</td>
<td>27.3041</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">exret_12</th>
<td>140571.0</td>
<td>0.1401</td>
<td>0.8031</td>
<td>-1.5858</td>
<td>-0.5388</td>
<td>-0.2003</td>
<td>0.0281</td>
<td>0.2880</td>
<td>1.1119</td>
<td>48.0488</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">vol_24</th>
<td>132233.0</td>
<td>0.5493</td>
<td>0.3488</td>
<td>0.0000</td>
<td>0.2070</td>
<td>0.3445</td>
<td>0.4827</td>
<td>0.6737</td>
<td>1.0739</td>
<td>9.1792</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">drawdown</th>
<td>165499.0</td>
<td>-0.5927</td>
<td>0.2975</td>
<td>-1.0000</td>
<td>-0.9631</td>
<td>-0.8501</td>
<td>-0.6616</td>
<td>-0.3725</td>
<td>0.0000</td>
<td>0.0000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="cross-sectional-distribution-of-compound-returns" class="level2" data-number="7.14">
<h2 data-number="7.14" class="anchored" data-anchor-id="cross-sectional-distribution-of-compound-returns"><span class="header-section-number">7.14</span> Cross-Sectional Distribution of Compound Returns</h2>
<p>To understand how compound returns vary across securities, we examine the cross-sectional distribution at different horizons.</p>
<div id="cell-fig-horizon-comparison" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>horizon_data <span class="op">=</span> pd.DataFrame()</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">12</span>]:</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> compound_dataset[[col]].dropna().copy()</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    temp.columns <span class="op">=</span> [<span class="st">"compound_return"</span>]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    temp[<span class="st">"horizon"</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss"> months"</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    lo, hi <span class="op">=</span> temp[<span class="st">"compound_return"</span>].quantile([<span class="fl">0.01</span>, <span class="fl">0.99</span>])</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> temp[</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        (temp[<span class="st">"compound_return"</span>] <span class="op">&gt;=</span> lo)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (temp[<span class="st">"compound_return"</span>] <span class="op">&lt;=</span> hi)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    horizon_data <span class="op">=</span> pd.concat([horizon_data, temp])</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>plot_horizons <span class="op">=</span> (</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    ggplot(horizon_data,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"compound_return"</span>, fill<span class="op">=</span><span class="st">"horizon"</span>)) <span class="op">+</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    geom_density(alpha<span class="op">=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Compound return"</span>, y<span class="op">=</span><span class="st">"Density"</span>, fill<span class="op">=</span><span class="st">"Horizon"</span>) <span class="op">+</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    scale_x_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>          figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>plot_horizons.draw()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<div id="fig-horizon-comparison" class="quarto-float quarto-figure quarto-figure-center anchored" data-fig-pos="htbp" alt="Overlaid density plots of compound returns at 3, 6, and 12 month horizons for Vietnamese stocks.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-horizon-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="06_compound_return_files/figure-html/fig-horizon-comparison-output-1.png" data-fig-pos="htbp" alt="Overlaid density plots of compound returns at 3, 6, and 12 month horizons for Vietnamese stocks." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-horizon-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7.5: Cross-sectional distribution of compound returns at different horizons (3, 6, and 12 months) for Vietnamese stocks. Longer horizons exhibit greater dispersion and more pronounced right skewness, reflecting the compounding of idiosyncratic risk. The fat tails are more extreme than those typically observed in developed markets, consistent with the higher volatility environment.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="vietnam-specific-considerations" class="level2" data-number="7.15">
<h2 data-number="7.15" class="anchored" data-anchor-id="vietnam-specific-considerations"><span class="header-section-number">7.15</span> Vietnam-Specific Considerations</h2>
<section id="price-limits-and-their-effect-on-compounding" class="level3" data-number="7.15.1">
<h3 data-number="7.15.1" class="anchored" data-anchor-id="price-limits-and-their-effect-on-compounding"><span class="header-section-number">7.15.1</span> Price Limits and Their Effect on Compounding</h3>
<p>Vietnam‚Äôs stock exchanges impose daily price limits that cap the maximum price change from the reference price. As of the latest regulations:</p>
<ul>
<li><strong>HOSE</strong>: <span class="math inline">\(\pm 7\%\)</span></li>
<li><strong>HNX</strong>: <span class="math inline">\(\pm 10\%\)</span></li>
<li><strong>UPCoM</strong>: <span class="math inline">\(\pm 15\%\)</span></li>
</ul>
<p>These limits truncate the daily return distribution and can create sequences of limit-hit days when large information events occur. For compound return computation, this means that the adjustment to new information may be spread over multiple days rather than occurring instantaneously. When computing monthly compound returns from daily data, this is handled correctly because the compound return accumulates the full adjustment regardless of how many days it takes.</p>
<p>However, price limits can introduce bias in short-horizon return computations. If a large positive event occurs and the stock hits the limit-up ceiling for several consecutive days, the 1-day or 1-week compound return will understate the true information content of the event <span class="citation" data-cites="kim2013reconsidering">(<a href="references.html#ref-kim2013reconsidering" role="doc-biblioref">Kim, Liu, and Yang 2013</a>)</span>. For event study applications, researchers should verify that the event window is long enough to accommodate the price-limit-induced delay in price adjustment.</p>
</section>
<section id="foreign-ownership-limits" class="level3" data-number="7.15.2">
<h3 data-number="7.15.2" class="anchored" data-anchor-id="foreign-ownership-limits"><span class="header-section-number">7.15.2</span> Foreign Ownership Limits</h3>
<p>Vietnam imposes foreign ownership limits (FOL) on listed companies, typically capped at 49% for most industries and lower (30% or less) for certain restricted sectors such as banking and telecommunications. When a stock reaches its FOL, foreign investors can only purchase shares from other foreign sellers, creating a parallel premium market for foreign-board shares. This does not directly affect the computation of compound returns (which use official traded prices), but researchers studying cross-border portfolio returns should be aware that the effective price paid by foreign investors may differ from the board price <span class="citation" data-cites="vo2017foreign">(<a href="references.html#ref-vo2017foreign" role="doc-biblioref">Vo 2017</a>)</span>.</p>
</section>
<section id="the-vn-index-and-market-benchmarks" class="level3" data-number="7.15.3">
<h3 data-number="7.15.3" class="anchored" data-anchor-id="the-vn-index-and-market-benchmarks"><span class="header-section-number">7.15.3</span> The VN-Index and Market Benchmarks</h3>
<p>For benchmark compound returns, Vietnam‚Äôs primary indices are:</p>
<ul>
<li><strong>VN-Index</strong>: The capitalization-weighted index of all HOSE-listed stocks.</li>
<li><strong>VN30</strong>: The 30 largest and most liquid stocks on HOSE, reviewed semi-annually.</li>
<li><strong>HNX-Index</strong>: The capitalization-weighted index of HNX-listed stocks.</li>
</ul>
<p>The VN-Index is the most widely used benchmark and is the default market return in our dataset.</p>
</section>
</section>
<section id="performance-considerations" class="level2" data-number="7.16">
<h2 data-number="7.16" class="anchored" data-anchor-id="performance-considerations"><span class="header-section-number">7.16</span> Performance Considerations</h2>
<p>When working with large datasets, computational efficiency matters. <a href="#tbl-performance-benchmark" class="quarto-xref">Table&nbsp;<span>7.8</span></a> compares the execution time of our four compounding methods on a standardized dataset.</p>
<div class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>n_stocks <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>n_months <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: np.repeat(<span class="bu">range</span>(n_stocks), n_months),</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: np.tile(</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        pd.date_range(<span class="st">"2015-01-31"</span>, periods<span class="op">=</span>n_months,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>                       freq<span class="op">=</span><span class="st">"ME"</span>),</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        n_stocks</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret_total"</span>: np.random.normal(</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.01</span>, <span class="fl">0.08</span>, n_stocks <span class="op">*</span> n_months</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> {}</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_cumprod(test_df)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Cumulative Product"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_logsum(test_df)</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Log-Sum-Exp"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_iterative(test_df)</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Iterative (carry)"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> rolling_compound_return(test_df, windows<span class="op">=</span>[<span class="dv">12</span>])</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Rolling (12-month)"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>perf_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Method"</span>: methods.keys(),</span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time (seconds)"</span>: [<span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> v <span class="kw">in</span> methods.values()],</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Relative Speed"</span>: [</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>v<span class="op">/</span><span class="bu">min</span>(methods.values())<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> methods.values()</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb39-44"><a href="#cb39-44" aria-hidden="true" tabindex="-1"></a>perf_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-performance-benchmark" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="36">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-performance-benchmark-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;7.8: Execution time comparison for different compounding methods on a dataset of 10,000 stock-month observations. The cumulative product and log-sum-exp methods are orders of magnitude faster than the iterative approach due to NumPy vectorization.
</figcaption>
<div aria-describedby="tbl-performance-benchmark-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="34">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Method</th>
<th data-quarto-table-cell-role="th">Time (seconds)</th>
<th data-quarto-table-cell-role="th">Relative Speed</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Cumulative Product</td>
<td>0.0039</td>
<td>1.0x</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Log-Sum-Exp</td>
<td>0.0043</td>
<td>1.1x</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Iterative (carry)</td>
<td>0.5225</td>
<td>132.7x</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Rolling (12-month)</td>
<td>0.0230</td>
<td>5.8x</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="common-pitfalls-and-best-practices" class="level2" data-number="7.17">
<h2 data-number="7.17" class="anchored" data-anchor-id="common-pitfalls-and-best-practices"><span class="header-section-number">7.17</span> Common Pitfalls and Best Practices</h2>
<p>Several subtle issues can lead to incorrect compound return calculations. We summarize the most important ones:</p>
<p><strong>Gaps in the time series.</strong> If a security has months with no observations (not even a missing return flag), rolling window calculations based on positional indexing will produce incorrect results. The rolling window will span the wrong calendar period. Always ensure that the time series is complete, fill gaps with explicit missing values before computing rolling statistics. This is particularly relevant in Vietnam, where trading suspensions can create gaps.</p>
<p><strong>Survivorship bias.</strong> As discussed in the delisting returns section, excluding securities that cease trading biases compound returns upward. Always incorporate delisting returns when available. When delisting returns are unavailable (as is sometimes the case in Vietnamese data), consider using imputed values based on the delisting reason.</p>
<p><strong>Look-ahead bias.</strong> When aligning compound returns to fiscal year ends for cross-sectional analysis, be careful not to use returns from before the fiscal year end to predict post-announcement returns. Vietnamese firms are required to publish audited annual financial statements within 90 days of the fiscal year end, so a buffer of at least 3 months is advisable when constructing forward-looking compound returns.</p>
<p><strong>Numerical overflow and underflow.</strong> For very long compounding horizons or extreme returns, the cumulative product can overflow (<code>inf</code>) or underflow (0). The log-sum-exp approach is more robust to such numerical issues because it operates in log space where the range is compressed.</p>
<p><strong>Annualization of partial periods.</strong> When computing annualized returns from partial-period data (e.g., 7 months of data annualized to 12), the annualization formula <span class="math inline">\((1+R)^{12/k} - 1\)</span> assumes that the observed return rate will persist. This assumption is stronger for short partial periods and can produce misleading results. Report the actual compound return and the number of periods alongside any annualized figures.</p>
<p><strong>Exchange transfers.</strong> In Vietnam, stocks sometimes transfer between UPCoM, HNX, and HOSE. These transfers may involve temporary trading halts and can cause apparent gaps in the return series. When computing compound returns that span an exchange transfer, ensure that the return series is continuous across the transfer date.</p>
<!-- ## Exercises

1.  Compute the annual compound return for the VN-Index for each year in the sample. How does it compare to the simple sum of monthly returns? In which years is the difference largest, and why?

2.  Implement a function that computes the **Calmar ratio** (annualized return divided by the absolute value of maximum drawdown) for each security. Which securities have the highest Calmar ratios over the most recent 5-year period? Do they tend to be on HOSE, HNX, or UPCoM?

3.  Sort stocks into quintiles based on their 12-month trailing compound return (the momentum signal) and compute the equal-weighted average return of each quintile in the subsequent month. Does the momentum effect appear in Vietnamese data? Compare your findings with evidence from @vo2018does.

4.  Extend the `rolling_compound_return` function to handle overlapping fiscal years, where the compounding window is aligned to each firm's fiscal year end rather than calendar months.

5.  Compare the BHAR and CAR measures for a set of randomly chosen event dates. Under what conditions do they diverge most? Relate your findings to the theoretical discussion of @barber1997detecting.

6.  Compute the cross-sectional correlation between 24-month rolling volatility and subsequent 12-month compound returns. Is there a risk-return tradeoff in the Vietnamese equity market cross section? How does this compare to the positive risk-return relationship documented in developed markets by @ghysels2005there?

7.  Examine how daily price limits affect the computation of weekly compound returns. Select stocks that hit the limit-up or limit-down ceiling on at least one day, and compare their weekly compound return to similar-magnitude events in stocks that did not hit the limit. -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-barber1997detecting" class="csl-entry" role="listitem">
Barber, Brad M, and John D Lyon. 1997. <span>‚ÄúDetecting Long-Run Abnormal Stock Returns: The Empirical Power and Specification of Test Statistics.‚Äù</span> <em>Journal of Financial Economics</em> 43 (3): 341‚Äì72.
</div>
<div id="ref-ben2012hedge" class="csl-entry" role="listitem">
Ben-David, Itzhak, Francesco Franzoni, and Rabih Moussawi. 2012. <span>‚ÄúHedge Fund Stock Trading in the Financial Crisis of 2007‚Äì2009.‚Äù</span> <em>The Review of Financial Studies</em> 25 (1): 1‚Äì54.
</div>
<div id="ref-daniel1997evidence" class="csl-entry" role="listitem">
Daniel, Kent, and Sheridan Titman. 1997. <span>‚ÄúEvidence on the Characteristics of Cross Sectional Variation in Stock Returns.‚Äù</span> <em>The Journal of Finance</em> 52 (1): 1‚Äì33.
</div>
<div id="ref-kahneman2013prospect" class="csl-entry" role="listitem">
Kahneman, Daniel, and Amos Tversky. 2013. <span>‚ÄúProspect Theory: An Analysis of Decision Under Risk.‚Äù</span> In <em>Handbook of the Fundamentals of Financial Decision Making: Part i</em>, 99‚Äì127. World Scientific.
</div>
<div id="ref-kim2013reconsidering" class="csl-entry" role="listitem">
Kim, Kenneth A, Haixiao Liu, and J Jimmy Yang. 2013. <span>‚ÄúReconsidering Price Limit Effectiveness.‚Äù</span> <em>Journal of Financial Research</em> 36 (4): 493‚Äì518.
</div>
<div id="ref-lyon1999improved" class="csl-entry" role="listitem">
Lyon, John D, Brad M Barber, and Chih-Ling Tsai. 1999. <span>‚ÄúImproved Methods for Tests of Long-Run Abnormal Stock Returns.‚Äù</span> <em>The Journal of Finance</em> 54 (1): 165‚Äì201.
</div>
<div id="ref-shumway1997delisting" class="csl-entry" role="listitem">
Shumway, Tyler. 1997. <span>‚ÄúThe Delisting Bias in CRSP Data.‚Äù</span> <em>The Journal of Finance</em> 52 (1): 327‚Äì40.
</div>
<div id="ref-vo2017foreign" class="csl-entry" role="listitem">
Vo, Xuan Vinh. 2017. <span>‚ÄúDo Foreign Investors Improve Stock Price Informativeness in Emerging Equity Markets? Evidence from Vietnam.‚Äù</span> <em>Research in International Business and Finance</em> 42: 986‚Äì91.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LG91D0C6RB";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./05_working_with_stock_returns.html" class="pagination-link" aria-label="Constructing and Analyzing Equity Return Series">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./10_modern_portfolio_theory.html" class="pagination-link" aria-label="Modern Portfolio Theory">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Compound Returns</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>In this chapter, we provide a treatment of compound returns. Whether constructing buy-and-hold portfolios, evaluating fund performance, computing cumulative wealth indices, or estimating long-horizon risk measures, the ability to correctly compound returns over arbitrary horizons is indispensable. We begin with the mathematical foundations: the distinction between simple and log returns, the relationship between arithmetic and geometric means, and the properties of continuously compounded returns. Along the way, we address practical complications that arise in real-world equity data, such as trading halts, price limit mechanisms, partial-period returns, and delisting events, and show how to handle them in the Vietnamese context.</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>The chapter proceeds to rolling compound returns over standard horizons (3, 6, 9, and 12 months), compound returns aligned to fiscal period ends, forward-looking cumulative returns for event studies, and rolling volatility estimation.</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format, date_format</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Simple Returns versus Log Returns</span></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>Before discussing compounding, we must distinguish between the two fundamental return conventions used in finance.</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simple (Arithmetic) Returns</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>The simple gross return on an asset from period $t-1$ to $t$ is defined as</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>1 + R_t = \frac{P_t + D_t}{P_{t-1}},</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>$$ {#eq-simple-return}</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>where $P_t$ denotes the price at the end of period $t$ and $D_t$ denotes any cash distributions (dividends, coupons) paid during period $t$. The simple net return is $R_t$ itself. When we speak of "returns" without qualification, we typically mean simple net returns.</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>The key property of simple returns is that **multi-period compounding is multiplicative**:</span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>1 + R_t(k) = \prod_{j=0}^{k-1} (1 + R_{t-j}) = (1 + R_t)(1 + R_{t-1}) \cdots (1 + R_{t-k+1}),</span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>$$ {#eq-compound-simple}</span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>where $R_t(k)$ is the $k$-period compound return ending at time $t$. This multiplicative structure is the foundation of all compounding methods discussed in this chapter.</span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="fu">### Continuously Compounded (Log) Returns</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a>The continuously compounded return, or log return, is defined as</span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>r_t = \ln(1 + R_t) = \ln<span class="sc">\!</span>\left(\frac{P_t + D_t}{P_{t-1}}\right).</span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>$$ {#eq-log-return}</span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>The central advantage of log returns for compounding is that **multi-period compounding becomes additive**:</span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>r_t(k) = \ln(1 + R_t(k)) = \sum_{j=0}^{k-1} r_{t-j} = r_t + r_{t-1} + \cdots + r_{t-k+1}.</span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>$$ {#eq-compound-log}</span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a>This additive property follows directly from the logarithmic identity $\ln(ab) = \ln(a) + \ln(b)$. It is computationally convenient because summation is numerically more stable than iterated multiplication, and because many statistical procedures (means, variances, regressions) operate naturally on additive quantities.</span>
<span id="cb40-57"><a href="#cb40-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-58"><a href="#cb40-58" aria-hidden="true" tabindex="-1"></a>To recover the simple compound return from the sum of log returns, we apply the exponential function:</span>
<span id="cb40-59"><a href="#cb40-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-60"><a href="#cb40-60" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-61"><a href="#cb40-61" aria-hidden="true" tabindex="-1"></a>R_t(k) = \exp<span class="sc">\!</span>\left(\sum_{j=0}^{k-1} r_{t-j}\right) - 1.</span>
<span id="cb40-62"><a href="#cb40-62" aria-hidden="true" tabindex="-1"></a>$$ {#eq-recover-simple}</span>
<span id="cb40-63"><a href="#cb40-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-64"><a href="#cb40-64" aria-hidden="true" tabindex="-1"></a><span class="fu">### When Do They Diverge?</span></span>
<span id="cb40-65"><a href="#cb40-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-66"><a href="#cb40-66" aria-hidden="true" tabindex="-1"></a>For small returns, the approximation $r_t \approx R_t$ holds to first order (via the Taylor expansion $\ln(1+x) \approx x$ for $|x| \ll 1$). However, for large returns, which is common in emerging markets, small-cap stocks, or crisis periods, the two can diverge substantially. Consider a stock that doubles in price ($R_t = 1.0$): the log return is $r_t = \ln(2) \approx 0.693$, a 31% discrepancy. Conversely, for a stock that loses half its value ($R_t = -0.5$): the log return is $r_t = \ln(0.5) \approx -0.693$, which is 39% larger in magnitude.</span>
<span id="cb40-67"><a href="#cb40-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-68"><a href="#cb40-68" aria-hidden="true" tabindex="-1"></a>This divergence is especially relevant in Vietnam, where daily price limits of $\pm 7\%$ on HOSE, $\pm 10\%$ on HNX, and $\pm 15\%$ on UPCoM can produce sequences of limit-up or limit-down days. Over a week of consecutive limit-up days on HOSE, the simple return is $(1.07)^5 - 1 = 40.3\%$ while the log return is $5 \times \ln(1.07) = 33.8\%$, which is a meaningful gap.</span>
<span id="cb40-69"><a href="#cb40-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-70"><a href="#cb40-70" aria-hidden="true" tabindex="-1"></a>@tbl-return-comparison illustrates this divergence across a range of return magnitudes.</span>
<span id="cb40-71"><a href="#cb40-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-74"><a href="#cb40-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-75"><a href="#cb40-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-return-comparison</span></span>
<span id="cb40-76"><a href="#cb40-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Comparison of simple and log returns for various price changes. The divergence grows with the magnitude of the simple return, which is particularly relevant for volatile emerging market stocks."</span></span>
<span id="cb40-77"><a href="#cb40-77" aria-hidden="true" tabindex="-1"></a>simple_returns <span class="op">=</span> [<span class="op">-</span><span class="fl">0.50</span>, <span class="op">-</span><span class="fl">0.30</span>, <span class="op">-</span><span class="fl">0.15</span>, <span class="op">-</span><span class="fl">0.10</span>, <span class="op">-</span><span class="fl">0.07</span>, <span class="op">-</span><span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.01</span>,</span>
<span id="cb40-78"><a href="#cb40-78" aria-hidden="true" tabindex="-1"></a>                  <span class="fl">0.00</span>, <span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.07</span>, <span class="fl">0.10</span>, <span class="fl">0.15</span>, <span class="fl">0.30</span>, <span class="fl">0.50</span>, <span class="fl">1.00</span>]</span>
<span id="cb40-79"><a href="#cb40-79" aria-hidden="true" tabindex="-1"></a>comparison_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-80"><a href="#cb40-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Simple Return"</span>: [<span class="ss">f"</span><span class="sc">{</span>r<span class="sc">:.2%}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb40-81"><a href="#cb40-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Log Return"</span>: [<span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>log(<span class="dv">1</span><span class="op">+</span>r)<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb40-82"><a href="#cb40-82" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Difference"</span>: [<span class="ss">f"</span><span class="sc">{</span>np<span class="sc">.</span>log(<span class="dv">1</span><span class="op">+</span>r) <span class="op">-</span> r<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> r <span class="kw">in</span> simple_returns],</span>
<span id="cb40-83"><a href="#cb40-83" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Relative Error (%)"</span>: [</span>
<span id="cb40-84"><a href="#cb40-84" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>((np.log(<span class="dv">1</span><span class="op">+</span>r) <span class="op">-</span> r) <span class="op">/</span> <span class="bu">abs</span>(r) <span class="op">*</span> <span class="dv">100</span>)<span class="sc">:.2f}</span><span class="ss">"</span> <span class="cf">if</span> r <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="st">"‚Äî"</span></span>
<span id="cb40-85"><a href="#cb40-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> simple_returns</span>
<span id="cb40-86"><a href="#cb40-86" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-87"><a href="#cb40-87" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-88"><a href="#cb40-88" aria-hidden="true" tabindex="-1"></a>comparison_df</span>
<span id="cb40-89"><a href="#cb40-89" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-90"><a href="#cb40-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-91"><a href="#cb40-91" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Key takeaway**: log returns are convenient for compounding (additive aggregation), but portfolio returns aggregate cross-sectionally in simple return space. In practice, we often transform to log returns for temporal compounding, then convert back to simple returns for reporting.</span></span>
<span id="cb40-92"><a href="#cb40-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-93"><a href="#cb40-93" aria-hidden="true" tabindex="-1"></a><span class="fu">## Mathematical Foundations of Compounding</span></span>
<span id="cb40-94"><a href="#cb40-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-95"><a href="#cb40-95" aria-hidden="true" tabindex="-1"></a><span class="fu">### Geometric Mean Return</span></span>
<span id="cb40-96"><a href="#cb40-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-97"><a href="#cb40-97" aria-hidden="true" tabindex="-1"></a>The geometric mean return over $T$ periods is</span>
<span id="cb40-98"><a href="#cb40-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-99"><a href="#cb40-99" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-100"><a href="#cb40-100" aria-hidden="true" tabindex="-1"></a>\bar{R}_g = \left(\prod_{t=1}^{T} (1 + R_t)\right)^{1/T} - 1,</span>
<span id="cb40-101"><a href="#cb40-101" aria-hidden="true" tabindex="-1"></a>$$ {#eq-geometric-mean}</span>
<span id="cb40-102"><a href="#cb40-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-103"><a href="#cb40-103" aria-hidden="true" tabindex="-1"></a>which represents the constant per-period return that would yield the same terminal wealth as the actual return sequence. It is always less than or equal to the arithmetic mean $\bar{R}_a = \frac{1}{T}\sum_{t=1}^{T} R_t$, with equality only when all returns are identical. The relationship between the two is approximately:</span>
<span id="cb40-104"><a href="#cb40-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-105"><a href="#cb40-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-106"><a href="#cb40-106" aria-hidden="true" tabindex="-1"></a>\bar{R}_g \approx \bar{R}_a - \frac{\sigma^2}{2},</span>
<span id="cb40-107"><a href="#cb40-107" aria-hidden="true" tabindex="-1"></a>$$ {#eq-arithmetic-geometric}</span>
<span id="cb40-108"><a href="#cb40-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-109"><a href="#cb40-109" aria-hidden="true" tabindex="-1"></a>where $\sigma^2$ is the variance of returns. This approximation, sometimes called the "volatility drag," has important implications: high-volatility assets have a larger wedge between their arithmetic and geometric means, meaning their actual compound growth understates what a naive average would suggest. In a market like Vietnam's, where individual stock volatility is often two to three times that of developed-market equities, the volatility drag can be substantial.</span>
<span id="cb40-110"><a href="#cb40-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-111"><a href="#cb40-111" aria-hidden="true" tabindex="-1"></a><span class="fu">### Wealth Index and Drawdowns</span></span>
<span id="cb40-112"><a href="#cb40-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-113"><a href="#cb40-113" aria-hidden="true" tabindex="-1"></a>Given an initial investment of $W_0$, the wealth at time $T$ is</span>
<span id="cb40-114"><a href="#cb40-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-115"><a href="#cb40-115" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-116"><a href="#cb40-116" aria-hidden="true" tabindex="-1"></a>W_T = W_0 \prod_{t=1}^{T} (1 + R_t).</span>
<span id="cb40-117"><a href="#cb40-117" aria-hidden="true" tabindex="-1"></a>$$ {#eq-wealth-index}</span>
<span id="cb40-118"><a href="#cb40-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-119"><a href="#cb40-119" aria-hidden="true" tabindex="-1"></a>The cumulative return (net) is simply $W_T / W_0 - 1$. The maximum drawdown, a widely used risk measure, is defined as</span>
<span id="cb40-120"><a href="#cb40-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-121"><a href="#cb40-121" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-122"><a href="#cb40-122" aria-hidden="true" tabindex="-1"></a>\text{MDD} = \max_{0 \le s \le t \le T} \left(\frac{W_s - W_t}{W_s}\right),</span>
<span id="cb40-123"><a href="#cb40-123" aria-hidden="true" tabindex="-1"></a>$$ {#eq-max-drawdown}</span>
<span id="cb40-124"><a href="#cb40-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-125"><a href="#cb40-125" aria-hidden="true" tabindex="-1"></a>which measures the largest peak-to-trough decline in the wealth index. We will compute this quantity alongside compound returns below. Drawdowns are particularly informative in emerging markets that experience sharp corrections, as occurred during the global financial crisis of 2008 when the VN-Index fell roughly 66% from its 2007 peak.</span>
<span id="cb40-126"><a href="#cb40-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-127"><a href="#cb40-127" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--# Show the data here --&gt;</span></span>
<span id="cb40-128"><a href="#cb40-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-129"><a href="#cb40-129" aria-hidden="true" tabindex="-1"></a><span class="fu">### Annualization</span></span>
<span id="cb40-130"><a href="#cb40-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-131"><a href="#cb40-131" aria-hidden="true" tabindex="-1"></a>For a $k$-period compound return $R_t(k)$ where each period has length $\Delta$ (e.g., $\Delta = 1/12$ for monthly data), the annualized return is</span>
<span id="cb40-132"><a href="#cb40-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-133"><a href="#cb40-133" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-134"><a href="#cb40-134" aria-hidden="true" tabindex="-1"></a>R_{\text{ann}} = (1 + R_t(k))^{1/(k\Delta)} - 1.</span>
<span id="cb40-135"><a href="#cb40-135" aria-hidden="true" tabindex="-1"></a>$$ {#eq-annualize}</span>
<span id="cb40-136"><a href="#cb40-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-137"><a href="#cb40-137" aria-hidden="true" tabindex="-1"></a>Similarly, for volatility estimated from $k$-period returns with period length $\Delta$:</span>
<span id="cb40-138"><a href="#cb40-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-139"><a href="#cb40-139" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-140"><a href="#cb40-140" aria-hidden="true" tabindex="-1"></a>\sigma_{\text{ann}} = \sigma / \sqrt{\Delta},</span>
<span id="cb40-141"><a href="#cb40-141" aria-hidden="true" tabindex="-1"></a>$$ {#eq-annualize-vol}</span>
<span id="cb40-142"><a href="#cb40-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-143"><a href="#cb40-143" aria-hidden="true" tabindex="-1"></a>so monthly volatility is annualized by multiplying by $\sqrt{12}$ and daily volatility by approximately $\sqrt{252}$ (assuming 252 trading days per year). For Vietnam specifically, the HOSE typically has around 245‚Äì250 trading days per year after accounting for Vietnamese public holidays, which is close enough that the $\sqrt{252}$ convention is standard.</span>
<span id="cb40-144"><a href="#cb40-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-145"><a href="#cb40-145" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation</span></span>
<span id="cb40-146"><a href="#cb40-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-147"><a href="#cb40-147" aria-hidden="true" tabindex="-1"></a>We start by loading monthly stock return data from our SQLite database. As prepared in previous chapters, this database contains monthly returns sourced from <span class="co">[</span><span class="ot">DataCore.vn</span><span class="co">](https://datacore.vn/)</span> for all securities listed on the Ho Chi Minh Stock Exchange (HOSE), Hanoi Stock Exchange (HNX), and the Unlisted Public Company Market (UPCoM). Returns are adjusted for stock splits, bonus issues, and rights offerings, and include reinvested cash dividends.</span>
<span id="cb40-148"><a href="#cb40-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-151"><a href="#cb40-151" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-152"><a href="#cb40-152" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb40-153"><a href="#cb40-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-154"><a href="#cb40-154" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb40-155"><a href="#cb40-155" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb40-156"><a href="#cb40-156" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess, ret, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb40-157"><a href="#cb40-157" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb40-158"><a href="#cb40-158" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb40-159"><a href="#cb40-159" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb40-160"><a href="#cb40-160" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb40-161"><a href="#cb40-161" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb40-162"><a href="#cb40-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-163"><a href="#cb40-163" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb40-164"><a href="#cb40-164" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess FROM factors_ff3_monthly"</span>,</span>
<span id="cb40-165"><a href="#cb40-165" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb40-166"><a href="#cb40-166" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>[<span class="st">"date"</span>]</span>
<span id="cb40-167"><a href="#cb40-167" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-168"><a href="#cb40-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-169"><a href="#cb40-169" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb40-170"><a href="#cb40-170" aria-hidden="true" tabindex="-1"></a>    factors_ff3_monthly,</span>
<span id="cb40-171"><a href="#cb40-171" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb40-172"><a href="#cb40-172" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb40-173"><a href="#cb40-173" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-174"><a href="#cb40-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-175"><a href="#cb40-175" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"ret_total"</span>] <span class="op">=</span> prices_monthly[<span class="st">"ret"</span>]</span>
<span id="cb40-176"><a href="#cb40-176" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"mkt_total"</span>] <span class="op">=</span> (</span>
<span id="cb40-177"><a href="#cb40-177" aria-hidden="true" tabindex="-1"></a>    prices_monthly[<span class="st">"mkt_excess"</span>] <span class="op">+</span> prices_monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb40-178"><a href="#cb40-178" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-179"><a href="#cb40-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-180"><a href="#cb40-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-181"><a href="#cb40-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-182"><a href="#cb40-182" aria-hidden="true" tabindex="-1"></a>Let us inspect the sample:</span>
<span id="cb40-183"><a href="#cb40-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-186"><a href="#cb40-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-187"><a href="#cb40-187" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample period: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb40-188"><a href="#cb40-188" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-189"><a href="#cb40-189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb40-190"><a href="#cb40-190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb40-191"><a href="#cb40-191" aria-hidden="true" tabindex="-1"></a><span class="co"># print(f"Exchanges: {prices_monthly['exchange'].unique()}")</span></span>
<span id="cb40-192"><a href="#cb40-192" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-193"><a href="#cb40-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-194"><a href="#cb40-194" aria-hidden="true" tabindex="-1"></a>@tbl-sample-overview provides summary statistics for the raw monthly returns, broken down by exchange. Differences across exchanges reflect the size and liquidity gradient: HOSE lists the largest and most liquid firms, HNX covers mid-cap companies, and UPCoM hosts smaller and more thinly traded securities.</span>
<span id="cb40-195"><a href="#cb40-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-198"><a href="#cb40-198" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-199"><a href="#cb40-199" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-sample-overview</span></span>
<span id="cb40-200"><a href="#cb40-200" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb40-201"><a href="#cb40-201" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary statistics of monthly stock returns by exchange. HOSE firms tend to have lower return dispersion and fewer extreme observations compared to HNX and UPCoM, consistent with their larger market capitalization and greater liquidity."</span></span>
<span id="cb40-202"><a href="#cb40-202" aria-hidden="true" tabindex="-1"></a>sample_stats <span class="op">=</span> (</span>
<span id="cb40-203"><a href="#cb40-203" aria-hidden="true" tabindex="-1"></a>    prices_monthly</span>
<span id="cb40-204"><a href="#cb40-204" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"exchange"</span>)[<span class="st">"ret_total"</span>]</span>
<span id="cb40-205"><a href="#cb40-205" aria-hidden="true" tabindex="-1"></a>    .describe(percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>])</span>
<span id="cb40-206"><a href="#cb40-206" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb40-207"><a href="#cb40-207" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-208"><a href="#cb40-208" aria-hidden="true" tabindex="-1"></a>sample_stats</span>
<span id="cb40-209"><a href="#cb40-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-210"><a href="#cb40-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-211"><a href="#cb40-211" aria-hidden="true" tabindex="-1"></a><span class="fu">## Method 1: Cumulative Product via GroupBy</span></span>
<span id="cb40-212"><a href="#cb40-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-213"><a href="#cb40-213" aria-hidden="true" tabindex="-1"></a>The most direct approach to compound returns uses the multiplicative property in @eq-compound-simple. For each security, we compute the cumulative product of gross returns $(1 + R_t)$ over the desired window.</span>
<span id="cb40-214"><a href="#cb40-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-217"><a href="#cb40-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-218"><a href="#cb40-218" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_cumprod(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-219"><a href="#cb40-219" aria-hidden="true" tabindex="-1"></a>                           group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb40-220"><a href="#cb40-220" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns using cumulative product.</span></span>
<span id="cb40-221"><a href="#cb40-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-222"><a href="#cb40-222" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-223"><a href="#cb40-223" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-224"><a href="#cb40-224" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-225"><a href="#cb40-225" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain `group_col`, 'date', and `ret_col`.</span></span>
<span id="cb40-226"><a href="#cb40-226" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-227"><a href="#cb40-227" aria-hidden="true" tabindex="-1"></a><span class="co">        Column name for period returns.</span></span>
<span id="cb40-228"><a href="#cb40-228" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-229"><a href="#cb40-229" aria-hidden="true" tabindex="-1"></a><span class="co">        Column name for grouping (e.g., security identifier).</span></span>
<span id="cb40-230"><a href="#cb40-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-231"><a href="#cb40-231" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-232"><a href="#cb40-232" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-233"><a href="#cb40-233" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb40-234"><a href="#cb40-234" aria-hidden="true" tabindex="-1"></a><span class="co">        Original DataFrame augmented with 'cumret' and 'wealth_index'.</span></span>
<span id="cb40-235"><a href="#cb40-235" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-236"><a href="#cb40-236" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-237"><a href="#cb40-237" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col]</span>
<span id="cb40-238"><a href="#cb40-238" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index"</span>] <span class="op">=</span> (</span>
<span id="cb40-239"><a href="#cb40-239" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>]</span>
<span id="cb40-240"><a href="#cb40-240" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb40-241"><a href="#cb40-241" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-242"><a href="#cb40-242" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth_index"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-243"><a href="#cb40-243" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-244"><a href="#cb40-244" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-245"><a href="#cb40-245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-246"><a href="#cb40-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-247"><a href="#cb40-247" aria-hidden="true" tabindex="-1"></a>Let us apply this to the full sample and examine the resulting wealth indices for a few selected stocks:</span>
<span id="cb40-248"><a href="#cb40-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-251"><a href="#cb40-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-252"><a href="#cb40-252" aria-hidden="true" tabindex="-1"></a>stock_cumret <span class="op">=</span> compute_cumret_cumprod(prices_monthly)</span>
<span id="cb40-253"><a href="#cb40-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-254"><a href="#cb40-254" aria-hidden="true" tabindex="-1"></a><span class="co"># Select stocks with long histories for illustration</span></span>
<span id="cb40-255"><a href="#cb40-255" aria-hidden="true" tabindex="-1"></a>stock_counts <span class="op">=</span> (</span>
<span id="cb40-256"><a href="#cb40-256" aria-hidden="true" tabindex="-1"></a>    stock_cumret.groupby(<span class="st">"symbol"</span>)[<span class="st">"date"</span>]</span>
<span id="cb40-257"><a href="#cb40-257" aria-hidden="true" tabindex="-1"></a>    .count()</span>
<span id="cb40-258"><a href="#cb40-258" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"n_obs"</span>)</span>
<span id="cb40-259"><a href="#cb40-259" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-260"><a href="#cb40-260" aria-hidden="true" tabindex="-1"></a>long_history_stocks <span class="op">=</span> (</span>
<span id="cb40-261"><a href="#cb40-261" aria-hidden="true" tabindex="-1"></a>    stock_counts.nlargest(<span class="dv">5</span>, <span class="st">"n_obs"</span>)[<span class="st">"symbol"</span>].tolist()</span>
<span id="cb40-262"><a href="#cb40-262" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-263"><a href="#cb40-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-264"><a href="#cb40-264" aria-hidden="true" tabindex="-1"></a>sample_wealth <span class="op">=</span> stock_cumret[</span>
<span id="cb40-265"><a href="#cb40-265" aria-hidden="true" tabindex="-1"></a>    stock_cumret[<span class="st">"symbol"</span>].isin(long_history_stocks)</span>
<span id="cb40-266"><a href="#cb40-266" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb40-267"><a href="#cb40-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-268"><a href="#cb40-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-269"><a href="#cb40-269" aria-hidden="true" tabindex="-1"></a>@fig-wealth-index plots the wealth indices (value of 1 VND invested) for these five securities over the full sample period.</span>
<span id="cb40-270"><a href="#cb40-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-273"><a href="#cb40-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-274"><a href="#cb40-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-wealth-index</span></span>
<span id="cb40-275"><a href="#cb40-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Wealth index (value of 1 VND invested) for selected long-history Vietnamese stocks. Each line represents the cumulative value of a 1 VND investment in a single stock, with all dividends reinvested. The divergence in terminal wealth illustrates the power of compounding over long horizons."</span></span>
<span id="cb40-276"><a href="#cb40-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing the growth of 1 VND invested in five different Vietnamese stocks over time."</span></span>
<span id="cb40-277"><a href="#cb40-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-pos: "htbp"</span></span>
<span id="cb40-278"><a href="#cb40-278" aria-hidden="true" tabindex="-1"></a>plot_wealth <span class="op">=</span> (</span>
<span id="cb40-279"><a href="#cb40-279" aria-hidden="true" tabindex="-1"></a>    ggplot(sample_wealth, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"wealth_index"</span>,</span>
<span id="cb40-280"><a href="#cb40-280" aria-hidden="true" tabindex="-1"></a>                              color<span class="op">=</span><span class="st">"factor(symbol)"</span>)) <span class="op">+</span></span>
<span id="cb40-281"><a href="#cb40-281" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="fl">0.6</span>) <span class="op">+</span></span>
<span id="cb40-282"><a href="#cb40-282" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb40-283"><a href="#cb40-283" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Wealth index (1 VND invested)"</span>,</span>
<span id="cb40-284"><a href="#cb40-284" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Stock"</span></span>
<span id="cb40-285"><a href="#cb40-285" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb40-286"><a href="#cb40-286" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-287"><a href="#cb40-287" aria-hidden="true" tabindex="-1"></a>    theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb40-288"><a href="#cb40-288" aria-hidden="true" tabindex="-1"></a>          figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb40-289"><a href="#cb40-289" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-290"><a href="#cb40-290" aria-hidden="true" tabindex="-1"></a>plot_wealth.draw()</span>
<span id="cb40-291"><a href="#cb40-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-292"><a href="#cb40-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-293"><a href="#cb40-293" aria-hidden="true" tabindex="-1"></a><span class="fu">### Handling Missing Returns</span></span>
<span id="cb40-294"><a href="#cb40-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-295"><a href="#cb40-295" aria-hidden="true" tabindex="-1"></a>The cumulative product approach propagates missing values: if any $R_t$ is <span class="in">`NaN`</span>, the entire cumulative product from that point onward becomes <span class="in">`NaN`</span>. This is conservative because it effectively assumes that a missing return renders the subsequent wealth index undefined. In many applications, this is the desired behavior because a missing return may indicate a data error or a period during which the stock was not trading.</span>
<span id="cb40-296"><a href="#cb40-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-297"><a href="#cb40-297" aria-hidden="true" tabindex="-1"></a>However, in the Vietnamese market, missing returns can arise from extended trading halts. The State Securities Commission (SSC) and exchanges may suspend trading in a stock for various regulatory reasons, such as financial reporting delays, pending corporate restructuring announcements, or suspected market manipulation. These halts can last days, weeks, or even months. During such halts, the stock's value has not changed (the last traded price remains the reference), so treating the missing return as zero (i.e., no price change) may be more appropriate than propagating <span class="in">`NaN`</span>.</span>
<span id="cb40-298"><a href="#cb40-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-301"><a href="#cb40-301" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-302"><a href="#cb40-302" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_skipna(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-303"><a href="#cb40-303" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb40-304"><a href="#cb40-304" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns, treating missing returns as zero."""</span></span>
<span id="cb40-305"><a href="#cb40-305" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-306"><a href="#cb40-306" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col].fillna(<span class="dv">0</span>)</span>
<span id="cb40-307"><a href="#cb40-307" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index"</span>] <span class="op">=</span> (</span>
<span id="cb40-308"><a href="#cb40-308" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>]</span>
<span id="cb40-309"><a href="#cb40-309" aria-hidden="true" tabindex="-1"></a>        .cumprod()</span>
<span id="cb40-310"><a href="#cb40-310" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-311"><a href="#cb40-311" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth_index"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-312"><a href="#cb40-312" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-313"><a href="#cb40-313" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-314"><a href="#cb40-314" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-315"><a href="#cb40-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-316"><a href="#cb40-316" aria-hidden="true" tabindex="-1"></a>::: callout-warning</span>
<span id="cb40-317"><a href="#cb40-317" aria-hidden="true" tabindex="-1"></a>Treating missing returns as zero is an assumption that may or may not be appropriate. If returns are missing because the stock was halted, zero may be reasonable. If returns are missing due to data errors or because the stock was genuinely not trading (e.g., awaiting relisting after a corporate event), imputing zero can introduce bias. Always investigate the reason for missing values before deciding on a treatment.</span>
<span id="cb40-318"><a href="#cb40-318" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-319"><a href="#cb40-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-320"><a href="#cb40-320" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--# The DataCore.vn documentation provides flags for different types of trading suspensions that can guide this decision. --&gt;</span></span>
<span id="cb40-321"><a href="#cb40-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-322"><a href="#cb40-322" aria-hidden="true" tabindex="-1"></a><span class="fu">## Method 2: Log-Sum-Exp Approach</span></span>
<span id="cb40-323"><a href="#cb40-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-324"><a href="#cb40-324" aria-hidden="true" tabindex="-1"></a>The log-sum-exp method exploits the additive property of log returns (@eq-compound-log). This approach is particularly useful when computing compound returns over fixed windows (e.g., annual returns from monthly data) because summation is both computationally efficient and numerically stable.</span>
<span id="cb40-325"><a href="#cb40-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-328"><a href="#cb40-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-329"><a href="#cb40-329" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_logsum(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-330"><a href="#cb40-330" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb40-331"><a href="#cb40-331" aria-hidden="true" tabindex="-1"></a>                          date_col<span class="op">=</span><span class="st">"date"</span>):</span>
<span id="cb40-332"><a href="#cb40-332" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns using the log-sum-exp approach.</span></span>
<span id="cb40-333"><a href="#cb40-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-334"><a href="#cb40-334" aria-hidden="true" tabindex="-1"></a><span class="co">    Steps:</span></span>
<span id="cb40-335"><a href="#cb40-335" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Transform to log returns: r_t = ln(1 + R_t)</span></span>
<span id="cb40-336"><a href="#cb40-336" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Cumulative sum of log returns within each group</span></span>
<span id="cb40-337"><a href="#cb40-337" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Exponentiate to recover simple cumulative return</span></span>
<span id="cb40-338"><a href="#cb40-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-339"><a href="#cb40-339" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-340"><a href="#cb40-340" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-341"><a href="#cb40-341" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-342"><a href="#cb40-342" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-343"><a href="#cb40-343" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-344"><a href="#cb40-344" aria-hidden="true" tabindex="-1"></a><span class="co">    date_col : str</span></span>
<span id="cb40-345"><a href="#cb40-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-346"><a href="#cb40-346" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-347"><a href="#cb40-347" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-348"><a href="#cb40-348" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb40-349"><a href="#cb40-349" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-350"><a href="#cb40-350" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, date_col]).copy()</span>
<span id="cb40-351"><a href="#cb40-351" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb40-352"><a href="#cb40-352" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_log_ret"</span>] <span class="op">=</span> (</span>
<span id="cb40-353"><a href="#cb40-353" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"log_ret"</span>].cumsum()</span>
<span id="cb40-354"><a href="#cb40-354" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-355"><a href="#cb40-355" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth_index_log"</span>] <span class="op">=</span> np.exp(df[<span class="st">"cum_log_ret"</span>])</span>
<span id="cb40-356"><a href="#cb40-356" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret_log"</span>] <span class="op">=</span> df[<span class="st">"wealth_index_log"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-357"><a href="#cb40-357" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"log_ret"</span>, <span class="st">"cum_log_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-358"><a href="#cb40-358" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-359"><a href="#cb40-359" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-360"><a href="#cb40-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-361"><a href="#cb40-361" aria-hidden="true" tabindex="-1"></a>Let us verify that the two methods produce identical results (up to floating-point precision):</span>
<span id="cb40-362"><a href="#cb40-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-365"><a href="#cb40-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-366"><a href="#cb40-366" aria-hidden="true" tabindex="-1"></a>stock_both <span class="op">=</span> compute_cumret_cumprod(prices_monthly)</span>
<span id="cb40-367"><a href="#cb40-367" aria-hidden="true" tabindex="-1"></a>stock_both <span class="op">=</span> compute_cumret_logsum(stock_both)</span>
<span id="cb40-368"><a href="#cb40-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-369"><a href="#cb40-369" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare on non-missing observations</span></span>
<span id="cb40-370"><a href="#cb40-370" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> (stock_both[<span class="st">"cumret"</span>].notna()</span>
<span id="cb40-371"><a href="#cb40-371" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> stock_both[<span class="st">"cumret_log"</span>].notna())</span>
<span id="cb40-372"><a href="#cb40-372" aria-hidden="true" tabindex="-1"></a>max_diff <span class="op">=</span> (stock_both.loc[mask, <span class="st">"cumret"</span>] <span class="op">-</span></span>
<span id="cb40-373"><a href="#cb40-373" aria-hidden="true" tabindex="-1"></a>            stock_both.loc[mask, <span class="st">"cumret_log"</span>]).<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb40-374"><a href="#cb40-374" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Maximum absolute difference between methods: </span><span class="sc">{</span>max_diff<span class="sc">:.2e}</span><span class="ss">"</span>)</span>
<span id="cb40-375"><a href="#cb40-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-376"><a href="#cb40-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-377"><a href="#cb40-377" aria-hidden="true" tabindex="-1"></a>The difference is at the level of machine epsilon ($\approx 10^{-15}$), confirming numerical equivalence.</span>
<span id="cb40-378"><a href="#cb40-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-379"><a href="#cb40-379" aria-hidden="true" tabindex="-1"></a><span class="fu">### Period-Specific Compound Returns</span></span>
<span id="cb40-380"><a href="#cb40-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-381"><a href="#cb40-381" aria-hidden="true" tabindex="-1"></a>A common task is to compute compound returns within calendar periods (months, quarters, years). The log-sum-exp approach lends itself naturally to grouped aggregation:</span>
<span id="cb40-382"><a href="#cb40-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-385"><a href="#cb40-385" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-386"><a href="#cb40-386" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compound_return_by_period(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-387"><a href="#cb40-387" aria-hidden="true" tabindex="-1"></a>                              group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb40-388"><a href="#cb40-388" aria-hidden="true" tabindex="-1"></a>                              period<span class="op">=</span><span class="st">"year"</span>):</span>
<span id="cb40-389"><a href="#cb40-389" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute compound returns within calendar periods.</span></span>
<span id="cb40-390"><a href="#cb40-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-391"><a href="#cb40-391" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-392"><a href="#cb40-392" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-393"><a href="#cb40-393" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-394"><a href="#cb40-394" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain 'date' and `ret_col`.</span></span>
<span id="cb40-395"><a href="#cb40-395" aria-hidden="true" tabindex="-1"></a><span class="co">    period : str</span></span>
<span id="cb40-396"><a href="#cb40-396" aria-hidden="true" tabindex="-1"></a><span class="co">        One of 'year', 'quarter', 'month'.</span></span>
<span id="cb40-397"><a href="#cb40-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-398"><a href="#cb40-398" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-399"><a href="#cb40-399" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-400"><a href="#cb40-400" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with compound returns per group-period.</span></span>
<span id="cb40-401"><a href="#cb40-401" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-402"><a href="#cb40-402" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb40-403"><a href="#cb40-403" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb40-404"><a href="#cb40-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> period <span class="op">==</span> <span class="st">"year"</span>:</span>
<span id="cb40-405"><a href="#cb40-405" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb40-406"><a href="#cb40-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> period <span class="op">==</span> <span class="st">"quarter"</span>:</span>
<span id="cb40-407"><a href="#cb40-407" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.to_period(<span class="st">"Q"</span>)</span>
<span id="cb40-408"><a href="#cb40-408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> period <span class="op">==</span> <span class="st">"month"</span>:</span>
<span id="cb40-409"><a href="#cb40-409" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"period"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb40-410"><a href="#cb40-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-411"><a href="#cb40-411" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> (</span>
<span id="cb40-412"><a href="#cb40-412" aria-hidden="true" tabindex="-1"></a>        df.groupby([group_col, <span class="st">"period"</span>])</span>
<span id="cb40-413"><a href="#cb40-413" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb40-414"><a href="#cb40-414" aria-hidden="true" tabindex="-1"></a>            cumret<span class="op">=</span>(</span>
<span id="cb40-415"><a href="#cb40-415" aria-hidden="true" tabindex="-1"></a>                <span class="st">"log_ret"</span>,</span>
<span id="cb40-416"><a href="#cb40-416" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: np.exp(x.<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-417"><a href="#cb40-417" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb40-418"><a href="#cb40-418" aria-hidden="true" tabindex="-1"></a>            n_obs<span class="op">=</span>(<span class="st">"log_ret"</span>, <span class="st">"count"</span>),</span>
<span id="cb40-419"><a href="#cb40-419" aria-hidden="true" tabindex="-1"></a>            n_miss<span class="op">=</span>(ret_col, <span class="kw">lambda</span> x: x.isna().<span class="bu">sum</span>()),</span>
<span id="cb40-420"><a href="#cb40-420" aria-hidden="true" tabindex="-1"></a>            start_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb40-421"><a href="#cb40-421" aria-hidden="true" tabindex="-1"></a>            end_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>)</span>
<span id="cb40-422"><a href="#cb40-422" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-423"><a href="#cb40-423" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb40-424"><a href="#cb40-424" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-425"><a href="#cb40-425" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb40-426"><a href="#cb40-426" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-427"><a href="#cb40-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-428"><a href="#cb40-428" aria-hidden="true" tabindex="-1"></a>@tbl-annual-returns shows annual compound returns for a subset of securities.</span>
<span id="cb40-429"><a href="#cb40-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-432"><a href="#cb40-432" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-433"><a href="#cb40-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-annual-returns</span></span>
<span id="cb40-434"><a href="#cb40-434" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Annual compound returns for selected Vietnamese securities. The number of non-missing monthly observations (n_obs) and missing observations (n_miss) are reported to flag potentially incomplete years. A stock-year with n_obs substantially below 12 indicates either partial listing or extended trading halts."</span></span>
<span id="cb40-435"><a href="#cb40-435" aria-hidden="true" tabindex="-1"></a>annual_returns <span class="op">=</span> compound_return_by_period(</span>
<span id="cb40-436"><a href="#cb40-436" aria-hidden="true" tabindex="-1"></a>    prices_monthly[</span>
<span id="cb40-437"><a href="#cb40-437" aria-hidden="true" tabindex="-1"></a>        prices_monthly[<span class="st">"symbol"</span>].isin(long_history_stocks)</span>
<span id="cb40-438"><a href="#cb40-438" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb40-439"><a href="#cb40-439" aria-hidden="true" tabindex="-1"></a>    period<span class="op">=</span><span class="st">"year"</span></span>
<span id="cb40-440"><a href="#cb40-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-441"><a href="#cb40-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-442"><a href="#cb40-442" aria-hidden="true" tabindex="-1"></a>recent_annual <span class="op">=</span> (</span>
<span id="cb40-443"><a href="#cb40-443" aria-hidden="true" tabindex="-1"></a>    annual_returns</span>
<span id="cb40-444"><a href="#cb40-444" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"symbol"</span>, <span class="st">"period"</span>])</span>
<span id="cb40-445"><a href="#cb40-445" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb40-446"><a href="#cb40-446" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">5</span>)</span>
<span id="cb40-447"><a href="#cb40-447" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb40-448"><a href="#cb40-448" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-449"><a href="#cb40-449" aria-hidden="true" tabindex="-1"></a>recent_annual.head(<span class="dv">20</span>)</span>
<span id="cb40-450"><a href="#cb40-450" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-451"><a href="#cb40-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-452"><a href="#cb40-452" aria-hidden="true" tabindex="-1"></a>::: callout-important</span>
<span id="cb40-453"><a href="#cb40-453" aria-hidden="true" tabindex="-1"></a>When the number of non-missing observations (<span class="in">`n_obs`</span>) is less than 12 for an annual return, the compound return represents only a partial year. This commonly occurs in the first and last years of a security's listing on HOSE, HNX, or UPCoM, or when a stock transfers between exchanges (e.g., from UPCoM to HOSE upon meeting listing requirements). Users should decide whether to retain or exclude such partial-year observations depending on their research design.</span>
<span id="cb40-454"><a href="#cb40-454" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-455"><a href="#cb40-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-456"><a href="#cb40-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## Method 3: Iterative Compounding with Retain Logic</span></span>
<span id="cb40-457"><a href="#cb40-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-458"><a href="#cb40-458" aria-hidden="true" tabindex="-1"></a>In some applications, we need fine-grained control over how missing values, delisting events, or other special conditions affect the compounding process. The iterative approach processes each observation sequentially, carrying forward the cumulative return and applying conditional logic at each step.</span>
<span id="cb40-459"><a href="#cb40-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-462"><a href="#cb40-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-463"><a href="#cb40-463" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_cumret_iterative(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-464"><a href="#cb40-464" aria-hidden="true" tabindex="-1"></a>                              group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb40-465"><a href="#cb40-465" aria-hidden="true" tabindex="-1"></a>                              handle_missing<span class="op">=</span><span class="st">"carry"</span>):</span>
<span id="cb40-466"><a href="#cb40-466" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute cumulative returns iteratively with flexible</span></span>
<span id="cb40-467"><a href="#cb40-467" aria-hidden="true" tabindex="-1"></a><span class="co">    missing value handling.</span></span>
<span id="cb40-468"><a href="#cb40-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-469"><a href="#cb40-469" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-470"><a href="#cb40-470" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-471"><a href="#cb40-471" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-472"><a href="#cb40-472" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-473"><a href="#cb40-473" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-474"><a href="#cb40-474" aria-hidden="true" tabindex="-1"></a><span class="co">    handle_missing : str</span></span>
<span id="cb40-475"><a href="#cb40-475" aria-hidden="true" tabindex="-1"></a><span class="co">        'carry' : treat missing as zero return (carry forward)</span></span>
<span id="cb40-476"><a href="#cb40-476" aria-hidden="true" tabindex="-1"></a><span class="co">        'propagate' : propagate NaN (conservative)</span></span>
<span id="cb40-477"><a href="#cb40-477" aria-hidden="true" tabindex="-1"></a><span class="co">        'reset' : reset wealth index to 1 after missing spell</span></span>
<span id="cb40-478"><a href="#cb40-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-479"><a href="#cb40-479" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-480"><a href="#cb40-480" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-481"><a href="#cb40-481" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb40-482"><a href="#cb40-482" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-483"><a href="#cb40-483" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-484"><a href="#cb40-484" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb40-485"><a href="#cb40-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-486"><a href="#cb40-486" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, group <span class="kw">in</span> df.groupby(group_col):</span>
<span id="cb40-487"><a href="#cb40-487" aria-hidden="true" tabindex="-1"></a>        cumret <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb40-488"><a href="#cb40-488" aria-hidden="true" tabindex="-1"></a>        cumrets <span class="op">=</span> []</span>
<span id="cb40-489"><a href="#cb40-489" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> group.iterrows():</span>
<span id="cb40-490"><a href="#cb40-490" aria-hidden="true" tabindex="-1"></a>            ret <span class="op">=</span> row[ret_col]</span>
<span id="cb40-491"><a href="#cb40-491" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pd.notna(ret):</span>
<span id="cb40-492"><a href="#cb40-492" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> cumret <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> ret)</span>
<span id="cb40-493"><a href="#cb40-493" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb40-494"><a href="#cb40-494" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> handle_missing <span class="op">==</span> <span class="st">"propagate"</span>:</span>
<span id="cb40-495"><a href="#cb40-495" aria-hidden="true" tabindex="-1"></a>                    cumret <span class="op">=</span> np.nan</span>
<span id="cb40-496"><a href="#cb40-496" aria-hidden="true" tabindex="-1"></a>                <span class="cf">elif</span> handle_missing <span class="op">==</span> <span class="st">"reset"</span>:</span>
<span id="cb40-497"><a href="#cb40-497" aria-hidden="true" tabindex="-1"></a>                    cumret <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb40-498"><a href="#cb40-498" aria-hidden="true" tabindex="-1"></a>                <span class="co"># 'carry' does nothing (cumret unchanged)</span></span>
<span id="cb40-499"><a href="#cb40-499" aria-hidden="true" tabindex="-1"></a>            cumrets.append(cumret)</span>
<span id="cb40-500"><a href="#cb40-500" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.copy()</span>
<span id="cb40-501"><a href="#cb40-501" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">"wealth_iter"</span>] <span class="op">=</span> cumrets</span>
<span id="cb40-502"><a href="#cb40-502" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">"cumret_iter"</span>] <span class="op">=</span> group[<span class="st">"wealth_iter"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-503"><a href="#cb40-503" aria-hidden="true" tabindex="-1"></a>        results.append(group)</span>
<span id="cb40-504"><a href="#cb40-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-505"><a href="#cb40-505" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-506"><a href="#cb40-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-507"><a href="#cb40-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-508"><a href="#cb40-508" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb40-509"><a href="#cb40-509" aria-hidden="true" tabindex="-1"></a>The iterative method is the slowest of the four approaches because it cannot leverage NumPy's vectorized operations. For large datasets, prefer Method 1 or 2 unless the conditional logic in Method 3 is essential. On a dataset with 1 million observations, Method 1 runs in approximately 0.1 seconds versus 10+ seconds for Method 3.</span>
<span id="cb40-510"><a href="#cb40-510" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb40-511"><a href="#cb40-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-512"><a href="#cb40-512" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparison of Missing Value Treatments</span></span>
<span id="cb40-513"><a href="#cb40-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-514"><a href="#cb40-514" aria-hidden="true" tabindex="-1"></a>To illustrate how the three missing-value strategies differ, consider a hypothetical stock with one missing return in the middle of its history:</span>
<span id="cb40-515"><a href="#cb40-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-518"><a href="#cb40-518" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-519"><a href="#cb40-519" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-missing-comparison</span></span>
<span id="cb40-520"><a href="#cb40-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Effect of different missing value treatments on cumulative returns. The 'carry' strategy assumes zero return for missing periods (appropriate for trading halts); 'propagate' makes all subsequent values undefined (conservative); 'reset' restarts the cumulative product after the missing spell."</span></span>
<span id="cb40-521"><a href="#cb40-521" aria-hidden="true" tabindex="-1"></a>example <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-522"><a href="#cb40-522" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: [<span class="dv">1</span>]<span class="op">*</span><span class="dv">6</span>,</span>
<span id="cb40-523"><a href="#cb40-523" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: pd.date_range(<span class="st">"2024-01-31"</span>, periods<span class="op">=</span><span class="dv">6</span>, freq<span class="op">=</span><span class="st">"ME"</span>),</span>
<span id="cb40-524"><a href="#cb40-524" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret_total"</span>: [<span class="fl">0.05</span>, <span class="fl">0.03</span>, np.nan, <span class="fl">0.04</span>, <span class="op">-</span><span class="fl">0.02</span>, <span class="fl">0.06</span>]</span>
<span id="cb40-525"><a href="#cb40-525" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-526"><a href="#cb40-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-527"><a href="#cb40-527" aria-hidden="true" tabindex="-1"></a>carry <span class="op">=</span> compute_cumret_iterative(example, handle_missing<span class="op">=</span><span class="st">"carry"</span>)</span>
<span id="cb40-528"><a href="#cb40-528" aria-hidden="true" tabindex="-1"></a>propagate <span class="op">=</span> compute_cumret_iterative(</span>
<span id="cb40-529"><a href="#cb40-529" aria-hidden="true" tabindex="-1"></a>    example, handle_missing<span class="op">=</span><span class="st">"propagate"</span></span>
<span id="cb40-530"><a href="#cb40-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-531"><a href="#cb40-531" aria-hidden="true" tabindex="-1"></a>reset <span class="op">=</span> compute_cumret_iterative(example, handle_missing<span class="op">=</span><span class="st">"reset"</span>)</span>
<span id="cb40-532"><a href="#cb40-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-533"><a href="#cb40-533" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-534"><a href="#cb40-534" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Date"</span>: example[<span class="st">"date"</span>].dt.strftime(<span class="st">"%Y-%m"</span>),</span>
<span id="cb40-535"><a href="#cb40-535" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Return"</span>: example[<span class="st">"ret_total"</span>],</span>
<span id="cb40-536"><a href="#cb40-536" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Carry"</span>: carry[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb40-537"><a href="#cb40-537" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Propagate"</span>: propagate[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb40-538"><a href="#cb40-538" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Reset"</span>: reset[<span class="st">"cumret_iter"</span>].<span class="bu">round</span>(<span class="dv">6</span>)</span>
<span id="cb40-539"><a href="#cb40-539" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-540"><a href="#cb40-540" aria-hidden="true" tabindex="-1"></a>comparison</span>
<span id="cb40-541"><a href="#cb40-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-542"><a href="#cb40-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-543"><a href="#cb40-543" aria-hidden="true" tabindex="-1"></a><span class="fu">## Method 4: Rolling Compound Returns</span></span>
<span id="cb40-544"><a href="#cb40-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-545"><a href="#cb40-545" aria-hidden="true" tabindex="-1"></a>For many empirical applications, including momentum strategies, performance evaluation, and risk estimation, we need compound returns over rolling windows of fixed length. This section implements efficient rolling compounding using pandas.</span>
<span id="cb40-546"><a href="#cb40-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-547"><a href="#cb40-547" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rolling Window via Log Returns</span></span>
<span id="cb40-548"><a href="#cb40-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-549"><a href="#cb40-549" aria-hidden="true" tabindex="-1"></a>The most efficient approach combines the log-sum-exp method with rolling sums:</span>
<span id="cb40-550"><a href="#cb40-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-553"><a href="#cb40-553" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-554"><a href="#cb40-554" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_compound_return(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-555"><a href="#cb40-555" aria-hidden="true" tabindex="-1"></a>                             group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb40-556"><a href="#cb40-556" aria-hidden="true" tabindex="-1"></a>                             windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]):</span>
<span id="cb40-557"><a href="#cb40-557" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling compound returns over specified windows.</span></span>
<span id="cb40-558"><a href="#cb40-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-559"><a href="#cb40-559" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-560"><a href="#cb40-560" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-561"><a href="#cb40-561" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-562"><a href="#cb40-562" aria-hidden="true" tabindex="-1"></a><span class="co">        Must be sorted by [group_col, 'date'] with no gaps.</span></span>
<span id="cb40-563"><a href="#cb40-563" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-564"><a href="#cb40-564" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-565"><a href="#cb40-565" aria-hidden="true" tabindex="-1"></a><span class="co">    windows : list of int</span></span>
<span id="cb40-566"><a href="#cb40-566" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling window lengths (in periods).</span></span>
<span id="cb40-567"><a href="#cb40-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-568"><a href="#cb40-568" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-569"><a href="#cb40-569" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-570"><a href="#cb40-570" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with new columns ret_{k} for each window k.</span></span>
<span id="cb40-571"><a href="#cb40-571" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-572"><a href="#cb40-572" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-573"><a href="#cb40-573" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[ret_col])</span>
<span id="cb40-574"><a href="#cb40-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-575"><a href="#cb40-575" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> windows:</span>
<span id="cb40-576"><a href="#cb40-576" aria-hidden="true" tabindex="-1"></a>        rolling_logsum <span class="op">=</span> (</span>
<span id="cb40-577"><a href="#cb40-577" aria-hidden="true" tabindex="-1"></a>            df.groupby(group_col)[<span class="st">"log_ret"</span>]</span>
<span id="cb40-578"><a href="#cb40-578" aria-hidden="true" tabindex="-1"></a>            .transform(</span>
<span id="cb40-579"><a href="#cb40-579" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb40-580"><a href="#cb40-580" aria-hidden="true" tabindex="-1"></a>                    window<span class="op">=</span>k, min_periods<span class="op">=</span>k</span>
<span id="cb40-581"><a href="#cb40-581" aria-hidden="true" tabindex="-1"></a>                ).<span class="bu">sum</span>()</span>
<span id="cb40-582"><a href="#cb40-582" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb40-583"><a href="#cb40-583" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-584"><a href="#cb40-584" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(rolling_logsum) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-585"><a href="#cb40-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-586"><a href="#cb40-586" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"log_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-587"><a href="#cb40-587" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-588"><a href="#cb40-588" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-589"><a href="#cb40-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-590"><a href="#cb40-590" aria-hidden="true" tabindex="-1"></a>We apply this to our full sample to compute 3-, 6-, 9-, and 12-month trailing compound returns:</span>
<span id="cb40-591"><a href="#cb40-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-594"><a href="#cb40-594" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-595"><a href="#cb40-595" aria-hidden="true" tabindex="-1"></a>stock_rolling <span class="op">=</span> rolling_compound_return(</span>
<span id="cb40-596"><a href="#cb40-596" aria-hidden="true" tabindex="-1"></a>    prices_monthly,</span>
<span id="cb40-597"><a href="#cb40-597" aria-hidden="true" tabindex="-1"></a>    windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb40-598"><a href="#cb40-598" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-599"><a href="#cb40-599" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-600"><a href="#cb40-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-601"><a href="#cb40-601" aria-hidden="true" tabindex="-1"></a>Let us also compute the same rolling returns for the market index, which serves as a benchmark for excess return calculations:</span>
<span id="cb40-602"><a href="#cb40-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-605"><a href="#cb40-605" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-606"><a href="#cb40-606" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute market rolling returns</span></span>
<span id="cb40-607"><a href="#cb40-607" aria-hidden="true" tabindex="-1"></a>market_monthly <span class="op">=</span> (</span>
<span id="cb40-608"><a href="#cb40-608" aria-hidden="true" tabindex="-1"></a>    prices_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_total"</span>]]</span>
<span id="cb40-609"><a href="#cb40-609" aria-hidden="true" tabindex="-1"></a>    .drop_duplicates()</span>
<span id="cb40-610"><a href="#cb40-610" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"date"</span>)</span>
<span id="cb40-611"><a href="#cb40-611" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb40-612"><a href="#cb40-612" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-613"><a href="#cb40-613" aria-hidden="true" tabindex="-1"></a>market_monthly[<span class="st">"log_mkt"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> market_monthly[<span class="st">"mkt_total"</span>])</span>
<span id="cb40-614"><a href="#cb40-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-615"><a href="#cb40-615" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]:</span>
<span id="cb40-616"><a href="#cb40-616" aria-hidden="true" tabindex="-1"></a>    market_monthly[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb40-617"><a href="#cb40-617" aria-hidden="true" tabindex="-1"></a>        np.exp(</span>
<span id="cb40-618"><a href="#cb40-618" aria-hidden="true" tabindex="-1"></a>            market_monthly[<span class="st">"log_mkt"</span>]</span>
<span id="cb40-619"><a href="#cb40-619" aria-hidden="true" tabindex="-1"></a>            .rolling(window<span class="op">=</span>k, min_periods<span class="op">=</span>k)</span>
<span id="cb40-620"><a href="#cb40-620" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">sum</span>()</span>
<span id="cb40-621"><a href="#cb40-621" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-622"><a href="#cb40-622" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-623"><a href="#cb40-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-624"><a href="#cb40-624" aria-hidden="true" tabindex="-1"></a>market_monthly.drop(columns<span class="op">=</span>[<span class="st">"log_mkt"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-625"><a href="#cb40-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-626"><a href="#cb40-626" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge market rolling returns back</span></span>
<span id="cb40-627"><a href="#cb40-627" aria-hidden="true" tabindex="-1"></a>stock_rolling <span class="op">=</span> stock_rolling.merge(</span>
<span id="cb40-628"><a href="#cb40-628" aria-hidden="true" tabindex="-1"></a>    market_monthly[</span>
<span id="cb40-629"><a href="#cb40-629" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]]</span>
<span id="cb40-630"><a href="#cb40-630" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb40-631"><a href="#cb40-631" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb40-632"><a href="#cb40-632" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb40-633"><a href="#cb40-633" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-634"><a href="#cb40-634" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-635"><a href="#cb40-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-636"><a href="#cb40-636" aria-hidden="true" tabindex="-1"></a>@fig-rolling-returns displays the distribution of 12-month rolling compound returns over time.</span>
<span id="cb40-637"><a href="#cb40-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-640"><a href="#cb40-640" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-641"><a href="#cb40-641" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rolling-returns</span></span>
<span id="cb40-642"><a href="#cb40-642" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-sectional distribution of 12-month rolling compound returns for Vietnamese stocks over time. The shaded band represents the interquartile range (25th‚Äì75th percentiles), while the solid line shows the median. Sharp market-wide events‚Äîsuch as the 2008 global financial crisis and the 2020 COVID-19 shock‚Äîare visible as periods when even the median return turns sharply negative."</span></span>
<span id="cb40-643"><a href="#cb40-643" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Time series chart showing the distribution of 12-month rolling stock returns in Vietnam."</span></span>
<span id="cb40-644"><a href="#cb40-644" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-pos: "htbp"</span></span>
<span id="cb40-645"><a href="#cb40-645" aria-hidden="true" tabindex="-1"></a>rolling_stats <span class="op">=</span> (</span>
<span id="cb40-646"><a href="#cb40-646" aria-hidden="true" tabindex="-1"></a>    stock_rolling</span>
<span id="cb40-647"><a href="#cb40-647" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret_12"</span>])</span>
<span id="cb40-648"><a href="#cb40-648" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"ret_12"</span>]</span>
<span id="cb40-649"><a href="#cb40-649" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>),</span>
<span id="cb40-650"><a href="#cb40-650" aria-hidden="true" tabindex="-1"></a>           <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb40-651"><a href="#cb40-651" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-652"><a href="#cb40-652" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-653"><a href="#cb40-653" aria-hidden="true" tabindex="-1"></a>rolling_stats.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"median"</span>, <span class="st">"p25"</span>, <span class="st">"p75"</span>]</span>
<span id="cb40-654"><a href="#cb40-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-655"><a href="#cb40-655" aria-hidden="true" tabindex="-1"></a>plot_rolling <span class="op">=</span> (</span>
<span id="cb40-656"><a href="#cb40-656" aria-hidden="true" tabindex="-1"></a>    ggplot(rolling_stats, aes(x<span class="op">=</span><span class="st">"date"</span>)) <span class="op">+</span></span>
<span id="cb40-657"><a href="#cb40-657" aria-hidden="true" tabindex="-1"></a>    geom_ribbon(aes(ymin<span class="op">=</span><span class="st">"p25"</span>, ymax<span class="op">=</span><span class="st">"p75"</span>),</span>
<span id="cb40-658"><a href="#cb40-658" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.3</span>, fill<span class="op">=</span><span class="st">"#2166ac"</span>) <span class="op">+</span></span>
<span id="cb40-659"><a href="#cb40-659" aria-hidden="true" tabindex="-1"></a>    geom_line(aes(y<span class="op">=</span><span class="st">"median"</span>), color<span class="op">=</span><span class="st">"#2166ac"</span>, size<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb40-660"><a href="#cb40-660" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb40-661"><a href="#cb40-661" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"12-month compound return"</span>) <span class="op">+</span></span>
<span id="cb40-662"><a href="#cb40-662" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb40-663"><a href="#cb40-663" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-664"><a href="#cb40-664" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb40-665"><a href="#cb40-665" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-666"><a href="#cb40-666" aria-hidden="true" tabindex="-1"></a>plot_rolling.draw()</span>
<span id="cb40-667"><a href="#cb40-667" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-668"><a href="#cb40-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-669"><a href="#cb40-669" aria-hidden="true" tabindex="-1"></a><span class="fu">### Verifying Rolling Returns</span></span>
<span id="cb40-670"><a href="#cb40-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-671"><a href="#cb40-671" aria-hidden="true" tabindex="-1"></a>It is prudent to verify rolling compound returns against a direct calculation. We select one stock and recompute its 12-month return manually:</span>
<span id="cb40-672"><a href="#cb40-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-675"><a href="#cb40-675" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-676"><a href="#cb40-676" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-rolling-verify</span></span>
<span id="cb40-677"><a href="#cb40-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Verification of rolling compound return calculation. The 'Direct' column computes the product of the preceding 12 monthly gross returns minus one; 'Rolling' uses our log-sum-exp function. Differences are at machine precision."</span></span>
<span id="cb40-678"><a href="#cb40-678" aria-hidden="true" tabindex="-1"></a>test_stock <span class="op">=</span> long_history_stocks[<span class="dv">0</span>]</span>
<span id="cb40-679"><a href="#cb40-679" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> (</span>
<span id="cb40-680"><a href="#cb40-680" aria-hidden="true" tabindex="-1"></a>    stock_rolling[stock_rolling[<span class="st">"symbol"</span>] <span class="op">==</span> test_stock]</span>
<span id="cb40-681"><a href="#cb40-681" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"date"</span>)</span>
<span id="cb40-682"><a href="#cb40-682" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">15</span>)</span>
<span id="cb40-683"><a href="#cb40-683" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb40-684"><a href="#cb40-684" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-685"><a href="#cb40-685" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-686"><a href="#cb40-686" aria-hidden="true" tabindex="-1"></a><span class="co"># Direct computation</span></span>
<span id="cb40-687"><a href="#cb40-687" aria-hidden="true" tabindex="-1"></a>test_data[<span class="st">"direct_ret_12"</span>] <span class="op">=</span> (</span>
<span id="cb40-688"><a href="#cb40-688" aria-hidden="true" tabindex="-1"></a>    test_data[<span class="st">"ret_total"</span>]</span>
<span id="cb40-689"><a href="#cb40-689" aria-hidden="true" tabindex="-1"></a>    .transform(</span>
<span id="cb40-690"><a href="#cb40-690" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.add(<span class="dv">1</span>).rolling(</span>
<span id="cb40-691"><a href="#cb40-691" aria-hidden="true" tabindex="-1"></a>            <span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span></span>
<span id="cb40-692"><a href="#cb40-692" aria-hidden="true" tabindex="-1"></a>        ).<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-693"><a href="#cb40-693" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-694"><a href="#cb40-694" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-695"><a href="#cb40-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-696"><a href="#cb40-696" aria-hidden="true" tabindex="-1"></a>verify <span class="op">=</span> (</span>
<span id="cb40-697"><a href="#cb40-697" aria-hidden="true" tabindex="-1"></a>    test_data[[<span class="st">"date"</span>, <span class="st">"ret_12"</span>, <span class="st">"direct_ret_12"</span>]]</span>
<span id="cb40-698"><a href="#cb40-698" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb40-699"><a href="#cb40-699" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">5</span>)</span>
<span id="cb40-700"><a href="#cb40-700" aria-hidden="true" tabindex="-1"></a>    .copy()</span>
<span id="cb40-701"><a href="#cb40-701" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-702"><a href="#cb40-702" aria-hidden="true" tabindex="-1"></a>verify[<span class="st">"difference"</span>] <span class="op">=</span> (</span>
<span id="cb40-703"><a href="#cb40-703" aria-hidden="true" tabindex="-1"></a>    verify[<span class="st">"ret_12"</span>] <span class="op">-</span> verify[<span class="st">"direct_ret_12"</span>]</span>
<span id="cb40-704"><a href="#cb40-704" aria-hidden="true" tabindex="-1"></a>).<span class="bu">abs</span>()</span>
<span id="cb40-705"><a href="#cb40-705" aria-hidden="true" tabindex="-1"></a>verify.<span class="bu">round</span>(<span class="dv">8</span>)</span>
<span id="cb40-706"><a href="#cb40-706" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-707"><a href="#cb40-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-708"><a href="#cb40-708" aria-hidden="true" tabindex="-1"></a><span class="fu">## Delisting Returns and Survivorship Bias</span></span>
<span id="cb40-709"><a href="#cb40-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-710"><a href="#cb40-710" aria-hidden="true" tabindex="-1"></a>A critical practical concern when computing compound returns is the treatment of securities that are removed from an exchange. Delisting occurs for various reasons: mergers and acquisitions, bankruptcy, failure to meet listing requirements, voluntary withdrawal, or transfer to another exchange. If delisting returns are not incorporated, the resulting compound returns suffer from survivorship bias: they overstate performance because the worst outcomes (bankruptcies, forced delistings) are excluded <span class="co">[</span><span class="ot">@shumway1997delisting</span><span class="co">]</span>.</span>
<span id="cb40-711"><a href="#cb40-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-712"><a href="#cb40-712" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Vietnamese Context</span></span>
<span id="cb40-713"><a href="#cb40-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-714"><a href="#cb40-714" aria-hidden="true" tabindex="-1"></a>In Vietnam, securities can be removed from their exchange listing for several reasons as specified by the SSC and exchange regulations:</span>
<span id="cb40-715"><a href="#cb40-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-716"><a href="#cb40-716" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Mandatory delisting**: when a firm has accumulated losses exceeding its charter capital, fails to meet financial reporting obligations for three consecutive years, or has its business license revoked.</span>
<span id="cb40-717"><a href="#cb40-717" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Voluntary delisting**: when a firm's shareholders vote to withdraw from the exchange.</span>
<span id="cb40-718"><a href="#cb40-718" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Transfer**: when a firm moves from UPCoM to HOSE/HNX (upgrade) or from HOSE/HNX to UPCoM (downgrade). These transfers are not true delistings in the economic sense but require careful handling in return calculations.</span>
<span id="cb40-719"><a href="#cb40-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-720"><a href="#cb40-720" aria-hidden="true" tabindex="-1"></a>Unlike more developed markets where detailed delisting return data is systematically compiled, Vietnamese market data may not always provide an explicit delisting return. When a stock is delisted for cause (e.g., bankruptcy), the last traded price may significantly overstate the security's recovery value. Researchers should be aware of this limitation and consider imputing delisting returns based on the delisting reason, following the methodology of @shumway1997delisting.</span>
<span id="cb40-721"><a href="#cb40-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-722"><a href="#cb40-722" aria-hidden="true" tabindex="-1"></a><span class="fu">### Incorporating Delisting Returns</span></span>
<span id="cb40-723"><a href="#cb40-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-724"><a href="#cb40-724" aria-hidden="true" tabindex="-1"></a>When a security is delisted, a final "delisting return" captures the value change between the last regular trading day and the realization of value after delisting. This return must be combined with the regular return in the delisting month:</span>
<span id="cb40-725"><a href="#cb40-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-726"><a href="#cb40-726" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-727"><a href="#cb40-727" aria-hidden="true" tabindex="-1"></a>R_t^{\text{adj}} = (1 + R_t)(1 + R_t^{\text{delist}}) - 1,</span>
<span id="cb40-728"><a href="#cb40-728" aria-hidden="true" tabindex="-1"></a>$$ {#eq-delisting-adj}</span>
<span id="cb40-729"><a href="#cb40-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-730"><a href="#cb40-730" aria-hidden="true" tabindex="-1"></a>where $R_t$ is the regular return and $R_t^{\text{delist}}$ is the delisting return. If the regular return is missing (the stock ceased trading before month end), we use the delisting return alone.</span>
<span id="cb40-731"><a href="#cb40-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-734"><a href="#cb40-734" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-735"><a href="#cb40-735" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_for_delisting(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-736"><a href="#cb40-736" aria-hidden="true" tabindex="-1"></a>                          dlret_col<span class="op">=</span><span class="st">"dlret"</span>):</span>
<span id="cb40-737"><a href="#cb40-737" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adjust returns for delisting events.</span></span>
<span id="cb40-738"><a href="#cb40-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-739"><a href="#cb40-739" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-740"><a href="#cb40-740" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-741"><a href="#cb40-741" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-742"><a href="#cb40-742" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain `ret_col` and `dlret_col`.</span></span>
<span id="cb40-743"><a href="#cb40-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-744"><a href="#cb40-744" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-745"><a href="#cb40-745" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-746"><a href="#cb40-746" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with adjusted return column 'ret_adj'.</span></span>
<span id="cb40-747"><a href="#cb40-747" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-748"><a href="#cb40-748" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb40-749"><a href="#cb40-749" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_adj"</span>] <span class="op">=</span> df[ret_col]</span>
<span id="cb40-750"><a href="#cb40-750" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-751"><a href="#cb40-751" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Case 1: Both regular and delisting returns available</span></span>
<span id="cb40-752"><a href="#cb40-752" aria-hidden="true" tabindex="-1"></a>    mask_both <span class="op">=</span> df[ret_col].notna() <span class="op">&amp;</span> df[dlret_col].notna()</span>
<span id="cb40-753"><a href="#cb40-753" aria-hidden="true" tabindex="-1"></a>    df.loc[mask_both, <span class="st">"ret_adj"</span>] <span class="op">=</span> (</span>
<span id="cb40-754"><a href="#cb40-754" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">+</span> df.loc[mask_both, ret_col]) <span class="op">*</span></span>
<span id="cb40-755"><a href="#cb40-755" aria-hidden="true" tabindex="-1"></a>        (<span class="dv">1</span> <span class="op">+</span> df.loc[mask_both, dlret_col]) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-756"><a href="#cb40-756" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-757"><a href="#cb40-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-758"><a href="#cb40-758" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Case 2: Only delisting return available</span></span>
<span id="cb40-759"><a href="#cb40-759" aria-hidden="true" tabindex="-1"></a>    mask_dlret_only <span class="op">=</span> (</span>
<span id="cb40-760"><a href="#cb40-760" aria-hidden="true" tabindex="-1"></a>        df[ret_col].isna() <span class="op">&amp;</span> df[dlret_col].notna()</span>
<span id="cb40-761"><a href="#cb40-761" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-762"><a href="#cb40-762" aria-hidden="true" tabindex="-1"></a>    df.loc[mask_dlret_only, <span class="st">"ret_adj"</span>] <span class="op">=</span> (</span>
<span id="cb40-763"><a href="#cb40-763" aria-hidden="true" tabindex="-1"></a>        df.loc[mask_dlret_only, dlret_col]</span>
<span id="cb40-764"><a href="#cb40-764" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-765"><a href="#cb40-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-766"><a href="#cb40-766" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-767"><a href="#cb40-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-768"><a href="#cb40-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-769"><a href="#cb40-769" aria-hidden="true" tabindex="-1"></a><span class="fu">### Impact of Delisting Adjustment</span></span>
<span id="cb40-770"><a href="#cb40-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-771"><a href="#cb40-771" aria-hidden="true" tabindex="-1"></a>The magnitude of the delisting bias depends on the frequency and severity of delisting events. @shumway1997delisting showed that, in developed markets, ignoring delisting returns introduces an upward bias of approximately 1% per year in equal-weighted portfolio returns. The bias is larger for small-cap stocks and value stocks, which are more prone to financial distress. In Vietnam, where smaller firms on HNX and UPCoM face tighter liquidity constraints and higher default risk, the bias may be even more pronounced. In emerging market delistings, mandatory delistings often involve firms with severe financial distress where residual equity value is near zero, implying delisting returns close to $-100\%$ in the worst cases.</span>
<span id="cb40-772"><a href="#cb40-772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-773"><a href="#cb40-773" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rolling Volatility Estimation</span></span>
<span id="cb40-774"><a href="#cb40-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-775"><a href="#cb40-775" aria-hidden="true" tabindex="-1"></a>Stock return volatility is a key input for risk management, option pricing, and many empirical asset pricing models. A common approach is to estimate rolling standard deviations of returns over a trailing window.</span>
<span id="cb40-776"><a href="#cb40-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-777"><a href="#cb40-777" aria-hidden="true" tabindex="-1"></a><span class="fu">### 24-Month Rolling Volatility</span></span>
<span id="cb40-778"><a href="#cb40-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-779"><a href="#cb40-779" aria-hidden="true" tabindex="-1"></a>Following @ben2012hedge, we compute the total stock return volatility as the rolling standard deviation of monthly returns over a 24-month window:</span>
<span id="cb40-780"><a href="#cb40-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-781"><a href="#cb40-781" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-782"><a href="#cb40-782" aria-hidden="true" tabindex="-1"></a>\hat{\sigma}_{i,t}^{24} = \sqrt{\frac{1}{23}\sum_{j=0}^{23}(R_{i,t-j} - \bar{R}_{i,t}^{24})^2},</span>
<span id="cb40-783"><a href="#cb40-783" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rolling-vol}</span>
<span id="cb40-784"><a href="#cb40-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-785"><a href="#cb40-785" aria-hidden="true" tabindex="-1"></a>where $\bar{R}_{i,t}^{24} = \frac{1}{24}\sum_{j=0}^{23} R_{i,t-j}$ is the trailing 24-month mean return.</span>
<span id="cb40-786"><a href="#cb40-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-789"><a href="#cb40-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-790"><a href="#cb40-790" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_volatility(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-791"><a href="#cb40-791" aria-hidden="true" tabindex="-1"></a>                        group_col<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb40-792"><a href="#cb40-792" aria-hidden="true" tabindex="-1"></a>                        window<span class="op">=</span><span class="dv">24</span>):</span>
<span id="cb40-793"><a href="#cb40-793" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling return volatility.</span></span>
<span id="cb40-794"><a href="#cb40-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-795"><a href="#cb40-795" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-796"><a href="#cb40-796" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-797"><a href="#cb40-797" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-798"><a href="#cb40-798" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-799"><a href="#cb40-799" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-800"><a href="#cb40-800" aria-hidden="true" tabindex="-1"></a><span class="co">    window : int</span></span>
<span id="cb40-801"><a href="#cb40-801" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling window length in periods.</span></span>
<span id="cb40-802"><a href="#cb40-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-803"><a href="#cb40-803" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-804"><a href="#cb40-804" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-805"><a href="#cb40-805" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'vol_{window}' column (annualized).</span></span>
<span id="cb40-806"><a href="#cb40-806" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-807"><a href="#cb40-807" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-808"><a href="#cb40-808" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb40-809"><a href="#cb40-809" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[ret_col]</span>
<span id="cb40-810"><a href="#cb40-810" aria-hidden="true" tabindex="-1"></a>        .transform(</span>
<span id="cb40-811"><a href="#cb40-811" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb40-812"><a href="#cb40-812" aria-hidden="true" tabindex="-1"></a>                window<span class="op">=</span>window, min_periods<span class="op">=</span>window</span>
<span id="cb40-813"><a href="#cb40-813" aria-hidden="true" tabindex="-1"></a>            ).std()</span>
<span id="cb40-814"><a href="#cb40-814" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-815"><a href="#cb40-815" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-816"><a href="#cb40-816" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualize (monthly to annual)</span></span>
<span id="cb40-817"><a href="#cb40-817" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">_ann"</span>] <span class="op">=</span> df[<span class="ss">f"vol_</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb40-818"><a href="#cb40-818" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-819"><a href="#cb40-819" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-820"><a href="#cb40-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-823"><a href="#cb40-823" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-824"><a href="#cb40-824" aria-hidden="true" tabindex="-1"></a>stock_vol <span class="op">=</span> rolling_volatility(stock_rolling)</span>
<span id="cb40-825"><a href="#cb40-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-826"><a href="#cb40-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-827"><a href="#cb40-827" aria-hidden="true" tabindex="-1"></a>@fig-vol-distribution shows the cross-sectional distribution of annualized 24-month volatility over time.</span>
<span id="cb40-828"><a href="#cb40-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-831"><a href="#cb40-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-832"><a href="#cb40-832" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-vol-distribution</span></span>
<span id="cb40-833"><a href="#cb40-833" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-sectional distribution of annualized 24-month rolling stock return volatility for Vietnamese equities. The median volatility (solid line) and interquartile range (shaded band) capture both secular trends and crisis episodes. Vietnamese stocks exhibit structurally higher volatility than developed-market peers, with the median annualized volatility typically ranging between 30% and 50%."</span></span>
<span id="cb40-834"><a href="#cb40-834" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Time series of the cross-sectional distribution of stock return volatility in Vietnam."</span></span>
<span id="cb40-835"><a href="#cb40-835" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-pos: "htbp"</span></span>
<span id="cb40-836"><a href="#cb40-836" aria-hidden="true" tabindex="-1"></a>vol_stats <span class="op">=</span> (</span>
<span id="cb40-837"><a href="#cb40-837" aria-hidden="true" tabindex="-1"></a>    stock_vol</span>
<span id="cb40-838"><a href="#cb40-838" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"vol_24_ann"</span>])</span>
<span id="cb40-839"><a href="#cb40-839" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"vol_24_ann"</span>]</span>
<span id="cb40-840"><a href="#cb40-840" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>),</span>
<span id="cb40-841"><a href="#cb40-841" aria-hidden="true" tabindex="-1"></a>           <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb40-842"><a href="#cb40-842" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-843"><a href="#cb40-843" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-844"><a href="#cb40-844" aria-hidden="true" tabindex="-1"></a>vol_stats.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"median"</span>, <span class="st">"p25"</span>, <span class="st">"p75"</span>]</span>
<span id="cb40-845"><a href="#cb40-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-846"><a href="#cb40-846" aria-hidden="true" tabindex="-1"></a>plot_vol <span class="op">=</span> (</span>
<span id="cb40-847"><a href="#cb40-847" aria-hidden="true" tabindex="-1"></a>    ggplot(vol_stats, aes(x<span class="op">=</span><span class="st">"date"</span>)) <span class="op">+</span></span>
<span id="cb40-848"><a href="#cb40-848" aria-hidden="true" tabindex="-1"></a>    geom_ribbon(aes(ymin<span class="op">=</span><span class="st">"p25"</span>, ymax<span class="op">=</span><span class="st">"p75"</span>),</span>
<span id="cb40-849"><a href="#cb40-849" aria-hidden="true" tabindex="-1"></a>                alpha<span class="op">=</span><span class="fl">0.3</span>, fill<span class="op">=</span><span class="st">"#b2182b"</span>) <span class="op">+</span></span>
<span id="cb40-850"><a href="#cb40-850" aria-hidden="true" tabindex="-1"></a>    geom_line(aes(y<span class="op">=</span><span class="st">"median"</span>), color<span class="op">=</span><span class="st">"#b2182b"</span>, size<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb40-851"><a href="#cb40-851" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Annualized 24-month volatility"</span>) <span class="op">+</span></span>
<span id="cb40-852"><a href="#cb40-852" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb40-853"><a href="#cb40-853" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-854"><a href="#cb40-854" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb40-855"><a href="#cb40-855" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-856"><a href="#cb40-856" aria-hidden="true" tabindex="-1"></a>plot_vol.draw()</span>
<span id="cb40-857"><a href="#cb40-857" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-858"><a href="#cb40-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-859"><a href="#cb40-859" aria-hidden="true" tabindex="-1"></a><span class="fu">### Volatility and Compound Returns: The Variance Drain</span></span>
<span id="cb40-860"><a href="#cb40-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-861"><a href="#cb40-861" aria-hidden="true" tabindex="-1"></a>As noted in @eq-arithmetic-geometric, the geometric mean return falls below the arithmetic mean by approximately $\sigma^2/2$. This "variance drain" or "volatility drag" means that two portfolios with the same arithmetic mean return but different volatilities will have different compound returns: the lower-volatility portfolio will compound to greater terminal wealth.</span>
<span id="cb40-862"><a href="#cb40-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-863"><a href="#cb40-863" aria-hidden="true" tabindex="-1"></a>This effect is quantitatively important in Vietnam. A stock with an arithmetic mean monthly return of 1.5% and a monthly standard deviation of 10% suffers a volatility drag of approximately $0.10^2/2 = 0.5\%$ per month, or roughly 6% per year. This is consistent with the observation that Vietnamese investors face substantial erosion of compound wealth from the high idiosyncratic volatility of individual stocks. We can verify this empirically by sorting stocks into volatility quintiles and comparing compound returns:</span>
<span id="cb40-864"><a href="#cb40-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-867"><a href="#cb40-867" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-868"><a href="#cb40-868" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-vol-drag</span></span>
<span id="cb40-869"><a href="#cb40-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Arithmetic mean, geometric mean, and volatility by volatility quintile for Vietnamese stocks. The difference between arithmetic and geometric mean increases with volatility, confirming the variance drain effect. The magnitude of the drag is notably large for the highest-volatility quintile, typical of small and illiquid stocks on HNX and UPCoM."</span></span>
<span id="cb40-870"><a href="#cb40-870" aria-hidden="true" tabindex="-1"></a>annual_data <span class="op">=</span> compound_return_by_period(</span>
<span id="cb40-871"><a href="#cb40-871" aria-hidden="true" tabindex="-1"></a>    prices_monthly, period<span class="op">=</span><span class="st">"year"</span></span>
<span id="cb40-872"><a href="#cb40-872" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-873"><a href="#cb40-873" aria-hidden="true" tabindex="-1"></a>annual_data <span class="op">=</span> annual_data[annual_data[<span class="st">"n_obs"</span>] <span class="op">&gt;=</span> <span class="dv">10</span>].copy()</span>
<span id="cb40-874"><a href="#cb40-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-875"><a href="#cb40-875" aria-hidden="true" tabindex="-1"></a>vol_annual <span class="op">=</span> (</span>
<span id="cb40-876"><a href="#cb40-876" aria-hidden="true" tabindex="-1"></a>    prices_monthly</span>
<span id="cb40-877"><a href="#cb40-877" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, prices_monthly[<span class="st">"date"</span>].dt.year])[</span>
<span id="cb40-878"><a href="#cb40-878" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ret_total"</span></span>
<span id="cb40-879"><a href="#cb40-879" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-880"><a href="#cb40-880" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"std"</span>, <span class="st">"mean"</span>, <span class="st">"count"</span>])</span>
<span id="cb40-881"><a href="#cb40-881" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-882"><a href="#cb40-882" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-883"><a href="#cb40-883" aria-hidden="true" tabindex="-1"></a>vol_annual.columns <span class="op">=</span> [<span class="st">"symbol"</span>, <span class="st">"period"</span>, <span class="st">"monthly_std"</span>,</span>
<span id="cb40-884"><a href="#cb40-884" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"monthly_mean"</span>, <span class="st">"n_months"</span>]</span>
<span id="cb40-885"><a href="#cb40-885" aria-hidden="true" tabindex="-1"></a>vol_annual <span class="op">=</span> vol_annual[vol_annual[<span class="st">"n_months"</span>] <span class="op">&gt;=</span> <span class="dv">10</span>].copy()</span>
<span id="cb40-886"><a href="#cb40-886" aria-hidden="true" tabindex="-1"></a>vol_annual[<span class="st">"ann_vol"</span>] <span class="op">=</span> vol_annual[<span class="st">"monthly_std"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb40-887"><a href="#cb40-887" aria-hidden="true" tabindex="-1"></a>vol_annual[<span class="st">"arith_mean_ann"</span>] <span class="op">=</span> vol_annual[<span class="st">"monthly_mean"</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb40-888"><a href="#cb40-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-889"><a href="#cb40-889" aria-hidden="true" tabindex="-1"></a>vol_analysis <span class="op">=</span> annual_data.merge(</span>
<span id="cb40-890"><a href="#cb40-890" aria-hidden="true" tabindex="-1"></a>    vol_annual, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"period"</span>]</span>
<span id="cb40-891"><a href="#cb40-891" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-892"><a href="#cb40-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-893"><a href="#cb40-893" aria-hidden="true" tabindex="-1"></a>vol_analysis[<span class="st">"vol_quintile"</span>] <span class="op">=</span> (</span>
<span id="cb40-894"><a href="#cb40-894" aria-hidden="true" tabindex="-1"></a>    vol_analysis.groupby(<span class="st">"period"</span>)[<span class="st">"ann_vol"</span>]</span>
<span id="cb40-895"><a href="#cb40-895" aria-hidden="true" tabindex="-1"></a>    .transform(</span>
<span id="cb40-896"><a href="#cb40-896" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb40-897"><a href="#cb40-897" aria-hidden="true" tabindex="-1"></a>            x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb40-898"><a href="#cb40-898" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-899"><a href="#cb40-899" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-900"><a href="#cb40-900" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-901"><a href="#cb40-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-902"><a href="#cb40-902" aria-hidden="true" tabindex="-1"></a>vol_summary <span class="op">=</span> (</span>
<span id="cb40-903"><a href="#cb40-903" aria-hidden="true" tabindex="-1"></a>    vol_analysis</span>
<span id="cb40-904"><a href="#cb40-904" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"vol_quintile"</span>)</span>
<span id="cb40-905"><a href="#cb40-905" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb40-906"><a href="#cb40-906" aria-hidden="true" tabindex="-1"></a>        arithmetic_mean<span class="op">=</span>(<span class="st">"arith_mean_ann"</span>, <span class="st">"mean"</span>),</span>
<span id="cb40-907"><a href="#cb40-907" aria-hidden="true" tabindex="-1"></a>        geometric_mean<span class="op">=</span>(<span class="st">"cumret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb40-908"><a href="#cb40-908" aria-hidden="true" tabindex="-1"></a>        avg_volatility<span class="op">=</span>(<span class="st">"ann_vol"</span>, <span class="st">"mean"</span>),</span>
<span id="cb40-909"><a href="#cb40-909" aria-hidden="true" tabindex="-1"></a>        n_stockyears<span class="op">=</span>(<span class="st">"cumret"</span>, <span class="st">"count"</span>)</span>
<span id="cb40-910"><a href="#cb40-910" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-911"><a href="#cb40-911" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb40-912"><a href="#cb40-912" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb40-913"><a href="#cb40-913" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-914"><a href="#cb40-914" aria-hidden="true" tabindex="-1"></a>vol_summary</span>
<span id="cb40-915"><a href="#cb40-915" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-916"><a href="#cb40-916" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-917"><a href="#cb40-917" aria-hidden="true" tabindex="-1"></a><span class="fu">## Compound Returns Around Fiscal Year Ends</span></span>
<span id="cb40-918"><a href="#cb40-918" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-919"><a href="#cb40-919" aria-hidden="true" tabindex="-1"></a>A widely used approach in accounting and finance research aligns compound returns to firm-specific fiscal period end dates. This is essential for computing buy-and-hold abnormal returns (BHARs) for event studies, post-earnings-announcement drift, and other studies where the event date varies by firm.</span>
<span id="cb40-920"><a href="#cb40-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-921"><a href="#cb40-921" aria-hidden="true" tabindex="-1"></a>In Vietnam, the majority of listed firms follow a calendar fiscal year (January‚ÄìDecember), as required by the Law on Accounting unless the Ministry of Finance grants an exemption. However, firms in certain industries (e.g., agriculture, tourism) may use non-standard fiscal years ending in March, June, or September.</span>
<span id="cb40-922"><a href="#cb40-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-923"><a href="#cb40-923" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!--# The DataCore.vn financial statements database records the firm-specific fiscal year end for each firm-year. --&gt;</span></span>
<span id="cb40-924"><a href="#cb40-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-925"><a href="#cb40-925" aria-hidden="true" tabindex="-1"></a><span class="fu">### Aligning Returns to Fiscal Periods</span></span>
<span id="cb40-926"><a href="#cb40-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-927"><a href="#cb40-927" aria-hidden="true" tabindex="-1"></a>The key challenge is that fiscal year ends differ across firms. We need to compute compound returns over windows anchored at these firm-specific dates.</span>
<span id="cb40-928"><a href="#cb40-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-931"><a href="#cb40-931" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-932"><a href="#cb40-932" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compound_returns_around_event(</span>
<span id="cb40-933"><a href="#cb40-933" aria-hidden="true" tabindex="-1"></a>    returns_df, events_df,</span>
<span id="cb40-934"><a href="#cb40-934" aria-hidden="true" tabindex="-1"></a>    id_col<span class="op">=</span><span class="st">"symbol"</span>, date_col<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb40-935"><a href="#cb40-935" aria-hidden="true" tabindex="-1"></a>    event_date_col<span class="op">=</span><span class="st">"datadate"</span>, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-936"><a href="#cb40-936" aria-hidden="true" tabindex="-1"></a>    pre_windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>],</span>
<span id="cb40-937"><a href="#cb40-937" aria-hidden="true" tabindex="-1"></a>    post_windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>]</span>
<span id="cb40-938"><a href="#cb40-938" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb40-939"><a href="#cb40-939" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute compound returns in windows around firm-specific</span></span>
<span id="cb40-940"><a href="#cb40-940" aria-hidden="true" tabindex="-1"></a><span class="co">    event dates.</span></span>
<span id="cb40-941"><a href="#cb40-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-942"><a href="#cb40-942" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-943"><a href="#cb40-943" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-944"><a href="#cb40-944" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : pd.DataFrame</span></span>
<span id="cb40-945"><a href="#cb40-945" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns with [id_col, date_col, ret_col].</span></span>
<span id="cb40-946"><a href="#cb40-946" aria-hidden="true" tabindex="-1"></a><span class="co">    events_df : pd.DataFrame</span></span>
<span id="cb40-947"><a href="#cb40-947" aria-hidden="true" tabindex="-1"></a><span class="co">        Event dates with [id_col, event_date_col].</span></span>
<span id="cb40-948"><a href="#cb40-948" aria-hidden="true" tabindex="-1"></a><span class="co">    pre_windows : list of int</span></span>
<span id="cb40-949"><a href="#cb40-949" aria-hidden="true" tabindex="-1"></a><span class="co">        Trailing window lengths (months before event).</span></span>
<span id="cb40-950"><a href="#cb40-950" aria-hidden="true" tabindex="-1"></a><span class="co">    post_windows : list of int</span></span>
<span id="cb40-951"><a href="#cb40-951" aria-hidden="true" tabindex="-1"></a><span class="co">        Forward window lengths (months after event).</span></span>
<span id="cb40-952"><a href="#cb40-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-953"><a href="#cb40-953" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-954"><a href="#cb40-954" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-955"><a href="#cb40-955" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with compound returns for each window.</span></span>
<span id="cb40-956"><a href="#cb40-956" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-957"><a href="#cb40-957" aria-hidden="true" tabindex="-1"></a>    returns_df <span class="op">=</span> returns_df.sort_values(</span>
<span id="cb40-958"><a href="#cb40-958" aria-hidden="true" tabindex="-1"></a>        [id_col, date_col]</span>
<span id="cb40-959"><a href="#cb40-959" aria-hidden="true" tabindex="-1"></a>    ).copy()</span>
<span id="cb40-960"><a href="#cb40-960" aria-hidden="true" tabindex="-1"></a>    events_df <span class="op">=</span> events_df.copy()</span>
<span id="cb40-961"><a href="#cb40-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-962"><a href="#cb40-962" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align event dates to month ends</span></span>
<span id="cb40-963"><a href="#cb40-963" aria-hidden="true" tabindex="-1"></a>    events_df[<span class="st">"event_month"</span>] <span class="op">=</span> (</span>
<span id="cb40-964"><a href="#cb40-964" aria-hidden="true" tabindex="-1"></a>        pd.to_datetime(events_df[event_date_col])</span>
<span id="cb40-965"><a href="#cb40-965" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb40-966"><a href="#cb40-966" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-967"><a href="#cb40-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-968"><a href="#cb40-968" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb40-969"><a href="#cb40-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-970"><a href="#cb40-970" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> events_df.iterrows():</span>
<span id="cb40-971"><a href="#cb40-971" aria-hidden="true" tabindex="-1"></a>        sid <span class="op">=</span> event[id_col]</span>
<span id="cb40-972"><a href="#cb40-972" aria-hidden="true" tabindex="-1"></a>        edate <span class="op">=</span> event[<span class="st">"event_month"</span>]</span>
<span id="cb40-973"><a href="#cb40-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-974"><a href="#cb40-974" aria-hidden="true" tabindex="-1"></a>        sec_rets <span class="op">=</span> returns_df[</span>
<span id="cb40-975"><a href="#cb40-975" aria-hidden="true" tabindex="-1"></a>            returns_df[id_col] <span class="op">==</span> sid</span>
<span id="cb40-976"><a href="#cb40-976" aria-hidden="true" tabindex="-1"></a>        ].copy()</span>
<span id="cb40-977"><a href="#cb40-977" aria-hidden="true" tabindex="-1"></a>        sec_rets <span class="op">=</span> sec_rets.set_index(date_col)[ret_col]</span>
<span id="cb40-978"><a href="#cb40-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-979"><a href="#cb40-979" aria-hidden="true" tabindex="-1"></a>        row <span class="op">=</span> {id_col: sid,</span>
<span id="cb40-980"><a href="#cb40-980" aria-hidden="true" tabindex="-1"></a>               event_date_col: event[event_date_col]}</span>
<span id="cb40-981"><a href="#cb40-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-982"><a href="#cb40-982" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-event compound returns</span></span>
<span id="cb40-983"><a href="#cb40-983" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> pre_windows:</span>
<span id="cb40-984"><a href="#cb40-984" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> edate <span class="op">-</span> pd.DateOffset(months<span class="op">=</span>k<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb40-985"><a href="#cb40-985" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> (start <span class="op">-</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb40-986"><a href="#cb40-986" aria-hidden="true" tabindex="-1"></a>                     <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>))</span>
<span id="cb40-987"><a href="#cb40-987" aria-hidden="true" tabindex="-1"></a>            window_rets <span class="op">=</span> sec_rets[</span>
<span id="cb40-988"><a href="#cb40-988" aria-hidden="true" tabindex="-1"></a>                (sec_rets.index <span class="op">&gt;=</span> start)</span>
<span id="cb40-989"><a href="#cb40-989" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span> (sec_rets.index <span class="op">&lt;=</span> edate)</span>
<span id="cb40-990"><a href="#cb40-990" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb40-991"><a href="#cb40-991" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(window_rets) <span class="op">&gt;=</span> k <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb40-992"><a href="#cb40-992" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> (</span>
<span id="cb40-993"><a href="#cb40-993" aria-hidden="true" tabindex="-1"></a>                    np.exp(np.log(<span class="dv">1</span> <span class="op">+</span> window_rets).<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-994"><a href="#cb40-994" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb40-995"><a href="#cb40-995" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb40-996"><a href="#cb40-996" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> np.nan</span>
<span id="cb40-997"><a href="#cb40-997" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f"ret_pre_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> cumret</span>
<span id="cb40-998"><a href="#cb40-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-999"><a href="#cb40-999" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-event compound returns</span></span>
<span id="cb40-1000"><a href="#cb40-1000" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> k <span class="kw">in</span> post_windows:</span>
<span id="cb40-1001"><a href="#cb40-1001" aria-hidden="true" tabindex="-1"></a>            start <span class="op">=</span> edate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb40-1002"><a href="#cb40-1002" aria-hidden="true" tabindex="-1"></a>            end <span class="op">=</span> (edate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>k)</span>
<span id="cb40-1003"><a href="#cb40-1003" aria-hidden="true" tabindex="-1"></a>                   <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>))</span>
<span id="cb40-1004"><a href="#cb40-1004" aria-hidden="true" tabindex="-1"></a>            window_rets <span class="op">=</span> sec_rets[</span>
<span id="cb40-1005"><a href="#cb40-1005" aria-hidden="true" tabindex="-1"></a>                (sec_rets.index <span class="op">&gt;=</span> start)</span>
<span id="cb40-1006"><a href="#cb40-1006" aria-hidden="true" tabindex="-1"></a>                <span class="op">&amp;</span> (sec_rets.index <span class="op">&lt;=</span> end)</span>
<span id="cb40-1007"><a href="#cb40-1007" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb40-1008"><a href="#cb40-1008" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(window_rets) <span class="op">&gt;=</span> k <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb40-1009"><a href="#cb40-1009" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> (</span>
<span id="cb40-1010"><a href="#cb40-1010" aria-hidden="true" tabindex="-1"></a>                    np.exp(np.log(<span class="dv">1</span> <span class="op">+</span> window_rets).<span class="bu">sum</span>()) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1011"><a href="#cb40-1011" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb40-1012"><a href="#cb40-1012" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb40-1013"><a href="#cb40-1013" aria-hidden="true" tabindex="-1"></a>                cumret <span class="op">=</span> np.nan</span>
<span id="cb40-1014"><a href="#cb40-1014" aria-hidden="true" tabindex="-1"></a>            row[<span class="ss">f"ret_post_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> cumret</span>
<span id="cb40-1015"><a href="#cb40-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1016"><a href="#cb40-1016" aria-hidden="true" tabindex="-1"></a>        results.append(row)</span>
<span id="cb40-1017"><a href="#cb40-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1018"><a href="#cb40-1018" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb40-1019"><a href="#cb40-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1020"><a href="#cb40-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1021"><a href="#cb40-1021" aria-hidden="true" tabindex="-1"></a><span class="fu">### Buy-and-Hold Abnormal Returns versus Cumulative Abnormal Returns</span></span>
<span id="cb40-1022"><a href="#cb40-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1023"><a href="#cb40-1023" aria-hidden="true" tabindex="-1"></a>For event studies and performance evaluation, we often want the **excess** compound return, which is the stock's compound return minus a benchmark's compound return over the same window. The buy-and-hold abnormal return (BHAR) is defined as</span>
<span id="cb40-1024"><a href="#cb40-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1025"><a href="#cb40-1025" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-1026"><a href="#cb40-1026" aria-hidden="true" tabindex="-1"></a>\text{BHAR}_{i,t}(k) = \prod_{j=1}^{k}(1 + R_{i,t+j}) - \prod_{j=1}^{k}(1 + R_{b,t+j}),</span>
<span id="cb40-1027"><a href="#cb40-1027" aria-hidden="true" tabindex="-1"></a>$$ {#eq-bhar}</span>
<span id="cb40-1028"><a href="#cb40-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1029"><a href="#cb40-1029" aria-hidden="true" tabindex="-1"></a>where $R_{b,t}$ is the benchmark return (market index, size-matched portfolio, etc.). This differs from the cumulative abnormal return (CAR), which sums simple abnormal returns:</span>
<span id="cb40-1030"><a href="#cb40-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1031"><a href="#cb40-1031" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-1032"><a href="#cb40-1032" aria-hidden="true" tabindex="-1"></a>\text{CAR}_{i,t}(k) = \sum_{j=1}^{k}(R_{i,t+j} - R_{b,t+j}).</span>
<span id="cb40-1033"><a href="#cb40-1033" aria-hidden="true" tabindex="-1"></a>$$ {#eq-car}</span>
<span id="cb40-1034"><a href="#cb40-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1035"><a href="#cb40-1035" aria-hidden="true" tabindex="-1"></a>The BHAR better captures the actual investor experience because it reflects the compounding of returns, whereas the CAR implicitly assumes daily rebalancing to maintain equal dollar positions in the stock and benchmark <span class="co">[</span><span class="ot">@barber1997detecting</span><span class="co">]</span>. The distinction is particularly important in Vietnam, where individual stock returns can be highly volatile and the compounding effect is therefore magnified. @lyon1999improved provide further analysis of the statistical properties of BHARs and recommend bootstrapped critical values for inference.</span>
<span id="cb40-1036"><a href="#cb40-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1039"><a href="#cb40-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1040"><a href="#cb40-1040" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_bhar(stock_returns, benchmark_returns):</span>
<span id="cb40-1041"><a href="#cb40-1041" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute buy-and-hold abnormal return.</span></span>
<span id="cb40-1042"><a href="#cb40-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1043"><a href="#cb40-1043" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-1044"><a href="#cb40-1044" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-1045"><a href="#cb40-1045" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_returns : array-like</span></span>
<span id="cb40-1046"><a href="#cb40-1046" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of stock returns.</span></span>
<span id="cb40-1047"><a href="#cb40-1047" aria-hidden="true" tabindex="-1"></a><span class="co">    benchmark_returns : array-like</span></span>
<span id="cb40-1048"><a href="#cb40-1048" aria-hidden="true" tabindex="-1"></a><span class="co">        Sequence of benchmark returns (same length).</span></span>
<span id="cb40-1049"><a href="#cb40-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1050"><a href="#cb40-1050" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-1051"><a href="#cb40-1051" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-1052"><a href="#cb40-1052" aria-hidden="true" tabindex="-1"></a><span class="co">    float : BHAR</span></span>
<span id="cb40-1053"><a href="#cb40-1053" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-1054"><a href="#cb40-1054" aria-hidden="true" tabindex="-1"></a>    stock_cumret <span class="op">=</span> (</span>
<span id="cb40-1055"><a href="#cb40-1055" aria-hidden="true" tabindex="-1"></a>        np.prod(<span class="dv">1</span> <span class="op">+</span> np.array(stock_returns)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1056"><a href="#cb40-1056" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1057"><a href="#cb40-1057" aria-hidden="true" tabindex="-1"></a>    bench_cumret <span class="op">=</span> (</span>
<span id="cb40-1058"><a href="#cb40-1058" aria-hidden="true" tabindex="-1"></a>        np.prod(<span class="dv">1</span> <span class="op">+</span> np.array(benchmark_returns)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1059"><a href="#cb40-1059" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1060"><a href="#cb40-1060" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stock_cumret <span class="op">-</span> bench_cumret</span>
<span id="cb40-1061"><a href="#cb40-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1062"><a href="#cb40-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1063"><a href="#cb40-1063" aria-hidden="true" tabindex="-1"></a><span class="fu">## Book Value of Equity</span></span>
<span id="cb40-1064"><a href="#cb40-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1065"><a href="#cb40-1065" aria-hidden="true" tabindex="-1"></a>Many empirical applications that use compound returns also require firm-level accounting variables. A commonly used variable is the book value of equity, computed following @daniel1997evidence:</span>
<span id="cb40-1066"><a href="#cb40-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1067"><a href="#cb40-1067" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb40-1068"><a href="#cb40-1068" aria-hidden="true" tabindex="-1"></a>\text{BE} = \text{SE} + \text{DT} + \text{ITC} - \text{PS},</span>
<span id="cb40-1069"><a href="#cb40-1069" aria-hidden="true" tabindex="-1"></a>$$ {#eq-book-equity}</span>
<span id="cb40-1070"><a href="#cb40-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1071"><a href="#cb40-1071" aria-hidden="true" tabindex="-1"></a>where SE is stockholders' equity, DT is deferred taxes, ITC is investment tax credit, and PS is the preferred stock value. For preferred stock, the hierarchy is: redemption value if available, then liquidating value, then carrying value.</span>
<span id="cb40-1072"><a href="#cb40-1072" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1073"><a href="#cb40-1073" aria-hidden="true" tabindex="-1"></a>In Vietnam, the accounting standards (Vietnamese Accounting Standards, VAS, and increasingly IFRS adoption) provide a somewhat different chart of accounts. Stockholders' equity is reported on the balance sheet as *V·ªën ch·ªß s·ªü h·ªØu*, which includes contributed capital (*V·ªën g√≥p c·ªßa ch·ªß s·ªü h·ªØu*), share premium (*Th·∫∑ng d∆∞ v·ªën c·ªï ph·∫ßn*), treasury stock adjustments, retained earnings (*L·ª£i nhu·∫≠n sau thu·∫ø ch∆∞a ph√¢n ph·ªëi*), and other reserves. Deferred tax assets and liabilities are reported separately. Preferred stock is rare among Vietnamese listed firms (most issue only common shares), but when present, its book value should be subtracted from total equity.</span>
<span id="cb40-1074"><a href="#cb40-1074" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1077"><a href="#cb40-1077" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1078"><a href="#cb40-1078" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_book_equity(df):</span>
<span id="cb40-1079"><a href="#cb40-1079" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute book value of equity for Vietnamese firms.</span></span>
<span id="cb40-1080"><a href="#cb40-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1081"><a href="#cb40-1081" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-1082"><a href="#cb40-1082" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-1083"><a href="#cb40-1083" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-1084"><a href="#cb40-1084" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain at minimum: equity (stockholders' equity),</span></span>
<span id="cb40-1085"><a href="#cb40-1085" aria-hidden="true" tabindex="-1"></a><span class="co">        deferred_tax (deferred tax liabilities, net),</span></span>
<span id="cb40-1086"><a href="#cb40-1086" aria-hidden="true" tabindex="-1"></a><span class="co">        pref_stock (preferred stock, if applicable).</span></span>
<span id="cb40-1087"><a href="#cb40-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1088"><a href="#cb40-1088" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-1089"><a href="#cb40-1089" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-1090"><a href="#cb40-1090" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'be' column.</span></span>
<span id="cb40-1091"><a href="#cb40-1091" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-1092"><a href="#cb40-1092" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb40-1093"><a href="#cb40-1093" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pref"</span>] <span class="op">=</span> df.get(</span>
<span id="cb40-1094"><a href="#cb40-1094" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pref_stock"</span>, pd.Series(<span class="dv">0</span>, index<span class="op">=</span>df.index)</span>
<span id="cb40-1095"><a href="#cb40-1095" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1096"><a href="#cb40-1096" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"dt"</span>] <span class="op">=</span> df.get(</span>
<span id="cb40-1097"><a href="#cb40-1097" aria-hidden="true" tabindex="-1"></a>        <span class="st">"deferred_tax"</span>, pd.Series(<span class="dv">0</span>, index<span class="op">=</span>df.index)</span>
<span id="cb40-1098"><a href="#cb40-1098" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1099"><a href="#cb40-1099" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> (</span>
<span id="cb40-1100"><a href="#cb40-1100" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"equity"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb40-1101"><a href="#cb40-1101" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> df[<span class="st">"dt"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb40-1102"><a href="#cb40-1102" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"pref"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb40-1103"><a href="#cb40-1103" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1104"><a href="#cb40-1104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set non-positive book equity to NaN</span></span>
<span id="cb40-1105"><a href="#cb40-1105" aria-hidden="true" tabindex="-1"></a>    df.loc[df[<span class="st">"be"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">"be"</span>] <span class="op">=</span> np.nan</span>
<span id="cb40-1106"><a href="#cb40-1106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-1107"><a href="#cb40-1107" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1108"><a href="#cb40-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1109"><a href="#cb40-1109" aria-hidden="true" tabindex="-1"></a><span class="fu">## Maximum Drawdown</span></span>
<span id="cb40-1110"><a href="#cb40-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1111"><a href="#cb40-1111" aria-hidden="true" tabindex="-1"></a>The maximum drawdown is a key risk metric that complements volatility. While volatility measures the dispersion of returns symmetrically, the maximum drawdown captures the worst cumulative loss an investor could experience: a measure that aligns more closely with how investors psychologically experience risk <span class="co">[</span><span class="ot">@kahneman2013prospect</span><span class="co">]</span>.</span>
<span id="cb40-1112"><a href="#cb40-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1115"><a href="#cb40-1115" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1116"><a href="#cb40-1116" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_max_drawdown(df, ret_col<span class="op">=</span><span class="st">"ret_total"</span>,</span>
<span id="cb40-1117"><a href="#cb40-1117" aria-hidden="true" tabindex="-1"></a>                          group_col<span class="op">=</span><span class="st">"symbol"</span>):</span>
<span id="cb40-1118"><a href="#cb40-1118" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute maximum drawdown for each security.</span></span>
<span id="cb40-1119"><a href="#cb40-1119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1120"><a href="#cb40-1120" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-1121"><a href="#cb40-1121" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-1122"><a href="#cb40-1122" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb40-1123"><a href="#cb40-1123" aria-hidden="true" tabindex="-1"></a><span class="co">    ret_col : str</span></span>
<span id="cb40-1124"><a href="#cb40-1124" aria-hidden="true" tabindex="-1"></a><span class="co">    group_col : str</span></span>
<span id="cb40-1125"><a href="#cb40-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1126"><a href="#cb40-1126" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-1127"><a href="#cb40-1127" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-1128"><a href="#cb40-1128" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame with 'max_drawdown' and running drawdown.</span></span>
<span id="cb40-1129"><a href="#cb40-1129" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-1130"><a href="#cb40-1130" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([group_col, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-1131"><a href="#cb40-1131" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[ret_col]</span>
<span id="cb40-1132"><a href="#cb40-1132" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth"</span>] <span class="op">=</span> (</span>
<span id="cb40-1133"><a href="#cb40-1133" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"gross_ret"</span>].cumprod()</span>
<span id="cb40-1134"><a href="#cb40-1134" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1135"><a href="#cb40-1135" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"peak"</span>] <span class="op">=</span> df.groupby(group_col)[<span class="st">"wealth"</span>].cummax()</span>
<span id="cb40-1136"><a href="#cb40-1136" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"drawdown"</span>] <span class="op">=</span> (</span>
<span id="cb40-1137"><a href="#cb40-1137" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">"wealth"</span>] <span class="op">-</span> df[<span class="st">"peak"</span>]) <span class="op">/</span> df[<span class="st">"peak"</span>]</span>
<span id="cb40-1138"><a href="#cb40-1138" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1139"><a href="#cb40-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1140"><a href="#cb40-1140" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> (</span>
<span id="cb40-1141"><a href="#cb40-1141" aria-hidden="true" tabindex="-1"></a>        df.groupby(group_col)[<span class="st">"drawdown"</span>]</span>
<span id="cb40-1142"><a href="#cb40-1142" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">min</span>()</span>
<span id="cb40-1143"><a href="#cb40-1143" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"max_drawdown"</span>)</span>
<span id="cb40-1144"><a href="#cb40-1144" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1145"><a href="#cb40-1145" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(max_dd, on<span class="op">=</span>group_col)</span>
<span id="cb40-1146"><a href="#cb40-1146" aria-hidden="true" tabindex="-1"></a>    df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>], inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-1147"><a href="#cb40-1147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-1148"><a href="#cb40-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1149"><a href="#cb40-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1150"><a href="#cb40-1150" aria-hidden="true" tabindex="-1"></a>@fig-drawdown illustrates the drawdown profile for a selected stock.</span>
<span id="cb40-1151"><a href="#cb40-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1154"><a href="#cb40-1154" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1155"><a href="#cb40-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-drawdown</span></span>
<span id="cb40-1156"><a href="#cb40-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Drawdown profile for a selected Vietnamese stock showing the percentage decline from each running peak. The maximum drawdown (horizontal dashed line) represents the worst peak-to-trough loss over the full sample. Vietnamese stocks frequently exhibit drawdowns exceeding 50%, reflecting the market's high volatility and susceptibility to sentiment-driven corrections."</span></span>
<span id="cb40-1157"><a href="#cb40-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Time series chart of drawdowns for a single Vietnamese stock."</span></span>
<span id="cb40-1158"><a href="#cb40-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-pos: "htbp"</span></span>
<span id="cb40-1159"><a href="#cb40-1159" aria-hidden="true" tabindex="-1"></a>dd_data <span class="op">=</span> compute_max_drawdown(</span>
<span id="cb40-1160"><a href="#cb40-1160" aria-hidden="true" tabindex="-1"></a>    prices_monthly[</span>
<span id="cb40-1161"><a href="#cb40-1161" aria-hidden="true" tabindex="-1"></a>        prices_monthly[<span class="st">"symbol"</span>] <span class="op">==</span> long_history_stocks[<span class="dv">0</span>]</span>
<span id="cb40-1162"><a href="#cb40-1162" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-1163"><a href="#cb40-1163" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1164"><a href="#cb40-1164" aria-hidden="true" tabindex="-1"></a>mdd <span class="op">=</span> dd_data[<span class="st">"max_drawdown"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb40-1165"><a href="#cb40-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1166"><a href="#cb40-1166" aria-hidden="true" tabindex="-1"></a>plot_dd <span class="op">=</span> (</span>
<span id="cb40-1167"><a href="#cb40-1167" aria-hidden="true" tabindex="-1"></a>    ggplot(dd_data, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"drawdown"</span>)) <span class="op">+</span></span>
<span id="cb40-1168"><a href="#cb40-1168" aria-hidden="true" tabindex="-1"></a>    geom_area(fill<span class="op">=</span><span class="st">"#b2182b"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb40-1169"><a href="#cb40-1169" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#b2182b"</span>, size<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb40-1170"><a href="#cb40-1170" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span>mdd, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb40-1171"><a href="#cb40-1171" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Drawdown from peak"</span>) <span class="op">+</span></span>
<span id="cb40-1172"><a href="#cb40-1172" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb40-1173"><a href="#cb40-1173" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-1174"><a href="#cb40-1174" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb40-1175"><a href="#cb40-1175" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1176"><a href="#cb40-1176" aria-hidden="true" tabindex="-1"></a>plot_dd.draw()</span>
<span id="cb40-1177"><a href="#cb40-1177" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1178"><a href="#cb40-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1179"><a href="#cb40-1179" aria-hidden="true" tabindex="-1"></a><span class="fu">## Putting It All Together: A Comprehensive Pipeline</span></span>
<span id="cb40-1180"><a href="#cb40-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1181"><a href="#cb40-1181" aria-hidden="true" tabindex="-1"></a>We now combine all the methods into a single pipeline that produces a research-ready dataset with rolling compound returns, market returns, volatility, and drawdown measures.</span>
<span id="cb40-1182"><a href="#cb40-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1185"><a href="#cb40-1185" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1186"><a href="#cb40-1186" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_compound_return_dataset(</span>
<span id="cb40-1187"><a href="#cb40-1187" aria-hidden="true" tabindex="-1"></a>    stock_df, windows<span class="op">=</span>[<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>], vol_window<span class="op">=</span><span class="dv">24</span></span>
<span id="cb40-1188"><a href="#cb40-1188" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb40-1189"><a href="#cb40-1189" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Build comprehensive compound return dataset.</span></span>
<span id="cb40-1190"><a href="#cb40-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1191"><a href="#cb40-1191" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb40-1192"><a href="#cb40-1192" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb40-1193"><a href="#cb40-1193" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_df : pd.DataFrame</span></span>
<span id="cb40-1194"><a href="#cb40-1194" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly stock return data with columns:</span></span>
<span id="cb40-1195"><a href="#cb40-1195" aria-hidden="true" tabindex="-1"></a><span class="co">        symbol, date, ret_total, mkt_total.</span></span>
<span id="cb40-1196"><a href="#cb40-1196" aria-hidden="true" tabindex="-1"></a><span class="co">    windows : list of int</span></span>
<span id="cb40-1197"><a href="#cb40-1197" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling compound return windows.</span></span>
<span id="cb40-1198"><a href="#cb40-1198" aria-hidden="true" tabindex="-1"></a><span class="co">    vol_window : int</span></span>
<span id="cb40-1199"><a href="#cb40-1199" aria-hidden="true" tabindex="-1"></a><span class="co">        Rolling volatility window.</span></span>
<span id="cb40-1200"><a href="#cb40-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1201"><a href="#cb40-1201" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb40-1202"><a href="#cb40-1202" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb40-1203"><a href="#cb40-1203" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb40-1204"><a href="#cb40-1204" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb40-1205"><a href="#cb40-1205" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> stock_df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb40-1206"><a href="#cb40-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1207"><a href="#cb40-1207" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Log returns</span></span>
<span id="cb40-1208"><a href="#cb40-1208" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_ret"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret_total"</span>])</span>
<span id="cb40-1209"><a href="#cb40-1209" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"log_mkt"</span>] <span class="op">=</span> np.log(<span class="dv">1</span> <span class="op">+</span> df[<span class="st">"mkt_total"</span>])</span>
<span id="cb40-1210"><a href="#cb40-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1211"><a href="#cb40-1211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Rolling compound returns (stock and market)</span></span>
<span id="cb40-1212"><a href="#cb40-1212" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> windows:</span>
<span id="cb40-1213"><a href="#cb40-1213" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(</span>
<span id="cb40-1214"><a href="#cb40-1214" aria-hidden="true" tabindex="-1"></a>            df.groupby(<span class="st">"symbol"</span>)[<span class="st">"log_ret"</span>]</span>
<span id="cb40-1215"><a href="#cb40-1215" aria-hidden="true" tabindex="-1"></a>            .transform(</span>
<span id="cb40-1216"><a href="#cb40-1216" aria-hidden="true" tabindex="-1"></a>                <span class="kw">lambda</span> x: x.rolling(k, min_periods<span class="op">=</span>k).<span class="bu">sum</span>()</span>
<span id="cb40-1217"><a href="#cb40-1217" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb40-1218"><a href="#cb40-1218" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1219"><a href="#cb40-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1220"><a href="#cb40-1220" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> np.exp(</span>
<span id="cb40-1221"><a href="#cb40-1221" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">"log_mkt"</span>]</span>
<span id="cb40-1222"><a href="#cb40-1222" aria-hidden="true" tabindex="-1"></a>            .rolling(k, min_periods<span class="op">=</span>k)</span>
<span id="cb40-1223"><a href="#cb40-1223" aria-hidden="true" tabindex="-1"></a>            .<span class="bu">sum</span>()</span>
<span id="cb40-1224"><a href="#cb40-1224" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1225"><a href="#cb40-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1226"><a href="#cb40-1226" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Excess compound return (BHAR vs market)</span></span>
<span id="cb40-1227"><a href="#cb40-1227" aria-hidden="true" tabindex="-1"></a>        df[<span class="ss">f"exret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> df[<span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>] <span class="op">-</span> df[<span class="ss">f"mkt_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb40-1228"><a href="#cb40-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1229"><a href="#cb40-1229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Cumulative return (full history)</span></span>
<span id="cb40-1230"><a href="#cb40-1230" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"wealth"</span>] <span class="op">=</span> (</span>
<span id="cb40-1231"><a href="#cb40-1231" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"log_ret"</span>]</span>
<span id="cb40-1232"><a href="#cb40-1232" aria-hidden="true" tabindex="-1"></a>        .cumsum()</span>
<span id="cb40-1233"><a href="#cb40-1233" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.exp)</span>
<span id="cb40-1234"><a href="#cb40-1234" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1235"><a href="#cb40-1235" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cumret"</span>] <span class="op">=</span> df[<span class="st">"wealth"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb40-1236"><a href="#cb40-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1237"><a href="#cb40-1237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Rolling volatility</span></span>
<span id="cb40-1238"><a href="#cb40-1238" aria-hidden="true" tabindex="-1"></a>    df[<span class="ss">f"vol_</span><span class="sc">{</span>vol_window<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (</span>
<span id="cb40-1239"><a href="#cb40-1239" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"ret_total"</span>]</span>
<span id="cb40-1240"><a href="#cb40-1240" aria-hidden="true" tabindex="-1"></a>        .transform(</span>
<span id="cb40-1241"><a href="#cb40-1241" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rolling(</span>
<span id="cb40-1242"><a href="#cb40-1242" aria-hidden="true" tabindex="-1"></a>                vol_window, min_periods<span class="op">=</span>vol_window</span>
<span id="cb40-1243"><a href="#cb40-1243" aria-hidden="true" tabindex="-1"></a>            ).std()</span>
<span id="cb40-1244"><a href="#cb40-1244" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb40-1245"><a href="#cb40-1245" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">*</span> np.sqrt(<span class="dv">12</span>)  <span class="co"># annualize</span></span>
<span id="cb40-1246"><a href="#cb40-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1247"><a href="#cb40-1247" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Drawdown</span></span>
<span id="cb40-1248"><a href="#cb40-1248" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"peak"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"wealth"</span>].cummax()</span>
<span id="cb40-1249"><a href="#cb40-1249" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"drawdown"</span>] <span class="op">=</span> (df[<span class="st">"wealth"</span>] <span class="op">-</span> df[<span class="st">"peak"</span>]) <span class="op">/</span> df[<span class="st">"peak"</span>]</span>
<span id="cb40-1250"><a href="#cb40-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1251"><a href="#cb40-1251" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up</span></span>
<span id="cb40-1252"><a href="#cb40-1252" aria-hidden="true" tabindex="-1"></a>    df.drop(</span>
<span id="cb40-1253"><a href="#cb40-1253" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>[<span class="st">"log_ret"</span>, <span class="st">"log_mkt"</span>, <span class="st">"peak"</span>], inplace<span class="op">=</span><span class="va">True</span></span>
<span id="cb40-1254"><a href="#cb40-1254" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1255"><a href="#cb40-1255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1256"><a href="#cb40-1256" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb40-1257"><a href="#cb40-1257" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1258"><a href="#cb40-1258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1261"><a href="#cb40-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1262"><a href="#cb40-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the full dataset</span></span>
<span id="cb40-1263"><a href="#cb40-1263" aria-hidden="true" tabindex="-1"></a>compound_dataset <span class="op">=</span> build_compound_return_dataset(prices_monthly)</span>
<span id="cb40-1264"><a href="#cb40-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1265"><a href="#cb40-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1266"><a href="#cb40-1266" aria-hidden="true" tabindex="-1"></a>@tbl-summary-stats provides summary statistics for the key variables in our compound return dataset.</span>
<span id="cb40-1267"><a href="#cb40-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1270"><a href="#cb40-1270" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1271"><a href="#cb40-1271" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-summary-stats</span></span>
<span id="cb40-1272"><a href="#cb40-1272" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary statistics for compound return variables across all Vietnamese stock-month observations. Returns are in decimal form (0.10 = 10%). The wide dispersion of 12-month compound returns and the high median volatility reflect the emerging market characteristics of the Vietnamese equity market."</span></span>
<span id="cb40-1273"><a href="#cb40-1273" aria-hidden="true" tabindex="-1"></a>summary_cols <span class="op">=</span> [<span class="st">"ret_total"</span>, <span class="st">"ret_3"</span>, <span class="st">"ret_6"</span>, <span class="st">"ret_12"</span>,</span>
<span id="cb40-1274"><a href="#cb40-1274" aria-hidden="true" tabindex="-1"></a>                <span class="st">"exret_3"</span>, <span class="st">"exret_12"</span>, <span class="st">"vol_24"</span>, <span class="st">"drawdown"</span>]</span>
<span id="cb40-1275"><a href="#cb40-1275" aria-hidden="true" tabindex="-1"></a>available_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> summary_cols</span>
<span id="cb40-1276"><a href="#cb40-1276" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> c <span class="kw">in</span> compound_dataset.columns]</span>
<span id="cb40-1277"><a href="#cb40-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1278"><a href="#cb40-1278" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> (</span>
<span id="cb40-1279"><a href="#cb40-1279" aria-hidden="true" tabindex="-1"></a>    compound_dataset[available_cols]</span>
<span id="cb40-1280"><a href="#cb40-1280" aria-hidden="true" tabindex="-1"></a>    .describe(percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.50</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>])</span>
<span id="cb40-1281"><a href="#cb40-1281" aria-hidden="true" tabindex="-1"></a>    .T</span>
<span id="cb40-1282"><a href="#cb40-1282" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb40-1283"><a href="#cb40-1283" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1284"><a href="#cb40-1284" aria-hidden="true" tabindex="-1"></a>summary</span>
<span id="cb40-1285"><a href="#cb40-1285" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1286"><a href="#cb40-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1287"><a href="#cb40-1287" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cross-Sectional Distribution of Compound Returns</span></span>
<span id="cb40-1288"><a href="#cb40-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1289"><a href="#cb40-1289" aria-hidden="true" tabindex="-1"></a>To understand how compound returns vary across securities, we examine the cross-sectional distribution at different horizons.</span>
<span id="cb40-1290"><a href="#cb40-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1293"><a href="#cb40-1293" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1294"><a href="#cb40-1294" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-horizon-comparison</span></span>
<span id="cb40-1295"><a href="#cb40-1295" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-sectional distribution of compound returns at different horizons (3, 6, and 12 months) for Vietnamese stocks. Longer horizons exhibit greater dispersion and more pronounced right skewness, reflecting the compounding of idiosyncratic risk. The fat tails are more extreme than those typically observed in developed markets, consistent with the higher volatility environment."</span></span>
<span id="cb40-1296"><a href="#cb40-1296" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Overlaid density plots of compound returns at 3, 6, and 12 month horizons for Vietnamese stocks."</span></span>
<span id="cb40-1297"><a href="#cb40-1297" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-pos: "htbp"</span></span>
<span id="cb40-1298"><a href="#cb40-1298" aria-hidden="true" tabindex="-1"></a>horizon_data <span class="op">=</span> pd.DataFrame()</span>
<span id="cb40-1299"><a href="#cb40-1299" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">12</span>]:</span>
<span id="cb40-1300"><a href="#cb40-1300" aria-hidden="true" tabindex="-1"></a>    col <span class="op">=</span> <span class="ss">f"ret_</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb40-1301"><a href="#cb40-1301" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> compound_dataset[[col]].dropna().copy()</span>
<span id="cb40-1302"><a href="#cb40-1302" aria-hidden="true" tabindex="-1"></a>    temp.columns <span class="op">=</span> [<span class="st">"compound_return"</span>]</span>
<span id="cb40-1303"><a href="#cb40-1303" aria-hidden="true" tabindex="-1"></a>    temp[<span class="st">"horizon"</span>] <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss"> months"</span></span>
<span id="cb40-1304"><a href="#cb40-1304" aria-hidden="true" tabindex="-1"></a>    lo, hi <span class="op">=</span> temp[<span class="st">"compound_return"</span>].quantile([<span class="fl">0.01</span>, <span class="fl">0.99</span>])</span>
<span id="cb40-1305"><a href="#cb40-1305" aria-hidden="true" tabindex="-1"></a>    temp <span class="op">=</span> temp[</span>
<span id="cb40-1306"><a href="#cb40-1306" aria-hidden="true" tabindex="-1"></a>        (temp[<span class="st">"compound_return"</span>] <span class="op">&gt;=</span> lo)</span>
<span id="cb40-1307"><a href="#cb40-1307" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span> (temp[<span class="st">"compound_return"</span>] <span class="op">&lt;=</span> hi)</span>
<span id="cb40-1308"><a href="#cb40-1308" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-1309"><a href="#cb40-1309" aria-hidden="true" tabindex="-1"></a>    horizon_data <span class="op">=</span> pd.concat([horizon_data, temp])</span>
<span id="cb40-1310"><a href="#cb40-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1311"><a href="#cb40-1311" aria-hidden="true" tabindex="-1"></a>plot_horizons <span class="op">=</span> (</span>
<span id="cb40-1312"><a href="#cb40-1312" aria-hidden="true" tabindex="-1"></a>    ggplot(horizon_data,</span>
<span id="cb40-1313"><a href="#cb40-1313" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"compound_return"</span>, fill<span class="op">=</span><span class="st">"horizon"</span>)) <span class="op">+</span></span>
<span id="cb40-1314"><a href="#cb40-1314" aria-hidden="true" tabindex="-1"></a>    geom_density(alpha<span class="op">=</span><span class="fl">0.4</span>) <span class="op">+</span></span>
<span id="cb40-1315"><a href="#cb40-1315" aria-hidden="true" tabindex="-1"></a>    geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>) <span class="op">+</span></span>
<span id="cb40-1316"><a href="#cb40-1316" aria-hidden="true" tabindex="-1"></a>    labs(x<span class="op">=</span><span class="st">"Compound return"</span>, y<span class="op">=</span><span class="st">"Density"</span>, fill<span class="op">=</span><span class="st">"Horizon"</span>) <span class="op">+</span></span>
<span id="cb40-1317"><a href="#cb40-1317" aria-hidden="true" tabindex="-1"></a>    scale_x_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb40-1318"><a href="#cb40-1318" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb40-1319"><a href="#cb40-1319" aria-hidden="true" tabindex="-1"></a>    theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span id="cb40-1320"><a href="#cb40-1320" aria-hidden="true" tabindex="-1"></a>          figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb40-1321"><a href="#cb40-1321" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-1322"><a href="#cb40-1322" aria-hidden="true" tabindex="-1"></a>plot_horizons.draw()</span>
<span id="cb40-1323"><a href="#cb40-1323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1324"><a href="#cb40-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1325"><a href="#cb40-1325" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vietnam-Specific Considerations</span></span>
<span id="cb40-1326"><a href="#cb40-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1327"><a href="#cb40-1327" aria-hidden="true" tabindex="-1"></a><span class="fu">### Price Limits and Their Effect on Compounding</span></span>
<span id="cb40-1328"><a href="#cb40-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1329"><a href="#cb40-1329" aria-hidden="true" tabindex="-1"></a>Vietnam's stock exchanges impose daily price limits that cap the maximum price change from the reference price. As of the latest regulations:</span>
<span id="cb40-1330"><a href="#cb40-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1331"><a href="#cb40-1331" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**HOSE**: $\pm 7\%$</span>
<span id="cb40-1332"><a href="#cb40-1332" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**HNX**: $\pm 10\%$</span>
<span id="cb40-1333"><a href="#cb40-1333" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**UPCoM**: $\pm 15\%$</span>
<span id="cb40-1334"><a href="#cb40-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1335"><a href="#cb40-1335" aria-hidden="true" tabindex="-1"></a>These limits truncate the daily return distribution and can create sequences of limit-hit days when large information events occur. For compound return computation, this means that the adjustment to new information may be spread over multiple days rather than occurring instantaneously. When computing monthly compound returns from daily data, this is handled correctly because the compound return accumulates the full adjustment regardless of how many days it takes.</span>
<span id="cb40-1336"><a href="#cb40-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1337"><a href="#cb40-1337" aria-hidden="true" tabindex="-1"></a>However, price limits can introduce bias in short-horizon return computations. If a large positive event occurs and the stock hits the limit-up ceiling for several consecutive days, the 1-day or 1-week compound return will understate the true information content of the event <span class="co">[</span><span class="ot">@kim2013reconsidering</span><span class="co">]</span>. For event study applications, researchers should verify that the event window is long enough to accommodate the price-limit-induced delay in price adjustment.</span>
<span id="cb40-1338"><a href="#cb40-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1339"><a href="#cb40-1339" aria-hidden="true" tabindex="-1"></a><span class="fu">### Foreign Ownership Limits</span></span>
<span id="cb40-1340"><a href="#cb40-1340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1341"><a href="#cb40-1341" aria-hidden="true" tabindex="-1"></a>Vietnam imposes foreign ownership limits (FOL) on listed companies, typically capped at 49% for most industries and lower (30% or less) for certain restricted sectors such as banking and telecommunications. When a stock reaches its FOL, foreign investors can only purchase shares from other foreign sellers, creating a parallel premium market for foreign-board shares. This does not directly affect the computation of compound returns (which use official traded prices), but researchers studying cross-border portfolio returns should be aware that the effective price paid by foreign investors may differ from the board price <span class="co">[</span><span class="ot">@vo2017foreign</span><span class="co">]</span>.</span>
<span id="cb40-1342"><a href="#cb40-1342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1343"><a href="#cb40-1343" aria-hidden="true" tabindex="-1"></a><span class="fu">### The VN-Index and Market Benchmarks</span></span>
<span id="cb40-1344"><a href="#cb40-1344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1345"><a href="#cb40-1345" aria-hidden="true" tabindex="-1"></a>For benchmark compound returns, Vietnam's primary indices are:</span>
<span id="cb40-1346"><a href="#cb40-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1347"><a href="#cb40-1347" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**VN-Index**: The capitalization-weighted index of all HOSE-listed stocks.</span>
<span id="cb40-1348"><a href="#cb40-1348" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**VN30**: The 30 largest and most liquid stocks on HOSE, reviewed semi-annually.</span>
<span id="cb40-1349"><a href="#cb40-1349" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**HNX-Index**: The capitalization-weighted index of HNX-listed stocks.</span>
<span id="cb40-1350"><a href="#cb40-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1351"><a href="#cb40-1351" aria-hidden="true" tabindex="-1"></a>The VN-Index is the most widely used benchmark and is the default market return in our dataset.</span>
<span id="cb40-1352"><a href="#cb40-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1353"><a href="#cb40-1353" aria-hidden="true" tabindex="-1"></a><span class="fu">## Performance Considerations</span></span>
<span id="cb40-1354"><a href="#cb40-1354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1355"><a href="#cb40-1355" aria-hidden="true" tabindex="-1"></a>When working with large datasets, computational efficiency matters. @tbl-performance-benchmark compares the execution time of our four compounding methods on a standardized dataset.</span>
<span id="cb40-1356"><a href="#cb40-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1359"><a href="#cb40-1359" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb40-1360"><a href="#cb40-1360" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-performance-benchmark</span></span>
<span id="cb40-1361"><a href="#cb40-1361" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Execution time comparison for different compounding methods on a dataset of 10,000 stock-month observations. The cumulative product and log-sum-exp methods are orders of magnitude faster than the iterative approach due to NumPy vectorization."</span></span>
<span id="cb40-1362"><a href="#cb40-1362" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb40-1363"><a href="#cb40-1363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1364"><a href="#cb40-1364" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb40-1365"><a href="#cb40-1365" aria-hidden="true" tabindex="-1"></a>n_stocks <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb40-1366"><a href="#cb40-1366" aria-hidden="true" tabindex="-1"></a>n_months <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb40-1367"><a href="#cb40-1367" aria-hidden="true" tabindex="-1"></a>test_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-1368"><a href="#cb40-1368" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: np.repeat(<span class="bu">range</span>(n_stocks), n_months),</span>
<span id="cb40-1369"><a href="#cb40-1369" aria-hidden="true" tabindex="-1"></a>    <span class="st">"date"</span>: np.tile(</span>
<span id="cb40-1370"><a href="#cb40-1370" aria-hidden="true" tabindex="-1"></a>        pd.date_range(<span class="st">"2015-01-31"</span>, periods<span class="op">=</span>n_months,</span>
<span id="cb40-1371"><a href="#cb40-1371" aria-hidden="true" tabindex="-1"></a>                       freq<span class="op">=</span><span class="st">"ME"</span>),</span>
<span id="cb40-1372"><a href="#cb40-1372" aria-hidden="true" tabindex="-1"></a>        n_stocks</span>
<span id="cb40-1373"><a href="#cb40-1373" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb40-1374"><a href="#cb40-1374" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret_total"</span>: np.random.normal(</span>
<span id="cb40-1375"><a href="#cb40-1375" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.01</span>, <span class="fl">0.08</span>, n_stocks <span class="op">*</span> n_months</span>
<span id="cb40-1376"><a href="#cb40-1376" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb40-1377"><a href="#cb40-1377" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1378"><a href="#cb40-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1379"><a href="#cb40-1379" aria-hidden="true" tabindex="-1"></a>methods <span class="op">=</span> {}</span>
<span id="cb40-1380"><a href="#cb40-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1381"><a href="#cb40-1381" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb40-1382"><a href="#cb40-1382" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_cumprod(test_df)</span>
<span id="cb40-1383"><a href="#cb40-1383" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Cumulative Product"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb40-1384"><a href="#cb40-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1385"><a href="#cb40-1385" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb40-1386"><a href="#cb40-1386" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_logsum(test_df)</span>
<span id="cb40-1387"><a href="#cb40-1387" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Log-Sum-Exp"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb40-1388"><a href="#cb40-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1389"><a href="#cb40-1389" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb40-1390"><a href="#cb40-1390" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> compute_cumret_iterative(test_df)</span>
<span id="cb40-1391"><a href="#cb40-1391" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Iterative (carry)"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb40-1392"><a href="#cb40-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1393"><a href="#cb40-1393" aria-hidden="true" tabindex="-1"></a>t0 <span class="op">=</span> time.time()</span>
<span id="cb40-1394"><a href="#cb40-1394" aria-hidden="true" tabindex="-1"></a>_ <span class="op">=</span> rolling_compound_return(test_df, windows<span class="op">=</span>[<span class="dv">12</span>])</span>
<span id="cb40-1395"><a href="#cb40-1395" aria-hidden="true" tabindex="-1"></a>methods[<span class="st">"Rolling (12-month)"</span>] <span class="op">=</span> time.time() <span class="op">-</span> t0</span>
<span id="cb40-1396"><a href="#cb40-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1397"><a href="#cb40-1397" aria-hidden="true" tabindex="-1"></a>perf_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb40-1398"><a href="#cb40-1398" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Method"</span>: methods.keys(),</span>
<span id="cb40-1399"><a href="#cb40-1399" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Time (seconds)"</span>: [<span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.4f}</span><span class="ss">"</span> <span class="cf">for</span> v <span class="kw">in</span> methods.values()],</span>
<span id="cb40-1400"><a href="#cb40-1400" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Relative Speed"</span>: [</span>
<span id="cb40-1401"><a href="#cb40-1401" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>v<span class="op">/</span><span class="bu">min</span>(methods.values())<span class="sc">:.1f}</span><span class="ss">x"</span></span>
<span id="cb40-1402"><a href="#cb40-1402" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> v <span class="kw">in</span> methods.values()</span>
<span id="cb40-1403"><a href="#cb40-1403" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb40-1404"><a href="#cb40-1404" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-1405"><a href="#cb40-1405" aria-hidden="true" tabindex="-1"></a>perf_df</span>
<span id="cb40-1406"><a href="#cb40-1406" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb40-1407"><a href="#cb40-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1408"><a href="#cb40-1408" aria-hidden="true" tabindex="-1"></a><span class="fu">## Common Pitfalls and Best Practices</span></span>
<span id="cb40-1409"><a href="#cb40-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1410"><a href="#cb40-1410" aria-hidden="true" tabindex="-1"></a>Several subtle issues can lead to incorrect compound return calculations. We summarize the most important ones:</span>
<span id="cb40-1411"><a href="#cb40-1411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1412"><a href="#cb40-1412" aria-hidden="true" tabindex="-1"></a>**Gaps in the time series.** If a security has months with no observations (not even a missing return flag), rolling window calculations based on positional indexing will produce incorrect results. The rolling window will span the wrong calendar period. Always ensure that the time series is complete, fill gaps with explicit missing values before computing rolling statistics. This is particularly relevant in Vietnam, where trading suspensions can create gaps.</span>
<span id="cb40-1413"><a href="#cb40-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1414"><a href="#cb40-1414" aria-hidden="true" tabindex="-1"></a>**Survivorship bias.** As discussed in the delisting returns section, excluding securities that cease trading biases compound returns upward. Always incorporate delisting returns when available. When delisting returns are unavailable (as is sometimes the case in Vietnamese data), consider using imputed values based on the delisting reason.</span>
<span id="cb40-1415"><a href="#cb40-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1416"><a href="#cb40-1416" aria-hidden="true" tabindex="-1"></a>**Look-ahead bias.** When aligning compound returns to fiscal year ends for cross-sectional analysis, be careful not to use returns from before the fiscal year end to predict post-announcement returns. Vietnamese firms are required to publish audited annual financial statements within 90 days of the fiscal year end, so a buffer of at least 3 months is advisable when constructing forward-looking compound returns.</span>
<span id="cb40-1417"><a href="#cb40-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1418"><a href="#cb40-1418" aria-hidden="true" tabindex="-1"></a>**Numerical overflow and underflow.** For very long compounding horizons or extreme returns, the cumulative product can overflow (<span class="in">`inf`</span>) or underflow (0). The log-sum-exp approach is more robust to such numerical issues because it operates in log space where the range is compressed.</span>
<span id="cb40-1419"><a href="#cb40-1419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1420"><a href="#cb40-1420" aria-hidden="true" tabindex="-1"></a>**Annualization of partial periods.** When computing annualized returns from partial-period data (e.g., 7 months of data annualized to 12), the annualization formula $(1+R)^{12/k} - 1$ assumes that the observed return rate will persist. This assumption is stronger for short partial periods and can produce misleading results. Report the actual compound return and the number of periods alongside any annualized figures.</span>
<span id="cb40-1421"><a href="#cb40-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1422"><a href="#cb40-1422" aria-hidden="true" tabindex="-1"></a>**Exchange transfers.** In Vietnam, stocks sometimes transfer between UPCoM, HNX, and HOSE. These transfers may involve temporary trading halts and can cause apparent gaps in the return series. When computing compound returns that span an exchange transfer, ensure that the return series is continuous across the transfer date.</span>
<span id="cb40-1423"><a href="#cb40-1423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1424"><a href="#cb40-1424" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises</span></span>
<span id="cb40-1425"><a href="#cb40-1425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1426"><a href="#cb40-1426" aria-hidden="true" tabindex="-1"></a><span class="co">1.  Compute the annual compound return for the VN-Index for each year in the sample. How does it compare to the simple sum of monthly returns? In which years is the difference largest, and why?</span></span>
<span id="cb40-1427"><a href="#cb40-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1428"><a href="#cb40-1428" aria-hidden="true" tabindex="-1"></a><span class="co">2.  Implement a function that computes the **Calmar ratio** (annualized return divided by the absolute value of maximum drawdown) for each security. Which securities have the highest Calmar ratios over the most recent 5-year period? Do they tend to be on HOSE, HNX, or UPCoM?</span></span>
<span id="cb40-1429"><a href="#cb40-1429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1430"><a href="#cb40-1430" aria-hidden="true" tabindex="-1"></a><span class="co">3.  Sort stocks into quintiles based on their 12-month trailing compound return (the momentum signal) and compute the equal-weighted average return of each quintile in the subsequent month. Does the momentum effect appear in Vietnamese data? Compare your findings with evidence from @vo2018does.</span></span>
<span id="cb40-1431"><a href="#cb40-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1432"><a href="#cb40-1432" aria-hidden="true" tabindex="-1"></a><span class="co">4.  Extend the `rolling_compound_return` function to handle overlapping fiscal years, where the compounding window is aligned to each firm's fiscal year end rather than calendar months.</span></span>
<span id="cb40-1433"><a href="#cb40-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1434"><a href="#cb40-1434" aria-hidden="true" tabindex="-1"></a><span class="co">5.  Compare the BHAR and CAR measures for a set of randomly chosen event dates. Under what conditions do they diverge most? Relate your findings to the theoretical discussion of @barber1997detecting.</span></span>
<span id="cb40-1435"><a href="#cb40-1435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1436"><a href="#cb40-1436" aria-hidden="true" tabindex="-1"></a><span class="co">6.  Compute the cross-sectional correlation between 24-month rolling volatility and subsequent 12-month compound returns. Is there a risk-return tradeoff in the Vietnamese equity market cross section? How does this compare to the positive risk-return relationship documented in developed markets by @ghysels2005there?</span></span>
<span id="cb40-1437"><a href="#cb40-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-1438"><a href="#cb40-1438" aria-hidden="true" tabindex="-1"></a><span class="co">7.  Examine how daily price limits affect the computation of weekly compound returns. Select stocks that hit the limit-up or limit-down ceiling on at least one day, and compare their weekly compound return to similar-magnitude events in stocks that did not hit the limit. --&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/06_compound_return.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>