<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>46&nbsp; Networks and Graphs in Finance ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./74_multimodel.html" rel="next">
<link href="./71_image.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="46&nbsp; Networks and Graphs in Finance ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:title" content="46&nbsp; Networks and Graphs in Finance ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./70_textual.html">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</a></li><li class="breadcrumb-item"><a href="./73_networks_graphs.html"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#graph-theory-foundations-for-finance" id="toc-graph-theory-foundations-for-finance" class="nav-link active" data-scroll-target="#graph-theory-foundations-for-finance"><span class="header-section-number">46.1</span> Graph Theory Foundations for Finance</a>
  <ul class="collapse">
  <li><a href="#representing-financial-data-as-graphs" id="toc-representing-financial-data-as-graphs" class="nav-link" data-scroll-target="#representing-financial-data-as-graphs"><span class="header-section-number">46.1.1</span> Representing Financial Data as Graphs</a></li>
  <li><a href="#key-graph-metrics" id="toc-key-graph-metrics" class="nav-link" data-scroll-target="#key-graph-metrics"><span class="header-section-number">46.1.2</span> Key Graph Metrics</a></li>
  <li><a href="#the-adjacency-matrix-and-its-spectral-properties" id="toc-the-adjacency-matrix-and-its-spectral-properties" class="nav-link" data-scroll-target="#the-adjacency-matrix-and-its-spectral-properties"><span class="header-section-number">46.1.3</span> The Adjacency Matrix and Its Spectral Properties</a></li>
  </ul></li>
  <li><a href="#ownership-and-control-networks" id="toc-ownership-and-control-networks" class="nav-link" data-scroll-target="#ownership-and-control-networks"><span class="header-section-number">46.2</span> Ownership and Control Networks</a>
  <ul class="collapse">
  <li><a href="#vietnamese-ownership-structure" id="toc-vietnamese-ownership-structure" class="nav-link" data-scroll-target="#vietnamese-ownership-structure"><span class="header-section-number">46.2.1</span> Vietnamese Ownership Structure</a></li>
  <li><a href="#ultimate-ownership-and-control-chains" id="toc-ultimate-ownership-and-control-chains" class="nav-link" data-scroll-target="#ultimate-ownership-and-control-chains"><span class="header-section-number">46.2.2</span> Ultimate Ownership and Control Chains</a></li>
  <li><a href="#ownership-centrality-and-firm-value" id="toc-ownership-centrality-and-firm-value" class="nav-link" data-scroll-target="#ownership-centrality-and-firm-value"><span class="header-section-number">46.2.3</span> Ownership Centrality and Firm Value</a></li>
  <li><a href="#business-group-detection" id="toc-business-group-detection" class="nav-link" data-scroll-target="#business-group-detection"><span class="header-section-number">46.2.4</span> Business Group Detection</a></li>
  </ul></li>
  <li><a href="#board-interlock-networks" id="toc-board-interlock-networks" class="nav-link" data-scroll-target="#board-interlock-networks"><span class="header-section-number">46.3</span> Board Interlock Networks</a>
  <ul class="collapse">
  <li><a href="#construction" id="toc-construction" class="nav-link" data-scroll-target="#construction"><span class="header-section-number">46.3.1</span> Construction</a></li>
  <li><a href="#interlocks-and-return-co-movement" id="toc-interlocks-and-return-co-movement" class="nav-link" data-scroll-target="#interlocks-and-return-co-movement"><span class="header-section-number">46.3.2</span> Interlocks and Return Co-Movement</a></li>
  </ul></li>
  <li><a href="#supply-chain-and-trade-networks" id="toc-supply-chain-and-trade-networks" class="nav-link" data-scroll-target="#supply-chain-and-trade-networks"><span class="header-section-number">46.4</span> Supply Chain and Trade Networks</a>
  <ul class="collapse">
  <li><a href="#constructing-the-supply-chain-graph" id="toc-constructing-the-supply-chain-graph" class="nav-link" data-scroll-target="#constructing-the-supply-chain-graph"><span class="header-section-number">46.4.1</span> Constructing the Supply Chain Graph</a></li>
  <li><a href="#customer-momentum" id="toc-customer-momentum" class="nav-link" data-scroll-target="#customer-momentum"><span class="header-section-number">46.4.2</span> Customer Momentum</a></li>
  <li><a href="#network-propagation-shock-diffusion-through-supply-chains" id="toc-network-propagation-shock-diffusion-through-supply-chains" class="nav-link" data-scroll-target="#network-propagation-shock-diffusion-through-supply-chains"><span class="header-section-number">46.4.3</span> Network Propagation: Shock Diffusion Through Supply Chains</a></li>
  </ul></li>
  <li><a href="#correlation-and-co-movement-networks" id="toc-correlation-and-co-movement-networks" class="nav-link" data-scroll-target="#correlation-and-co-movement-networks"><span class="header-section-number">46.5</span> Correlation and Co-Movement Networks</a>
  <ul class="collapse">
  <li><a href="#construction-from-return-data" id="toc-construction-from-return-data" class="nav-link" data-scroll-target="#construction-from-return-data"><span class="header-section-number">46.5.1</span> Construction from Return Data</a></li>
  <li><a href="#the-diebold-yilmaz-connectedness-framework" id="toc-the-diebold-yilmaz-connectedness-framework" class="nav-link" data-scroll-target="#the-diebold-yilmaz-connectedness-framework"><span class="header-section-number">46.5.2</span> The Diebold-Yilmaz Connectedness Framework</a></li>
  </ul></li>
  <li><a href="#interbank-and-financial-contagion-networks" id="toc-interbank-and-financial-contagion-networks" class="nav-link" data-scroll-target="#interbank-and-financial-contagion-networks"><span class="header-section-number">46.6</span> Interbank and Financial Contagion Networks</a>
  <ul class="collapse">
  <li><a href="#the-interbank-market-as-a-network" id="toc-the-interbank-market-as-a-network" class="nav-link" data-scroll-target="#the-interbank-market-as-a-network"><span class="header-section-number">46.6.1</span> The Interbank Market as a Network</a></li>
  <li><a href="#cascading-default-simulation" id="toc-cascading-default-simulation" class="nav-link" data-scroll-target="#cascading-default-simulation"><span class="header-section-number">46.6.2</span> Cascading Default Simulation</a></li>
  </ul></li>
  <li><a href="#graph-neural-networks-for-financial-prediction" id="toc-graph-neural-networks-for-financial-prediction" class="nav-link" data-scroll-target="#graph-neural-networks-for-financial-prediction"><span class="header-section-number">46.7</span> Graph Neural Networks for Financial Prediction</a>
  <ul class="collapse">
  <li><a href="#from-graphs-to-predictions" id="toc-from-graphs-to-predictions" class="nav-link" data-scroll-target="#from-graphs-to-predictions"><span class="header-section-number">46.7.1</span> From Graphs to Predictions</a></li>
  <li><a href="#graph-convolutional-networks-gcn" id="toc-graph-convolutional-networks-gcn" class="nav-link" data-scroll-target="#graph-convolutional-networks-gcn"><span class="header-section-number">46.7.2</span> Graph Convolutional Networks (GCN)</a></li>
  <li><a href="#graph-attention-networks-gat" id="toc-graph-attention-networks-gat" class="nav-link" data-scroll-target="#graph-attention-networks-gat"><span class="header-section-number">46.7.3</span> Graph Attention Networks (GAT)</a></li>
  <li><a href="#gnn-for-cross-sectional-return-prediction" id="toc-gnn-for-cross-sectional-return-prediction" class="nav-link" data-scroll-target="#gnn-for-cross-sectional-return-prediction"><span class="header-section-number">46.7.4</span> GNN for Cross-Sectional Return Prediction</a></li>
  <li><a href="#temporal-graph-networks" id="toc-temporal-graph-networks" class="nav-link" data-scroll-target="#temporal-graph-networks"><span class="header-section-number">46.7.5</span> Temporal Graph Networks</a></li>
  <li><a href="#gnn-for-credit-risk-and-fraud-detection" id="toc-gnn-for-credit-risk-and-fraud-detection" class="nav-link" data-scroll-target="#gnn-for-credit-risk-and-fraud-detection"><span class="header-section-number">46.7.6</span> GNN for Credit Risk and Fraud Detection</a></li>
  </ul></li>
  <li><a href="#when-to-use-network-methods" id="toc-when-to-use-network-methods" class="nav-link" data-scroll-target="#when-to-use-network-methods"><span class="header-section-number">46.8</span> When to Use Network Methods</a>
  <ul class="collapse">
  <li><a href="#decision-framework" id="toc-decision-framework" class="nav-link" data-scroll-target="#decision-framework"><span class="header-section-number">46.8.1</span> Decision Framework</a></li>
  <li><a href="#data-requirements-and-vietnamese-availability" id="toc-data-requirements-and-vietnamese-availability" class="nav-link" data-scroll-target="#data-requirements-and-vietnamese-availability"><span class="header-section-number">46.8.2</span> Data Requirements and Vietnamese Availability</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">46.9</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/73_networks_graphs.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./70_textual.html">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</a></li><li class="breadcrumb-item"><a href="./73_networks_graphs.html"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Financial markets are networks. Every stock return is shaped by connections: firms share supply chains, directors, auditors, investors, lenders, and regulators. Shocks propagate through these links (e.g., a bankruptcy ripples through supplier networks, a central bank liquidity squeeze radiates through interbank exposures, and information diffuses through board interlocks and institutional co-ownership). Yet the dominant empirical paradigm in finance treats firms as isolated observations indexed by <span class="math inline">\((i, t)\)</span>, connected only through their shared exposure to common factors. This chapter introduces tools for modeling, measuring, and exploiting the network structure that standard panel regressions ignore.</p>
<p>The Vietnamese financial system is particularly network-dense. State ownership creates a lattice of cross-connected enterprises: the same line ministry may oversee the borrower, the lender, and the insurer. Pyramidal business groups (such as Vingroup, Masan, and FPT) link dozens of listed and unlisted entities through chains of equity ownership. The banking system is small and concentrated, with a few state-owned commercial banks accounting for the majority of assets, generating dense interbank exposures. Board interlocks (e.g., directors who serve on multiple boards simultaneously) are pervasive and often follow ownership lines. And the equity market itself exhibits return co-movement patterns that, when represented as a correlation network, reveal sector-level and ownership-level clustering invisible in standard factor analysis.</p>
<p>This chapter covers the full spectrum of network methods used in financial economics, from classical graph theory through modern graph neural networks (GNNs). We organize the material in seven sections. First, graph theory fundamentals and the representation of financial data as networks. Second, ownership and control networks, which are the most distinctive network structure in Vietnamese markets. Third, board interlock and governance networks. Fourth, supply chain and trade networks. Fifth, correlation and co-movement networks for portfolio construction and systemic risk monitoring. Sixth, interbank and contagion networks. Seventh, graph neural networks and graph-based machine learning for asset pricing, credit risk, and anomaly detection.</p>
<div id="setup" class="cell" data-message="false" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph libraries</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> sparse</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> squareform</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical and econometric</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Deep learning (for GNNs later)</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="3bab7cb5" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="graph-theory-foundations-for-finance" class="level2" data-number="46.1">
<h2 data-number="46.1" class="anchored" data-anchor-id="graph-theory-foundations-for-finance"><span class="header-section-number">46.1</span> Graph Theory Foundations for Finance</h2>
<section id="representing-financial-data-as-graphs" class="level3" data-number="46.1.1">
<h3 data-number="46.1.1" class="anchored" data-anchor-id="representing-financial-data-as-graphs"><span class="header-section-number">46.1.1</span> Representing Financial Data as Graphs</h3>
<p>A graph <span class="math inline">\(G = (V, E)\)</span> consists of a set of vertices (nodes) <span class="math inline">\(V\)</span> and edges (links) <span class="math inline">\(E \subseteq V \times V\)</span>. In financial networks, nodes represent economic agents, such as firms, banks, investors, directors, and edges represent relationships including ownership stakes, lending, board seats, supply contracts, and return co-movement.</p>
<p>Financial graphs come in several varieties:</p>
<p><strong>Directed vs.&nbsp;undirected.</strong> Ownership is directed: firm <span class="math inline">\(A\)</span> owns a stake in firm <span class="math inline">\(B\)</span>, but not necessarily vice versa. Board interlocks are undirected: if director <span class="math inline">\(d\)</span> sits on both firm <span class="math inline">\(A\)</span>‚Äôs and firm <span class="math inline">\(B\)</span>‚Äôs boards, the connection is symmetric. Supply chains are directed: <span class="math inline">\(A\)</span> supplies to <span class="math inline">\(B\)</span>.</p>
<p><strong>Weighted vs.&nbsp;unweighted.</strong> Ownership networks are naturally weighted by the ownership percentage. Correlation networks are weighted by the pairwise correlation coefficient. Board interlocks can be weighted by the number of shared directors.</p>
<p><strong>Static vs.&nbsp;dynamic.</strong> Most financial networks evolve over time as ownership changes, directors rotate, and correlations shift. A temporal graph <span class="math inline">\(G_t = (V_t, E_t)\)</span> captures this evolution.</p>
<p><strong>Bipartite vs.&nbsp;unipartite.</strong> The raw data for many financial networks is bipartite: directors <span class="math inline">\(\times\)</span> firms, investors <span class="math inline">\(\times\)</span> stocks, banks <span class="math inline">\(\times\)</span> borrowers. The one-mode projection converts this to a unipartite graph: two firms are connected if they share a director, two stocks are connected if they share an institutional investor, etc.</p>
</section>
<section id="key-graph-metrics" class="level3" data-number="46.1.2">
<h3 data-number="46.1.2" class="anchored" data-anchor-id="key-graph-metrics"><span class="header-section-number">46.1.2</span> Key Graph Metrics</h3>
<p>For a graph <span class="math inline">\(G\)</span> with <span class="math inline">\(n = |V|\)</span> nodes and <span class="math inline">\(m = |E|\)</span> edges, we define the following metrics, each with a specific financial interpretation.</p>
<p><strong>Degree centrality.</strong> The degree <span class="math inline">\(k_i\)</span> of node <span class="math inline">\(i\)</span> is the number of edges incident to <span class="math inline">\(i\)</span>. In a directed graph, we distinguish in-degree <span class="math inline">\(k_i^{\text{in}}\)</span> (edges pointing to <span class="math inline">\(i\)</span>) and out-degree <span class="math inline">\(k_i^{\text{out}}\)</span> (edges from <span class="math inline">\(i\)</span>). Normalized degree centrality is:</p>
<p><span id="eq-degree-centrality"><span class="math display">\[
C_D(i) = \frac{k_i}{n - 1}
\tag{46.1}\]</span></span></p>
<p>In an ownership network, high out-degree means a firm owns stakes in many others (conglomerate); high in-degree means many entities own stakes in the firm (dispersed ownership).</p>
<p><strong>Betweenness centrality.</strong> The fraction of shortest paths between all pairs of nodes that pass through node <span class="math inline">\(i\)</span>:</p>
<p><span id="eq-betweenness"><span class="math display">\[
C_B(i) = \sum_{s \neq i \neq t} \frac{\sigma_{st}(i)}{\sigma_{st}}
\tag{46.2}\]</span></span></p>
<p>where <span class="math inline">\(\sigma_{st}\)</span> is the total number of shortest paths from <span class="math inline">\(s\)</span> to <span class="math inline">\(t\)</span> and <span class="math inline">\(\sigma_{st}(i)\)</span> is the number that pass through <span class="math inline">\(i\)</span>. High betweenness identifies ‚Äúbridge‚Äù nodes (i.e., firms or banks that connect otherwise disconnected parts of the financial system). The failure of a high-betweenness bank can fragment the interbank network.</p>
<p><strong>Eigenvector centrality.</strong> A node is central if it is connected to other central nodes. The eigenvector centrality is the solution to:</p>
<p><span id="eq-eigenvector-centrality"><span class="math display">\[
\lambda \mathbf{c} = A \mathbf{c}
\tag{46.3}\]</span></span></p>
<p>where <span class="math inline">\(A\)</span> is the adjacency matrix and <span class="math inline">\(\lambda\)</span> is the largest eigenvalue. Google‚Äôs PageRank is a regularized variant designed for directed graphs. In financial networks, eigenvector centrality identifies systemically important institutions (i.e., those connected to other important institutions).</p>
<p><strong>Clustering coefficient.</strong> The fraction of a node‚Äôs neighbors that are also neighbors of each other:</p>
<p><span id="eq-clustering"><span class="math display">\[
C_C(i) = \frac{2 T_i}{k_i(k_i - 1)}
\tag{46.4}\]</span></span></p>
<p>where <span class="math inline">\(T_i\)</span> is the number of triangles containing node <span class="math inline">\(i\)</span>. High clustering indicates tightly knit groups (e.g., business groups, lending circles, co-invested portfolios).</p>
<p><strong>Community structure.</strong> Many financial networks exhibit modular structure: groups of densely connected nodes with sparse connections between groups. Community detection algorithms (Louvain, label propagation, spectral clustering) identify these modules, which in financial networks often correspond to business groups, industry sectors, or lending clusters.</p>
<div id="graph-fundamentals" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_network_metrics(G):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute standard network metrics for a graph.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.Graph or nx.DiGraph</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Input graph.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Node-level and graph-level metrics.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    is_directed <span class="op">=</span> G.is_directed()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node-level metrics</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_directed:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        in_degree <span class="op">=</span> <span class="bu">dict</span>(G.in_degree())</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        out_degree <span class="op">=</span> <span class="bu">dict</span>(G.out_degree())</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        degree <span class="op">=</span> {n: in_degree[n] <span class="op">+</span> out_degree[n] <span class="cf">for</span> n <span class="kw">in</span> G.nodes()}</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        degree <span class="op">=</span> <span class="bu">dict</span>(G.degree())</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    betweenness <span class="op">=</span> nx.betweenness_centrality(G, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    eigenvector <span class="op">=</span> nx.eigenvector_centrality_numpy(</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        G, weight<span class="op">=</span><span class="st">"weight"</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> <span class="bu">len</span>(G) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> {}</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    clustering <span class="op">=</span> nx.clustering(G, weight<span class="op">=</span><span class="st">"weight"</span>) <span class="cf">if</span> <span class="kw">not</span> is_directed <span class="cf">else</span> {}</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PageRank (works for both directed and undirected)</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    pagerank <span class="op">=</span> nx.pagerank(G, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Graph-level metrics</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    n_nodes <span class="op">=</span> G.number_of_nodes()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    n_edges <span class="op">=</span> G.number_of_edges()</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    density <span class="op">=</span> nx.density(G)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connected components</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_directed:</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        n_weak_components <span class="op">=</span> nx.number_weakly_connected_components(G)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>        n_strong_components <span class="op">=</span> nx.number_strongly_connected_components(G)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        n_components <span class="op">=</span> nx.number_connected_components(G)</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degree distribution statistics</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    degrees <span class="op">=</span> <span class="bu">list</span>(degree.values())</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    avg_degree <span class="op">=</span> np.mean(degrees) <span class="cf">if</span> degrees <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    max_degree <span class="op">=</span> <span class="bu">max</span>(degrees) <span class="cf">if</span> degrees <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assortativity</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    assortativity <span class="op">=</span> nx.degree_assortativity_coefficient(G)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Community detection (Louvain)</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_directed:</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>            communities <span class="op">=</span> nx.community.louvain_communities(G)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>            modularity <span class="op">=</span> nx.community.modularity(G, communities)</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>            n_communities <span class="op">=</span> <span class="bu">len</span>(communities)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>            modularity, n_communities <span class="op">=</span> np.nan, <span class="dv">0</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>        modularity, n_communities <span class="op">=</span> np.nan, <span class="dv">0</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    node_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">"degree"</span>: degree,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">"betweenness"</span>: betweenness,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eigenvector"</span>: eigenvector,</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pagerank"</span>: pagerank,</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">"clustering"</span>: clustering <span class="cf">if</span> clustering <span class="cf">else</span> {n: np.nan <span class="cf">for</span> n <span class="kw">in</span> G.nodes()}</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    graph_metrics <span class="op">=</span> {</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_nodes"</span>: n_nodes,</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_edges"</span>: n_edges,</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"density"</span>: density,</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"avg_degree"</span>: avg_degree,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_degree"</span>: max_degree,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">"assortativity"</span>: assortativity,</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"modularity"</span>: modularity,</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_communities"</span>: n_communities</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node_metrics, graph_metrics</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="the-adjacency-matrix-and-its-spectral-properties" class="level3" data-number="46.1.3">
<h3 data-number="46.1.3" class="anchored" data-anchor-id="the-adjacency-matrix-and-its-spectral-properties"><span class="header-section-number">46.1.3</span> The Adjacency Matrix and Its Spectral Properties</h3>
<p>The adjacency matrix <span class="math inline">\(A \in \mathbb{R}^{n \times n}\)</span> encodes the graph structure: <span class="math inline">\(A_{ij} = w_{ij}\)</span> if there is an edge from <span class="math inline">\(i\)</span> to <span class="math inline">\(j\)</span> with weight <span class="math inline">\(w_{ij}\)</span>, and <span class="math inline">\(A_{ij} = 0\)</span> otherwise. For undirected graphs, <span class="math inline">\(A\)</span> is symmetric.</p>
<p>The graph Laplacian <span class="math inline">\(L = D - A\)</span> (where <span class="math inline">\(D\)</span> is the diagonal degree matrix) has eigenvalues <span class="math inline">\(0 = \lambda_1 \leq \lambda_2 \leq \ldots \leq \lambda_n\)</span> with important structural interpretations:</p>
<ul>
<li>The multiplicity of <span class="math inline">\(\lambda = 0\)</span> equals the number of connected components.</li>
<li>The second eigenvalue <span class="math inline">\(\lambda_2\)</span> (the algebraic connectivity or Fiedler value) measures how well-connected the graph is. Low <span class="math inline">\(\lambda_2\)</span> implies the graph has a bottleneck, which is a weak point where cutting a few edges would disconnect large portions.</li>
<li>The eigenvectors of <span class="math inline">\(L\)</span> provide the spectral embedding of the graph, which is the foundation for spectral clustering and graph convolutional networks.</li>
</ul>
<p>The normalized Laplacian <span class="math inline">\(\tilde{L} = D^{-1/2} L D^{-1/2}\)</span> is used in GCNs because it stabilizes message passing across nodes with different degrees.</p>
<div id="spectral-analysis" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_graph_analysis(A, n_components<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute spectral properties of a financial network.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    A : np.ndarray or sparse matrix</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjacency matrix.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of eigenvalues/vectors to compute.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Eigenvalues, algebraic connectivity, spectral gap.</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> A.shape[<span class="dv">0</span>]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sparse.issparse(A):</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        A_dense <span class="op">=</span> A.toarray()</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        A_dense <span class="op">=</span> A</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degree matrix</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> np.diag(A_dense.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Graph Laplacian</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> D <span class="op">-</span> A_dense</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized Laplacian</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    D_inv_sqrt <span class="op">=</span> np.diag(<span class="fl">1.0</span> <span class="op">/</span> np.sqrt(np.diag(D) <span class="op">+</span> <span class="fl">1e-10</span>))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    L_norm <span class="op">=</span> D_inv_sqrt <span class="op">@</span> L <span class="op">@</span> D_inv_sqrt</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Eigendecomposition (smallest eigenvalues)</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    eigenvalues, eigenvectors <span class="op">=</span> np.linalg.eigh(L_norm)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by eigenvalue</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.argsort(eigenvalues)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    eigenvalues <span class="op">=</span> eigenvalues[idx]</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    eigenvectors <span class="op">=</span> eigenvectors[:, idx]</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Algebraic connectivity (Fiedler value)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    fiedler_value <span class="op">=</span> eigenvalues[<span class="dv">1</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    fiedler_vector <span class="op">=</span> eigenvectors[:, <span class="dv">1</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> np.zeros(n)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Spectral gap</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    spectral_gap <span class="op">=</span> eigenvalues[<span class="dv">1</span>] <span class="op">-</span> eigenvalues[<span class="dv">0</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eigenvalues"</span>: eigenvalues[:n_components],</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fiedler_value"</span>: fiedler_value,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fiedler_vector"</span>: fiedler_vector,</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"spectral_gap"</span>: spectral_gap,</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"spectral_embedding"</span>: eigenvectors[:, <span class="dv">1</span>:n_components <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="ownership-and-control-networks" class="level2" data-number="46.2">
<h2 data-number="46.2" class="anchored" data-anchor-id="ownership-and-control-networks"><span class="header-section-number">46.2</span> Ownership and Control Networks</h2>
<section id="vietnamese-ownership-structure" class="level3" data-number="46.2.1">
<h3 data-number="46.2.1" class="anchored" data-anchor-id="vietnamese-ownership-structure"><span class="header-section-number">46.2.1</span> Vietnamese Ownership Structure</h3>
<p>Ownership networks are arguably the most economically consequential graph structure in Vietnamese markets. The Vietnamese corporate landscape is characterized by three distinctive features that generate complex ownership topologies:</p>
<p><strong>State ownership pyramids.</strong> The government holds equity in hundreds of firms through a hierarchy of holding entities: the State Capital Investment Corporation (SCIC), line ministries, provincial People‚Äôs Committees, and state-owned economic groups (t·∫≠p ƒëo√†n kinh t·∫ø nh√† n∆∞·ªõc). These chains create multi-layered pyramids where the state‚Äôs ultimate control rights may substantially exceed its cash flow rights.</p>
<p><strong>Private business groups.</strong> Vietnamese conglomerates (Vingroup, Masan, FPT, Ho√† Ph√°t, Thaco) create complex webs of cross-ownership, subsidiary relationships, and associate stakes. These structures serve multiple purposes: internal capital markets, tax optimization, regulatory arbitrage, and control enhancement.</p>
<p><strong>Circular and cross-ownership.</strong> Vietnamese regulations do not effectively prevent circular ownership (firm <span class="math inline">\(A\)</span> owns firm <span class="math inline">\(B\)</span> which owns firm <span class="math inline">\(C\)</span> which owns firm <span class="math inline">\(A\)</span>), creating loops in the ownership graph that amplify control beyond direct stakes and inflate accounting equity <span class="citation" data-cites="bebchuk1999rent">(<a href="references.html#ref-bebchuk1999rent" role="doc-biblioref">Bebchuk 1999</a>)</span>.</p>
<div id="ownership-network-data" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ownership data</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ownership <span class="op">=</span> dc.get_ownership_network(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    min_stake<span class="op">=</span><span class="fl">1.0</span>  <span class="co"># Minimum 1% ownership stake</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm characteristics</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>firms <span class="op">=</span> dc.get_firm_characteristics(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2024-01-01"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>).groupby(<span class="st">"ticker"</span>).last().reset_index()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Ownership edges: </span><span class="sc">{</span><span class="bu">len</span>(ownership)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique owners: </span><span class="sc">{</span>ownership[<span class="st">'owner_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique targets: </span><span class="sc">{</span>ownership[<span class="st">'target_ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="build-ownership-graph" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build directed ownership graph</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>G_own <span class="op">=</span> nx.DiGraph()</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add firm nodes with attributes</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> firms.iterrows():</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    G_own.add_node(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"ticker"</span>],</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        node_type<span class="op">=</span><span class="st">"firm"</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        market_cap<span class="op">=</span>row.get(<span class="st">"market_cap"</span>, <span class="dv">0</span>),</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        industry<span class="op">=</span>row.get(<span class="st">"industry"</span>, <span class="st">"Unknown"</span>),</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        is_soe<span class="op">=</span>row.get(<span class="st">"state_ownership_pct"</span>, <span class="dv">0</span>) <span class="op">&gt;</span> <span class="dv">50</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ownership edges</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> ownership.iterrows():</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    owner <span class="op">=</span> row[<span class="st">"owner_id"</span>]</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> row[<span class="st">"target_ticker"</span>]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    stake <span class="op">=</span> row[<span class="st">"ownership_pct"</span>]</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add owner node if not present</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> owner <span class="kw">not</span> <span class="kw">in</span> G_own:</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        G_own.add_node(</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            owner,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            node_type<span class="op">=</span>row.get(<span class="st">"owner_type"</span>, <span class="st">"entity"</span>),</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            market_cap<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            industry<span class="op">=</span><span class="st">"Holding"</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    G_own.add_edge(owner, target, weight<span class="op">=</span>stake <span class="op">/</span> <span class="dv">100</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>node_metrics_own, graph_metrics_own <span class="op">=</span> compute_network_metrics(G_own)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Ownership Network Summary:"</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> graph_metrics_own.items():</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-ownership-network-stats" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ownership-network-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.1: Ownership Network: Graph-Level Statistics
</figcaption>
<div aria-describedby="tbl-ownership-network-stats-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>own_stats <span class="op">=</span> pd.DataFrame([graph_metrics_own]).T</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>own_stats.columns <span class="op">=</span> [<span class="st">"Value"</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>own_stats <span class="op">=</span> own_stats.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>own_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
<section id="ultimate-ownership-and-control-chains" class="level3" data-number="46.2.2">
<h3 data-number="46.2.2" class="anchored" data-anchor-id="ultimate-ownership-and-control-chains"><span class="header-section-number">46.2.2</span> Ultimate Ownership and Control Chains</h3>
<p>Direct ownership understates the actual control exercised through pyramidal chains. The ultimate ownership stake of entity <span class="math inline">\(A\)</span> in firm <span class="math inline">\(Z\)</span> through a chain <span class="math inline">\(A \to B \to C \to Z\)</span> is the product of intermediate stakes:</p>
<p><span id="eq-ultimate-ownership"><span class="math display">\[
\omega_{A \to Z}^{\text{ultimate}} = \prod_{(i,j) \in \text{path}(A, Z)} w_{ij}
\tag{46.5}\]</span></span></p>
<p>where <span class="math inline">\(w_{ij}\)</span> is the direct stake of <span class="math inline">\(i\)</span> in <span class="math inline">\(j\)</span>. When multiple paths exist from <span class="math inline">\(A\)</span> to <span class="math inline">\(Z\)</span>, the total ultimate ownership is the sum across paths. The control rights, however, are determined by the weakest link in the chain (the minimum stake along the path), reflecting the principle that control requires a majority at each level.</p>
<div id="ultimate-ownership" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ultimate_ownership(G, source, target, max_depth<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute ultimate ownership of source in target through all paths.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership graph with edge weights as ownership fractions.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    source : str</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Ultimate owner node.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    target : str</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Target firm node.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    max_depth : int</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum chain length to consider.</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Total ownership, control rights, number of paths.</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> source <span class="kw">not</span> <span class="kw">in</span> G <span class="kw">or</span> target <span class="kw">not</span> <span class="kw">in</span> G:</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"ownership"</span>: <span class="dv">0</span>, <span class="st">"control"</span>: <span class="dv">0</span>, <span class="st">"n_paths"</span>: <span class="dv">0</span>}</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    total_ownership <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    max_control <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    n_paths <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find all simple paths from source to target</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> nx.all_simple_paths(G, source, target,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>                                         cutoff<span class="op">=</span>max_depth):</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Cash flow rights: product of stakes</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            ownership <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            min_stake <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(path) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>                edge_data <span class="op">=</span> G[path[i]][path[i <span class="op">+</span> <span class="dv">1</span>]]</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>                stake <span class="op">=</span> edge_data.get(<span class="st">"weight"</span>, <span class="dv">0</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>                ownership <span class="op">*=</span> stake</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>                min_stake <span class="op">=</span> <span class="bu">min</span>(min_stake, stake)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>            total_ownership <span class="op">+=</span> ownership</span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>            max_control <span class="op">=</span> <span class="bu">max</span>(max_control, min_stake)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            n_paths <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> nx.NetworkXNoPath:</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ownership"</span>: total_ownership,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"control"</span>: max_control,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_paths"</span>: n_paths</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_control_wedge(G, firms_list, max_depth<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the wedge between control and cash flow rights</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="co">    for the largest shareholder of each firm.</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co">    The wedge = control rights - cash flow rights.</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive wedge ‚Üí potential for tunneling.</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    wedge_data <span class="op">=</span> []</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> firm <span class="kw">in</span> firms_list:</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> firm <span class="kw">not</span> <span class="kw">in</span> G:</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find all direct owners</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>        predecessors <span class="op">=</span> <span class="bu">list</span>(G.predecessors(firm))</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> predecessors:</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find largest direct owner</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        stakes <span class="op">=</span> {p: G[p][firm][<span class="st">"weight"</span>] <span class="cf">for</span> p <span class="kw">in</span> predecessors}</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        largest_owner <span class="op">=</span> <span class="bu">max</span>(stakes, key<span class="op">=</span>stakes.get)</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        direct_stake <span class="op">=</span> stakes[largest_owner]</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute ultimate ownership through all paths</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        ultimate <span class="op">=</span> compute_ultimate_ownership(</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>            G, largest_owner, firm, max_depth</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        wedge_data.append({</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ticker"</span>: firm,</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">"largest_owner"</span>: largest_owner,</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            <span class="st">"direct_stake"</span>: direct_stake,</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ultimate_ownership"</span>: ultimate[<span class="st">"ownership"</span>],</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">"control_rights"</span>: ultimate[<span class="st">"control"</span>],</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_ownership_paths"</span>: ultimate[<span class="st">"n_paths"</span>],</span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">"wedge"</span>: ultimate[<span class="st">"control"</span>] <span class="op">-</span> ultimate[<span class="st">"ownership"</span>]</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(wedge_data)</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute for all listed firms</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>listed_firms <span class="op">=</span> [n <span class="cf">for</span> n, d <span class="kw">in</span> G_own.nodes(data<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> d.get(<span class="st">"node_type"</span>) <span class="op">==</span> <span class="st">"firm"</span>]</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>wedge_df <span class="op">=</span> compute_control_wedge(G_own, listed_firms)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-control-wedge" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="9">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-control-wedge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.2: Control-Cash Flow Wedge: Summary Statistics
</figcaption>
<div aria-describedby="tbl-control-wedge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>wedge_summary <span class="op">=</span> wedge_df[</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"direct_stake"</span>, <span class="st">"ultimate_ownership"</span>, <span class="st">"control_rights"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>     <span class="st">"n_ownership_paths"</span>, <span class="st">"wedge"</span>]</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>].describe(percentiles<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>]).T.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>wedge_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<div id="fig-control-wedge" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-control-wedge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(wedge_df, p9.aes(x<span class="op">=</span><span class="st">"wedge"</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Control Wedge (Control Rights ‚àí Cash Flow Rights)"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Control-Ownership Wedge: Positive Values Indicate Tunneling Risk"</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-control-wedge-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;46.1
</figcaption>
</figure>
</div>
</section>
<section id="ownership-centrality-and-firm-value" class="level3" data-number="46.2.3">
<h3 data-number="46.2.3" class="anchored" data-anchor-id="ownership-centrality-and-firm-value"><span class="header-section-number">46.2.3</span> Ownership Centrality and Firm Value</h3>
<p>We test whether a firm‚Äôs position in the ownership network predicts its market valuation, controlling for standard determinants:</p>
<p><span id="eq-network-valuation"><span class="math display">\[
Q_{i,t} = \beta_0 + \beta_1 \text{Centrality}_{i,t} + \beta_2 \text{Wedge}_{i,t} + \boldsymbol{\gamma}' \mathbf{X}_{i,t} + \alpha_{\text{ind}} + \delta_t + \varepsilon_{i,t}
\tag{46.6}\]</span></span></p>
<div id="ownership-valuation" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge network metrics with firm characteristics</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>node_metrics_own_df <span class="op">=</span> node_metrics_own.reset_index().rename(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"ticker"</span>}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>valuation_data <span class="op">=</span> firms.merge(node_metrics_own_df, on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>valuation_data <span class="op">=</span> valuation_data.merge(</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    wedge_df[[<span class="st">"ticker"</span>, <span class="st">"wedge"</span>, <span class="st">"n_ownership_paths"</span>]],</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel regression</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>val_clean <span class="op">=</span> valuation_data.dropna(</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"tobins_q"</span>, <span class="st">"eigenvector"</span>, <span class="st">"wedge"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_size"</span>, <span class="st">"profitability"</span>, <span class="st">"leverage"</span>]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(val_clean) <span class="op">&gt;</span> <span class="dv">50</span>:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    model_network_val <span class="op">=</span> sm.OLS(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        val_clean[<span class="st">"tobins_q"</span>],</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(val_clean[[</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"eigenvector"</span>, <span class="st">"betweenness"</span>, <span class="st">"wedge"</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_size"</span>, <span class="st">"profitability"</span>, <span class="st">"leverage"</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        ]])</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Ownership Network Position and Firm Value:"</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">"eigenvector"</span>, <span class="st">"betweenness"</span>, <span class="st">"wedge"</span>]:</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>model_network_val<span class="sc">.</span>params[var]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"(t = </span><span class="sc">{</span>model_network_val<span class="sc">.</span>tvalues[var]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="business-group-detection" class="level3" data-number="46.2.4">
<h3 data-number="46.2.4" class="anchored" data-anchor-id="business-group-detection"><span class="header-section-number">46.2.4</span> Business Group Detection</h3>
<p>Business groups (i.e., collections of legally independent firms linked by common ownership) are a defining feature of Vietnamese corporate structure. We detect them algorithmically using community detection on the ownership graph.</p>
<div id="business-groups" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_business_groups(G, min_group_size<span class="op">=</span><span class="dv">3</span>, ownership_threshold<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Detect business groups from ownership network.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    A business group is a connected component in the undirected</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    projection of the ownership graph, filtered for economically</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    meaningful ownership stakes.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Directed ownership graph.</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">    min_group_size : int</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum firms in a group.</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_threshold : float</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum ownership stake to count as a link.</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Group assignments with apex firm.</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter edges by threshold</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    G_filtered <span class="op">=</span> nx.DiGraph()</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u, v, d <span class="kw">in</span> G.edges(data<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d.get(<span class="st">"weight"</span>, <span class="dv">0</span>) <span class="op">&gt;=</span> ownership_threshold:</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>            G_filtered.add_edge(u, v, <span class="op">**</span>d)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to undirected for component detection</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    G_undirected <span class="op">=</span> G_filtered.to_undirected()</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find connected components</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    components <span class="op">=</span> <span class="bu">list</span>(nx.connected_components(G_undirected))</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter by size</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    groups <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> components <span class="cf">if</span> <span class="bu">len</span>(c) <span class="op">&gt;=</span> min_group_size]</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each group, identify the apex (top of pyramid)</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    group_data <span class="op">=</span> []</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> group_id, members <span class="kw">in</span> <span class="bu">enumerate</span>(groups):</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        subgraph <span class="op">=</span> G_filtered.subgraph(members)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apex: node with highest out-degree and lowest in-degree</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (controls others but is not controlled)</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> {}</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> node <span class="kw">in</span> members:</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>            in_deg <span class="op">=</span> subgraph.in_degree(node)</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>            out_deg <span class="op">=</span> subgraph.out_degree(node)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>            scores[node] <span class="op">=</span> out_deg <span class="op">-</span> in_deg</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        apex <span class="op">=</span> <span class="bu">max</span>(scores, key<span class="op">=</span>scores.get) <span class="cf">if</span> scores <span class="cf">else</span> <span class="bu">list</span>(members)[<span class="dv">0</span>]</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> member <span class="kw">in</span> members:</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            node_data <span class="op">=</span> G.nodes.get(member, {})</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>            group_data.append({</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ticker"</span>: member,</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">"group_id"</span>: group_id,</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>                <span class="st">"group_size"</span>: <span class="bu">len</span>(members),</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>                <span class="st">"apex"</span>: apex,</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>                <span class="st">"is_apex"</span>: member <span class="op">==</span> apex,</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">"node_type"</span>: node_data.get(<span class="st">"node_type"</span>, <span class="st">"unknown"</span>),</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>                <span class="st">"industry"</span>: node_data.get(<span class="st">"industry"</span>, <span class="st">"Unknown"</span>),</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>                <span class="st">"market_cap"</span>: node_data.get(<span class="st">"market_cap"</span>, <span class="dv">0</span>)</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(group_data)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>groups_df <span class="op">=</span> detect_business_groups(G_own)</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Business groups detected: </span><span class="sc">{</span>groups_df[<span class="st">'group_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms in groups: </span><span class="sc">{</span><span class="bu">len</span>(groups_df[groups_df[<span class="st">'node_type'</span>] <span class="op">==</span> <span class="st">'firm'</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-business-groups" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-business-groups-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.3: Largest Vietnamese Business Groups by Ownership Network Analysis
</figcaption>
<div aria-describedby="tbl-business-groups-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>top_groups <span class="op">=</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    groups_df.groupby(<span class="st">"group_id"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        apex<span class="op">=</span>(<span class="st">"apex"</span>, <span class="st">"first"</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        n_members<span class="op">=</span>(<span class="st">"ticker"</span>, <span class="st">"count"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        n_listed<span class="op">=</span>(<span class="st">"node_type"</span>, <span class="kw">lambda</span> x: (x <span class="op">==</span> <span class="st">"firm"</span>).<span class="bu">sum</span>()),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        total_mcap<span class="op">=</span>(<span class="st">"market_cap"</span>, <span class="st">"sum"</span>),</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        industries<span class="op">=</span>(<span class="st">"industry"</span>, <span class="kw">lambda</span> x: x.nunique())</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"total_mcap"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">15</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>top_groups[<span class="st">"total_mcap_bn"</span>] <span class="op">=</span> top_groups[<span class="st">"total_mcap"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>top_groups[[<span class="st">"apex"</span>, <span class="st">"n_members"</span>, <span class="st">"n_listed"</span>, <span class="st">"total_mcap_bn"</span>, <span class="st">"industries"</span>]]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
</section>
<section id="board-interlock-networks" class="level2" data-number="46.3">
<h2 data-number="46.3" class="anchored" data-anchor-id="board-interlock-networks"><span class="header-section-number">46.3</span> Board Interlock Networks</h2>
<section id="construction" class="level3" data-number="46.3.1">
<h3 data-number="46.3.1" class="anchored" data-anchor-id="construction"><span class="header-section-number">46.3.1</span> Construction</h3>
<p>A board interlock exists when a director serves on the boards of two or more firms simultaneously. The board interlock network is a unipartite projection of the bipartite director<span class="math inline">\(\times\)</span>firm graph: two firms are connected if they share at least one director, weighted by the number of shared directors.</p>
<p>Board interlocks are an information channel. <span class="citation" data-cites="bizjak2008does">Bizjak, Lemmon, and Naveen (<a href="references.html#ref-bizjak2008does" role="doc-biblioref">2008</a>)</span> show that compensation practices diffuse through board networks. <span class="citation" data-cites="cai2014board">Cai et al. (<a href="references.html#ref-cai2014board" role="doc-biblioref">2014</a>)</span> demonstrate that firms connected through interlocks have correlated investment policies. In Vietnamese markets, interlocks often follow ownership lines (e.g., the parent company appoints directors to subsidiary boards), creating a governance channel that reinforces the ownership channel.</p>
<div id="board-interlock-data" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load board membership data</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>board_data <span class="op">=</span> dc.get_board_memberships(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Director-firm pairs: </span><span class="sc">{</span><span class="bu">len</span>(board_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique directors: </span><span class="sc">{</span>board_data[<span class="st">'director_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>board_data[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Build bipartite graph</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> nx.Graph()</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> board_data.iterrows():</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    B.add_node(row[<span class="st">"director_id"</span>], bipartite<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    B.add_node(row[<span class="st">"ticker"</span>], bipartite<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    B.add_edge(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"director_id"</span>], row[<span class="st">"ticker"</span>],</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>row.get(<span class="st">"role"</span>, <span class="st">"director"</span>),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        is_independent<span class="op">=</span>row.get(<span class="st">"is_independent"</span>, <span class="va">False</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Project to firm-firm interlock network</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>firm_nodes <span class="op">=</span> [n <span class="cf">for</span> n, d <span class="kw">in</span> B.nodes(data<span class="op">=</span><span class="va">True</span>) <span class="cf">if</span> d.get(<span class="st">"bipartite"</span>) <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>G_interlock <span class="op">=</span> nx.bipartite.weighted_projected_graph(B, firm_nodes)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Edge weight = number of shared directors</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>interlock_metrics, interlock_graph <span class="op">=</span> compute_network_metrics(G_interlock)</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Board Interlock Network:"</span>)</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Firms: </span><span class="sc">{</span>G_interlock<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Interlocking pairs: </span><span class="sc">{</span>G_interlock<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Density: </span><span class="sc">{</span>nx<span class="sc">.</span>density(G_interlock)<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="interlock-vs-ownership" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do board interlocks follow ownership lines?</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare interlock edges with ownership edges</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>interlock_edges <span class="op">=</span> <span class="bu">set</span>(G_interlock.edges())</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>ownership_edges_undirected <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> u, v <span class="kw">in</span> G_own.edges():</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> u <span class="kw">in</span> firm_nodes <span class="kw">and</span> v <span class="kw">in</span> firm_nodes:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        ownership_edges_undirected.add((<span class="bu">min</span>(u, v), <span class="bu">max</span>(u, v)))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>interlock_edges_normalized <span class="op">=</span> {</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    (<span class="bu">min</span>(u, v), <span class="bu">max</span>(u, v)) <span class="cf">for</span> u, v <span class="kw">in</span> interlock_edges</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>overlap <span class="op">=</span> interlock_edges_normalized <span class="op">&amp;</span> ownership_edges_undirected</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>n_interlock <span class="op">=</span> <span class="bu">len</span>(interlock_edges_normalized)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>n_ownership <span class="op">=</span> <span class="bu">len</span>(ownership_edges_undirected)</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>n_overlap <span class="op">=</span> <span class="bu">len</span>(overlap)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Interlock edges: </span><span class="sc">{</span>n_interlock<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Ownership edges (firm-firm): </span><span class="sc">{</span>n_ownership<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overlap: </span><span class="sc">{</span>n_overlap<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_interlock <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fraction of interlocks with ownership link: "</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>n_overlap <span class="op">/</span> n_interlock<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="interlocks-and-return-co-movement" class="level3" data-number="46.3.2">
<h3 data-number="46.3.2" class="anchored" data-anchor-id="interlocks-and-return-co-movement"><span class="header-section-number">46.3.2</span> Interlocks and Return Co-Movement</h3>
<p>If board interlocks serve as information channels, firms connected through interlocks should exhibit excess return co-movement beyond what is explained by shared industry or size characteristics. We test this using the methodology of <span class="citation" data-cites="cohen2008economic">Cohen and Frazzini (<a href="references.html#ref-cohen2008economic" role="doc-biblioref">2008</a>)</span>:</p>
<p><span id="eq-interlock-comovement"><span class="math display">\[
\rho_{ij,t} = \alpha + \beta \cdot \text{Interlock}_{ij,t} + \gamma \cdot \text{SameIndustry}_{ij} + \delta \cdot \text{SizeProximity}_{ij,t} + \varepsilon_{ij,t}
\tag{46.7}\]</span></span></p>
<div id="interlock-comovement" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute pairwise return correlations for interlocked and non-interlocked pairs</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> dc.get_monthly_returns(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to wide format</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>returns_wide <span class="op">=</span> monthly_returns.pivot(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"ticker"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>).dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> returns_wide.corr()</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare correlations: interlocked vs non-interlocked</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>interlock_corrs <span class="op">=</span> []</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>non_interlock_corrs <span class="op">=</span> []</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>tickers_in_both <span class="op">=</span> <span class="bu">set</span>(corr_matrix.columns) <span class="op">&amp;</span> <span class="bu">set</span>(G_interlock.nodes())</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ticker_i <span class="kw">in</span> <span class="bu">enumerate</span>(tickers_in_both):</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker_j <span class="kw">in</span> <span class="bu">list</span>(tickers_in_both)[i <span class="op">+</span> <span class="dv">1</span>:]:</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        corr <span class="op">=</span> corr_matrix.loc[ticker_i, ticker_j]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(corr):</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> G_interlock.has_edge(ticker_i, ticker_j):</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>            interlock_corrs.append(corr)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>            non_interlock_corrs.append(corr)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> interlock_corrs <span class="kw">and</span> non_interlock_corrs:</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    t_stat, p_val <span class="op">=</span> stats.ttest_ind(interlock_corrs, non_interlock_corrs)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Interlocked pairs: n=</span><span class="sc">{</span><span class="bu">len</span>(interlock_corrs)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"mean corr=</span><span class="sc">{</span>np<span class="sc">.</span>mean(interlock_corrs)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Non-interlocked: n=</span><span class="sc">{</span><span class="bu">len</span>(non_interlock_corrs)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"mean corr=</span><span class="sc">{</span>np<span class="sc">.</span>mean(non_interlock_corrs)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Difference t-stat: </span><span class="sc">{</span>t_stat<span class="sc">:.3f}</span><span class="ss">, p-value: </span><span class="sc">{</span>p_val<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="supply-chain-and-trade-networks" class="level2" data-number="46.4">
<h2 data-number="46.4" class="anchored" data-anchor-id="supply-chain-and-trade-networks"><span class="header-section-number">46.4</span> Supply Chain and Trade Networks</h2>
<section id="constructing-the-supply-chain-graph" class="level3" data-number="46.4.1">
<h3 data-number="46.4.1" class="anchored" data-anchor-id="constructing-the-supply-chain-graph"><span class="header-section-number">46.4.1</span> Constructing the Supply Chain Graph</h3>
<p>Supply chain relationships (customer-supplier linkages) represent real economic connections through which shocks propagate. <span class="citation" data-cites="acemoglu2015systemic">Acemoglu, Ozdaglar, and Tahbaz-Salehi (<a href="references.html#ref-acemoglu2015systemic" role="doc-biblioref">2015</a>)</span> demonstrate theoretically that in the presence of supply chain linkages, idiosyncratic shocks to individual firms can generate aggregate fluctuations rather than washing out. <span class="citation" data-cites="cohen2008economic">Cohen and Frazzini (<a href="references.html#ref-cohen2008economic" role="doc-biblioref">2008</a>)</span> and <span class="citation" data-cites="menzly2010market">Menzly and Ozbas (<a href="references.html#ref-menzly2010market" role="doc-biblioref">2010</a>)</span> show that supply chain connections predict cross-sectional return differences: when a major customer‚Äôs stock drops, its suppliers‚Äô stocks follow with a delay.</p>
<div id="supply-chain-data" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load supply chain data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>supply_chain <span class="op">=</span> dc.get_supply_chain_data(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Build directed supply chain graph</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>G_supply <span class="op">=</span> nx.DiGraph()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> supply_chain.iterrows():</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    G_supply.add_edge(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"supplier_ticker"</span>],</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"customer_ticker"</span>],</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>        weight<span class="op">=</span>row.get(<span class="st">"transaction_value"</span>, <span class="dv">1</span>),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        pct_of_supplier_revenue<span class="op">=</span>row.get(<span class="st">"pct_supplier_revenue"</span>, <span class="dv">0</span>),</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        pct_of_customer_cogs<span class="op">=</span>row.get(<span class="st">"pct_customer_cogs"</span>, <span class="dv">0</span>),</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        year<span class="op">=</span>row.get(<span class="st">"year"</span>, <span class="dv">2024</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Supply chain links: </span><span class="sc">{</span>G_supply<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms involved: </span><span class="sc">{</span>G_supply<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="customer-momentum" class="level3" data-number="46.4.2">
<h3 data-number="46.4.2" class="anchored" data-anchor-id="customer-momentum"><span class="header-section-number">46.4.2</span> Customer Momentum</h3>
<p>The ‚Äúcustomer momentum‚Äù strategy of <span class="citation" data-cites="cohen2008economic">Cohen and Frazzini (<a href="references.html#ref-cohen2008economic" role="doc-biblioref">2008</a>)</span> exploits the delayed propagation of information through supply chains. When a customer firm‚Äôs stock rises, its suppliers‚Äô stocks tend to follow in subsequent months:</p>
<p><span id="eq-customer-momentum"><span class="math display">\[
r_{i,t+1} = \alpha + \beta \cdot \text{CustomerReturn}_{i,t} + \gamma \cdot r_{i,t} + \boldsymbol{\delta}' \mathbf{X}_{i,t} + \varepsilon_{i,t}
\tag{46.8}\]</span></span></p>
<p>where <span class="math inline">\(\text{CustomerReturn}_{i,t} = \sum_{j \in \text{Customers}(i)} w_{ij} \cdot r_{j,t}\)</span> is the weighted average return of firm <span class="math inline">\(i\)</span>‚Äôs customers.</p>
<div id="customer-momentum" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute customer-weighted returns for each supplier</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_customer_returns(supply_graph, monthly_returns):</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute customer-weighted returns for each supplier firm.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each supplier, compute weighted average customer return</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date <span class="kw">in</span> monthly_returns[<span class="st">"date"</span>].unique():</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        date_returns <span class="op">=</span> monthly_returns[monthly_returns[<span class="st">"date"</span>] <span class="op">==</span> date]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        ret_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(date_returns[<span class="st">"ticker"</span>], date_returns[<span class="st">"ret"</span>]))</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> supplier <span class="kw">in</span> supply_graph.nodes():</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            customers <span class="op">=</span> <span class="bu">list</span>(supply_graph.successors(supplier))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> customers:</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>            customer_rets <span class="op">=</span> []</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>            customer_weights <span class="op">=</span> []</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cust <span class="kw">in</span> customers:</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> cust <span class="kw">in</span> ret_dict:</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>                    edge_data <span class="op">=</span> supply_graph[supplier][cust]</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>                    weight <span class="op">=</span> edge_data.get(<span class="st">"pct_of_supplier_revenue"</span>, <span class="dv">1</span>)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>                    customer_rets.append(ret_dict[cust])</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>                    customer_weights.append(weight)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> customer_rets:</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>                weights <span class="op">=</span> np.array(customer_weights)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> weights.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>                    weights <span class="op">=</span> weights <span class="op">/</span> weights.<span class="bu">sum</span>()</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>                    weights <span class="op">=</span> np.ones(<span class="bu">len</span>(weights)) <span class="op">/</span> <span class="bu">len</span>(weights)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>                weighted_ret <span class="op">=</span> np.average(customer_rets, weights<span class="op">=</span>weights)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>                results.append({</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"date"</span>: date,</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"ticker"</span>: supplier,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"customer_ret"</span>: weighted_ret,</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_customers"</span>: <span class="bu">len</span>(customer_rets)</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>customer_rets <span class="op">=</span> compute_customer_returns(G_supply, monthly_returns)</span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with own returns and lag</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>momentum_data <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    customer_rets, on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>], how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>momentum_data <span class="op">=</span> momentum_data.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"own_ret_lag"</span>] <span class="op">=</span> momentum_data.groupby(<span class="st">"ticker"</span>)[<span class="st">"ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"customer_ret_lag"</span>] <span class="op">=</span> momentum_data.groupby(</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticker"</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"customer_ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"ret_lead"</span>] <span class="op">=</span> momentum_data.groupby(<span class="st">"ticker"</span>)[<span class="st">"ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression</span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>mom_clean <span class="op">=</span> momentum_data.dropna(</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"ret_lead"</span>, <span class="st">"customer_ret_lag"</span>, <span class="st">"own_ret_lag"</span>]</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>model_mom <span class="op">=</span> sm.OLS(</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    mom_clean[<span class="st">"ret_lead"</span>],</span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    sm.add_constant(mom_clean[[<span class="st">"customer_ret_lag"</span>, <span class="st">"own_ret_lag"</span>]])</span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"cluster"</span>, cov_kwds<span class="op">=</span>{<span class="st">"groups"</span>: mom_clean[<span class="st">"ticker"</span>]})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-customer-momentum" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="19">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-customer-momentum-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.4: Customer Momentum: Supplier Returns Predicted by Customer Returns
</figcaption>
<div aria-describedby="tbl-customer-momentum-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mom_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: model_mom.params.<span class="bu">round</span>(<span class="dv">4</span>),</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: model_mom.bse.<span class="bu">round</span>(<span class="dv">4</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: model_mom.tvalues.<span class="bu">round</span>(<span class="dv">3</span>),</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: model_mom.pvalues.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>mom_results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
<section id="network-propagation-shock-diffusion-through-supply-chains" class="level3" data-number="46.4.3">
<h3 data-number="46.4.3" class="anchored" data-anchor-id="network-propagation-shock-diffusion-through-supply-chains"><span class="header-section-number">46.4.3</span> Network Propagation: Shock Diffusion Through Supply Chains</h3>
<p>The <span class="citation" data-cites="acemoglu2015systemic">Acemoglu, Ozdaglar, and Tahbaz-Salehi (<a href="references.html#ref-acemoglu2015systemic" role="doc-biblioref">2015</a>)</span> model predicts that the aggregate effect of an idiosyncratic shock depends on the network‚Äôs topology. In a star network (one central hub), hub shocks generate aggregate fluctuations. In a symmetric network, shocks cancel out. We implement a simulation-based approach to measure shock propagation in the Vietnamese supply chain.</p>
<div id="shock-propagation" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_shock_propagation(G, shocked_node, shock_size<span class="op">=-</span><span class="fl">0.10</span>,</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                                decay<span class="op">=</span><span class="fl">0.5</span>, max_steps<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate the propagation of an idiosyncratic shock through</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    a supply chain network.</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Supply chain graph (supplier ‚Üí customer).</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    shocked_node : str</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Node receiving the initial shock.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    shock_size : float</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Initial shock magnitude (e.g., -0.10 = -10% revenue shock).</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    decay : float</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Fraction of shock transmitted per link (0 &lt; decay &lt; 1).</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">    max_steps : int</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum propagation steps.</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : {node: cumulative shock received}.</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    shocks <span class="op">=</span> {shocked_node: shock_size}</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    frontier <span class="op">=</span> {shocked_node}</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(max_steps):</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        new_frontier <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> node <span class="kw">in</span> frontier:</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagate to customers (downstream)</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> customer <span class="kw">in</span> G.successors(node):</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>                edge_weight <span class="op">=</span> G[node][customer].get(</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pct_of_customer_cogs"</span>, <span class="fl">0.1</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>                transmitted <span class="op">=</span> shocks[node] <span class="op">*</span> decay <span class="op">*</span> edge_weight</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(transmitted) <span class="op">&gt;</span> <span class="fl">0.001</span>:</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>                    shocks[customer] <span class="op">=</span> shocks.get(customer, <span class="dv">0</span>) <span class="op">+</span> transmitted</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>                    new_frontier.add(customer)</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagate to suppliers (upstream)</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> supplier <span class="kw">in</span> G.predecessors(node):</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>                edge_weight <span class="op">=</span> G[supplier][node].get(</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pct_of_supplier_revenue"</span>, <span class="fl">0.1</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>                transmitted <span class="op">=</span> shocks[node] <span class="op">*</span> decay <span class="op">*</span> edge_weight</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(transmitted) <span class="op">&gt;</span> <span class="fl">0.001</span>:</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>                    shocks[supplier] <span class="op">=</span> shocks.get(supplier, <span class="dv">0</span>) <span class="op">+</span> transmitted</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>                    new_frontier.add(supplier)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>        frontier <span class="op">=</span> new_frontier</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> frontier:</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shocks</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify systemically important supply chain nodes</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a><span class="co"># (Those whose shock has largest aggregate impact)</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>systemic_importance <span class="op">=</span> {}</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>listed_in_supply <span class="op">=</span> [n <span class="cf">for</span> n <span class="kw">in</span> G_supply.nodes()</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> n <span class="kw">in</span> <span class="bu">set</span>(firms[<span class="st">"ticker"</span>])]</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> firm <span class="kw">in</span> listed_in_supply[:<span class="dv">100</span>]:  <span class="co"># Sample for computational feasibility</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    shocks <span class="op">=</span> simulate_shock_propagation(G_supply, firm, <span class="op">-</span><span class="fl">0.10</span>)</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    aggregate_impact <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">abs</span>(v) <span class="cf">for</span> k, v <span class="kw">in</span> shocks.items() <span class="cf">if</span> k <span class="op">!=</span> firm)</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    systemic_importance[firm] <span class="op">=</span> aggregate_impact</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>systemic_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(systemic_importance.items()),</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"systemic_impact"</span>]</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>).sort_values(<span class="st">"systemic_impact"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-systemic-supply-chain" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-systemic-supply-chain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.5: Most Systemically Important Firms in the Supply Chain Network
</figcaption>
<div aria-describedby="tbl-systemic-supply-chain-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>top_systemic <span class="op">=</span> systemic_df.head(<span class="dv">20</span>).merge(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    firms[[<span class="st">"ticker"</span>, <span class="st">"industry"</span>, <span class="st">"market_cap"</span>]],</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>top_systemic[<span class="st">"market_cap_bn"</span>] <span class="op">=</span> top_systemic[<span class="st">"market_cap"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>top_systemic[[<span class="st">"ticker"</span>, <span class="st">"industry"</span>, <span class="st">"market_cap_bn"</span>, <span class="st">"systemic_impact"</span>]].<span class="bu">round</span>(<span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
</section>
<section id="correlation-and-co-movement-networks" class="level2" data-number="46.5">
<h2 data-number="46.5" class="anchored" data-anchor-id="correlation-and-co-movement-networks"><span class="header-section-number">46.5</span> Correlation and Co-Movement Networks</h2>
<section id="construction-from-return-data" class="level3" data-number="46.5.1">
<h3 data-number="46.5.1" class="anchored" data-anchor-id="construction-from-return-data"><span class="header-section-number">46.5.1</span> Construction from Return Data</h3>
<p>A correlation network connects assets whose returns co-move. This is perhaps the most widely used financial network because it requires only return data‚Äîno proprietary ownership or supply chain information. The standard construction involves three steps:</p>
<ol type="1">
<li><p><strong>Compute pairwise correlations.</strong> For <span class="math inline">\(n\)</span> assets over <span class="math inline">\(T\)</span> periods, the sample correlation matrix <span class="math inline">\(\hat{\rho} \in \mathbb{R}^{n \times n}\)</span> has <span class="math inline">\(n(n-1)/2\)</span> unique entries.</p></li>
<li><p><strong>Threshold or transform.</strong> Convert the dense correlation matrix into a sparse graph. Common approaches: hard threshold (<span class="math inline">\(\rho_{ij} &gt; \bar{\rho}\)</span>), Minimum Spanning Tree (MST), or Planar Maximally Filtered Graph (PMFG).</p></li>
<li><p><strong>Analyze the graph.</strong> Community detection reveals sector clustering; centrality identifies market bellwethers; temporal evolution tracks regime changes.</p></li>
</ol>
<div id="correlation-network" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute correlation matrix from daily returns</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_returns.pivot(</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"ticker"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>).dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> daily_wide.corr()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum Spanning Tree (MST)</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert correlation to distance: d = sqrt(2(1-œÅ))</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> corr.values))</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>np.fill_diagonal(dist, <span class="dv">0</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete graph with distances</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>G_complete <span class="op">=</span> nx.Graph()</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>tickers <span class="op">=</span> <span class="bu">list</span>(corr.columns)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tickers)):</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(tickers)):</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        G_complete.add_edge(</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            tickers[i], tickers[j],</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">=</span>dist[i, j],</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>            correlation<span class="op">=</span>corr.iloc[i, j]</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="co"># MST</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>G_mst <span class="op">=</span> nx.minimum_spanning_tree(G_complete, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Thresholded correlation network</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>G_corr <span class="op">=</span> nx.Graph()</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tickers)):</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(tickers)):</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> corr.iloc[i, j] <span class="op">&gt;</span> threshold:</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            G_corr.add_edge(</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>                tickers[i], tickers[j],</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span>corr.iloc[i, j]</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MST: </span><span class="sc">{</span>G_mst<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss"> nodes, "</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_mst<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss"> edges"</span>)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Corr network (œÅ &gt; </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">): "</span></span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_corr<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss"> nodes, "</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_corr<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss"> edges"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="the-diebold-yilmaz-connectedness-framework" class="level3" data-number="46.5.2">
<h3 data-number="46.5.2" class="anchored" data-anchor-id="the-diebold-yilmaz-connectedness-framework"><span class="header-section-number">46.5.2</span> The Diebold-Yilmaz Connectedness Framework</h3>
<p><span class="citation" data-cites="diebold2014network">Diebold and Yƒ±lmaz (<a href="references.html#ref-diebold2014network" role="doc-biblioref">2014</a>)</span> propose measuring financial connectedness using the variance decomposition from a vector autoregression (VAR). The fraction of the <span class="math inline">\(H\)</span>-step-ahead forecast error variance of variable <span class="math inline">\(i\)</span> attributable to shocks from variable <span class="math inline">\(j\)</span> defines the pairwise directional connectedness:</p>
<p><span id="eq-dy-connectedness"><span class="math display">\[
C_{i \leftarrow j}(H) = \frac{\tilde{\theta}_{ij}^g(H)}{\sum_{j=1}^{n} \tilde{\theta}_{ij}^g(H)} \times 100
\tag{46.9}\]</span></span></p>
<p>where <span class="math inline">\(\tilde{\theta}_{ij}^g(H)\)</span> is the generalized forecast error variance decomposition. The total connectedness index (TCI) aggregates across all pairs:</p>
<p><span id="eq-tci"><span class="math display">\[
\text{TCI}(H) = \frac{\sum_{i \neq j} C_{i \leftarrow j}(H)}{\sum_{i,j} C_{i \leftarrow j}(H)} \times 100
\tag{46.10}\]</span></span></p>
<p>High TCI indicates a tightly connected system where shocks propagate widely; low TCI indicates relative isolation.</p>
<div id="diebold-yilmaz" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diebold_yilmaz_connectedness(returns_df, var_order<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                                  forecast_horizon<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the Diebold-Yilmaz (2014) connectedness table.</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns with columns as assets, index as dates.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    var_order : int</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">        VAR lag order.</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_horizon : int</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Forecast horizon for variance decomposition.</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Connectedness matrix, TCI, TO/FROM measures.</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> statsmodels.tsa.api <span class="im">import</span> VAR</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit VAR</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> VAR(returns_df.dropna())</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> model.fit(var_order)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generalized Forecast Error Variance Decomposition</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    fevd <span class="op">=</span> results.fevd(forecast_horizon)</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract decomposition matrix at horizon H</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> returns_df.shape[<span class="dv">1</span>]</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> np.zeros((n, n))</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>        decomp <span class="op">=</span> fevd.decomp[i]  <span class="co"># H x n array</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        C[i, :] <span class="op">=</span> decomp[<span class="op">-</span><span class="dv">1</span>, :]  <span class="co"># Take horizon H values</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize rows to sum to 100</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    row_sums <span class="op">=</span> C.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    C_norm <span class="op">=</span> C <span class="op">/</span> row_sums <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connectedness measures</span></span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FROM: how much of i's variance comes from others</span></span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    FROM <span class="op">=</span> C_norm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">-</span> np.diag(C_norm)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TO: how much of others' variance comes from i</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    TO <span class="op">=</span> C_norm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">-</span> np.diag(C_norm)</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NET = TO - FROM</span></span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    NET <span class="op">=</span> TO <span class="op">-</span> FROM</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total Connectedness Index</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>    TCI <span class="op">=</span> FROM.<span class="bu">sum</span>() <span class="op">/</span> n</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> returns_df.columns.tolist()</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    connectedness_df <span class="op">=</span> pd.DataFrame(C_norm, index<span class="op">=</span>names, columns<span class="op">=</span>names)</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>    connectedness_df[<span class="st">"FROM_others"</span>] <span class="op">=</span> FROM</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    connectedness_df.loc[<span class="st">"TO_others"</span>] <span class="op">=</span> <span class="bu">list</span>(TO) <span class="op">+</span> [TCI]</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectedness_matrix"</span>: connectedness_df,</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TCI"</span>: TCI,</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">"FROM"</span>: pd.Series(FROM, index<span class="op">=</span>names),</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TO"</span>: pd.Series(TO, index<span class="op">=</span>names),</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NET"</span>: pd.Series(NET, index<span class="op">=</span>names)</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to top Vietnamese stocks by liquidity</span></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>top_stocks <span class="op">=</span> (</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>    daily_returns.groupby(<span class="st">"ticker"</span>)[<span class="st">"volume"</span>]</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">20</span>)</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    .index</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>top_returns <span class="op">=</span> daily_wide[</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>    [c <span class="cf">for</span> c <span class="kw">in</span> top_stocks <span class="cf">if</span> c <span class="kw">in</span> daily_wide.columns]</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>].dropna()</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>dy_results <span class="op">=</span> diebold_yilmaz_connectedness(top_returns)</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Connectedness Index: </span><span class="sc">{</span>dy_results[<span class="st">'TCI'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-connectedness" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="24">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-connectedness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.6: Diebold-Yilmaz Net Connectedness: Net Transmitters (+) and Receivers (‚àí)
</figcaption>
<div aria-describedby="tbl-connectedness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>net_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TO_others"</span>: dy_results[<span class="st">"TO"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FROM_others"</span>: dy_results[<span class="st">"FROM"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NET"</span>: dy_results[<span class="st">"NET"</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">"NET"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>net_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<div id="rolling-connectedness" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling TCI to track systemic risk over time</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_tci(returns_wide, window<span class="op">=</span><span class="dv">252</span>, step<span class="op">=</span><span class="dv">21</span>, var_order<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>                 forecast_horizon<span class="op">=</span><span class="dv">10</span>, min_stocks<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling Total Connectedness Index."""</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> returns_wide.index</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    tci_series <span class="op">=</span> []</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(window, <span class="bu">len</span>(dates), step):</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> returns_wide.iloc[i <span class="op">-</span> window:i]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep stocks with sufficient data</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        valid_cols <span class="op">=</span> window_data.dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="bu">int</span>(window <span class="op">*</span> <span class="fl">0.9</span>))</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> valid_cols.shape[<span class="dv">1</span>] <span class="op">&lt;</span> min_stocks:</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use top stocks by variance (most informative)</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>        top_cols <span class="op">=</span> valid_cols.var().nlargest(min_stocks).index</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> valid_cols[top_cols].dropna()</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> window <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> diebold_yilmaz_connectedness(</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                subset, var_order, forecast_horizon</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>            tci_series.append({</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"date"</span>: dates[i],</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"TCI"</span>: result[<span class="st">"TCI"</span>],</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_stocks"</span>: <span class="bu">len</span>(top_cols)</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(tci_series)</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a><span class="co"># tci_df = rolling_tci(daily_wide, window=252, step=21)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="interbank-and-financial-contagion-networks" class="level2" data-number="46.6">
<h2 data-number="46.6" class="anchored" data-anchor-id="interbank-and-financial-contagion-networks"><span class="header-section-number">46.6</span> Interbank and Financial Contagion Networks</h2>
<section id="the-interbank-market-as-a-network" class="level3" data-number="46.6.1">
<h3 data-number="46.6.1" class="anchored" data-anchor-id="the-interbank-market-as-a-network"><span class="header-section-number">46.6.1</span> The Interbank Market as a Network</h3>
<p>The interbank market, where banks lend reserves to each other, is the canonical financial network. <span class="citation" data-cites="allen2000financial">Allen and Gale (<a href="references.html#ref-allen2000financial" role="doc-biblioref">2000</a>)</span> demonstrate that the structure of interbank linkages determines whether a bank failure cascades into a systemic crisis or is absorbed by the network. Two extreme topologies illustrate:</p>
<p><strong>Complete network (all banks linked to all).</strong> Each bank‚Äôs exposure to any single counterpart is small. A bank failure imposes small losses on many banks, which can individually absorb them. The network is resilient.</p>
<p><strong>Ring network (each bank linked to one neighbor).</strong> Each bank‚Äôs exposure is concentrated in a single counterpart. A failure in one bank can topple its neighbor, triggering a chain of cascading defaults. The network is fragile.</p>
<p>The Vietnamese banking system, with its concentration of state-owned banks and the regulatory emphasis on interbank lending for liquidity management, lies between these extremes.</p>
<div id="interbank-network" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load interbank exposure data</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>interbank <span class="op">=</span> dc.get_interbank_exposures(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Build interbank network</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>G_bank <span class="op">=</span> nx.DiGraph()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> interbank.iterrows():</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    G_bank.add_edge(</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"lender_bank"</span>],</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"borrower_bank"</span>],</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        weight<span class="op">=</span>row[<span class="st">"exposure_bn_vnd"</span>],</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        exposure_pct_equity<span class="op">=</span>row.get(<span class="st">"exposure_pct_equity"</span>, <span class="dv">0</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bank attributes</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>bank_info <span class="op">=</span> dc.get_bank_characteristics(date<span class="op">=</span><span class="st">"2024-06-30"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> bank_info.iterrows():</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"ticker"</span>] <span class="kw">in</span> G_bank:</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        G_bank.nodes[row[<span class="st">"ticker"</span>]].update({</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_assets"</span>: row.get(<span class="st">"total_assets"</span>, <span class="dv">0</span>),</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"equity"</span>: row.get(<span class="st">"equity"</span>, <span class="dv">0</span>),</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"is_soe"</span>: row.get(<span class="st">"is_soe"</span>, <span class="va">False</span>),</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tier1_ratio"</span>: row.get(<span class="st">"tier1_ratio"</span>, <span class="dv">0</span>)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>bank_metrics, bank_graph_stats <span class="op">=</span> compute_network_metrics(G_bank)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="cascading-default-simulation" class="level3" data-number="46.6.2">
<h3 data-number="46.6.2" class="anchored" data-anchor-id="cascading-default-simulation"><span class="header-section-number">46.6.2</span> Cascading Default Simulation</h3>
<p>We implement the <span class="citation" data-cites="eisenberg2001systemic">Eisenberg and Noe (<a href="references.html#ref-eisenberg2001systemic" role="doc-biblioref">2001</a>)</span> clearing mechanism to simulate cascading defaults in the interbank network. When a bank fails, it cannot honor its interbank obligations, imposing losses on its creditors, who may in turn fail:</p>
<p><span id="eq-eisenberg-noe"><span class="math display">\[
p_i^* = \min\left(\bar{p}_i, \; e_i + \sum_{j} \frac{L_{ji}}{\sum_k L_{jk}} p_j^*\right)
\tag{46.11}\]</span></span></p>
<p>where <span class="math inline">\(p_i^*\)</span> is bank <span class="math inline">\(i\)</span>‚Äôs actual payment, <span class="math inline">\(\bar{p}_i\)</span> is its total obligation, <span class="math inline">\(e_i\)</span> is its external assets minus external liabilities, and <span class="math inline">\(L_{ji}/\sum_k L_{jk}\)</span> is the fraction of bank <span class="math inline">\(j\)</span>‚Äôs obligations owed to bank <span class="math inline">\(i\)</span>.</p>
<div id="cascading-defaults" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_cascading_defaults(G, initial_failure, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>                                  equity_buffer<span class="op">=</span><span class="fl">0.08</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                                  max_rounds<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate cascading defaults in an interbank network.</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Interbank exposure graph (lender ‚Üí borrower, weight = exposure).</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="co">    initial_failure : str</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Bank that fails initially.</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co">    equity_buffer : float</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Fraction of equity that absorbs losses before default.</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">    max_rounds : int</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum cascade rounds.</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Defaulted banks, round-by-round losses, systemic loss.</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    defaulted <span class="op">=</span> {initial_failure}</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    cascade_history <span class="op">=</span> [{<span class="st">"round"</span>: <span class="dv">0</span>, <span class="st">"defaults"</span>: [initial_failure],</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"total_defaults"</span>: <span class="dv">1</span>}]</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> round_num <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_rounds <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>        new_defaults <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bank <span class="kw">in</span> G.nodes():</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bank <span class="kw">in</span> defaulted:</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute losses from defaulted counterparties</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> defaulted_bank <span class="kw">in</span> defaulted:</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> G.has_edge(bank, defaulted_bank):</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># bank lent to defaulted_bank ‚Üí loss</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>                    exposure <span class="op">=</span> G[bank][defaulted_bank][<span class="st">"weight"</span>]</span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Assume LGD = 60%</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> exposure <span class="op">*</span> <span class="fl">0.6</span></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>                    total_loss <span class="op">+=</span> loss</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if losses exceed equity buffer</span></span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>            bank_data <span class="op">=</span> G.nodes.get(bank, {})</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>            equity <span class="op">=</span> bank_data.get(<span class="st">"equity"</span>, <span class="bu">float</span>(<span class="st">"inf"</span>))</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_loss <span class="op">&gt;</span> equity <span class="op">*</span> equity_buffer:</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>                new_defaults.add(bank)</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> new_defaults:</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>        defaulted <span class="op">|=</span> new_defaults</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>        cascade_history.append({</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">"round"</span>: round_num,</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">"defaults"</span>: <span class="bu">list</span>(new_defaults),</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_defaults"</span>: <span class="bu">len</span>(defaulted)</span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute systemic loss</span></span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    total_system_equity <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>        G.nodes[n].get(<span class="st">"equity"</span>, <span class="dv">0</span>) <span class="cf">for</span> n <span class="kw">in</span> G.nodes()</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>    defaulted_equity <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>        G.nodes[n].get(<span class="st">"equity"</span>, <span class="dv">0</span>) <span class="cf">for</span> n <span class="kw">in</span> defaulted</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    systemic_loss_pct <span class="op">=</span> (</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>        defaulted_equity <span class="op">/</span> total_system_equity</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_system_equity <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"defaulted_banks"</span>: <span class="bu">list</span>(defaulted),</span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_defaults"</span>: <span class="bu">len</span>(defaulted),</span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_rounds"</span>: <span class="bu">len</span>(cascade_history) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_history"</span>: cascade_history,</span>
<span id="cb27-77"><a href="#cb27-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">"systemic_loss_pct"</span>: systemic_loss_pct</span>
<span id="cb27-78"><a href="#cb27-78" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb27-79"><a href="#cb27-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-80"><a href="#cb27-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-81"><a href="#cb27-81" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate cascade for each bank</span></span>
<span id="cb27-82"><a href="#cb27-82" aria-hidden="true" tabindex="-1"></a>cascade_results <span class="op">=</span> []</span>
<span id="cb27-83"><a href="#cb27-83" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bank <span class="kw">in</span> G_bank.nodes():</span>
<span id="cb27-84"><a href="#cb27-84" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> simulate_cascading_defaults(G_bank, bank)</span>
<span id="cb27-85"><a href="#cb27-85" aria-hidden="true" tabindex="-1"></a>    cascade_results.append({</span>
<span id="cb27-86"><a href="#cb27-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"initial_failure"</span>: bank,</span>
<span id="cb27-87"><a href="#cb27-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cascading_defaults"</span>: result[<span class="st">"n_defaults"</span>],</span>
<span id="cb27-88"><a href="#cb27-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">"systemic_loss_pct"</span>: result[<span class="st">"systemic_loss_pct"</span>],</span>
<span id="cb27-89"><a href="#cb27-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_rounds"</span>: result[<span class="st">"cascade_rounds"</span>]</span>
<span id="cb27-90"><a href="#cb27-90" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb27-91"><a href="#cb27-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-92"><a href="#cb27-92" aria-hidden="true" tabindex="-1"></a>cascade_df <span class="op">=</span> pd.DataFrame(cascade_results).sort_values(</span>
<span id="cb27-93"><a href="#cb27-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">"systemic_loss_pct"</span>, ascending<span class="op">=</span><span class="va">False</span></span>
<span id="cb27-94"><a href="#cb27-94" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-systemic-banks" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="28">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-systemic-banks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.7: Systemically Important Banks: Cascading Default Analysis
</figcaption>
<div aria-describedby="tbl-systemic-banks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cascade_df.head(<span class="dv">15</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
</section>
<section id="graph-neural-networks-for-financial-prediction" class="level2" data-number="46.7">
<h2 data-number="46.7" class="anchored" data-anchor-id="graph-neural-networks-for-financial-prediction"><span class="header-section-number">46.7</span> Graph Neural Networks for Financial Prediction</h2>
<section id="from-graphs-to-predictions" class="level3" data-number="46.7.1">
<h3 data-number="46.7.1" class="anchored" data-anchor-id="from-graphs-to-predictions"><span class="header-section-number">46.7.1</span> From Graphs to Predictions</h3>
<p>Classical network analysis computes hand-crafted features (centrality, clustering, community membership) and feeds them into standard regression models. Graph neural networks (GNNs) learn features directly from the graph structure and node attributes through message passing. The key insight is that a node‚Äôs representation should depend not only on its own features but on the features of its neighbors, their neighbors, and so on.</p>
</section>
<section id="graph-convolutional-networks-gcn" class="level3" data-number="46.7.2">
<h3 data-number="46.7.2" class="anchored" data-anchor-id="graph-convolutional-networks-gcn"><span class="header-section-number">46.7.2</span> Graph Convolutional Networks (GCN)</h3>
<p>The Graph Convolutional Network of <span class="citation" data-cites="kipf2016semi">Kipf and Welling (<a href="references.html#ref-kipf2016semi" role="doc-biblioref">2016</a>)</span> performs spectral convolution on graphs. The layer-wise propagation rule is:</p>
<p><span id="eq-gcn"><span class="math display">\[
H^{(\ell+1)} = \sigma\left(\tilde{D}^{-1/2} \tilde{A} \tilde{D}^{-1/2} H^{(\ell)} W^{(\ell)}\right)
\tag{46.12}\]</span></span></p>
<p>where <span class="math inline">\(\tilde{A} = A + I_n\)</span> is the adjacency matrix with self-loops, <span class="math inline">\(\tilde{D}\)</span> is the corresponding degree matrix, <span class="math inline">\(H^{(\ell)}\)</span> is the node feature matrix at layer <span class="math inline">\(\ell\)</span>, <span class="math inline">\(W^{(\ell)}\)</span> is the learnable weight matrix, and <span class="math inline">\(\sigma\)</span> is a nonlinearity (ReLU). The normalized <span class="math inline">\(\tilde{D}^{-1/2} \tilde{A} \tilde{D}^{-1/2}\)</span> term averages each node‚Äôs features with its neighbors‚Äô features, weighted by degree.</p>
</section>
<section id="graph-attention-networks-gat" class="level3" data-number="46.7.3">
<h3 data-number="46.7.3" class="anchored" data-anchor-id="graph-attention-networks-gat"><span class="header-section-number">46.7.3</span> Graph Attention Networks (GAT)</h3>
<p>The Graph Attention Network of <span class="citation" data-cites="velivckovic2017graph">Veliƒçkoviƒá et al. (<a href="references.html#ref-velivckovic2017graph" role="doc-biblioref">2017</a>)</span> replaces the fixed normalization in GCN with learned attention coefficients:</p>
<p><span id="eq-gat"><span class="math display">\[
h_i^{(\ell+1)} = \sigma\left(\sum_{j \in \mathcal{N}(i)} \alpha_{ij}^{(\ell)} W^{(\ell)} h_j^{(\ell)}\right)
\tag{46.13}\]</span></span></p>
<p>where the attention coefficient <span class="math inline">\(\alpha_{ij}\)</span> is computed as:</p>
<p><span id="eq-gat-attention"><span class="math display">\[
\alpha_{ij} = \frac{\exp\left(\text{LeakyReLU}\left(\mathbf{a}^\top [W h_i \| W h_j]\right)\right)}{\sum_{k \in \mathcal{N}(i)} \exp\left(\text{LeakyReLU}\left(\mathbf{a}^\top [W h_i \| W h_k]\right)\right)}
\tag{46.14}\]</span></span></p>
<p>This allows the model to learn which neighbors are most informative for each node, rather than treating all neighbors equally.</p>
<div id="gnn-models" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GCNLayer(nn.Module):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Graph Convolutional Network layer (Kipf &amp; Welling, 2016)."""</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_features, out_features, bias<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weight <span class="op">=</span> nn.Parameter(torch.FloatTensor(in_features, out_features))</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bias:</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bias <span class="op">=</span> nn.Parameter(torch.FloatTensor(out_features))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bias <span class="op">=</span> <span class="va">None</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_parameters()</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset_parameters(<span class="va">self</span>):</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.weight)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.bias <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>            nn.init.zeros_(<span class="va">self</span>.bias)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj_norm):</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, in_features)</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co">            Node feature matrix.</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co">        adj_norm : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="co">            Normalized adjacency matrix (D^{-1/2} A D^{-1/2}).</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        support <span class="op">=</span> x <span class="op">@</span> <span class="va">self</span>.weight</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> adj_norm <span class="op">@</span> support</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.bias <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>            output <span class="op">=</span> output <span class="op">+</span> <span class="va">self</span>.bias</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GATLayer(nn.Module):</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Graph Attention Network layer (Velickovic et al., 2017)."""</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_features, out_features, n_heads<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>                 dropout<span class="op">=</span><span class="fl">0.1</span>, concat<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_heads <span class="op">=</span> n_heads</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_features <span class="op">=</span> out_features</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.concat <span class="op">=</span> concat</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.W <span class="op">=</span> nn.Parameter(</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>            torch.FloatTensor(n_heads, in_features, out_features)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.a <span class="op">=</span> nn.Parameter(torch.FloatTensor(n_heads, <span class="dv">2</span> <span class="op">*</span> out_features, <span class="dv">1</span>))</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(dropout)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.leaky_relu <span class="op">=</span> nn.LeakyReLU(<span class="fl">0.2</span>)</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_parameters()</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset_parameters(<span class="va">self</span>):</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.W)</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.a)</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, in_features)</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a><span class="co">        adj : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="co">            Binary adjacency matrix (1 if edge, 0 otherwise).</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> x.size(<span class="dv">0</span>)</span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Linear transformation for each head</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x: (n, in_f) -&gt; h: (heads, n, out_f)</span></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> torch.einsum(<span class="st">"ni,hio-&gt;hno"</span>, x, <span class="va">self</span>.W)</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attention coefficients</span></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concatenate h_i and h_j for all pairs</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>        h_i <span class="op">=</span> h.unsqueeze(<span class="dv">2</span>).expand(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, n, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (heads, n, n, out_f)</span></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        h_j <span class="op">=</span> h.unsqueeze(<span class="dv">1</span>).expand(<span class="op">-</span><span class="dv">1</span>, n, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (heads, n, n, out_f)</span></span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>        concat_h <span class="op">=</span> torch.cat([h_i, h_j], dim<span class="op">=-</span><span class="dv">1</span>)    <span class="co"># (heads, n, n, 2*out_f)</span></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> <span class="va">self</span>.leaky_relu(</span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>            torch.einsum(<span class="st">"hnmo,hoi-&gt;hnm"</span>, concat_h, <span class="va">self</span>.a).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mask non-edges</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> adj.unsqueeze(<span class="dv">0</span>).expand(<span class="va">self</span>.n_heads, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> e.masked_fill(mask <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">"-inf"</span>))</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Softmax attention</span></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> F.softmax(e, dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="va">self</span>.dropout(alpha)</span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weighted aggregation</span></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> torch.einsum(<span class="st">"hnm,hmo-&gt;hno"</span>, alpha, h)  <span class="co"># (heads, n, out_f)</span></span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.concat:</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> out.permute(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>).reshape(n, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (n, heads * out_f)</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> out.mean(dim<span class="op">=</span><span class="dv">0</span>)  <span class="co"># (n, out_f)</span></span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out, alpha</span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FinancialGNN(nn.Module):</span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a><span class="co">    Graph Neural Network for financial node prediction.</span></span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports GCN and GAT layers with flexible architecture.</span></span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim, hidden_dim<span class="op">=</span><span class="dv">64</span>, output_dim<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a>                 n_layers<span class="op">=</span><span class="dv">2</span>, n_heads<span class="op">=</span><span class="dv">4</span>, gnn_type<span class="op">=</span><span class="st">"gat"</span>,</span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>                 dropout<span class="op">=</span><span class="fl">0.3</span>):</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gnn_type <span class="op">=</span> gnn_type</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(dropout)</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gnn_type <span class="op">==</span> <span class="st">"gcn"</span>:</span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.ModuleList()</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(GCNLayer(input_dim, hidden_dim))</span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layers <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.layers.append(GCNLayer(hidden_dim, hidden_dim))</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> gnn_type <span class="op">==</span> <span class="st">"gat"</span>:</span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.ModuleList()</span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>                GATLayer(input_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>                         n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layers <span class="op">-</span> <span class="dv">2</span>):</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.layers.append(</span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>                    GATLayer(hidden_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>                             n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Last layer: single head, no concat</span></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(</span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a>                GATLayer(hidden_dim, hidden_dim,</span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a>                         n_heads<span class="op">=</span><span class="dv">1</span>, concat<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-136"><a href="#cb29-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction head</span></span>
<span id="cb29-137"><a href="#cb29-137" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, hidden_dim <span class="op">//</span> <span class="dv">2</span>),</span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(dropout),</span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim <span class="op">//</span> <span class="dv">2</span>, output_dim)</span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, input_dim)</span></span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a><span class="co">            Node features.</span></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a><span class="co">        adj : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a><span class="co">            Adjacency matrix.</span></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> x</span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>        attention_weights <span class="op">=</span> []</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, layer <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.layers):</span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.gnn_type <span class="op">==</span> <span class="st">"gcn"</span>:</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> layer(h, adj)</span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> F.relu(h) <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(<span class="va">self</span>.layers) <span class="op">-</span> <span class="dv">1</span> <span class="cf">else</span> h</span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="va">self</span>.gnn_type <span class="op">==</span> <span class="st">"gat"</span>:</span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a>                h, alpha <span class="op">=</span> layer(h, adj)</span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a>                attention_weights.append(alpha)</span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(<span class="va">self</span>.layers) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a>                    h <span class="op">=</span> F.elu(h)</span>
<span id="cb29-165"><a href="#cb29-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-166"><a href="#cb29-166" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> <span class="va">self</span>.dropout(h)</span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> <span class="va">self</span>.head(h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions, attention_weights</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="gnn-for-cross-sectional-return-prediction" class="level3" data-number="46.7.4">
<h3 data-number="46.7.4" class="anchored" data-anchor-id="gnn-for-cross-sectional-return-prediction"><span class="header-section-number">46.7.4</span> GNN for Cross-Sectional Return Prediction</h3>
<p>We apply the GNN to predict cross-sectional stock returns, where the graph encodes ownership connections between firms. The hypothesis is that firms connected through ownership have correlated return dynamics that the GNN can exploit.</p>
<div id="gnn-return-prediction" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_gnn_data(firms_df, ownership_graph, returns_df, date):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare node features and adjacency matrix for GNN prediction.</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="co">    firms_df : DataFrame</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Firm characteristics.</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_graph : nx.DiGraph</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership network.</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock returns.</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple : (node_features, adjacency, target_returns, ticker_list)</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get stocks with both features and network presence</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(firms_df[<span class="st">"ticker"</span>]) <span class="op">&amp;</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(ownership_graph.nodes()) <span class="op">&amp;</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(returns_df[<span class="st">"ticker"</span>])</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tickers:</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node features</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"profitability"</span>, <span class="st">"investment"</span>, <span class="st">"leverage"</span>,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>, <span class="st">"volatility"</span>, <span class="st">"turnover"</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    feat_df <span class="op">=</span> firms_df[firms_df[<span class="st">"ticker"</span>].isin(tickers)].set_index(<span class="st">"ticker"</span>)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    feat_df <span class="op">=</span> feat_df.reindex(tickers)</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> feat_df[feature_cols].fillna(<span class="dv">0</span>).values</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> (X <span class="op">-</span> X.mean(axis<span class="op">=</span><span class="dv">0</span>)) <span class="op">/</span> (X.std(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjacency matrix</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>    ticker_to_idx <span class="op">=</span> {t: i <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(tickers)}</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(tickers)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> np.zeros((n, n))</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u, v, d <span class="kw">in</span> ownership_graph.edges(data<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> u <span class="kw">in</span> ticker_to_idx <span class="kw">and</span> v <span class="kw">in</span> ticker_to_idx:</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>            weight <span class="op">=</span> d.get(<span class="st">"weight"</span>, <span class="dv">1</span>)</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>            A[ticker_to_idx[u], ticker_to_idx[v]] <span class="op">=</span> weight</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>            A[ticker_to_idx[v], ticker_to_idx[u]] <span class="op">=</span> weight  <span class="co"># Symmetrize</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add self-loops</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> A <span class="op">+</span> np.eye(n)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize: D^{-1/2} A D^{-1/2}</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> np.diag(A.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>    D_inv_sqrt <span class="op">=</span> np.diag(<span class="fl">1.0</span> <span class="op">/</span> np.sqrt(np.diag(D) <span class="op">+</span> <span class="fl">1e-10</span>))</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a>    A_norm <span class="op">=</span> D_inv_sqrt <span class="op">@</span> A <span class="op">@</span> D_inv_sqrt</span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Target returns</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>    ret_df <span class="op">=</span> returns_df[</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>        (returns_df[<span class="st">"ticker"</span>].isin(tickers)) <span class="op">&amp;</span></span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>        (returns_df[<span class="st">"date"</span>] <span class="op">==</span> date)</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"ticker"</span>).reindex(tickers)</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> ret_df[<span class="st">"ret"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>        torch.tensor(X, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>        torch.tensor(A_norm, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>        torch.tensor(y, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>        tickers</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_gnn_model(model, X_train, A_train, y_train,</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>                     X_val, A_val, y_val,</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>                     n_epochs<span class="op">=</span><span class="dv">100</span>, lr<span class="op">=</span><span class="fl">1e-3</span>):</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train GNN model with validation-based early stopping."""</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span>lr,</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>                                  weight_decay<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>    best_val_loss <span class="op">=</span> <span class="bu">float</span>(<span class="st">"inf"</span>)</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>    patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(n_epochs):</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>        pred, _ <span class="op">=</span> model(X_train, A_train)</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> F.mse_loss(pred, y_train)</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>            val_pred, _ <span class="op">=</span> model(X_val, A_val)</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>            val_loss <span class="op">=</span> F.mse_loss(val_pred, y_val).item()</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> val_loss <span class="op">&lt;</span> best_val_loss:</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>            best_val_loss <span class="op">=</span> val_loss</span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>            best_state <span class="op">=</span> {k: v.clone() <span class="cf">for</span> k, v <span class="kw">in</span> model.state_dict().items()}</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> patience_counter <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(best_state)</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, best_val_loss</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="temporal-graph-networks" class="level3" data-number="46.7.5">
<h3 data-number="46.7.5" class="anchored" data-anchor-id="temporal-graph-networks"><span class="header-section-number">46.7.5</span> Temporal Graph Networks</h3>
<p>Financial networks evolve over time. Ownership stakes change, directors rotate, correlations shift. Temporal GNNs extend static GNNs by incorporating the time dimension explicitly. The Temporal Graph Network (TGN) of <span class="citation" data-cites="rossi2020temporal">Rossi et al. (<a href="references.html#ref-rossi2020temporal" role="doc-biblioref">2020</a>)</span> maintains a memory state for each node that is updated whenever an event involving the node occurs:</p>
<p><span id="eq-tgn"><span class="math display">\[
\mathbf{s}_i(t) = \text{GRU}\left(\mathbf{s}_i(t^-), \; \text{msg}(i, t)\right)
\tag{46.15}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{s}_i(t)\)</span> is the memory state of node <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>, <span class="math inline">\(\text{msg}(i, t)\)</span> is the message aggregated from events at time <span class="math inline">\(t\)</span>, and GRU is a gated recurrent unit.</p>
<div id="temporal-gnn" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TemporalFinancialGNN(nn.Module):</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Temporal GNN for dynamic financial networks.</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Combines graph convolution with temporal memory.</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node_dim, edge_dim<span class="op">=</span><span class="dv">1</span>, memory_dim<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                 hidden_dim<span class="op">=</span><span class="dv">64</span>, output_dim<span class="op">=</span><span class="dv">1</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.memory_dim <span class="op">=</span> memory_dim</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Memory update (GRU)</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.memory_updater <span class="op">=</span> nn.GRUCell(</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>            input_size<span class="op">=</span>node_dim <span class="op">+</span> edge_dim <span class="op">+</span> memory_dim,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>            hidden_size<span class="op">=</span>memory_dim</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Message function</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.message_fn <span class="op">=</span> nn.Sequential(</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>            nn.Linear(memory_dim <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> edge_dim, hidden_dim),</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, memory_dim)</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Graph attention for spatial aggregation</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spatial_attn <span class="op">=</span> GATLayer(</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>            memory_dim <span class="op">+</span> node_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Temporal attention for recent history</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temporal_attn <span class="op">=</span> nn.MultiheadAttention(</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>            embed_dim<span class="op">=</span>hidden_dim, num_heads<span class="op">=</span>n_heads,</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>            batch_first<span class="op">=</span><span class="va">True</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction head</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, hidden_dim),</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, output_dim)</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, node_features, adj_sequence, memory<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a><span class="co">        node_features : list of Tensors</span></span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a><span class="co">            Node features at each time step.</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co">        adj_sequence : list of Tensors</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="co">            Adjacency matrices at each time step.</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a><span class="co">        memory : Tensor or None</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a><span class="co">            Initial memory state (n_nodes, memory_dim).</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns</span></span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a><span class="co">        -------</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a><span class="co">        predictions : Tensor</span></span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a><span class="co">            Predictions for the last time step.</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>        n_nodes <span class="op">=</span> node_features[<span class="dv">0</span>].shape[<span class="dv">0</span>]</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>        T <span class="op">=</span> <span class="bu">len</span>(node_features)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> memory <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>            memory <span class="op">=</span> torch.zeros(n_nodes, <span class="va">self</span>.memory_dim)</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>        temporal_states <span class="op">=</span> []</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T):</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>            x_t <span class="op">=</span> node_features[t]</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>            adj_t <span class="op">=</span> adj_sequence[t]</span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Spatial aggregation via GAT</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>            combined <span class="op">=</span> torch.cat([x_t, memory], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>            spatial_out, _ <span class="op">=</span> <span class="va">self</span>.spatial_attn(combined, adj_t)</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>            temporal_states.append(spatial_out.unsqueeze(<span class="dv">1</span>))</span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update memory with current state</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>            update_input <span class="op">=</span> torch.cat([</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>                x_t, spatial_out[:, :<span class="dv">1</span>].squeeze(<span class="dv">1</span>) <span class="cf">if</span> spatial_out.dim() <span class="op">&gt;</span> <span class="dv">2</span></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span> spatial_out,</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>                memory</span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>            ], dim<span class="op">=-</span><span class="dv">1</span>)[:, :<span class="va">self</span>.memory_updater.input_size]</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack temporal states: (n_nodes, T, hidden)</span></span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>        temporal_stack <span class="op">=</span> torch.cat(temporal_states, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Temporal attention across time steps</span></span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>        temporal_out, _ <span class="op">=</span> <span class="va">self</span>.temporal_attn(</span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>            temporal_stack, temporal_stack, temporal_stack</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use last time step</span></span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>        last_spatial <span class="op">=</span> temporal_states[<span class="op">-</span><span class="dv">1</span>].squeeze(<span class="dv">1</span>)</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>        last_temporal <span class="op">=</span> temporal_out[:, <span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> torch.cat([last_spatial, last_temporal], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> <span class="va">self</span>.head(combined).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="gnn-for-credit-risk-and-fraud-detection" class="level3" data-number="46.7.6">
<h3 data-number="46.7.6" class="anchored" data-anchor-id="gnn-for-credit-risk-and-fraud-detection"><span class="header-section-number">46.7.6</span> GNN for Credit Risk and Fraud Detection</h3>
<p>Beyond return prediction, GNNs are particularly powerful for credit risk assessment and fraud detection, where the network structure itself is informative. In credit risk, firms connected to defaulted counterparties face elevated risk. In fraud detection, suspicious transaction patterns propagate through networks of related entities.</p>
<div id="gnn-credit-risk" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreditRiskGNN(nn.Module):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="co">    GNN for credit default prediction using firm and bank networks.</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Node classification: predict default probability per firm.</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, firm_features_dim, bank_features_dim<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>                 hidden_dim<span class="op">=</span><span class="dv">64</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        input_dim <span class="op">=</span> firm_features_dim <span class="op">+</span> bank_features_dim</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># GNN backbone</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gnn <span class="op">=</span> FinancialGNN(</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>            input_dim<span class="op">=</span>input_dim,</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            hidden_dim<span class="op">=</span>hidden_dim,</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>            output_dim<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>            n_layers<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            n_heads<span class="op">=</span>n_heads,</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            gnn_type<span class="op">=</span><span class="st">"gat"</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Additional head for probability output</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sigmoid <span class="op">=</span> nn.Sigmoid()</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>        logits, attn <span class="op">=</span> <span class="va">self</span>.gnn(x, adj)</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> <span class="va">self</span>.sigmoid(logits)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> probs, attn</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="when-to-use-network-methods" class="level2" data-number="46.8">
<h2 data-number="46.8" class="anchored" data-anchor-id="when-to-use-network-methods"><span class="header-section-number">46.8</span> When to Use Network Methods</h2>
<section id="decision-framework" class="level3" data-number="46.8.1">
<h3 data-number="46.8.1" class="anchored" data-anchor-id="decision-framework"><span class="header-section-number">46.8.1</span> Decision Framework</h3>
<div id="tbl-network-decision" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-network-decision-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.8: Decision Framework for Network Methods
</figcaption>
<div aria-describedby="tbl-network-decision-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 30%">
<col style="width: 41%">
<col style="width: 27%">
</colgroup>
<thead>
<tr class="header">
<th>Question</th>
<th>Best Approach</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Does firm <span class="math inline">\(A\)</span> affect firm <span class="math inline">\(B\)</span>?</td>
<td>Pairwise test + network controls</td>
<td>Supply chain momentum</td>
</tr>
<tr class="even">
<td>Which firms are most systemically important?</td>
<td>Centrality measures</td>
<td>Interbank contagion</td>
</tr>
<tr class="odd">
<td>Do network-connected firms co-move?</td>
<td>Correlation vs.&nbsp;interlock overlap</td>
<td>Board interlock diffusion</td>
</tr>
<tr class="even">
<td>Can network structure predict returns?</td>
<td>GNN or network-augmented regression</td>
<td>GCN return prediction</td>
</tr>
<tr class="odd">
<td>How does a shock propagate?</td>
<td>Cascade simulation</td>
<td>Eisenberg-Noe default model</td>
</tr>
<tr class="even">
<td>What is the optimal portfolio given network risk?</td>
<td>Network-regularized optimization</td>
<td>Correlation MST filtering</td>
</tr>
<tr class="odd">
<td>How does the network change over time?</td>
<td>Temporal GNN or rolling analysis</td>
<td>DY rolling connectedness</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="data-requirements-and-vietnamese-availability" class="level3" data-number="46.8.2">
<h3 data-number="46.8.2" class="anchored" data-anchor-id="data-requirements-and-vietnamese-availability"><span class="header-section-number">46.8.2</span> Data Requirements and Vietnamese Availability</h3>
<div id="tbl-network-data" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-network-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.9: Financial Network Data Sources in Vietnam
</figcaption>
<div aria-describedby="tbl-network-data-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th>Network Type</th>
<th>Required Data</th>
<th>Vietnamese Availability</th>
<th>Update Frequency</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Ownership</td>
<td>Shareholder registers</td>
<td>Good (semi-annual filings)</td>
<td>Semi-annual</td>
</tr>
<tr class="even">
<td>Board interlocks</td>
<td>Director appointments</td>
<td>Good (filings)</td>
<td>Annual</td>
</tr>
<tr class="odd">
<td>Supply chain</td>
<td>Customer-supplier disclosures, trade data</td>
<td>Moderate (related-party disclosures)</td>
<td>Annual</td>
</tr>
<tr class="even">
<td>Correlation</td>
<td>Return data</td>
<td>Excellent (daily from exchanges)</td>
<td>Daily</td>
</tr>
<tr class="odd">
<td>Interbank</td>
<td>Bilateral exposures</td>
<td>Limited (SBV data, banks‚Äô notes to FS)</td>
<td>Quarterly</td>
</tr>
<tr class="even">
<td>Co-holdings</td>
<td>Institutional holdings</td>
<td>Moderate (semi-annual disclosures)</td>
<td>Semi-annual</td>
</tr>
<tr class="odd">
<td>Lending</td>
<td>Loan-level data</td>
<td>Limited (banking supervision data)</td>
<td>Quarterly</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<!-- ## Exercises

1.  **Ownership Pyramid Depth and Tunneling.** For each listed firm, compute the depth of the longest ownership chain from the ultimate controller to the firm. Regress Tobin's $Q$ and ROA on pyramid depth, controlling for the control-cash flow wedge, firm size, industry, and listing exchange. Does deeper pyramidal ownership destroy value? Does the effect differ between state and private pyramids? Use the @claessens2002disentangling methodology.

2.  **Board Network Information Diffusion.** Construct the board interlock network for 2020-2024 and identify firms that added new interlocking directors. Using a difference-in-differences design, test whether newly interlocked firms exhibit increased return co-movement relative to a matched control group. Does the effect depend on whether the shared director is classified as independent?

3.  **Supply Chain Contagion During COVID-19.** Reconstruct the supply chain network as of December 2019. Identify firms with direct supply chain links to Chinese manufacturers. Using the onset of COVID-19 lockdowns in China (January 2020) as a shock, estimate the differential stock price decline for firms with high vs. low exposure to Chinese suppliers. Does the effect attenuate by network distance (direct supplier vs. supplier's supplier)?

4.  **Correlation Network Regime Detection.** Compute rolling 6-month correlation networks with monthly updates for 2014-2024. Apply community detection (Louvain algorithm) at each date. Track the number of communities, modularity, and the composition of the largest community over time. Do correlation regime changes (merging of previously distinct communities) precede periods of elevated market volatility? Construct a "network fragility" indicator based on decreasing modularity and test its predictive power for VN-Index drawdowns.

5.  **GNN vs. Linear Models for Return Prediction.** Implement a rigorous horse race between: (a) Fama-MacBeth cross-sectional regression with standard characteristics, (b) the same regression augmented with hand-crafted network features (degree, betweenness, eigenvector centrality, community membership), and (c) a GCN and GAT that take the same node features plus the adjacency matrix as input. Use expanding-window time-series cross-validation with monthly rebalancing. Report out-of-sample $R^2$, information coefficient, and the Sharpe ratio of quintile-sorted long-short portfolios. Does the GNN's ability to learn features from graph structure outperform hand-crafted network features?

6.  **Dynamic Interbank Contagion Index.** Implement the rolling Diebold-Yilmaz (2014) connectedness index for the Vietnamese banking sector using quarterly data. Compute the Total Connectedness Index, directional FROM/TO measures, and net connectedness for each bank. Plot the TCI over time and identify peaks corresponding to known stress events (2011 banking consolidation, 2022 corporate bond crisis). Does a rising TCI at time $t$ predict banking sector underperformance at $t+1$?

7.  **Heterogeneous Graph Neural Network.** Construct a heterogeneous financial graph with three node types (firms, banks, directors) and four edge types (ownership, lending, board membership, supply chain). Implement a Heterogeneous GAT (HAN) that uses edge-type-specific attention. Does the heterogeneous graph outperform separate homogeneous graphs for return prediction? Which edge type receives the highest attention weight?

8.  **Node2Vec Financial Embeddings.** Apply the Node2Vec algorithm [@grover2016node2vec] to the ownership network with different hyperparameters ($p$, $q$) controlling the balance between BFS-like (local neighborhood) and DFS-like (structural role) exploration. Visualize the 128-dimensional embeddings using t-SNE, colored by industry. Do the embeddings capture industry structure? Use the embeddings as additional features in a return prediction model and compare with hand-crafted centrality features. -->
</section>
</section>
<section id="summary" class="level2" data-number="46.9">
<h2 data-number="46.9" class="anchored" data-anchor-id="summary"><span class="header-section-number">46.9</span> Summary</h2>
<p>This chapter developed the network toolkit for Vietnamese financial markets, spanning classical graph theory, domain-specific financial network construction, and modern graph neural networks.</p>
<p>The central insight is that financial networks encode information invisible to standard panel regressions. Ownership networks reveal pyramidal control structures and tunneling risk that explain cross-sectional differences in firm value. Board interlocks serve as information channels through which compensation practices, investment policies, and governance norms diffuse. Supply chain networks propagate real economic shocks: the customer momentum anomaly demonstrates that market prices incorporate supply chain information with a predictable delay. Correlation networks capture co-movement structure that both reveals sector clustering and evolves across market regimes. And interbank networks determine whether individual bank failures cascade into systemic crises.</p>
<p>Vietnamese markets are particularly network-dense because of the pervasive role of state ownership, the prominence of business groups, and the concentration of the banking system. The control-cash flow wedge (i.e., the gap between control rights and cash flow rights created by pyramidal ownership) is larger and more variable than in markets with stronger minority shareholder protections. This wedge, which is computable only through network analysis of ownership chains, is both a governance risk measure and a predictor of firm value.</p>
<p>Graph neural networks extend the toolkit from hand-crafted network features to learned representations. The GCN and GAT architectures aggregate information across network neighborhoods, and the temporal GNN captures the evolution of network structure over time. For return prediction, the empirical question is whether the GNN‚Äôs ability to learn flexible functions of the graph structure outperforms the simpler approach of computing centrality measures and feeding them into standard models. The exercises provide a framework for answering this question rigorously.</p>
<p>The network perspective is not a replacement for standard asset pricing or corporate finance methods; it is a complement. The most productive research designs combine network structure with identification strategies from the causal inference toolkit: using network shocks as instruments, exploiting network disruptions as natural experiments, and controlling for network position when estimating treatment effects. The intersection of networks and causal inference (e.g., network interference, peer effects identification, spatial econometrics) represents the frontier of empirical finance.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-acemoglu2015systemic" class="csl-entry" role="listitem">
Acemoglu, Daron, Asuman Ozdaglar, and Alireza Tahbaz-Salehi. 2015. <span>‚ÄúSystemic Risk and Stability in Financial Networks.‚Äù</span> <em>American Economic Review</em> 105 (2): 564‚Äì608.
</div>
<div id="ref-allen2000financial" class="csl-entry" role="listitem">
Allen, Franklin, and Douglas Gale. 2000. <span>‚ÄúFinancial Contagion.‚Äù</span> <em>Journal of Political Economy</em> 108 (1): 1‚Äì33.
</div>
<div id="ref-bebchuk1999rent" class="csl-entry" role="listitem">
Bebchuk, Lucian A. 1999. <span>‚ÄúA Rent-Protection Theory of Corporate Ownership and Control.‚Äù</span> National Bureau of Economic Research Cambridge, Mass., USA.
</div>
<div id="ref-bizjak2008does" class="csl-entry" role="listitem">
Bizjak, John M, Michael L Lemmon, and Lalitha Naveen. 2008. <span>‚ÄúDoes the Use of Peer Groups Contribute to Higher Pay and Less Efficient Compensation?‚Äù</span> <em>Journal of Financial Economics</em> 90 (2): 152‚Äì68.
</div>
<div id="ref-cai2014board" class="csl-entry" role="listitem">
Cai, Ye, Dan S Dhaliwal, Yongtae Kim, and Carrie Pan. 2014. <span>‚ÄúBoard Interlocks and the Diffusion of Disclosure Policy.‚Äù</span> <em>Review of Accounting Studies</em> 19 (3): 1086‚Äì1119.
</div>
<div id="ref-cohen2008economic" class="csl-entry" role="listitem">
Cohen, Lauren, and Andrea Frazzini. 2008. <span>‚ÄúEconomic Links and Predictable Returns.‚Äù</span> <em>The Journal of Finance</em> 63 (4): 1977‚Äì2011.
</div>
<div id="ref-diebold2014network" class="csl-entry" role="listitem">
Diebold, Francis X, and Kamil Yƒ±lmaz. 2014. <span>‚ÄúOn the Network Topology of Variance Decompositions: Measuring the Connectedness of Financial Firms.‚Äù</span> <em>Journal of Econometrics</em> 182 (1): 119‚Äì34.
</div>
<div id="ref-eisenberg2001systemic" class="csl-entry" role="listitem">
Eisenberg, Larry, and Thomas H Noe. 2001. <span>‚ÄúSystemic Risk in Financial Systems.‚Äù</span> <em>Management Science</em> 47 (2): 236‚Äì49.
</div>
<div id="ref-kipf2016semi" class="csl-entry" role="listitem">
Kipf, Thomas N, and Max Welling. 2016. <span>‚ÄúSemi-Supervised Classification with Graph Convolutional Networks.‚Äù</span> <em>arXiv Preprint arXiv:1609.02907</em>.
</div>
<div id="ref-menzly2010market" class="csl-entry" role="listitem">
Menzly, Lior, and Oguzhan Ozbas. 2010. <span>‚ÄúMarket Segmentation and Cross-Predictability of Returns.‚Äù</span> <em>The Journal of Finance</em> 65 (4): 1555‚Äì80.
</div>
<div id="ref-rossi2020temporal" class="csl-entry" role="listitem">
Rossi, Emanuele, Ben Chamberlain, Fabrizio Frasca, Davide Eynard, Federico Monti, and Michael Bronstein. 2020. <span>‚ÄúTemporal Graph Networks for Deep Learning on Dynamic Graphs.‚Äù</span> <em>arXiv Preprint arXiv:2006.10637</em>.
</div>
<div id="ref-velivckovic2017graph" class="csl-entry" role="listitem">
Veliƒçkoviƒá, Petar, Guillem Cucurull, Arantxa Casanova, Adriana Romero, Pietro Lio, and Yoshua Bengio. 2017. <span>‚ÄúGraph Attention Networks.‚Äù</span> <em>arXiv Preprint arXiv:1710.10903</em>.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LG91D0C6RB";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./71_image.html" class="pagination-link" aria-label="Image and Visual Data in Finance">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./74_multimodel.html" class="pagination-link" aria-label="Multimodal Models in Finance">
        <span class="nav-page-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Networks and Graphs in Finance</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>Financial markets are networks. Every stock return is shaped by connections: firms share supply chains, directors, auditors, investors, lenders, and regulators. Shocks propagate through these links (e.g., a bankruptcy ripples through supplier networks, a central bank liquidity squeeze radiates through interbank exposures, and information diffuses through board interlocks and institutional co-ownership). Yet the dominant empirical paradigm in finance treats firms as isolated observations indexed by $(i, t)$, connected only through their shared exposure to common factors. This chapter introduces tools for modeling, measuring, and exploiting the network structure that standard panel regressions ignore.</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>The Vietnamese financial system is particularly network-dense. State ownership creates a lattice of cross-connected enterprises: the same line ministry may oversee the borrower, the lender, and the insurer. Pyramidal business groups (such as Vingroup, Masan, and FPT) link dozens of listed and unlisted entities through chains of equity ownership. The banking system is small and concentrated, with a few state-owned commercial banks accounting for the majority of assets, generating dense interbank exposures. Board interlocks (e.g., directors who serve on multiple boards simultaneously) are pervasive and often follow ownership lines. And the equity market itself exhibits return co-movement patterns that, when represented as a correlation network, reveal sector-level and ownership-level clustering invisible in standard factor analysis.</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>This chapter covers the full spectrum of network methods used in financial economics, from classical graph theory through modern graph neural networks (GNNs). We organize the material in seven sections. First, graph theory fundamentals and the representation of financial data as networks. Second, ownership and control networks, which are the most distinctive network structure in Vietnamese markets. Third, board interlock and governance networks. Fourth, supply chain and trade networks. Fifth, correlation and co-movement networks for portfolio construction and systemic risk monitoring. Sixth, interbank and contagion networks. Seventh, graph neural networks and graph-based machine learning for asset pricing, credit risk, and anomaly detection.</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Graph libraries</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> sparse</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> squareform</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical and econometric</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> mpatches</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Deep learning (for GNNs later)</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="fu">## Graph Theory Foundations for Finance</span></span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a><span class="fu">### Representing Financial Data as Graphs</span></span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>A graph $G = (V, E)$ consists of a set of vertices (nodes) $V$ and edges (links) $E \subseteq V \times V$. In financial networks, nodes represent economic agents, such as firms, banks, investors, directors, and edges represent relationships including ownership stakes, lending, board seats, supply contracts, and return co-movement.</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>Financial graphs come in several varieties:</span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>**Directed vs. undirected.** Ownership is directed: firm $A$ owns a stake in firm $B$, but not necessarily vice versa. Board interlocks are undirected: if director $d$ sits on both firm $A$'s and firm $B$'s boards, the connection is symmetric. Supply chains are directed: $A$ supplies to $B$.</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>**Weighted vs. unweighted.** Ownership networks are naturally weighted by the ownership percentage. Correlation networks are weighted by the pairwise correlation coefficient. Board interlocks can be weighted by the number of shared directors.</span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>**Static vs. dynamic.** Most financial networks evolve over time as ownership changes, directors rotate, and correlations shift. A temporal graph $G_t = (V_t, E_t)$ captures this evolution.</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>**Bipartite vs. unipartite.** The raw data for many financial networks is bipartite: directors $\times$ firms, investors $\times$ stocks, banks $\times$ borrowers. The one-mode projection converts this to a unipartite graph: two firms are connected if they share a director, two stocks are connected if they share an institutional investor, etc.</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Graph Metrics</span></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>For a graph $G$ with $n = |V|$ nodes and $m = |E|$ edges, we define the following metrics, each with a specific financial interpretation.</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a>**Degree centrality.** The degree $k_i$ of node $i$ is the number of edges incident to $i$. In a directed graph, we distinguish in-degree $k_i^{\text{in}}$ (edges pointing to $i$) and out-degree $k_i^{\text{out}}$ (edges from $i$). Normalized degree centrality is:</span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>C_D(i) = \frac{k_i}{n - 1}</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>$$ {#eq-degree-centrality}</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>In an ownership network, high out-degree means a firm owns stakes in many others (conglomerate); high in-degree means many entities own stakes in the firm (dispersed ownership).</span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>**Betweenness centrality.** The fraction of shortest paths between all pairs of nodes that pass through node $i$:</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>C_B(i) = \sum_{s \neq i \neq t} \frac{\sigma_{st}(i)}{\sigma_{st}}</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>$$ {#eq-betweenness}</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>where $\sigma_{st}$ is the total number of shortest paths from $s$ to $t$ and $\sigma_{st}(i)$ is the number that pass through $i$. High betweenness identifies "bridge" nodes (i.e., firms or banks that connect otherwise disconnected parts of the financial system). The failure of a high-betweenness bank can fragment the interbank network.</span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>**Eigenvector centrality.** A node is central if it is connected to other central nodes. The eigenvector centrality is the solution to:</span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a>\lambda \mathbf{c} = A \mathbf{c}</span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a>$$ {#eq-eigenvector-centrality}</span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>where $A$ is the adjacency matrix and $\lambda$ is the largest eigenvalue. Google's PageRank is a regularized variant designed for directed graphs. In financial networks, eigenvector centrality identifies systemically important institutions (i.e., those connected to other important institutions).</span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>**Clustering coefficient.** The fraction of a node's neighbors that are also neighbors of each other:</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>C_C(i) = \frac{2 T_i}{k_i(k_i - 1)}</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>$$ {#eq-clustering}</span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>where $T_i$ is the number of triangles containing node $i$. High clustering indicates tightly knit groups (e.g., business groups, lending circles, co-invested portfolios).</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>**Community structure.** Many financial networks exhibit modular structure: groups of densely connected nodes with sparse connections between groups. Community detection algorithms (Louvain, label propagation, spectral clustering) identify these modules, which in financial networks often correspond to business groups, industry sectors, or lending clusters.</span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: graph-fundamentals</span></span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_network_metrics(G):</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute standard network metrics for a graph.</span></span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.Graph or nx.DiGraph</span></span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a><span class="co">        Input graph.</span></span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Node-level and graph-level metrics.</span></span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>    is_directed <span class="op">=</span> G.is_directed()</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node-level metrics</span></span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_directed:</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>        in_degree <span class="op">=</span> <span class="bu">dict</span>(G.in_degree())</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>        out_degree <span class="op">=</span> <span class="bu">dict</span>(G.out_degree())</span>
<span id="cb33-131"><a href="#cb33-131" aria-hidden="true" tabindex="-1"></a>        degree <span class="op">=</span> {n: in_degree[n] <span class="op">+</span> out_degree[n] <span class="cf">for</span> n <span class="kw">in</span> G.nodes()}</span>
<span id="cb33-132"><a href="#cb33-132" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-133"><a href="#cb33-133" aria-hidden="true" tabindex="-1"></a>        degree <span class="op">=</span> <span class="bu">dict</span>(G.degree())</span>
<span id="cb33-134"><a href="#cb33-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-135"><a href="#cb33-135" aria-hidden="true" tabindex="-1"></a>    betweenness <span class="op">=</span> nx.betweenness_centrality(G, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb33-136"><a href="#cb33-136" aria-hidden="true" tabindex="-1"></a>    eigenvector <span class="op">=</span> nx.eigenvector_centrality_numpy(</span>
<span id="cb33-137"><a href="#cb33-137" aria-hidden="true" tabindex="-1"></a>        G, weight<span class="op">=</span><span class="st">"weight"</span></span>
<span id="cb33-138"><a href="#cb33-138" aria-hidden="true" tabindex="-1"></a>    ) <span class="cf">if</span> <span class="bu">len</span>(G) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> {}</span>
<span id="cb33-139"><a href="#cb33-139" aria-hidden="true" tabindex="-1"></a>    clustering <span class="op">=</span> nx.clustering(G, weight<span class="op">=</span><span class="st">"weight"</span>) <span class="cf">if</span> <span class="kw">not</span> is_directed <span class="cf">else</span> {}</span>
<span id="cb33-140"><a href="#cb33-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-141"><a href="#cb33-141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PageRank (works for both directed and undirected)</span></span>
<span id="cb33-142"><a href="#cb33-142" aria-hidden="true" tabindex="-1"></a>    pagerank <span class="op">=</span> nx.pagerank(G, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb33-143"><a href="#cb33-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-144"><a href="#cb33-144" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Graph-level metrics</span></span>
<span id="cb33-145"><a href="#cb33-145" aria-hidden="true" tabindex="-1"></a>    n_nodes <span class="op">=</span> G.number_of_nodes()</span>
<span id="cb33-146"><a href="#cb33-146" aria-hidden="true" tabindex="-1"></a>    n_edges <span class="op">=</span> G.number_of_edges()</span>
<span id="cb33-147"><a href="#cb33-147" aria-hidden="true" tabindex="-1"></a>    density <span class="op">=</span> nx.density(G)</span>
<span id="cb33-148"><a href="#cb33-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-149"><a href="#cb33-149" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connected components</span></span>
<span id="cb33-150"><a href="#cb33-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> is_directed:</span>
<span id="cb33-151"><a href="#cb33-151" aria-hidden="true" tabindex="-1"></a>        n_weak_components <span class="op">=</span> nx.number_weakly_connected_components(G)</span>
<span id="cb33-152"><a href="#cb33-152" aria-hidden="true" tabindex="-1"></a>        n_strong_components <span class="op">=</span> nx.number_strongly_connected_components(G)</span>
<span id="cb33-153"><a href="#cb33-153" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-154"><a href="#cb33-154" aria-hidden="true" tabindex="-1"></a>        n_components <span class="op">=</span> nx.number_connected_components(G)</span>
<span id="cb33-155"><a href="#cb33-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-156"><a href="#cb33-156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degree distribution statistics</span></span>
<span id="cb33-157"><a href="#cb33-157" aria-hidden="true" tabindex="-1"></a>    degrees <span class="op">=</span> <span class="bu">list</span>(degree.values())</span>
<span id="cb33-158"><a href="#cb33-158" aria-hidden="true" tabindex="-1"></a>    avg_degree <span class="op">=</span> np.mean(degrees) <span class="cf">if</span> degrees <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-159"><a href="#cb33-159" aria-hidden="true" tabindex="-1"></a>    max_degree <span class="op">=</span> <span class="bu">max</span>(degrees) <span class="cf">if</span> degrees <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-160"><a href="#cb33-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-161"><a href="#cb33-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assortativity</span></span>
<span id="cb33-162"><a href="#cb33-162" aria-hidden="true" tabindex="-1"></a>    assortativity <span class="op">=</span> nx.degree_assortativity_coefficient(G)</span>
<span id="cb33-163"><a href="#cb33-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-164"><a href="#cb33-164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Community detection (Louvain)</span></span>
<span id="cb33-165"><a href="#cb33-165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> is_directed:</span>
<span id="cb33-166"><a href="#cb33-166" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-167"><a href="#cb33-167" aria-hidden="true" tabindex="-1"></a>            communities <span class="op">=</span> nx.community.louvain_communities(G)</span>
<span id="cb33-168"><a href="#cb33-168" aria-hidden="true" tabindex="-1"></a>            modularity <span class="op">=</span> nx.community.modularity(G, communities)</span>
<span id="cb33-169"><a href="#cb33-169" aria-hidden="true" tabindex="-1"></a>            n_communities <span class="op">=</span> <span class="bu">len</span>(communities)</span>
<span id="cb33-170"><a href="#cb33-170" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb33-171"><a href="#cb33-171" aria-hidden="true" tabindex="-1"></a>            modularity, n_communities <span class="op">=</span> np.nan, <span class="dv">0</span></span>
<span id="cb33-172"><a href="#cb33-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-173"><a href="#cb33-173" aria-hidden="true" tabindex="-1"></a>        modularity, n_communities <span class="op">=</span> np.nan, <span class="dv">0</span></span>
<span id="cb33-174"><a href="#cb33-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-175"><a href="#cb33-175" aria-hidden="true" tabindex="-1"></a>    node_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb33-176"><a href="#cb33-176" aria-hidden="true" tabindex="-1"></a>        <span class="st">"degree"</span>: degree,</span>
<span id="cb33-177"><a href="#cb33-177" aria-hidden="true" tabindex="-1"></a>        <span class="st">"betweenness"</span>: betweenness,</span>
<span id="cb33-178"><a href="#cb33-178" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eigenvector"</span>: eigenvector,</span>
<span id="cb33-179"><a href="#cb33-179" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pagerank"</span>: pagerank,</span>
<span id="cb33-180"><a href="#cb33-180" aria-hidden="true" tabindex="-1"></a>        <span class="st">"clustering"</span>: clustering <span class="cf">if</span> clustering <span class="cf">else</span> {n: np.nan <span class="cf">for</span> n <span class="kw">in</span> G.nodes()}</span>
<span id="cb33-181"><a href="#cb33-181" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb33-182"><a href="#cb33-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-183"><a href="#cb33-183" aria-hidden="true" tabindex="-1"></a>    graph_metrics <span class="op">=</span> {</span>
<span id="cb33-184"><a href="#cb33-184" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_nodes"</span>: n_nodes,</span>
<span id="cb33-185"><a href="#cb33-185" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_edges"</span>: n_edges,</span>
<span id="cb33-186"><a href="#cb33-186" aria-hidden="true" tabindex="-1"></a>        <span class="st">"density"</span>: density,</span>
<span id="cb33-187"><a href="#cb33-187" aria-hidden="true" tabindex="-1"></a>        <span class="st">"avg_degree"</span>: avg_degree,</span>
<span id="cb33-188"><a href="#cb33-188" aria-hidden="true" tabindex="-1"></a>        <span class="st">"max_degree"</span>: max_degree,</span>
<span id="cb33-189"><a href="#cb33-189" aria-hidden="true" tabindex="-1"></a>        <span class="st">"assortativity"</span>: assortativity,</span>
<span id="cb33-190"><a href="#cb33-190" aria-hidden="true" tabindex="-1"></a>        <span class="st">"modularity"</span>: modularity,</span>
<span id="cb33-191"><a href="#cb33-191" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_communities"</span>: n_communities</span>
<span id="cb33-192"><a href="#cb33-192" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-193"><a href="#cb33-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-194"><a href="#cb33-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> node_metrics, graph_metrics</span>
<span id="cb33-195"><a href="#cb33-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-196"><a href="#cb33-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-197"><a href="#cb33-197" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Adjacency Matrix and Its Spectral Properties</span></span>
<span id="cb33-198"><a href="#cb33-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-199"><a href="#cb33-199" aria-hidden="true" tabindex="-1"></a>The adjacency matrix $A \in \mathbb{R}^{n \times n}$ encodes the graph structure: $A_{ij} = w_{ij}$ if there is an edge from $i$ to $j$ with weight $w_{ij}$, and $A_{ij} = 0$ otherwise. For undirected graphs, $A$ is symmetric.</span>
<span id="cb33-200"><a href="#cb33-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-201"><a href="#cb33-201" aria-hidden="true" tabindex="-1"></a>The graph Laplacian $L = D - A$ (where $D$ is the diagonal degree matrix) has eigenvalues $0 = \lambda_1 \leq \lambda_2 \leq \ldots \leq \lambda_n$ with important structural interpretations:</span>
<span id="cb33-202"><a href="#cb33-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-203"><a href="#cb33-203" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The multiplicity of $\lambda = 0$ equals the number of connected components.</span>
<span id="cb33-204"><a href="#cb33-204" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The second eigenvalue $\lambda_2$ (the algebraic connectivity or Fiedler value) measures how well-connected the graph is. Low $\lambda_2$ implies the graph has a bottleneck, which is a weak point where cutting a few edges would disconnect large portions.</span>
<span id="cb33-205"><a href="#cb33-205" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The eigenvectors of $L$ provide the spectral embedding of the graph, which is the foundation for spectral clustering and graph convolutional networks.</span>
<span id="cb33-206"><a href="#cb33-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-207"><a href="#cb33-207" aria-hidden="true" tabindex="-1"></a>The normalized Laplacian $\tilde{L} = D^{-1/2} L D^{-1/2}$ is used in GCNs because it stabilizes message passing across nodes with different degrees.</span>
<span id="cb33-208"><a href="#cb33-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-211"><a href="#cb33-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-212"><a href="#cb33-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: spectral-analysis</span></span>
<span id="cb33-213"><a href="#cb33-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-214"><a href="#cb33-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-215"><a href="#cb33-215" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> spectral_graph_analysis(A, n_components<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb33-216"><a href="#cb33-216" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-217"><a href="#cb33-217" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute spectral properties of a financial network.</span></span>
<span id="cb33-218"><a href="#cb33-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-219"><a href="#cb33-219" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-220"><a href="#cb33-220" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-221"><a href="#cb33-221" aria-hidden="true" tabindex="-1"></a><span class="co">    A : np.ndarray or sparse matrix</span></span>
<span id="cb33-222"><a href="#cb33-222" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjacency matrix.</span></span>
<span id="cb33-223"><a href="#cb33-223" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb33-224"><a href="#cb33-224" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of eigenvalues/vectors to compute.</span></span>
<span id="cb33-225"><a href="#cb33-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-226"><a href="#cb33-226" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-227"><a href="#cb33-227" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-228"><a href="#cb33-228" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Eigenvalues, algebraic connectivity, spectral gap.</span></span>
<span id="cb33-229"><a href="#cb33-229" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-230"><a href="#cb33-230" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> A.shape[<span class="dv">0</span>]</span>
<span id="cb33-231"><a href="#cb33-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-232"><a href="#cb33-232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sparse.issparse(A):</span>
<span id="cb33-233"><a href="#cb33-233" aria-hidden="true" tabindex="-1"></a>        A_dense <span class="op">=</span> A.toarray()</span>
<span id="cb33-234"><a href="#cb33-234" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-235"><a href="#cb33-235" aria-hidden="true" tabindex="-1"></a>        A_dense <span class="op">=</span> A</span>
<span id="cb33-236"><a href="#cb33-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-237"><a href="#cb33-237" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Degree matrix</span></span>
<span id="cb33-238"><a href="#cb33-238" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> np.diag(A_dense.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb33-239"><a href="#cb33-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-240"><a href="#cb33-240" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Graph Laplacian</span></span>
<span id="cb33-241"><a href="#cb33-241" aria-hidden="true" tabindex="-1"></a>    L <span class="op">=</span> D <span class="op">-</span> A_dense</span>
<span id="cb33-242"><a href="#cb33-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-243"><a href="#cb33-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalized Laplacian</span></span>
<span id="cb33-244"><a href="#cb33-244" aria-hidden="true" tabindex="-1"></a>    D_inv_sqrt <span class="op">=</span> np.diag(<span class="fl">1.0</span> <span class="op">/</span> np.sqrt(np.diag(D) <span class="op">+</span> <span class="fl">1e-10</span>))</span>
<span id="cb33-245"><a href="#cb33-245" aria-hidden="true" tabindex="-1"></a>    L_norm <span class="op">=</span> D_inv_sqrt <span class="op">@</span> L <span class="op">@</span> D_inv_sqrt</span>
<span id="cb33-246"><a href="#cb33-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-247"><a href="#cb33-247" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Eigendecomposition (smallest eigenvalues)</span></span>
<span id="cb33-248"><a href="#cb33-248" aria-hidden="true" tabindex="-1"></a>    eigenvalues, eigenvectors <span class="op">=</span> np.linalg.eigh(L_norm)</span>
<span id="cb33-249"><a href="#cb33-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-250"><a href="#cb33-250" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by eigenvalue</span></span>
<span id="cb33-251"><a href="#cb33-251" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> np.argsort(eigenvalues)</span>
<span id="cb33-252"><a href="#cb33-252" aria-hidden="true" tabindex="-1"></a>    eigenvalues <span class="op">=</span> eigenvalues[idx]</span>
<span id="cb33-253"><a href="#cb33-253" aria-hidden="true" tabindex="-1"></a>    eigenvectors <span class="op">=</span> eigenvectors[:, idx]</span>
<span id="cb33-254"><a href="#cb33-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-255"><a href="#cb33-255" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Algebraic connectivity (Fiedler value)</span></span>
<span id="cb33-256"><a href="#cb33-256" aria-hidden="true" tabindex="-1"></a>    fiedler_value <span class="op">=</span> eigenvalues[<span class="dv">1</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-257"><a href="#cb33-257" aria-hidden="true" tabindex="-1"></a>    fiedler_vector <span class="op">=</span> eigenvectors[:, <span class="dv">1</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> np.zeros(n)</span>
<span id="cb33-258"><a href="#cb33-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-259"><a href="#cb33-259" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Spectral gap</span></span>
<span id="cb33-260"><a href="#cb33-260" aria-hidden="true" tabindex="-1"></a>    spectral_gap <span class="op">=</span> eigenvalues[<span class="dv">1</span>] <span class="op">-</span> eigenvalues[<span class="dv">0</span>] <span class="cf">if</span> n <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-261"><a href="#cb33-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-262"><a href="#cb33-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb33-263"><a href="#cb33-263" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eigenvalues"</span>: eigenvalues[:n_components],</span>
<span id="cb33-264"><a href="#cb33-264" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fiedler_value"</span>: fiedler_value,</span>
<span id="cb33-265"><a href="#cb33-265" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fiedler_vector"</span>: fiedler_vector,</span>
<span id="cb33-266"><a href="#cb33-266" aria-hidden="true" tabindex="-1"></a>        <span class="st">"spectral_gap"</span>: spectral_gap,</span>
<span id="cb33-267"><a href="#cb33-267" aria-hidden="true" tabindex="-1"></a>        <span class="st">"spectral_embedding"</span>: eigenvectors[:, <span class="dv">1</span>:n_components <span class="op">+</span> <span class="dv">1</span>]</span>
<span id="cb33-268"><a href="#cb33-268" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-269"><a href="#cb33-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-270"><a href="#cb33-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-271"><a href="#cb33-271" aria-hidden="true" tabindex="-1"></a><span class="fu">## Ownership and Control Networks</span></span>
<span id="cb33-272"><a href="#cb33-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-273"><a href="#cb33-273" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vietnamese Ownership Structure</span></span>
<span id="cb33-274"><a href="#cb33-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-275"><a href="#cb33-275" aria-hidden="true" tabindex="-1"></a>Ownership networks are arguably the most economically consequential graph structure in Vietnamese markets. The Vietnamese corporate landscape is characterized by three distinctive features that generate complex ownership topologies:</span>
<span id="cb33-276"><a href="#cb33-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-277"><a href="#cb33-277" aria-hidden="true" tabindex="-1"></a>**State ownership pyramids.** The government holds equity in hundreds of firms through a hierarchy of holding entities: the State Capital Investment Corporation (SCIC), line ministries, provincial People's Committees, and state-owned economic groups (t·∫≠p ƒëo√†n kinh t·∫ø nh√† n∆∞·ªõc). These chains create multi-layered pyramids where the state's ultimate control rights may substantially exceed its cash flow rights.</span>
<span id="cb33-278"><a href="#cb33-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-279"><a href="#cb33-279" aria-hidden="true" tabindex="-1"></a>**Private business groups.** Vietnamese conglomerates (Vingroup, Masan, FPT, Ho√† Ph√°t, Thaco) create complex webs of cross-ownership, subsidiary relationships, and associate stakes. These structures serve multiple purposes: internal capital markets, tax optimization, regulatory arbitrage, and control enhancement.</span>
<span id="cb33-280"><a href="#cb33-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-281"><a href="#cb33-281" aria-hidden="true" tabindex="-1"></a>**Circular and cross-ownership.** Vietnamese regulations do not effectively prevent circular ownership (firm $A$ owns firm $B$ which owns firm $C$ which owns firm $A$), creating loops in the ownership graph that amplify control beyond direct stakes and inflate accounting equity <span class="co">[</span><span class="ot">@bebchuk1999rent</span><span class="co">]</span>.</span>
<span id="cb33-282"><a href="#cb33-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-285"><a href="#cb33-285" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-286"><a href="#cb33-286" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ownership-network-data</span></span>
<span id="cb33-287"><a href="#cb33-287" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-288"><a href="#cb33-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-289"><a href="#cb33-289" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ownership data</span></span>
<span id="cb33-290"><a href="#cb33-290" aria-hidden="true" tabindex="-1"></a>ownership <span class="op">=</span> dc.get_ownership_network(</span>
<span id="cb33-291"><a href="#cb33-291" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span>,</span>
<span id="cb33-292"><a href="#cb33-292" aria-hidden="true" tabindex="-1"></a>    min_stake<span class="op">=</span><span class="fl">1.0</span>  <span class="co"># Minimum 1% ownership stake</span></span>
<span id="cb33-293"><a href="#cb33-293" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-294"><a href="#cb33-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-295"><a href="#cb33-295" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm characteristics</span></span>
<span id="cb33-296"><a href="#cb33-296" aria-hidden="true" tabindex="-1"></a>firms <span class="op">=</span> dc.get_firm_characteristics(</span>
<span id="cb33-297"><a href="#cb33-297" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2024-01-01"</span>,</span>
<span id="cb33-298"><a href="#cb33-298" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb33-299"><a href="#cb33-299" aria-hidden="true" tabindex="-1"></a>).groupby(<span class="st">"ticker"</span>).last().reset_index()</span>
<span id="cb33-300"><a href="#cb33-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-301"><a href="#cb33-301" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Ownership edges: </span><span class="sc">{</span><span class="bu">len</span>(ownership)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-302"><a href="#cb33-302" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique owners: </span><span class="sc">{</span>ownership[<span class="st">'owner_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-303"><a href="#cb33-303" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique targets: </span><span class="sc">{</span>ownership[<span class="st">'target_ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-304"><a href="#cb33-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-305"><a href="#cb33-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-308"><a href="#cb33-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-309"><a href="#cb33-309" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: build-ownership-graph</span></span>
<span id="cb33-310"><a href="#cb33-310" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-311"><a href="#cb33-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-312"><a href="#cb33-312" aria-hidden="true" tabindex="-1"></a><span class="co"># Build directed ownership graph</span></span>
<span id="cb33-313"><a href="#cb33-313" aria-hidden="true" tabindex="-1"></a>G_own <span class="op">=</span> nx.DiGraph()</span>
<span id="cb33-314"><a href="#cb33-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-315"><a href="#cb33-315" aria-hidden="true" tabindex="-1"></a><span class="co"># Add firm nodes with attributes</span></span>
<span id="cb33-316"><a href="#cb33-316" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> firms.iterrows():</span>
<span id="cb33-317"><a href="#cb33-317" aria-hidden="true" tabindex="-1"></a>    G_own.add_node(</span>
<span id="cb33-318"><a href="#cb33-318" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"ticker"</span>],</span>
<span id="cb33-319"><a href="#cb33-319" aria-hidden="true" tabindex="-1"></a>        node_type<span class="op">=</span><span class="st">"firm"</span>,</span>
<span id="cb33-320"><a href="#cb33-320" aria-hidden="true" tabindex="-1"></a>        market_cap<span class="op">=</span>row.get(<span class="st">"market_cap"</span>, <span class="dv">0</span>),</span>
<span id="cb33-321"><a href="#cb33-321" aria-hidden="true" tabindex="-1"></a>        industry<span class="op">=</span>row.get(<span class="st">"industry"</span>, <span class="st">"Unknown"</span>),</span>
<span id="cb33-322"><a href="#cb33-322" aria-hidden="true" tabindex="-1"></a>        is_soe<span class="op">=</span>row.get(<span class="st">"state_ownership_pct"</span>, <span class="dv">0</span>) <span class="op">&gt;</span> <span class="dv">50</span></span>
<span id="cb33-323"><a href="#cb33-323" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-324"><a href="#cb33-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-325"><a href="#cb33-325" aria-hidden="true" tabindex="-1"></a><span class="co"># Add ownership edges</span></span>
<span id="cb33-326"><a href="#cb33-326" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> ownership.iterrows():</span>
<span id="cb33-327"><a href="#cb33-327" aria-hidden="true" tabindex="-1"></a>    owner <span class="op">=</span> row[<span class="st">"owner_id"</span>]</span>
<span id="cb33-328"><a href="#cb33-328" aria-hidden="true" tabindex="-1"></a>    target <span class="op">=</span> row[<span class="st">"target_ticker"</span>]</span>
<span id="cb33-329"><a href="#cb33-329" aria-hidden="true" tabindex="-1"></a>    stake <span class="op">=</span> row[<span class="st">"ownership_pct"</span>]</span>
<span id="cb33-330"><a href="#cb33-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-331"><a href="#cb33-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add owner node if not present</span></span>
<span id="cb33-332"><a href="#cb33-332" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> owner <span class="kw">not</span> <span class="kw">in</span> G_own:</span>
<span id="cb33-333"><a href="#cb33-333" aria-hidden="true" tabindex="-1"></a>        G_own.add_node(</span>
<span id="cb33-334"><a href="#cb33-334" aria-hidden="true" tabindex="-1"></a>            owner,</span>
<span id="cb33-335"><a href="#cb33-335" aria-hidden="true" tabindex="-1"></a>            node_type<span class="op">=</span>row.get(<span class="st">"owner_type"</span>, <span class="st">"entity"</span>),</span>
<span id="cb33-336"><a href="#cb33-336" aria-hidden="true" tabindex="-1"></a>            market_cap<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb33-337"><a href="#cb33-337" aria-hidden="true" tabindex="-1"></a>            industry<span class="op">=</span><span class="st">"Holding"</span></span>
<span id="cb33-338"><a href="#cb33-338" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-339"><a href="#cb33-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-340"><a href="#cb33-340" aria-hidden="true" tabindex="-1"></a>    G_own.add_edge(owner, target, weight<span class="op">=</span>stake <span class="op">/</span> <span class="dv">100</span>)</span>
<span id="cb33-341"><a href="#cb33-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-342"><a href="#cb33-342" aria-hidden="true" tabindex="-1"></a>node_metrics_own, graph_metrics_own <span class="op">=</span> compute_network_metrics(G_own)</span>
<span id="cb33-343"><a href="#cb33-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-344"><a href="#cb33-344" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Ownership Network Summary:"</span>)</span>
<span id="cb33-345"><a href="#cb33-345" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> graph_metrics_own.items():</span>
<span id="cb33-346"><a href="#cb33-346" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-347"><a href="#cb33-347" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-348"><a href="#cb33-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-351"><a href="#cb33-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-352"><a href="#cb33-352" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ownership-network-stats</span></span>
<span id="cb33-353"><a href="#cb33-353" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-354"><a href="#cb33-354" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Ownership Network: Graph-Level Statistics"</span></span>
<span id="cb33-355"><a href="#cb33-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-356"><a href="#cb33-356" aria-hidden="true" tabindex="-1"></a>own_stats <span class="op">=</span> pd.DataFrame([graph_metrics_own]).T</span>
<span id="cb33-357"><a href="#cb33-357" aria-hidden="true" tabindex="-1"></a>own_stats.columns <span class="op">=</span> [<span class="st">"Value"</span>]</span>
<span id="cb33-358"><a href="#cb33-358" aria-hidden="true" tabindex="-1"></a>own_stats <span class="op">=</span> own_stats.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb33-359"><a href="#cb33-359" aria-hidden="true" tabindex="-1"></a>own_stats</span>
<span id="cb33-360"><a href="#cb33-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-361"><a href="#cb33-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-362"><a href="#cb33-362" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ultimate Ownership and Control Chains</span></span>
<span id="cb33-363"><a href="#cb33-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-364"><a href="#cb33-364" aria-hidden="true" tabindex="-1"></a>Direct ownership understates the actual control exercised through pyramidal chains. The ultimate ownership stake of entity $A$ in firm $Z$ through a chain $A \to B \to C \to Z$ is the product of intermediate stakes:</span>
<span id="cb33-365"><a href="#cb33-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-366"><a href="#cb33-366" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-367"><a href="#cb33-367" aria-hidden="true" tabindex="-1"></a>\omega_{A \to Z}^{\text{ultimate}} = \prod_{(i,j) \in \text{path}(A, Z)} w_{ij}</span>
<span id="cb33-368"><a href="#cb33-368" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ultimate-ownership}</span>
<span id="cb33-369"><a href="#cb33-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-370"><a href="#cb33-370" aria-hidden="true" tabindex="-1"></a>where $w_{ij}$ is the direct stake of $i$ in $j$. When multiple paths exist from $A$ to $Z$, the total ultimate ownership is the sum across paths. The control rights, however, are determined by the weakest link in the chain (the minimum stake along the path), reflecting the principle that control requires a majority at each level.</span>
<span id="cb33-371"><a href="#cb33-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-374"><a href="#cb33-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-375"><a href="#cb33-375" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ultimate-ownership</span></span>
<span id="cb33-376"><a href="#cb33-376" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-377"><a href="#cb33-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-378"><a href="#cb33-378" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ultimate_ownership(G, source, target, max_depth<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb33-379"><a href="#cb33-379" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-380"><a href="#cb33-380" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute ultimate ownership of source in target through all paths.</span></span>
<span id="cb33-381"><a href="#cb33-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-382"><a href="#cb33-382" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-383"><a href="#cb33-383" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-384"><a href="#cb33-384" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb33-385"><a href="#cb33-385" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership graph with edge weights as ownership fractions.</span></span>
<span id="cb33-386"><a href="#cb33-386" aria-hidden="true" tabindex="-1"></a><span class="co">    source : str</span></span>
<span id="cb33-387"><a href="#cb33-387" aria-hidden="true" tabindex="-1"></a><span class="co">        Ultimate owner node.</span></span>
<span id="cb33-388"><a href="#cb33-388" aria-hidden="true" tabindex="-1"></a><span class="co">    target : str</span></span>
<span id="cb33-389"><a href="#cb33-389" aria-hidden="true" tabindex="-1"></a><span class="co">        Target firm node.</span></span>
<span id="cb33-390"><a href="#cb33-390" aria-hidden="true" tabindex="-1"></a><span class="co">    max_depth : int</span></span>
<span id="cb33-391"><a href="#cb33-391" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum chain length to consider.</span></span>
<span id="cb33-392"><a href="#cb33-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-393"><a href="#cb33-393" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-394"><a href="#cb33-394" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-395"><a href="#cb33-395" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Total ownership, control rights, number of paths.</span></span>
<span id="cb33-396"><a href="#cb33-396" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-397"><a href="#cb33-397" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> source <span class="kw">not</span> <span class="kw">in</span> G <span class="kw">or</span> target <span class="kw">not</span> <span class="kw">in</span> G:</span>
<span id="cb33-398"><a href="#cb33-398" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"ownership"</span>: <span class="dv">0</span>, <span class="st">"control"</span>: <span class="dv">0</span>, <span class="st">"n_paths"</span>: <span class="dv">0</span>}</span>
<span id="cb33-399"><a href="#cb33-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-400"><a href="#cb33-400" aria-hidden="true" tabindex="-1"></a>    total_ownership <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-401"><a href="#cb33-401" aria-hidden="true" tabindex="-1"></a>    max_control <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-402"><a href="#cb33-402" aria-hidden="true" tabindex="-1"></a>    n_paths <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-403"><a href="#cb33-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-404"><a href="#cb33-404" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find all simple paths from source to target</span></span>
<span id="cb33-405"><a href="#cb33-405" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb33-406"><a href="#cb33-406" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> nx.all_simple_paths(G, source, target,</span>
<span id="cb33-407"><a href="#cb33-407" aria-hidden="true" tabindex="-1"></a>                                         cutoff<span class="op">=</span>max_depth):</span>
<span id="cb33-408"><a href="#cb33-408" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Cash flow rights: product of stakes</span></span>
<span id="cb33-409"><a href="#cb33-409" aria-hidden="true" tabindex="-1"></a>            ownership <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb33-410"><a href="#cb33-410" aria-hidden="true" tabindex="-1"></a>            min_stake <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb33-411"><a href="#cb33-411" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(path) <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb33-412"><a href="#cb33-412" aria-hidden="true" tabindex="-1"></a>                edge_data <span class="op">=</span> G[path[i]][path[i <span class="op">+</span> <span class="dv">1</span>]]</span>
<span id="cb33-413"><a href="#cb33-413" aria-hidden="true" tabindex="-1"></a>                stake <span class="op">=</span> edge_data.get(<span class="st">"weight"</span>, <span class="dv">0</span>)</span>
<span id="cb33-414"><a href="#cb33-414" aria-hidden="true" tabindex="-1"></a>                ownership <span class="op">*=</span> stake</span>
<span id="cb33-415"><a href="#cb33-415" aria-hidden="true" tabindex="-1"></a>                min_stake <span class="op">=</span> <span class="bu">min</span>(min_stake, stake)</span>
<span id="cb33-416"><a href="#cb33-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-417"><a href="#cb33-417" aria-hidden="true" tabindex="-1"></a>            total_ownership <span class="op">+=</span> ownership</span>
<span id="cb33-418"><a href="#cb33-418" aria-hidden="true" tabindex="-1"></a>            max_control <span class="op">=</span> <span class="bu">max</span>(max_control, min_stake)</span>
<span id="cb33-419"><a href="#cb33-419" aria-hidden="true" tabindex="-1"></a>            n_paths <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb33-420"><a href="#cb33-420" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> nx.NetworkXNoPath:</span>
<span id="cb33-421"><a href="#cb33-421" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb33-422"><a href="#cb33-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-423"><a href="#cb33-423" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb33-424"><a href="#cb33-424" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ownership"</span>: total_ownership,</span>
<span id="cb33-425"><a href="#cb33-425" aria-hidden="true" tabindex="-1"></a>        <span class="st">"control"</span>: max_control,</span>
<span id="cb33-426"><a href="#cb33-426" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_paths"</span>: n_paths</span>
<span id="cb33-427"><a href="#cb33-427" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-428"><a href="#cb33-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-429"><a href="#cb33-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-430"><a href="#cb33-430" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_control_wedge(G, firms_list, max_depth<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb33-431"><a href="#cb33-431" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-432"><a href="#cb33-432" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the wedge between control and cash flow rights</span></span>
<span id="cb33-433"><a href="#cb33-433" aria-hidden="true" tabindex="-1"></a><span class="co">    for the largest shareholder of each firm.</span></span>
<span id="cb33-434"><a href="#cb33-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-435"><a href="#cb33-435" aria-hidden="true" tabindex="-1"></a><span class="co">    The wedge = control rights - cash flow rights.</span></span>
<span id="cb33-436"><a href="#cb33-436" aria-hidden="true" tabindex="-1"></a><span class="co">    Positive wedge ‚Üí potential for tunneling.</span></span>
<span id="cb33-437"><a href="#cb33-437" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-438"><a href="#cb33-438" aria-hidden="true" tabindex="-1"></a>    wedge_data <span class="op">=</span> []</span>
<span id="cb33-439"><a href="#cb33-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-440"><a href="#cb33-440" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> firm <span class="kw">in</span> firms_list:</span>
<span id="cb33-441"><a href="#cb33-441" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> firm <span class="kw">not</span> <span class="kw">in</span> G:</span>
<span id="cb33-442"><a href="#cb33-442" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-443"><a href="#cb33-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-444"><a href="#cb33-444" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find all direct owners</span></span>
<span id="cb33-445"><a href="#cb33-445" aria-hidden="true" tabindex="-1"></a>        predecessors <span class="op">=</span> <span class="bu">list</span>(G.predecessors(firm))</span>
<span id="cb33-446"><a href="#cb33-446" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> predecessors:</span>
<span id="cb33-447"><a href="#cb33-447" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-448"><a href="#cb33-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-449"><a href="#cb33-449" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find largest direct owner</span></span>
<span id="cb33-450"><a href="#cb33-450" aria-hidden="true" tabindex="-1"></a>        stakes <span class="op">=</span> {p: G[p][firm][<span class="st">"weight"</span>] <span class="cf">for</span> p <span class="kw">in</span> predecessors}</span>
<span id="cb33-451"><a href="#cb33-451" aria-hidden="true" tabindex="-1"></a>        largest_owner <span class="op">=</span> <span class="bu">max</span>(stakes, key<span class="op">=</span>stakes.get)</span>
<span id="cb33-452"><a href="#cb33-452" aria-hidden="true" tabindex="-1"></a>        direct_stake <span class="op">=</span> stakes[largest_owner]</span>
<span id="cb33-453"><a href="#cb33-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-454"><a href="#cb33-454" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute ultimate ownership through all paths</span></span>
<span id="cb33-455"><a href="#cb33-455" aria-hidden="true" tabindex="-1"></a>        ultimate <span class="op">=</span> compute_ultimate_ownership(</span>
<span id="cb33-456"><a href="#cb33-456" aria-hidden="true" tabindex="-1"></a>            G, largest_owner, firm, max_depth</span>
<span id="cb33-457"><a href="#cb33-457" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-458"><a href="#cb33-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-459"><a href="#cb33-459" aria-hidden="true" tabindex="-1"></a>        wedge_data.append({</span>
<span id="cb33-460"><a href="#cb33-460" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ticker"</span>: firm,</span>
<span id="cb33-461"><a href="#cb33-461" aria-hidden="true" tabindex="-1"></a>            <span class="st">"largest_owner"</span>: largest_owner,</span>
<span id="cb33-462"><a href="#cb33-462" aria-hidden="true" tabindex="-1"></a>            <span class="st">"direct_stake"</span>: direct_stake,</span>
<span id="cb33-463"><a href="#cb33-463" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ultimate_ownership"</span>: ultimate[<span class="st">"ownership"</span>],</span>
<span id="cb33-464"><a href="#cb33-464" aria-hidden="true" tabindex="-1"></a>            <span class="st">"control_rights"</span>: ultimate[<span class="st">"control"</span>],</span>
<span id="cb33-465"><a href="#cb33-465" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_ownership_paths"</span>: ultimate[<span class="st">"n_paths"</span>],</span>
<span id="cb33-466"><a href="#cb33-466" aria-hidden="true" tabindex="-1"></a>            <span class="st">"wedge"</span>: ultimate[<span class="st">"control"</span>] <span class="op">-</span> ultimate[<span class="st">"ownership"</span>]</span>
<span id="cb33-467"><a href="#cb33-467" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb33-468"><a href="#cb33-468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-469"><a href="#cb33-469" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(wedge_data)</span>
<span id="cb33-470"><a href="#cb33-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-471"><a href="#cb33-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-472"><a href="#cb33-472" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute for all listed firms</span></span>
<span id="cb33-473"><a href="#cb33-473" aria-hidden="true" tabindex="-1"></a>listed_firms <span class="op">=</span> [n <span class="cf">for</span> n, d <span class="kw">in</span> G_own.nodes(data<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-474"><a href="#cb33-474" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> d.get(<span class="st">"node_type"</span>) <span class="op">==</span> <span class="st">"firm"</span>]</span>
<span id="cb33-475"><a href="#cb33-475" aria-hidden="true" tabindex="-1"></a>wedge_df <span class="op">=</span> compute_control_wedge(G_own, listed_firms)</span>
<span id="cb33-476"><a href="#cb33-476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-477"><a href="#cb33-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-480"><a href="#cb33-480" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-481"><a href="#cb33-481" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-control-wedge</span></span>
<span id="cb33-482"><a href="#cb33-482" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-483"><a href="#cb33-483" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Control-Cash Flow Wedge: Summary Statistics"</span></span>
<span id="cb33-484"><a href="#cb33-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-485"><a href="#cb33-485" aria-hidden="true" tabindex="-1"></a>wedge_summary <span class="op">=</span> wedge_df[</span>
<span id="cb33-486"><a href="#cb33-486" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"direct_stake"</span>, <span class="st">"ultimate_ownership"</span>, <span class="st">"control_rights"</span>,</span>
<span id="cb33-487"><a href="#cb33-487" aria-hidden="true" tabindex="-1"></a>     <span class="st">"n_ownership_paths"</span>, <span class="st">"wedge"</span>]</span>
<span id="cb33-488"><a href="#cb33-488" aria-hidden="true" tabindex="-1"></a>].describe(percentiles<span class="op">=</span>[<span class="fl">0.1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.9</span>]).T.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb33-489"><a href="#cb33-489" aria-hidden="true" tabindex="-1"></a>wedge_summary</span>
<span id="cb33-490"><a href="#cb33-490" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-491"><a href="#cb33-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-494"><a href="#cb33-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-495"><a href="#cb33-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-control-wedge</span></span>
<span id="cb33-496"><a href="#cb33-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-497"><a href="#cb33-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of Control-Cash Flow Wedge Across Vietnamese Listed Firms"</span></span>
<span id="cb33-498"><a href="#cb33-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-499"><a href="#cb33-499" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb33-500"><a href="#cb33-500" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(wedge_df, p9.aes(x<span class="op">=</span><span class="st">"wedge"</span>))</span>
<span id="cb33-501"><a href="#cb33-501" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb33-502"><a href="#cb33-502" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>)</span>
<span id="cb33-503"><a href="#cb33-503" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb33-504"><a href="#cb33-504" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Control Wedge (Control Rights ‚àí Cash Flow Rights)"</span>,</span>
<span id="cb33-505"><a href="#cb33-505" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb33-506"><a href="#cb33-506" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Control-Ownership Wedge: Positive Values Indicate Tunneling Risk"</span></span>
<span id="cb33-507"><a href="#cb33-507" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-508"><a href="#cb33-508" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb33-509"><a href="#cb33-509" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb33-510"><a href="#cb33-510" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-511"><a href="#cb33-511" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-512"><a href="#cb33-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-513"><a href="#cb33-513" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ownership Centrality and Firm Value</span></span>
<span id="cb33-514"><a href="#cb33-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-515"><a href="#cb33-515" aria-hidden="true" tabindex="-1"></a>We test whether a firm's position in the ownership network predicts its market valuation, controlling for standard determinants:</span>
<span id="cb33-516"><a href="#cb33-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-517"><a href="#cb33-517" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-518"><a href="#cb33-518" aria-hidden="true" tabindex="-1"></a>Q_{i,t} = \beta_0 + \beta_1 \text{Centrality}_{i,t} + \beta_2 \text{Wedge}_{i,t} + \boldsymbol{\gamma}' \mathbf{X}_{i,t} + \alpha_{\text{ind}} + \delta_t + \varepsilon_{i,t}</span>
<span id="cb33-519"><a href="#cb33-519" aria-hidden="true" tabindex="-1"></a>$$ {#eq-network-valuation}</span>
<span id="cb33-520"><a href="#cb33-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-523"><a href="#cb33-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-524"><a href="#cb33-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ownership-valuation</span></span>
<span id="cb33-525"><a href="#cb33-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-526"><a href="#cb33-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-527"><a href="#cb33-527" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge network metrics with firm characteristics</span></span>
<span id="cb33-528"><a href="#cb33-528" aria-hidden="true" tabindex="-1"></a>node_metrics_own_df <span class="op">=</span> node_metrics_own.reset_index().rename(</span>
<span id="cb33-529"><a href="#cb33-529" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"index"</span>: <span class="st">"ticker"</span>}</span>
<span id="cb33-530"><a href="#cb33-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-531"><a href="#cb33-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-532"><a href="#cb33-532" aria-hidden="true" tabindex="-1"></a>valuation_data <span class="op">=</span> firms.merge(node_metrics_own_df, on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb33-533"><a href="#cb33-533" aria-hidden="true" tabindex="-1"></a>valuation_data <span class="op">=</span> valuation_data.merge(</span>
<span id="cb33-534"><a href="#cb33-534" aria-hidden="true" tabindex="-1"></a>    wedge_df[[<span class="st">"ticker"</span>, <span class="st">"wedge"</span>, <span class="st">"n_ownership_paths"</span>]],</span>
<span id="cb33-535"><a href="#cb33-535" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb33-536"><a href="#cb33-536" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-537"><a href="#cb33-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-538"><a href="#cb33-538" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel regression</span></span>
<span id="cb33-539"><a href="#cb33-539" aria-hidden="true" tabindex="-1"></a>val_clean <span class="op">=</span> valuation_data.dropna(</span>
<span id="cb33-540"><a href="#cb33-540" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"tobins_q"</span>, <span class="st">"eigenvector"</span>, <span class="st">"wedge"</span>,</span>
<span id="cb33-541"><a href="#cb33-541" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_size"</span>, <span class="st">"profitability"</span>, <span class="st">"leverage"</span>]</span>
<span id="cb33-542"><a href="#cb33-542" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-543"><a href="#cb33-543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-544"><a href="#cb33-544" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(val_clean) <span class="op">&gt;</span> <span class="dv">50</span>:</span>
<span id="cb33-545"><a href="#cb33-545" aria-hidden="true" tabindex="-1"></a>    model_network_val <span class="op">=</span> sm.OLS(</span>
<span id="cb33-546"><a href="#cb33-546" aria-hidden="true" tabindex="-1"></a>        val_clean[<span class="st">"tobins_q"</span>],</span>
<span id="cb33-547"><a href="#cb33-547" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(val_clean[[</span>
<span id="cb33-548"><a href="#cb33-548" aria-hidden="true" tabindex="-1"></a>            <span class="st">"eigenvector"</span>, <span class="st">"betweenness"</span>, <span class="st">"wedge"</span>,</span>
<span id="cb33-549"><a href="#cb33-549" aria-hidden="true" tabindex="-1"></a>            <span class="st">"log_size"</span>, <span class="st">"profitability"</span>, <span class="st">"leverage"</span></span>
<span id="cb33-550"><a href="#cb33-550" aria-hidden="true" tabindex="-1"></a>        ]])</span>
<span id="cb33-551"><a href="#cb33-551" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb33-552"><a href="#cb33-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-553"><a href="#cb33-553" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Ownership Network Position and Firm Value:"</span>)</span>
<span id="cb33-554"><a href="#cb33-554" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">"eigenvector"</span>, <span class="st">"betweenness"</span>, <span class="st">"wedge"</span>]:</span>
<span id="cb33-555"><a href="#cb33-555" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>model_network_val<span class="sc">.</span>params[var]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb33-556"><a href="#cb33-556" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"(t = </span><span class="sc">{</span>model_network_val<span class="sc">.</span>tvalues[var]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb33-557"><a href="#cb33-557" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-558"><a href="#cb33-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-559"><a href="#cb33-559" aria-hidden="true" tabindex="-1"></a><span class="fu">### Business Group Detection</span></span>
<span id="cb33-560"><a href="#cb33-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-561"><a href="#cb33-561" aria-hidden="true" tabindex="-1"></a>Business groups (i.e., collections of legally independent firms linked by common ownership) are a defining feature of Vietnamese corporate structure. We detect them algorithmically using community detection on the ownership graph.</span>
<span id="cb33-562"><a href="#cb33-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-565"><a href="#cb33-565" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-566"><a href="#cb33-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: business-groups</span></span>
<span id="cb33-567"><a href="#cb33-567" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-568"><a href="#cb33-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-569"><a href="#cb33-569" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_business_groups(G, min_group_size<span class="op">=</span><span class="dv">3</span>, ownership_threshold<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb33-570"><a href="#cb33-570" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-571"><a href="#cb33-571" aria-hidden="true" tabindex="-1"></a><span class="co">    Detect business groups from ownership network.</span></span>
<span id="cb33-572"><a href="#cb33-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-573"><a href="#cb33-573" aria-hidden="true" tabindex="-1"></a><span class="co">    A business group is a connected component in the undirected</span></span>
<span id="cb33-574"><a href="#cb33-574" aria-hidden="true" tabindex="-1"></a><span class="co">    projection of the ownership graph, filtered for economically</span></span>
<span id="cb33-575"><a href="#cb33-575" aria-hidden="true" tabindex="-1"></a><span class="co">    meaningful ownership stakes.</span></span>
<span id="cb33-576"><a href="#cb33-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-577"><a href="#cb33-577" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-578"><a href="#cb33-578" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-579"><a href="#cb33-579" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb33-580"><a href="#cb33-580" aria-hidden="true" tabindex="-1"></a><span class="co">        Directed ownership graph.</span></span>
<span id="cb33-581"><a href="#cb33-581" aria-hidden="true" tabindex="-1"></a><span class="co">    min_group_size : int</span></span>
<span id="cb33-582"><a href="#cb33-582" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum firms in a group.</span></span>
<span id="cb33-583"><a href="#cb33-583" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_threshold : float</span></span>
<span id="cb33-584"><a href="#cb33-584" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum ownership stake to count as a link.</span></span>
<span id="cb33-585"><a href="#cb33-585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-586"><a href="#cb33-586" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-587"><a href="#cb33-587" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-588"><a href="#cb33-588" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Group assignments with apex firm.</span></span>
<span id="cb33-589"><a href="#cb33-589" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-590"><a href="#cb33-590" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter edges by threshold</span></span>
<span id="cb33-591"><a href="#cb33-591" aria-hidden="true" tabindex="-1"></a>    G_filtered <span class="op">=</span> nx.DiGraph()</span>
<span id="cb33-592"><a href="#cb33-592" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u, v, d <span class="kw">in</span> G.edges(data<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb33-593"><a href="#cb33-593" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> d.get(<span class="st">"weight"</span>, <span class="dv">0</span>) <span class="op">&gt;=</span> ownership_threshold:</span>
<span id="cb33-594"><a href="#cb33-594" aria-hidden="true" tabindex="-1"></a>            G_filtered.add_edge(u, v, <span class="op">**</span>d)</span>
<span id="cb33-595"><a href="#cb33-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-596"><a href="#cb33-596" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to undirected for component detection</span></span>
<span id="cb33-597"><a href="#cb33-597" aria-hidden="true" tabindex="-1"></a>    G_undirected <span class="op">=</span> G_filtered.to_undirected()</span>
<span id="cb33-598"><a href="#cb33-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-599"><a href="#cb33-599" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find connected components</span></span>
<span id="cb33-600"><a href="#cb33-600" aria-hidden="true" tabindex="-1"></a>    components <span class="op">=</span> <span class="bu">list</span>(nx.connected_components(G_undirected))</span>
<span id="cb33-601"><a href="#cb33-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-602"><a href="#cb33-602" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter by size</span></span>
<span id="cb33-603"><a href="#cb33-603" aria-hidden="true" tabindex="-1"></a>    groups <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> components <span class="cf">if</span> <span class="bu">len</span>(c) <span class="op">&gt;=</span> min_group_size]</span>
<span id="cb33-604"><a href="#cb33-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-605"><a href="#cb33-605" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each group, identify the apex (top of pyramid)</span></span>
<span id="cb33-606"><a href="#cb33-606" aria-hidden="true" tabindex="-1"></a>    group_data <span class="op">=</span> []</span>
<span id="cb33-607"><a href="#cb33-607" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> group_id, members <span class="kw">in</span> <span class="bu">enumerate</span>(groups):</span>
<span id="cb33-608"><a href="#cb33-608" aria-hidden="true" tabindex="-1"></a>        subgraph <span class="op">=</span> G_filtered.subgraph(members)</span>
<span id="cb33-609"><a href="#cb33-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-610"><a href="#cb33-610" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apex: node with highest out-degree and lowest in-degree</span></span>
<span id="cb33-611"><a href="#cb33-611" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (controls others but is not controlled)</span></span>
<span id="cb33-612"><a href="#cb33-612" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> {}</span>
<span id="cb33-613"><a href="#cb33-613" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> node <span class="kw">in</span> members:</span>
<span id="cb33-614"><a href="#cb33-614" aria-hidden="true" tabindex="-1"></a>            in_deg <span class="op">=</span> subgraph.in_degree(node)</span>
<span id="cb33-615"><a href="#cb33-615" aria-hidden="true" tabindex="-1"></a>            out_deg <span class="op">=</span> subgraph.out_degree(node)</span>
<span id="cb33-616"><a href="#cb33-616" aria-hidden="true" tabindex="-1"></a>            scores[node] <span class="op">=</span> out_deg <span class="op">-</span> in_deg</span>
<span id="cb33-617"><a href="#cb33-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-618"><a href="#cb33-618" aria-hidden="true" tabindex="-1"></a>        apex <span class="op">=</span> <span class="bu">max</span>(scores, key<span class="op">=</span>scores.get) <span class="cf">if</span> scores <span class="cf">else</span> <span class="bu">list</span>(members)[<span class="dv">0</span>]</span>
<span id="cb33-619"><a href="#cb33-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-620"><a href="#cb33-620" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> member <span class="kw">in</span> members:</span>
<span id="cb33-621"><a href="#cb33-621" aria-hidden="true" tabindex="-1"></a>            node_data <span class="op">=</span> G.nodes.get(member, {})</span>
<span id="cb33-622"><a href="#cb33-622" aria-hidden="true" tabindex="-1"></a>            group_data.append({</span>
<span id="cb33-623"><a href="#cb33-623" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ticker"</span>: member,</span>
<span id="cb33-624"><a href="#cb33-624" aria-hidden="true" tabindex="-1"></a>                <span class="st">"group_id"</span>: group_id,</span>
<span id="cb33-625"><a href="#cb33-625" aria-hidden="true" tabindex="-1"></a>                <span class="st">"group_size"</span>: <span class="bu">len</span>(members),</span>
<span id="cb33-626"><a href="#cb33-626" aria-hidden="true" tabindex="-1"></a>                <span class="st">"apex"</span>: apex,</span>
<span id="cb33-627"><a href="#cb33-627" aria-hidden="true" tabindex="-1"></a>                <span class="st">"is_apex"</span>: member <span class="op">==</span> apex,</span>
<span id="cb33-628"><a href="#cb33-628" aria-hidden="true" tabindex="-1"></a>                <span class="st">"node_type"</span>: node_data.get(<span class="st">"node_type"</span>, <span class="st">"unknown"</span>),</span>
<span id="cb33-629"><a href="#cb33-629" aria-hidden="true" tabindex="-1"></a>                <span class="st">"industry"</span>: node_data.get(<span class="st">"industry"</span>, <span class="st">"Unknown"</span>),</span>
<span id="cb33-630"><a href="#cb33-630" aria-hidden="true" tabindex="-1"></a>                <span class="st">"market_cap"</span>: node_data.get(<span class="st">"market_cap"</span>, <span class="dv">0</span>)</span>
<span id="cb33-631"><a href="#cb33-631" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb33-632"><a href="#cb33-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-633"><a href="#cb33-633" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(group_data)</span>
<span id="cb33-634"><a href="#cb33-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-635"><a href="#cb33-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-636"><a href="#cb33-636" aria-hidden="true" tabindex="-1"></a>groups_df <span class="op">=</span> detect_business_groups(G_own)</span>
<span id="cb33-637"><a href="#cb33-637" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Business groups detected: </span><span class="sc">{</span>groups_df[<span class="st">'group_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-638"><a href="#cb33-638" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms in groups: </span><span class="sc">{</span><span class="bu">len</span>(groups_df[groups_df[<span class="st">'node_type'</span>] <span class="op">==</span> <span class="st">'firm'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-639"><a href="#cb33-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-640"><a href="#cb33-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-643"><a href="#cb33-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-644"><a href="#cb33-644" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-business-groups</span></span>
<span id="cb33-645"><a href="#cb33-645" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-646"><a href="#cb33-646" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Largest Vietnamese Business Groups by Ownership Network Analysis"</span></span>
<span id="cb33-647"><a href="#cb33-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-648"><a href="#cb33-648" aria-hidden="true" tabindex="-1"></a>top_groups <span class="op">=</span> (</span>
<span id="cb33-649"><a href="#cb33-649" aria-hidden="true" tabindex="-1"></a>    groups_df.groupby(<span class="st">"group_id"</span>)</span>
<span id="cb33-650"><a href="#cb33-650" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb33-651"><a href="#cb33-651" aria-hidden="true" tabindex="-1"></a>        apex<span class="op">=</span>(<span class="st">"apex"</span>, <span class="st">"first"</span>),</span>
<span id="cb33-652"><a href="#cb33-652" aria-hidden="true" tabindex="-1"></a>        n_members<span class="op">=</span>(<span class="st">"ticker"</span>, <span class="st">"count"</span>),</span>
<span id="cb33-653"><a href="#cb33-653" aria-hidden="true" tabindex="-1"></a>        n_listed<span class="op">=</span>(<span class="st">"node_type"</span>, <span class="kw">lambda</span> x: (x <span class="op">==</span> <span class="st">"firm"</span>).<span class="bu">sum</span>()),</span>
<span id="cb33-654"><a href="#cb33-654" aria-hidden="true" tabindex="-1"></a>        total_mcap<span class="op">=</span>(<span class="st">"market_cap"</span>, <span class="st">"sum"</span>),</span>
<span id="cb33-655"><a href="#cb33-655" aria-hidden="true" tabindex="-1"></a>        industries<span class="op">=</span>(<span class="st">"industry"</span>, <span class="kw">lambda</span> x: x.nunique())</span>
<span id="cb33-656"><a href="#cb33-656" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-657"><a href="#cb33-657" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"total_mcap"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-658"><a href="#cb33-658" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">15</span>)</span>
<span id="cb33-659"><a href="#cb33-659" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb33-660"><a href="#cb33-660" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-661"><a href="#cb33-661" aria-hidden="true" tabindex="-1"></a>top_groups[<span class="st">"total_mcap_bn"</span>] <span class="op">=</span> top_groups[<span class="st">"total_mcap"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb33-662"><a href="#cb33-662" aria-hidden="true" tabindex="-1"></a>top_groups[[<span class="st">"apex"</span>, <span class="st">"n_members"</span>, <span class="st">"n_listed"</span>, <span class="st">"total_mcap_bn"</span>, <span class="st">"industries"</span>]]</span>
<span id="cb33-663"><a href="#cb33-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-664"><a href="#cb33-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-665"><a href="#cb33-665" aria-hidden="true" tabindex="-1"></a><span class="fu">## Board Interlock Networks</span></span>
<span id="cb33-666"><a href="#cb33-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-667"><a href="#cb33-667" aria-hidden="true" tabindex="-1"></a><span class="fu">### Construction</span></span>
<span id="cb33-668"><a href="#cb33-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-669"><a href="#cb33-669" aria-hidden="true" tabindex="-1"></a>A board interlock exists when a director serves on the boards of two or more firms simultaneously. The board interlock network is a unipartite projection of the bipartite director$\times$firm graph: two firms are connected if they share at least one director, weighted by the number of shared directors.</span>
<span id="cb33-670"><a href="#cb33-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-671"><a href="#cb33-671" aria-hidden="true" tabindex="-1"></a>Board interlocks are an information channel. @bizjak2008does show that compensation practices diffuse through board networks. @cai2014board demonstrate that firms connected through interlocks have correlated investment policies. In Vietnamese markets, interlocks often follow ownership lines (e.g., the parent company appoints directors to subsidiary boards), creating a governance channel that reinforces the ownership channel.</span>
<span id="cb33-672"><a href="#cb33-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-675"><a href="#cb33-675" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-676"><a href="#cb33-676" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: board-interlock-data</span></span>
<span id="cb33-677"><a href="#cb33-677" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-678"><a href="#cb33-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-679"><a href="#cb33-679" aria-hidden="true" tabindex="-1"></a><span class="co"># Load board membership data</span></span>
<span id="cb33-680"><a href="#cb33-680" aria-hidden="true" tabindex="-1"></a>board_data <span class="op">=</span> dc.get_board_memberships(</span>
<span id="cb33-681"><a href="#cb33-681" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb33-682"><a href="#cb33-682" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-683"><a href="#cb33-683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-684"><a href="#cb33-684" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Director-firm pairs: </span><span class="sc">{</span><span class="bu">len</span>(board_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-685"><a href="#cb33-685" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique directors: </span><span class="sc">{</span>board_data[<span class="st">'director_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-686"><a href="#cb33-686" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>board_data[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-687"><a href="#cb33-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-688"><a href="#cb33-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Build bipartite graph</span></span>
<span id="cb33-689"><a href="#cb33-689" aria-hidden="true" tabindex="-1"></a>B <span class="op">=</span> nx.Graph()</span>
<span id="cb33-690"><a href="#cb33-690" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> board_data.iterrows():</span>
<span id="cb33-691"><a href="#cb33-691" aria-hidden="true" tabindex="-1"></a>    B.add_node(row[<span class="st">"director_id"</span>], bipartite<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb33-692"><a href="#cb33-692" aria-hidden="true" tabindex="-1"></a>    B.add_node(row[<span class="st">"ticker"</span>], bipartite<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-693"><a href="#cb33-693" aria-hidden="true" tabindex="-1"></a>    B.add_edge(</span>
<span id="cb33-694"><a href="#cb33-694" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"director_id"</span>], row[<span class="st">"ticker"</span>],</span>
<span id="cb33-695"><a href="#cb33-695" aria-hidden="true" tabindex="-1"></a>        role<span class="op">=</span>row.get(<span class="st">"role"</span>, <span class="st">"director"</span>),</span>
<span id="cb33-696"><a href="#cb33-696" aria-hidden="true" tabindex="-1"></a>        is_independent<span class="op">=</span>row.get(<span class="st">"is_independent"</span>, <span class="va">False</span>)</span>
<span id="cb33-697"><a href="#cb33-697" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-698"><a href="#cb33-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-699"><a href="#cb33-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Project to firm-firm interlock network</span></span>
<span id="cb33-700"><a href="#cb33-700" aria-hidden="true" tabindex="-1"></a>firm_nodes <span class="op">=</span> [n <span class="cf">for</span> n, d <span class="kw">in</span> B.nodes(data<span class="op">=</span><span class="va">True</span>) <span class="cf">if</span> d.get(<span class="st">"bipartite"</span>) <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb33-701"><a href="#cb33-701" aria-hidden="true" tabindex="-1"></a>G_interlock <span class="op">=</span> nx.bipartite.weighted_projected_graph(B, firm_nodes)</span>
<span id="cb33-702"><a href="#cb33-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-703"><a href="#cb33-703" aria-hidden="true" tabindex="-1"></a><span class="co"># Edge weight = number of shared directors</span></span>
<span id="cb33-704"><a href="#cb33-704" aria-hidden="true" tabindex="-1"></a>interlock_metrics, interlock_graph <span class="op">=</span> compute_network_metrics(G_interlock)</span>
<span id="cb33-705"><a href="#cb33-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-706"><a href="#cb33-706" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Board Interlock Network:"</span>)</span>
<span id="cb33-707"><a href="#cb33-707" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Firms: </span><span class="sc">{</span>G_interlock<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-708"><a href="#cb33-708" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Interlocking pairs: </span><span class="sc">{</span>G_interlock<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-709"><a href="#cb33-709" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Density: </span><span class="sc">{</span>nx<span class="sc">.</span>density(G_interlock)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb33-710"><a href="#cb33-710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-711"><a href="#cb33-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-714"><a href="#cb33-714" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-715"><a href="#cb33-715" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: interlock-vs-ownership</span></span>
<span id="cb33-716"><a href="#cb33-716" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-717"><a href="#cb33-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-718"><a href="#cb33-718" aria-hidden="true" tabindex="-1"></a><span class="co"># Do board interlocks follow ownership lines?</span></span>
<span id="cb33-719"><a href="#cb33-719" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare interlock edges with ownership edges</span></span>
<span id="cb33-720"><a href="#cb33-720" aria-hidden="true" tabindex="-1"></a>interlock_edges <span class="op">=</span> <span class="bu">set</span>(G_interlock.edges())</span>
<span id="cb33-721"><a href="#cb33-721" aria-hidden="true" tabindex="-1"></a>ownership_edges_undirected <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb33-722"><a href="#cb33-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-723"><a href="#cb33-723" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> u, v <span class="kw">in</span> G_own.edges():</span>
<span id="cb33-724"><a href="#cb33-724" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> u <span class="kw">in</span> firm_nodes <span class="kw">and</span> v <span class="kw">in</span> firm_nodes:</span>
<span id="cb33-725"><a href="#cb33-725" aria-hidden="true" tabindex="-1"></a>        ownership_edges_undirected.add((<span class="bu">min</span>(u, v), <span class="bu">max</span>(u, v)))</span>
<span id="cb33-726"><a href="#cb33-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-727"><a href="#cb33-727" aria-hidden="true" tabindex="-1"></a>interlock_edges_normalized <span class="op">=</span> {</span>
<span id="cb33-728"><a href="#cb33-728" aria-hidden="true" tabindex="-1"></a>    (<span class="bu">min</span>(u, v), <span class="bu">max</span>(u, v)) <span class="cf">for</span> u, v <span class="kw">in</span> interlock_edges</span>
<span id="cb33-729"><a href="#cb33-729" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-730"><a href="#cb33-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-731"><a href="#cb33-731" aria-hidden="true" tabindex="-1"></a>overlap <span class="op">=</span> interlock_edges_normalized <span class="op">&amp;</span> ownership_edges_undirected</span>
<span id="cb33-732"><a href="#cb33-732" aria-hidden="true" tabindex="-1"></a>n_interlock <span class="op">=</span> <span class="bu">len</span>(interlock_edges_normalized)</span>
<span id="cb33-733"><a href="#cb33-733" aria-hidden="true" tabindex="-1"></a>n_ownership <span class="op">=</span> <span class="bu">len</span>(ownership_edges_undirected)</span>
<span id="cb33-734"><a href="#cb33-734" aria-hidden="true" tabindex="-1"></a>n_overlap <span class="op">=</span> <span class="bu">len</span>(overlap)</span>
<span id="cb33-735"><a href="#cb33-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-736"><a href="#cb33-736" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Interlock edges: </span><span class="sc">{</span>n_interlock<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-737"><a href="#cb33-737" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Ownership edges (firm-firm): </span><span class="sc">{</span>n_ownership<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-738"><a href="#cb33-738" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Overlap: </span><span class="sc">{</span>n_overlap<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-739"><a href="#cb33-739" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_interlock <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-740"><a href="#cb33-740" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fraction of interlocks with ownership link: "</span></span>
<span id="cb33-741"><a href="#cb33-741" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>n_overlap <span class="op">/</span> n_interlock<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb33-742"><a href="#cb33-742" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-743"><a href="#cb33-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-744"><a href="#cb33-744" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interlocks and Return Co-Movement</span></span>
<span id="cb33-745"><a href="#cb33-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-746"><a href="#cb33-746" aria-hidden="true" tabindex="-1"></a>If board interlocks serve as information channels, firms connected through interlocks should exhibit excess return co-movement beyond what is explained by shared industry or size characteristics. We test this using the methodology of @cohen2008economic:</span>
<span id="cb33-747"><a href="#cb33-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-748"><a href="#cb33-748" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-749"><a href="#cb33-749" aria-hidden="true" tabindex="-1"></a>\rho_{ij,t} = \alpha + \beta \cdot \text{Interlock}_{ij,t} + \gamma \cdot \text{SameIndustry}_{ij} + \delta \cdot \text{SizeProximity}_{ij,t} + \varepsilon_{ij,t}</span>
<span id="cb33-750"><a href="#cb33-750" aria-hidden="true" tabindex="-1"></a>$$ {#eq-interlock-comovement}</span>
<span id="cb33-751"><a href="#cb33-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-754"><a href="#cb33-754" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-755"><a href="#cb33-755" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: interlock-comovement</span></span>
<span id="cb33-756"><a href="#cb33-756" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-757"><a href="#cb33-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-758"><a href="#cb33-758" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute pairwise return correlations for interlocked and non-interlocked pairs</span></span>
<span id="cb33-759"><a href="#cb33-759" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> dc.get_monthly_returns(</span>
<span id="cb33-760"><a href="#cb33-760" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb33-761"><a href="#cb33-761" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb33-762"><a href="#cb33-762" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-763"><a href="#cb33-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-764"><a href="#cb33-764" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to wide format</span></span>
<span id="cb33-765"><a href="#cb33-765" aria-hidden="true" tabindex="-1"></a>returns_wide <span class="op">=</span> monthly_returns.pivot(</span>
<span id="cb33-766"><a href="#cb33-766" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"ticker"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb33-767"><a href="#cb33-767" aria-hidden="true" tabindex="-1"></a>).dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb33-768"><a href="#cb33-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-769"><a href="#cb33-769" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation matrix</span></span>
<span id="cb33-770"><a href="#cb33-770" aria-hidden="true" tabindex="-1"></a>corr_matrix <span class="op">=</span> returns_wide.corr()</span>
<span id="cb33-771"><a href="#cb33-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-772"><a href="#cb33-772" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare correlations: interlocked vs non-interlocked</span></span>
<span id="cb33-773"><a href="#cb33-773" aria-hidden="true" tabindex="-1"></a>interlock_corrs <span class="op">=</span> []</span>
<span id="cb33-774"><a href="#cb33-774" aria-hidden="true" tabindex="-1"></a>non_interlock_corrs <span class="op">=</span> []</span>
<span id="cb33-775"><a href="#cb33-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-776"><a href="#cb33-776" aria-hidden="true" tabindex="-1"></a>tickers_in_both <span class="op">=</span> <span class="bu">set</span>(corr_matrix.columns) <span class="op">&amp;</span> <span class="bu">set</span>(G_interlock.nodes())</span>
<span id="cb33-777"><a href="#cb33-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-778"><a href="#cb33-778" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, ticker_i <span class="kw">in</span> <span class="bu">enumerate</span>(tickers_in_both):</span>
<span id="cb33-779"><a href="#cb33-779" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker_j <span class="kw">in</span> <span class="bu">list</span>(tickers_in_both)[i <span class="op">+</span> <span class="dv">1</span>:]:</span>
<span id="cb33-780"><a href="#cb33-780" aria-hidden="true" tabindex="-1"></a>        corr <span class="op">=</span> corr_matrix.loc[ticker_i, ticker_j]</span>
<span id="cb33-781"><a href="#cb33-781" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> np.isnan(corr):</span>
<span id="cb33-782"><a href="#cb33-782" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-783"><a href="#cb33-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-784"><a href="#cb33-784" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> G_interlock.has_edge(ticker_i, ticker_j):</span>
<span id="cb33-785"><a href="#cb33-785" aria-hidden="true" tabindex="-1"></a>            interlock_corrs.append(corr)</span>
<span id="cb33-786"><a href="#cb33-786" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-787"><a href="#cb33-787" aria-hidden="true" tabindex="-1"></a>            non_interlock_corrs.append(corr)</span>
<span id="cb33-788"><a href="#cb33-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-789"><a href="#cb33-789" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> interlock_corrs <span class="kw">and</span> non_interlock_corrs:</span>
<span id="cb33-790"><a href="#cb33-790" aria-hidden="true" tabindex="-1"></a>    t_stat, p_val <span class="op">=</span> stats.ttest_ind(interlock_corrs, non_interlock_corrs)</span>
<span id="cb33-791"><a href="#cb33-791" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Interlocked pairs: n=</span><span class="sc">{</span><span class="bu">len</span>(interlock_corrs)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb33-792"><a href="#cb33-792" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"mean corr=</span><span class="sc">{</span>np<span class="sc">.</span>mean(interlock_corrs)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb33-793"><a href="#cb33-793" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Non-interlocked: n=</span><span class="sc">{</span><span class="bu">len</span>(non_interlock_corrs)<span class="sc">}</span><span class="ss">, "</span></span>
<span id="cb33-794"><a href="#cb33-794" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"mean corr=</span><span class="sc">{</span>np<span class="sc">.</span>mean(non_interlock_corrs)<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb33-795"><a href="#cb33-795" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Difference t-stat: </span><span class="sc">{</span>t_stat<span class="sc">:.3f}</span><span class="ss">, p-value: </span><span class="sc">{</span>p_val<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb33-796"><a href="#cb33-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-797"><a href="#cb33-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-798"><a href="#cb33-798" aria-hidden="true" tabindex="-1"></a><span class="fu">## Supply Chain and Trade Networks</span></span>
<span id="cb33-799"><a href="#cb33-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-800"><a href="#cb33-800" aria-hidden="true" tabindex="-1"></a><span class="fu">### Constructing the Supply Chain Graph</span></span>
<span id="cb33-801"><a href="#cb33-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-802"><a href="#cb33-802" aria-hidden="true" tabindex="-1"></a>Supply chain relationships (customer-supplier linkages) represent real economic connections through which shocks propagate. @acemoglu2015systemic demonstrate theoretically that in the presence of supply chain linkages, idiosyncratic shocks to individual firms can generate aggregate fluctuations rather than washing out. @cohen2008economic and @menzly2010market show that supply chain connections predict cross-sectional return differences: when a major customer's stock drops, its suppliers' stocks follow with a delay.</span>
<span id="cb33-803"><a href="#cb33-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-806"><a href="#cb33-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-807"><a href="#cb33-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: supply-chain-data</span></span>
<span id="cb33-808"><a href="#cb33-808" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-809"><a href="#cb33-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-810"><a href="#cb33-810" aria-hidden="true" tabindex="-1"></a><span class="co"># Load supply chain data</span></span>
<span id="cb33-811"><a href="#cb33-811" aria-hidden="true" tabindex="-1"></a>supply_chain <span class="op">=</span> dc.get_supply_chain_data(</span>
<span id="cb33-812"><a href="#cb33-812" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb33-813"><a href="#cb33-813" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb33-814"><a href="#cb33-814" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-815"><a href="#cb33-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-816"><a href="#cb33-816" aria-hidden="true" tabindex="-1"></a><span class="co"># Build directed supply chain graph</span></span>
<span id="cb33-817"><a href="#cb33-817" aria-hidden="true" tabindex="-1"></a>G_supply <span class="op">=</span> nx.DiGraph()</span>
<span id="cb33-818"><a href="#cb33-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-819"><a href="#cb33-819" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> supply_chain.iterrows():</span>
<span id="cb33-820"><a href="#cb33-820" aria-hidden="true" tabindex="-1"></a>    G_supply.add_edge(</span>
<span id="cb33-821"><a href="#cb33-821" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"supplier_ticker"</span>],</span>
<span id="cb33-822"><a href="#cb33-822" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"customer_ticker"</span>],</span>
<span id="cb33-823"><a href="#cb33-823" aria-hidden="true" tabindex="-1"></a>        weight<span class="op">=</span>row.get(<span class="st">"transaction_value"</span>, <span class="dv">1</span>),</span>
<span id="cb33-824"><a href="#cb33-824" aria-hidden="true" tabindex="-1"></a>        pct_of_supplier_revenue<span class="op">=</span>row.get(<span class="st">"pct_supplier_revenue"</span>, <span class="dv">0</span>),</span>
<span id="cb33-825"><a href="#cb33-825" aria-hidden="true" tabindex="-1"></a>        pct_of_customer_cogs<span class="op">=</span>row.get(<span class="st">"pct_customer_cogs"</span>, <span class="dv">0</span>),</span>
<span id="cb33-826"><a href="#cb33-826" aria-hidden="true" tabindex="-1"></a>        year<span class="op">=</span>row.get(<span class="st">"year"</span>, <span class="dv">2024</span>)</span>
<span id="cb33-827"><a href="#cb33-827" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-828"><a href="#cb33-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-829"><a href="#cb33-829" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Supply chain links: </span><span class="sc">{</span>G_supply<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-830"><a href="#cb33-830" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms involved: </span><span class="sc">{</span>G_supply<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-831"><a href="#cb33-831" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-832"><a href="#cb33-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-833"><a href="#cb33-833" aria-hidden="true" tabindex="-1"></a><span class="fu">### Customer Momentum</span></span>
<span id="cb33-834"><a href="#cb33-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-835"><a href="#cb33-835" aria-hidden="true" tabindex="-1"></a>The "customer momentum" strategy of @cohen2008economic exploits the delayed propagation of information through supply chains. When a customer firm's stock rises, its suppliers' stocks tend to follow in subsequent months:</span>
<span id="cb33-836"><a href="#cb33-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-837"><a href="#cb33-837" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-838"><a href="#cb33-838" aria-hidden="true" tabindex="-1"></a>r_{i,t+1} = \alpha + \beta \cdot \text{CustomerReturn}_{i,t} + \gamma \cdot r_{i,t} + \boldsymbol{\delta}' \mathbf{X}_{i,t} + \varepsilon_{i,t}</span>
<span id="cb33-839"><a href="#cb33-839" aria-hidden="true" tabindex="-1"></a>$$ {#eq-customer-momentum}</span>
<span id="cb33-840"><a href="#cb33-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-841"><a href="#cb33-841" aria-hidden="true" tabindex="-1"></a>where $\text{CustomerReturn}_{i,t} = \sum_{j \in \text{Customers}(i)} w_{ij} \cdot r_{j,t}$ is the weighted average return of firm $i$'s customers.</span>
<span id="cb33-842"><a href="#cb33-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-845"><a href="#cb33-845" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-846"><a href="#cb33-846" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: customer-momentum</span></span>
<span id="cb33-847"><a href="#cb33-847" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-848"><a href="#cb33-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-849"><a href="#cb33-849" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute customer-weighted returns for each supplier</span></span>
<span id="cb33-850"><a href="#cb33-850" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_customer_returns(supply_graph, monthly_returns):</span>
<span id="cb33-851"><a href="#cb33-851" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-852"><a href="#cb33-852" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute customer-weighted returns for each supplier firm.</span></span>
<span id="cb33-853"><a href="#cb33-853" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-854"><a href="#cb33-854" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each supplier, compute weighted average customer return</span></span>
<span id="cb33-855"><a href="#cb33-855" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb33-856"><a href="#cb33-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-857"><a href="#cb33-857" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date <span class="kw">in</span> monthly_returns[<span class="st">"date"</span>].unique():</span>
<span id="cb33-858"><a href="#cb33-858" aria-hidden="true" tabindex="-1"></a>        date_returns <span class="op">=</span> monthly_returns[monthly_returns[<span class="st">"date"</span>] <span class="op">==</span> date]</span>
<span id="cb33-859"><a href="#cb33-859" aria-hidden="true" tabindex="-1"></a>        ret_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(date_returns[<span class="st">"ticker"</span>], date_returns[<span class="st">"ret"</span>]))</span>
<span id="cb33-860"><a href="#cb33-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-861"><a href="#cb33-861" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> supplier <span class="kw">in</span> supply_graph.nodes():</span>
<span id="cb33-862"><a href="#cb33-862" aria-hidden="true" tabindex="-1"></a>            customers <span class="op">=</span> <span class="bu">list</span>(supply_graph.successors(supplier))</span>
<span id="cb33-863"><a href="#cb33-863" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> customers:</span>
<span id="cb33-864"><a href="#cb33-864" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb33-865"><a href="#cb33-865" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-866"><a href="#cb33-866" aria-hidden="true" tabindex="-1"></a>            customer_rets <span class="op">=</span> []</span>
<span id="cb33-867"><a href="#cb33-867" aria-hidden="true" tabindex="-1"></a>            customer_weights <span class="op">=</span> []</span>
<span id="cb33-868"><a href="#cb33-868" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> cust <span class="kw">in</span> customers:</span>
<span id="cb33-869"><a href="#cb33-869" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> cust <span class="kw">in</span> ret_dict:</span>
<span id="cb33-870"><a href="#cb33-870" aria-hidden="true" tabindex="-1"></a>                    edge_data <span class="op">=</span> supply_graph[supplier][cust]</span>
<span id="cb33-871"><a href="#cb33-871" aria-hidden="true" tabindex="-1"></a>                    weight <span class="op">=</span> edge_data.get(<span class="st">"pct_of_supplier_revenue"</span>, <span class="dv">1</span>)</span>
<span id="cb33-872"><a href="#cb33-872" aria-hidden="true" tabindex="-1"></a>                    customer_rets.append(ret_dict[cust])</span>
<span id="cb33-873"><a href="#cb33-873" aria-hidden="true" tabindex="-1"></a>                    customer_weights.append(weight)</span>
<span id="cb33-874"><a href="#cb33-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-875"><a href="#cb33-875" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> customer_rets:</span>
<span id="cb33-876"><a href="#cb33-876" aria-hidden="true" tabindex="-1"></a>                weights <span class="op">=</span> np.array(customer_weights)</span>
<span id="cb33-877"><a href="#cb33-877" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> weights.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb33-878"><a href="#cb33-878" aria-hidden="true" tabindex="-1"></a>                    weights <span class="op">=</span> weights <span class="op">/</span> weights.<span class="bu">sum</span>()</span>
<span id="cb33-879"><a href="#cb33-879" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb33-880"><a href="#cb33-880" aria-hidden="true" tabindex="-1"></a>                    weights <span class="op">=</span> np.ones(<span class="bu">len</span>(weights)) <span class="op">/</span> <span class="bu">len</span>(weights)</span>
<span id="cb33-881"><a href="#cb33-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-882"><a href="#cb33-882" aria-hidden="true" tabindex="-1"></a>                weighted_ret <span class="op">=</span> np.average(customer_rets, weights<span class="op">=</span>weights)</span>
<span id="cb33-883"><a href="#cb33-883" aria-hidden="true" tabindex="-1"></a>                results.append({</span>
<span id="cb33-884"><a href="#cb33-884" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"date"</span>: date,</span>
<span id="cb33-885"><a href="#cb33-885" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"ticker"</span>: supplier,</span>
<span id="cb33-886"><a href="#cb33-886" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"customer_ret"</span>: weighted_ret,</span>
<span id="cb33-887"><a href="#cb33-887" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_customers"</span>: <span class="bu">len</span>(customer_rets)</span>
<span id="cb33-888"><a href="#cb33-888" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb33-889"><a href="#cb33-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-890"><a href="#cb33-890" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb33-891"><a href="#cb33-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-892"><a href="#cb33-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-893"><a href="#cb33-893" aria-hidden="true" tabindex="-1"></a>customer_rets <span class="op">=</span> compute_customer_returns(G_supply, monthly_returns)</span>
<span id="cb33-894"><a href="#cb33-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-895"><a href="#cb33-895" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with own returns and lag</span></span>
<span id="cb33-896"><a href="#cb33-896" aria-hidden="true" tabindex="-1"></a>momentum_data <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb33-897"><a href="#cb33-897" aria-hidden="true" tabindex="-1"></a>    customer_rets, on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>], how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb33-898"><a href="#cb33-898" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-899"><a href="#cb33-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-900"><a href="#cb33-900" aria-hidden="true" tabindex="-1"></a>momentum_data <span class="op">=</span> momentum_data.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb33-901"><a href="#cb33-901" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"own_ret_lag"</span>] <span class="op">=</span> momentum_data.groupby(<span class="st">"ticker"</span>)[<span class="st">"ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb33-902"><a href="#cb33-902" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"customer_ret_lag"</span>] <span class="op">=</span> momentum_data.groupby(</span>
<span id="cb33-903"><a href="#cb33-903" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticker"</span></span>
<span id="cb33-904"><a href="#cb33-904" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"customer_ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb33-905"><a href="#cb33-905" aria-hidden="true" tabindex="-1"></a>momentum_data[<span class="st">"ret_lead"</span>] <span class="op">=</span> momentum_data.groupby(<span class="st">"ticker"</span>)[<span class="st">"ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb33-906"><a href="#cb33-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-907"><a href="#cb33-907" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression</span></span>
<span id="cb33-908"><a href="#cb33-908" aria-hidden="true" tabindex="-1"></a>mom_clean <span class="op">=</span> momentum_data.dropna(</span>
<span id="cb33-909"><a href="#cb33-909" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"ret_lead"</span>, <span class="st">"customer_ret_lag"</span>, <span class="st">"own_ret_lag"</span>]</span>
<span id="cb33-910"><a href="#cb33-910" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-911"><a href="#cb33-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-912"><a href="#cb33-912" aria-hidden="true" tabindex="-1"></a>model_mom <span class="op">=</span> sm.OLS(</span>
<span id="cb33-913"><a href="#cb33-913" aria-hidden="true" tabindex="-1"></a>    mom_clean[<span class="st">"ret_lead"</span>],</span>
<span id="cb33-914"><a href="#cb33-914" aria-hidden="true" tabindex="-1"></a>    sm.add_constant(mom_clean[[<span class="st">"customer_ret_lag"</span>, <span class="st">"own_ret_lag"</span>]])</span>
<span id="cb33-915"><a href="#cb33-915" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"cluster"</span>, cov_kwds<span class="op">=</span>{<span class="st">"groups"</span>: mom_clean[<span class="st">"ticker"</span>]})</span>
<span id="cb33-916"><a href="#cb33-916" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-917"><a href="#cb33-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-920"><a href="#cb33-920" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-921"><a href="#cb33-921" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-customer-momentum</span></span>
<span id="cb33-922"><a href="#cb33-922" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-923"><a href="#cb33-923" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Customer Momentum: Supplier Returns Predicted by Customer Returns"</span></span>
<span id="cb33-924"><a href="#cb33-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-925"><a href="#cb33-925" aria-hidden="true" tabindex="-1"></a>mom_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb33-926"><a href="#cb33-926" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: model_mom.params.<span class="bu">round</span>(<span class="dv">4</span>),</span>
<span id="cb33-927"><a href="#cb33-927" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: model_mom.bse.<span class="bu">round</span>(<span class="dv">4</span>),</span>
<span id="cb33-928"><a href="#cb33-928" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: model_mom.tvalues.<span class="bu">round</span>(<span class="dv">3</span>),</span>
<span id="cb33-929"><a href="#cb33-929" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: model_mom.pvalues.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb33-930"><a href="#cb33-930" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb33-931"><a href="#cb33-931" aria-hidden="true" tabindex="-1"></a>mom_results</span>
<span id="cb33-932"><a href="#cb33-932" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-933"><a href="#cb33-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-934"><a href="#cb33-934" aria-hidden="true" tabindex="-1"></a><span class="fu">### Network Propagation: Shock Diffusion Through Supply Chains</span></span>
<span id="cb33-935"><a href="#cb33-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-936"><a href="#cb33-936" aria-hidden="true" tabindex="-1"></a>The @acemoglu2015systemic model predicts that the aggregate effect of an idiosyncratic shock depends on the network's topology. In a star network (one central hub), hub shocks generate aggregate fluctuations. In a symmetric network, shocks cancel out. We implement a simulation-based approach to measure shock propagation in the Vietnamese supply chain.</span>
<span id="cb33-937"><a href="#cb33-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-940"><a href="#cb33-940" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-941"><a href="#cb33-941" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: shock-propagation</span></span>
<span id="cb33-942"><a href="#cb33-942" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-943"><a href="#cb33-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-944"><a href="#cb33-944" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_shock_propagation(G, shocked_node, shock_size<span class="op">=-</span><span class="fl">0.10</span>,</span>
<span id="cb33-945"><a href="#cb33-945" aria-hidden="true" tabindex="-1"></a>                                decay<span class="op">=</span><span class="fl">0.5</span>, max_steps<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb33-946"><a href="#cb33-946" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-947"><a href="#cb33-947" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate the propagation of an idiosyncratic shock through</span></span>
<span id="cb33-948"><a href="#cb33-948" aria-hidden="true" tabindex="-1"></a><span class="co">    a supply chain network.</span></span>
<span id="cb33-949"><a href="#cb33-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-950"><a href="#cb33-950" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-951"><a href="#cb33-951" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-952"><a href="#cb33-952" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb33-953"><a href="#cb33-953" aria-hidden="true" tabindex="-1"></a><span class="co">        Supply chain graph (supplier ‚Üí customer).</span></span>
<span id="cb33-954"><a href="#cb33-954" aria-hidden="true" tabindex="-1"></a><span class="co">    shocked_node : str</span></span>
<span id="cb33-955"><a href="#cb33-955" aria-hidden="true" tabindex="-1"></a><span class="co">        Node receiving the initial shock.</span></span>
<span id="cb33-956"><a href="#cb33-956" aria-hidden="true" tabindex="-1"></a><span class="co">    shock_size : float</span></span>
<span id="cb33-957"><a href="#cb33-957" aria-hidden="true" tabindex="-1"></a><span class="co">        Initial shock magnitude (e.g., -0.10 = -10% revenue shock).</span></span>
<span id="cb33-958"><a href="#cb33-958" aria-hidden="true" tabindex="-1"></a><span class="co">    decay : float</span></span>
<span id="cb33-959"><a href="#cb33-959" aria-hidden="true" tabindex="-1"></a><span class="co">        Fraction of shock transmitted per link (0 &lt; decay &lt; 1).</span></span>
<span id="cb33-960"><a href="#cb33-960" aria-hidden="true" tabindex="-1"></a><span class="co">    max_steps : int</span></span>
<span id="cb33-961"><a href="#cb33-961" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum propagation steps.</span></span>
<span id="cb33-962"><a href="#cb33-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-963"><a href="#cb33-963" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-964"><a href="#cb33-964" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-965"><a href="#cb33-965" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : {node: cumulative shock received}.</span></span>
<span id="cb33-966"><a href="#cb33-966" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-967"><a href="#cb33-967" aria-hidden="true" tabindex="-1"></a>    shocks <span class="op">=</span> {shocked_node: shock_size}</span>
<span id="cb33-968"><a href="#cb33-968" aria-hidden="true" tabindex="-1"></a>    frontier <span class="op">=</span> {shocked_node}</span>
<span id="cb33-969"><a href="#cb33-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-970"><a href="#cb33-970" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(max_steps):</span>
<span id="cb33-971"><a href="#cb33-971" aria-hidden="true" tabindex="-1"></a>        new_frontier <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb33-972"><a href="#cb33-972" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> node <span class="kw">in</span> frontier:</span>
<span id="cb33-973"><a href="#cb33-973" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagate to customers (downstream)</span></span>
<span id="cb33-974"><a href="#cb33-974" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> customer <span class="kw">in</span> G.successors(node):</span>
<span id="cb33-975"><a href="#cb33-975" aria-hidden="true" tabindex="-1"></a>                edge_weight <span class="op">=</span> G[node][customer].get(</span>
<span id="cb33-976"><a href="#cb33-976" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pct_of_customer_cogs"</span>, <span class="fl">0.1</span></span>
<span id="cb33-977"><a href="#cb33-977" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb33-978"><a href="#cb33-978" aria-hidden="true" tabindex="-1"></a>                transmitted <span class="op">=</span> shocks[node] <span class="op">*</span> decay <span class="op">*</span> edge_weight</span>
<span id="cb33-979"><a href="#cb33-979" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(transmitted) <span class="op">&gt;</span> <span class="fl">0.001</span>:</span>
<span id="cb33-980"><a href="#cb33-980" aria-hidden="true" tabindex="-1"></a>                    shocks[customer] <span class="op">=</span> shocks.get(customer, <span class="dv">0</span>) <span class="op">+</span> transmitted</span>
<span id="cb33-981"><a href="#cb33-981" aria-hidden="true" tabindex="-1"></a>                    new_frontier.add(customer)</span>
<span id="cb33-982"><a href="#cb33-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-983"><a href="#cb33-983" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Propagate to suppliers (upstream)</span></span>
<span id="cb33-984"><a href="#cb33-984" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> supplier <span class="kw">in</span> G.predecessors(node):</span>
<span id="cb33-985"><a href="#cb33-985" aria-hidden="true" tabindex="-1"></a>                edge_weight <span class="op">=</span> G[supplier][node].get(</span>
<span id="cb33-986"><a href="#cb33-986" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"pct_of_supplier_revenue"</span>, <span class="fl">0.1</span></span>
<span id="cb33-987"><a href="#cb33-987" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb33-988"><a href="#cb33-988" aria-hidden="true" tabindex="-1"></a>                transmitted <span class="op">=</span> shocks[node] <span class="op">*</span> decay <span class="op">*</span> edge_weight</span>
<span id="cb33-989"><a href="#cb33-989" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">abs</span>(transmitted) <span class="op">&gt;</span> <span class="fl">0.001</span>:</span>
<span id="cb33-990"><a href="#cb33-990" aria-hidden="true" tabindex="-1"></a>                    shocks[supplier] <span class="op">=</span> shocks.get(supplier, <span class="dv">0</span>) <span class="op">+</span> transmitted</span>
<span id="cb33-991"><a href="#cb33-991" aria-hidden="true" tabindex="-1"></a>                    new_frontier.add(supplier)</span>
<span id="cb33-992"><a href="#cb33-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-993"><a href="#cb33-993" aria-hidden="true" tabindex="-1"></a>        frontier <span class="op">=</span> new_frontier</span>
<span id="cb33-994"><a href="#cb33-994" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> frontier:</span>
<span id="cb33-995"><a href="#cb33-995" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb33-996"><a href="#cb33-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-997"><a href="#cb33-997" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shocks</span>
<span id="cb33-998"><a href="#cb33-998" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-999"><a href="#cb33-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1000"><a href="#cb33-1000" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify systemically important supply chain nodes</span></span>
<span id="cb33-1001"><a href="#cb33-1001" aria-hidden="true" tabindex="-1"></a><span class="co"># (Those whose shock has largest aggregate impact)</span></span>
<span id="cb33-1002"><a href="#cb33-1002" aria-hidden="true" tabindex="-1"></a>systemic_importance <span class="op">=</span> {}</span>
<span id="cb33-1003"><a href="#cb33-1003" aria-hidden="true" tabindex="-1"></a>listed_in_supply <span class="op">=</span> [n <span class="cf">for</span> n <span class="kw">in</span> G_supply.nodes()</span>
<span id="cb33-1004"><a href="#cb33-1004" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> n <span class="kw">in</span> <span class="bu">set</span>(firms[<span class="st">"ticker"</span>])]</span>
<span id="cb33-1005"><a href="#cb33-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1006"><a href="#cb33-1006" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> firm <span class="kw">in</span> listed_in_supply[:<span class="dv">100</span>]:  <span class="co"># Sample for computational feasibility</span></span>
<span id="cb33-1007"><a href="#cb33-1007" aria-hidden="true" tabindex="-1"></a>    shocks <span class="op">=</span> simulate_shock_propagation(G_supply, firm, <span class="op">-</span><span class="fl">0.10</span>)</span>
<span id="cb33-1008"><a href="#cb33-1008" aria-hidden="true" tabindex="-1"></a>    aggregate_impact <span class="op">=</span> <span class="bu">sum</span>(<span class="bu">abs</span>(v) <span class="cf">for</span> k, v <span class="kw">in</span> shocks.items() <span class="cf">if</span> k <span class="op">!=</span> firm)</span>
<span id="cb33-1009"><a href="#cb33-1009" aria-hidden="true" tabindex="-1"></a>    systemic_importance[firm] <span class="op">=</span> aggregate_impact</span>
<span id="cb33-1010"><a href="#cb33-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1011"><a href="#cb33-1011" aria-hidden="true" tabindex="-1"></a>systemic_df <span class="op">=</span> pd.DataFrame(</span>
<span id="cb33-1012"><a href="#cb33-1012" aria-hidden="true" tabindex="-1"></a>    <span class="bu">list</span>(systemic_importance.items()),</span>
<span id="cb33-1013"><a href="#cb33-1013" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"systemic_impact"</span>]</span>
<span id="cb33-1014"><a href="#cb33-1014" aria-hidden="true" tabindex="-1"></a>).sort_values(<span class="st">"systemic_impact"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-1015"><a href="#cb33-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1016"><a href="#cb33-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1019"><a href="#cb33-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1020"><a href="#cb33-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-systemic-supply-chain</span></span>
<span id="cb33-1021"><a href="#cb33-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1022"><a href="#cb33-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Most Systemically Important Firms in the Supply Chain Network"</span></span>
<span id="cb33-1023"><a href="#cb33-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1024"><a href="#cb33-1024" aria-hidden="true" tabindex="-1"></a>top_systemic <span class="op">=</span> systemic_df.head(<span class="dv">20</span>).merge(</span>
<span id="cb33-1025"><a href="#cb33-1025" aria-hidden="true" tabindex="-1"></a>    firms[[<span class="st">"ticker"</span>, <span class="st">"industry"</span>, <span class="st">"market_cap"</span>]],</span>
<span id="cb33-1026"><a href="#cb33-1026" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb33-1027"><a href="#cb33-1027" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-1028"><a href="#cb33-1028" aria-hidden="true" tabindex="-1"></a>top_systemic[<span class="st">"market_cap_bn"</span>] <span class="op">=</span> top_systemic[<span class="st">"market_cap"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb33-1029"><a href="#cb33-1029" aria-hidden="true" tabindex="-1"></a>top_systemic[[<span class="st">"ticker"</span>, <span class="st">"industry"</span>, <span class="st">"market_cap_bn"</span>, <span class="st">"systemic_impact"</span>]].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb33-1030"><a href="#cb33-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1031"><a href="#cb33-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1032"><a href="#cb33-1032" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correlation and Co-Movement Networks</span></span>
<span id="cb33-1033"><a href="#cb33-1033" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1034"><a href="#cb33-1034" aria-hidden="true" tabindex="-1"></a><span class="fu">### Construction from Return Data</span></span>
<span id="cb33-1035"><a href="#cb33-1035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1036"><a href="#cb33-1036" aria-hidden="true" tabindex="-1"></a>A correlation network connects assets whose returns co-move. This is perhaps the most widely used financial network because it requires only return data---no proprietary ownership or supply chain information. The standard construction involves three steps:</span>
<span id="cb33-1037"><a href="#cb33-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1038"><a href="#cb33-1038" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Compute pairwise correlations.** For $n$ assets over $T$ periods, the sample correlation matrix $\hat{\rho} \in \mathbb{R}^{n \times n}$ has $n(n-1)/2$ unique entries.</span>
<span id="cb33-1039"><a href="#cb33-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1040"><a href="#cb33-1040" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Threshold or transform.** Convert the dense correlation matrix into a sparse graph. Common approaches: hard threshold ($\rho_{ij} &gt; \bar{\rho}$), Minimum Spanning Tree (MST), or Planar Maximally Filtered Graph (PMFG).</span>
<span id="cb33-1041"><a href="#cb33-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1042"><a href="#cb33-1042" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Analyze the graph.** Community detection reveals sector clustering; centrality identifies market bellwethers; temporal evolution tracks regime changes.</span>
<span id="cb33-1043"><a href="#cb33-1043" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1046"><a href="#cb33-1046" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1047"><a href="#cb33-1047" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: correlation-network</span></span>
<span id="cb33-1048"><a href="#cb33-1048" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1049"><a href="#cb33-1049" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1050"><a href="#cb33-1050" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute correlation matrix from daily returns</span></span>
<span id="cb33-1051"><a href="#cb33-1051" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb33-1052"><a href="#cb33-1052" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb33-1053"><a href="#cb33-1053" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb33-1054"><a href="#cb33-1054" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-1055"><a href="#cb33-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1056"><a href="#cb33-1056" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_returns.pivot(</span>
<span id="cb33-1057"><a href="#cb33-1057" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"ticker"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb33-1058"><a href="#cb33-1058" aria-hidden="true" tabindex="-1"></a>).dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb33-1059"><a href="#cb33-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1060"><a href="#cb33-1060" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> daily_wide.corr()</span>
<span id="cb33-1061"><a href="#cb33-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1062"><a href="#cb33-1062" aria-hidden="true" tabindex="-1"></a><span class="co"># Minimum Spanning Tree (MST)</span></span>
<span id="cb33-1063"><a href="#cb33-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert correlation to distance: d = sqrt(2(1-œÅ))</span></span>
<span id="cb33-1064"><a href="#cb33-1064" aria-hidden="true" tabindex="-1"></a>dist <span class="op">=</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> corr.values))</span>
<span id="cb33-1065"><a href="#cb33-1065" aria-hidden="true" tabindex="-1"></a>np.fill_diagonal(dist, <span class="dv">0</span>)</span>
<span id="cb33-1066"><a href="#cb33-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1067"><a href="#cb33-1067" aria-hidden="true" tabindex="-1"></a><span class="co"># Build complete graph with distances</span></span>
<span id="cb33-1068"><a href="#cb33-1068" aria-hidden="true" tabindex="-1"></a>G_complete <span class="op">=</span> nx.Graph()</span>
<span id="cb33-1069"><a href="#cb33-1069" aria-hidden="true" tabindex="-1"></a>tickers <span class="op">=</span> <span class="bu">list</span>(corr.columns)</span>
<span id="cb33-1070"><a href="#cb33-1070" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tickers)):</span>
<span id="cb33-1071"><a href="#cb33-1071" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(tickers)):</span>
<span id="cb33-1072"><a href="#cb33-1072" aria-hidden="true" tabindex="-1"></a>        G_complete.add_edge(</span>
<span id="cb33-1073"><a href="#cb33-1073" aria-hidden="true" tabindex="-1"></a>            tickers[i], tickers[j],</span>
<span id="cb33-1074"><a href="#cb33-1074" aria-hidden="true" tabindex="-1"></a>            weight<span class="op">=</span>dist[i, j],</span>
<span id="cb33-1075"><a href="#cb33-1075" aria-hidden="true" tabindex="-1"></a>            correlation<span class="op">=</span>corr.iloc[i, j]</span>
<span id="cb33-1076"><a href="#cb33-1076" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1077"><a href="#cb33-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1078"><a href="#cb33-1078" aria-hidden="true" tabindex="-1"></a><span class="co"># MST</span></span>
<span id="cb33-1079"><a href="#cb33-1079" aria-hidden="true" tabindex="-1"></a>G_mst <span class="op">=</span> nx.minimum_spanning_tree(G_complete, weight<span class="op">=</span><span class="st">"weight"</span>)</span>
<span id="cb33-1080"><a href="#cb33-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1081"><a href="#cb33-1081" aria-hidden="true" tabindex="-1"></a><span class="co"># Thresholded correlation network</span></span>
<span id="cb33-1082"><a href="#cb33-1082" aria-hidden="true" tabindex="-1"></a>threshold <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb33-1083"><a href="#cb33-1083" aria-hidden="true" tabindex="-1"></a>G_corr <span class="op">=</span> nx.Graph()</span>
<span id="cb33-1084"><a href="#cb33-1084" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(tickers)):</span>
<span id="cb33-1085"><a href="#cb33-1085" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(tickers)):</span>
<span id="cb33-1086"><a href="#cb33-1086" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> corr.iloc[i, j] <span class="op">&gt;</span> threshold:</span>
<span id="cb33-1087"><a href="#cb33-1087" aria-hidden="true" tabindex="-1"></a>            G_corr.add_edge(</span>
<span id="cb33-1088"><a href="#cb33-1088" aria-hidden="true" tabindex="-1"></a>                tickers[i], tickers[j],</span>
<span id="cb33-1089"><a href="#cb33-1089" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span>corr.iloc[i, j]</span>
<span id="cb33-1090"><a href="#cb33-1090" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-1091"><a href="#cb33-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1092"><a href="#cb33-1092" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MST: </span><span class="sc">{</span>G_mst<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss"> nodes, "</span></span>
<span id="cb33-1093"><a href="#cb33-1093" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_mst<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss"> edges"</span>)</span>
<span id="cb33-1094"><a href="#cb33-1094" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Corr network (œÅ &gt; </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">): "</span></span>
<span id="cb33-1095"><a href="#cb33-1095" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_corr<span class="sc">.</span>number_of_nodes()<span class="sc">}</span><span class="ss"> nodes, "</span></span>
<span id="cb33-1096"><a href="#cb33-1096" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>G_corr<span class="sc">.</span>number_of_edges()<span class="sc">}</span><span class="ss"> edges"</span>)</span>
<span id="cb33-1097"><a href="#cb33-1097" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1098"><a href="#cb33-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1099"><a href="#cb33-1099" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Diebold-Yilmaz Connectedness Framework</span></span>
<span id="cb33-1100"><a href="#cb33-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1101"><a href="#cb33-1101" aria-hidden="true" tabindex="-1"></a>@diebold2014network propose measuring financial connectedness using the variance decomposition from a vector autoregression (VAR). The fraction of the $H$-step-ahead forecast error variance of variable $i$ attributable to shocks from variable $j$ defines the pairwise directional connectedness:</span>
<span id="cb33-1102"><a href="#cb33-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1103"><a href="#cb33-1103" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1104"><a href="#cb33-1104" aria-hidden="true" tabindex="-1"></a>C_{i \leftarrow j}(H) = \frac{\tilde{\theta}_{ij}^g(H)}{\sum_{j=1}^{n} \tilde{\theta}_{ij}^g(H)} \times 100</span>
<span id="cb33-1105"><a href="#cb33-1105" aria-hidden="true" tabindex="-1"></a>$$ {#eq-dy-connectedness}</span>
<span id="cb33-1106"><a href="#cb33-1106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1107"><a href="#cb33-1107" aria-hidden="true" tabindex="-1"></a>where $\tilde{\theta}_{ij}^g(H)$ is the generalized forecast error variance decomposition. The total connectedness index (TCI) aggregates across all pairs:</span>
<span id="cb33-1108"><a href="#cb33-1108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1109"><a href="#cb33-1109" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1110"><a href="#cb33-1110" aria-hidden="true" tabindex="-1"></a>\text{TCI}(H) = \frac{\sum_{i \neq j} C_{i \leftarrow j}(H)}{\sum_{i,j} C_{i \leftarrow j}(H)} \times 100</span>
<span id="cb33-1111"><a href="#cb33-1111" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tci}</span>
<span id="cb33-1112"><a href="#cb33-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1113"><a href="#cb33-1113" aria-hidden="true" tabindex="-1"></a>High TCI indicates a tightly connected system where shocks propagate widely; low TCI indicates relative isolation.</span>
<span id="cb33-1114"><a href="#cb33-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1117"><a href="#cb33-1117" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1118"><a href="#cb33-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: diebold-yilmaz</span></span>
<span id="cb33-1119"><a href="#cb33-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1120"><a href="#cb33-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1121"><a href="#cb33-1121" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> diebold_yilmaz_connectedness(returns_df, var_order<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb33-1122"><a href="#cb33-1122" aria-hidden="true" tabindex="-1"></a>                                  forecast_horizon<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb33-1123"><a href="#cb33-1123" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1124"><a href="#cb33-1124" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the Diebold-Yilmaz (2014) connectedness table.</span></span>
<span id="cb33-1125"><a href="#cb33-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1126"><a href="#cb33-1126" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-1127"><a href="#cb33-1127" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-1128"><a href="#cb33-1128" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb33-1129"><a href="#cb33-1129" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns with columns as assets, index as dates.</span></span>
<span id="cb33-1130"><a href="#cb33-1130" aria-hidden="true" tabindex="-1"></a><span class="co">    var_order : int</span></span>
<span id="cb33-1131"><a href="#cb33-1131" aria-hidden="true" tabindex="-1"></a><span class="co">        VAR lag order.</span></span>
<span id="cb33-1132"><a href="#cb33-1132" aria-hidden="true" tabindex="-1"></a><span class="co">    forecast_horizon : int</span></span>
<span id="cb33-1133"><a href="#cb33-1133" aria-hidden="true" tabindex="-1"></a><span class="co">        Forecast horizon for variance decomposition.</span></span>
<span id="cb33-1134"><a href="#cb33-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1135"><a href="#cb33-1135" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-1136"><a href="#cb33-1136" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-1137"><a href="#cb33-1137" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Connectedness matrix, TCI, TO/FROM measures.</span></span>
<span id="cb33-1138"><a href="#cb33-1138" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1139"><a href="#cb33-1139" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> statsmodels.tsa.api <span class="im">import</span> VAR</span>
<span id="cb33-1140"><a href="#cb33-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1141"><a href="#cb33-1141" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit VAR</span></span>
<span id="cb33-1142"><a href="#cb33-1142" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> VAR(returns_df.dropna())</span>
<span id="cb33-1143"><a href="#cb33-1143" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> model.fit(var_order)</span>
<span id="cb33-1144"><a href="#cb33-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1145"><a href="#cb33-1145" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Generalized Forecast Error Variance Decomposition</span></span>
<span id="cb33-1146"><a href="#cb33-1146" aria-hidden="true" tabindex="-1"></a>    fevd <span class="op">=</span> results.fevd(forecast_horizon)</span>
<span id="cb33-1147"><a href="#cb33-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1148"><a href="#cb33-1148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract decomposition matrix at horizon H</span></span>
<span id="cb33-1149"><a href="#cb33-1149" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> returns_df.shape[<span class="dv">1</span>]</span>
<span id="cb33-1150"><a href="#cb33-1150" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> np.zeros((n, n))</span>
<span id="cb33-1151"><a href="#cb33-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1152"><a href="#cb33-1152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(n):</span>
<span id="cb33-1153"><a href="#cb33-1153" aria-hidden="true" tabindex="-1"></a>        decomp <span class="op">=</span> fevd.decomp[i]  <span class="co"># H x n array</span></span>
<span id="cb33-1154"><a href="#cb33-1154" aria-hidden="true" tabindex="-1"></a>        C[i, :] <span class="op">=</span> decomp[<span class="op">-</span><span class="dv">1</span>, :]  <span class="co"># Take horizon H values</span></span>
<span id="cb33-1155"><a href="#cb33-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1156"><a href="#cb33-1156" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize rows to sum to 100</span></span>
<span id="cb33-1157"><a href="#cb33-1157" aria-hidden="true" tabindex="-1"></a>    row_sums <span class="op">=</span> C.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>, keepdims<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-1158"><a href="#cb33-1158" aria-hidden="true" tabindex="-1"></a>    C_norm <span class="op">=</span> C <span class="op">/</span> row_sums <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb33-1159"><a href="#cb33-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1160"><a href="#cb33-1160" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connectedness measures</span></span>
<span id="cb33-1161"><a href="#cb33-1161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FROM: how much of i's variance comes from others</span></span>
<span id="cb33-1162"><a href="#cb33-1162" aria-hidden="true" tabindex="-1"></a>    FROM <span class="op">=</span> C_norm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">-</span> np.diag(C_norm)</span>
<span id="cb33-1163"><a href="#cb33-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1164"><a href="#cb33-1164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># TO: how much of others' variance comes from i</span></span>
<span id="cb33-1165"><a href="#cb33-1165" aria-hidden="true" tabindex="-1"></a>    TO <span class="op">=</span> C_norm.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">-</span> np.diag(C_norm)</span>
<span id="cb33-1166"><a href="#cb33-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1167"><a href="#cb33-1167" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NET = TO - FROM</span></span>
<span id="cb33-1168"><a href="#cb33-1168" aria-hidden="true" tabindex="-1"></a>    NET <span class="op">=</span> TO <span class="op">-</span> FROM</span>
<span id="cb33-1169"><a href="#cb33-1169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1170"><a href="#cb33-1170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total Connectedness Index</span></span>
<span id="cb33-1171"><a href="#cb33-1171" aria-hidden="true" tabindex="-1"></a>    TCI <span class="op">=</span> FROM.<span class="bu">sum</span>() <span class="op">/</span> n</span>
<span id="cb33-1172"><a href="#cb33-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1173"><a href="#cb33-1173" aria-hidden="true" tabindex="-1"></a>    names <span class="op">=</span> returns_df.columns.tolist()</span>
<span id="cb33-1174"><a href="#cb33-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1175"><a href="#cb33-1175" aria-hidden="true" tabindex="-1"></a>    connectedness_df <span class="op">=</span> pd.DataFrame(C_norm, index<span class="op">=</span>names, columns<span class="op">=</span>names)</span>
<span id="cb33-1176"><a href="#cb33-1176" aria-hidden="true" tabindex="-1"></a>    connectedness_df[<span class="st">"FROM_others"</span>] <span class="op">=</span> FROM</span>
<span id="cb33-1177"><a href="#cb33-1177" aria-hidden="true" tabindex="-1"></a>    connectedness_df.loc[<span class="st">"TO_others"</span>] <span class="op">=</span> <span class="bu">list</span>(TO) <span class="op">+</span> [TCI]</span>
<span id="cb33-1178"><a href="#cb33-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1179"><a href="#cb33-1179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb33-1180"><a href="#cb33-1180" aria-hidden="true" tabindex="-1"></a>        <span class="st">"connectedness_matrix"</span>: connectedness_df,</span>
<span id="cb33-1181"><a href="#cb33-1181" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TCI"</span>: TCI,</span>
<span id="cb33-1182"><a href="#cb33-1182" aria-hidden="true" tabindex="-1"></a>        <span class="st">"FROM"</span>: pd.Series(FROM, index<span class="op">=</span>names),</span>
<span id="cb33-1183"><a href="#cb33-1183" aria-hidden="true" tabindex="-1"></a>        <span class="st">"TO"</span>: pd.Series(TO, index<span class="op">=</span>names),</span>
<span id="cb33-1184"><a href="#cb33-1184" aria-hidden="true" tabindex="-1"></a>        <span class="st">"NET"</span>: pd.Series(NET, index<span class="op">=</span>names)</span>
<span id="cb33-1185"><a href="#cb33-1185" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-1186"><a href="#cb33-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1187"><a href="#cb33-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1188"><a href="#cb33-1188" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply to top Vietnamese stocks by liquidity</span></span>
<span id="cb33-1189"><a href="#cb33-1189" aria-hidden="true" tabindex="-1"></a>top_stocks <span class="op">=</span> (</span>
<span id="cb33-1190"><a href="#cb33-1190" aria-hidden="true" tabindex="-1"></a>    daily_returns.groupby(<span class="st">"ticker"</span>)[<span class="st">"volume"</span>]</span>
<span id="cb33-1191"><a href="#cb33-1191" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb33-1192"><a href="#cb33-1192" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">20</span>)</span>
<span id="cb33-1193"><a href="#cb33-1193" aria-hidden="true" tabindex="-1"></a>    .index</span>
<span id="cb33-1194"><a href="#cb33-1194" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-1195"><a href="#cb33-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1196"><a href="#cb33-1196" aria-hidden="true" tabindex="-1"></a>top_returns <span class="op">=</span> daily_wide[</span>
<span id="cb33-1197"><a href="#cb33-1197" aria-hidden="true" tabindex="-1"></a>    [c <span class="cf">for</span> c <span class="kw">in</span> top_stocks <span class="cf">if</span> c <span class="kw">in</span> daily_wide.columns]</span>
<span id="cb33-1198"><a href="#cb33-1198" aria-hidden="true" tabindex="-1"></a>].dropna()</span>
<span id="cb33-1199"><a href="#cb33-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1200"><a href="#cb33-1200" aria-hidden="true" tabindex="-1"></a>dy_results <span class="op">=</span> diebold_yilmaz_connectedness(top_returns)</span>
<span id="cb33-1201"><a href="#cb33-1201" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total Connectedness Index: </span><span class="sc">{</span>dy_results[<span class="st">'TCI'</span>]<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb33-1202"><a href="#cb33-1202" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1203"><a href="#cb33-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1206"><a href="#cb33-1206" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1207"><a href="#cb33-1207" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-connectedness</span></span>
<span id="cb33-1208"><a href="#cb33-1208" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1209"><a href="#cb33-1209" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Diebold-Yilmaz Net Connectedness: Net Transmitters (+) and Receivers (‚àí)"</span></span>
<span id="cb33-1210"><a href="#cb33-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1211"><a href="#cb33-1211" aria-hidden="true" tabindex="-1"></a>net_df <span class="op">=</span> pd.DataFrame({</span>
<span id="cb33-1212"><a href="#cb33-1212" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TO_others"</span>: dy_results[<span class="st">"TO"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb33-1213"><a href="#cb33-1213" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FROM_others"</span>: dy_results[<span class="st">"FROM"</span>].<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb33-1214"><a href="#cb33-1214" aria-hidden="true" tabindex="-1"></a>    <span class="st">"NET"</span>: dy_results[<span class="st">"NET"</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb33-1215"><a href="#cb33-1215" aria-hidden="true" tabindex="-1"></a>}).sort_values(<span class="st">"NET"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-1216"><a href="#cb33-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1217"><a href="#cb33-1217" aria-hidden="true" tabindex="-1"></a>net_df</span>
<span id="cb33-1218"><a href="#cb33-1218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1219"><a href="#cb33-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1222"><a href="#cb33-1222" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1223"><a href="#cb33-1223" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rolling-connectedness</span></span>
<span id="cb33-1224"><a href="#cb33-1224" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1225"><a href="#cb33-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1226"><a href="#cb33-1226" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling TCI to track systemic risk over time</span></span>
<span id="cb33-1227"><a href="#cb33-1227" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rolling_tci(returns_wide, window<span class="op">=</span><span class="dv">252</span>, step<span class="op">=</span><span class="dv">21</span>, var_order<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb33-1228"><a href="#cb33-1228" aria-hidden="true" tabindex="-1"></a>                 forecast_horizon<span class="op">=</span><span class="dv">10</span>, min_stocks<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb33-1229"><a href="#cb33-1229" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute rolling Total Connectedness Index."""</span></span>
<span id="cb33-1230"><a href="#cb33-1230" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> returns_wide.index</span>
<span id="cb33-1231"><a href="#cb33-1231" aria-hidden="true" tabindex="-1"></a>    tci_series <span class="op">=</span> []</span>
<span id="cb33-1232"><a href="#cb33-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1233"><a href="#cb33-1233" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(window, <span class="bu">len</span>(dates), step):</span>
<span id="cb33-1234"><a href="#cb33-1234" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> returns_wide.iloc[i <span class="op">-</span> window:i]</span>
<span id="cb33-1235"><a href="#cb33-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1236"><a href="#cb33-1236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Keep stocks with sufficient data</span></span>
<span id="cb33-1237"><a href="#cb33-1237" aria-hidden="true" tabindex="-1"></a>        valid_cols <span class="op">=</span> window_data.dropna(axis<span class="op">=</span><span class="dv">1</span>, thresh<span class="op">=</span><span class="bu">int</span>(window <span class="op">*</span> <span class="fl">0.9</span>))</span>
<span id="cb33-1238"><a href="#cb33-1238" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> valid_cols.shape[<span class="dv">1</span>] <span class="op">&lt;</span> min_stocks:</span>
<span id="cb33-1239"><a href="#cb33-1239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-1240"><a href="#cb33-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1241"><a href="#cb33-1241" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use top stocks by variance (most informative)</span></span>
<span id="cb33-1242"><a href="#cb33-1242" aria-hidden="true" tabindex="-1"></a>        top_cols <span class="op">=</span> valid_cols.var().nlargest(min_stocks).index</span>
<span id="cb33-1243"><a href="#cb33-1243" aria-hidden="true" tabindex="-1"></a>        subset <span class="op">=</span> valid_cols[top_cols].dropna()</span>
<span id="cb33-1244"><a href="#cb33-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1245"><a href="#cb33-1245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> window <span class="op">*</span> <span class="fl">0.8</span>:</span>
<span id="cb33-1246"><a href="#cb33-1246" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-1247"><a href="#cb33-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1248"><a href="#cb33-1248" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb33-1249"><a href="#cb33-1249" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> diebold_yilmaz_connectedness(</span>
<span id="cb33-1250"><a href="#cb33-1250" aria-hidden="true" tabindex="-1"></a>                subset, var_order, forecast_horizon</span>
<span id="cb33-1251"><a href="#cb33-1251" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-1252"><a href="#cb33-1252" aria-hidden="true" tabindex="-1"></a>            tci_series.append({</span>
<span id="cb33-1253"><a href="#cb33-1253" aria-hidden="true" tabindex="-1"></a>                <span class="st">"date"</span>: dates[i],</span>
<span id="cb33-1254"><a href="#cb33-1254" aria-hidden="true" tabindex="-1"></a>                <span class="st">"TCI"</span>: result[<span class="st">"TCI"</span>],</span>
<span id="cb33-1255"><a href="#cb33-1255" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_stocks"</span>: <span class="bu">len</span>(top_cols)</span>
<span id="cb33-1256"><a href="#cb33-1256" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb33-1257"><a href="#cb33-1257" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb33-1258"><a href="#cb33-1258" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb33-1259"><a href="#cb33-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1260"><a href="#cb33-1260" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(tci_series)</span>
<span id="cb33-1261"><a href="#cb33-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1262"><a href="#cb33-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1263"><a href="#cb33-1263" aria-hidden="true" tabindex="-1"></a><span class="co"># tci_df = rolling_tci(daily_wide, window=252, step=21)</span></span>
<span id="cb33-1264"><a href="#cb33-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1265"><a href="#cb33-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1266"><a href="#cb33-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Interbank and Financial Contagion Networks</span></span>
<span id="cb33-1267"><a href="#cb33-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1268"><a href="#cb33-1268" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Interbank Market as a Network</span></span>
<span id="cb33-1269"><a href="#cb33-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1270"><a href="#cb33-1270" aria-hidden="true" tabindex="-1"></a>The interbank market, where banks lend reserves to each other, is the canonical financial network. @allen2000financial demonstrate that the structure of interbank linkages determines whether a bank failure cascades into a systemic crisis or is absorbed by the network. Two extreme topologies illustrate:</span>
<span id="cb33-1271"><a href="#cb33-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1272"><a href="#cb33-1272" aria-hidden="true" tabindex="-1"></a>**Complete network (all banks linked to all).** Each bank's exposure to any single counterpart is small. A bank failure imposes small losses on many banks, which can individually absorb them. The network is resilient.</span>
<span id="cb33-1273"><a href="#cb33-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1274"><a href="#cb33-1274" aria-hidden="true" tabindex="-1"></a>**Ring network (each bank linked to one neighbor).** Each bank's exposure is concentrated in a single counterpart. A failure in one bank can topple its neighbor, triggering a chain of cascading defaults. The network is fragile.</span>
<span id="cb33-1275"><a href="#cb33-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1276"><a href="#cb33-1276" aria-hidden="true" tabindex="-1"></a>The Vietnamese banking system, with its concentration of state-owned banks and the regulatory emphasis on interbank lending for liquidity management, lies between these extremes.</span>
<span id="cb33-1277"><a href="#cb33-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1280"><a href="#cb33-1280" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1281"><a href="#cb33-1281" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: interbank-network</span></span>
<span id="cb33-1282"><a href="#cb33-1282" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1283"><a href="#cb33-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1284"><a href="#cb33-1284" aria-hidden="true" tabindex="-1"></a><span class="co"># Load interbank exposure data</span></span>
<span id="cb33-1285"><a href="#cb33-1285" aria-hidden="true" tabindex="-1"></a>interbank <span class="op">=</span> dc.get_interbank_exposures(</span>
<span id="cb33-1286"><a href="#cb33-1286" aria-hidden="true" tabindex="-1"></a>    date<span class="op">=</span><span class="st">"2024-06-30"</span></span>
<span id="cb33-1287"><a href="#cb33-1287" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-1288"><a href="#cb33-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1289"><a href="#cb33-1289" aria-hidden="true" tabindex="-1"></a><span class="co"># Build interbank network</span></span>
<span id="cb33-1290"><a href="#cb33-1290" aria-hidden="true" tabindex="-1"></a>G_bank <span class="op">=</span> nx.DiGraph()</span>
<span id="cb33-1291"><a href="#cb33-1291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1292"><a href="#cb33-1292" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> interbank.iterrows():</span>
<span id="cb33-1293"><a href="#cb33-1293" aria-hidden="true" tabindex="-1"></a>    G_bank.add_edge(</span>
<span id="cb33-1294"><a href="#cb33-1294" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"lender_bank"</span>],</span>
<span id="cb33-1295"><a href="#cb33-1295" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">"borrower_bank"</span>],</span>
<span id="cb33-1296"><a href="#cb33-1296" aria-hidden="true" tabindex="-1"></a>        weight<span class="op">=</span>row[<span class="st">"exposure_bn_vnd"</span>],</span>
<span id="cb33-1297"><a href="#cb33-1297" aria-hidden="true" tabindex="-1"></a>        exposure_pct_equity<span class="op">=</span>row.get(<span class="st">"exposure_pct_equity"</span>, <span class="dv">0</span>)</span>
<span id="cb33-1298"><a href="#cb33-1298" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1299"><a href="#cb33-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1300"><a href="#cb33-1300" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bank attributes</span></span>
<span id="cb33-1301"><a href="#cb33-1301" aria-hidden="true" tabindex="-1"></a>bank_info <span class="op">=</span> dc.get_bank_characteristics(date<span class="op">=</span><span class="st">"2024-06-30"</span>)</span>
<span id="cb33-1302"><a href="#cb33-1302" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> bank_info.iterrows():</span>
<span id="cb33-1303"><a href="#cb33-1303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">"ticker"</span>] <span class="kw">in</span> G_bank:</span>
<span id="cb33-1304"><a href="#cb33-1304" aria-hidden="true" tabindex="-1"></a>        G_bank.nodes[row[<span class="st">"ticker"</span>]].update({</span>
<span id="cb33-1305"><a href="#cb33-1305" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_assets"</span>: row.get(<span class="st">"total_assets"</span>, <span class="dv">0</span>),</span>
<span id="cb33-1306"><a href="#cb33-1306" aria-hidden="true" tabindex="-1"></a>            <span class="st">"equity"</span>: row.get(<span class="st">"equity"</span>, <span class="dv">0</span>),</span>
<span id="cb33-1307"><a href="#cb33-1307" aria-hidden="true" tabindex="-1"></a>            <span class="st">"is_soe"</span>: row.get(<span class="st">"is_soe"</span>, <span class="va">False</span>),</span>
<span id="cb33-1308"><a href="#cb33-1308" aria-hidden="true" tabindex="-1"></a>            <span class="st">"tier1_ratio"</span>: row.get(<span class="st">"tier1_ratio"</span>, <span class="dv">0</span>)</span>
<span id="cb33-1309"><a href="#cb33-1309" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb33-1310"><a href="#cb33-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1311"><a href="#cb33-1311" aria-hidden="true" tabindex="-1"></a>bank_metrics, bank_graph_stats <span class="op">=</span> compute_network_metrics(G_bank)</span>
<span id="cb33-1312"><a href="#cb33-1312" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1313"><a href="#cb33-1313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1314"><a href="#cb33-1314" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cascading Default Simulation</span></span>
<span id="cb33-1315"><a href="#cb33-1315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1316"><a href="#cb33-1316" aria-hidden="true" tabindex="-1"></a>We implement the @eisenberg2001systemic clearing mechanism to simulate cascading defaults in the interbank network. When a bank fails, it cannot honor its interbank obligations, imposing losses on its creditors, who may in turn fail:</span>
<span id="cb33-1317"><a href="#cb33-1317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1318"><a href="#cb33-1318" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1319"><a href="#cb33-1319" aria-hidden="true" tabindex="-1"></a>p_i^* = \min\left(\bar{p}_i, \; e_i + \sum_{j} \frac{L_{ji}}{\sum_k L_{jk}} p_j^*\right)</span>
<span id="cb33-1320"><a href="#cb33-1320" aria-hidden="true" tabindex="-1"></a>$$ {#eq-eisenberg-noe}</span>
<span id="cb33-1321"><a href="#cb33-1321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1322"><a href="#cb33-1322" aria-hidden="true" tabindex="-1"></a>where $p_i^*$ is bank $i$'s actual payment, $\bar{p}_i$ is its total obligation, $e_i$ is its external assets minus external liabilities, and $L_{ji}/\sum_k L_{jk}$ is the fraction of bank $j$'s obligations owed to bank $i$.</span>
<span id="cb33-1323"><a href="#cb33-1323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1326"><a href="#cb33-1326" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1327"><a href="#cb33-1327" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: cascading-defaults</span></span>
<span id="cb33-1328"><a href="#cb33-1328" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1329"><a href="#cb33-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1330"><a href="#cb33-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1331"><a href="#cb33-1331" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_cascading_defaults(G, initial_failure, </span>
<span id="cb33-1332"><a href="#cb33-1332" aria-hidden="true" tabindex="-1"></a>                                  equity_buffer<span class="op">=</span><span class="fl">0.08</span>,</span>
<span id="cb33-1333"><a href="#cb33-1333" aria-hidden="true" tabindex="-1"></a>                                  max_rounds<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb33-1334"><a href="#cb33-1334" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1335"><a href="#cb33-1335" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate cascading defaults in an interbank network.</span></span>
<span id="cb33-1336"><a href="#cb33-1336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1337"><a href="#cb33-1337" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-1338"><a href="#cb33-1338" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-1339"><a href="#cb33-1339" aria-hidden="true" tabindex="-1"></a><span class="co">    G : nx.DiGraph</span></span>
<span id="cb33-1340"><a href="#cb33-1340" aria-hidden="true" tabindex="-1"></a><span class="co">        Interbank exposure graph (lender ‚Üí borrower, weight = exposure).</span></span>
<span id="cb33-1341"><a href="#cb33-1341" aria-hidden="true" tabindex="-1"></a><span class="co">    initial_failure : str</span></span>
<span id="cb33-1342"><a href="#cb33-1342" aria-hidden="true" tabindex="-1"></a><span class="co">        Bank that fails initially.</span></span>
<span id="cb33-1343"><a href="#cb33-1343" aria-hidden="true" tabindex="-1"></a><span class="co">    equity_buffer : float</span></span>
<span id="cb33-1344"><a href="#cb33-1344" aria-hidden="true" tabindex="-1"></a><span class="co">        Fraction of equity that absorbs losses before default.</span></span>
<span id="cb33-1345"><a href="#cb33-1345" aria-hidden="true" tabindex="-1"></a><span class="co">    max_rounds : int</span></span>
<span id="cb33-1346"><a href="#cb33-1346" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum cascade rounds.</span></span>
<span id="cb33-1347"><a href="#cb33-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1348"><a href="#cb33-1348" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-1349"><a href="#cb33-1349" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-1350"><a href="#cb33-1350" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Defaulted banks, round-by-round losses, systemic loss.</span></span>
<span id="cb33-1351"><a href="#cb33-1351" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1352"><a href="#cb33-1352" aria-hidden="true" tabindex="-1"></a>    defaulted <span class="op">=</span> {initial_failure}</span>
<span id="cb33-1353"><a href="#cb33-1353" aria-hidden="true" tabindex="-1"></a>    cascade_history <span class="op">=</span> [{<span class="st">"round"</span>: <span class="dv">0</span>, <span class="st">"defaults"</span>: [initial_failure],</span>
<span id="cb33-1354"><a href="#cb33-1354" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"total_defaults"</span>: <span class="dv">1</span>}]</span>
<span id="cb33-1355"><a href="#cb33-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1356"><a href="#cb33-1356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> round_num <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, max_rounds <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb33-1357"><a href="#cb33-1357" aria-hidden="true" tabindex="-1"></a>        new_defaults <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb33-1358"><a href="#cb33-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1359"><a href="#cb33-1359" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bank <span class="kw">in</span> G.nodes():</span>
<span id="cb33-1360"><a href="#cb33-1360" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> bank <span class="kw">in</span> defaulted:</span>
<span id="cb33-1361"><a href="#cb33-1361" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb33-1362"><a href="#cb33-1362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1363"><a href="#cb33-1363" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute losses from defaulted counterparties</span></span>
<span id="cb33-1364"><a href="#cb33-1364" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-1365"><a href="#cb33-1365" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> defaulted_bank <span class="kw">in</span> defaulted:</span>
<span id="cb33-1366"><a href="#cb33-1366" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> G.has_edge(bank, defaulted_bank):</span>
<span id="cb33-1367"><a href="#cb33-1367" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># bank lent to defaulted_bank ‚Üí loss</span></span>
<span id="cb33-1368"><a href="#cb33-1368" aria-hidden="true" tabindex="-1"></a>                    exposure <span class="op">=</span> G[bank][defaulted_bank][<span class="st">"weight"</span>]</span>
<span id="cb33-1369"><a href="#cb33-1369" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Assume LGD = 60%</span></span>
<span id="cb33-1370"><a href="#cb33-1370" aria-hidden="true" tabindex="-1"></a>                    loss <span class="op">=</span> exposure <span class="op">*</span> <span class="fl">0.6</span></span>
<span id="cb33-1371"><a href="#cb33-1371" aria-hidden="true" tabindex="-1"></a>                    total_loss <span class="op">+=</span> loss</span>
<span id="cb33-1372"><a href="#cb33-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1373"><a href="#cb33-1373" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if losses exceed equity buffer</span></span>
<span id="cb33-1374"><a href="#cb33-1374" aria-hidden="true" tabindex="-1"></a>            bank_data <span class="op">=</span> G.nodes.get(bank, {})</span>
<span id="cb33-1375"><a href="#cb33-1375" aria-hidden="true" tabindex="-1"></a>            equity <span class="op">=</span> bank_data.get(<span class="st">"equity"</span>, <span class="bu">float</span>(<span class="st">"inf"</span>))</span>
<span id="cb33-1376"><a href="#cb33-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1377"><a href="#cb33-1377" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_loss <span class="op">&gt;</span> equity <span class="op">*</span> equity_buffer:</span>
<span id="cb33-1378"><a href="#cb33-1378" aria-hidden="true" tabindex="-1"></a>                new_defaults.add(bank)</span>
<span id="cb33-1379"><a href="#cb33-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1380"><a href="#cb33-1380" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> new_defaults:</span>
<span id="cb33-1381"><a href="#cb33-1381" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb33-1382"><a href="#cb33-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1383"><a href="#cb33-1383" aria-hidden="true" tabindex="-1"></a>        defaulted <span class="op">|=</span> new_defaults</span>
<span id="cb33-1384"><a href="#cb33-1384" aria-hidden="true" tabindex="-1"></a>        cascade_history.append({</span>
<span id="cb33-1385"><a href="#cb33-1385" aria-hidden="true" tabindex="-1"></a>            <span class="st">"round"</span>: round_num,</span>
<span id="cb33-1386"><a href="#cb33-1386" aria-hidden="true" tabindex="-1"></a>            <span class="st">"defaults"</span>: <span class="bu">list</span>(new_defaults),</span>
<span id="cb33-1387"><a href="#cb33-1387" aria-hidden="true" tabindex="-1"></a>            <span class="st">"total_defaults"</span>: <span class="bu">len</span>(defaulted)</span>
<span id="cb33-1388"><a href="#cb33-1388" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb33-1389"><a href="#cb33-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1390"><a href="#cb33-1390" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute systemic loss</span></span>
<span id="cb33-1391"><a href="#cb33-1391" aria-hidden="true" tabindex="-1"></a>    total_system_equity <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb33-1392"><a href="#cb33-1392" aria-hidden="true" tabindex="-1"></a>        G.nodes[n].get(<span class="st">"equity"</span>, <span class="dv">0</span>) <span class="cf">for</span> n <span class="kw">in</span> G.nodes()</span>
<span id="cb33-1393"><a href="#cb33-1393" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1394"><a href="#cb33-1394" aria-hidden="true" tabindex="-1"></a>    defaulted_equity <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb33-1395"><a href="#cb33-1395" aria-hidden="true" tabindex="-1"></a>        G.nodes[n].get(<span class="st">"equity"</span>, <span class="dv">0</span>) <span class="cf">for</span> n <span class="kw">in</span> defaulted</span>
<span id="cb33-1396"><a href="#cb33-1396" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1397"><a href="#cb33-1397" aria-hidden="true" tabindex="-1"></a>    systemic_loss_pct <span class="op">=</span> (</span>
<span id="cb33-1398"><a href="#cb33-1398" aria-hidden="true" tabindex="-1"></a>        defaulted_equity <span class="op">/</span> total_system_equity</span>
<span id="cb33-1399"><a href="#cb33-1399" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_system_equity <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb33-1400"><a href="#cb33-1400" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1401"><a href="#cb33-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1402"><a href="#cb33-1402" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb33-1403"><a href="#cb33-1403" aria-hidden="true" tabindex="-1"></a>        <span class="st">"defaulted_banks"</span>: <span class="bu">list</span>(defaulted),</span>
<span id="cb33-1404"><a href="#cb33-1404" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_defaults"</span>: <span class="bu">len</span>(defaulted),</span>
<span id="cb33-1405"><a href="#cb33-1405" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_rounds"</span>: <span class="bu">len</span>(cascade_history) <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb33-1406"><a href="#cb33-1406" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_history"</span>: cascade_history,</span>
<span id="cb33-1407"><a href="#cb33-1407" aria-hidden="true" tabindex="-1"></a>        <span class="st">"systemic_loss_pct"</span>: systemic_loss_pct</span>
<span id="cb33-1408"><a href="#cb33-1408" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-1409"><a href="#cb33-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1410"><a href="#cb33-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1411"><a href="#cb33-1411" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate cascade for each bank</span></span>
<span id="cb33-1412"><a href="#cb33-1412" aria-hidden="true" tabindex="-1"></a>cascade_results <span class="op">=</span> []</span>
<span id="cb33-1413"><a href="#cb33-1413" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> bank <span class="kw">in</span> G_bank.nodes():</span>
<span id="cb33-1414"><a href="#cb33-1414" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> simulate_cascading_defaults(G_bank, bank)</span>
<span id="cb33-1415"><a href="#cb33-1415" aria-hidden="true" tabindex="-1"></a>    cascade_results.append({</span>
<span id="cb33-1416"><a href="#cb33-1416" aria-hidden="true" tabindex="-1"></a>        <span class="st">"initial_failure"</span>: bank,</span>
<span id="cb33-1417"><a href="#cb33-1417" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_cascading_defaults"</span>: result[<span class="st">"n_defaults"</span>],</span>
<span id="cb33-1418"><a href="#cb33-1418" aria-hidden="true" tabindex="-1"></a>        <span class="st">"systemic_loss_pct"</span>: result[<span class="st">"systemic_loss_pct"</span>],</span>
<span id="cb33-1419"><a href="#cb33-1419" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cascade_rounds"</span>: result[<span class="st">"cascade_rounds"</span>]</span>
<span id="cb33-1420"><a href="#cb33-1420" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb33-1421"><a href="#cb33-1421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1422"><a href="#cb33-1422" aria-hidden="true" tabindex="-1"></a>cascade_df <span class="op">=</span> pd.DataFrame(cascade_results).sort_values(</span>
<span id="cb33-1423"><a href="#cb33-1423" aria-hidden="true" tabindex="-1"></a>    <span class="st">"systemic_loss_pct"</span>, ascending<span class="op">=</span><span class="va">False</span></span>
<span id="cb33-1424"><a href="#cb33-1424" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-1425"><a href="#cb33-1425" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1426"><a href="#cb33-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1429"><a href="#cb33-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1430"><a href="#cb33-1430" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-systemic-banks</span></span>
<span id="cb33-1431"><a href="#cb33-1431" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1432"><a href="#cb33-1432" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Systemically Important Banks: Cascading Default Analysis"</span></span>
<span id="cb33-1433"><a href="#cb33-1433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1434"><a href="#cb33-1434" aria-hidden="true" tabindex="-1"></a>cascade_df.head(<span class="dv">15</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb33-1435"><a href="#cb33-1435" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1436"><a href="#cb33-1436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1437"><a href="#cb33-1437" aria-hidden="true" tabindex="-1"></a><span class="fu">## Graph Neural Networks for Financial Prediction</span></span>
<span id="cb33-1438"><a href="#cb33-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1439"><a href="#cb33-1439" aria-hidden="true" tabindex="-1"></a><span class="fu">### From Graphs to Predictions</span></span>
<span id="cb33-1440"><a href="#cb33-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1441"><a href="#cb33-1441" aria-hidden="true" tabindex="-1"></a>Classical network analysis computes hand-crafted features (centrality, clustering, community membership) and feeds them into standard regression models. Graph neural networks (GNNs) learn features directly from the graph structure and node attributes through message passing. The key insight is that a node's representation should depend not only on its own features but on the features of its neighbors, their neighbors, and so on.</span>
<span id="cb33-1442"><a href="#cb33-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1443"><a href="#cb33-1443" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graph Convolutional Networks (GCN)</span></span>
<span id="cb33-1444"><a href="#cb33-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1445"><a href="#cb33-1445" aria-hidden="true" tabindex="-1"></a>The Graph Convolutional Network of @kipf2016semi performs spectral convolution on graphs. The layer-wise propagation rule is:</span>
<span id="cb33-1446"><a href="#cb33-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1447"><a href="#cb33-1447" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1448"><a href="#cb33-1448" aria-hidden="true" tabindex="-1"></a>H^{(\ell+1)} = \sigma\left(\tilde{D}^{-1/2} \tilde{A} \tilde{D}^{-1/2} H^{(\ell)} W^{(\ell)}\right)</span>
<span id="cb33-1449"><a href="#cb33-1449" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gcn}</span>
<span id="cb33-1450"><a href="#cb33-1450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1451"><a href="#cb33-1451" aria-hidden="true" tabindex="-1"></a>where $\tilde{A} = A + I_n$ is the adjacency matrix with self-loops, $\tilde{D}$ is the corresponding degree matrix, $H^{(\ell)}$ is the node feature matrix at layer $\ell$, $W^{(\ell)}$ is the learnable weight matrix, and $\sigma$ is a nonlinearity (ReLU). The normalized $\tilde{D}^{-1/2} \tilde{A} \tilde{D}^{-1/2}$ term averages each node's features with its neighbors' features, weighted by degree.</span>
<span id="cb33-1452"><a href="#cb33-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1453"><a href="#cb33-1453" aria-hidden="true" tabindex="-1"></a><span class="fu">### Graph Attention Networks (GAT)</span></span>
<span id="cb33-1454"><a href="#cb33-1454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1455"><a href="#cb33-1455" aria-hidden="true" tabindex="-1"></a>The Graph Attention Network of @velivckovic2017graph replaces the fixed normalization in GCN with learned attention coefficients:</span>
<span id="cb33-1456"><a href="#cb33-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1457"><a href="#cb33-1457" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1458"><a href="#cb33-1458" aria-hidden="true" tabindex="-1"></a>h_i^{(\ell+1)} = \sigma\left(\sum_{j \in \mathcal{N}(i)} \alpha_{ij}^{(\ell)} W^{(\ell)} h_j^{(\ell)}\right)</span>
<span id="cb33-1459"><a href="#cb33-1459" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gat}</span>
<span id="cb33-1460"><a href="#cb33-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1461"><a href="#cb33-1461" aria-hidden="true" tabindex="-1"></a>where the attention coefficient $\alpha_{ij}$ is computed as:</span>
<span id="cb33-1462"><a href="#cb33-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1463"><a href="#cb33-1463" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1464"><a href="#cb33-1464" aria-hidden="true" tabindex="-1"></a>\alpha_{ij} = \frac{\exp\left(\text{LeakyReLU}\left(\mathbf{a}^\top <span class="co">[</span><span class="ot">W h_i \| W h_j</span><span class="co">]</span>\right)\right)}{\sum_{k \in \mathcal{N}(i)} \exp\left(\text{LeakyReLU}\left(\mathbf{a}^\top <span class="co">[</span><span class="ot">W h_i \| W h_k</span><span class="co">]</span>\right)\right)}</span>
<span id="cb33-1465"><a href="#cb33-1465" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gat-attention}</span>
<span id="cb33-1466"><a href="#cb33-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1467"><a href="#cb33-1467" aria-hidden="true" tabindex="-1"></a>This allows the model to learn which neighbors are most informative for each node, rather than treating all neighbors equally.</span>
<span id="cb33-1468"><a href="#cb33-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1471"><a href="#cb33-1471" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1472"><a href="#cb33-1472" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gnn-models</span></span>
<span id="cb33-1473"><a href="#cb33-1473" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1474"><a href="#cb33-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1475"><a href="#cb33-1475" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GCNLayer(nn.Module):</span>
<span id="cb33-1476"><a href="#cb33-1476" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Graph Convolutional Network layer (Kipf &amp; Welling, 2016)."""</span></span>
<span id="cb33-1477"><a href="#cb33-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1478"><a href="#cb33-1478" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_features, out_features, bias<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb33-1479"><a href="#cb33-1479" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-1480"><a href="#cb33-1480" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.weight <span class="op">=</span> nn.Parameter(torch.FloatTensor(in_features, out_features))</span>
<span id="cb33-1481"><a href="#cb33-1481" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> bias:</span>
<span id="cb33-1482"><a href="#cb33-1482" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bias <span class="op">=</span> nn.Parameter(torch.FloatTensor(out_features))</span>
<span id="cb33-1483"><a href="#cb33-1483" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-1484"><a href="#cb33-1484" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.bias <span class="op">=</span> <span class="va">None</span></span>
<span id="cb33-1485"><a href="#cb33-1485" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_parameters()</span>
<span id="cb33-1486"><a href="#cb33-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1487"><a href="#cb33-1487" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset_parameters(<span class="va">self</span>):</span>
<span id="cb33-1488"><a href="#cb33-1488" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.weight)</span>
<span id="cb33-1489"><a href="#cb33-1489" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.bias <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb33-1490"><a href="#cb33-1490" aria-hidden="true" tabindex="-1"></a>            nn.init.zeros_(<span class="va">self</span>.bias)</span>
<span id="cb33-1491"><a href="#cb33-1491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1492"><a href="#cb33-1492" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj_norm):</span>
<span id="cb33-1493"><a href="#cb33-1493" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb33-1494"><a href="#cb33-1494" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb33-1495"><a href="#cb33-1495" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb33-1496"><a href="#cb33-1496" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, in_features)</span></span>
<span id="cb33-1497"><a href="#cb33-1497" aria-hidden="true" tabindex="-1"></a><span class="co">            Node feature matrix.</span></span>
<span id="cb33-1498"><a href="#cb33-1498" aria-hidden="true" tabindex="-1"></a><span class="co">        adj_norm : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb33-1499"><a href="#cb33-1499" aria-hidden="true" tabindex="-1"></a><span class="co">            Normalized adjacency matrix (D^{-1/2} A D^{-1/2}).</span></span>
<span id="cb33-1500"><a href="#cb33-1500" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb33-1501"><a href="#cb33-1501" aria-hidden="true" tabindex="-1"></a>        support <span class="op">=</span> x <span class="op">@</span> <span class="va">self</span>.weight</span>
<span id="cb33-1502"><a href="#cb33-1502" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> adj_norm <span class="op">@</span> support</span>
<span id="cb33-1503"><a href="#cb33-1503" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.bias <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb33-1504"><a href="#cb33-1504" aria-hidden="true" tabindex="-1"></a>            output <span class="op">=</span> output <span class="op">+</span> <span class="va">self</span>.bias</span>
<span id="cb33-1505"><a href="#cb33-1505" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output</span>
<span id="cb33-1506"><a href="#cb33-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1507"><a href="#cb33-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1508"><a href="#cb33-1508" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> GATLayer(nn.Module):</span>
<span id="cb33-1509"><a href="#cb33-1509" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Graph Attention Network layer (Velickovic et al., 2017)."""</span></span>
<span id="cb33-1510"><a href="#cb33-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1511"><a href="#cb33-1511" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, in_features, out_features, n_heads<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb33-1512"><a href="#cb33-1512" aria-hidden="true" tabindex="-1"></a>                 dropout<span class="op">=</span><span class="fl">0.1</span>, concat<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb33-1513"><a href="#cb33-1513" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-1514"><a href="#cb33-1514" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.n_heads <span class="op">=</span> n_heads</span>
<span id="cb33-1515"><a href="#cb33-1515" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.out_features <span class="op">=</span> out_features</span>
<span id="cb33-1516"><a href="#cb33-1516" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.concat <span class="op">=</span> concat</span>
<span id="cb33-1517"><a href="#cb33-1517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1518"><a href="#cb33-1518" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.W <span class="op">=</span> nn.Parameter(</span>
<span id="cb33-1519"><a href="#cb33-1519" aria-hidden="true" tabindex="-1"></a>            torch.FloatTensor(n_heads, in_features, out_features)</span>
<span id="cb33-1520"><a href="#cb33-1520" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1521"><a href="#cb33-1521" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.a <span class="op">=</span> nn.Parameter(torch.FloatTensor(n_heads, <span class="dv">2</span> <span class="op">*</span> out_features, <span class="dv">1</span>))</span>
<span id="cb33-1522"><a href="#cb33-1522" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(dropout)</span>
<span id="cb33-1523"><a href="#cb33-1523" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.leaky_relu <span class="op">=</span> nn.LeakyReLU(<span class="fl">0.2</span>)</span>
<span id="cb33-1524"><a href="#cb33-1524" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.reset_parameters()</span>
<span id="cb33-1525"><a href="#cb33-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1526"><a href="#cb33-1526" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> reset_parameters(<span class="va">self</span>):</span>
<span id="cb33-1527"><a href="#cb33-1527" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.W)</span>
<span id="cb33-1528"><a href="#cb33-1528" aria-hidden="true" tabindex="-1"></a>        nn.init.xavier_uniform_(<span class="va">self</span>.a)</span>
<span id="cb33-1529"><a href="#cb33-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1530"><a href="#cb33-1530" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb33-1531"><a href="#cb33-1531" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb33-1532"><a href="#cb33-1532" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb33-1533"><a href="#cb33-1533" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb33-1534"><a href="#cb33-1534" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, in_features)</span></span>
<span id="cb33-1535"><a href="#cb33-1535" aria-hidden="true" tabindex="-1"></a><span class="co">        adj : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb33-1536"><a href="#cb33-1536" aria-hidden="true" tabindex="-1"></a><span class="co">            Binary adjacency matrix (1 if edge, 0 otherwise).</span></span>
<span id="cb33-1537"><a href="#cb33-1537" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb33-1538"><a href="#cb33-1538" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> x.size(<span class="dv">0</span>)</span>
<span id="cb33-1539"><a href="#cb33-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1540"><a href="#cb33-1540" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Linear transformation for each head</span></span>
<span id="cb33-1541"><a href="#cb33-1541" aria-hidden="true" tabindex="-1"></a>        <span class="co"># x: (n, in_f) -&gt; h: (heads, n, out_f)</span></span>
<span id="cb33-1542"><a href="#cb33-1542" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> torch.einsum(<span class="st">"ni,hio-&gt;hno"</span>, x, <span class="va">self</span>.W)</span>
<span id="cb33-1543"><a href="#cb33-1543" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1544"><a href="#cb33-1544" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attention coefficients</span></span>
<span id="cb33-1545"><a href="#cb33-1545" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concatenate h_i and h_j for all pairs</span></span>
<span id="cb33-1546"><a href="#cb33-1546" aria-hidden="true" tabindex="-1"></a>        h_i <span class="op">=</span> h.unsqueeze(<span class="dv">2</span>).expand(<span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, n, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (heads, n, n, out_f)</span></span>
<span id="cb33-1547"><a href="#cb33-1547" aria-hidden="true" tabindex="-1"></a>        h_j <span class="op">=</span> h.unsqueeze(<span class="dv">1</span>).expand(<span class="op">-</span><span class="dv">1</span>, n, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (heads, n, n, out_f)</span></span>
<span id="cb33-1548"><a href="#cb33-1548" aria-hidden="true" tabindex="-1"></a>        concat_h <span class="op">=</span> torch.cat([h_i, h_j], dim<span class="op">=-</span><span class="dv">1</span>)    <span class="co"># (heads, n, n, 2*out_f)</span></span>
<span id="cb33-1549"><a href="#cb33-1549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1550"><a href="#cb33-1550" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> <span class="va">self</span>.leaky_relu(</span>
<span id="cb33-1551"><a href="#cb33-1551" aria-hidden="true" tabindex="-1"></a>            torch.einsum(<span class="st">"hnmo,hoi-&gt;hnm"</span>, concat_h, <span class="va">self</span>.a).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb33-1552"><a href="#cb33-1552" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1553"><a href="#cb33-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1554"><a href="#cb33-1554" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Mask non-edges</span></span>
<span id="cb33-1555"><a href="#cb33-1555" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> adj.unsqueeze(<span class="dv">0</span>).expand(<span class="va">self</span>.n_heads, <span class="op">-</span><span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb33-1556"><a href="#cb33-1556" aria-hidden="true" tabindex="-1"></a>        e <span class="op">=</span> e.masked_fill(mask <span class="op">==</span> <span class="dv">0</span>, <span class="bu">float</span>(<span class="st">"-inf"</span>))</span>
<span id="cb33-1557"><a href="#cb33-1557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1558"><a href="#cb33-1558" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Softmax attention</span></span>
<span id="cb33-1559"><a href="#cb33-1559" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> F.softmax(e, dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb33-1560"><a href="#cb33-1560" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="va">self</span>.dropout(alpha)</span>
<span id="cb33-1561"><a href="#cb33-1561" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1562"><a href="#cb33-1562" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Weighted aggregation</span></span>
<span id="cb33-1563"><a href="#cb33-1563" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> torch.einsum(<span class="st">"hnm,hmo-&gt;hno"</span>, alpha, h)  <span class="co"># (heads, n, out_f)</span></span>
<span id="cb33-1564"><a href="#cb33-1564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1565"><a href="#cb33-1565" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.concat:</span>
<span id="cb33-1566"><a href="#cb33-1566" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> out.permute(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">2</span>).reshape(n, <span class="op">-</span><span class="dv">1</span>)  <span class="co"># (n, heads * out_f)</span></span>
<span id="cb33-1567"><a href="#cb33-1567" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-1568"><a href="#cb33-1568" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> out.mean(dim<span class="op">=</span><span class="dv">0</span>)  <span class="co"># (n, out_f)</span></span>
<span id="cb33-1569"><a href="#cb33-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1570"><a href="#cb33-1570" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> out, alpha</span>
<span id="cb33-1571"><a href="#cb33-1571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1572"><a href="#cb33-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1573"><a href="#cb33-1573" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FinancialGNN(nn.Module):</span>
<span id="cb33-1574"><a href="#cb33-1574" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1575"><a href="#cb33-1575" aria-hidden="true" tabindex="-1"></a><span class="co">    Graph Neural Network for financial node prediction.</span></span>
<span id="cb33-1576"><a href="#cb33-1576" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports GCN and GAT layers with flexible architecture.</span></span>
<span id="cb33-1577"><a href="#cb33-1577" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1578"><a href="#cb33-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1579"><a href="#cb33-1579" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim, hidden_dim<span class="op">=</span><span class="dv">64</span>, output_dim<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb33-1580"><a href="#cb33-1580" aria-hidden="true" tabindex="-1"></a>                 n_layers<span class="op">=</span><span class="dv">2</span>, n_heads<span class="op">=</span><span class="dv">4</span>, gnn_type<span class="op">=</span><span class="st">"gat"</span>,</span>
<span id="cb33-1581"><a href="#cb33-1581" aria-hidden="true" tabindex="-1"></a>                 dropout<span class="op">=</span><span class="fl">0.3</span>):</span>
<span id="cb33-1582"><a href="#cb33-1582" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-1583"><a href="#cb33-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1584"><a href="#cb33-1584" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gnn_type <span class="op">=</span> gnn_type</span>
<span id="cb33-1585"><a href="#cb33-1585" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(dropout)</span>
<span id="cb33-1586"><a href="#cb33-1586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1587"><a href="#cb33-1587" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gnn_type <span class="op">==</span> <span class="st">"gcn"</span>:</span>
<span id="cb33-1588"><a href="#cb33-1588" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.ModuleList()</span>
<span id="cb33-1589"><a href="#cb33-1589" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(GCNLayer(input_dim, hidden_dim))</span>
<span id="cb33-1590"><a href="#cb33-1590" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layers <span class="op">-</span> <span class="dv">1</span>):</span>
<span id="cb33-1591"><a href="#cb33-1591" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.layers.append(GCNLayer(hidden_dim, hidden_dim))</span>
<span id="cb33-1592"><a href="#cb33-1592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1593"><a href="#cb33-1593" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> gnn_type <span class="op">==</span> <span class="st">"gat"</span>:</span>
<span id="cb33-1594"><a href="#cb33-1594" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers <span class="op">=</span> nn.ModuleList()</span>
<span id="cb33-1595"><a href="#cb33-1595" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(</span>
<span id="cb33-1596"><a href="#cb33-1596" aria-hidden="true" tabindex="-1"></a>                GATLayer(input_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb33-1597"><a href="#cb33-1597" aria-hidden="true" tabindex="-1"></a>                         n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-1598"><a href="#cb33-1598" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-1599"><a href="#cb33-1599" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_layers <span class="op">-</span> <span class="dv">2</span>):</span>
<span id="cb33-1600"><a href="#cb33-1600" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.layers.append(</span>
<span id="cb33-1601"><a href="#cb33-1601" aria-hidden="true" tabindex="-1"></a>                    GATLayer(hidden_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb33-1602"><a href="#cb33-1602" aria-hidden="true" tabindex="-1"></a>                             n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-1603"><a href="#cb33-1603" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb33-1604"><a href="#cb33-1604" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Last layer: single head, no concat</span></span>
<span id="cb33-1605"><a href="#cb33-1605" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layers.append(</span>
<span id="cb33-1606"><a href="#cb33-1606" aria-hidden="true" tabindex="-1"></a>                GATLayer(hidden_dim, hidden_dim,</span>
<span id="cb33-1607"><a href="#cb33-1607" aria-hidden="true" tabindex="-1"></a>                         n_heads<span class="op">=</span><span class="dv">1</span>, concat<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-1608"><a href="#cb33-1608" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb33-1609"><a href="#cb33-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1610"><a href="#cb33-1610" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction head</span></span>
<span id="cb33-1611"><a href="#cb33-1611" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb33-1612"><a href="#cb33-1612" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, hidden_dim <span class="op">//</span> <span class="dv">2</span>),</span>
<span id="cb33-1613"><a href="#cb33-1613" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb33-1614"><a href="#cb33-1614" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(dropout),</span>
<span id="cb33-1615"><a href="#cb33-1615" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim <span class="op">//</span> <span class="dv">2</span>, output_dim)</span>
<span id="cb33-1616"><a href="#cb33-1616" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1617"><a href="#cb33-1617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1618"><a href="#cb33-1618" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb33-1619"><a href="#cb33-1619" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb33-1620"><a href="#cb33-1620" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb33-1621"><a href="#cb33-1621" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb33-1622"><a href="#cb33-1622" aria-hidden="true" tabindex="-1"></a><span class="co">        x : Tensor (n_nodes, input_dim)</span></span>
<span id="cb33-1623"><a href="#cb33-1623" aria-hidden="true" tabindex="-1"></a><span class="co">            Node features.</span></span>
<span id="cb33-1624"><a href="#cb33-1624" aria-hidden="true" tabindex="-1"></a><span class="co">        adj : Tensor (n_nodes, n_nodes)</span></span>
<span id="cb33-1625"><a href="#cb33-1625" aria-hidden="true" tabindex="-1"></a><span class="co">            Adjacency matrix.</span></span>
<span id="cb33-1626"><a href="#cb33-1626" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb33-1627"><a href="#cb33-1627" aria-hidden="true" tabindex="-1"></a>        h <span class="op">=</span> x</span>
<span id="cb33-1628"><a href="#cb33-1628" aria-hidden="true" tabindex="-1"></a>        attention_weights <span class="op">=</span> []</span>
<span id="cb33-1629"><a href="#cb33-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1630"><a href="#cb33-1630" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, layer <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.layers):</span>
<span id="cb33-1631"><a href="#cb33-1631" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="va">self</span>.gnn_type <span class="op">==</span> <span class="st">"gcn"</span>:</span>
<span id="cb33-1632"><a href="#cb33-1632" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> layer(h, adj)</span>
<span id="cb33-1633"><a href="#cb33-1633" aria-hidden="true" tabindex="-1"></a>                h <span class="op">=</span> F.relu(h) <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(<span class="va">self</span>.layers) <span class="op">-</span> <span class="dv">1</span> <span class="cf">else</span> h</span>
<span id="cb33-1634"><a href="#cb33-1634" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> <span class="va">self</span>.gnn_type <span class="op">==</span> <span class="st">"gat"</span>:</span>
<span id="cb33-1635"><a href="#cb33-1635" aria-hidden="true" tabindex="-1"></a>                h, alpha <span class="op">=</span> layer(h, adj)</span>
<span id="cb33-1636"><a href="#cb33-1636" aria-hidden="true" tabindex="-1"></a>                attention_weights.append(alpha)</span>
<span id="cb33-1637"><a href="#cb33-1637" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> i <span class="op">&lt;</span> <span class="bu">len</span>(<span class="va">self</span>.layers) <span class="op">-</span> <span class="dv">1</span>:</span>
<span id="cb33-1638"><a href="#cb33-1638" aria-hidden="true" tabindex="-1"></a>                    h <span class="op">=</span> F.elu(h)</span>
<span id="cb33-1639"><a href="#cb33-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1640"><a href="#cb33-1640" aria-hidden="true" tabindex="-1"></a>            h <span class="op">=</span> <span class="va">self</span>.dropout(h)</span>
<span id="cb33-1641"><a href="#cb33-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1642"><a href="#cb33-1642" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> <span class="va">self</span>.head(h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb33-1643"><a href="#cb33-1643" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions, attention_weights</span>
<span id="cb33-1644"><a href="#cb33-1644" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1645"><a href="#cb33-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1646"><a href="#cb33-1646" aria-hidden="true" tabindex="-1"></a><span class="fu">### GNN for Cross-Sectional Return Prediction</span></span>
<span id="cb33-1647"><a href="#cb33-1647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1648"><a href="#cb33-1648" aria-hidden="true" tabindex="-1"></a>We apply the GNN to predict cross-sectional stock returns, where the graph encodes ownership connections between firms. The hypothesis is that firms connected through ownership have correlated return dynamics that the GNN can exploit.</span>
<span id="cb33-1649"><a href="#cb33-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1652"><a href="#cb33-1652" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1653"><a href="#cb33-1653" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gnn-return-prediction</span></span>
<span id="cb33-1654"><a href="#cb33-1654" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1655"><a href="#cb33-1655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1656"><a href="#cb33-1656" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_gnn_data(firms_df, ownership_graph, returns_df, date):</span>
<span id="cb33-1657"><a href="#cb33-1657" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1658"><a href="#cb33-1658" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare node features and adjacency matrix for GNN prediction.</span></span>
<span id="cb33-1659"><a href="#cb33-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1660"><a href="#cb33-1660" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-1661"><a href="#cb33-1661" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-1662"><a href="#cb33-1662" aria-hidden="true" tabindex="-1"></a><span class="co">    firms_df : DataFrame</span></span>
<span id="cb33-1663"><a href="#cb33-1663" aria-hidden="true" tabindex="-1"></a><span class="co">        Firm characteristics.</span></span>
<span id="cb33-1664"><a href="#cb33-1664" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_graph : nx.DiGraph</span></span>
<span id="cb33-1665"><a href="#cb33-1665" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership network.</span></span>
<span id="cb33-1666"><a href="#cb33-1666" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb33-1667"><a href="#cb33-1667" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock returns.</span></span>
<span id="cb33-1668"><a href="#cb33-1668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1669"><a href="#cb33-1669" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-1670"><a href="#cb33-1670" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-1671"><a href="#cb33-1671" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple : (node_features, adjacency, target_returns, ticker_list)</span></span>
<span id="cb33-1672"><a href="#cb33-1672" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1673"><a href="#cb33-1673" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get stocks with both features and network presence</span></span>
<span id="cb33-1674"><a href="#cb33-1674" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> <span class="bu">sorted</span>(</span>
<span id="cb33-1675"><a href="#cb33-1675" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(firms_df[<span class="st">"ticker"</span>]) <span class="op">&amp;</span></span>
<span id="cb33-1676"><a href="#cb33-1676" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(ownership_graph.nodes()) <span class="op">&amp;</span></span>
<span id="cb33-1677"><a href="#cb33-1677" aria-hidden="true" tabindex="-1"></a>        <span class="bu">set</span>(returns_df[<span class="st">"ticker"</span>])</span>
<span id="cb33-1678"><a href="#cb33-1678" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1679"><a href="#cb33-1679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1680"><a href="#cb33-1680" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> tickers:</span>
<span id="cb33-1681"><a href="#cb33-1681" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb33-1682"><a href="#cb33-1682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1683"><a href="#cb33-1683" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Node features</span></span>
<span id="cb33-1684"><a href="#cb33-1684" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [</span>
<span id="cb33-1685"><a href="#cb33-1685" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>,</span>
<span id="cb33-1686"><a href="#cb33-1686" aria-hidden="true" tabindex="-1"></a>        <span class="st">"profitability"</span>, <span class="st">"investment"</span>, <span class="st">"leverage"</span>,</span>
<span id="cb33-1687"><a href="#cb33-1687" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>, <span class="st">"volatility"</span>, <span class="st">"turnover"</span></span>
<span id="cb33-1688"><a href="#cb33-1688" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb33-1689"><a href="#cb33-1689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1690"><a href="#cb33-1690" aria-hidden="true" tabindex="-1"></a>    feat_df <span class="op">=</span> firms_df[firms_df[<span class="st">"ticker"</span>].isin(tickers)].set_index(<span class="st">"ticker"</span>)</span>
<span id="cb33-1691"><a href="#cb33-1691" aria-hidden="true" tabindex="-1"></a>    feat_df <span class="op">=</span> feat_df.reindex(tickers)</span>
<span id="cb33-1692"><a href="#cb33-1692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1693"><a href="#cb33-1693" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> feat_df[feature_cols].fillna(<span class="dv">0</span>).values</span>
<span id="cb33-1694"><a href="#cb33-1694" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> (X <span class="op">-</span> X.mean(axis<span class="op">=</span><span class="dv">0</span>)) <span class="op">/</span> (X.std(axis<span class="op">=</span><span class="dv">0</span>) <span class="op">+</span> <span class="fl">1e-8</span>)</span>
<span id="cb33-1695"><a href="#cb33-1695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1696"><a href="#cb33-1696" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjacency matrix</span></span>
<span id="cb33-1697"><a href="#cb33-1697" aria-hidden="true" tabindex="-1"></a>    ticker_to_idx <span class="op">=</span> {t: i <span class="cf">for</span> i, t <span class="kw">in</span> <span class="bu">enumerate</span>(tickers)}</span>
<span id="cb33-1698"><a href="#cb33-1698" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(tickers)</span>
<span id="cb33-1699"><a href="#cb33-1699" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> np.zeros((n, n))</span>
<span id="cb33-1700"><a href="#cb33-1700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1701"><a href="#cb33-1701" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> u, v, d <span class="kw">in</span> ownership_graph.edges(data<span class="op">=</span><span class="va">True</span>):</span>
<span id="cb33-1702"><a href="#cb33-1702" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> u <span class="kw">in</span> ticker_to_idx <span class="kw">and</span> v <span class="kw">in</span> ticker_to_idx:</span>
<span id="cb33-1703"><a href="#cb33-1703" aria-hidden="true" tabindex="-1"></a>            weight <span class="op">=</span> d.get(<span class="st">"weight"</span>, <span class="dv">1</span>)</span>
<span id="cb33-1704"><a href="#cb33-1704" aria-hidden="true" tabindex="-1"></a>            A[ticker_to_idx[u], ticker_to_idx[v]] <span class="op">=</span> weight</span>
<span id="cb33-1705"><a href="#cb33-1705" aria-hidden="true" tabindex="-1"></a>            A[ticker_to_idx[v], ticker_to_idx[u]] <span class="op">=</span> weight  <span class="co"># Symmetrize</span></span>
<span id="cb33-1706"><a href="#cb33-1706" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1707"><a href="#cb33-1707" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add self-loops</span></span>
<span id="cb33-1708"><a href="#cb33-1708" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> A <span class="op">+</span> np.eye(n)</span>
<span id="cb33-1709"><a href="#cb33-1709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1710"><a href="#cb33-1710" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize: D^{-1/2} A D^{-1/2}</span></span>
<span id="cb33-1711"><a href="#cb33-1711" aria-hidden="true" tabindex="-1"></a>    D <span class="op">=</span> np.diag(A.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb33-1712"><a href="#cb33-1712" aria-hidden="true" tabindex="-1"></a>    D_inv_sqrt <span class="op">=</span> np.diag(<span class="fl">1.0</span> <span class="op">/</span> np.sqrt(np.diag(D) <span class="op">+</span> <span class="fl">1e-10</span>))</span>
<span id="cb33-1713"><a href="#cb33-1713" aria-hidden="true" tabindex="-1"></a>    A_norm <span class="op">=</span> D_inv_sqrt <span class="op">@</span> A <span class="op">@</span> D_inv_sqrt</span>
<span id="cb33-1714"><a href="#cb33-1714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1715"><a href="#cb33-1715" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Target returns</span></span>
<span id="cb33-1716"><a href="#cb33-1716" aria-hidden="true" tabindex="-1"></a>    ret_df <span class="op">=</span> returns_df[</span>
<span id="cb33-1717"><a href="#cb33-1717" aria-hidden="true" tabindex="-1"></a>        (returns_df[<span class="st">"ticker"</span>].isin(tickers)) <span class="op">&amp;</span></span>
<span id="cb33-1718"><a href="#cb33-1718" aria-hidden="true" tabindex="-1"></a>        (returns_df[<span class="st">"date"</span>] <span class="op">==</span> date)</span>
<span id="cb33-1719"><a href="#cb33-1719" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"ticker"</span>).reindex(tickers)</span>
<span id="cb33-1720"><a href="#cb33-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1721"><a href="#cb33-1721" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> ret_df[<span class="st">"ret"</span>].fillna(<span class="dv">0</span>).values</span>
<span id="cb33-1722"><a href="#cb33-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1723"><a href="#cb33-1723" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb33-1724"><a href="#cb33-1724" aria-hidden="true" tabindex="-1"></a>        torch.tensor(X, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb33-1725"><a href="#cb33-1725" aria-hidden="true" tabindex="-1"></a>        torch.tensor(A_norm, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb33-1726"><a href="#cb33-1726" aria-hidden="true" tabindex="-1"></a>        torch.tensor(y, dtype<span class="op">=</span>torch.float32),</span>
<span id="cb33-1727"><a href="#cb33-1727" aria-hidden="true" tabindex="-1"></a>        tickers</span>
<span id="cb33-1728"><a href="#cb33-1728" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-1729"><a href="#cb33-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1730"><a href="#cb33-1730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1731"><a href="#cb33-1731" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_gnn_model(model, X_train, A_train, y_train,</span>
<span id="cb33-1732"><a href="#cb33-1732" aria-hidden="true" tabindex="-1"></a>                     X_val, A_val, y_val,</span>
<span id="cb33-1733"><a href="#cb33-1733" aria-hidden="true" tabindex="-1"></a>                     n_epochs<span class="op">=</span><span class="dv">100</span>, lr<span class="op">=</span><span class="fl">1e-3</span>):</span>
<span id="cb33-1734"><a href="#cb33-1734" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Train GNN model with validation-based early stopping."""</span></span>
<span id="cb33-1735"><a href="#cb33-1735" aria-hidden="true" tabindex="-1"></a>    optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span>lr,</span>
<span id="cb33-1736"><a href="#cb33-1736" aria-hidden="true" tabindex="-1"></a>                                  weight_decay<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb33-1737"><a href="#cb33-1737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1738"><a href="#cb33-1738" aria-hidden="true" tabindex="-1"></a>    best_val_loss <span class="op">=</span> <span class="bu">float</span>(<span class="st">"inf"</span>)</span>
<span id="cb33-1739"><a href="#cb33-1739" aria-hidden="true" tabindex="-1"></a>    patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-1740"><a href="#cb33-1740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1741"><a href="#cb33-1741" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(n_epochs):</span>
<span id="cb33-1742"><a href="#cb33-1742" aria-hidden="true" tabindex="-1"></a>        model.train()</span>
<span id="cb33-1743"><a href="#cb33-1743" aria-hidden="true" tabindex="-1"></a>        optimizer.zero_grad()</span>
<span id="cb33-1744"><a href="#cb33-1744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1745"><a href="#cb33-1745" aria-hidden="true" tabindex="-1"></a>        pred, _ <span class="op">=</span> model(X_train, A_train)</span>
<span id="cb33-1746"><a href="#cb33-1746" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> F.mse_loss(pred, y_train)</span>
<span id="cb33-1747"><a href="#cb33-1747" aria-hidden="true" tabindex="-1"></a>        loss.backward()</span>
<span id="cb33-1748"><a href="#cb33-1748" aria-hidden="true" tabindex="-1"></a>        optimizer.step()</span>
<span id="cb33-1749"><a href="#cb33-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1750"><a href="#cb33-1750" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Validation</span></span>
<span id="cb33-1751"><a href="#cb33-1751" aria-hidden="true" tabindex="-1"></a>        model.<span class="bu">eval</span>()</span>
<span id="cb33-1752"><a href="#cb33-1752" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb33-1753"><a href="#cb33-1753" aria-hidden="true" tabindex="-1"></a>            val_pred, _ <span class="op">=</span> model(X_val, A_val)</span>
<span id="cb33-1754"><a href="#cb33-1754" aria-hidden="true" tabindex="-1"></a>            val_loss <span class="op">=</span> F.mse_loss(val_pred, y_val).item()</span>
<span id="cb33-1755"><a href="#cb33-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1756"><a href="#cb33-1756" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> val_loss <span class="op">&lt;</span> best_val_loss:</span>
<span id="cb33-1757"><a href="#cb33-1757" aria-hidden="true" tabindex="-1"></a>            best_val_loss <span class="op">=</span> val_loss</span>
<span id="cb33-1758"><a href="#cb33-1758" aria-hidden="true" tabindex="-1"></a>            best_state <span class="op">=</span> {k: v.clone() <span class="cf">for</span> k, v <span class="kw">in</span> model.state_dict().items()}</span>
<span id="cb33-1759"><a href="#cb33-1759" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb33-1760"><a href="#cb33-1760" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb33-1761"><a href="#cb33-1761" aria-hidden="true" tabindex="-1"></a>            patience_counter <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb33-1762"><a href="#cb33-1762" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> patience_counter <span class="op">&gt;=</span> <span class="dv">15</span>:</span>
<span id="cb33-1763"><a href="#cb33-1763" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb33-1764"><a href="#cb33-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1765"><a href="#cb33-1765" aria-hidden="true" tabindex="-1"></a>    model.load_state_dict(best_state)</span>
<span id="cb33-1766"><a href="#cb33-1766" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, best_val_loss</span>
<span id="cb33-1767"><a href="#cb33-1767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1768"><a href="#cb33-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1769"><a href="#cb33-1769" aria-hidden="true" tabindex="-1"></a><span class="fu">### Temporal Graph Networks</span></span>
<span id="cb33-1770"><a href="#cb33-1770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1771"><a href="#cb33-1771" aria-hidden="true" tabindex="-1"></a>Financial networks evolve over time. Ownership stakes change, directors rotate, correlations shift. Temporal GNNs extend static GNNs by incorporating the time dimension explicitly. The Temporal Graph Network (TGN) of @rossi2020temporal maintains a memory state for each node that is updated whenever an event involving the node occurs:</span>
<span id="cb33-1772"><a href="#cb33-1772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1773"><a href="#cb33-1773" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb33-1774"><a href="#cb33-1774" aria-hidden="true" tabindex="-1"></a>\mathbf{s}_i(t) = \text{GRU}\left(\mathbf{s}_i(t^-), \; \text{msg}(i, t)\right)</span>
<span id="cb33-1775"><a href="#cb33-1775" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tgn}</span>
<span id="cb33-1776"><a href="#cb33-1776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1777"><a href="#cb33-1777" aria-hidden="true" tabindex="-1"></a>where $\mathbf{s}_i(t)$ is the memory state of node $i$ at time $t$, $\text{msg}(i, t)$ is the message aggregated from events at time $t$, and GRU is a gated recurrent unit.</span>
<span id="cb33-1778"><a href="#cb33-1778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1781"><a href="#cb33-1781" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1782"><a href="#cb33-1782" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: temporal-gnn</span></span>
<span id="cb33-1783"><a href="#cb33-1783" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1784"><a href="#cb33-1784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1785"><a href="#cb33-1785" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TemporalFinancialGNN(nn.Module):</span>
<span id="cb33-1786"><a href="#cb33-1786" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1787"><a href="#cb33-1787" aria-hidden="true" tabindex="-1"></a><span class="co">    Temporal GNN for dynamic financial networks.</span></span>
<span id="cb33-1788"><a href="#cb33-1788" aria-hidden="true" tabindex="-1"></a><span class="co">    Combines graph convolution with temporal memory.</span></span>
<span id="cb33-1789"><a href="#cb33-1789" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1790"><a href="#cb33-1790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1791"><a href="#cb33-1791" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, node_dim, edge_dim<span class="op">=</span><span class="dv">1</span>, memory_dim<span class="op">=</span><span class="dv">64</span>,</span>
<span id="cb33-1792"><a href="#cb33-1792" aria-hidden="true" tabindex="-1"></a>                 hidden_dim<span class="op">=</span><span class="dv">64</span>, output_dim<span class="op">=</span><span class="dv">1</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb33-1793"><a href="#cb33-1793" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-1794"><a href="#cb33-1794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1795"><a href="#cb33-1795" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.memory_dim <span class="op">=</span> memory_dim</span>
<span id="cb33-1796"><a href="#cb33-1796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1797"><a href="#cb33-1797" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Memory update (GRU)</span></span>
<span id="cb33-1798"><a href="#cb33-1798" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.memory_updater <span class="op">=</span> nn.GRUCell(</span>
<span id="cb33-1799"><a href="#cb33-1799" aria-hidden="true" tabindex="-1"></a>            input_size<span class="op">=</span>node_dim <span class="op">+</span> edge_dim <span class="op">+</span> memory_dim,</span>
<span id="cb33-1800"><a href="#cb33-1800" aria-hidden="true" tabindex="-1"></a>            hidden_size<span class="op">=</span>memory_dim</span>
<span id="cb33-1801"><a href="#cb33-1801" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1802"><a href="#cb33-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1803"><a href="#cb33-1803" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Message function</span></span>
<span id="cb33-1804"><a href="#cb33-1804" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.message_fn <span class="op">=</span> nn.Sequential(</span>
<span id="cb33-1805"><a href="#cb33-1805" aria-hidden="true" tabindex="-1"></a>            nn.Linear(memory_dim <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> edge_dim, hidden_dim),</span>
<span id="cb33-1806"><a href="#cb33-1806" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb33-1807"><a href="#cb33-1807" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, memory_dim)</span>
<span id="cb33-1808"><a href="#cb33-1808" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1809"><a href="#cb33-1809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1810"><a href="#cb33-1810" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Graph attention for spatial aggregation</span></span>
<span id="cb33-1811"><a href="#cb33-1811" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.spatial_attn <span class="op">=</span> GATLayer(</span>
<span id="cb33-1812"><a href="#cb33-1812" aria-hidden="true" tabindex="-1"></a>            memory_dim <span class="op">+</span> node_dim, hidden_dim <span class="op">//</span> n_heads,</span>
<span id="cb33-1813"><a href="#cb33-1813" aria-hidden="true" tabindex="-1"></a>            n_heads<span class="op">=</span>n_heads, concat<span class="op">=</span><span class="va">True</span></span>
<span id="cb33-1814"><a href="#cb33-1814" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1815"><a href="#cb33-1815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1816"><a href="#cb33-1816" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Temporal attention for recent history</span></span>
<span id="cb33-1817"><a href="#cb33-1817" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.temporal_attn <span class="op">=</span> nn.MultiheadAttention(</span>
<span id="cb33-1818"><a href="#cb33-1818" aria-hidden="true" tabindex="-1"></a>            embed_dim<span class="op">=</span>hidden_dim, num_heads<span class="op">=</span>n_heads,</span>
<span id="cb33-1819"><a href="#cb33-1819" aria-hidden="true" tabindex="-1"></a>            batch_first<span class="op">=</span><span class="va">True</span></span>
<span id="cb33-1820"><a href="#cb33-1820" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1821"><a href="#cb33-1821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1822"><a href="#cb33-1822" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction head</span></span>
<span id="cb33-1823"><a href="#cb33-1823" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb33-1824"><a href="#cb33-1824" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, hidden_dim),</span>
<span id="cb33-1825"><a href="#cb33-1825" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb33-1826"><a href="#cb33-1826" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb33-1827"><a href="#cb33-1827" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim, output_dim)</span>
<span id="cb33-1828"><a href="#cb33-1828" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1829"><a href="#cb33-1829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1830"><a href="#cb33-1830" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, node_features, adj_sequence, memory<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb33-1831"><a href="#cb33-1831" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb33-1832"><a href="#cb33-1832" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb33-1833"><a href="#cb33-1833" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb33-1834"><a href="#cb33-1834" aria-hidden="true" tabindex="-1"></a><span class="co">        node_features : list of Tensors</span></span>
<span id="cb33-1835"><a href="#cb33-1835" aria-hidden="true" tabindex="-1"></a><span class="co">            Node features at each time step.</span></span>
<span id="cb33-1836"><a href="#cb33-1836" aria-hidden="true" tabindex="-1"></a><span class="co">        adj_sequence : list of Tensors</span></span>
<span id="cb33-1837"><a href="#cb33-1837" aria-hidden="true" tabindex="-1"></a><span class="co">            Adjacency matrices at each time step.</span></span>
<span id="cb33-1838"><a href="#cb33-1838" aria-hidden="true" tabindex="-1"></a><span class="co">        memory : Tensor or None</span></span>
<span id="cb33-1839"><a href="#cb33-1839" aria-hidden="true" tabindex="-1"></a><span class="co">            Initial memory state (n_nodes, memory_dim).</span></span>
<span id="cb33-1840"><a href="#cb33-1840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1841"><a href="#cb33-1841" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns</span></span>
<span id="cb33-1842"><a href="#cb33-1842" aria-hidden="true" tabindex="-1"></a><span class="co">        -------</span></span>
<span id="cb33-1843"><a href="#cb33-1843" aria-hidden="true" tabindex="-1"></a><span class="co">        predictions : Tensor</span></span>
<span id="cb33-1844"><a href="#cb33-1844" aria-hidden="true" tabindex="-1"></a><span class="co">            Predictions for the last time step.</span></span>
<span id="cb33-1845"><a href="#cb33-1845" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb33-1846"><a href="#cb33-1846" aria-hidden="true" tabindex="-1"></a>        n_nodes <span class="op">=</span> node_features[<span class="dv">0</span>].shape[<span class="dv">0</span>]</span>
<span id="cb33-1847"><a href="#cb33-1847" aria-hidden="true" tabindex="-1"></a>        T <span class="op">=</span> <span class="bu">len</span>(node_features)</span>
<span id="cb33-1848"><a href="#cb33-1848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1849"><a href="#cb33-1849" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> memory <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb33-1850"><a href="#cb33-1850" aria-hidden="true" tabindex="-1"></a>            memory <span class="op">=</span> torch.zeros(n_nodes, <span class="va">self</span>.memory_dim)</span>
<span id="cb33-1851"><a href="#cb33-1851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1852"><a href="#cb33-1852" aria-hidden="true" tabindex="-1"></a>        temporal_states <span class="op">=</span> []</span>
<span id="cb33-1853"><a href="#cb33-1853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1854"><a href="#cb33-1854" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> <span class="bu">range</span>(T):</span>
<span id="cb33-1855"><a href="#cb33-1855" aria-hidden="true" tabindex="-1"></a>            x_t <span class="op">=</span> node_features[t]</span>
<span id="cb33-1856"><a href="#cb33-1856" aria-hidden="true" tabindex="-1"></a>            adj_t <span class="op">=</span> adj_sequence[t]</span>
<span id="cb33-1857"><a href="#cb33-1857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1858"><a href="#cb33-1858" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Spatial aggregation via GAT</span></span>
<span id="cb33-1859"><a href="#cb33-1859" aria-hidden="true" tabindex="-1"></a>            combined <span class="op">=</span> torch.cat([x_t, memory], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb33-1860"><a href="#cb33-1860" aria-hidden="true" tabindex="-1"></a>            spatial_out, _ <span class="op">=</span> <span class="va">self</span>.spatial_attn(combined, adj_t)</span>
<span id="cb33-1861"><a href="#cb33-1861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1862"><a href="#cb33-1862" aria-hidden="true" tabindex="-1"></a>            temporal_states.append(spatial_out.unsqueeze(<span class="dv">1</span>))</span>
<span id="cb33-1863"><a href="#cb33-1863" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1864"><a href="#cb33-1864" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update memory with current state</span></span>
<span id="cb33-1865"><a href="#cb33-1865" aria-hidden="true" tabindex="-1"></a>            update_input <span class="op">=</span> torch.cat([</span>
<span id="cb33-1866"><a href="#cb33-1866" aria-hidden="true" tabindex="-1"></a>                x_t, spatial_out[:, :<span class="dv">1</span>].squeeze(<span class="dv">1</span>) <span class="cf">if</span> spatial_out.dim() <span class="op">&gt;</span> <span class="dv">2</span></span>
<span id="cb33-1867"><a href="#cb33-1867" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span> spatial_out,</span>
<span id="cb33-1868"><a href="#cb33-1868" aria-hidden="true" tabindex="-1"></a>                memory</span>
<span id="cb33-1869"><a href="#cb33-1869" aria-hidden="true" tabindex="-1"></a>            ], dim<span class="op">=-</span><span class="dv">1</span>)[:, :<span class="va">self</span>.memory_updater.input_size]</span>
<span id="cb33-1870"><a href="#cb33-1870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1871"><a href="#cb33-1871" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stack temporal states: (n_nodes, T, hidden)</span></span>
<span id="cb33-1872"><a href="#cb33-1872" aria-hidden="true" tabindex="-1"></a>        temporal_stack <span class="op">=</span> torch.cat(temporal_states, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb33-1873"><a href="#cb33-1873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1874"><a href="#cb33-1874" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Temporal attention across time steps</span></span>
<span id="cb33-1875"><a href="#cb33-1875" aria-hidden="true" tabindex="-1"></a>        temporal_out, _ <span class="op">=</span> <span class="va">self</span>.temporal_attn(</span>
<span id="cb33-1876"><a href="#cb33-1876" aria-hidden="true" tabindex="-1"></a>            temporal_stack, temporal_stack, temporal_stack</span>
<span id="cb33-1877"><a href="#cb33-1877" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1878"><a href="#cb33-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1879"><a href="#cb33-1879" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use last time step</span></span>
<span id="cb33-1880"><a href="#cb33-1880" aria-hidden="true" tabindex="-1"></a>        last_spatial <span class="op">=</span> temporal_states[<span class="op">-</span><span class="dv">1</span>].squeeze(<span class="dv">1</span>)</span>
<span id="cb33-1881"><a href="#cb33-1881" aria-hidden="true" tabindex="-1"></a>        last_temporal <span class="op">=</span> temporal_out[:, <span class="op">-</span><span class="dv">1</span>, :]</span>
<span id="cb33-1882"><a href="#cb33-1882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1883"><a href="#cb33-1883" aria-hidden="true" tabindex="-1"></a>        combined <span class="op">=</span> torch.cat([last_spatial, last_temporal], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb33-1884"><a href="#cb33-1884" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> <span class="va">self</span>.head(combined).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb33-1885"><a href="#cb33-1885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1886"><a href="#cb33-1886" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> predictions</span>
<span id="cb33-1887"><a href="#cb33-1887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1888"><a href="#cb33-1888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1889"><a href="#cb33-1889" aria-hidden="true" tabindex="-1"></a><span class="fu">### GNN for Credit Risk and Fraud Detection</span></span>
<span id="cb33-1890"><a href="#cb33-1890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1891"><a href="#cb33-1891" aria-hidden="true" tabindex="-1"></a>Beyond return prediction, GNNs are particularly powerful for credit risk assessment and fraud detection, where the network structure itself is informative. In credit risk, firms connected to defaulted counterparties face elevated risk. In fraud detection, suspicious transaction patterns propagate through networks of related entities.</span>
<span id="cb33-1892"><a href="#cb33-1892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1895"><a href="#cb33-1895" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb33-1896"><a href="#cb33-1896" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gnn-credit-risk</span></span>
<span id="cb33-1897"><a href="#cb33-1897" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb33-1898"><a href="#cb33-1898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1899"><a href="#cb33-1899" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CreditRiskGNN(nn.Module):</span>
<span id="cb33-1900"><a href="#cb33-1900" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-1901"><a href="#cb33-1901" aria-hidden="true" tabindex="-1"></a><span class="co">    GNN for credit default prediction using firm and bank networks.</span></span>
<span id="cb33-1902"><a href="#cb33-1902" aria-hidden="true" tabindex="-1"></a><span class="co">    Node classification: predict default probability per firm.</span></span>
<span id="cb33-1903"><a href="#cb33-1903" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-1904"><a href="#cb33-1904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1905"><a href="#cb33-1905" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, firm_features_dim, bank_features_dim<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb33-1906"><a href="#cb33-1906" aria-hidden="true" tabindex="-1"></a>                 hidden_dim<span class="op">=</span><span class="dv">64</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb33-1907"><a href="#cb33-1907" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb33-1908"><a href="#cb33-1908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1909"><a href="#cb33-1909" aria-hidden="true" tabindex="-1"></a>        input_dim <span class="op">=</span> firm_features_dim <span class="op">+</span> bank_features_dim</span>
<span id="cb33-1910"><a href="#cb33-1910" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1911"><a href="#cb33-1911" aria-hidden="true" tabindex="-1"></a>        <span class="co"># GNN backbone</span></span>
<span id="cb33-1912"><a href="#cb33-1912" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gnn <span class="op">=</span> FinancialGNN(</span>
<span id="cb33-1913"><a href="#cb33-1913" aria-hidden="true" tabindex="-1"></a>            input_dim<span class="op">=</span>input_dim,</span>
<span id="cb33-1914"><a href="#cb33-1914" aria-hidden="true" tabindex="-1"></a>            hidden_dim<span class="op">=</span>hidden_dim,</span>
<span id="cb33-1915"><a href="#cb33-1915" aria-hidden="true" tabindex="-1"></a>            output_dim<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb33-1916"><a href="#cb33-1916" aria-hidden="true" tabindex="-1"></a>            n_layers<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb33-1917"><a href="#cb33-1917" aria-hidden="true" tabindex="-1"></a>            n_heads<span class="op">=</span>n_heads,</span>
<span id="cb33-1918"><a href="#cb33-1918" aria-hidden="true" tabindex="-1"></a>            gnn_type<span class="op">=</span><span class="st">"gat"</span></span>
<span id="cb33-1919"><a href="#cb33-1919" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-1920"><a href="#cb33-1920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1921"><a href="#cb33-1921" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Additional head for probability output</span></span>
<span id="cb33-1922"><a href="#cb33-1922" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sigmoid <span class="op">=</span> nn.Sigmoid()</span>
<span id="cb33-1923"><a href="#cb33-1923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1924"><a href="#cb33-1924" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x, adj):</span>
<span id="cb33-1925"><a href="#cb33-1925" aria-hidden="true" tabindex="-1"></a>        logits, attn <span class="op">=</span> <span class="va">self</span>.gnn(x, adj)</span>
<span id="cb33-1926"><a href="#cb33-1926" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> <span class="va">self</span>.sigmoid(logits)</span>
<span id="cb33-1927"><a href="#cb33-1927" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> probs, attn</span>
<span id="cb33-1928"><a href="#cb33-1928" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb33-1929"><a href="#cb33-1929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1930"><a href="#cb33-1930" aria-hidden="true" tabindex="-1"></a><span class="fu">## When to Use Network Methods</span></span>
<span id="cb33-1931"><a href="#cb33-1931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1932"><a href="#cb33-1932" aria-hidden="true" tabindex="-1"></a><span class="fu">### Decision Framework</span></span>
<span id="cb33-1933"><a href="#cb33-1933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1934"><a href="#cb33-1934" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Question <span class="pp">|</span> Best Approach <span class="pp">|</span> Example <span class="pp">|</span></span>
<span id="cb33-1935"><a href="#cb33-1935" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------------------|------------------------------|--------------------|</span></span>
<span id="cb33-1936"><a href="#cb33-1936" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Does firm $A$ affect firm $B$? <span class="pp">|</span> Pairwise test + network controls <span class="pp">|</span> Supply chain momentum <span class="pp">|</span></span>
<span id="cb33-1937"><a href="#cb33-1937" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Which firms are most systemically important? <span class="pp">|</span> Centrality measures <span class="pp">|</span> Interbank contagion <span class="pp">|</span></span>
<span id="cb33-1938"><a href="#cb33-1938" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Do network-connected firms co-move? <span class="pp">|</span> Correlation vs. interlock overlap <span class="pp">|</span> Board interlock diffusion <span class="pp">|</span></span>
<span id="cb33-1939"><a href="#cb33-1939" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Can network structure predict returns? <span class="pp">|</span> GNN or network-augmented regression <span class="pp">|</span> GCN return prediction <span class="pp">|</span></span>
<span id="cb33-1940"><a href="#cb33-1940" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> How does a shock propagate? <span class="pp">|</span> Cascade simulation <span class="pp">|</span> Eisenberg-Noe default model <span class="pp">|</span></span>
<span id="cb33-1941"><a href="#cb33-1941" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> What is the optimal portfolio given network risk? <span class="pp">|</span> Network-regularized optimization <span class="pp">|</span> Correlation MST filtering <span class="pp">|</span></span>
<span id="cb33-1942"><a href="#cb33-1942" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> How does the network change over time? <span class="pp">|</span> Temporal GNN or rolling analysis <span class="pp">|</span> DY rolling connectedness <span class="pp">|</span></span>
<span id="cb33-1943"><a href="#cb33-1943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1944"><a href="#cb33-1944" aria-hidden="true" tabindex="-1"></a>: Decision Framework for Network Methods {#tbl-network-decision}</span>
<span id="cb33-1945"><a href="#cb33-1945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1946"><a href="#cb33-1946" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Requirements and Vietnamese Availability</span></span>
<span id="cb33-1947"><a href="#cb33-1947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1948"><a href="#cb33-1948" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Network Type <span class="pp">|</span> Required Data <span class="pp">|</span> Vietnamese Availability <span class="pp">|</span> Update Frequency <span class="pp">|</span></span>
<span id="cb33-1949"><a href="#cb33-1949" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|------------------|-------------------|------------------|</span></span>
<span id="cb33-1950"><a href="#cb33-1950" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Ownership <span class="pp">|</span> Shareholder registers <span class="pp">|</span> Good (semi-annual filings) <span class="pp">|</span> Semi-annual <span class="pp">|</span></span>
<span id="cb33-1951"><a href="#cb33-1951" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Board interlocks <span class="pp">|</span> Director appointments <span class="pp">|</span> Good (filings) <span class="pp">|</span> Annual <span class="pp">|</span></span>
<span id="cb33-1952"><a href="#cb33-1952" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Supply chain <span class="pp">|</span> Customer-supplier disclosures, trade data <span class="pp">|</span> Moderate (related-party disclosures) <span class="pp">|</span> Annual <span class="pp">|</span></span>
<span id="cb33-1953"><a href="#cb33-1953" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Correlation <span class="pp">|</span> Return data <span class="pp">|</span> Excellent (daily from exchanges) <span class="pp">|</span> Daily <span class="pp">|</span></span>
<span id="cb33-1954"><a href="#cb33-1954" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Interbank <span class="pp">|</span> Bilateral exposures <span class="pp">|</span> Limited (SBV data, banks' notes to FS) <span class="pp">|</span> Quarterly <span class="pp">|</span></span>
<span id="cb33-1955"><a href="#cb33-1955" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Co-holdings <span class="pp">|</span> Institutional holdings <span class="pp">|</span> Moderate (semi-annual disclosures) <span class="pp">|</span> Semi-annual <span class="pp">|</span></span>
<span id="cb33-1956"><a href="#cb33-1956" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Lending <span class="pp">|</span> Loan-level data <span class="pp">|</span> Limited (banking supervision data) <span class="pp">|</span> Quarterly <span class="pp">|</span></span>
<span id="cb33-1957"><a href="#cb33-1957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1958"><a href="#cb33-1958" aria-hidden="true" tabindex="-1"></a>: Financial Network Data Sources in Vietnam {#tbl-network-data}</span>
<span id="cb33-1959"><a href="#cb33-1959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1960"><a href="#cb33-1960" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises</span></span>
<span id="cb33-1961"><a href="#cb33-1961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1962"><a href="#cb33-1962" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Ownership Pyramid Depth and Tunneling.** For each listed firm, compute the depth of the longest ownership chain from the ultimate controller to the firm. Regress Tobin's $Q$ and ROA on pyramid depth, controlling for the control-cash flow wedge, firm size, industry, and listing exchange. Does deeper pyramidal ownership destroy value? Does the effect differ between state and private pyramids? Use the @claessens2002disentangling methodology.</span></span>
<span id="cb33-1963"><a href="#cb33-1963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1964"><a href="#cb33-1964" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Board Network Information Diffusion.** Construct the board interlock network for 2020-2024 and identify firms that added new interlocking directors. Using a difference-in-differences design, test whether newly interlocked firms exhibit increased return co-movement relative to a matched control group. Does the effect depend on whether the shared director is classified as independent?</span></span>
<span id="cb33-1965"><a href="#cb33-1965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1966"><a href="#cb33-1966" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Supply Chain Contagion During COVID-19.** Reconstruct the supply chain network as of December 2019. Identify firms with direct supply chain links to Chinese manufacturers. Using the onset of COVID-19 lockdowns in China (January 2020) as a shock, estimate the differential stock price decline for firms with high vs. low exposure to Chinese suppliers. Does the effect attenuate by network distance (direct supplier vs. supplier's supplier)?</span></span>
<span id="cb33-1967"><a href="#cb33-1967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1968"><a href="#cb33-1968" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Correlation Network Regime Detection.** Compute rolling 6-month correlation networks with monthly updates for 2014-2024. Apply community detection (Louvain algorithm) at each date. Track the number of communities, modularity, and the composition of the largest community over time. Do correlation regime changes (merging of previously distinct communities) precede periods of elevated market volatility? Construct a "network fragility" indicator based on decreasing modularity and test its predictive power for VN-Index drawdowns.</span></span>
<span id="cb33-1969"><a href="#cb33-1969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1970"><a href="#cb33-1970" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **GNN vs. Linear Models for Return Prediction.** Implement a rigorous horse race between: (a) Fama-MacBeth cross-sectional regression with standard characteristics, (b) the same regression augmented with hand-crafted network features (degree, betweenness, eigenvector centrality, community membership), and (c) a GCN and GAT that take the same node features plus the adjacency matrix as input. Use expanding-window time-series cross-validation with monthly rebalancing. Report out-of-sample $R^2$, information coefficient, and the Sharpe ratio of quintile-sorted long-short portfolios. Does the GNN's ability to learn features from graph structure outperform hand-crafted network features?</span></span>
<span id="cb33-1971"><a href="#cb33-1971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1972"><a href="#cb33-1972" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Dynamic Interbank Contagion Index.** Implement the rolling Diebold-Yilmaz (2014) connectedness index for the Vietnamese banking sector using quarterly data. Compute the Total Connectedness Index, directional FROM/TO measures, and net connectedness for each bank. Plot the TCI over time and identify peaks corresponding to known stress events (2011 banking consolidation, 2022 corporate bond crisis). Does a rising TCI at time $t$ predict banking sector underperformance at $t+1$?</span></span>
<span id="cb33-1973"><a href="#cb33-1973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1974"><a href="#cb33-1974" aria-hidden="true" tabindex="-1"></a><span class="co">7.  **Heterogeneous Graph Neural Network.** Construct a heterogeneous financial graph with three node types (firms, banks, directors) and four edge types (ownership, lending, board membership, supply chain). Implement a Heterogeneous GAT (HAN) that uses edge-type-specific attention. Does the heterogeneous graph outperform separate homogeneous graphs for return prediction? Which edge type receives the highest attention weight?</span></span>
<span id="cb33-1975"><a href="#cb33-1975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1976"><a href="#cb33-1976" aria-hidden="true" tabindex="-1"></a><span class="co">8.  **Node2Vec Financial Embeddings.** Apply the Node2Vec algorithm [@grover2016node2vec] to the ownership network with different hyperparameters ($p$, $q$) controlling the balance between BFS-like (local neighborhood) and DFS-like (structural role) exploration. Visualize the 128-dimensional embeddings using t-SNE, colored by industry. Do the embeddings capture industry structure? Use the embeddings as additional features in a return prediction model and compare with hand-crafted centrality features. --&gt;</span></span>
<span id="cb33-1977"><a href="#cb33-1977" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1978"><a href="#cb33-1978" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb33-1979"><a href="#cb33-1979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1980"><a href="#cb33-1980" aria-hidden="true" tabindex="-1"></a>This chapter developed the network toolkit for Vietnamese financial markets, spanning classical graph theory, domain-specific financial network construction, and modern graph neural networks.</span>
<span id="cb33-1981"><a href="#cb33-1981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1982"><a href="#cb33-1982" aria-hidden="true" tabindex="-1"></a>The central insight is that financial networks encode information invisible to standard panel regressions. Ownership networks reveal pyramidal control structures and tunneling risk that explain cross-sectional differences in firm value. Board interlocks serve as information channels through which compensation practices, investment policies, and governance norms diffuse. Supply chain networks propagate real economic shocks: the customer momentum anomaly demonstrates that market prices incorporate supply chain information with a predictable delay. Correlation networks capture co-movement structure that both reveals sector clustering and evolves across market regimes. And interbank networks determine whether individual bank failures cascade into systemic crises.</span>
<span id="cb33-1983"><a href="#cb33-1983" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1984"><a href="#cb33-1984" aria-hidden="true" tabindex="-1"></a>Vietnamese markets are particularly network-dense because of the pervasive role of state ownership, the prominence of business groups, and the concentration of the banking system. The control-cash flow wedge (i.e., the gap between control rights and cash flow rights created by pyramidal ownership) is larger and more variable than in markets with stronger minority shareholder protections. This wedge, which is computable only through network analysis of ownership chains, is both a governance risk measure and a predictor of firm value.</span>
<span id="cb33-1985"><a href="#cb33-1985" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1986"><a href="#cb33-1986" aria-hidden="true" tabindex="-1"></a>Graph neural networks extend the toolkit from hand-crafted network features to learned representations. The GCN and GAT architectures aggregate information across network neighborhoods, and the temporal GNN captures the evolution of network structure over time. For return prediction, the empirical question is whether the GNN's ability to learn flexible functions of the graph structure outperforms the simpler approach of computing centrality measures and feeding them into standard models. The exercises provide a framework for answering this question rigorously.</span>
<span id="cb33-1987"><a href="#cb33-1987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-1988"><a href="#cb33-1988" aria-hidden="true" tabindex="-1"></a>The network perspective is not a replacement for standard asset pricing or corporate finance methods; it is a complement. The most productive research designs combine network structure with identification strategies from the causal inference toolkit: using network shocks as instruments, exploiting network disruptions as natural experiments, and controlling for network position when estimating treatment effects. The intersection of networks and causal inference (e.g., network interference, peer effects identification, spatial econometrics) represents the frontier of empirical finance.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/73_networks_graphs.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>