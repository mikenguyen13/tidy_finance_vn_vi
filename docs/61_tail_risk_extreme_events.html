<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>41&nbsp; Tail Risk and Extreme Events ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./62_corporate_finance_estimators.html" rel="next">
<link href="./60_event_studies.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="41&nbsp; Tail Risk and Extreme Events ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:title" content="41&nbsp; Tail Risk and Extreme Events ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./60_event_studies.html">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</a></li><li class="breadcrumb-item"><a href="./61_tail_risk_extreme_events.html"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L·ªùi n√≥i ƒë·∫ßu</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Truy c·∫≠p v√† qu·∫£n l√Ω d·ªØ li·ªáu t√†i ch√≠nh VN</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">D·ªØ li·ªáu Datacore</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#crash-risk-in-equity-markets" id="toc-crash-risk-in-equity-markets" class="nav-link active" data-scroll-target="#crash-risk-in-equity-markets"><span class="header-section-number">41.1</span> Crash Risk in Equity Markets</a>
  <ul class="collapse">
  <li><a href="#the-left-tail-problem" id="toc-the-left-tail-problem" class="nav-link" data-scroll-target="#the-left-tail-problem"><span class="header-section-number">41.1.1</span> The Left Tail Problem</a></li>
  <li><a href="#crash-risk-measures" id="toc-crash-risk-measures" class="nav-link" data-scroll-target="#crash-risk-measures"><span class="header-section-number">41.1.2</span> Crash Risk Measures</a></li>
  <li><a href="#cross-sectional-distribution-of-crash-risk" id="toc-cross-sectional-distribution-of-crash-risk" class="nav-link" data-scroll-target="#cross-sectional-distribution-of-crash-risk"><span class="header-section-number">41.1.3</span> Cross-Sectional Distribution of Crash Risk</a></li>
  <li><a href="#interpretation-in-asset-pricing" id="toc-interpretation-in-asset-pricing" class="nav-link" data-scroll-target="#interpretation-in-asset-pricing"><span class="header-section-number">41.1.4</span> Interpretation in Asset Pricing</a></li>
  <li><a href="#downside-tail-concentration" id="toc-downside-tail-concentration" class="nav-link" data-scroll-target="#downside-tail-concentration"><span class="header-section-number">41.1.5</span> Downside Tail Concentration</a></li>
  </ul></li>
  <li><a href="#value-at-risk-and-expected-shortfall" id="toc-value-at-risk-and-expected-shortfall" class="nav-link" data-scroll-target="#value-at-risk-and-expected-shortfall"><span class="header-section-number">41.2</span> Value at Risk and Expected Shortfall</a>
  <ul class="collapse">
  <li><a href="#definitions" id="toc-definitions" class="nav-link" data-scroll-target="#definitions"><span class="header-section-number">41.2.1</span> Definitions</a></li>
  <li><a href="#why-expected-shortfall-dominates-var" id="toc-why-expected-shortfall-dominates-var" class="nav-link" data-scroll-target="#why-expected-shortfall-dominates-var"><span class="header-section-number">41.2.2</span> Why Expected Shortfall Dominates VaR</a></li>
  <li><a href="#estimation-methods" id="toc-estimation-methods" class="nav-link" data-scroll-target="#estimation-methods"><span class="header-section-number">41.2.3</span> Estimation Methods</a></li>
  <li><a href="#var-backtesting" id="toc-var-backtesting" class="nav-link" data-scroll-target="#var-backtesting"><span class="header-section-number">41.2.4</span> VaR Backtesting</a></li>
  <li><a href="#sec-limited-data" id="toc-sec-limited-data" class="nav-link" data-scroll-target="#sec-limited-data"><span class="header-section-number">41.2.5</span> Estimation Under Limited Data</a></li>
  </ul></li>
  <li><a href="#sec-evt" id="toc-sec-evt" class="nav-link" data-scroll-target="#sec-evt"><span class="header-section-number">41.3</span> Extreme Value Theory</a>
  <ul class="collapse">
  <li><a href="#motivation-what-evt-captures-that-garch-does-not" id="toc-motivation-what-evt-captures-that-garch-does-not" class="nav-link" data-scroll-target="#motivation-what-evt-captures-that-garch-does-not"><span class="header-section-number">41.3.1</span> Motivation: What EVT Captures That GARCH Does Not</a></li>
  <li><a href="#tail-index-estimation" id="toc-tail-index-estimation" class="nav-link" data-scroll-target="#tail-index-estimation"><span class="header-section-number">41.3.2</span> Tail Index Estimation</a></li>
  <li><a href="#block-maxima-and-the-gev-distribution" id="toc-block-maxima-and-the-gev-distribution" class="nav-link" data-scroll-target="#block-maxima-and-the-gev-distribution"><span class="header-section-number">41.3.3</span> Block Maxima and the GEV Distribution</a></li>
  <li><a href="#sec-gpd" id="toc-sec-gpd" class="nav-link" data-scroll-target="#sec-gpd"><span class="header-section-number">41.3.4</span> Peaks Over Threshold and the GPD</a></li>
  <li><a href="#threshold-selection" id="toc-threshold-selection" class="nav-link" data-scroll-target="#threshold-selection"><span class="header-section-number">41.3.5</span> Threshold Selection</a></li>
  <li><a href="#what-evt-captures-that-garch-does-not" id="toc-what-evt-captures-that-garch-does-not" class="nav-link" data-scroll-target="#what-evt-captures-that-garch-does-not"><span class="header-section-number">41.3.6</span> What EVT Captures That GARCH Does Not</a></li>
  </ul></li>
  <li><a href="#tail-dependence-and-contagion" id="toc-tail-dependence-and-contagion" class="nav-link" data-scroll-target="#tail-dependence-and-contagion"><span class="header-section-number">41.4</span> Tail Dependence and Contagion</a>
  <ul class="collapse">
  <li><a href="#why-correlation-breaks-down-in-crises" id="toc-why-correlation-breaks-down-in-crises" class="nav-link" data-scroll-target="#why-correlation-breaks-down-in-crises"><span class="header-section-number">41.4.1</span> Why Correlation Breaks Down in Crises</a></li>
  <li><a href="#co-crash-measures" id="toc-co-crash-measures" class="nav-link" data-scroll-target="#co-crash-measures"><span class="header-section-number">41.4.2</span> Co-Crash Measures</a></li>
  <li><a href="#system-wide-stress-transmission" id="toc-system-wide-stress-transmission" class="nav-link" data-scroll-target="#system-wide-stress-transmission"><span class="header-section-number">41.4.3</span> System-Wide Stress Transmission</a></li>
  <li><a href="#financial-contagion-mechanisms" id="toc-financial-contagion-mechanisms" class="nav-link" data-scroll-target="#financial-contagion-mechanisms"><span class="header-section-number">41.4.4</span> Financial Contagion Mechanisms</a></li>
  </ul></li>
  <li><a href="#applications-to-financial-stability" id="toc-applications-to-financial-stability" class="nav-link" data-scroll-target="#applications-to-financial-stability"><span class="header-section-number">41.5</span> Applications to Financial Stability</a>
  <ul class="collapse">
  <li><a href="#market-wide-stress-indicators" id="toc-market-wide-stress-indicators" class="nav-link" data-scroll-target="#market-wide-stress-indicators"><span class="header-section-number">41.5.1</span> Market-Wide Stress Indicators</a></li>
  <li><a href="#sectoral-fragility" id="toc-sectoral-fragility" class="nav-link" data-scroll-target="#sectoral-fragility"><span class="header-section-number">41.5.2</span> Sectoral Fragility</a></li>
  <li><a href="#crisis-diagnostics" id="toc-crisis-diagnostics" class="nav-link" data-scroll-target="#crisis-diagnostics"><span class="header-section-number">41.5.3</span> Crisis Diagnostics</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">41.6</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/61_tail_risk_extreme_events.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./60_event_studies.html">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</a></li><li class="breadcrumb-item"><a href="./61_tail_risk_extreme_events.html"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Finance is fundamentally a discipline of extremes. The central objects of concern (e.g., asset pricing, portfolio allocation, capital regulation, systemic stability) are all disproportionately shaped by rare but severe events. A portfolio manager who correctly estimates the mean and variance of returns but ignores the possibility of a <span class="math inline">\(-20\%\)</span> daily move is, in the language of <span class="citation" data-cites="taleb2010black">Taleb (<a href="references.html#ref-taleb2010black" role="doc-biblioref">2010</a>)</span>, ‚Äúpicking up pennies in front of a steamroller.‚Äù The 1997 Asian Financial Crisis, the 2008 Global Financial Crisis, and the 2020 COVID-19 crash each demonstrated that the most consequential realizations in financial markets are precisely those that conventional Gaussian models assign near-zero probability.</p>
<p>This chapter develops the statistical and econometric toolkit for measuring, modeling, and diagnosing tail risk in Vietnamese equity markets. We focus on three interconnected layers. First, at the individual stock level, we estimate crash risk measures that capture the asymmetry and thickness of the left tail of return distributions. Second, at the portfolio or regulatory level, we implement Value at Risk (VaR) and Expected Shortfall (ES) under multiple estimation approaches and evaluate their accuracy via backtesting. Third, at the system level, we apply Extreme Value Theory (EVT) and tail dependence measures to characterize joint crash behavior across sectors and assess financial contagion.</p>
<p>Vietnamese markets present a particularly rich laboratory for studying tail phenomena. Daily price limits mechanically censor the tails of observed return distributions, creating latent tail risk that is not directly observable but must be inferred. State ownership concentrations, thin liquidity, and herding behavior among retail investors amplify crash dynamics. The absence of a developed derivatives market means that tail hedging instruments familiar in more developed markets (e.g., deep out-of-the-money puts, variance swaps) are largely unavailable, making accurate tail risk measurement all the more important for risk management.</p>
<div id="setup" class="cell" data-message="false" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="crash-risk-in-equity-markets" class="level2" data-number="41.1">
<h2 data-number="41.1" class="anchored" data-anchor-id="crash-risk-in-equity-markets"><span class="header-section-number">41.1</span> Crash Risk in Equity Markets</h2>
<section id="the-left-tail-problem" class="level3" data-number="41.1.1">
<h3 data-number="41.1.1" class="anchored" data-anchor-id="the-left-tail-problem"><span class="header-section-number">41.1.1</span> The Left Tail Problem</h3>
<p>The return distribution of individual stocks and market indices is not symmetric. Decades of evidence, beginning with <span class="citation" data-cites="mandelbrot1963variation">Mandelbrot et al. (<a href="references.html#ref-mandelbrot1963variation" role="doc-biblioref">1963</a>)</span> and formalized in the asset pricing context by <span class="citation" data-cites="harvey2000conditional">Harvey and Siddique (<a href="references.html#ref-harvey2000conditional" role="doc-biblioref">2000</a>)</span>, establish that equity returns exhibit negative skewness (i.e., large negative returns occur more frequently than a Gaussian model predicts) and excess kurtosis (i.e., the tails are thicker than normal in both directions, but the left tail is of primary economic concern).</p>
<p>Let <span class="math inline">\(r_{i,t}\)</span> denote the daily log return of stock <span class="math inline">\(i\)</span> on day <span class="math inline">\(t\)</span>. The standardized third central moment (skewness) is:</p>
<p><span id="eq-skewness"><span class="math display">\[
\text{Skew}(r_i) = \frac{E\left[(r_{i,t} - \mu_i)^3\right]}{\sigma_i^3}
\tag{41.1}\]</span></span></p>
<p>Negative skewness implies that the distribution has a longer or fatter left tail relative to the right. In economic terms, negative skewness means that large losses are more likely than large gains of equal magnitude. The standardized fourth moment (excess kurtosis) is:</p>
<p><span id="eq-kurtosis"><span class="math display">\[
\text{Kurt}(r_i) = \frac{E\left[(r_{i,t} - \mu_i)^4\right]}{\sigma_i^4} - 3
\tag{41.2}\]</span></span></p>
<p>Positive excess kurtosis indicates heavier tails than the normal distribution. Both moments have direct asset pricing implications: <span class="citation" data-cites="harvey2000conditional">Harvey and Siddique (<a href="references.html#ref-harvey2000conditional" role="doc-biblioref">2000</a>)</span> and <span class="citation" data-cites="kraus1976skewness">Kraus and Litzenberger (<a href="references.html#ref-kraus1976skewness" role="doc-biblioref">1976</a>)</span> argue that investors demand compensation for holding negatively skewed assets, implying that crash-prone stocks should earn higher expected returns, ceteris paribus.</p>
</section>
<section id="crash-risk-measures" class="level3" data-number="41.1.2">
<h3 data-number="41.1.2" class="anchored" data-anchor-id="crash-risk-measures"><span class="header-section-number">41.1.2</span> Crash Risk Measures</h3>
<p>The literature has developed several firm-specific crash risk measures. We implement the three most widely used, following <span class="citation" data-cites="chen2001forecasting">Chen, Hong, and Stein (<a href="references.html#ref-chen2001forecasting" role="doc-biblioref">2001</a>)</span> and <span class="citation" data-cites="hutton2009opaque">Hutton, Marcus, and Tehranian (<a href="references.html#ref-hutton2009opaque" role="doc-biblioref">2009</a>)</span>.</p>
<p><strong>Measure 1: Negative Coefficient of Skewness (NCSKEW)</strong></p>
<p>For each firm <span class="math inline">\(i\)</span> in fiscal year <span class="math inline">\(y\)</span>, compute firm-specific weekly returns <span class="math inline">\(W_{i,\tau}\)</span> as residuals from a market model augmented with lead and lag market returns to account for nonsynchronous trading:</p>
<p><span id="eq-crash-model"><span class="math display">\[
r_{i,t} = \alpha_i + \beta_{1i} r_{m,t-1} + \beta_{2i} r_{m,t} + \beta_{3i} r_{m,t+1} + \varepsilon_{i,t}
\tag{41.3}\]</span></span></p>
<p>where <span class="math inline">\(r_{m,t}\)</span> is the value-weighted market return on day <span class="math inline">\(t\)</span>. The firm-specific weekly return is <span class="math inline">\(W_{i,\tau} = \ln(1 + \sum_{t \in \tau} \hat{\varepsilon}_{i,t})\)</span>, where <span class="math inline">\(\tau\)</span> indexes weeks. NCSKEW is then:</p>
<p><span id="eq-ncskew"><span class="math display">\[
\text{NCSKEW}_{i,y} = -\frac{n(n-1)^{3/2} \sum W_{i,\tau}^3}{(n-1)(n-2)\left(\sum W_{i,\tau}^2\right)^{3/2}}
\tag{41.4}\]</span></span></p>
<p>where <span class="math inline">\(n\)</span> is the number of firm-specific weekly returns in the year. The negative sign ensures that higher NCSKEW corresponds to greater crash risk.</p>
<p><strong>Measure 2: Down-to-Up Volatility (DUVOL)</strong></p>
<p>Partition the firm-specific weekly returns into ‚Äúdown weeks‚Äù (<span class="math inline">\(W_{i,\tau} &lt; \bar{W}_i\)</span>) and ‚Äúup weeks‚Äù (<span class="math inline">\(W_{i,\tau} \geq \bar{W}_i\)</span>), where <span class="math inline">\(\bar{W}_i\)</span> is the annual mean. Then:</p>
<p><span id="eq-duvol"><span class="math display">\[
\text{DUVOL}_{i,y} = \ln\left(\frac{(n_u - 1)\sum_{\text{down}} W_{i,\tau}^2}{(n_d - 1)\sum_{\text{up}} W_{i,\tau}^2}\right)
\tag{41.5}\]</span></span></p>
<p>where <span class="math inline">\(n_u\)</span> and <span class="math inline">\(n_d\)</span> are the number of up and down weeks, respectively. Higher DUVOL indicates greater crash risk. <span class="citation" data-cites="chen2001forecasting">Chen, Hong, and Stein (<a href="references.html#ref-chen2001forecasting" role="doc-biblioref">2001</a>)</span> argue that DUVOL is less sensitive to outliers than NCSKEW because it does not involve the cube of returns.</p>
<p><strong>Measure 3: Crash Count (COUNT)</strong></p>
<p>Define a crash event as a firm-specific weekly return that falls below <span class="math inline">\(k\)</span> standard deviations of its annual distribution:</p>
<p><span id="eq-crash-event"><span class="math display">\[
\text{CRASH}_{i,\tau} = \mathbb{1}\left(W_{i,\tau} &lt; \bar{W}_i - k \cdot \hat{\sigma}_{W_i}\right)
\tag{41.6}\]</span></span></p>
<p>The standard threshold in the literature is <span class="math inline">\(k = 3.09\)</span>, corresponding to the 0.1% tail of a standard normal distribution. The crash count for year <span class="math inline">\(y\)</span> is <span class="math inline">\(\text{COUNT}_{i,y} = \sum_{\tau \in y} \text{CRASH}_{i,\tau}\)</span>.</p>
<div id="load-data" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily stock returns and market returns</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Market return: value-weighted index</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> daily_returns.merge(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Universe: </span><span class="sc">{</span>df[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> firms, "</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> trading days"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="firm-specific-returns" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_firm_specific_returns(group):</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate firm-specific daily returns from augmented market model</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    with lead and lag market returns (Chen, Hong, Stein 2001).</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> group.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"mkt_lag1"</span>] <span class="op">=</span> g[<span class="st">"mkt_ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"mkt_lead1"</span>] <span class="op">=</span> g[<span class="st">"mkt_ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> g.dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>, <span class="st">"mkt_lag1"</span>, <span class="st">"mkt_lead1"</span>])</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(g) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> g[[<span class="st">"mkt_lag1"</span>, <span class="st">"mkt_ret"</span>, <span class="st">"mkt_lead1"</span>]].values</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> g[<span class="st">"ret"</span>].values</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"resid"</span>] <span class="op">=</span> y <span class="op">-</span> model.predict(X)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> g[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"resid"</span>]]</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by firm-year</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"year"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>firm_resids <span class="op">=</span> (</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>], group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_firm_specific_returns)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="weekly-aggregation" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily residuals to weekly firm-specific returns</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(firm_resids[<span class="st">"date"</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"week"</span>] <span class="op">=</span> firm_resids[<span class="st">"date"</span>].dt.isocalendar().week.astype(<span class="bu">int</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"year"</span>] <span class="op">=</span> firm_resids[<span class="st">"date"</span>].dt.year</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>weekly_returns <span class="op">=</span> (</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    firm_resids.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>])</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    .agg(W<span class="op">=</span>(<span class="st">"resid"</span>, <span class="kw">lambda</span> x: np.log(<span class="dv">1</span> <span class="op">+</span> x.<span class="bu">sum</span>())))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="crash-risk-measures" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_crash_measures(group):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute NCSKEW, DUVOL, and CRASH count for one firm-year."""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> group[<span class="st">"W"</span>].values</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(W)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">26</span>:  <span class="co"># Require at least 26 weeks</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ncskew"</span>: np.nan, <span class="st">"duvol"</span>: np.nan,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"crash_count"</span>: np.nan, <span class="st">"n_weeks"</span>: n</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NCSKEW</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    W_demean <span class="op">=</span> W <span class="op">-</span> W.mean()</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    num <span class="op">=</span> n <span class="op">*</span> (n <span class="op">-</span> <span class="dv">1</span>)<span class="op">**</span><span class="fl">1.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(W_demean<span class="op">**</span><span class="dv">3</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    den <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">*</span> (np.<span class="bu">sum</span>(W_demean<span class="op">**</span><span class="dv">2</span>))<span class="op">**</span><span class="fl">1.5</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    ncskew <span class="op">=</span> <span class="op">-</span>(num <span class="op">/</span> den) <span class="cf">if</span> den <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DUVOL</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    mean_W <span class="op">=</span> W.mean()</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    down <span class="op">=</span> W[W <span class="op">&lt;</span> mean_W]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    up <span class="op">=</span> W[W <span class="op">&gt;=</span> mean_W]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    n_d, n_u <span class="op">=</span> <span class="bu">len</span>(down), <span class="bu">len</span>(up)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_d <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">and</span> n_u <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        duvol <span class="op">=</span> np.log(</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            ((n_u <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.<span class="bu">sum</span>(down<span class="op">**</span><span class="dv">2</span>)) <span class="op">/</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            ((n_d <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.<span class="bu">sum</span>(up<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        duvol <span class="op">=</span> np.nan</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crash count (k = 3.09)</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> W.mean() <span class="op">-</span> <span class="fl">3.09</span> <span class="op">*</span> W.std()</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    crash_count <span class="op">=</span> <span class="bu">int</span>(np.<span class="bu">sum</span>(W <span class="op">&lt;</span> threshold))</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ncskew"</span>: ncskew,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"duvol"</span>: duvol,</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"crash_count"</span>: crash_count,</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_weeks"</span>: n</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>crash_risk <span class="op">=</span> (</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    weekly_returns.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_crash_measures)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>crash_risk <span class="op">=</span> crash_risk.dropna(subset<span class="op">=</span>[<span class="st">"ncskew"</span>, <span class="st">"duvol"</span>])</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Crash risk panel: </span><span class="sc">{</span><span class="bu">len</span>(crash_risk)<span class="sc">}</span><span class="ss"> firm-years"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="cross-sectional-distribution-of-crash-risk" class="level3" data-number="41.1.3">
<h3 data-number="41.1.3" class="anchored" data-anchor-id="cross-sectional-distribution-of-crash-risk"><span class="header-section-number">41.1.3</span> Cross-Sectional Distribution of Crash Risk</h3>
<p><a href="#tbl-crash-summary" class="quarto-xref">Table&nbsp;<span>41.1</span></a> presents summary statistics for the three crash risk measures across the Vietnamese equity market.</p>
<div id="tbl-crash-summary" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="7">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-crash-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.1: Summary Statistics of Crash Risk Measures
</figcaption>
<div aria-describedby="tbl-crash-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> crash_risk[[<span class="st">"ncskew"</span>, <span class="st">"duvol"</span>, <span class="st">"crash_count"</span>]].describe(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>).T.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>summary.columns <span class="op">=</span> [<span class="st">"N"</span>, <span class="st">"Mean"</span>, <span class="st">"Std"</span>, <span class="st">"Min"</span>, <span class="st">"5%"</span>, <span class="st">"25%"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Median"</span>, <span class="st">"75%"</span>, <span class="st">"95%"</span>, <span class="st">"Max"</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<div id="fig-ncskew-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ncskew-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> crash_risk[crash_risk[<span class="st">"year"</span>].between(<span class="dv">2012</span>, <span class="dv">2024</span>)].copy()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_data, p9.aes(x<span class="op">=</span><span class="st">"ncskew"</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.facet_wrap(<span class="st">"~year"</span>, scales<span class="op">=</span><span class="st">"free_y"</span>, ncol<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"NCSKEW"</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Firm-Level Crash Risk (NCSKEW)"</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-ncskew-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.1
</figcaption>
</figure>
</div>
<p>The rightward shift of the NCSKEW distribution during crisis episodes, particularly in 2020 and 2022, indicates a market-wide increase in crash risk. The red dashed line at zero separates firms with negative skewness (right of zero, i.e., high NCSKEW since the measure is negated) from those with positive skewness.</p>
</section>
<section id="interpretation-in-asset-pricing" class="level3" data-number="41.1.4">
<h3 data-number="41.1.4" class="anchored" data-anchor-id="interpretation-in-asset-pricing"><span class="header-section-number">41.1.4</span> Interpretation in Asset Pricing</h3>
<p>Crash risk has first-order implications for asset pricing. <span class="citation" data-cites="harvey2000conditional">Harvey and Siddique (<a href="references.html#ref-harvey2000conditional" role="doc-biblioref">2000</a>)</span> demonstrate that coskewness (i.e., the contribution of an individual asset to the skewness of the aggregate market portfolio) is priced in the cross-section of expected returns. Specifically, assets that tend to crash when the market crashes (negative coskewness) should command a risk premium.</p>
<p>The coskewness of stock <span class="math inline">\(i\)</span> with the market is:</p>
<p><span id="eq-coskewness"><span class="math display">\[
\text{CoSkew}_i = \frac{E\left[(r_i - \mu_i)(r_m - \mu_m)^2\right]}{\sigma_i \cdot \sigma_m^2}
\tag{41.7}\]</span></span></p>
<p>Stocks with more negative coskewness exhibit disproportionately poor performance during market downturns. In Vietnam, this is especially relevant because: (1) retail investor herding amplifies co-movement during selloffs; (2) price limits delay crash completion, spreading crash risk across multiple days; and (3) state-owned enterprises, which constitute a large fraction of market capitalization, may exhibit coordinated crash behavior driven by common policy shocks.</p>
<div id="coskewness-estimation" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_coskewness(group):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate coskewness for a firm-year."""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    r_i <span class="op">=</span> group[<span class="st">"ret"</span>].values</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    r_m <span class="op">=</span> group[<span class="st">"mkt_ret"</span>].values</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(r_i) <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    r_i_dm <span class="op">=</span> r_i <span class="op">-</span> r_i.mean()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    r_m_dm <span class="op">=</span> r_m <span class="op">-</span> r_m.mean()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    coskew <span class="op">=</span> (</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        np.mean(r_i_dm <span class="op">*</span> r_m_dm<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        (np.std(r_i) <span class="op">*</span> np.std(r_m)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coskew</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>df_coskew <span class="op">=</span> (</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({<span class="st">"coskewness"</span>: compute_coskewness(g)}))</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-coskew-time" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-coskew-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>median_coskew <span class="op">=</span> (</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    df_coskew.groupby(<span class="st">"year"</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        median_coskew<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="st">"median"</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        q25<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>)),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        q75<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>))</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(median_coskew, p9.aes(x<span class="op">=</span><span class="st">"year"</span>))</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"q25"</span>, ymax<span class="op">=</span><span class="st">"q75"</span>),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(p9.aes(y<span class="op">=</span><span class="st">"median_coskew"</span>), color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Coskewness"</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Coskewness: Median and Interquartile Range"</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-coskew-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.2
</figcaption>
</figure>
</div>
</section>
<section id="downside-tail-concentration" class="level3" data-number="41.1.5">
<h3 data-number="41.1.5" class="anchored" data-anchor-id="downside-tail-concentration"><span class="header-section-number">41.1.5</span> Downside Tail Concentration</h3>
<p>Beyond skewness, the concentration of returns in the extreme left tail provides additional diagnostic information. We define the downside tail concentration ratio as the fraction of total return variance attributable to observations below the <span class="math inline">\(p\)</span>-th percentile:</p>
<p><span id="eq-tail-concentration"><span class="math display">\[
\text{TCR}_p = \frac{\sum_{r_{i,t} &lt; q_p} (r_{i,t} - \bar{r}_i)^2}{\sum_t (r_{i,t} - \bar{r}_i)^2}
\tag{41.8}\]</span></span></p>
<p>where <span class="math inline">\(q_p\)</span> is the <span class="math inline">\(p\)</span>-th percentile of the firm‚Äôs return distribution. Under a symmetric distribution, <span class="math inline">\(\text{TCR}_{5\%}\)</span> would be close to <span class="math inline">\(5\%\)</span> (with a slight upward bias due to the squaring). Values substantially exceeding <span class="math inline">\(5\%\)</span> indicate that the left tail contributes disproportionately to total risk.</p>
<div id="tail-concentration" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tail_concentration_ratio(returns, p<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute tail concentration ratio at percentile p."""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> np.quantile(returns, p)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    r_dm <span class="op">=</span> returns <span class="op">-</span> returns.mean()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    total_var <span class="op">=</span> np.<span class="bu">sum</span>(r_dm<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    tail_var <span class="op">=</span> np.<span class="bu">sum</span>(r_dm[returns <span class="op">&lt;</span> q]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tail_var <span class="op">/</span> total_var <span class="cf">if</span> total_var <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> (</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        tcr_5<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: tail_concentration_ratio(x.values, <span class="fl">0.05</span>)),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        tcr_1<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: tail_concentration_ratio(x.values, <span class="fl">0.01</span>)),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        n_obs<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"count"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n_obs &gt;= 120"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Median TCR(5%):"</span>, <span class="bu">round</span>(tcr[<span class="st">"tcr_5"</span>].median(), <span class="dv">4</span>))</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Median TCR(1%):"</span>, <span class="bu">round</span>(tcr[<span class="st">"tcr_1"</span>].median(), <span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="value-at-risk-and-expected-shortfall" class="level2" data-number="41.2">
<h2 data-number="41.2" class="anchored" data-anchor-id="value-at-risk-and-expected-shortfall"><span class="header-section-number">41.2</span> Value at Risk and Expected Shortfall</h2>
<section id="definitions" class="level3" data-number="41.2.1">
<h3 data-number="41.2.1" class="anchored" data-anchor-id="definitions"><span class="header-section-number">41.2.1</span> Definitions</h3>
<p>Value at Risk (VaR) and Expected Shortfall (ES) are the two principal quantile-based risk measures used in financial regulation and internal risk management. For a portfolio return <span class="math inline">\(r\)</span> with the cumulative distribution function <span class="math inline">\(F\)</span>, the VaR at confidence level <span class="math inline">\(\alpha\)</span> is:</p>
<p><span id="eq-var-def"><span class="math display">\[
\text{VaR}_\alpha = -F^{-1}(\alpha) = -\inf\{x : F(x) \geq \alpha\}
\tag{41.9}\]</span></span></p>
<p>This is simply the negative of the <span class="math inline">\(\alpha\)</span>-quantile of the return distribution. For <span class="math inline">\(\alpha = 0.01\)</span>, <span class="math inline">\(\text{VaR}_{1\%}\)</span> answers: ‚ÄúWhat is the loss that is exceeded with only 1% probability?‚Äù</p>
<p>Expected Shortfall (also called Conditional VaR or CVaR) is the expected loss conditional on the loss exceeding VaR:</p>
<p><span id="eq-es-def"><span class="math display">\[
\text{ES}_\alpha = -\frac{1}{\alpha}\int_0^\alpha F^{-1}(u) \, du = -E\left[r \mid r \leq -\text{VaR}_\alpha\right]
\tag{41.10}\]</span></span></p>
<p>For continuous distributions, ES simplifies to the conditional expectation in <a href="#eq-es-def" class="quarto-xref">Equation&nbsp;<span>41.10</span></a>. ES is always at least as large as VaR (<span class="math inline">\(\text{ES}_\alpha \geq \text{VaR}_\alpha\)</span>) and is strictly larger whenever the distribution has any mass beyond the VaR quantile.</p>
</section>
<section id="why-expected-shortfall-dominates-var" class="level3" data-number="41.2.2">
<h3 data-number="41.2.2" class="anchored" data-anchor-id="why-expected-shortfall-dominates-var"><span class="header-section-number">41.2.2</span> Why Expected Shortfall Dominates VaR</h3>
<p><a href="#tbl-tail-riskvar-vs-es" class="quarto-xref">Table&nbsp;<span>41.2</span></a> summarizes the fundamental differences.</p>
<div id="tbl-tail-riskvar-vs-es" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tail-riskvar-vs-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.2: Comparison of VaR and Expected Shortfall
</figcaption>
<div aria-describedby="tbl-tail-riskvar-vs-es-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 26%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>Property</th>
<th>VaR</th>
<th>Expected Shortfall</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Definition</td>
<td>Quantile of the loss distribution</td>
<td>Conditional mean loss beyond VaR</td>
</tr>
<tr class="even">
<td>Tail information</td>
<td>None beyond the quantile</td>
<td>Captures severity of tail losses</td>
</tr>
<tr class="odd">
<td>Subadditivity</td>
<td>Not subadditive in general</td>
<td>Subadditive (coherent risk measure)</td>
</tr>
<tr class="even">
<td>Regulatory status</td>
<td>Basel II primary measure</td>
<td>Basel III/IV primary measure</td>
</tr>
<tr class="odd">
<td>Backtesting</td>
<td>Binary: breach or no breach</td>
<td>Continuous: requires severity assessment</td>
</tr>
<tr class="even">
<td>Sensitivity to tail shape</td>
<td>None</td>
<td>Directly sensitive</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The critical deficiency of VaR is the absence of subadditivity. A risk measure <span class="math inline">\(\rho\)</span> is subadditive if <span class="math inline">\(\rho(X + Y) \leq \rho(X) + \rho(Y)\)</span> for all portfolios <span class="math inline">\(X, Y\)</span>. VaR violates this condition for non-elliptical distributions, meaning that diversification can appear to increase risk under VaR, which is a perverse result. <span class="citation" data-cites="artzner1999coherent">Artzner et al. (<a href="references.html#ref-artzner1999coherent" role="doc-biblioref">1999</a>)</span> established the axiomatic framework for coherent risk measures, and ES satisfies all four axioms: monotonicity, translation invariance, positive homogeneity, and subadditivity. VaR satisfies only three.</p>
</section>
<section id="estimation-methods" class="level3" data-number="41.2.3">
<h3 data-number="41.2.3" class="anchored" data-anchor-id="estimation-methods"><span class="header-section-number">41.2.3</span> Estimation Methods</h3>
<p>We implement four approaches to VaR and ES estimation, each with distinct assumptions and data requirements.</p>
<p><strong>Method 1: Historical Simulation</strong></p>
<p>The simplest nonparametric approach uses the empirical distribution directly:</p>
<p><span id="eq-var-hs"><span class="math display">\[
\widehat{\text{VaR}}_\alpha^{\text{HS}} = -\hat{F}_n^{-1}(\alpha) = -r_{(\lceil n\alpha \rceil)}
\tag{41.11}\]</span></span></p>
<p>where <span class="math inline">\(r_{(k)}\)</span> is the <span class="math inline">\(k\)</span>-th order statistic of the return sample. ES is the average of all returns below the VaR:</p>
<p><span id="eq-es-hs"><span class="math display">\[
\widehat{\text{ES}}_\alpha^{\text{HS}} = -\frac{1}{\lfloor n\alpha \rfloor}\sum_{k=1}^{\lfloor n\alpha \rfloor} r_{(k)}
\tag{41.12}\]</span></span></p>
<p><strong>Method 2: Parametric (Gaussian)</strong></p>
<p>Assume <span class="math inline">\(r_t \sim N(\mu, \sigma^2)\)</span>. Then:</p>
<p><span id="eq-var-gauss"><span class="math display">\[
\text{VaR}_\alpha^{\text{Gauss}} = -(\hat{\mu} + \hat{\sigma} \cdot \Phi^{-1}(\alpha))
\tag{41.13}\]</span></span></p>
<p><span id="eq-es-gauss"><span class="math display">\[
\text{ES}_\alpha^{\text{Gauss}} = -\hat{\mu} + \hat{\sigma} \cdot \frac{\phi(\Phi^{-1}(\alpha))}{\alpha}
\tag{41.14}\]</span></span></p>
<p>where <span class="math inline">\(\Phi\)</span> and <span class="math inline">\(\phi\)</span> are the standard normal CDF and PDF, respectively. The Gaussian assumption is known to underestimate tail risk for equity returns, but provides a useful baseline.</p>
<p><strong>Method 3: Parametric (Student-</strong><span class="math inline">\(t\)</span>)</p>
<p>The Student-<span class="math inline">\(t\)</span> distribution with <span class="math inline">\(\nu\)</span> degrees of freedom captures excess kurtosis. The VaR and ES are:</p>
<p><span id="eq-var-t"><span class="math display">\[
\text{VaR}_\alpha^{t} = -\left(\hat{\mu} + \hat{\sigma}\sqrt{\frac{\nu - 2}{\nu}} \cdot t_\nu^{-1}(\alpha)\right)
\tag{41.15}\]</span></span></p>
<p><span id="eq-es-t"><span class="math display">\[
\text{ES}_\alpha^{t} = -\hat{\mu} + \hat{\sigma}\sqrt{\frac{\nu-2}{\nu}} \cdot \frac{f_{t_\nu}(t_\nu^{-1}(\alpha))}{\alpha} \cdot \frac{\nu + (t_\nu^{-1}(\alpha))^2}{\nu - 1}
\tag{41.16}\]</span></span></p>
<p>where <span class="math inline">\(t_\nu^{-1}\)</span> and <span class="math inline">\(f_{t_\nu}\)</span> are the quantile function and PDF of the Student-<span class="math inline">\(t\)</span> distribution.</p>
<p><strong>Method 4: GARCH-Filtered EVT (Semi-Parametric)</strong></p>
<p>This approach, developed by <span class="citation" data-cites="mcneil2000estimation">McNeil and Frey (<a href="references.html#ref-mcneil2000estimation" role="doc-biblioref">2000</a>)</span>, first filters returns through a GARCH(1,1) model to obtain standardized residuals <span class="math inline">\(z_t = \hat{\varepsilon}_t / \hat{\sigma}_t\)</span>, then fits a Generalized Pareto Distribution (GPD) to the lower tail of the standardized residuals. We detail the EVT component in <a href="#sec-evt" class="quarto-xref"><span>Section 41.3</span></a>.</p>
<div id="var-es-estimation" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_var_es(returns, alpha<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate VaR and ES at level alpha using four methods.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : array-like</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Return series.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Tail probability (e.g., 0.01 for 1%).</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : VaR and ES estimates for each method.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> np.array(returns)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> r[<span class="op">~</span>np.isnan(r)]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(r)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    mu, sigma <span class="op">=</span> r.mean(), r.std(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Historical simulation</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    sorted_r <span class="op">=</span> np.sort(r)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="bu">int</span>(np.ceil(n <span class="op">*</span> alpha))</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"var_hs"</span>] <span class="op">=</span> <span class="op">-</span>sorted_r[idx <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"es_hs"</span>] <span class="op">=</span> <span class="op">-</span>sorted_r[:idx].mean()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Gaussian</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    z_alpha <span class="op">=</span> stats.norm.ppf(alpha)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"var_gauss"</span>] <span class="op">=</span> <span class="op">-</span>(mu <span class="op">+</span> sigma <span class="op">*</span> z_alpha)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"es_gauss"</span>] <span class="op">=</span> <span class="op">-</span>mu <span class="op">+</span> sigma <span class="op">*</span> stats.norm.pdf(z_alpha) <span class="op">/</span> alpha</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 3: Student-t (MLE for degrees of freedom)</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        nu, loc, scale <span class="op">=</span> stats.t.fit(r)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        t_alpha <span class="op">=</span> stats.t.ppf(alpha, df<span class="op">=</span>nu)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"var_t"</span>] <span class="op">=</span> <span class="op">-</span>(loc <span class="op">+</span> scale <span class="op">*</span> t_alpha)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"es_t"</span>] <span class="op">=</span> (</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>loc <span class="op">+</span> scale <span class="op">*</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>            (stats.t.pdf(t_alpha, df<span class="op">=</span>nu) <span class="op">/</span> alpha) <span class="op">*</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>            ((nu <span class="op">+</span> t_alpha<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (nu <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"nu_hat"</span>] <span class="op">=</span> nu</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"var_t"</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"es_t"</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"nu_hat"</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="market-var-es" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute VaR and ES for the aggregate market index</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>market_daily <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 1-year VaR/ES</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>window <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>results_list <span class="op">=</span> []</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> end_idx <span class="kw">in</span> <span class="bu">range</span>(window, <span class="bu">len</span>(market_daily)):</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    window_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].iloc[end_idx <span class="op">-</span> window:end_idx].values</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> market_daily[<span class="st">"date"</span>].iloc[end_idx]</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    est <span class="op">=</span> estimate_var_es(window_returns, alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    est[<span class="st">"date"</span>] <span class="op">=</span> date</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    results_list.append(est)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>var_es_ts <span class="op">=</span> pd.DataFrame(results_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-var-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="14">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-var-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>plot_var <span class="op">=</span> var_es_ts.melt(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"var_hs"</span>, <span class="st">"var_gauss"</span>, <span class="st">"var_t"</span>],</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">"method"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"var"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>method_labels <span class="op">=</span> {</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_hs"</span>: <span class="st">"Historical Simulation"</span>,</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_gauss"</span>: <span class="st">"Gaussian"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_t"</span>: <span class="st">"Student-t"</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>plot_var[<span class="st">"method"</span>] <span class="op">=</span> plot_var[<span class="st">"method"</span>].<span class="bu">map</span>(method_labels)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_var, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"var"</span>, color<span class="op">=</span><span class="st">"method"</span>))</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"1% VaR (Loss)"</span>,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling 252-Day Value at Risk Estimates"</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Method"</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-var-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.3
</figcaption>
</figure>
</div>
<div id="fig-es-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="15">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-es-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>plot_es <span class="op">=</span> var_es_ts.melt(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"es_hs"</span>, <span class="st">"es_gauss"</span>, <span class="st">"es_t"</span>],</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">"method"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"es"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>method_labels_es <span class="op">=</span> {</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_hs"</span>: <span class="st">"Historical Simulation"</span>,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_gauss"</span>: <span class="st">"Gaussian"</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_t"</span>: <span class="st">"Student-t"</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>plot_es[<span class="st">"method"</span>] <span class="op">=</span> plot_es[<span class="st">"method"</span>].<span class="bu">map</span>(method_labels_es)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_es, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"es"</span>, color<span class="op">=</span><span class="st">"method"</span>))</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"1</span><span class="sc">% E</span><span class="st">S (Loss)"</span>,</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling 252-Day Expected Shortfall Estimates"</span>,</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Method"</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>]</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-es-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.4
</figcaption>
</figure>
</div>
</section>
<section id="var-backtesting" class="level3" data-number="41.2.4">
<h3 data-number="41.2.4" class="anchored" data-anchor-id="var-backtesting"><span class="header-section-number">41.2.4</span> VaR Backtesting</h3>
<p>A VaR model is only useful if its predictions are accurate. Backtesting evaluates whether the realized frequency of VaR breaches is consistent with the nominal confidence level. If VaR is estimated at the <span class="math inline">\(\alpha = 1\%\)</span> level, we expect approximately 1% of days to exhibit losses exceeding VaR.</p>
<p>The Kupiec unconditional coverage test <span class="citation" data-cites="kupiec1995techniques">(<a href="references.html#ref-kupiec1995techniques" role="doc-biblioref">Kupiec et al. 1995</a>)</span> evaluates whether the total number of breaches <span class="math inline">\(x\)</span> in <span class="math inline">\(n\)</span> observations is consistent with <span class="math inline">\(\alpha\)</span>:</p>
<p><span id="eq-kupiec"><span class="math display">\[
\text{LR}_{\text{UC}} = -2\ln\left(\frac{\alpha^x (1-\alpha)^{n-x}}{\hat{p}^x (1-\hat{p})^{n-x}}\right) \sim \chi^2(1)
\tag{41.17}\]</span></span></p>
<p>where <span class="math inline">\(\hat{p} = x/n\)</span> is the empirical breach frequency. The Christoffersen conditional coverage test <span class="citation" data-cites="christoffersen1998evaluating">(<a href="references.html#ref-christoffersen1998evaluating" role="doc-biblioref">Christoffersen 1998</a>)</span> additionally evaluates whether breaches are independent (no clustering):</p>
<p><span id="eq-christoffersen"><span class="math display">\[
\text{LR}_{\text{CC}} = \text{LR}_{\text{UC}} + \text{LR}_{\text{IND}}
\tag{41.18}\]</span></span></p>
<p>where <span class="math inline">\(\text{LR}_{\text{IND}}\)</span> tests the null of independence using a first-order Markov chain model for breach indicators.</p>
<div id="backtesting" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kupiec_test(returns, var_estimates, alpha<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Kupiec unconditional coverage test for VaR backtesting.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : breach count, expected, breach rate, LR statistic, p-value.</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    breaches <span class="op">=</span> returns <span class="op">&lt;</span> <span class="op">-</span>var_estimates</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> breaches.<span class="bu">sum</span>()</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(returns)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    p_hat <span class="op">=</span> x <span class="op">/</span> n</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p_hat <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p_hat <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"breaches"</span>: x, <span class="st">"expected"</span>: n <span class="op">*</span> alpha,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">"breach_rate"</span>: p_hat, <span class="st">"lr_stat"</span>: np.nan, <span class="st">"p_value"</span>: np.nan}</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> (</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>        x <span class="op">*</span> np.log(alpha) <span class="op">+</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> x <span class="op">*</span> np.log(p_hat) <span class="op">-</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p_hat)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.chi2.cdf(lr, df<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"breaches"</span>: <span class="bu">int</span>(x),</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: <span class="bu">round</span>(n <span class="op">*</span> alpha, <span class="dv">1</span>),</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"breach_rate"</span>: <span class="bu">round</span>(p_hat, <span class="dv">4</span>),</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lr_stat"</span>: <span class="bu">round</span>(lr, <span class="dv">4</span>),</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p_value"</span>: <span class="bu">round</span>(p_value, <span class="dv">4</span>)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Backtest each method</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>actual_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].iloc[window:].values</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>backtest_results <span class="op">=</span> {}</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method, col <span class="kw">in</span> [(<span class="st">"Historical"</span>, <span class="st">"var_hs"</span>),</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">"Gaussian"</span>, <span class="st">"var_gauss"</span>),</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">"Student-t"</span>, <span class="st">"var_t"</span>)]:</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    backtest_results[method] <span class="op">=</span> kupiec_test(</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        actual_returns, var_es_ts[col].values, alpha<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>bt_df <span class="op">=</span> pd.DataFrame(backtest_results).T</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>bt_df.index.name <span class="op">=</span> <span class="st">"Method"</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>bt_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-limited-data" class="level3" data-number="41.2.5">
<h3 data-number="41.2.5" class="anchored" data-anchor-id="sec-limited-data"><span class="header-section-number">41.2.5</span> Estimation Under Limited Data</h3>
<p>In Vietnamese equity markets, many stocks have short trading histories, thin liquidity, and censored returns due to price limits. These features create challenges for tail risk estimation that are less severe in developed markets.</p>
<p><strong>Price limit censoring.</strong> When a stock hits its daily price limit, the observed return is truncated. The true latent return may extend well beyond the limit, but is unobservable. This means that historical simulation mechanically understates VaR and ES for stocks that frequently hit limits. A Tobit-type correction can partially address this:</p>
<p><span id="eq-tobit-var"><span class="math display">\[
r_{i,t}^{\text{latent}} \sim N(\mu_i, \sigma_i^2), \quad r_{i,t}^{\text{obs}} = \max(\underline{L}, \min(\bar{L}, r_{i,t}^{\text{latent}}))
\tag{41.19}\]</span></span></p>
<p>The parameters <span class="math inline">\((\mu_i, \sigma_i^2)\)</span> can be estimated via maximum likelihood on the censored sample, and VaR/ES can then be computed from the estimated latent distribution.</p>
<p><strong>Short histories.</strong> For recently listed stocks, the available sample may be too short for reliable nonparametric estimation. In these cases, shrinkage toward a cross-sectional prior (e.g., the sector median VaR) or Bayesian approaches with informative priors can improve stability.</p>
</section>
</section>
<section id="sec-evt" class="level2" data-number="41.3">
<h2 data-number="41.3" class="anchored" data-anchor-id="sec-evt"><span class="header-section-number">41.3</span> Extreme Value Theory</h2>
<section id="motivation-what-evt-captures-that-garch-does-not" class="level3" data-number="41.3.1">
<h3 data-number="41.3.1" class="anchored" data-anchor-id="motivation-what-evt-captures-that-garch-does-not"><span class="header-section-number">41.3.1</span> Motivation: What EVT Captures That GARCH Does Not</h3>
<p>GARCH models capture volatility clustering (i.e., the tendency of large returns to be followed by large returns), but they make specific distributional assumptions about standardized residuals (typically Gaussian or Student-<span class="math inline">\(t\)</span>). The tail behavior of the conditional distribution is thus determined by the parametric innovation assumption, not learned from the data.</p>
<p>Extreme Value Theory (EVT) takes a fundamentally different approach. It provides a statistical framework for estimating the distribution of extreme observations without specifying the entire return distribution. The key theoretical results (i.e., the Fisher-Tippett-Gnedenko theorem and the Pickands-Balkema-de Haan theorem) establish that the distribution of properly normalized maxima (or exceedances over high thresholds) converges to specific parametric families regardless of the parent distribution. This universality is what makes EVT powerful: the tail can be estimated even when the center of the distribution is misspecified.</p>
</section>
<section id="tail-index-estimation" class="level3" data-number="41.3.2">
<h3 data-number="41.3.2" class="anchored" data-anchor-id="tail-index-estimation"><span class="header-section-number">41.3.2</span> Tail Index Estimation</h3>
<p>The tail index <span class="math inline">\(\xi\)</span> (also denoted <span class="math inline">\(\alpha^{-1}\)</span> in some formulations) governs the rate of tail decay. For heavy-tailed distributions, the survival function satisfies:</p>
<p><span id="eq-tail-decay"><span class="math display">\[
P(X &gt; x) \sim L(x) \cdot x^{-1/\xi}, \quad x \to \infty
\tag{41.20}\]</span></span></p>
<p>where <span class="math inline">\(L(x)\)</span> is a slowly varying function. The tail index <span class="math inline">\(\xi &gt; 0\)</span> implies a Pareto-type tail; larger <span class="math inline">\(\xi\)</span> means heavier tails. Financial return distributions typically have <span class="math inline">\(\xi \in (0.2, 0.5)\)</span>, corresponding to tail indices <span class="math inline">\(\alpha = 1/\xi \in (2, 5)\)</span>, which implies finite variance but potentially infinite higher moments.</p>
<p>The Hill estimator <span class="citation" data-cites="hill1975simple">(<a href="references.html#ref-hill1975simple" role="doc-biblioref">Hill 1975</a>)</span> provides a simple nonparametric estimate of <span class="math inline">\(\xi\)</span> from the upper order statistics:</p>
<p><span id="eq-hill"><span class="math display">\[
\hat{\xi}_{\text{Hill}}(k) = \frac{1}{k}\sum_{j=1}^{k} \ln X_{(n-j+1)} - \ln X_{(n-k)}
\tag{41.21}\]</span></span></p>
<p>where <span class="math inline">\(X_{(1)} \leq \cdots \leq X_{(n)}\)</span> are the order statistics and <span class="math inline">\(k\)</span> is the number of upper order statistics used. The choice of <span class="math inline">\(k\)</span> involves a bias-variance tradeoff: small <span class="math inline">\(k\)</span> yields high variance; large <span class="math inline">\(k\)</span> introduces bias from non-tail observations.</p>
<div id="hill-estimator" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hill_estimator(data, k_values<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Hill estimator of tail index for a range of k values.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    data : array-like</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Positive values (use absolute values of losses).</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    k_values : array-like, optional</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of upper order statistics to use.</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with columns [k, xi_hat, se].</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.sort(np.<span class="bu">abs</span>(data))[::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Descending order</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k_values <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>        k_values <span class="op">=</span> <span class="bu">range</span>(<span class="dv">10</span>, <span class="bu">min</span>(n <span class="op">//</span> <span class="dv">2</span>, <span class="dv">500</span>), <span class="dv">5</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> k_values:</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">&gt;=</span> n <span class="kw">or</span> k <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        log_excess <span class="op">=</span> np.log(x[:k]) <span class="op">-</span> np.log(x[k])</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>        xi_hat <span class="op">=</span> log_excess.mean()</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> xi_hat <span class="op">/</span> np.sqrt(k)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        results.append({<span class="st">"k"</span>: k, <span class="st">"xi_hat"</span>: xi_hat, <span class="st">"se"</span>: se})</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-hill-plot" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hill-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use negative market returns (losses)</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> <span class="op">-</span>market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>losses_positive <span class="op">=</span> losses[losses <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>hill_results <span class="op">=</span> hill_estimator(losses_positive)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(hill_results, p9.aes(x<span class="op">=</span><span class="st">"k"</span>, y<span class="op">=</span><span class="st">"xi_hat"</span>))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"xi_hat - 1.96 * se"</span>, ymax<span class="op">=</span><span class="st">"xi_hat + 1.96 * se"</span>),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="fl">0.33</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.annotate(</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"text"</span>, x<span class="op">=</span>hill_results[<span class="st">"k"</span>].<span class="bu">max</span>() <span class="op">*</span> <span class="fl">0.7</span>, y<span class="op">=</span><span class="fl">0.35</span>,</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Œæ = 1/3 (cubic tail)"</span>, color<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="dv">8</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Number of Order Statistics (k)"</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Hill Estimate ŒæÃÇ"</span>,</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Hill Plot for Market Return Left Tail"</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-hill-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.5
</figcaption>
</figure>
</div>
<p>The Hill plot is a standard diagnostic in EVT. A stable region of the Hill estimate across a range of <span class="math inline">\(k\)</span> suggests a reliable tail index estimate. The red dashed line at <span class="math inline">\(\xi = 1/3\)</span> corresponds to a tail index of <span class="math inline">\(\alpha = 3\)</span>, which implies that the third moment (skewness) is infinite, which is a finding consistent with much of the empirical finance literature <span class="citation" data-cites="cont2001empirical gabaix2003theory">(<a href="references.html#ref-cont2001empirical" role="doc-biblioref">Cont 2001</a>; <a href="references.html#ref-gabaix2003theory" role="doc-biblioref">Gabaix et al. 2003</a>)</span>.</p>
</section>
<section id="block-maxima-and-the-gev-distribution" class="level3" data-number="41.3.3">
<h3 data-number="41.3.3" class="anchored" data-anchor-id="block-maxima-and-the-gev-distribution"><span class="header-section-number">41.3.3</span> Block Maxima and the GEV Distribution</h3>
<p>The Fisher-Tippett-Gnedenko theorem establishes that if the maximum of <span class="math inline">\(n\)</span> i.i.d. random variables, after proper normalization, converges in distribution, the limit must be a Generalized Extreme Value (GEV) distribution:</p>
<p><span id="eq-gev"><span class="math display">\[
G_\xi(x) = \exp\left\{-\left(1 + \xi \cdot \frac{x - \mu}{\sigma}\right)^{-1/\xi}\right\}
\tag{41.22}\]</span></span></p>
<p>for <span class="math inline">\(1 + \xi(x - \mu)/\sigma &gt; 0\)</span>, where <span class="math inline">\(\mu\)</span> is the location, <span class="math inline">\(\sigma &gt; 0\)</span> the scale, and <span class="math inline">\(\xi\)</span> the shape parameter. The three sub-families are in <a href="#tbl-tail-riskgev-families" class="quarto-xref">Table&nbsp;<span>41.3</span></a>.</p>
<div id="tbl-tail-riskgev-families" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tail-riskgev-families-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.3: GEV Sub-Families and Financial Interpretation
</figcaption>
<div aria-describedby="tbl-tail-riskgev-families-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Shape <span class="math inline">\(\xi\)</span></th>
<th>Distribution</th>
<th>Tail Type</th>
<th>Finance Example</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">\(\xi &gt; 0\)</span></td>
<td>Fr√©chet</td>
<td>Heavy (polynomial decay)</td>
<td>Equity returns, credit losses</td>
</tr>
<tr class="even">
<td><span class="math inline">\(\xi = 0\)</span></td>
<td>Gumbel</td>
<td>Light (exponential decay)</td>
<td>Normal/lognormal models</td>
</tr>
<tr class="odd">
<td><span class="math inline">\(\xi &lt; 0\)</span></td>
<td>Weibull</td>
<td>Bounded upper tail</td>
<td>Bounded loss distributions</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>For the block maxima approach, we divide the return series into non-overlapping blocks (typically months or quarters) and extract the minimum return (maximum loss) from each block. The GEV is then fitted to these block minima.</p>
<div id="block-maxima" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> genextreme</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly block minima (maximum losses)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>market_daily[<span class="st">"month"</span>] <span class="op">=</span> market_daily[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>block_minima <span class="op">=</span> (</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    market_daily.groupby(<span class="st">"month"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    .agg(min_ret<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"min"</span>))</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit GEV to negated block minima (so we model maxima of losses)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>block_losses <span class="op">=</span> <span class="op">-</span>block_minima[<span class="st">"min_ret"</span>].values</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>xi_hat, loc_hat, scale_hat <span class="op">=</span> genextreme.fit(block_losses)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GEV fit to monthly block maxima of losses:"</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Shape (Œæ):    </span><span class="sc">{</span>xi_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Location (Œº): </span><span class="sc">{</span>loc_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Scale (œÉ):    </span><span class="sc">{</span>scale_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-gev-fit" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="20">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-gev-fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>x_grid <span class="op">=</span> np.linspace(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    block_losses.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.8</span>,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    block_losses.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.2</span>,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">200</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>gev_pdf <span class="op">=</span> genextreme.pdf(x_grid, xi_hat, loc<span class="op">=</span>loc_hat, scale<span class="op">=</span>scale_hat)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"x"</span>: np.concatenate([block_losses, x_grid]),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>: ([<span class="st">"Empirical"</span>] <span class="op">*</span> <span class="bu">len</span>(block_losses) <span class="op">+</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>               [<span class="st">"GEV Fit"</span>] <span class="op">*</span> <span class="bu">len</span>(x_grid)),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"density"</span>: np.concatenate([</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        np.full(<span class="bu">len</span>(block_losses), np.nan),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        gev_pdf</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"value"</span>: np.concatenate([block_losses, np.full(<span class="bu">len</span>(x_grid), np.nan)])</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>empirical <span class="op">=</span> plot_data[plot_data[<span class="st">"source"</span>] <span class="op">==</span> <span class="st">"Empirical"</span>]</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> plot_data[plot_data[<span class="st">"source"</span>] <span class="op">==</span> <span class="st">"GEV Fit"</span>]</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    p9.ggplot()</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>empirical, mapping<span class="op">=</span>p9.aes(x<span class="op">=</span><span class="st">"value"</span>, y<span class="op">=</span><span class="st">"..density.."</span>),</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span><span class="dv">30</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>fitted, mapping<span class="op">=</span>p9.aes(x<span class="op">=</span><span class="st">"x"</span>, y<span class="op">=</span><span class="st">"density"</span>),</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly Maximum Loss"</span>,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Density"</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"GEV Distribution Fit to Monthly Block Maxima"</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-gev-fit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.6
</figcaption>
</figure>
</div>
</section>
<section id="sec-gpd" class="level3" data-number="41.3.4">
<h3 data-number="41.3.4" class="anchored" data-anchor-id="sec-gpd"><span class="header-section-number">41.3.4</span> Peaks Over Threshold and the GPD</h3>
<p>The Peaks Over Threshold (POT) approach is generally preferred over block maxima because it uses tail data more efficiently. The Pickands-Balkema-de Haan theorem establishes that for a sufficiently high threshold <span class="math inline">\(u\)</span>, the distribution of exceedances <span class="math inline">\(Y = X - u \mid X &gt; u\)</span> converges to a Generalized Pareto Distribution (GPD):</p>
<p><span id="eq-gpd"><span class="math display">\[
H_{\xi,\beta}(y) = \begin{cases}
1 - \left(1 + \frac{\xi y}{\beta}\right)^{-1/\xi} &amp; \text{if } \xi \neq 0 \\
1 - \exp\left(-\frac{y}{\beta}\right) &amp; \text{if } \xi = 0
\end{cases}
\tag{41.23}\]</span></span></p>
<p>for <span class="math inline">\(y &gt; 0\)</span> and <span class="math inline">\(1 + \xi y / \beta &gt; 0\)</span>, where <span class="math inline">\(\beta &gt; 0\)</span> is the scale parameter and <span class="math inline">\(\xi\)</span> is the shape parameter (identical to the GEV shape). The POT-based VaR and ES at level <span class="math inline">\(\alpha\)</span> are:</p>
<p><span id="eq-var-gpd"><span class="math display">\[
\text{VaR}_\alpha^{\text{GPD}} = u + \frac{\hat{\beta}}{\hat{\xi}}\left[\left(\frac{n}{N_u} \cdot \alpha\right)^{-\hat{\xi}} - 1\right]
\tag{41.24}\]</span></span></p>
<p><span id="eq-es-gpd"><span class="math display">\[
\text{ES}_\alpha^{\text{GPD}} = \frac{\text{VaR}_\alpha^{\text{GPD}}}{1 - \hat{\xi}} + \frac{\hat{\beta} - \hat{\xi} u}{1 - \hat{\xi}}
\tag{41.25}\]</span></span></p>
<p>where <span class="math inline">\(N_u\)</span> is the number of observations exceeding <span class="math inline">\(u\)</span> and <span class="math inline">\(n\)</span> is the total sample size. These formulae are valid for <span class="math inline">\(\hat{\xi} &lt; 1\)</span>.</p>
<div id="gpd-estimation" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> genpareto</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_gpd_pot(returns, threshold_quantile<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Fit GPD to exceedances over threshold using POT approach.</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : array-like</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Return series (losses should be positive).</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    threshold_quantile : float</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Quantile for threshold selection.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Threshold, GPD parameters, VaR, ES estimates.</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> <span class="op">-</span>np.array(returns)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> losses[<span class="op">~</span>np.isnan(losses)]</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(losses)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> np.quantile(losses, threshold_quantile)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    exceedances <span class="op">=</span> losses[losses <span class="op">&gt;</span> u] <span class="op">-</span> u</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    N_u <span class="op">=</span> <span class="bu">len</span>(exceedances)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit GPD</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    xi_hat, _, beta_hat <span class="op">=</span> genpareto.fit(exceedances, floc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VaR and ES at 1%</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    var_gpd <span class="op">=</span> u <span class="op">+</span> (beta_hat <span class="op">/</span> xi_hat) <span class="op">*</span> (</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        (n <span class="op">/</span> N_u <span class="op">*</span> alpha)<span class="op">**</span>(<span class="op">-</span>xi_hat) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    es_gpd <span class="op">=</span> var_gpd <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> xi_hat) <span class="op">+</span> (beta_hat <span class="op">-</span> xi_hat <span class="op">*</span> u) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> xi_hat)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"threshold"</span>: u,</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_exceedances"</span>: N_u,</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_hat"</span>: xi_hat,</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_hat"</span>: beta_hat,</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_1pct"</span>: var_gpd,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"es_1pct"</span>: es_gpd</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit GPD to market losses</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>gpd_results <span class="op">=</span> fit_gpd_pot(market_daily[<span class="st">"mkt_ret"</span>].dropna().values, <span class="fl">0.95</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GPD-POT Results (1</span><span class="sc">% le</span><span class="st">vel):"</span>)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> gpd_results.items():</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">float</span>):</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="threshold-selection" class="level3" data-number="41.3.5">
<h3 data-number="41.3.5" class="anchored" data-anchor-id="threshold-selection"><span class="header-section-number">41.3.5</span> Threshold Selection</h3>
<p>The choice of threshold <span class="math inline">\(u\)</span> is the key practical decision in POT analysis. Too low a threshold violates the asymptotic approximation; too high wastes data. The mean residual life plot provides a graphical diagnostic: if the GPD approximation holds above <span class="math inline">\(u_0\)</span>, the mean excess function <span class="math inline">\(e(u) = E[X - u \mid X &gt; u]\)</span> is linear in <span class="math inline">\(u\)</span> for <span class="math inline">\(u &gt; u_0\)</span>:</p>
<p><span id="eq-mean-excess"><span class="math display">\[
e(u) = \frac{\beta + \xi u}{1 - \xi}
\tag{41.26}\]</span></span></p>
<div id="fig-mean-residual-life" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="22">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-mean-residual-life-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> <span class="op">-</span>market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>losses_sorted <span class="op">=</span> np.sort(losses)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> np.quantile(losses, np.linspace(<span class="fl">0.80</span>, <span class="fl">0.99</span>, <span class="dv">50</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>mean_excess <span class="op">=</span> []</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> u <span class="kw">in</span> thresholds:</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    exceedances <span class="op">=</span> losses[losses <span class="op">&gt;</span> u] <span class="op">-</span> u</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(exceedances) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>        mean_excess.append({</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"threshold"</span>: u,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mean_excess"</span>: exceedances.mean(),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"se"</span>: exceedances.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(exceedances)),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_exceed"</span>: <span class="bu">len</span>(exceedances)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>mrl_df <span class="op">=</span> pd.DataFrame(mean_excess)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(mrl_df, p9.aes(x<span class="op">=</span><span class="st">"threshold"</span>, y<span class="op">=</span><span class="st">"mean_excess"</span>))</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        p9.aes(</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>            ymin<span class="op">=</span><span class="st">"mean_excess - 1.96 * se"</span>,</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>            ymax<span class="op">=</span><span class="st">"mean_excess + 1.96 * se"</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Threshold (u)"</span>,</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Mean Excess e(u)"</span>,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Mean Residual Life Plot"</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-mean-residual-life-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.7
</figcaption>
</figure>
</div>
<p>A threshold in the region where the mean residual life plot is approximately linear is appropriate. In practice, we also compare GPD parameter stability across a range of thresholds and select the lowest threshold at which estimates stabilize.</p>
</section>
<section id="what-evt-captures-that-garch-does-not" class="level3" data-number="41.3.6">
<h3 data-number="41.3.6" class="anchored" data-anchor-id="what-evt-captures-that-garch-does-not"><span class="header-section-number">41.3.6</span> What EVT Captures That GARCH Does Not</h3>
<p><a href="#tbl-tail-riskevt-vs-garch" class="quarto-xref">Table&nbsp;<span>41.4</span></a> summarizes the complementary roles of these two modeling frameworks.</p>
<div id="tbl-tail-riskevt-vs-garch" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tail-riskevt-vs-garch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.4: GARCH vs.&nbsp;EVT: Complementary Frameworks
</figcaption>
<div aria-describedby="tbl-tail-riskevt-vs-garch-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 40%">
<col style="width: 33%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>GARCH</th>
<th>EVT</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>What is modeled</td>
<td>Conditional variance dynamics</td>
<td>Unconditional tail distribution</td>
</tr>
<tr class="even">
<td>Distributional assumption</td>
<td>Full distribution (Gaussian or <span class="math inline">\(t\)</span>)</td>
<td>Only the tail (GPD or GEV)</td>
</tr>
<tr class="odd">
<td>Time dependence</td>
<td>Explicit (volatility clustering)</td>
<td>None (i.i.d. or filtered)</td>
</tr>
<tr class="even">
<td>Tail shape</td>
<td>Determined by innovation distribution</td>
<td>Estimated from data</td>
</tr>
<tr class="odd">
<td>Extreme quantiles</td>
<td>Extrapolation from parametric assumption</td>
<td>Principled extrapolation via EVT theorems</td>
</tr>
<tr class="even">
<td>Best use</td>
<td>Short-horizon risk forecasting</td>
<td>Extreme quantile estimation, stress testing</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The GARCH-filtered EVT approach of <span class="citation" data-cites="mcneil2000estimation">McNeil and Frey (<a href="references.html#ref-mcneil2000estimation" role="doc-biblioref">2000</a>)</span> combines both: GARCH captures the time-varying volatility, and EVT models the residual tail. This hybrid approach is considered best practice for financial risk management <span class="citation" data-cites="mcneil2015quantitative">(<a href="references.html#ref-mcneil2015quantitative" role="doc-biblioref">McNeil, Frey, and Embrechts 2015</a>)</span>.</p>
</section>
</section>
<section id="tail-dependence-and-contagion" class="level2" data-number="41.4">
<h2 data-number="41.4" class="anchored" data-anchor-id="tail-dependence-and-contagion"><span class="header-section-number">41.4</span> Tail Dependence and Contagion</h2>
<section id="why-correlation-breaks-down-in-crises" class="level3" data-number="41.4.1">
<h3 data-number="41.4.1" class="anchored" data-anchor-id="why-correlation-breaks-down-in-crises"><span class="header-section-number">41.4.1</span> Why Correlation Breaks Down in Crises</h3>
<p>Perhaps the most important practical fact about multivariate tail risk is that correlations estimated from the body of the distribution systematically understate dependence in the tails. <span class="citation" data-cites="longin2001extreme">Longin and Solnik (<a href="references.html#ref-longin2001extreme" role="doc-biblioref">2001</a>)</span> demonstrate this using extreme value theory: for bivariate normal returns, the correlation of extreme realizations converges to zero as the threshold moves further into the tail. Yet empirically, the correlation of crash returns remains large and often increases (a phenomenon incompatible with multivariate normality).</p>
<p>Formally, the coefficient of lower tail dependence between two return series <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> is:</p>
<p><span id="eq-tail-dependence"><span class="math display">\[
\lambda_L = \lim_{q \to 0^+} P\left(Y \leq F_Y^{-1}(q) \mid X \leq F_X^{-1}(q)\right)
\tag{41.27}\]</span></span></p>
<p>If <span class="math inline">\(\lambda_L &gt; 0\)</span>, the two series exhibit asymptotic tail dependence (i.e., extreme losses tend to occur jointly). For the bivariate normal distribution, <span class="math inline">\(\lambda_L = 0\)</span> for all <span class="math inline">\(|\rho| &lt; 1\)</span> (asymptotic tail independence). This means that any model built on multivariate normality will structurally underestimate the probability of joint crashes. The Student-<span class="math inline">\(t\)</span> copula, by contrast, has <span class="math inline">\(\lambda_L &gt; 0\)</span> for <span class="math inline">\(\rho &gt; -1\)</span>, which is why it has become the workhorse model for joint tail risk in finance <span class="citation" data-cites="demarta2005t">(<a href="references.html#ref-demarta2005t" role="doc-biblioref">Demarta and McNeil 2005</a>)</span>.</p>
</section>
<section id="co-crash-measures" class="level3" data-number="41.4.2">
<h3 data-number="41.4.2" class="anchored" data-anchor-id="co-crash-measures"><span class="header-section-number">41.4.2</span> Co-Crash Measures</h3>
<p>We implement several empirical measures of joint crash behavior.</p>
<p><strong>Exceedance Correlation.</strong> Following <span class="citation" data-cites="longin2001extreme">Longin and Solnik (<a href="references.html#ref-longin2001extreme" role="doc-biblioref">2001</a>)</span>, compute the correlation of returns conditional on both returns falling below a threshold <span class="math inline">\(\theta\)</span>:</p>
<p><span id="eq-exceedance-corr"><span class="math display">\[
\rho^-(\theta) = \text{Corr}(r_i, r_j \mid r_i &lt; \theta, r_j &lt; \theta)
\tag{41.28}\]</span></span></p>
<p>If returns are bivariate normal, <span class="math inline">\(\rho^-(\theta) \to 0\)</span> as <span class="math inline">\(\theta \to -\infty\)</span>. Empirically, <span class="math inline">\(\rho^-(\theta)\)</span> typically increases as <span class="math inline">\(\theta\)</span> decreases, indicating tail dependence beyond what the normal model implies.</p>
<p><strong>Co-Exceedance Count.</strong> For each day <span class="math inline">\(t\)</span>, count the number of stocks or sectors whose returns fall below the <span class="math inline">\(q\)</span>-th percentile of their respective marginal distributions:</p>
<p><span id="eq-coexceedance"><span class="math display">\[
C_t(q) = \sum_{i=1}^{N} \mathbb{1}\left(r_{i,t} &lt; F_i^{-1}(q)\right)
\tag{41.29}\]</span></span></p>
<p>Days with high <span class="math inline">\(C_t(q)\)</span> represent system-wide stress events.</p>
<div id="tail-dependence-estimation" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> empirical_tail_dependence(x, y, quantiles<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate lower tail dependence coefficient at various quantiles.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses the empirical copula approach: transform to uniform margins,</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    then estimate P(V &lt;= q | U &lt;= q) for decreasing q.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> quantiles <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        quantiles <span class="op">=</span> [<span class="fl">0.20</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>]</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform to uniform margins via empirical CDF</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.stats <span class="im">import</span> rankdata</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> rankdata(x) <span class="op">/</span> (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> rankdata(y) <span class="op">/</span> (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> quantiles:</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        mask_u <span class="op">=</span> u <span class="op">&lt;=</span> q</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        mask_both <span class="op">=</span> mask_u <span class="op">&amp;</span> (v <span class="op">&lt;=</span> q)</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        n_u <span class="op">=</span> mask_u.<span class="bu">sum</span>()</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>        n_both <span class="op">=</span> mask_both.<span class="bu">sum</span>()</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>        lambda_hat <span class="op">=</span> n_both <span class="op">/</span> n_u <span class="cf">if</span> n_u <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"quantile"</span>: q,</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lambda_L"</span>: lambda_hat,</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_below_x"</span>: <span class="bu">int</span>(n_u),</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_co_crash"</span>: <span class="bu">int</span>(n_both)</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="sector-tail-dependence" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sector-level daily returns</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>sector_returns <span class="op">=</span> dc.get_sector_returns(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute pairwise tail dependence for major sectors</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>sectors <span class="op">=</span> sector_returns[<span class="st">"sector"</span>].unique()[:<span class="dv">8</span>]  <span class="co"># Top 8 sectors</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>pairwise_td <span class="op">=</span> []</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s1, s2 <span class="kw">in</span> itertools.combinations(sectors, <span class="dv">2</span>):</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    r1 <span class="op">=</span> sector_returns.loc[</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>        sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> s1, [<span class="st">"date"</span>, <span class="st">"ret"</span>]</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"date"</span>)[<span class="st">"ret"</span>]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> sector_returns.loc[</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> s2, [<span class="st">"date"</span>, <span class="st">"ret"</span>]</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"date"</span>)[<span class="st">"ret"</span>]</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align dates</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    aligned <span class="op">=</span> pd.concat([r1, r2], axis<span class="op">=</span><span class="dv">1</span>, join<span class="op">=</span><span class="st">"inner"</span>).dropna()</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(aligned) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    td <span class="op">=</span> empirical_tail_dependence(</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        aligned.iloc[:, <span class="dv">0</span>].values,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        aligned.iloc[:, <span class="dv">1</span>].values,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        quantiles<span class="op">=</span>[<span class="fl">0.05</span>]</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    pairwise_td.append({</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector_1"</span>: s1,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector_2"</span>: s2,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lambda_L_5pct"</span>: td[<span class="st">"lambda_L"</span>].iloc[<span class="dv">0</span>],</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pearson_corr"</span>: aligned.iloc[:, <span class="dv">0</span>].corr(aligned.iloc[:, <span class="dv">1</span>])</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>td_df <span class="op">=</span> pd.DataFrame(pairwise_td)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-tail-dependence" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="25">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tail-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.5: Pairwise Tail Dependence vs.&nbsp;Linear Correlation Across Sectors
</figcaption>
<div aria-describedby="tbl-tail-dependence-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>td_display <span class="op">=</span> td_df.copy()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"lambda_L_5pct"</span>] <span class="op">=</span> td_display[<span class="st">"lambda_L_5pct"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"pearson_corr"</span>] <span class="op">=</span> td_display[<span class="st">"pearson_corr"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"ratio"</span>] <span class="op">=</span> (</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    td_display[<span class="st">"lambda_L_5pct"</span>] <span class="op">/</span> td_display[<span class="st">"pearson_corr"</span>]</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>td_display.sort_values(<span class="st">"lambda_L_5pct"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">15</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<p>The ratio column in <a href="#tbl-tail-dependence" class="quarto-xref">Table&nbsp;<span>41.5</span></a> is particularly informative. When <span class="math inline">\(\lambda_L / \rho \gg 1\)</span>, the sectors exhibit disproportionately high co-crash frequency relative to their overall correlation. This is the hallmark of tail dependence that Gaussian models miss.</p>
</section>
<section id="system-wide-stress-transmission" class="level3" data-number="41.4.3">
<h3 data-number="41.4.3" class="anchored" data-anchor-id="system-wide-stress-transmission"><span class="header-section-number">41.4.3</span> System-Wide Stress Transmission</h3>
<p>To assess system-wide contagion dynamics, we construct daily co-exceedance counts and examine their time-series properties.</p>
<div id="coexceedance" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily co-exceedance count at the 5% level</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>sector_wide <span class="op">=</span> sector_returns.pivot_table(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"sector"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 252-day quantile thresholds</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>quantile_thresholds <span class="op">=</span> sector_wide.rolling(<span class="dv">252</span>, min_periods<span class="op">=</span><span class="dv">60</span>).quantile(<span class="fl">0.05</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Indicator: return below rolling 5th percentile</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>exceedance_indicators <span class="op">=</span> (sector_wide <span class="op">&lt;</span> quantile_thresholds).astype(<span class="bu">int</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>co_exceedance <span class="op">=</span> exceedance_indicators.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>co_exceedance.name <span class="op">=</span> <span class="st">"co_exceedance"</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>co_exceed_df <span class="op">=</span> co_exceedance.reset_index()</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>co_exceed_df.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"co_exceedance"</span>]</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>co_exceed_df[<span class="st">"n_sectors"</span>] <span class="op">=</span> exceedance_indicators.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).values</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-coexceedance-ts" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="27">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-coexceedance-ts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(co_exceed_df.dropna(), p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"co_exceedance"</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of Sectors in Left Tail"</span>,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"System-Wide Stress: Daily Co-Exceedance Count"</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-coexceedance-ts-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.8
</figcaption>
</figure>
</div>
<p>Peaks in the co-exceedance series correspond to system-wide stress episodes. The smoothed trend (red line) reveals the evolving baseline level of systemic fragility.</p>
</section>
<section id="financial-contagion-mechanisms" class="level3" data-number="41.4.4">
<h3 data-number="41.4.4" class="anchored" data-anchor-id="financial-contagion-mechanisms"><span class="header-section-number">41.4.4</span> Financial Contagion Mechanisms</h3>
<p>The literature distinguishes several channels through which stress propagates across assets, sectors, and markets <span class="citation" data-cites="forbes2002no kaminsky2002unholy">(<a href="references.html#ref-forbes2002no" role="doc-biblioref">Forbes and Rigobon 2002</a>; <a href="references.html#ref-kaminsky2002unholy" role="doc-biblioref">Kaminsky, Reinhart, and Vegh 2002</a>)</span>:</p>
<p><strong>Direct linkages.</strong> Balance sheet interconnections, interbank lending, and cross-holdings create direct transmission channels. When institution <span class="math inline">\(A\)</span> holds assets issued by institution <span class="math inline">\(B\)</span>, losses at <span class="math inline">\(B\)</span> directly impair <span class="math inline">\(A\)</span>‚Äôs balance sheet.</p>
<p><strong>Information contagion.</strong> Adverse news about one firm triggers reassessment of similarly exposed firms. <span class="citation" data-cites="king1990transmission">King and Wadhwani (<a href="references.html#ref-king1990transmission" role="doc-biblioref">1990</a>)</span> and <span class="citation" data-cites="kodres2002rational">Kodres and Pritsker (<a href="references.html#ref-kodres2002rational" role="doc-biblioref">2002</a>)</span> formalize this via Bayesian updating: investors cannot distinguish idiosyncratic from systematic shocks, so a crash in one asset leads them to update beliefs about common risk factors.</p>
<p><strong>Liquidity contagion.</strong> Fire sales by distressed institutions depress prices of commonly held assets, creating losses for other holders. <span class="citation" data-cites="brunnermeier2009deciphering">Brunnermeier (<a href="references.html#ref-brunnermeier2009deciphering" role="doc-biblioref">2009</a>)</span> model this as a liquidity spiral: declining prices trigger margin calls, which force further sales, further depressing prices. In Vietnamese markets, the absence of circuit breakers beyond price limits and the concentration of holdings among a few large institutional investors amplify this channel.</p>
<p><strong>Behavioral contagion.</strong> Herding behavior (i.e., investors mimicking others‚Äô trades) generates correlated selling pressure even in the absence of fundamental linkages. <span class="citation" data-cites="bikhchandani1992theory">Bikhchandani, Hirshleifer, and Welch (<a href="references.html#ref-bikhchandani1992theory" role="doc-biblioref">1992</a>)</span> and <span class="citation" data-cites="banerjee1992simple">Banerjee (<a href="references.html#ref-banerjee1992simple" role="doc-biblioref">1992</a>)</span> provide theoretical foundations. <span class="citation" data-cites="choe2005domestic">Choe, Kho, and Stulz (<a href="references.html#ref-choe2005domestic" role="doc-biblioref">2005</a>)</span> document herding in emerging markets specifically.</p>
<p>We can test for contagion (as distinct from interdependence) using the <span class="citation" data-cites="forbes2002no">Forbes and Rigobon (<a href="references.html#ref-forbes2002no" role="doc-biblioref">2002</a>)</span> framework. The null hypothesis is that the co-movement observed during a crisis period is fully explained by the increase in volatility (which mechanically inflates correlations). The adjusted correlation is:</p>
<p><span id="eq-forbes-rigobon"><span class="math display">\[
\rho^* = \frac{\rho_{\text{crisis}}}{\sqrt{1 + \delta[1 - \rho_{\text{crisis}}^2]}}
\tag{41.30}\]</span></span></p>
<p>where <span class="math inline">\(\delta = \sigma_{\text{crisis}}^2 / \sigma_{\text{tranquil}}^2 - 1\)</span> is the relative increase in variance. If <span class="math inline">\(\rho^* &gt; \rho_{\text{tranquil}}\)</span>, the increase in co-movement exceeds what volatility adjustment alone predicts, which is evidence of contagion.</p>
<div id="contagion-test" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forbes_rigobon_test(returns_df, crisis_start, crisis_end):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Forbes-Rigobon adjusted correlation test for contagion.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns are sector returns, index is date.</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co">    crisis_start, crisis_end : str</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Crisis period boundaries.</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Pairwise contagion test results.</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    tranquil <span class="op">=</span> returns_df[returns_df.index <span class="op">&lt;</span> crisis_start].dropna()</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    crisis <span class="op">=</span> returns_df[</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>        (returns_df.index <span class="op">&gt;=</span> crisis_start) <span class="op">&amp;</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>        (returns_df.index <span class="op">&lt;=</span> crisis_end)</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    ].dropna()</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    sectors <span class="op">=</span> returns_df.columns.tolist()</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s1, s2 <span class="kw">in</span> itertools.combinations(sectors, <span class="dv">2</span>):</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s1 <span class="kw">not</span> <span class="kw">in</span> tranquil.columns <span class="kw">or</span> s2 <span class="kw">not</span> <span class="kw">in</span> crisis.columns:</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a>        rho_t <span class="op">=</span> tranquil[s1].corr(tranquil[s2])</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>        rho_c <span class="op">=</span> crisis[s1].corr(crisis[s2])</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        var_t <span class="op">=</span> tranquil[s1].var()</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        var_c <span class="op">=</span> crisis[s1].var()</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> var_t <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>        delta <span class="op">=</span> var_c <span class="op">/</span> var_t <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>        rho_adj <span class="op">=</span> rho_c <span class="op">/</span> np.sqrt(<span class="dv">1</span> <span class="op">+</span> delta <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> rho_c<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sector_1"</span>: s1,</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sector_2"</span>: s2,</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_tranquil"</span>: <span class="bu">round</span>(rho_t, <span class="dv">4</span>),</span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_crisis"</span>: <span class="bu">round</span>(rho_c, <span class="dv">4</span>),</span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_adjusted"</span>: <span class="bu">round</span>(rho_adj, <span class="dv">4</span>),</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">"contagion"</span>: rho_adj <span class="op">&gt;</span> rho_t</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="contagion-covid" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test for contagion during COVID-19 crash</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>contagion_covid <span class="op">=</span> forbes_rigobon_test(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    sector_wide,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    crisis_start<span class="op">=</span><span class="st">"2020-02-01"</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    crisis_end<span class="op">=</span><span class="st">"2020-04-30"</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>n_pairs <span class="op">=</span> <span class="bu">len</span>(contagion_covid)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>n_contagion <span class="op">=</span> contagion_covid[<span class="st">"contagion"</span>].<span class="bu">sum</span>()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"COVID-19 contagion test: </span><span class="sc">{</span>n_contagion<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_pairs<span class="sc">}</span><span class="ss"> sector pairs "</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"show evidence of contagion (</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>n_contagion<span class="op">/</span>n_pairs<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-contagion-results" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="30">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-contagion-results-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.6: Forbes-Rigobon Contagion Test: COVID-19 Crisis Period
</figcaption>
<div aria-describedby="tbl-contagion-results-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>contagion_covid.sort_values(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rho_adjusted"</span>, ascending<span class="op">=</span><span class="va">False</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>).head(<span class="dv">15</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
</section>
<section id="applications-to-financial-stability" class="level2" data-number="41.5">
<h2 data-number="41.5" class="anchored" data-anchor-id="applications-to-financial-stability"><span class="header-section-number">41.5</span> Applications to Financial Stability</h2>
<section id="market-wide-stress-indicators" class="level3" data-number="41.5.1">
<h3 data-number="41.5.1" class="anchored" data-anchor-id="market-wide-stress-indicators"><span class="header-section-number">41.5.1</span> Market-Wide Stress Indicators</h3>
<p>We construct several market-wide stress indicators that aggregate the individual-level and sectoral tail risk measures developed above into a comprehensive system-level diagnostic.</p>
<p><strong>Aggregate Crash Risk Index.</strong> The cross-sectional average of firm-level NCSKEW provides a market-wide measure of crash risk that is forward-looking (it captures the buildup of negative skewness before a crash materializes):</p>
<p><span id="eq-acri"><span class="math display">\[
\text{ACRI}_y = \frac{1}{N_y}\sum_{i=1}^{N_y} \text{NCSKEW}_{i,y}
\tag{41.31}\]</span></span></p>
<p><strong>Market Tail Risk (MTR).</strong> Following <span class="citation" data-cites="kelly2014tail">Kelly and Jiang (<a href="references.html#ref-kelly2014tail" role="doc-biblioref">2014</a>)</span>, we estimate the time-varying tail risk of the market portfolio using option-implied or realized tail measures. In the absence of a liquid options market in Vietnam, we use the realized version based on the Hill tail index estimated from rolling windows:</p>
<p><span id="eq-mtr"><span class="math display">\[
\text{MTR}_t = \hat{\xi}_t^{\text{Hill}} \cdot \hat{\sigma}_t
\tag{41.32}\]</span></span></p>
<p>where <span class="math inline">\(\hat{\xi}_t^{\text{Hill}}\)</span> is the Hill estimator computed from a trailing 252-day window and <span class="math inline">\(\hat{\sigma}_t\)</span> is the conditional volatility (e.g., from GARCH). This interaction captures both the thickness of the tail and the current scale of volatility.</p>
<div id="stability-indicators" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate Crash Risk Index</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>acri <span class="op">=</span> (</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    crash_risk.groupby(<span class="st">"year"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        acri<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"mean"</span>),</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>        median_ncskew<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"median"</span>),</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>        pct_high_crash<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> x.quantile(<span class="fl">0.75</span>)).mean()),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>        n_firms<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"count"</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Market Tail Risk: rolling Hill estimator x rolling volatility</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>mkt_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> market_daily[<span class="st">"date"</span>].dropna().values</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>mtr_list <span class="op">=</span> []</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> end_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">504</span>, <span class="bu">len</span>(mkt_returns)):</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    window_ret <span class="op">=</span> mkt_returns[end_idx <span class="op">-</span> <span class="dv">252</span>:end_idx]</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    losses_pos <span class="op">=</span> <span class="op">-</span>window_ret[window_ret <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(losses_pos) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hill estimator at k = 50</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    sorted_losses <span class="op">=</span> np.sort(losses_pos)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">min</span>(<span class="dv">50</span>, <span class="bu">len</span>(sorted_losses) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    log_excess <span class="op">=</span> np.log(sorted_losses[:k]) <span class="op">-</span> np.log(sorted_losses[k])</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>    xi_hat <span class="op">=</span> log_excess.mean()</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    sigma_hat <span class="op">=</span> window_ret.std()</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>    mtr <span class="op">=</span> xi_hat <span class="op">*</span> sigma_hat</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>    mtr_list.append({</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: dates[end_idx],</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_hat"</span>: xi_hat,</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_hat"</span>: sigma_hat,</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mtr"</span>: mtr</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>mtr_df <span class="op">=</span> pd.DataFrame(mtr_list)</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>mtr_df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(mtr_df[<span class="st">"date"</span>])</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-stability-dashboard" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="32">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stability-dashboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(mtr_df, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"mtr"</span>))</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"MTR (Œæ √ó œÉ)"</span>,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Market Tail Risk: Rolling Hill Index √ó Conditional Volatility"</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-stability-dashboard-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.9
</figcaption>
</figure>
</div>
</section>
<section id="sectoral-fragility" class="level3" data-number="41.5.2">
<h3 data-number="41.5.2" class="anchored" data-anchor-id="sectoral-fragility"><span class="header-section-number">41.5.2</span> Sectoral Fragility</h3>
<p>Not all sectors are equally vulnerable to tail events. We decompose system-wide tail risk into sectoral contributions to identify the most fragile parts of the market.</p>
<div id="sectoral-fragility" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sector-level tail statistics</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sector_tail_stats <span class="op">=</span> []</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sector <span class="kw">in</span> sectors:</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    sector_data <span class="op">=</span> sector_returns[sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> sector][<span class="st">"ret"</span>].dropna()</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(sector_data) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    s_data <span class="op">=</span> sector_data.values</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skewness and kurtosis</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    skew <span class="op">=</span> stats.skew(s_data)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    kurt <span class="op">=</span> stats.kurtosis(s_data)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VaR and ES at 1%</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>    var_1 <span class="op">=</span> <span class="op">-</span>np.quantile(s_data, <span class="fl">0.01</span>)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    es_1 <span class="op">=</span> <span class="op">-</span>s_data[s_data <span class="op">&lt;=</span> np.quantile(s_data, <span class="fl">0.01</span>)].mean()</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hill tail index (k=50)</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>    losses_pos <span class="op">=</span> <span class="op">-</span>s_data[s_data <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    sorted_l <span class="op">=</span> np.sort(losses_pos)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">min</span>(<span class="dv">50</span>, <span class="bu">len</span>(sorted_l) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k <span class="op">&gt;=</span> <span class="dv">10</span>:</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>        log_exc <span class="op">=</span> np.log(sorted_l[:k]) <span class="op">-</span> np.log(sorted_l[k])</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> log_exc.mean()</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> np.nan</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>    sector_tail_stats.append({</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector"</span>: sector,</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"skewness"</span>: <span class="bu">round</span>(skew, <span class="dv">3</span>),</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"excess_kurtosis"</span>: <span class="bu">round</span>(kurt, <span class="dv">3</span>),</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_1pct"</span>: <span class="bu">round</span>(var_1, <span class="dv">4</span>),</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"es_1pct"</span>: <span class="bu">round</span>(es_1, <span class="dv">4</span>),</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tail_index_xi"</span>: <span class="bu">round</span>(xi, <span class="dv">3</span>) <span class="cf">if</span> <span class="kw">not</span> np.isnan(xi) <span class="cf">else</span> np.nan,</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_obs"</span>: <span class="bu">len</span>(s_data)</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>fragility_df <span class="op">=</span> pd.DataFrame(sector_tail_stats)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-sectoral-fragility" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="34">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-sectoral-fragility-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.7: Sectoral Tail Risk Profile
</figcaption>
<div aria-describedby="tbl-sectoral-fragility-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fragility_df.sort_values(<span class="st">"es_1pct"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<div id="fig-sector-scatter" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="35">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sector-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        fragility_df.dropna(),</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        p9.aes(x<span class="op">=</span><span class="st">"tail_index_xi"</span>, y<span class="op">=</span><span class="st">"es_1pct"</span>, label<span class="op">=</span><span class="st">"sector"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_text(nudge_y<span class="op">=</span><span class="fl">0.002</span>, size<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Tail Index (Œæ, Hill)"</span>,</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"1</span><span class="sc">% E</span><span class="st">xpected Shortfall"</span>,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Sector Fragility Map"</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-sector-scatter-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.10
</figcaption>
</figure>
</div>
<p>Sectors in the upper-right quadrant of <a href="#fig-sector-scatter" class="quarto-xref">Figure&nbsp;<span>41.10</span></a> exhibit both high expected shortfall (large average losses in the tail) and high tail index (heavier-than-typical tails). These represent the most fragile components of the market from a systemic stability perspective.</p>
</section>
<section id="crisis-diagnostics" class="level3" data-number="41.5.3">
<h3 data-number="41.5.3" class="anchored" data-anchor-id="crisis-diagnostics"><span class="header-section-number">41.5.3</span> Crisis Diagnostics</h3>
<p>We construct a comprehensive crisis diagnostic framework that combines the indicators developed above to identify, characterize, and compare stress episodes in Vietnamese financial markets.</p>
<div id="crisis-diagnostics" class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify extreme co-exceedance days (system-wide stress events)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>threshold_high_stress <span class="op">=</span> co_exceed_df[<span class="st">"co_exceedance"</span>].quantile(<span class="fl">0.99</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> co_exceed_df[</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    co_exceed_df[<span class="st">"co_exceedance"</span>] <span class="op">&gt;=</span> threshold_high_stress</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market return on stress days</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> stress_events.merge(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    market_daily[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"System-wide stress days (top 1%): </span><span class="sc">{</span><span class="bu">len</span>(stress_events)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average market return on stress days: "</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stress_events[<span class="st">'mkt_ret'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average co-exceedance on stress days: "</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stress_events[<span class="st">'co_exceedance'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-crisis-episodes" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="37">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-crisis-episodes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.8: Major Stress Episodes: Clustering of System-Wide Tail Events
</figcaption>
<div aria-describedby="tbl-crisis-episodes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cluster stress days into episodes (within 10 trading days)</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> stress_events.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>stress_events[<span class="st">"gap"</span>] <span class="op">=</span> stress_events[<span class="st">"date"</span>].diff().dt.days</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>stress_events[<span class="st">"episode"</span>] <span class="op">=</span> (stress_events[<span class="st">"gap"</span>] <span class="op">&gt;</span> <span class="dv">15</span>).cumsum()</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>episode_summary <span class="op">=</span> (</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    stress_events.groupby(<span class="st">"episode"</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>),</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        n_stress_days<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"count"</span>),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        avg_market_return<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        min_market_return<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"min"</span>),</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        avg_coexceedance<span class="op">=</span>(<span class="st">"co_exceedance"</span>, <span class="st">"mean"</span>)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"min_market_return"</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"avg_market_return"</span>] <span class="op">=</span> episode_summary[<span class="st">"avg_market_return"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"min_market_return"</span>] <span class="op">=</span> episode_summary[<span class="st">"min_market_return"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"avg_coexceedance"</span>] <span class="op">=</span> episode_summary[<span class="st">"avg_coexceedance"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>episode_summary.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<!-- ## Exercises

1.  **Crash Risk Determinants.** Estimate a panel regression of NCSKEW on lagged firm characteristics: size, book-to-market, leverage, return volatility, trading volume, state ownership dummy, and lagged NCSKEW. Include industry and year fixed effects. Cluster standard errors by firm. Which characteristics predict future crash risk? Does state ownership amplify or attenuate crash risk?

2.  **VaR Model Comparison.** Implement a GARCH(1,1)-$t$ model for the market return and compute the one-day-ahead VaR at the 1% level. Compare its backtesting performance (Kupiec and Christoffersen tests) against the four static methods implemented in this chapter. Which model performs best in terms of unconditional coverage? Which in terms of independence?

3.  **Threshold Sensitivity.** Re-estimate the GPD model from @sec-gpd using thresholds at the 90th, 92.5th, 95th, and 97.5th percentiles. Plot the resulting VaR and ES estimates as a function of the threshold. At what threshold do the estimates stabilize? Relate your findings to the mean residual life plot.

4.  **Tail Dependence Across Market Regimes.** Split the sample into bull and bear regimes (e.g., above/below the 12-month moving average of the market index). Estimate pairwise tail dependence coefficients separately for each regime. Is tail dependence symmetric across regimes, or is it asymmetrically higher during bear markets?

5.  **Contagion During Multiple Crises.** Apply the Forbes-Rigobon contagion test to at least three distinct crisis episodes in Vietnam (e.g., 2011 banking stress, 2018 trade war, 2020 COVID-19, 2022 V·∫°n Th·ªãnh Ph√°t/corporate bond crisis). Compare the fraction of sector pairs showing contagion across episodes. Which crises were most contagious? What structural features of each crisis might explain the differences?

6.  **Price Limit Bias in Tail Estimation.** Simulate a stock return series from a Student-$t$ distribution with known parameters, then censor it at Vietnamese daily price limits ($\pm 7\%$ for HOSE, $\pm 10\%$ for HNX). Compare VaR, ES, and Hill tail index estimates from the censored and uncensored series. Quantify the underestimation bias as a function of the true tail thickness and price limit width. -->
</section>
</section>
<section id="summary" class="level2" data-number="41.6">
<h2 data-number="41.6" class="anchored" data-anchor-id="summary"><span class="header-section-number">41.6</span> Summary</h2>
<p>This chapter developed a comprehensive toolkit for measuring and diagnosing tail risk in Vietnamese equity markets. The key objects estimated (crash risk measures, VaR and Expected Shortfall, tail indices, and tail dependence coefficients) capture distinct but complementary aspects of extreme event behavior.</p>
<p>At the individual stock level, the NCSKEW, DUVOL, and crash count measures quantify asymmetry in firm-specific return distributions, providing forward-looking indicators of crash vulnerability. At the portfolio level, EVT-based approaches to VaR and ES estimation avoid the parametric misspecification that plagues Gaussian and even Student-<span class="math inline">\(t\)</span> models in the deep tails. At the system level, tail dependence and co-exceedance measures reveal the extent to which crashes propagate across sectors, and the Forbes-Rigobon contagion test distinguishes genuine contagion from the mechanical increase in co-movement driven by higher volatility.</p>
<p>Several features of Vietnamese markets deserve emphasis. Price limits censor the observed return distribution, causing systematic underestimation of true tail risk. The concentration of trading among retail investors amplifies herding-driven crash dynamics. State ownership of large firms creates correlated exposure to policy shocks that is not captured by standard diversification. And the absence of deep derivatives markets limits the hedging instruments available for tail risk management, making accurate measurement all the more critical.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-artzner1999coherent" class="csl-entry" role="listitem">
Artzner, Philippe, Freddy Delbaen, Jean-Marc Eber, and David Heath. 1999. <span>‚ÄúCoherent Measures of Risk.‚Äù</span> <em>Mathematical Finance</em> 9 (3): 203‚Äì28.
</div>
<div id="ref-banerjee1992simple" class="csl-entry" role="listitem">
Banerjee, Abhijit V. 1992. <span>‚ÄúA Simple Model of Herd Behavior.‚Äù</span> <em>The Quarterly Journal of Economics</em> 107 (3): 797‚Äì817.
</div>
<div id="ref-bikhchandani1992theory" class="csl-entry" role="listitem">
Bikhchandani, Sushil, David Hirshleifer, and Ivo Welch. 1992. <span>‚ÄúA Theory of Fads, Fashion, Custom, and Cultural Change as Informational Cascades.‚Äù</span> <em>Journal of Political Economy</em> 100 (5): 992‚Äì1026.
</div>
<div id="ref-brunnermeier2009deciphering" class="csl-entry" role="listitem">
Brunnermeier, Markus K. 2009. <span>‚ÄúDeciphering the Liquidity and Credit Crunch 2007‚Äì2008.‚Äù</span> <em>Journal of Economic Perspectives</em> 23 (1): 77‚Äì100.
</div>
<div id="ref-chen2001forecasting" class="csl-entry" role="listitem">
Chen, Joseph, Harrison Hong, and Jeremy C Stein. 2001. <span>‚ÄúForecasting Crashes: Trading Volume, Past Returns, and Conditional Skewness in Stock Prices.‚Äù</span> <em>Journal of Financial Economics</em> 61 (3): 345‚Äì81.
</div>
<div id="ref-choe2005domestic" class="csl-entry" role="listitem">
Choe, Hyuk, Bong-Chan Kho, and Ren√© M Stulz. 2005. <span>‚ÄúDo Domestic Investors Have an Edge? The Trading Experience of Foreign Investors in Korea.‚Äù</span> <em>The Review of Financial Studies</em> 18 (3): 795‚Äì829.
</div>
<div id="ref-christoffersen1998evaluating" class="csl-entry" role="listitem">
Christoffersen, Peter F. 1998. <span>‚ÄúEvaluating Interval Forecasts.‚Äù</span> <em>International Economic Review</em>, 841‚Äì62.
</div>
<div id="ref-cont2001empirical" class="csl-entry" role="listitem">
Cont, Rama. 2001. <span>‚ÄúEmpirical Properties of Asset Returns: Stylized Facts and Statistical Issues.‚Äù</span> <em>Quantitative Finance</em> 1 (2): 223.
</div>
<div id="ref-demarta2005t" class="csl-entry" role="listitem">
Demarta, Stefano, and Alexander J McNeil. 2005. <span>‚ÄúThe t Copula and Related Copulas.‚Äù</span> <em>International Statistical Review</em> 73 (1): 111‚Äì29.
</div>
<div id="ref-forbes2002no" class="csl-entry" role="listitem">
Forbes, Kristin J, and Roberto Rigobon. 2002. <span>‚ÄúNo Contagion, Only Interdependence: Measuring Stock Market Comovements.‚Äù</span> <em>The Journal of Finance</em> 57 (5): 2223‚Äì61.
</div>
<div id="ref-gabaix2003theory" class="csl-entry" role="listitem">
Gabaix, Xavier, Parameswaran Gopikrishnan, Vasiliki Plerou, and H Eugene Stanley. 2003. <span>‚ÄúA Theory of Power-Law Distributions in Financial Market Fluctuations.‚Äù</span> <em>Nature</em> 423 (6937): 267‚Äì70.
</div>
<div id="ref-harvey2000conditional" class="csl-entry" role="listitem">
Harvey, Campbell R, and Akhtar Siddique. 2000. <span>‚ÄúConditional Skewness in Asset Pricing Tests.‚Äù</span> <em>The Journal of Finance</em> 55 (3): 1263‚Äì95.
</div>
<div id="ref-hill1975simple" class="csl-entry" role="listitem">
Hill, Bruce M. 1975. <span>‚ÄúA Simple General Approach to Inference about the Tail of a Distribution.‚Äù</span> <em>The Annals of Statistics</em>, 1163‚Äì74.
</div>
<div id="ref-hutton2009opaque" class="csl-entry" role="listitem">
Hutton, Amy P, Alan J Marcus, and Hassan Tehranian. 2009. <span>‚ÄúOpaque Financial Reports, R2, and Crash Risk.‚Äù</span> <em>Journal of Financial Economics</em> 94 (1): 67‚Äì86.
</div>
<div id="ref-kaminsky2002unholy" class="csl-entry" role="listitem">
Kaminsky, Graciela L, Carmen M Reinhart, and Carlos A Vegh. 2002. <span>‚ÄúThe Unholy Trinity of Financial Contagion.‚Äù</span> <em>Journal of Economic Perspectives</em> 17 (4): 51‚Äì74.
</div>
<div id="ref-kelly2014tail" class="csl-entry" role="listitem">
Kelly, Bryan, and Hao Jiang. 2014. <span>‚ÄúTail Risk and Asset Prices.‚Äù</span> <em>The Review of Financial Studies</em> 27 (10): 2841‚Äì71.
</div>
<div id="ref-king1990transmission" class="csl-entry" role="listitem">
King, Mervyn A, and Sushil Wadhwani. 1990. <span>‚ÄúTransmission of Volatility Between Stock Markets.‚Äù</span> <em>The Review of Financial Studies</em> 3 (1): 5‚Äì33.
</div>
<div id="ref-kodres2002rational" class="csl-entry" role="listitem">
Kodres, Laura E, and Matthew Pritsker. 2002. <span>‚ÄúA Rational Expectations Model of Financial Contagion.‚Äù</span> <em>The Journal of Finance</em> 57 (2): 769‚Äì99.
</div>
<div id="ref-kraus1976skewness" class="csl-entry" role="listitem">
Kraus, Alan, and Robert H Litzenberger. 1976. <span>‚ÄúSkewness Preference and the Valuation of Risk Assets.‚Äù</span> <em>The Journal of Finance</em> 31 (4): 1085‚Äì1100.
</div>
<div id="ref-kupiec1995techniques" class="csl-entry" role="listitem">
Kupiec, Paul H et al. 1995. <span>‚ÄúTechniques for Verifying the Accuracy of Risk Measurement Models.‚Äù</span>
</div>
<div id="ref-longin2001extreme" class="csl-entry" role="listitem">
Longin, Francois, and Bruno Solnik. 2001. <span>‚ÄúExtreme Correlation of International Equity Markets.‚Äù</span> <em>The Journal of Finance</em> 56 (2): 649‚Äì76.
</div>
<div id="ref-mandelbrot1963variation" class="csl-entry" role="listitem">
Mandelbrot, Benoit et al. 1963. <span>‚ÄúThe Variation of Certain Speculative Prices.‚Äù</span> <em>Journal of Business</em> 36 (4): 394.
</div>
<div id="ref-mcneil2000estimation" class="csl-entry" role="listitem">
McNeil, Alexander J, and R√ºdiger Frey. 2000. <span>‚ÄúEstimation of Tail-Related Risk Measures for Heteroscedastic Financial Time Series: An Extreme Value Approach.‚Äù</span> <em>Journal of Empirical Finance</em> 7 (3-4): 271‚Äì300.
</div>
<div id="ref-mcneil2015quantitative" class="csl-entry" role="listitem">
McNeil, Alexander J, R√ºdiger Frey, and Paul Embrechts. 2015. <em>Quantitative Risk Management: Concepts, Techniques and Tools-Revised Edition</em>. Princeton university press.
</div>
<div id="ref-taleb2010black" class="csl-entry" role="listitem">
Taleb, Nassim Nicholas. 2010. <em>The Black Swan:: The Impact of the Highly Improbable: With a New Section:" on Robustness and Fragility"</em>. Vol. 2. Random house trade paperbacks.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LG91D0C6RB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LG91D0C6RB');
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./60_event_studies.html" class="pagination-link" aria-label="Event Studies in Finance">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./62_corporate_finance_estimators.html" class="pagination-link" aria-label="Corporate Finance Estimators and Identification">
        <span class="nav-page-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Tail Risk and Extreme Events</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>Finance is fundamentally a discipline of extremes. The central objects of concern (e.g., asset pricing, portfolio allocation, capital regulation, systemic stability) are all disproportionately shaped by rare but severe events. A portfolio manager who correctly estimates the mean and variance of returns but ignores the possibility of a $-20\%$ daily move is, in the language of @taleb2010black, "picking up pennies in front of a steamroller." The 1997 Asian Financial Crisis, the 2008 Global Financial Crisis, and the 2020 COVID-19 crash each demonstrated that the most consequential realizations in financial markets are precisely those that conventional Gaussian models assign near-zero probability.</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>This chapter develops the statistical and econometric toolkit for measuring, modeling, and diagnosing tail risk in Vietnamese equity markets. We focus on three interconnected layers. First, at the individual stock level, we estimate crash risk measures that capture the asymmetry and thickness of the left tail of return distributions. Second, at the portfolio or regulatory level, we implement Value at Risk (VaR) and Expected Shortfall (ES) under multiple estimation approaches and evaluate their accuracy via backtesting. Third, at the system level, we apply Extreme Value Theory (EVT) and tail dependence measures to characterize joint crash behavior across sectors and assess financial contagion.</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>Vietnamese markets present a particularly rich laboratory for studying tail phenomena. Daily price limits mechanically censor the tails of observed return distributions, creating latent tail risk that is not directly observable but must be inferred. State ownership concentrations, thin liquidity, and herding behavior among retail investors amplify crash dynamics. The absence of a developed derivatives market means that tail hedging instruments familiar in more developed markets (e.g., deep out-of-the-money puts, variance swaps) are largely unavailable, making accurate tail risk measurement all the more important for risk management.</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="fu">## Crash Risk in Equity Markets</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Left Tail Problem</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>The return distribution of individual stocks and market indices is not symmetric. Decades of evidence, beginning with @mandelbrot1963variation and formalized in the asset pricing context by @harvey2000conditional, establish that equity returns exhibit negative skewness (i.e., large negative returns occur more frequently than a Gaussian model predicts) and excess kurtosis (i.e., the tails are thicker than normal in both directions, but the left tail is of primary economic concern).</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>Let $r_{i,t}$ denote the daily log return of stock $i$ on day $t$. The standardized third central moment (skewness) is:</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>\text{Skew}(r_i) = \frac{E\left<span class="co">[</span><span class="ot">(r_{i,t} - \mu_i)^3\right</span><span class="co">]</span>}{\sigma_i^3}</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>$$ {#eq-skewness}</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>Negative skewness implies that the distribution has a longer or fatter left tail relative to the right. In economic terms, negative skewness means that large losses are more likely than large gains of equal magnitude. The standardized fourth moment (excess kurtosis) is:</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>\text{Kurt}(r_i) = \frac{E\left<span class="co">[</span><span class="ot">(r_{i,t} - \mu_i)^4\right</span><span class="co">]</span>}{\sigma_i^4} - 3</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>$$ {#eq-kurtosis}</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>Positive excess kurtosis indicates heavier tails than the normal distribution. Both moments have direct asset pricing implications: @harvey2000conditional and @kraus1976skewness argue that investors demand compensation for holding negatively skewed assets, implying that crash-prone stocks should earn higher expected returns, ceteris paribus.</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a><span class="fu">### Crash Risk Measures</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>The literature has developed several firm-specific crash risk measures. We implement the three most widely used, following @chen2001forecasting and @hutton2009opaque.</span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>**Measure 1: Negative Coefficient of Skewness (NCSKEW)**</span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>For each firm $i$ in fiscal year $y$, compute firm-specific weekly returns $W_{i,\tau}$ as residuals from a market model augmented with lead and lag market returns to account for nonsynchronous trading:</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>r_{i,t} = \alpha_i + \beta_{1i} r_{m,t-1} + \beta_{2i} r_{m,t} + \beta_{3i} r_{m,t+1} + \varepsilon_{i,t}</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>$$ {#eq-crash-model}</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>where $r_{m,t}$ is the value-weighted market return on day $t$. The firm-specific weekly return is $W_{i,\tau} = \ln(1 + \sum_{t \in \tau} \hat{\varepsilon}_{i,t})$, where $\tau$ indexes weeks. NCSKEW is then:</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>\text{NCSKEW}_{i,y} = -\frac{n(n-1)^{3/2} \sum W_{i,\tau}^3}{(n-1)(n-2)\left(\sum W_{i,\tau}^2\right)^{3/2}}</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ncskew}</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>where $n$ is the number of firm-specific weekly returns in the year. The negative sign ensures that higher NCSKEW corresponds to greater crash risk.</span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>**Measure 2: Down-to-Up Volatility (DUVOL)**</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>Partition the firm-specific weekly returns into "down weeks" ($W_{i,\tau} &lt; \bar{W}_i$) and "up weeks" ($W_{i,\tau} \geq \bar{W}_i$), where $\bar{W}_i$ is the annual mean. Then:</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>\text{DUVOL}_{i,y} = \ln\left(\frac{(n_u - 1)\sum_{\text{down}} W_{i,\tau}^2}{(n_d - 1)\sum_{\text{up}} W_{i,\tau}^2}\right)</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>$$ {#eq-duvol}</span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-73"><a href="#cb37-73" aria-hidden="true" tabindex="-1"></a>where $n_u$ and $n_d$ are the number of up and down weeks, respectively. Higher DUVOL indicates greater crash risk. @chen2001forecasting argue that DUVOL is less sensitive to outliers than NCSKEW because it does not involve the cube of returns.</span>
<span id="cb37-74"><a href="#cb37-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-75"><a href="#cb37-75" aria-hidden="true" tabindex="-1"></a>**Measure 3: Crash Count (COUNT)**</span>
<span id="cb37-76"><a href="#cb37-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-77"><a href="#cb37-77" aria-hidden="true" tabindex="-1"></a>Define a crash event as a firm-specific weekly return that falls below $k$ standard deviations of its annual distribution:</span>
<span id="cb37-78"><a href="#cb37-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-79"><a href="#cb37-79" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-80"><a href="#cb37-80" aria-hidden="true" tabindex="-1"></a>\text{CRASH}_{i,\tau} = \mathbb{1}\left(W_{i,\tau} &lt; \bar{W}_i - k \cdot \hat{\sigma}_{W_i}\right)</span>
<span id="cb37-81"><a href="#cb37-81" aria-hidden="true" tabindex="-1"></a>$$ {#eq-crash-event}</span>
<span id="cb37-82"><a href="#cb37-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-83"><a href="#cb37-83" aria-hidden="true" tabindex="-1"></a>The standard threshold in the literature is $k = 3.09$, corresponding to the 0.1% tail of a standard normal distribution. The crash count for year $y$ is $\text{COUNT}_{i,y} = \sum_{\tau \in y} \text{CRASH}_{i,\tau}$.</span>
<span id="cb37-84"><a href="#cb37-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-87"><a href="#cb37-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-88"><a href="#cb37-88" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-data</span></span>
<span id="cb37-89"><a href="#cb37-89" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-90"><a href="#cb37-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-91"><a href="#cb37-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-92"><a href="#cb37-92" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb37-93"><a href="#cb37-93" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb37-94"><a href="#cb37-94" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb37-95"><a href="#cb37-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-96"><a href="#cb37-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Load daily stock returns and market returns</span></span>
<span id="cb37-97"><a href="#cb37-97" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb37-98"><a href="#cb37-98" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb37-99"><a href="#cb37-99" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb37-100"><a href="#cb37-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-101"><a href="#cb37-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-102"><a href="#cb37-102" aria-hidden="true" tabindex="-1"></a><span class="co"># Market return: value-weighted index</span></span>
<span id="cb37-103"><a href="#cb37-103" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb37-104"><a href="#cb37-104" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb37-105"><a href="#cb37-105" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb37-106"><a href="#cb37-106" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb37-107"><a href="#cb37-107" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-108"><a href="#cb37-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-109"><a href="#cb37-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge</span></span>
<span id="cb37-110"><a href="#cb37-110" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> daily_returns.merge(</span>
<span id="cb37-111"><a href="#cb37-111" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb37-112"><a href="#cb37-112" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb37-113"><a href="#cb37-113" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb37-114"><a href="#cb37-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-115"><a href="#cb37-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-116"><a href="#cb37-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Universe: </span><span class="sc">{</span>df[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> firms, "</span></span>
<span id="cb37-117"><a href="#cb37-117" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>df[<span class="st">'date'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss"> trading days"</span>)</span>
<span id="cb37-118"><a href="#cb37-118" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-119"><a href="#cb37-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-122"><a href="#cb37-122" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-123"><a href="#cb37-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: firm-specific-returns</span></span>
<span id="cb37-124"><a href="#cb37-124" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-125"><a href="#cb37-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-126"><a href="#cb37-126" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb37-127"><a href="#cb37-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-128"><a href="#cb37-128" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_firm_specific_returns(group):</span>
<span id="cb37-129"><a href="#cb37-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-130"><a href="#cb37-130" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate firm-specific daily returns from augmented market model</span></span>
<span id="cb37-131"><a href="#cb37-131" aria-hidden="true" tabindex="-1"></a><span class="co">    with lead and lag market returns (Chen, Hong, Stein 2001).</span></span>
<span id="cb37-132"><a href="#cb37-132" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-133"><a href="#cb37-133" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> group.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb37-134"><a href="#cb37-134" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"mkt_lag1"</span>] <span class="op">=</span> g[<span class="st">"mkt_ret"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb37-135"><a href="#cb37-135" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"mkt_lead1"</span>] <span class="op">=</span> g[<span class="st">"mkt_ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb37-136"><a href="#cb37-136" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> g.dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>, <span class="st">"mkt_lag1"</span>, <span class="st">"mkt_lead1"</span>])</span>
<span id="cb37-137"><a href="#cb37-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-138"><a href="#cb37-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(g) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb37-139"><a href="#cb37-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb37-140"><a href="#cb37-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-141"><a href="#cb37-141" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> g[[<span class="st">"mkt_lag1"</span>, <span class="st">"mkt_ret"</span>, <span class="st">"mkt_lead1"</span>]].values</span>
<span id="cb37-142"><a href="#cb37-142" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> g[<span class="st">"ret"</span>].values</span>
<span id="cb37-143"><a href="#cb37-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-144"><a href="#cb37-144" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression().fit(X, y)</span>
<span id="cb37-145"><a href="#cb37-145" aria-hidden="true" tabindex="-1"></a>    g[<span class="st">"resid"</span>] <span class="op">=</span> y <span class="op">-</span> model.predict(X)</span>
<span id="cb37-146"><a href="#cb37-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-147"><a href="#cb37-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> g[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"resid"</span>]]</span>
<span id="cb37-148"><a href="#cb37-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-149"><a href="#cb37-149" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by firm-year</span></span>
<span id="cb37-150"><a href="#cb37-150" aria-hidden="true" tabindex="-1"></a>df[<span class="st">"year"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb37-151"><a href="#cb37-151" aria-hidden="true" tabindex="-1"></a>firm_resids <span class="op">=</span> (</span>
<span id="cb37-152"><a href="#cb37-152" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>], group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-153"><a href="#cb37-153" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_firm_specific_returns)</span>
<span id="cb37-154"><a href="#cb37-154" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-155"><a href="#cb37-155" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-156"><a href="#cb37-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-157"><a href="#cb37-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-160"><a href="#cb37-160" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-161"><a href="#cb37-161" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: weekly-aggregation</span></span>
<span id="cb37-162"><a href="#cb37-162" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-163"><a href="#cb37-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-164"><a href="#cb37-164" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily residuals to weekly firm-specific returns</span></span>
<span id="cb37-165"><a href="#cb37-165" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(firm_resids[<span class="st">"date"</span>])</span>
<span id="cb37-166"><a href="#cb37-166" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"week"</span>] <span class="op">=</span> firm_resids[<span class="st">"date"</span>].dt.isocalendar().week.astype(<span class="bu">int</span>)</span>
<span id="cb37-167"><a href="#cb37-167" aria-hidden="true" tabindex="-1"></a>firm_resids[<span class="st">"year"</span>] <span class="op">=</span> firm_resids[<span class="st">"date"</span>].dt.year</span>
<span id="cb37-168"><a href="#cb37-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-169"><a href="#cb37-169" aria-hidden="true" tabindex="-1"></a>weekly_returns <span class="op">=</span> (</span>
<span id="cb37-170"><a href="#cb37-170" aria-hidden="true" tabindex="-1"></a>    firm_resids.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>, <span class="st">"week"</span>])</span>
<span id="cb37-171"><a href="#cb37-171" aria-hidden="true" tabindex="-1"></a>    .agg(W<span class="op">=</span>(<span class="st">"resid"</span>, <span class="kw">lambda</span> x: np.log(<span class="dv">1</span> <span class="op">+</span> x.<span class="bu">sum</span>())))</span>
<span id="cb37-172"><a href="#cb37-172" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-173"><a href="#cb37-173" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-174"><a href="#cb37-174" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-175"><a href="#cb37-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-178"><a href="#cb37-178" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-179"><a href="#cb37-179" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crash-risk-measures</span></span>
<span id="cb37-180"><a href="#cb37-180" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-181"><a href="#cb37-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-182"><a href="#cb37-182" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_crash_measures(group):</span>
<span id="cb37-183"><a href="#cb37-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute NCSKEW, DUVOL, and CRASH count for one firm-year."""</span></span>
<span id="cb37-184"><a href="#cb37-184" aria-hidden="true" tabindex="-1"></a>    W <span class="op">=</span> group[<span class="st">"W"</span>].values</span>
<span id="cb37-185"><a href="#cb37-185" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(W)</span>
<span id="cb37-186"><a href="#cb37-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-187"><a href="#cb37-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n <span class="op">&lt;</span> <span class="dv">26</span>:  <span class="co"># Require at least 26 weeks</span></span>
<span id="cb37-188"><a href="#cb37-188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({</span>
<span id="cb37-189"><a href="#cb37-189" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ncskew"</span>: np.nan, <span class="st">"duvol"</span>: np.nan,</span>
<span id="cb37-190"><a href="#cb37-190" aria-hidden="true" tabindex="-1"></a>            <span class="st">"crash_count"</span>: np.nan, <span class="st">"n_weeks"</span>: n</span>
<span id="cb37-191"><a href="#cb37-191" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-192"><a href="#cb37-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-193"><a href="#cb37-193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># NCSKEW</span></span>
<span id="cb37-194"><a href="#cb37-194" aria-hidden="true" tabindex="-1"></a>    W_demean <span class="op">=</span> W <span class="op">-</span> W.mean()</span>
<span id="cb37-195"><a href="#cb37-195" aria-hidden="true" tabindex="-1"></a>    num <span class="op">=</span> n <span class="op">*</span> (n <span class="op">-</span> <span class="dv">1</span>)<span class="op">**</span><span class="fl">1.5</span> <span class="op">*</span> np.<span class="bu">sum</span>(W_demean<span class="op">**</span><span class="dv">3</span>)</span>
<span id="cb37-196"><a href="#cb37-196" aria-hidden="true" tabindex="-1"></a>    den <span class="op">=</span> (n <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> (n <span class="op">-</span> <span class="dv">2</span>) <span class="op">*</span> (np.<span class="bu">sum</span>(W_demean<span class="op">**</span><span class="dv">2</span>))<span class="op">**</span><span class="fl">1.5</span></span>
<span id="cb37-197"><a href="#cb37-197" aria-hidden="true" tabindex="-1"></a>    ncskew <span class="op">=</span> <span class="op">-</span>(num <span class="op">/</span> den) <span class="cf">if</span> den <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb37-198"><a href="#cb37-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-199"><a href="#cb37-199" aria-hidden="true" tabindex="-1"></a>    <span class="co"># DUVOL</span></span>
<span id="cb37-200"><a href="#cb37-200" aria-hidden="true" tabindex="-1"></a>    mean_W <span class="op">=</span> W.mean()</span>
<span id="cb37-201"><a href="#cb37-201" aria-hidden="true" tabindex="-1"></a>    down <span class="op">=</span> W[W <span class="op">&lt;</span> mean_W]</span>
<span id="cb37-202"><a href="#cb37-202" aria-hidden="true" tabindex="-1"></a>    up <span class="op">=</span> W[W <span class="op">&gt;=</span> mean_W]</span>
<span id="cb37-203"><a href="#cb37-203" aria-hidden="true" tabindex="-1"></a>    n_d, n_u <span class="op">=</span> <span class="bu">len</span>(down), <span class="bu">len</span>(up)</span>
<span id="cb37-204"><a href="#cb37-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-205"><a href="#cb37-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_d <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">and</span> n_u <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb37-206"><a href="#cb37-206" aria-hidden="true" tabindex="-1"></a>        duvol <span class="op">=</span> np.log(</span>
<span id="cb37-207"><a href="#cb37-207" aria-hidden="true" tabindex="-1"></a>            ((n_u <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.<span class="bu">sum</span>(down<span class="op">**</span><span class="dv">2</span>)) <span class="op">/</span></span>
<span id="cb37-208"><a href="#cb37-208" aria-hidden="true" tabindex="-1"></a>            ((n_d <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> np.<span class="bu">sum</span>(up<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb37-209"><a href="#cb37-209" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-210"><a href="#cb37-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-211"><a href="#cb37-211" aria-hidden="true" tabindex="-1"></a>        duvol <span class="op">=</span> np.nan</span>
<span id="cb37-212"><a href="#cb37-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-213"><a href="#cb37-213" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Crash count (k = 3.09)</span></span>
<span id="cb37-214"><a href="#cb37-214" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> W.mean() <span class="op">-</span> <span class="fl">3.09</span> <span class="op">*</span> W.std()</span>
<span id="cb37-215"><a href="#cb37-215" aria-hidden="true" tabindex="-1"></a>    crash_count <span class="op">=</span> <span class="bu">int</span>(np.<span class="bu">sum</span>(W <span class="op">&lt;</span> threshold))</span>
<span id="cb37-216"><a href="#cb37-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-217"><a href="#cb37-217" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({</span>
<span id="cb37-218"><a href="#cb37-218" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ncskew"</span>: ncskew,</span>
<span id="cb37-219"><a href="#cb37-219" aria-hidden="true" tabindex="-1"></a>        <span class="st">"duvol"</span>: duvol,</span>
<span id="cb37-220"><a href="#cb37-220" aria-hidden="true" tabindex="-1"></a>        <span class="st">"crash_count"</span>: crash_count,</span>
<span id="cb37-221"><a href="#cb37-221" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_weeks"</span>: n</span>
<span id="cb37-222"><a href="#cb37-222" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-223"><a href="#cb37-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-224"><a href="#cb37-224" aria-hidden="true" tabindex="-1"></a>crash_risk <span class="op">=</span> (</span>
<span id="cb37-225"><a href="#cb37-225" aria-hidden="true" tabindex="-1"></a>    weekly_returns.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb37-226"><a href="#cb37-226" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_crash_measures)</span>
<span id="cb37-227"><a href="#cb37-227" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-228"><a href="#cb37-228" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-229"><a href="#cb37-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-230"><a href="#cb37-230" aria-hidden="true" tabindex="-1"></a>crash_risk <span class="op">=</span> crash_risk.dropna(subset<span class="op">=</span>[<span class="st">"ncskew"</span>, <span class="st">"duvol"</span>])</span>
<span id="cb37-231"><a href="#cb37-231" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Crash risk panel: </span><span class="sc">{</span><span class="bu">len</span>(crash_risk)<span class="sc">}</span><span class="ss"> firm-years"</span>)</span>
<span id="cb37-232"><a href="#cb37-232" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-233"><a href="#cb37-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-234"><a href="#cb37-234" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cross-Sectional Distribution of Crash Risk</span></span>
<span id="cb37-235"><a href="#cb37-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-236"><a href="#cb37-236" aria-hidden="true" tabindex="-1"></a>@tbl-crash-summary presents summary statistics for the three crash risk measures across the Vietnamese equity market.</span>
<span id="cb37-237"><a href="#cb37-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-240"><a href="#cb37-240" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-241"><a href="#cb37-241" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-crash-summary</span></span>
<span id="cb37-242"><a href="#cb37-242" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-243"><a href="#cb37-243" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary Statistics of Crash Risk Measures"</span></span>
<span id="cb37-244"><a href="#cb37-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-245"><a href="#cb37-245" aria-hidden="true" tabindex="-1"></a>summary <span class="op">=</span> crash_risk[[<span class="st">"ncskew"</span>, <span class="st">"duvol"</span>, <span class="st">"crash_count"</span>]].describe(</span>
<span id="cb37-246"><a href="#cb37-246" aria-hidden="true" tabindex="-1"></a>    percentiles<span class="op">=</span>[<span class="fl">0.05</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.95</span>]</span>
<span id="cb37-247"><a href="#cb37-247" aria-hidden="true" tabindex="-1"></a>).T.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-248"><a href="#cb37-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-249"><a href="#cb37-249" aria-hidden="true" tabindex="-1"></a>summary.columns <span class="op">=</span> [<span class="st">"N"</span>, <span class="st">"Mean"</span>, <span class="st">"Std"</span>, <span class="st">"Min"</span>, <span class="st">"5%"</span>, <span class="st">"25%"</span>,</span>
<span id="cb37-250"><a href="#cb37-250" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"Median"</span>, <span class="st">"75%"</span>, <span class="st">"95%"</span>, <span class="st">"Max"</span>]</span>
<span id="cb37-251"><a href="#cb37-251" aria-hidden="true" tabindex="-1"></a>summary</span>
<span id="cb37-252"><a href="#cb37-252" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-253"><a href="#cb37-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-256"><a href="#cb37-256" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-257"><a href="#cb37-257" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ncskew-distribution</span></span>
<span id="cb37-258"><a href="#cb37-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-259"><a href="#cb37-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-Sectional Distribution of NCSKEW by Year"</span></span>
<span id="cb37-260"><a href="#cb37-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-261"><a href="#cb37-261" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> crash_risk[crash_risk[<span class="st">"year"</span>].between(<span class="dv">2012</span>, <span class="dv">2024</span>)].copy()</span>
<span id="cb37-262"><a href="#cb37-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-263"><a href="#cb37-263" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-264"><a href="#cb37-264" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_data, p9.aes(x<span class="op">=</span><span class="st">"ncskew"</span>))</span>
<span id="cb37-265"><a href="#cb37-265" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb37-266"><a href="#cb37-266" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.facet_wrap(<span class="st">"~year"</span>, scales<span class="op">=</span><span class="st">"free_y"</span>, ncol<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb37-267"><a href="#cb37-267" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb37-268"><a href="#cb37-268" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-269"><a href="#cb37-269" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"NCSKEW"</span>,</span>
<span id="cb37-270"><a href="#cb37-270" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb37-271"><a href="#cb37-271" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Firm-Level Crash Risk (NCSKEW)"</span></span>
<span id="cb37-272"><a href="#cb37-272" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-273"><a href="#cb37-273" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-274"><a href="#cb37-274" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb37-275"><a href="#cb37-275" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-276"><a href="#cb37-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-277"><a href="#cb37-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-278"><a href="#cb37-278" aria-hidden="true" tabindex="-1"></a>The rightward shift of the NCSKEW distribution during crisis episodes, particularly in 2020 and 2022, indicates a market-wide increase in crash risk. The red dashed line at zero separates firms with negative skewness (right of zero, i.e., high NCSKEW since the measure is negated) from those with positive skewness.</span>
<span id="cb37-279"><a href="#cb37-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-280"><a href="#cb37-280" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation in Asset Pricing</span></span>
<span id="cb37-281"><a href="#cb37-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-282"><a href="#cb37-282" aria-hidden="true" tabindex="-1"></a>Crash risk has first-order implications for asset pricing. @harvey2000conditional demonstrate that coskewness (i.e., the contribution of an individual asset to the skewness of the aggregate market portfolio) is priced in the cross-section of expected returns. Specifically, assets that tend to crash when the market crashes (negative coskewness) should command a risk premium.</span>
<span id="cb37-283"><a href="#cb37-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-284"><a href="#cb37-284" aria-hidden="true" tabindex="-1"></a>The coskewness of stock $i$ with the market is:</span>
<span id="cb37-285"><a href="#cb37-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-286"><a href="#cb37-286" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-287"><a href="#cb37-287" aria-hidden="true" tabindex="-1"></a>\text{CoSkew}_i = \frac{E\left<span class="co">[</span><span class="ot">(r_i - \mu_i)(r_m - \mu_m)^2\right</span><span class="co">]</span>}{\sigma_i \cdot \sigma_m^2}</span>
<span id="cb37-288"><a href="#cb37-288" aria-hidden="true" tabindex="-1"></a>$$ {#eq-coskewness}</span>
<span id="cb37-289"><a href="#cb37-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-290"><a href="#cb37-290" aria-hidden="true" tabindex="-1"></a>Stocks with more negative coskewness exhibit disproportionately poor performance during market downturns. In Vietnam, this is especially relevant because: (1) retail investor herding amplifies co-movement during selloffs; (2) price limits delay crash completion, spreading crash risk across multiple days; and (3) state-owned enterprises, which constitute a large fraction of market capitalization, may exhibit coordinated crash behavior driven by common policy shocks.</span>
<span id="cb37-291"><a href="#cb37-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-294"><a href="#cb37-294" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-295"><a href="#cb37-295" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: coskewness-estimation</span></span>
<span id="cb37-296"><a href="#cb37-296" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-297"><a href="#cb37-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-298"><a href="#cb37-298" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_coskewness(group):</span>
<span id="cb37-299"><a href="#cb37-299" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate coskewness for a firm-year."""</span></span>
<span id="cb37-300"><a href="#cb37-300" aria-hidden="true" tabindex="-1"></a>    r_i <span class="op">=</span> group[<span class="st">"ret"</span>].values</span>
<span id="cb37-301"><a href="#cb37-301" aria-hidden="true" tabindex="-1"></a>    r_m <span class="op">=</span> group[<span class="st">"mkt_ret"</span>].values</span>
<span id="cb37-302"><a href="#cb37-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-303"><a href="#cb37-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(r_i) <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb37-304"><a href="#cb37-304" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb37-305"><a href="#cb37-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-306"><a href="#cb37-306" aria-hidden="true" tabindex="-1"></a>    r_i_dm <span class="op">=</span> r_i <span class="op">-</span> r_i.mean()</span>
<span id="cb37-307"><a href="#cb37-307" aria-hidden="true" tabindex="-1"></a>    r_m_dm <span class="op">=</span> r_m <span class="op">-</span> r_m.mean()</span>
<span id="cb37-308"><a href="#cb37-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-309"><a href="#cb37-309" aria-hidden="true" tabindex="-1"></a>    coskew <span class="op">=</span> (</span>
<span id="cb37-310"><a href="#cb37-310" aria-hidden="true" tabindex="-1"></a>        np.mean(r_i_dm <span class="op">*</span> r_m_dm<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span></span>
<span id="cb37-311"><a href="#cb37-311" aria-hidden="true" tabindex="-1"></a>        (np.std(r_i) <span class="op">*</span> np.std(r_m)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb37-312"><a href="#cb37-312" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-313"><a href="#cb37-313" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> coskew</span>
<span id="cb37-314"><a href="#cb37-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-315"><a href="#cb37-315" aria-hidden="true" tabindex="-1"></a>df_coskew <span class="op">=</span> (</span>
<span id="cb37-316"><a href="#cb37-316" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb37-317"><a href="#cb37-317" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: pd.Series({<span class="st">"coskewness"</span>: compute_coskewness(g)}))</span>
<span id="cb37-318"><a href="#cb37-318" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-319"><a href="#cb37-319" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb37-320"><a href="#cb37-320" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-321"><a href="#cb37-321" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-322"><a href="#cb37-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-325"><a href="#cb37-325" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-326"><a href="#cb37-326" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-coskew-time</span></span>
<span id="cb37-327"><a href="#cb37-327" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-Sectional Median Coskewness Over Time"</span></span>
<span id="cb37-328"><a href="#cb37-328" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-329"><a href="#cb37-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-330"><a href="#cb37-330" aria-hidden="true" tabindex="-1"></a>median_coskew <span class="op">=</span> (</span>
<span id="cb37-331"><a href="#cb37-331" aria-hidden="true" tabindex="-1"></a>    df_coskew.groupby(<span class="st">"year"</span>)</span>
<span id="cb37-332"><a href="#cb37-332" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb37-333"><a href="#cb37-333" aria-hidden="true" tabindex="-1"></a>        median_coskew<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="st">"median"</span>),</span>
<span id="cb37-334"><a href="#cb37-334" aria-hidden="true" tabindex="-1"></a>        q25<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>)),</span>
<span id="cb37-335"><a href="#cb37-335" aria-hidden="true" tabindex="-1"></a>        q75<span class="op">=</span>(<span class="st">"coskewness"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>))</span>
<span id="cb37-336"><a href="#cb37-336" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-337"><a href="#cb37-337" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-338"><a href="#cb37-338" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-339"><a href="#cb37-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-340"><a href="#cb37-340" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-341"><a href="#cb37-341" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(median_coskew, p9.aes(x<span class="op">=</span><span class="st">"year"</span>))</span>
<span id="cb37-342"><a href="#cb37-342" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb37-343"><a href="#cb37-343" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"q25"</span>, ymax<span class="op">=</span><span class="st">"q75"</span>),</span>
<span id="cb37-344"><a href="#cb37-344" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb37-345"><a href="#cb37-345" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-346"><a href="#cb37-346" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(p9.aes(y<span class="op">=</span><span class="st">"median_coskew"</span>), color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-347"><a href="#cb37-347" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb37-348"><a href="#cb37-348" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-349"><a href="#cb37-349" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb37-350"><a href="#cb37-350" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Coskewness"</span>,</span>
<span id="cb37-351"><a href="#cb37-351" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Coskewness: Median and Interquartile Range"</span></span>
<span id="cb37-352"><a href="#cb37-352" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-353"><a href="#cb37-353" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-354"><a href="#cb37-354" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb37-355"><a href="#cb37-355" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-356"><a href="#cb37-356" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-357"><a href="#cb37-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-358"><a href="#cb37-358" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downside Tail Concentration</span></span>
<span id="cb37-359"><a href="#cb37-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-360"><a href="#cb37-360" aria-hidden="true" tabindex="-1"></a>Beyond skewness, the concentration of returns in the extreme left tail provides additional diagnostic information. We define the downside tail concentration ratio as the fraction of total return variance attributable to observations below the $p$-th percentile:</span>
<span id="cb37-361"><a href="#cb37-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-362"><a href="#cb37-362" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-363"><a href="#cb37-363" aria-hidden="true" tabindex="-1"></a>\text{TCR}_p = \frac{\sum_{r_{i,t} &lt; q_p} (r_{i,t} - \bar{r}_i)^2}{\sum_t (r_{i,t} - \bar{r}_i)^2}</span>
<span id="cb37-364"><a href="#cb37-364" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tail-concentration}</span>
<span id="cb37-365"><a href="#cb37-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-366"><a href="#cb37-366" aria-hidden="true" tabindex="-1"></a>where $q_p$ is the $p$-th percentile of the firm's return distribution. Under a symmetric distribution, $\text{TCR}_{5\%}$ would be close to $5\%$ (with a slight upward bias due to the squaring). Values substantially exceeding $5\%$ indicate that the left tail contributes disproportionately to total risk.</span>
<span id="cb37-367"><a href="#cb37-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-370"><a href="#cb37-370" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-371"><a href="#cb37-371" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tail-concentration</span></span>
<span id="cb37-372"><a href="#cb37-372" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-373"><a href="#cb37-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-374"><a href="#cb37-374" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tail_concentration_ratio(returns, p<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb37-375"><a href="#cb37-375" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute tail concentration ratio at percentile p."""</span></span>
<span id="cb37-376"><a href="#cb37-376" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> np.quantile(returns, p)</span>
<span id="cb37-377"><a href="#cb37-377" aria-hidden="true" tabindex="-1"></a>    r_dm <span class="op">=</span> returns <span class="op">-</span> returns.mean()</span>
<span id="cb37-378"><a href="#cb37-378" aria-hidden="true" tabindex="-1"></a>    total_var <span class="op">=</span> np.<span class="bu">sum</span>(r_dm<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb37-379"><a href="#cb37-379" aria-hidden="true" tabindex="-1"></a>    tail_var <span class="op">=</span> np.<span class="bu">sum</span>(r_dm[returns <span class="op">&lt;</span> q]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb37-380"><a href="#cb37-380" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tail_var <span class="op">/</span> total_var <span class="cf">if</span> total_var <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb37-381"><a href="#cb37-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-382"><a href="#cb37-382" aria-hidden="true" tabindex="-1"></a>tcr <span class="op">=</span> (</span>
<span id="cb37-383"><a href="#cb37-383" aria-hidden="true" tabindex="-1"></a>    df.groupby([<span class="st">"ticker"</span>, <span class="st">"year"</span>])</span>
<span id="cb37-384"><a href="#cb37-384" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb37-385"><a href="#cb37-385" aria-hidden="true" tabindex="-1"></a>        tcr_5<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: tail_concentration_ratio(x.values, <span class="fl">0.05</span>)),</span>
<span id="cb37-386"><a href="#cb37-386" aria-hidden="true" tabindex="-1"></a>        tcr_1<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: tail_concentration_ratio(x.values, <span class="fl">0.01</span>)),</span>
<span id="cb37-387"><a href="#cb37-387" aria-hidden="true" tabindex="-1"></a>        n_obs<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"count"</span>)</span>
<span id="cb37-388"><a href="#cb37-388" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-389"><a href="#cb37-389" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-390"><a href="#cb37-390" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n_obs &gt;= 120"</span>)</span>
<span id="cb37-391"><a href="#cb37-391" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-392"><a href="#cb37-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-393"><a href="#cb37-393" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Median TCR(5%):"</span>, <span class="bu">round</span>(tcr[<span class="st">"tcr_5"</span>].median(), <span class="dv">4</span>))</span>
<span id="cb37-394"><a href="#cb37-394" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Median TCR(1%):"</span>, <span class="bu">round</span>(tcr[<span class="st">"tcr_1"</span>].median(), <span class="dv">4</span>))</span>
<span id="cb37-395"><a href="#cb37-395" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-396"><a href="#cb37-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-397"><a href="#cb37-397" aria-hidden="true" tabindex="-1"></a><span class="fu">## Value at Risk and Expected Shortfall</span></span>
<span id="cb37-398"><a href="#cb37-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-399"><a href="#cb37-399" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definitions</span></span>
<span id="cb37-400"><a href="#cb37-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-401"><a href="#cb37-401" aria-hidden="true" tabindex="-1"></a>Value at Risk (VaR) and Expected Shortfall (ES) are the two principal quantile-based risk measures used in financial regulation and internal risk management. For a portfolio return $r$ with the cumulative distribution function $F$, the VaR at confidence level $\alpha$ is:</span>
<span id="cb37-402"><a href="#cb37-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-403"><a href="#cb37-403" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-404"><a href="#cb37-404" aria-hidden="true" tabindex="-1"></a>\text{VaR}_\alpha = -F^{-1}(\alpha) = -\inf<span class="sc">\{</span>x : F(x) \geq \alpha<span class="sc">\}</span></span>
<span id="cb37-405"><a href="#cb37-405" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var-def}</span>
<span id="cb37-406"><a href="#cb37-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-407"><a href="#cb37-407" aria-hidden="true" tabindex="-1"></a>This is simply the negative of the $\alpha$-quantile of the return distribution. For $\alpha = 0.01$, $\text{VaR}_{1\%}$ answers: "What is the loss that is exceeded with only 1% probability?"</span>
<span id="cb37-408"><a href="#cb37-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-409"><a href="#cb37-409" aria-hidden="true" tabindex="-1"></a>Expected Shortfall (also called Conditional VaR or CVaR) is the expected loss conditional on the loss exceeding VaR:</span>
<span id="cb37-410"><a href="#cb37-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-411"><a href="#cb37-411" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-412"><a href="#cb37-412" aria-hidden="true" tabindex="-1"></a>\text{ES}_\alpha = -\frac{1}{\alpha}\int_0^\alpha F^{-1}(u) \, du = -E\left[r \mid r \leq -\text{VaR}_\alpha\right]</span>
<span id="cb37-413"><a href="#cb37-413" aria-hidden="true" tabindex="-1"></a>$$ {#eq-es-def}</span>
<span id="cb37-414"><a href="#cb37-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-415"><a href="#cb37-415" aria-hidden="true" tabindex="-1"></a>For continuous distributions, ES simplifies to the conditional expectation in @eq-es-def. ES is always at least as large as VaR ($\text{ES}_\alpha \geq \text{VaR}_\alpha$) and is strictly larger whenever the distribution has any mass beyond the VaR quantile.</span>
<span id="cb37-416"><a href="#cb37-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-417"><a href="#cb37-417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Expected Shortfall Dominates VaR</span></span>
<span id="cb37-418"><a href="#cb37-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-419"><a href="#cb37-419" aria-hidden="true" tabindex="-1"></a>@tbl-tail-riskvar-vs-es summarizes the fundamental differences.</span>
<span id="cb37-420"><a href="#cb37-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-421"><a href="#cb37-421" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Property <span class="pp">|</span> VaR <span class="pp">|</span> Expected Shortfall <span class="pp">|</span></span>
<span id="cb37-422"><a href="#cb37-422" aria-hidden="true" tabindex="-1"></a><span class="pp">|-------------------|-------------------|----------------------------------|</span></span>
<span id="cb37-423"><a href="#cb37-423" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Definition <span class="pp">|</span> Quantile of the loss distribution <span class="pp">|</span> Conditional mean loss beyond VaR <span class="pp">|</span></span>
<span id="cb37-424"><a href="#cb37-424" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Tail information <span class="pp">|</span> None beyond the quantile <span class="pp">|</span> Captures severity of tail losses <span class="pp">|</span></span>
<span id="cb37-425"><a href="#cb37-425" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Subadditivity <span class="pp">|</span> Not subadditive in general <span class="pp">|</span> Subadditive (coherent risk measure) <span class="pp">|</span></span>
<span id="cb37-426"><a href="#cb37-426" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Regulatory status <span class="pp">|</span> Basel II primary measure <span class="pp">|</span> Basel III/IV primary measure <span class="pp">|</span></span>
<span id="cb37-427"><a href="#cb37-427" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Backtesting <span class="pp">|</span> Binary: breach or no breach <span class="pp">|</span> Continuous: requires severity assessment <span class="pp">|</span></span>
<span id="cb37-428"><a href="#cb37-428" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Sensitivity to tail shape <span class="pp">|</span> None <span class="pp">|</span> Directly sensitive <span class="pp">|</span></span>
<span id="cb37-429"><a href="#cb37-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-430"><a href="#cb37-430" aria-hidden="true" tabindex="-1"></a>: Comparison of VaR and Expected Shortfall {#tbl-tail-riskvar-vs-es}</span>
<span id="cb37-431"><a href="#cb37-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-432"><a href="#cb37-432" aria-hidden="true" tabindex="-1"></a>The critical deficiency of VaR is the absence of subadditivity. A risk measure $\rho$ is subadditive if $\rho(X + Y) \leq \rho(X) + \rho(Y)$ for all portfolios $X, Y$. VaR violates this condition for non-elliptical distributions, meaning that diversification can appear to increase risk under VaR, which is a perverse result. @artzner1999coherent established the axiomatic framework for coherent risk measures, and ES satisfies all four axioms: monotonicity, translation invariance, positive homogeneity, and subadditivity. VaR satisfies only three.</span>
<span id="cb37-433"><a href="#cb37-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-434"><a href="#cb37-434" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimation Methods</span></span>
<span id="cb37-435"><a href="#cb37-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-436"><a href="#cb37-436" aria-hidden="true" tabindex="-1"></a>We implement four approaches to VaR and ES estimation, each with distinct assumptions and data requirements.</span>
<span id="cb37-437"><a href="#cb37-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-438"><a href="#cb37-438" aria-hidden="true" tabindex="-1"></a>**Method 1: Historical Simulation**</span>
<span id="cb37-439"><a href="#cb37-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-440"><a href="#cb37-440" aria-hidden="true" tabindex="-1"></a>The simplest nonparametric approach uses the empirical distribution directly:</span>
<span id="cb37-441"><a href="#cb37-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-442"><a href="#cb37-442" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-443"><a href="#cb37-443" aria-hidden="true" tabindex="-1"></a>\widehat{\text{VaR}}_\alpha^{\text{HS}} = -\hat{F}_n^{-1}(\alpha) = -r_{(\lceil n\alpha \rceil)}</span>
<span id="cb37-444"><a href="#cb37-444" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var-hs}</span>
<span id="cb37-445"><a href="#cb37-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-446"><a href="#cb37-446" aria-hidden="true" tabindex="-1"></a>where $r_{(k)}$ is the $k$-th order statistic of the return sample. ES is the average of all returns below the VaR:</span>
<span id="cb37-447"><a href="#cb37-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-448"><a href="#cb37-448" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-449"><a href="#cb37-449" aria-hidden="true" tabindex="-1"></a>\widehat{\text{ES}}_\alpha^{\text{HS}} = -\frac{1}{\lfloor n\alpha \rfloor}\sum_{k=1}^{\lfloor n\alpha \rfloor} r_{(k)}</span>
<span id="cb37-450"><a href="#cb37-450" aria-hidden="true" tabindex="-1"></a>$$ {#eq-es-hs}</span>
<span id="cb37-451"><a href="#cb37-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-452"><a href="#cb37-452" aria-hidden="true" tabindex="-1"></a>**Method 2: Parametric (Gaussian)**</span>
<span id="cb37-453"><a href="#cb37-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-454"><a href="#cb37-454" aria-hidden="true" tabindex="-1"></a>Assume $r_t \sim N(\mu, \sigma^2)$. Then:</span>
<span id="cb37-455"><a href="#cb37-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-456"><a href="#cb37-456" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-457"><a href="#cb37-457" aria-hidden="true" tabindex="-1"></a>\text{VaR}_\alpha^{\text{Gauss}} = -(\hat{\mu} + \hat{\sigma} \cdot \Phi^{-1}(\alpha))</span>
<span id="cb37-458"><a href="#cb37-458" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var-gauss}</span>
<span id="cb37-459"><a href="#cb37-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-460"><a href="#cb37-460" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-461"><a href="#cb37-461" aria-hidden="true" tabindex="-1"></a>\text{ES}_\alpha^{\text{Gauss}} = -\hat{\mu} + \hat{\sigma} \cdot \frac{\phi(\Phi^{-1}(\alpha))}{\alpha}</span>
<span id="cb37-462"><a href="#cb37-462" aria-hidden="true" tabindex="-1"></a>$$ {#eq-es-gauss}</span>
<span id="cb37-463"><a href="#cb37-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-464"><a href="#cb37-464" aria-hidden="true" tabindex="-1"></a>where $\Phi$ and $\phi$ are the standard normal CDF and PDF, respectively. The Gaussian assumption is known to underestimate tail risk for equity returns, but provides a useful baseline.</span>
<span id="cb37-465"><a href="#cb37-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-466"><a href="#cb37-466" aria-hidden="true" tabindex="-1"></a>**Method 3: Parametric (Student-**$t$)</span>
<span id="cb37-467"><a href="#cb37-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-468"><a href="#cb37-468" aria-hidden="true" tabindex="-1"></a>The Student-$t$ distribution with $\nu$ degrees of freedom captures excess kurtosis. The VaR and ES are:</span>
<span id="cb37-469"><a href="#cb37-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-470"><a href="#cb37-470" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-471"><a href="#cb37-471" aria-hidden="true" tabindex="-1"></a>\text{VaR}_\alpha^{t} = -\left(\hat{\mu} + \hat{\sigma}\sqrt{\frac{\nu - 2}{\nu}} \cdot t_\nu^{-1}(\alpha)\right)</span>
<span id="cb37-472"><a href="#cb37-472" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var-t}</span>
<span id="cb37-473"><a href="#cb37-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-474"><a href="#cb37-474" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-475"><a href="#cb37-475" aria-hidden="true" tabindex="-1"></a>\text{ES}_\alpha^{t} = -\hat{\mu} + \hat{\sigma}\sqrt{\frac{\nu-2}{\nu}} \cdot \frac{f_{t_\nu}(t_\nu^{-1}(\alpha))}{\alpha} \cdot \frac{\nu + (t_\nu^{-1}(\alpha))^2}{\nu - 1}</span>
<span id="cb37-476"><a href="#cb37-476" aria-hidden="true" tabindex="-1"></a>$$ {#eq-es-t}</span>
<span id="cb37-477"><a href="#cb37-477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-478"><a href="#cb37-478" aria-hidden="true" tabindex="-1"></a>where $t_\nu^{-1}$ and $f_{t_\nu}$ are the quantile function and PDF of the Student-$t$ distribution.</span>
<span id="cb37-479"><a href="#cb37-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-480"><a href="#cb37-480" aria-hidden="true" tabindex="-1"></a>**Method 4: GARCH-Filtered EVT (Semi-Parametric)**</span>
<span id="cb37-481"><a href="#cb37-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-482"><a href="#cb37-482" aria-hidden="true" tabindex="-1"></a>This approach, developed by @mcneil2000estimation, first filters returns through a GARCH(1,1) model to obtain standardized residuals $z_t = \hat{\varepsilon}_t / \hat{\sigma}_t$, then fits a Generalized Pareto Distribution (GPD) to the lower tail of the standardized residuals. We detail the EVT component in @sec-evt.</span>
<span id="cb37-483"><a href="#cb37-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-486"><a href="#cb37-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-487"><a href="#cb37-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: var-es-estimation</span></span>
<span id="cb37-488"><a href="#cb37-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-489"><a href="#cb37-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-490"><a href="#cb37-490" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_var_es(returns, alpha<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb37-491"><a href="#cb37-491" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-492"><a href="#cb37-492" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate VaR and ES at level alpha using four methods.</span></span>
<span id="cb37-493"><a href="#cb37-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-494"><a href="#cb37-494" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb37-495"><a href="#cb37-495" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb37-496"><a href="#cb37-496" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : array-like</span></span>
<span id="cb37-497"><a href="#cb37-497" aria-hidden="true" tabindex="-1"></a><span class="co">        Return series.</span></span>
<span id="cb37-498"><a href="#cb37-498" aria-hidden="true" tabindex="-1"></a><span class="co">    alpha : float</span></span>
<span id="cb37-499"><a href="#cb37-499" aria-hidden="true" tabindex="-1"></a><span class="co">        Tail probability (e.g., 0.01 for 1%).</span></span>
<span id="cb37-500"><a href="#cb37-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-501"><a href="#cb37-501" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-502"><a href="#cb37-502" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-503"><a href="#cb37-503" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : VaR and ES estimates for each method.</span></span>
<span id="cb37-504"><a href="#cb37-504" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-505"><a href="#cb37-505" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> np.array(returns)</span>
<span id="cb37-506"><a href="#cb37-506" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> r[<span class="op">~</span>np.isnan(r)]</span>
<span id="cb37-507"><a href="#cb37-507" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(r)</span>
<span id="cb37-508"><a href="#cb37-508" aria-hidden="true" tabindex="-1"></a>    mu, sigma <span class="op">=</span> r.mean(), r.std(ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-509"><a href="#cb37-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-510"><a href="#cb37-510" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb37-511"><a href="#cb37-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-512"><a href="#cb37-512" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 1: Historical simulation</span></span>
<span id="cb37-513"><a href="#cb37-513" aria-hidden="true" tabindex="-1"></a>    sorted_r <span class="op">=</span> np.sort(r)</span>
<span id="cb37-514"><a href="#cb37-514" aria-hidden="true" tabindex="-1"></a>    idx <span class="op">=</span> <span class="bu">int</span>(np.ceil(n <span class="op">*</span> alpha))</span>
<span id="cb37-515"><a href="#cb37-515" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"var_hs"</span>] <span class="op">=</span> <span class="op">-</span>sorted_r[idx <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb37-516"><a href="#cb37-516" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"es_hs"</span>] <span class="op">=</span> <span class="op">-</span>sorted_r[:idx].mean()</span>
<span id="cb37-517"><a href="#cb37-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-518"><a href="#cb37-518" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 2: Gaussian</span></span>
<span id="cb37-519"><a href="#cb37-519" aria-hidden="true" tabindex="-1"></a>    z_alpha <span class="op">=</span> stats.norm.ppf(alpha)</span>
<span id="cb37-520"><a href="#cb37-520" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"var_gauss"</span>] <span class="op">=</span> <span class="op">-</span>(mu <span class="op">+</span> sigma <span class="op">*</span> z_alpha)</span>
<span id="cb37-521"><a href="#cb37-521" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">"es_gauss"</span>] <span class="op">=</span> <span class="op">-</span>mu <span class="op">+</span> sigma <span class="op">*</span> stats.norm.pdf(z_alpha) <span class="op">/</span> alpha</span>
<span id="cb37-522"><a href="#cb37-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-523"><a href="#cb37-523" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Method 3: Student-t (MLE for degrees of freedom)</span></span>
<span id="cb37-524"><a href="#cb37-524" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb37-525"><a href="#cb37-525" aria-hidden="true" tabindex="-1"></a>        nu, loc, scale <span class="op">=</span> stats.t.fit(r)</span>
<span id="cb37-526"><a href="#cb37-526" aria-hidden="true" tabindex="-1"></a>        t_alpha <span class="op">=</span> stats.t.ppf(alpha, df<span class="op">=</span>nu)</span>
<span id="cb37-527"><a href="#cb37-527" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"var_t"</span>] <span class="op">=</span> <span class="op">-</span>(loc <span class="op">+</span> scale <span class="op">*</span> t_alpha)</span>
<span id="cb37-528"><a href="#cb37-528" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"es_t"</span>] <span class="op">=</span> (</span>
<span id="cb37-529"><a href="#cb37-529" aria-hidden="true" tabindex="-1"></a>            <span class="op">-</span>loc <span class="op">+</span> scale <span class="op">*</span></span>
<span id="cb37-530"><a href="#cb37-530" aria-hidden="true" tabindex="-1"></a>            (stats.t.pdf(t_alpha, df<span class="op">=</span>nu) <span class="op">/</span> alpha) <span class="op">*</span></span>
<span id="cb37-531"><a href="#cb37-531" aria-hidden="true" tabindex="-1"></a>            ((nu <span class="op">+</span> t_alpha<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> (nu <span class="op">-</span> <span class="dv">1</span>))</span>
<span id="cb37-532"><a href="#cb37-532" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-533"><a href="#cb37-533" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"nu_hat"</span>] <span class="op">=</span> nu</span>
<span id="cb37-534"><a href="#cb37-534" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb37-535"><a href="#cb37-535" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"var_t"</span>] <span class="op">=</span> np.nan</span>
<span id="cb37-536"><a href="#cb37-536" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"es_t"</span>] <span class="op">=</span> np.nan</span>
<span id="cb37-537"><a href="#cb37-537" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">"nu_hat"</span>] <span class="op">=</span> np.nan</span>
<span id="cb37-538"><a href="#cb37-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-539"><a href="#cb37-539" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb37-540"><a href="#cb37-540" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-541"><a href="#cb37-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-544"><a href="#cb37-544" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-545"><a href="#cb37-545" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: market-var-es</span></span>
<span id="cb37-546"><a href="#cb37-546" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-547"><a href="#cb37-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-548"><a href="#cb37-548" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute VaR and ES for the aggregate market index</span></span>
<span id="cb37-549"><a href="#cb37-549" aria-hidden="true" tabindex="-1"></a>market_daily <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb37-550"><a href="#cb37-550" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb37-551"><a href="#cb37-551" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb37-552"><a href="#cb37-552" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb37-553"><a href="#cb37-553" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-554"><a href="#cb37-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-555"><a href="#cb37-555" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 1-year VaR/ES</span></span>
<span id="cb37-556"><a href="#cb37-556" aria-hidden="true" tabindex="-1"></a>window <span class="op">=</span> <span class="dv">252</span></span>
<span id="cb37-557"><a href="#cb37-557" aria-hidden="true" tabindex="-1"></a>results_list <span class="op">=</span> []</span>
<span id="cb37-558"><a href="#cb37-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-559"><a href="#cb37-559" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> end_idx <span class="kw">in</span> <span class="bu">range</span>(window, <span class="bu">len</span>(market_daily)):</span>
<span id="cb37-560"><a href="#cb37-560" aria-hidden="true" tabindex="-1"></a>    window_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].iloc[end_idx <span class="op">-</span> window:end_idx].values</span>
<span id="cb37-561"><a href="#cb37-561" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> market_daily[<span class="st">"date"</span>].iloc[end_idx]</span>
<span id="cb37-562"><a href="#cb37-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-563"><a href="#cb37-563" aria-hidden="true" tabindex="-1"></a>    est <span class="op">=</span> estimate_var_es(window_returns, alpha<span class="op">=</span><span class="fl">0.01</span>)</span>
<span id="cb37-564"><a href="#cb37-564" aria-hidden="true" tabindex="-1"></a>    est[<span class="st">"date"</span>] <span class="op">=</span> date</span>
<span id="cb37-565"><a href="#cb37-565" aria-hidden="true" tabindex="-1"></a>    results_list.append(est)</span>
<span id="cb37-566"><a href="#cb37-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-567"><a href="#cb37-567" aria-hidden="true" tabindex="-1"></a>var_es_ts <span class="op">=</span> pd.DataFrame(results_list)</span>
<span id="cb37-568"><a href="#cb37-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-569"><a href="#cb37-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-572"><a href="#cb37-572" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-573"><a href="#cb37-573" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-var-comparison</span></span>
<span id="cb37-574"><a href="#cb37-574" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-575"><a href="#cb37-575" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rolling 1% VaR Estimates: Historical, Gaussian, and Student-t Methods"</span></span>
<span id="cb37-576"><a href="#cb37-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-577"><a href="#cb37-577" aria-hidden="true" tabindex="-1"></a>plot_var <span class="op">=</span> var_es_ts.melt(</span>
<span id="cb37-578"><a href="#cb37-578" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb37-579"><a href="#cb37-579" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"var_hs"</span>, <span class="st">"var_gauss"</span>, <span class="st">"var_t"</span>],</span>
<span id="cb37-580"><a href="#cb37-580" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">"method"</span>,</span>
<span id="cb37-581"><a href="#cb37-581" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"var"</span></span>
<span id="cb37-582"><a href="#cb37-582" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-583"><a href="#cb37-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-584"><a href="#cb37-584" aria-hidden="true" tabindex="-1"></a>method_labels <span class="op">=</span> {</span>
<span id="cb37-585"><a href="#cb37-585" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_hs"</span>: <span class="st">"Historical Simulation"</span>,</span>
<span id="cb37-586"><a href="#cb37-586" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_gauss"</span>: <span class="st">"Gaussian"</span>,</span>
<span id="cb37-587"><a href="#cb37-587" aria-hidden="true" tabindex="-1"></a>    <span class="st">"var_t"</span>: <span class="st">"Student-t"</span></span>
<span id="cb37-588"><a href="#cb37-588" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-589"><a href="#cb37-589" aria-hidden="true" tabindex="-1"></a>plot_var[<span class="st">"method"</span>] <span class="op">=</span> plot_var[<span class="st">"method"</span>].<span class="bu">map</span>(method_labels)</span>
<span id="cb37-590"><a href="#cb37-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-591"><a href="#cb37-591" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-592"><a href="#cb37-592" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_var, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"var"</span>, color<span class="op">=</span><span class="st">"method"</span>))</span>
<span id="cb37-593"><a href="#cb37-593" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-594"><a href="#cb37-594" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-595"><a href="#cb37-595" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"1% VaR (Loss)"</span>,</span>
<span id="cb37-596"><a href="#cb37-596" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling 252-Day Value at Risk Estimates"</span>,</span>
<span id="cb37-597"><a href="#cb37-597" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Method"</span></span>
<span id="cb37-598"><a href="#cb37-598" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-599"><a href="#cb37-599" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb37-600"><a href="#cb37-600" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>]</span>
<span id="cb37-601"><a href="#cb37-601" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-602"><a href="#cb37-602" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-603"><a href="#cb37-603" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb37-604"><a href="#cb37-604" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-605"><a href="#cb37-605" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-606"><a href="#cb37-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-609"><a href="#cb37-609" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-610"><a href="#cb37-610" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-es-comparison</span></span>
<span id="cb37-611"><a href="#cb37-611" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-612"><a href="#cb37-612" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rolling 1% Expected Shortfall Estimates"</span></span>
<span id="cb37-613"><a href="#cb37-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-614"><a href="#cb37-614" aria-hidden="true" tabindex="-1"></a>plot_es <span class="op">=</span> var_es_ts.melt(</span>
<span id="cb37-615"><a href="#cb37-615" aria-hidden="true" tabindex="-1"></a>    id_vars<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb37-616"><a href="#cb37-616" aria-hidden="true" tabindex="-1"></a>    value_vars<span class="op">=</span>[<span class="st">"es_hs"</span>, <span class="st">"es_gauss"</span>, <span class="st">"es_t"</span>],</span>
<span id="cb37-617"><a href="#cb37-617" aria-hidden="true" tabindex="-1"></a>    var_name<span class="op">=</span><span class="st">"method"</span>,</span>
<span id="cb37-618"><a href="#cb37-618" aria-hidden="true" tabindex="-1"></a>    value_name<span class="op">=</span><span class="st">"es"</span></span>
<span id="cb37-619"><a href="#cb37-619" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-620"><a href="#cb37-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-621"><a href="#cb37-621" aria-hidden="true" tabindex="-1"></a>method_labels_es <span class="op">=</span> {</span>
<span id="cb37-622"><a href="#cb37-622" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_hs"</span>: <span class="st">"Historical Simulation"</span>,</span>
<span id="cb37-623"><a href="#cb37-623" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_gauss"</span>: <span class="st">"Gaussian"</span>,</span>
<span id="cb37-624"><a href="#cb37-624" aria-hidden="true" tabindex="-1"></a>    <span class="st">"es_t"</span>: <span class="st">"Student-t"</span></span>
<span id="cb37-625"><a href="#cb37-625" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-626"><a href="#cb37-626" aria-hidden="true" tabindex="-1"></a>plot_es[<span class="st">"method"</span>] <span class="op">=</span> plot_es[<span class="st">"method"</span>].<span class="bu">map</span>(method_labels_es)</span>
<span id="cb37-627"><a href="#cb37-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-628"><a href="#cb37-628" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-629"><a href="#cb37-629" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_es, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"es"</span>, color<span class="op">=</span><span class="st">"method"</span>))</span>
<span id="cb37-630"><a href="#cb37-630" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>, size<span class="op">=</span><span class="fl">0.6</span>)</span>
<span id="cb37-631"><a href="#cb37-631" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-632"><a href="#cb37-632" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"1</span><span class="sc">% E</span><span class="st">S (Loss)"</span>,</span>
<span id="cb37-633"><a href="#cb37-633" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling 252-Day Expected Shortfall Estimates"</span>,</span>
<span id="cb37-634"><a href="#cb37-634" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Method"</span></span>
<span id="cb37-635"><a href="#cb37-635" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-636"><a href="#cb37-636" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb37-637"><a href="#cb37-637" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>]</span>
<span id="cb37-638"><a href="#cb37-638" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-639"><a href="#cb37-639" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-640"><a href="#cb37-640" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb37-641"><a href="#cb37-641" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-642"><a href="#cb37-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-643"><a href="#cb37-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-644"><a href="#cb37-644" aria-hidden="true" tabindex="-1"></a><span class="fu">### VaR Backtesting</span></span>
<span id="cb37-645"><a href="#cb37-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-646"><a href="#cb37-646" aria-hidden="true" tabindex="-1"></a>A VaR model is only useful if its predictions are accurate. Backtesting evaluates whether the realized frequency of VaR breaches is consistent with the nominal confidence level. If VaR is estimated at the $\alpha = 1\%$ level, we expect approximately 1% of days to exhibit losses exceeding VaR.</span>
<span id="cb37-647"><a href="#cb37-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-648"><a href="#cb37-648" aria-hidden="true" tabindex="-1"></a>The Kupiec unconditional coverage test <span class="co">[</span><span class="ot">@kupiec1995techniques</span><span class="co">]</span> evaluates whether the total number of breaches $x$ in $n$ observations is consistent with $\alpha$:</span>
<span id="cb37-649"><a href="#cb37-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-650"><a href="#cb37-650" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-651"><a href="#cb37-651" aria-hidden="true" tabindex="-1"></a>\text{LR}_{\text{UC}} = -2\ln\left(\frac{\alpha^x (1-\alpha)^{n-x}}{\hat{p}^x (1-\hat{p})^{n-x}}\right) \sim \chi^2(1)</span>
<span id="cb37-652"><a href="#cb37-652" aria-hidden="true" tabindex="-1"></a>$$ {#eq-kupiec}</span>
<span id="cb37-653"><a href="#cb37-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-654"><a href="#cb37-654" aria-hidden="true" tabindex="-1"></a>where $\hat{p} = x/n$ is the empirical breach frequency. The Christoffersen conditional coverage test <span class="co">[</span><span class="ot">@christoffersen1998evaluating</span><span class="co">]</span> additionally evaluates whether breaches are independent (no clustering):</span>
<span id="cb37-655"><a href="#cb37-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-656"><a href="#cb37-656" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-657"><a href="#cb37-657" aria-hidden="true" tabindex="-1"></a>\text{LR}_{\text{CC}} = \text{LR}_{\text{UC}} + \text{LR}_{\text{IND}}</span>
<span id="cb37-658"><a href="#cb37-658" aria-hidden="true" tabindex="-1"></a>$$ {#eq-christoffersen}</span>
<span id="cb37-659"><a href="#cb37-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-660"><a href="#cb37-660" aria-hidden="true" tabindex="-1"></a>where $\text{LR}_{\text{IND}}$ tests the null of independence using a first-order Markov chain model for breach indicators.</span>
<span id="cb37-661"><a href="#cb37-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-664"><a href="#cb37-664" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-665"><a href="#cb37-665" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: backtesting</span></span>
<span id="cb37-666"><a href="#cb37-666" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-667"><a href="#cb37-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-668"><a href="#cb37-668" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> kupiec_test(returns, var_estimates, alpha<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb37-669"><a href="#cb37-669" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-670"><a href="#cb37-670" aria-hidden="true" tabindex="-1"></a><span class="co">    Kupiec unconditional coverage test for VaR backtesting.</span></span>
<span id="cb37-671"><a href="#cb37-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-672"><a href="#cb37-672" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-673"><a href="#cb37-673" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-674"><a href="#cb37-674" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : breach count, expected, breach rate, LR statistic, p-value.</span></span>
<span id="cb37-675"><a href="#cb37-675" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-676"><a href="#cb37-676" aria-hidden="true" tabindex="-1"></a>    breaches <span class="op">=</span> returns <span class="op">&lt;</span> <span class="op">-</span>var_estimates</span>
<span id="cb37-677"><a href="#cb37-677" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> breaches.<span class="bu">sum</span>()</span>
<span id="cb37-678"><a href="#cb37-678" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(returns)</span>
<span id="cb37-679"><a href="#cb37-679" aria-hidden="true" tabindex="-1"></a>    p_hat <span class="op">=</span> x <span class="op">/</span> n</span>
<span id="cb37-680"><a href="#cb37-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-681"><a href="#cb37-681" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p_hat <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> p_hat <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb37-682"><a href="#cb37-682" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"breaches"</span>: x, <span class="st">"expected"</span>: n <span class="op">*</span> alpha,</span>
<span id="cb37-683"><a href="#cb37-683" aria-hidden="true" tabindex="-1"></a>                <span class="st">"breach_rate"</span>: p_hat, <span class="st">"lr_stat"</span>: np.nan, <span class="st">"p_value"</span>: np.nan}</span>
<span id="cb37-684"><a href="#cb37-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-685"><a href="#cb37-685" aria-hidden="true" tabindex="-1"></a>    lr <span class="op">=</span> <span class="op">-</span><span class="dv">2</span> <span class="op">*</span> (</span>
<span id="cb37-686"><a href="#cb37-686" aria-hidden="true" tabindex="-1"></a>        x <span class="op">*</span> np.log(alpha) <span class="op">+</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> alpha)</span>
<span id="cb37-687"><a href="#cb37-687" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> x <span class="op">*</span> np.log(p_hat) <span class="op">-</span> (n <span class="op">-</span> x) <span class="op">*</span> np.log(<span class="dv">1</span> <span class="op">-</span> p_hat)</span>
<span id="cb37-688"><a href="#cb37-688" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-689"><a href="#cb37-689" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> stats.chi2.cdf(lr, df<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-690"><a href="#cb37-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-691"><a href="#cb37-691" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb37-692"><a href="#cb37-692" aria-hidden="true" tabindex="-1"></a>        <span class="st">"breaches"</span>: <span class="bu">int</span>(x),</span>
<span id="cb37-693"><a href="#cb37-693" aria-hidden="true" tabindex="-1"></a>        <span class="st">"expected"</span>: <span class="bu">round</span>(n <span class="op">*</span> alpha, <span class="dv">1</span>),</span>
<span id="cb37-694"><a href="#cb37-694" aria-hidden="true" tabindex="-1"></a>        <span class="st">"breach_rate"</span>: <span class="bu">round</span>(p_hat, <span class="dv">4</span>),</span>
<span id="cb37-695"><a href="#cb37-695" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lr_stat"</span>: <span class="bu">round</span>(lr, <span class="dv">4</span>),</span>
<span id="cb37-696"><a href="#cb37-696" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p_value"</span>: <span class="bu">round</span>(p_value, <span class="dv">4</span>)</span>
<span id="cb37-697"><a href="#cb37-697" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-698"><a href="#cb37-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-699"><a href="#cb37-699" aria-hidden="true" tabindex="-1"></a><span class="co"># Backtest each method</span></span>
<span id="cb37-700"><a href="#cb37-700" aria-hidden="true" tabindex="-1"></a>actual_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].iloc[window:].values</span>
<span id="cb37-701"><a href="#cb37-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-702"><a href="#cb37-702" aria-hidden="true" tabindex="-1"></a>backtest_results <span class="op">=</span> {}</span>
<span id="cb37-703"><a href="#cb37-703" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method, col <span class="kw">in</span> [(<span class="st">"Historical"</span>, <span class="st">"var_hs"</span>),</span>
<span id="cb37-704"><a href="#cb37-704" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">"Gaussian"</span>, <span class="st">"var_gauss"</span>),</span>
<span id="cb37-705"><a href="#cb37-705" aria-hidden="true" tabindex="-1"></a>                     (<span class="st">"Student-t"</span>, <span class="st">"var_t"</span>)]:</span>
<span id="cb37-706"><a href="#cb37-706" aria-hidden="true" tabindex="-1"></a>    backtest_results[method] <span class="op">=</span> kupiec_test(</span>
<span id="cb37-707"><a href="#cb37-707" aria-hidden="true" tabindex="-1"></a>        actual_returns, var_es_ts[col].values, alpha<span class="op">=</span><span class="fl">0.01</span></span>
<span id="cb37-708"><a href="#cb37-708" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-709"><a href="#cb37-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-710"><a href="#cb37-710" aria-hidden="true" tabindex="-1"></a>bt_df <span class="op">=</span> pd.DataFrame(backtest_results).T</span>
<span id="cb37-711"><a href="#cb37-711" aria-hidden="true" tabindex="-1"></a>bt_df.index.name <span class="op">=</span> <span class="st">"Method"</span></span>
<span id="cb37-712"><a href="#cb37-712" aria-hidden="true" tabindex="-1"></a>bt_df</span>
<span id="cb37-713"><a href="#cb37-713" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-714"><a href="#cb37-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-715"><a href="#cb37-715" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimation Under Limited Data {#sec-limited-data}</span></span>
<span id="cb37-716"><a href="#cb37-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-717"><a href="#cb37-717" aria-hidden="true" tabindex="-1"></a>In Vietnamese equity markets, many stocks have short trading histories, thin liquidity, and censored returns due to price limits. These features create challenges for tail risk estimation that are less severe in developed markets.</span>
<span id="cb37-718"><a href="#cb37-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-719"><a href="#cb37-719" aria-hidden="true" tabindex="-1"></a>**Price limit censoring.** When a stock hits its daily price limit, the observed return is truncated. The true latent return may extend well beyond the limit, but is unobservable. This means that historical simulation mechanically understates VaR and ES for stocks that frequently hit limits. A Tobit-type correction can partially address this:</span>
<span id="cb37-720"><a href="#cb37-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-721"><a href="#cb37-721" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-722"><a href="#cb37-722" aria-hidden="true" tabindex="-1"></a>r_{i,t}^{\text{latent}} \sim N(\mu_i, \sigma_i^2), \quad r_{i,t}^{\text{obs}} = \max(\underline{L}, \min(\bar{L}, r_{i,t}^{\text{latent}}))</span>
<span id="cb37-723"><a href="#cb37-723" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tobit-var}</span>
<span id="cb37-724"><a href="#cb37-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-725"><a href="#cb37-725" aria-hidden="true" tabindex="-1"></a>The parameters $(\mu_i, \sigma_i^2)$ can be estimated via maximum likelihood on the censored sample, and VaR/ES can then be computed from the estimated latent distribution.</span>
<span id="cb37-726"><a href="#cb37-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-727"><a href="#cb37-727" aria-hidden="true" tabindex="-1"></a>**Short histories.** For recently listed stocks, the available sample may be too short for reliable nonparametric estimation. In these cases, shrinkage toward a cross-sectional prior (e.g., the sector median VaR) or Bayesian approaches with informative priors can improve stability.</span>
<span id="cb37-728"><a href="#cb37-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-729"><a href="#cb37-729" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extreme Value Theory {#sec-evt}</span></span>
<span id="cb37-730"><a href="#cb37-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-731"><a href="#cb37-731" aria-hidden="true" tabindex="-1"></a><span class="fu">### Motivation: What EVT Captures That GARCH Does Not</span></span>
<span id="cb37-732"><a href="#cb37-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-733"><a href="#cb37-733" aria-hidden="true" tabindex="-1"></a>GARCH models capture volatility clustering (i.e., the tendency of large returns to be followed by large returns), but they make specific distributional assumptions about standardized residuals (typically Gaussian or Student-$t$). The tail behavior of the conditional distribution is thus determined by the parametric innovation assumption, not learned from the data.</span>
<span id="cb37-734"><a href="#cb37-734" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-735"><a href="#cb37-735" aria-hidden="true" tabindex="-1"></a>Extreme Value Theory (EVT) takes a fundamentally different approach. It provides a statistical framework for estimating the distribution of extreme observations without specifying the entire return distribution. The key theoretical results (i.e., the Fisher-Tippett-Gnedenko theorem and the Pickands-Balkema-de Haan theorem) establish that the distribution of properly normalized maxima (or exceedances over high thresholds) converges to specific parametric families regardless of the parent distribution. This universality is what makes EVT powerful: the tail can be estimated even when the center of the distribution is misspecified.</span>
<span id="cb37-736"><a href="#cb37-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-737"><a href="#cb37-737" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tail Index Estimation</span></span>
<span id="cb37-738"><a href="#cb37-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-739"><a href="#cb37-739" aria-hidden="true" tabindex="-1"></a>The tail index $\xi$ (also denoted $\alpha^{-1}$ in some formulations) governs the rate of tail decay. For heavy-tailed distributions, the survival function satisfies:</span>
<span id="cb37-740"><a href="#cb37-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-741"><a href="#cb37-741" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-742"><a href="#cb37-742" aria-hidden="true" tabindex="-1"></a>P(X &gt; x) \sim L(x) \cdot x^{-1/\xi}, \quad x \to \infty</span>
<span id="cb37-743"><a href="#cb37-743" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tail-decay}</span>
<span id="cb37-744"><a href="#cb37-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-745"><a href="#cb37-745" aria-hidden="true" tabindex="-1"></a>where $L(x)$ is a slowly varying function. The tail index $\xi &gt; 0$ implies a Pareto-type tail; larger $\xi$ means heavier tails. Financial return distributions typically have $\xi \in (0.2, 0.5)$, corresponding to tail indices $\alpha = 1/\xi \in (2, 5)$, which implies finite variance but potentially infinite higher moments.</span>
<span id="cb37-746"><a href="#cb37-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-747"><a href="#cb37-747" aria-hidden="true" tabindex="-1"></a>The Hill estimator <span class="co">[</span><span class="ot">@hill1975simple</span><span class="co">]</span> provides a simple nonparametric estimate of $\xi$ from the upper order statistics:</span>
<span id="cb37-748"><a href="#cb37-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-749"><a href="#cb37-749" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-750"><a href="#cb37-750" aria-hidden="true" tabindex="-1"></a>\hat{\xi}_{\text{Hill}}(k) = \frac{1}{k}\sum_{j=1}^{k} \ln X_{(n-j+1)} - \ln X_{(n-k)}</span>
<span id="cb37-751"><a href="#cb37-751" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hill}</span>
<span id="cb37-752"><a href="#cb37-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-753"><a href="#cb37-753" aria-hidden="true" tabindex="-1"></a>where $X_{(1)} \leq \cdots \leq X_{(n)}$ are the order statistics and $k$ is the number of upper order statistics used. The choice of $k$ involves a bias-variance tradeoff: small $k$ yields high variance; large $k$ introduces bias from non-tail observations.</span>
<span id="cb37-754"><a href="#cb37-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-757"><a href="#cb37-757" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-758"><a href="#cb37-758" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hill-estimator</span></span>
<span id="cb37-759"><a href="#cb37-759" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-760"><a href="#cb37-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-761"><a href="#cb37-761" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hill_estimator(data, k_values<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb37-762"><a href="#cb37-762" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-763"><a href="#cb37-763" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Hill estimator of tail index for a range of k values.</span></span>
<span id="cb37-764"><a href="#cb37-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-765"><a href="#cb37-765" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb37-766"><a href="#cb37-766" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb37-767"><a href="#cb37-767" aria-hidden="true" tabindex="-1"></a><span class="co">    data : array-like</span></span>
<span id="cb37-768"><a href="#cb37-768" aria-hidden="true" tabindex="-1"></a><span class="co">        Positive values (use absolute values of losses).</span></span>
<span id="cb37-769"><a href="#cb37-769" aria-hidden="true" tabindex="-1"></a><span class="co">    k_values : array-like, optional</span></span>
<span id="cb37-770"><a href="#cb37-770" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of upper order statistics to use.</span></span>
<span id="cb37-771"><a href="#cb37-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-772"><a href="#cb37-772" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-773"><a href="#cb37-773" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-774"><a href="#cb37-774" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with columns [k, xi_hat, se].</span></span>
<span id="cb37-775"><a href="#cb37-775" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-776"><a href="#cb37-776" aria-hidden="true" tabindex="-1"></a>    x <span class="op">=</span> np.sort(np.<span class="bu">abs</span>(data))[::<span class="op">-</span><span class="dv">1</span>]  <span class="co"># Descending order</span></span>
<span id="cb37-777"><a href="#cb37-777" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb37-778"><a href="#cb37-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-779"><a href="#cb37-779" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k_values <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb37-780"><a href="#cb37-780" aria-hidden="true" tabindex="-1"></a>        k_values <span class="op">=</span> <span class="bu">range</span>(<span class="dv">10</span>, <span class="bu">min</span>(n <span class="op">//</span> <span class="dv">2</span>, <span class="dv">500</span>), <span class="dv">5</span>)</span>
<span id="cb37-781"><a href="#cb37-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-782"><a href="#cb37-782" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-783"><a href="#cb37-783" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> k_values:</span>
<span id="cb37-784"><a href="#cb37-784" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">&gt;=</span> n <span class="kw">or</span> k <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb37-785"><a href="#cb37-785" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-786"><a href="#cb37-786" aria-hidden="true" tabindex="-1"></a>        log_excess <span class="op">=</span> np.log(x[:k]) <span class="op">-</span> np.log(x[k])</span>
<span id="cb37-787"><a href="#cb37-787" aria-hidden="true" tabindex="-1"></a>        xi_hat <span class="op">=</span> log_excess.mean()</span>
<span id="cb37-788"><a href="#cb37-788" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> xi_hat <span class="op">/</span> np.sqrt(k)</span>
<span id="cb37-789"><a href="#cb37-789" aria-hidden="true" tabindex="-1"></a>        results.append({<span class="st">"k"</span>: k, <span class="st">"xi_hat"</span>: xi_hat, <span class="st">"se"</span>: se})</span>
<span id="cb37-790"><a href="#cb37-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-791"><a href="#cb37-791" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb37-792"><a href="#cb37-792" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-793"><a href="#cb37-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-796"><a href="#cb37-796" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-797"><a href="#cb37-797" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hill-plot</span></span>
<span id="cb37-798"><a href="#cb37-798" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-799"><a href="#cb37-799" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Hill Plot: Tail Index Estimate as a Function of Order Statistics"</span></span>
<span id="cb37-800"><a href="#cb37-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-801"><a href="#cb37-801" aria-hidden="true" tabindex="-1"></a><span class="co"># Use negative market returns (losses)</span></span>
<span id="cb37-802"><a href="#cb37-802" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> <span class="op">-</span>market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb37-803"><a href="#cb37-803" aria-hidden="true" tabindex="-1"></a>losses_positive <span class="op">=</span> losses[losses <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb37-804"><a href="#cb37-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-805"><a href="#cb37-805" aria-hidden="true" tabindex="-1"></a>hill_results <span class="op">=</span> hill_estimator(losses_positive)</span>
<span id="cb37-806"><a href="#cb37-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-807"><a href="#cb37-807" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-808"><a href="#cb37-808" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(hill_results, p9.aes(x<span class="op">=</span><span class="st">"k"</span>, y<span class="op">=</span><span class="st">"xi_hat"</span>))</span>
<span id="cb37-809"><a href="#cb37-809" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb37-810"><a href="#cb37-810" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"xi_hat - 1.96 * se"</span>, ymax<span class="op">=</span><span class="st">"xi_hat + 1.96 * se"</span>),</span>
<span id="cb37-811"><a href="#cb37-811" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb37-812"><a href="#cb37-812" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-813"><a href="#cb37-813" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb37-814"><a href="#cb37-814" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="fl">0.33</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>)</span>
<span id="cb37-815"><a href="#cb37-815" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.annotate(</span>
<span id="cb37-816"><a href="#cb37-816" aria-hidden="true" tabindex="-1"></a>        <span class="st">"text"</span>, x<span class="op">=</span>hill_results[<span class="st">"k"</span>].<span class="bu">max</span>() <span class="op">*</span> <span class="fl">0.7</span>, y<span class="op">=</span><span class="fl">0.35</span>,</span>
<span id="cb37-817"><a href="#cb37-817" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">"Œæ = 1/3 (cubic tail)"</span>, color<span class="op">=</span><span class="st">"red"</span>, size<span class="op">=</span><span class="dv">8</span></span>
<span id="cb37-818"><a href="#cb37-818" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-819"><a href="#cb37-819" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-820"><a href="#cb37-820" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Number of Order Statistics (k)"</span>,</span>
<span id="cb37-821"><a href="#cb37-821" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Hill Estimate ŒæÃÇ"</span>,</span>
<span id="cb37-822"><a href="#cb37-822" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Hill Plot for Market Return Left Tail"</span></span>
<span id="cb37-823"><a href="#cb37-823" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-824"><a href="#cb37-824" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-825"><a href="#cb37-825" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb37-826"><a href="#cb37-826" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-827"><a href="#cb37-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-828"><a href="#cb37-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-829"><a href="#cb37-829" aria-hidden="true" tabindex="-1"></a>The Hill plot is a standard diagnostic in EVT. A stable region of the Hill estimate across a range of $k$ suggests a reliable tail index estimate. The red dashed line at $\xi = 1/3$ corresponds to a tail index of $\alpha = 3$, which implies that the third moment (skewness) is infinite, which is a finding consistent with much of the empirical finance literature <span class="co">[</span><span class="ot">@cont2001empirical; @gabaix2003theory</span><span class="co">]</span>.</span>
<span id="cb37-830"><a href="#cb37-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-831"><a href="#cb37-831" aria-hidden="true" tabindex="-1"></a><span class="fu">### Block Maxima and the GEV Distribution</span></span>
<span id="cb37-832"><a href="#cb37-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-833"><a href="#cb37-833" aria-hidden="true" tabindex="-1"></a>The Fisher-Tippett-Gnedenko theorem establishes that if the maximum of $n$ i.i.d. random variables, after proper normalization, converges in distribution, the limit must be a Generalized Extreme Value (GEV) distribution:</span>
<span id="cb37-834"><a href="#cb37-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-835"><a href="#cb37-835" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-836"><a href="#cb37-836" aria-hidden="true" tabindex="-1"></a>G_\xi(x) = \exp\left<span class="sc">\{</span>-\left(1 + \xi \cdot \frac{x - \mu}{\sigma}\right)^{-1/\xi}\right<span class="sc">\}</span></span>
<span id="cb37-837"><a href="#cb37-837" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gev}</span>
<span id="cb37-838"><a href="#cb37-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-839"><a href="#cb37-839" aria-hidden="true" tabindex="-1"></a>for $1 + \xi(x - \mu)/\sigma &gt; 0$, where $\mu$ is the location, $\sigma &gt; 0$ the scale, and $\xi$ the shape parameter. The three sub-families are in @tbl-tail-riskgev-families.</span>
<span id="cb37-840"><a href="#cb37-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-841"><a href="#cb37-841" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Shape $\xi$ <span class="pp">|</span> Distribution <span class="pp">|</span> Tail Type <span class="pp">|</span> Finance Example <span class="pp">|</span></span>
<span id="cb37-842"><a href="#cb37-842" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|------------------|------------------|-------------------|</span></span>
<span id="cb37-843"><a href="#cb37-843" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $\xi &gt; 0$ <span class="pp">|</span> Fr√©chet <span class="pp">|</span> Heavy (polynomial decay) <span class="pp">|</span> Equity returns, credit losses <span class="pp">|</span></span>
<span id="cb37-844"><a href="#cb37-844" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $\xi = 0$ <span class="pp">|</span> Gumbel <span class="pp">|</span> Light (exponential decay) <span class="pp">|</span> Normal/lognormal models <span class="pp">|</span></span>
<span id="cb37-845"><a href="#cb37-845" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> $\xi &lt; 0$ <span class="pp">|</span> Weibull <span class="pp">|</span> Bounded upper tail <span class="pp">|</span> Bounded loss distributions <span class="pp">|</span></span>
<span id="cb37-846"><a href="#cb37-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-847"><a href="#cb37-847" aria-hidden="true" tabindex="-1"></a>: GEV Sub-Families and Financial Interpretation {#tbl-tail-riskgev-families}</span>
<span id="cb37-848"><a href="#cb37-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-849"><a href="#cb37-849" aria-hidden="true" tabindex="-1"></a>For the block maxima approach, we divide the return series into non-overlapping blocks (typically months or quarters) and extract the minimum return (maximum loss) from each block. The GEV is then fitted to these block minima.</span>
<span id="cb37-850"><a href="#cb37-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-853"><a href="#cb37-853" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-854"><a href="#cb37-854" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: block-maxima</span></span>
<span id="cb37-855"><a href="#cb37-855" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-856"><a href="#cb37-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-857"><a href="#cb37-857" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> genextreme</span>
<span id="cb37-858"><a href="#cb37-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-859"><a href="#cb37-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly block minima (maximum losses)</span></span>
<span id="cb37-860"><a href="#cb37-860" aria-hidden="true" tabindex="-1"></a>market_daily[<span class="st">"month"</span>] <span class="op">=</span> market_daily[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb37-861"><a href="#cb37-861" aria-hidden="true" tabindex="-1"></a>block_minima <span class="op">=</span> (</span>
<span id="cb37-862"><a href="#cb37-862" aria-hidden="true" tabindex="-1"></a>    market_daily.groupby(<span class="st">"month"</span>)</span>
<span id="cb37-863"><a href="#cb37-863" aria-hidden="true" tabindex="-1"></a>    .agg(min_ret<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"min"</span>))</span>
<span id="cb37-864"><a href="#cb37-864" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-865"><a href="#cb37-865" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-866"><a href="#cb37-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-867"><a href="#cb37-867" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit GEV to negated block minima (so we model maxima of losses)</span></span>
<span id="cb37-868"><a href="#cb37-868" aria-hidden="true" tabindex="-1"></a>block_losses <span class="op">=</span> <span class="op">-</span>block_minima[<span class="st">"min_ret"</span>].values</span>
<span id="cb37-869"><a href="#cb37-869" aria-hidden="true" tabindex="-1"></a>xi_hat, loc_hat, scale_hat <span class="op">=</span> genextreme.fit(block_losses)</span>
<span id="cb37-870"><a href="#cb37-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-871"><a href="#cb37-871" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"GEV fit to monthly block maxima of losses:"</span>)</span>
<span id="cb37-872"><a href="#cb37-872" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Shape (Œæ):    </span><span class="sc">{</span>xi_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-873"><a href="#cb37-873" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Location (Œº): </span><span class="sc">{</span>loc_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-874"><a href="#cb37-874" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Scale (œÉ):    </span><span class="sc">{</span>scale_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-875"><a href="#cb37-875" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-876"><a href="#cb37-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-879"><a href="#cb37-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-880"><a href="#cb37-880" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-gev-fit</span></span>
<span id="cb37-881"><a href="#cb37-881" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-882"><a href="#cb37-882" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "GEV Fit to Monthly Maximum Losses"</span></span>
<span id="cb37-883"><a href="#cb37-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-884"><a href="#cb37-884" aria-hidden="true" tabindex="-1"></a>x_grid <span class="op">=</span> np.linspace(</span>
<span id="cb37-885"><a href="#cb37-885" aria-hidden="true" tabindex="-1"></a>    block_losses.<span class="bu">min</span>() <span class="op">*</span> <span class="fl">0.8</span>,</span>
<span id="cb37-886"><a href="#cb37-886" aria-hidden="true" tabindex="-1"></a>    block_losses.<span class="bu">max</span>() <span class="op">*</span> <span class="fl">1.2</span>,</span>
<span id="cb37-887"><a href="#cb37-887" aria-hidden="true" tabindex="-1"></a>    <span class="dv">200</span></span>
<span id="cb37-888"><a href="#cb37-888" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-889"><a href="#cb37-889" aria-hidden="true" tabindex="-1"></a>gev_pdf <span class="op">=</span> genextreme.pdf(x_grid, xi_hat, loc<span class="op">=</span>loc_hat, scale<span class="op">=</span>scale_hat)</span>
<span id="cb37-890"><a href="#cb37-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-891"><a href="#cb37-891" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> pd.DataFrame({</span>
<span id="cb37-892"><a href="#cb37-892" aria-hidden="true" tabindex="-1"></a>    <span class="st">"x"</span>: np.concatenate([block_losses, x_grid]),</span>
<span id="cb37-893"><a href="#cb37-893" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span>: ([<span class="st">"Empirical"</span>] <span class="op">*</span> <span class="bu">len</span>(block_losses) <span class="op">+</span></span>
<span id="cb37-894"><a href="#cb37-894" aria-hidden="true" tabindex="-1"></a>               [<span class="st">"GEV Fit"</span>] <span class="op">*</span> <span class="bu">len</span>(x_grid)),</span>
<span id="cb37-895"><a href="#cb37-895" aria-hidden="true" tabindex="-1"></a>    <span class="st">"density"</span>: np.concatenate([</span>
<span id="cb37-896"><a href="#cb37-896" aria-hidden="true" tabindex="-1"></a>        np.full(<span class="bu">len</span>(block_losses), np.nan),</span>
<span id="cb37-897"><a href="#cb37-897" aria-hidden="true" tabindex="-1"></a>        gev_pdf</span>
<span id="cb37-898"><a href="#cb37-898" aria-hidden="true" tabindex="-1"></a>    ]),</span>
<span id="cb37-899"><a href="#cb37-899" aria-hidden="true" tabindex="-1"></a>    <span class="st">"value"</span>: np.concatenate([block_losses, np.full(<span class="bu">len</span>(x_grid), np.nan)])</span>
<span id="cb37-900"><a href="#cb37-900" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb37-901"><a href="#cb37-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-902"><a href="#cb37-902" aria-hidden="true" tabindex="-1"></a>empirical <span class="op">=</span> plot_data[plot_data[<span class="st">"source"</span>] <span class="op">==</span> <span class="st">"Empirical"</span>]</span>
<span id="cb37-903"><a href="#cb37-903" aria-hidden="true" tabindex="-1"></a>fitted <span class="op">=</span> plot_data[plot_data[<span class="st">"source"</span>] <span class="op">==</span> <span class="st">"GEV Fit"</span>]</span>
<span id="cb37-904"><a href="#cb37-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-905"><a href="#cb37-905" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-906"><a href="#cb37-906" aria-hidden="true" tabindex="-1"></a>    p9.ggplot()</span>
<span id="cb37-907"><a href="#cb37-907" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(</span>
<span id="cb37-908"><a href="#cb37-908" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>empirical, mapping<span class="op">=</span>p9.aes(x<span class="op">=</span><span class="st">"value"</span>, y<span class="op">=</span><span class="st">"..density.."</span>),</span>
<span id="cb37-909"><a href="#cb37-909" aria-hidden="true" tabindex="-1"></a>        bins<span class="op">=</span><span class="dv">30</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb37-910"><a href="#cb37-910" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-911"><a href="#cb37-911" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(</span>
<span id="cb37-912"><a href="#cb37-912" aria-hidden="true" tabindex="-1"></a>        data<span class="op">=</span>fitted, mapping<span class="op">=</span>p9.aes(x<span class="op">=</span><span class="st">"x"</span>, y<span class="op">=</span><span class="st">"density"</span>),</span>
<span id="cb37-913"><a href="#cb37-913" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span></span>
<span id="cb37-914"><a href="#cb37-914" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-915"><a href="#cb37-915" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-916"><a href="#cb37-916" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly Maximum Loss"</span>,</span>
<span id="cb37-917"><a href="#cb37-917" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Density"</span>,</span>
<span id="cb37-918"><a href="#cb37-918" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"GEV Distribution Fit to Monthly Block Maxima"</span></span>
<span id="cb37-919"><a href="#cb37-919" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-920"><a href="#cb37-920" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-921"><a href="#cb37-921" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb37-922"><a href="#cb37-922" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-923"><a href="#cb37-923" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-924"><a href="#cb37-924" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-925"><a href="#cb37-925" aria-hidden="true" tabindex="-1"></a><span class="fu">### Peaks Over Threshold and the GPD {#sec-gpd}</span></span>
<span id="cb37-926"><a href="#cb37-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-927"><a href="#cb37-927" aria-hidden="true" tabindex="-1"></a>The Peaks Over Threshold (POT) approach is generally preferred over block maxima because it uses tail data more efficiently. The Pickands-Balkema-de Haan theorem establishes that for a sufficiently high threshold $u$, the distribution of exceedances $Y = X - u \mid X &gt; u$ converges to a Generalized Pareto Distribution (GPD):</span>
<span id="cb37-928"><a href="#cb37-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-929"><a href="#cb37-929" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-930"><a href="#cb37-930" aria-hidden="true" tabindex="-1"></a>H_{\xi,\beta}(y) = \begin{cases}</span>
<span id="cb37-931"><a href="#cb37-931" aria-hidden="true" tabindex="-1"></a>1 - \left(1 + \frac{\xi y}{\beta}\right)^{-1/\xi} &amp; \text{if } \xi \neq 0 <span class="sc">\\</span></span>
<span id="cb37-932"><a href="#cb37-932" aria-hidden="true" tabindex="-1"></a>1 - \exp\left(-\frac{y}{\beta}\right) &amp; \text{if } \xi = 0</span>
<span id="cb37-933"><a href="#cb37-933" aria-hidden="true" tabindex="-1"></a>\end{cases}</span>
<span id="cb37-934"><a href="#cb37-934" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gpd}</span>
<span id="cb37-935"><a href="#cb37-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-936"><a href="#cb37-936" aria-hidden="true" tabindex="-1"></a>for $y &gt; 0$ and $1 + \xi y / \beta &gt; 0$, where $\beta &gt; 0$ is the scale parameter and $\xi$ is the shape parameter (identical to the GEV shape). The POT-based VaR and ES at level $\alpha$ are:</span>
<span id="cb37-937"><a href="#cb37-937" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-938"><a href="#cb37-938" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-939"><a href="#cb37-939" aria-hidden="true" tabindex="-1"></a>\text{VaR}_\alpha^{\text{GPD}} = u + \frac{\hat{\beta}}{\hat{\xi}}\left<span class="co">[</span><span class="ot">\left(\frac{n}{N_u} \cdot \alpha\right)^{-\hat{\xi}} - 1\right</span><span class="co">]</span></span>
<span id="cb37-940"><a href="#cb37-940" aria-hidden="true" tabindex="-1"></a>$$ {#eq-var-gpd}</span>
<span id="cb37-941"><a href="#cb37-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-942"><a href="#cb37-942" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-943"><a href="#cb37-943" aria-hidden="true" tabindex="-1"></a>\text{ES}_\alpha^{\text{GPD}} = \frac{\text{VaR}_\alpha^{\text{GPD}}}{1 - \hat{\xi}} + \frac{\hat{\beta} - \hat{\xi} u}{1 - \hat{\xi}}</span>
<span id="cb37-944"><a href="#cb37-944" aria-hidden="true" tabindex="-1"></a>$$ {#eq-es-gpd}</span>
<span id="cb37-945"><a href="#cb37-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-946"><a href="#cb37-946" aria-hidden="true" tabindex="-1"></a>where $N_u$ is the number of observations exceeding $u$ and $n$ is the total sample size. These formulae are valid for $\hat{\xi} &lt; 1$.</span>
<span id="cb37-947"><a href="#cb37-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-950"><a href="#cb37-950" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-951"><a href="#cb37-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gpd-estimation</span></span>
<span id="cb37-952"><a href="#cb37-952" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-953"><a href="#cb37-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-954"><a href="#cb37-954" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> genpareto</span>
<span id="cb37-955"><a href="#cb37-955" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-956"><a href="#cb37-956" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fit_gpd_pot(returns, threshold_quantile<span class="op">=</span><span class="fl">0.95</span>):</span>
<span id="cb37-957"><a href="#cb37-957" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-958"><a href="#cb37-958" aria-hidden="true" tabindex="-1"></a><span class="co">    Fit GPD to exceedances over threshold using POT approach.</span></span>
<span id="cb37-959"><a href="#cb37-959" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-960"><a href="#cb37-960" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb37-961"><a href="#cb37-961" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb37-962"><a href="#cb37-962" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : array-like</span></span>
<span id="cb37-963"><a href="#cb37-963" aria-hidden="true" tabindex="-1"></a><span class="co">        Return series (losses should be positive).</span></span>
<span id="cb37-964"><a href="#cb37-964" aria-hidden="true" tabindex="-1"></a><span class="co">    threshold_quantile : float</span></span>
<span id="cb37-965"><a href="#cb37-965" aria-hidden="true" tabindex="-1"></a><span class="co">        Quantile for threshold selection.</span></span>
<span id="cb37-966"><a href="#cb37-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-967"><a href="#cb37-967" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-968"><a href="#cb37-968" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-969"><a href="#cb37-969" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Threshold, GPD parameters, VaR, ES estimates.</span></span>
<span id="cb37-970"><a href="#cb37-970" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-971"><a href="#cb37-971" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> <span class="op">-</span>np.array(returns)</span>
<span id="cb37-972"><a href="#cb37-972" aria-hidden="true" tabindex="-1"></a>    losses <span class="op">=</span> losses[<span class="op">~</span>np.isnan(losses)]</span>
<span id="cb37-973"><a href="#cb37-973" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(losses)</span>
<span id="cb37-974"><a href="#cb37-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-975"><a href="#cb37-975" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> np.quantile(losses, threshold_quantile)</span>
<span id="cb37-976"><a href="#cb37-976" aria-hidden="true" tabindex="-1"></a>    exceedances <span class="op">=</span> losses[losses <span class="op">&gt;</span> u] <span class="op">-</span> u</span>
<span id="cb37-977"><a href="#cb37-977" aria-hidden="true" tabindex="-1"></a>    N_u <span class="op">=</span> <span class="bu">len</span>(exceedances)</span>
<span id="cb37-978"><a href="#cb37-978" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-979"><a href="#cb37-979" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fit GPD</span></span>
<span id="cb37-980"><a href="#cb37-980" aria-hidden="true" tabindex="-1"></a>    xi_hat, _, beta_hat <span class="op">=</span> genpareto.fit(exceedances, floc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb37-981"><a href="#cb37-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-982"><a href="#cb37-982" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VaR and ES at 1%</span></span>
<span id="cb37-983"><a href="#cb37-983" aria-hidden="true" tabindex="-1"></a>    alpha <span class="op">=</span> <span class="fl">0.01</span></span>
<span id="cb37-984"><a href="#cb37-984" aria-hidden="true" tabindex="-1"></a>    var_gpd <span class="op">=</span> u <span class="op">+</span> (beta_hat <span class="op">/</span> xi_hat) <span class="op">*</span> (</span>
<span id="cb37-985"><a href="#cb37-985" aria-hidden="true" tabindex="-1"></a>        (n <span class="op">/</span> N_u <span class="op">*</span> alpha)<span class="op">**</span>(<span class="op">-</span>xi_hat) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb37-986"><a href="#cb37-986" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-987"><a href="#cb37-987" aria-hidden="true" tabindex="-1"></a>    es_gpd <span class="op">=</span> var_gpd <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> xi_hat) <span class="op">+</span> (beta_hat <span class="op">-</span> xi_hat <span class="op">*</span> u) <span class="op">/</span> (<span class="dv">1</span> <span class="op">-</span> xi_hat)</span>
<span id="cb37-988"><a href="#cb37-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-989"><a href="#cb37-989" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb37-990"><a href="#cb37-990" aria-hidden="true" tabindex="-1"></a>        <span class="st">"threshold"</span>: u,</span>
<span id="cb37-991"><a href="#cb37-991" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_exceedances"</span>: N_u,</span>
<span id="cb37-992"><a href="#cb37-992" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_hat"</span>: xi_hat,</span>
<span id="cb37-993"><a href="#cb37-993" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta_hat"</span>: beta_hat,</span>
<span id="cb37-994"><a href="#cb37-994" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_1pct"</span>: var_gpd,</span>
<span id="cb37-995"><a href="#cb37-995" aria-hidden="true" tabindex="-1"></a>        <span class="st">"es_1pct"</span>: es_gpd</span>
<span id="cb37-996"><a href="#cb37-996" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb37-997"><a href="#cb37-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-998"><a href="#cb37-998" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit GPD to market losses</span></span>
<span id="cb37-999"><a href="#cb37-999" aria-hidden="true" tabindex="-1"></a>gpd_results <span class="op">=</span> fit_gpd_pot(market_daily[<span class="st">"mkt_ret"</span>].dropna().values, <span class="fl">0.95</span>)</span>
<span id="cb37-1000"><a href="#cb37-1000" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1001"><a href="#cb37-1001" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"GPD-POT Results (1</span><span class="sc">% le</span><span class="st">vel):"</span>)</span>
<span id="cb37-1002"><a href="#cb37-1002" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> k, v <span class="kw">in</span> gpd_results.items():</span>
<span id="cb37-1003"><a href="#cb37-1003" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(v, <span class="bu">float</span>):</span>
<span id="cb37-1004"><a href="#cb37-1004" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb37-1005"><a href="#cb37-1005" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-1006"><a href="#cb37-1006" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1007"><a href="#cb37-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1008"><a href="#cb37-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1009"><a href="#cb37-1009" aria-hidden="true" tabindex="-1"></a><span class="fu">### Threshold Selection</span></span>
<span id="cb37-1010"><a href="#cb37-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1011"><a href="#cb37-1011" aria-hidden="true" tabindex="-1"></a>The choice of threshold $u$ is the key practical decision in POT analysis. Too low a threshold violates the asymptotic approximation; too high wastes data. The mean residual life plot provides a graphical diagnostic: if the GPD approximation holds above $u_0$, the mean excess function $e(u) = E<span class="co">[</span><span class="ot">X - u \mid X &gt; u</span><span class="co">]</span>$ is linear in $u$ for $u &gt; u_0$:</span>
<span id="cb37-1012"><a href="#cb37-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1013"><a href="#cb37-1013" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1014"><a href="#cb37-1014" aria-hidden="true" tabindex="-1"></a>e(u) = \frac{\beta + \xi u}{1 - \xi}</span>
<span id="cb37-1015"><a href="#cb37-1015" aria-hidden="true" tabindex="-1"></a>$$ {#eq-mean-excess}</span>
<span id="cb37-1016"><a href="#cb37-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1019"><a href="#cb37-1019" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1020"><a href="#cb37-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-mean-residual-life</span></span>
<span id="cb37-1021"><a href="#cb37-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1022"><a href="#cb37-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mean Residual Life Plot for Threshold Selection"</span></span>
<span id="cb37-1023"><a href="#cb37-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1024"><a href="#cb37-1024" aria-hidden="true" tabindex="-1"></a>losses <span class="op">=</span> <span class="op">-</span>market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb37-1025"><a href="#cb37-1025" aria-hidden="true" tabindex="-1"></a>losses_sorted <span class="op">=</span> np.sort(losses)</span>
<span id="cb37-1026"><a href="#cb37-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1027"><a href="#cb37-1027" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> np.quantile(losses, np.linspace(<span class="fl">0.80</span>, <span class="fl">0.99</span>, <span class="dv">50</span>))</span>
<span id="cb37-1028"><a href="#cb37-1028" aria-hidden="true" tabindex="-1"></a>mean_excess <span class="op">=</span> []</span>
<span id="cb37-1029"><a href="#cb37-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1030"><a href="#cb37-1030" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> u <span class="kw">in</span> thresholds:</span>
<span id="cb37-1031"><a href="#cb37-1031" aria-hidden="true" tabindex="-1"></a>    exceedances <span class="op">=</span> losses[losses <span class="op">&gt;</span> u] <span class="op">-</span> u</span>
<span id="cb37-1032"><a href="#cb37-1032" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(exceedances) <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb37-1033"><a href="#cb37-1033" aria-hidden="true" tabindex="-1"></a>        mean_excess.append({</span>
<span id="cb37-1034"><a href="#cb37-1034" aria-hidden="true" tabindex="-1"></a>            <span class="st">"threshold"</span>: u,</span>
<span id="cb37-1035"><a href="#cb37-1035" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mean_excess"</span>: exceedances.mean(),</span>
<span id="cb37-1036"><a href="#cb37-1036" aria-hidden="true" tabindex="-1"></a>            <span class="st">"se"</span>: exceedances.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(exceedances)),</span>
<span id="cb37-1037"><a href="#cb37-1037" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_exceed"</span>: <span class="bu">len</span>(exceedances)</span>
<span id="cb37-1038"><a href="#cb37-1038" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-1039"><a href="#cb37-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1040"><a href="#cb37-1040" aria-hidden="true" tabindex="-1"></a>mrl_df <span class="op">=</span> pd.DataFrame(mean_excess)</span>
<span id="cb37-1041"><a href="#cb37-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1042"><a href="#cb37-1042" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-1043"><a href="#cb37-1043" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(mrl_df, p9.aes(x<span class="op">=</span><span class="st">"threshold"</span>, y<span class="op">=</span><span class="st">"mean_excess"</span>))</span>
<span id="cb37-1044"><a href="#cb37-1044" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_ribbon(</span>
<span id="cb37-1045"><a href="#cb37-1045" aria-hidden="true" tabindex="-1"></a>        p9.aes(</span>
<span id="cb37-1046"><a href="#cb37-1046" aria-hidden="true" tabindex="-1"></a>            ymin<span class="op">=</span><span class="st">"mean_excess - 1.96 * se"</span>,</span>
<span id="cb37-1047"><a href="#cb37-1047" aria-hidden="true" tabindex="-1"></a>            ymax<span class="op">=</span><span class="st">"mean_excess + 1.96 * se"</span></span>
<span id="cb37-1048"><a href="#cb37-1048" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb37-1049"><a href="#cb37-1049" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb37-1050"><a href="#cb37-1050" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1051"><a href="#cb37-1051" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb37-1052"><a href="#cb37-1052" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb37-1053"><a href="#cb37-1053" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-1054"><a href="#cb37-1054" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Threshold (u)"</span>,</span>
<span id="cb37-1055"><a href="#cb37-1055" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Mean Excess e(u)"</span>,</span>
<span id="cb37-1056"><a href="#cb37-1056" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Mean Residual Life Plot"</span></span>
<span id="cb37-1057"><a href="#cb37-1057" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1058"><a href="#cb37-1058" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-1059"><a href="#cb37-1059" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb37-1060"><a href="#cb37-1060" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1061"><a href="#cb37-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1062"><a href="#cb37-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1063"><a href="#cb37-1063" aria-hidden="true" tabindex="-1"></a>A threshold in the region where the mean residual life plot is approximately linear is appropriate. In practice, we also compare GPD parameter stability across a range of thresholds and select the lowest threshold at which estimates stabilize.</span>
<span id="cb37-1064"><a href="#cb37-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1065"><a href="#cb37-1065" aria-hidden="true" tabindex="-1"></a><span class="fu">### What EVT Captures That GARCH Does Not</span></span>
<span id="cb37-1066"><a href="#cb37-1066" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1067"><a href="#cb37-1067" aria-hidden="true" tabindex="-1"></a>@tbl-tail-riskevt-vs-garch summarizes the complementary roles of these two modeling frameworks.</span>
<span id="cb37-1068"><a href="#cb37-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1069"><a href="#cb37-1069" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Feature <span class="pp">|</span> GARCH <span class="pp">|</span> EVT <span class="pp">|</span></span>
<span id="cb37-1070"><a href="#cb37-1070" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------------------------|------------------------|-------------------|</span></span>
<span id="cb37-1071"><a href="#cb37-1071" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> What is modeled <span class="pp">|</span> Conditional variance dynamics <span class="pp">|</span> Unconditional tail distribution <span class="pp">|</span></span>
<span id="cb37-1072"><a href="#cb37-1072" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Distributional assumption <span class="pp">|</span> Full distribution (Gaussian or $t$) <span class="pp">|</span> Only the tail (GPD or GEV) <span class="pp">|</span></span>
<span id="cb37-1073"><a href="#cb37-1073" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Time dependence <span class="pp">|</span> Explicit (volatility clustering) <span class="pp">|</span> None (i.i.d. or filtered) <span class="pp">|</span></span>
<span id="cb37-1074"><a href="#cb37-1074" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Tail shape <span class="pp">|</span> Determined by innovation distribution <span class="pp">|</span> Estimated from data <span class="pp">|</span></span>
<span id="cb37-1075"><a href="#cb37-1075" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Extreme quantiles <span class="pp">|</span> Extrapolation from parametric assumption <span class="pp">|</span> Principled extrapolation via EVT theorems <span class="pp">|</span></span>
<span id="cb37-1076"><a href="#cb37-1076" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Best use <span class="pp">|</span> Short-horizon risk forecasting <span class="pp">|</span> Extreme quantile estimation, stress testing <span class="pp">|</span></span>
<span id="cb37-1077"><a href="#cb37-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1078"><a href="#cb37-1078" aria-hidden="true" tabindex="-1"></a>: GARCH vs. EVT: Complementary Frameworks {#tbl-tail-riskevt-vs-garch}</span>
<span id="cb37-1079"><a href="#cb37-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1080"><a href="#cb37-1080" aria-hidden="true" tabindex="-1"></a>The GARCH-filtered EVT approach of @mcneil2000estimation combines both: GARCH captures the time-varying volatility, and EVT models the residual tail. This hybrid approach is considered best practice for financial risk management <span class="co">[</span><span class="ot">@mcneil2015quantitative</span><span class="co">]</span>.</span>
<span id="cb37-1081"><a href="#cb37-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1082"><a href="#cb37-1082" aria-hidden="true" tabindex="-1"></a><span class="fu">## Tail Dependence and Contagion</span></span>
<span id="cb37-1083"><a href="#cb37-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1084"><a href="#cb37-1084" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Correlation Breaks Down in Crises</span></span>
<span id="cb37-1085"><a href="#cb37-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1086"><a href="#cb37-1086" aria-hidden="true" tabindex="-1"></a>Perhaps the most important practical fact about multivariate tail risk is that correlations estimated from the body of the distribution systematically understate dependence in the tails. @longin2001extreme demonstrate this using extreme value theory: for bivariate normal returns, the correlation of extreme realizations converges to zero as the threshold moves further into the tail. Yet empirically, the correlation of crash returns remains large and often increases (a phenomenon incompatible with multivariate normality).</span>
<span id="cb37-1087"><a href="#cb37-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1088"><a href="#cb37-1088" aria-hidden="true" tabindex="-1"></a>Formally, the coefficient of lower tail dependence between two return series $X$ and $Y$ is:</span>
<span id="cb37-1089"><a href="#cb37-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1090"><a href="#cb37-1090" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1091"><a href="#cb37-1091" aria-hidden="true" tabindex="-1"></a>\lambda_L = \lim_{q \to 0^+} P\left(Y \leq F_Y^{-1}(q) \mid X \leq F_X^{-1}(q)\right)</span>
<span id="cb37-1092"><a href="#cb37-1092" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tail-dependence}</span>
<span id="cb37-1093"><a href="#cb37-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1094"><a href="#cb37-1094" aria-hidden="true" tabindex="-1"></a>If $\lambda_L &gt; 0$, the two series exhibit asymptotic tail dependence (i.e., extreme losses tend to occur jointly). For the bivariate normal distribution, $\lambda_L = 0$ for all $|\rho| &lt; 1$ (asymptotic tail independence). This means that any model built on multivariate normality will structurally underestimate the probability of joint crashes. The Student-$t$ copula, by contrast, has $\lambda_L &gt; 0$ for $\rho &gt; -1$, which is why it has become the workhorse model for joint tail risk in finance <span class="co">[</span><span class="ot">@demarta2005t</span><span class="co">]</span>.</span>
<span id="cb37-1095"><a href="#cb37-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1096"><a href="#cb37-1096" aria-hidden="true" tabindex="-1"></a><span class="fu">### Co-Crash Measures</span></span>
<span id="cb37-1097"><a href="#cb37-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1098"><a href="#cb37-1098" aria-hidden="true" tabindex="-1"></a>We implement several empirical measures of joint crash behavior.</span>
<span id="cb37-1099"><a href="#cb37-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1100"><a href="#cb37-1100" aria-hidden="true" tabindex="-1"></a>**Exceedance Correlation.** Following @longin2001extreme, compute the correlation of returns conditional on both returns falling below a threshold $\theta$:</span>
<span id="cb37-1101"><a href="#cb37-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1102"><a href="#cb37-1102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1103"><a href="#cb37-1103" aria-hidden="true" tabindex="-1"></a>\rho^-(\theta) = \text{Corr}(r_i, r_j \mid r_i &lt; \theta, r_j &lt; \theta)</span>
<span id="cb37-1104"><a href="#cb37-1104" aria-hidden="true" tabindex="-1"></a>$$ {#eq-exceedance-corr}</span>
<span id="cb37-1105"><a href="#cb37-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1106"><a href="#cb37-1106" aria-hidden="true" tabindex="-1"></a>If returns are bivariate normal, $\rho^-(\theta) \to 0$ as $\theta \to -\infty$. Empirically, $\rho^-(\theta)$ typically increases as $\theta$ decreases, indicating tail dependence beyond what the normal model implies.</span>
<span id="cb37-1107"><a href="#cb37-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1108"><a href="#cb37-1108" aria-hidden="true" tabindex="-1"></a>**Co-Exceedance Count.** For each day $t$, count the number of stocks or sectors whose returns fall below the $q$-th percentile of their respective marginal distributions:</span>
<span id="cb37-1109"><a href="#cb37-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1110"><a href="#cb37-1110" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1111"><a href="#cb37-1111" aria-hidden="true" tabindex="-1"></a>C_t(q) = \sum_{i=1}^{N} \mathbb{1}\left(r_{i,t} &lt; F_i^{-1}(q)\right)</span>
<span id="cb37-1112"><a href="#cb37-1112" aria-hidden="true" tabindex="-1"></a>$$ {#eq-coexceedance}</span>
<span id="cb37-1113"><a href="#cb37-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1114"><a href="#cb37-1114" aria-hidden="true" tabindex="-1"></a>Days with high $C_t(q)$ represent system-wide stress events.</span>
<span id="cb37-1115"><a href="#cb37-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1118"><a href="#cb37-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1119"><a href="#cb37-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tail-dependence-estimation</span></span>
<span id="cb37-1120"><a href="#cb37-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1121"><a href="#cb37-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1122"><a href="#cb37-1122" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> empirical_tail_dependence(x, y, quantiles<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb37-1123"><a href="#cb37-1123" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-1124"><a href="#cb37-1124" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate lower tail dependence coefficient at various quantiles.</span></span>
<span id="cb37-1125"><a href="#cb37-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1126"><a href="#cb37-1126" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses the empirical copula approach: transform to uniform margins,</span></span>
<span id="cb37-1127"><a href="#cb37-1127" aria-hidden="true" tabindex="-1"></a><span class="co">    then estimate P(V &lt;= q | U &lt;= q) for decreasing q.</span></span>
<span id="cb37-1128"><a href="#cb37-1128" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-1129"><a href="#cb37-1129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> quantiles <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb37-1130"><a href="#cb37-1130" aria-hidden="true" tabindex="-1"></a>        quantiles <span class="op">=</span> [<span class="fl">0.20</span>, <span class="fl">0.15</span>, <span class="fl">0.10</span>, <span class="fl">0.05</span>, <span class="fl">0.03</span>, <span class="fl">0.01</span>]</span>
<span id="cb37-1131"><a href="#cb37-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1132"><a href="#cb37-1132" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Transform to uniform margins via empirical CDF</span></span>
<span id="cb37-1133"><a href="#cb37-1133" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.stats <span class="im">import</span> rankdata</span>
<span id="cb37-1134"><a href="#cb37-1134" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(x)</span>
<span id="cb37-1135"><a href="#cb37-1135" aria-hidden="true" tabindex="-1"></a>    u <span class="op">=</span> rankdata(x) <span class="op">/</span> (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb37-1136"><a href="#cb37-1136" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> rankdata(y) <span class="op">/</span> (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb37-1137"><a href="#cb37-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1138"><a href="#cb37-1138" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-1139"><a href="#cb37-1139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> quantiles:</span>
<span id="cb37-1140"><a href="#cb37-1140" aria-hidden="true" tabindex="-1"></a>        mask_u <span class="op">=</span> u <span class="op">&lt;=</span> q</span>
<span id="cb37-1141"><a href="#cb37-1141" aria-hidden="true" tabindex="-1"></a>        mask_both <span class="op">=</span> mask_u <span class="op">&amp;</span> (v <span class="op">&lt;=</span> q)</span>
<span id="cb37-1142"><a href="#cb37-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1143"><a href="#cb37-1143" aria-hidden="true" tabindex="-1"></a>        n_u <span class="op">=</span> mask_u.<span class="bu">sum</span>()</span>
<span id="cb37-1144"><a href="#cb37-1144" aria-hidden="true" tabindex="-1"></a>        n_both <span class="op">=</span> mask_both.<span class="bu">sum</span>()</span>
<span id="cb37-1145"><a href="#cb37-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1146"><a href="#cb37-1146" aria-hidden="true" tabindex="-1"></a>        lambda_hat <span class="op">=</span> n_both <span class="op">/</span> n_u <span class="cf">if</span> n_u <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb37-1147"><a href="#cb37-1147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1148"><a href="#cb37-1148" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb37-1149"><a href="#cb37-1149" aria-hidden="true" tabindex="-1"></a>            <span class="st">"quantile"</span>: q,</span>
<span id="cb37-1150"><a href="#cb37-1150" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lambda_L"</span>: lambda_hat,</span>
<span id="cb37-1151"><a href="#cb37-1151" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_below_x"</span>: <span class="bu">int</span>(n_u),</span>
<span id="cb37-1152"><a href="#cb37-1152" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_co_crash"</span>: <span class="bu">int</span>(n_both)</span>
<span id="cb37-1153"><a href="#cb37-1153" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-1154"><a href="#cb37-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1155"><a href="#cb37-1155" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb37-1156"><a href="#cb37-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1157"><a href="#cb37-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1160"><a href="#cb37-1160" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1161"><a href="#cb37-1161" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sector-tail-dependence</span></span>
<span id="cb37-1162"><a href="#cb37-1162" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1163"><a href="#cb37-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1164"><a href="#cb37-1164" aria-hidden="true" tabindex="-1"></a><span class="co"># Load sector-level daily returns</span></span>
<span id="cb37-1165"><a href="#cb37-1165" aria-hidden="true" tabindex="-1"></a>sector_returns <span class="op">=</span> dc.get_sector_returns(</span>
<span id="cb37-1166"><a href="#cb37-1166" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2010-01-01"</span>,</span>
<span id="cb37-1167"><a href="#cb37-1167" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb37-1168"><a href="#cb37-1168" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb37-1169"><a href="#cb37-1169" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1170"><a href="#cb37-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1171"><a href="#cb37-1171" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute pairwise tail dependence for major sectors</span></span>
<span id="cb37-1172"><a href="#cb37-1172" aria-hidden="true" tabindex="-1"></a>sectors <span class="op">=</span> sector_returns[<span class="st">"sector"</span>].unique()[:<span class="dv">8</span>]  <span class="co"># Top 8 sectors</span></span>
<span id="cb37-1173"><a href="#cb37-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1174"><a href="#cb37-1174" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb37-1175"><a href="#cb37-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1176"><a href="#cb37-1176" aria-hidden="true" tabindex="-1"></a>pairwise_td <span class="op">=</span> []</span>
<span id="cb37-1177"><a href="#cb37-1177" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s1, s2 <span class="kw">in</span> itertools.combinations(sectors, <span class="dv">2</span>):</span>
<span id="cb37-1178"><a href="#cb37-1178" aria-hidden="true" tabindex="-1"></a>    r1 <span class="op">=</span> sector_returns.loc[</span>
<span id="cb37-1179"><a href="#cb37-1179" aria-hidden="true" tabindex="-1"></a>        sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> s1, [<span class="st">"date"</span>, <span class="st">"ret"</span>]</span>
<span id="cb37-1180"><a href="#cb37-1180" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"date"</span>)[<span class="st">"ret"</span>]</span>
<span id="cb37-1181"><a href="#cb37-1181" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> sector_returns.loc[</span>
<span id="cb37-1182"><a href="#cb37-1182" aria-hidden="true" tabindex="-1"></a>        sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> s2, [<span class="st">"date"</span>, <span class="st">"ret"</span>]</span>
<span id="cb37-1183"><a href="#cb37-1183" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">"date"</span>)[<span class="st">"ret"</span>]</span>
<span id="cb37-1184"><a href="#cb37-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1185"><a href="#cb37-1185" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align dates</span></span>
<span id="cb37-1186"><a href="#cb37-1186" aria-hidden="true" tabindex="-1"></a>    aligned <span class="op">=</span> pd.concat([r1, r2], axis<span class="op">=</span><span class="dv">1</span>, join<span class="op">=</span><span class="st">"inner"</span>).dropna()</span>
<span id="cb37-1187"><a href="#cb37-1187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(aligned) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb37-1188"><a href="#cb37-1188" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb37-1189"><a href="#cb37-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1190"><a href="#cb37-1190" aria-hidden="true" tabindex="-1"></a>    td <span class="op">=</span> empirical_tail_dependence(</span>
<span id="cb37-1191"><a href="#cb37-1191" aria-hidden="true" tabindex="-1"></a>        aligned.iloc[:, <span class="dv">0</span>].values,</span>
<span id="cb37-1192"><a href="#cb37-1192" aria-hidden="true" tabindex="-1"></a>        aligned.iloc[:, <span class="dv">1</span>].values,</span>
<span id="cb37-1193"><a href="#cb37-1193" aria-hidden="true" tabindex="-1"></a>        quantiles<span class="op">=</span>[<span class="fl">0.05</span>]</span>
<span id="cb37-1194"><a href="#cb37-1194" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1195"><a href="#cb37-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1196"><a href="#cb37-1196" aria-hidden="true" tabindex="-1"></a>    pairwise_td.append({</span>
<span id="cb37-1197"><a href="#cb37-1197" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector_1"</span>: s1,</span>
<span id="cb37-1198"><a href="#cb37-1198" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector_2"</span>: s2,</span>
<span id="cb37-1199"><a href="#cb37-1199" aria-hidden="true" tabindex="-1"></a>        <span class="st">"lambda_L_5pct"</span>: td[<span class="st">"lambda_L"</span>].iloc[<span class="dv">0</span>],</span>
<span id="cb37-1200"><a href="#cb37-1200" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pearson_corr"</span>: aligned.iloc[:, <span class="dv">0</span>].corr(aligned.iloc[:, <span class="dv">1</span>])</span>
<span id="cb37-1201"><a href="#cb37-1201" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-1202"><a href="#cb37-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1203"><a href="#cb37-1203" aria-hidden="true" tabindex="-1"></a>td_df <span class="op">=</span> pd.DataFrame(pairwise_td)</span>
<span id="cb37-1204"><a href="#cb37-1204" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1205"><a href="#cb37-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1208"><a href="#cb37-1208" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1209"><a href="#cb37-1209" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-tail-dependence</span></span>
<span id="cb37-1210"><a href="#cb37-1210" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1211"><a href="#cb37-1211" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Pairwise Tail Dependence vs. Linear Correlation Across Sectors"</span></span>
<span id="cb37-1212"><a href="#cb37-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1213"><a href="#cb37-1213" aria-hidden="true" tabindex="-1"></a>td_display <span class="op">=</span> td_df.copy()</span>
<span id="cb37-1214"><a href="#cb37-1214" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"lambda_L_5pct"</span>] <span class="op">=</span> td_display[<span class="st">"lambda_L_5pct"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-1215"><a href="#cb37-1215" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"pearson_corr"</span>] <span class="op">=</span> td_display[<span class="st">"pearson_corr"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-1216"><a href="#cb37-1216" aria-hidden="true" tabindex="-1"></a>td_display[<span class="st">"ratio"</span>] <span class="op">=</span> (</span>
<span id="cb37-1217"><a href="#cb37-1217" aria-hidden="true" tabindex="-1"></a>    td_display[<span class="st">"lambda_L_5pct"</span>] <span class="op">/</span> td_display[<span class="st">"pearson_corr"</span>]</span>
<span id="cb37-1218"><a href="#cb37-1218" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb37-1219"><a href="#cb37-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1220"><a href="#cb37-1220" aria-hidden="true" tabindex="-1"></a>td_display.sort_values(<span class="st">"lambda_L_5pct"</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">15</span>)</span>
<span id="cb37-1221"><a href="#cb37-1221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1222"><a href="#cb37-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1223"><a href="#cb37-1223" aria-hidden="true" tabindex="-1"></a>The ratio column in @tbl-tail-dependence is particularly informative. When $\lambda_L / \rho \gg 1$, the sectors exhibit disproportionately high co-crash frequency relative to their overall correlation. This is the hallmark of tail dependence that Gaussian models miss.</span>
<span id="cb37-1224"><a href="#cb37-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1225"><a href="#cb37-1225" aria-hidden="true" tabindex="-1"></a><span class="fu">### System-Wide Stress Transmission</span></span>
<span id="cb37-1226"><a href="#cb37-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1227"><a href="#cb37-1227" aria-hidden="true" tabindex="-1"></a>To assess system-wide contagion dynamics, we construct daily co-exceedance counts and examine their time-series properties.</span>
<span id="cb37-1228"><a href="#cb37-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1231"><a href="#cb37-1231" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1232"><a href="#cb37-1232" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: coexceedance</span></span>
<span id="cb37-1233"><a href="#cb37-1233" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1234"><a href="#cb37-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1235"><a href="#cb37-1235" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily co-exceedance count at the 5% level</span></span>
<span id="cb37-1236"><a href="#cb37-1236" aria-hidden="true" tabindex="-1"></a>sector_wide <span class="op">=</span> sector_returns.pivot_table(</span>
<span id="cb37-1237"><a href="#cb37-1237" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"sector"</span>, values<span class="op">=</span><span class="st">"ret"</span></span>
<span id="cb37-1238"><a href="#cb37-1238" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1239"><a href="#cb37-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1240"><a href="#cb37-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling 252-day quantile thresholds</span></span>
<span id="cb37-1241"><a href="#cb37-1241" aria-hidden="true" tabindex="-1"></a>quantile_thresholds <span class="op">=</span> sector_wide.rolling(<span class="dv">252</span>, min_periods<span class="op">=</span><span class="dv">60</span>).quantile(<span class="fl">0.05</span>)</span>
<span id="cb37-1242"><a href="#cb37-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1243"><a href="#cb37-1243" aria-hidden="true" tabindex="-1"></a><span class="co"># Indicator: return below rolling 5th percentile</span></span>
<span id="cb37-1244"><a href="#cb37-1244" aria-hidden="true" tabindex="-1"></a>exceedance_indicators <span class="op">=</span> (sector_wide <span class="op">&lt;</span> quantile_thresholds).astype(<span class="bu">int</span>)</span>
<span id="cb37-1245"><a href="#cb37-1245" aria-hidden="true" tabindex="-1"></a>co_exceedance <span class="op">=</span> exceedance_indicators.<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-1246"><a href="#cb37-1246" aria-hidden="true" tabindex="-1"></a>co_exceedance.name <span class="op">=</span> <span class="st">"co_exceedance"</span></span>
<span id="cb37-1247"><a href="#cb37-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1248"><a href="#cb37-1248" aria-hidden="true" tabindex="-1"></a>co_exceed_df <span class="op">=</span> co_exceedance.reset_index()</span>
<span id="cb37-1249"><a href="#cb37-1249" aria-hidden="true" tabindex="-1"></a>co_exceed_df.columns <span class="op">=</span> [<span class="st">"date"</span>, <span class="st">"co_exceedance"</span>]</span>
<span id="cb37-1250"><a href="#cb37-1250" aria-hidden="true" tabindex="-1"></a>co_exceed_df[<span class="st">"n_sectors"</span>] <span class="op">=</span> exceedance_indicators.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>).values</span>
<span id="cb37-1251"><a href="#cb37-1251" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1252"><a href="#cb37-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1255"><a href="#cb37-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1256"><a href="#cb37-1256" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-coexceedance-ts</span></span>
<span id="cb37-1257"><a href="#cb37-1257" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1258"><a href="#cb37-1258" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Daily Co-Exceedance Count: Number of Sectors Below Their 5th Percentile"</span></span>
<span id="cb37-1259"><a href="#cb37-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1260"><a href="#cb37-1260" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-1261"><a href="#cb37-1261" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(co_exceed_df.dropna(), p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"co_exceedance"</span>))</span>
<span id="cb37-1262"><a href="#cb37-1262" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb37-1263"><a href="#cb37-1263" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1264"><a href="#cb37-1264" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-1265"><a href="#cb37-1265" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb37-1266"><a href="#cb37-1266" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of Sectors in Left Tail"</span>,</span>
<span id="cb37-1267"><a href="#cb37-1267" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"System-Wide Stress: Daily Co-Exceedance Count"</span></span>
<span id="cb37-1268"><a href="#cb37-1268" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1269"><a href="#cb37-1269" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-1270"><a href="#cb37-1270" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb37-1271"><a href="#cb37-1271" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1272"><a href="#cb37-1272" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1273"><a href="#cb37-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1274"><a href="#cb37-1274" aria-hidden="true" tabindex="-1"></a>Peaks in the co-exceedance series correspond to system-wide stress episodes. The smoothed trend (red line) reveals the evolving baseline level of systemic fragility.</span>
<span id="cb37-1275"><a href="#cb37-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1276"><a href="#cb37-1276" aria-hidden="true" tabindex="-1"></a><span class="fu">### Financial Contagion Mechanisms</span></span>
<span id="cb37-1277"><a href="#cb37-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1278"><a href="#cb37-1278" aria-hidden="true" tabindex="-1"></a>The literature distinguishes several channels through which stress propagates across assets, sectors, and markets <span class="co">[</span><span class="ot">@forbes2002no; @kaminsky2002unholy</span><span class="co">]</span>:</span>
<span id="cb37-1279"><a href="#cb37-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1280"><a href="#cb37-1280" aria-hidden="true" tabindex="-1"></a>**Direct linkages.** Balance sheet interconnections, interbank lending, and cross-holdings create direct transmission channels. When institution $A$ holds assets issued by institution $B$, losses at $B$ directly impair $A$'s balance sheet.</span>
<span id="cb37-1281"><a href="#cb37-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1282"><a href="#cb37-1282" aria-hidden="true" tabindex="-1"></a>**Information contagion.** Adverse news about one firm triggers reassessment of similarly exposed firms. @king1990transmission and @kodres2002rational formalize this via Bayesian updating: investors cannot distinguish idiosyncratic from systematic shocks, so a crash in one asset leads them to update beliefs about common risk factors.</span>
<span id="cb37-1283"><a href="#cb37-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1284"><a href="#cb37-1284" aria-hidden="true" tabindex="-1"></a>**Liquidity contagion.** Fire sales by distressed institutions depress prices of commonly held assets, creating losses for other holders. @brunnermeier2009deciphering model this as a liquidity spiral: declining prices trigger margin calls, which force further sales, further depressing prices. In Vietnamese markets, the absence of circuit breakers beyond price limits and the concentration of holdings among a few large institutional investors amplify this channel.</span>
<span id="cb37-1285"><a href="#cb37-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1286"><a href="#cb37-1286" aria-hidden="true" tabindex="-1"></a>**Behavioral contagion.** Herding behavior (i.e., investors mimicking others' trades) generates correlated selling pressure even in the absence of fundamental linkages. @bikhchandani1992theory and @banerjee1992simple provide theoretical foundations. @choe2005domestic document herding in emerging markets specifically.</span>
<span id="cb37-1287"><a href="#cb37-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1288"><a href="#cb37-1288" aria-hidden="true" tabindex="-1"></a>We can test for contagion (as distinct from interdependence) using the @forbes2002no framework. The null hypothesis is that the co-movement observed during a crisis period is fully explained by the increase in volatility (which mechanically inflates correlations). The adjusted correlation is:</span>
<span id="cb37-1289"><a href="#cb37-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1290"><a href="#cb37-1290" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1291"><a href="#cb37-1291" aria-hidden="true" tabindex="-1"></a>\rho^* = \frac{\rho_{\text{crisis}}}{\sqrt{1 + \delta<span class="co">[</span><span class="ot">1 - \rho_{\text{crisis}}^2</span><span class="co">]</span>}}</span>
<span id="cb37-1292"><a href="#cb37-1292" aria-hidden="true" tabindex="-1"></a>$$ {#eq-forbes-rigobon}</span>
<span id="cb37-1293"><a href="#cb37-1293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1294"><a href="#cb37-1294" aria-hidden="true" tabindex="-1"></a>where $\delta = \sigma_{\text{crisis}}^2 / \sigma_{\text{tranquil}}^2 - 1$ is the relative increase in variance. If $\rho^* &gt; \rho_{\text{tranquil}}$, the increase in co-movement exceeds what volatility adjustment alone predicts, which is evidence of contagion.</span>
<span id="cb37-1295"><a href="#cb37-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1298"><a href="#cb37-1298" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1299"><a href="#cb37-1299" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: contagion-test</span></span>
<span id="cb37-1300"><a href="#cb37-1300" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1301"><a href="#cb37-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1302"><a href="#cb37-1302" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> forbes_rigobon_test(returns_df, crisis_start, crisis_end):</span>
<span id="cb37-1303"><a href="#cb37-1303" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb37-1304"><a href="#cb37-1304" aria-hidden="true" tabindex="-1"></a><span class="co">    Forbes-Rigobon adjusted correlation test for contagion.</span></span>
<span id="cb37-1305"><a href="#cb37-1305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1306"><a href="#cb37-1306" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb37-1307"><a href="#cb37-1307" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb37-1308"><a href="#cb37-1308" aria-hidden="true" tabindex="-1"></a><span class="co">    returns_df : DataFrame</span></span>
<span id="cb37-1309"><a href="#cb37-1309" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns are sector returns, index is date.</span></span>
<span id="cb37-1310"><a href="#cb37-1310" aria-hidden="true" tabindex="-1"></a><span class="co">    crisis_start, crisis_end : str</span></span>
<span id="cb37-1311"><a href="#cb37-1311" aria-hidden="true" tabindex="-1"></a><span class="co">        Crisis period boundaries.</span></span>
<span id="cb37-1312"><a href="#cb37-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1313"><a href="#cb37-1313" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb37-1314"><a href="#cb37-1314" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb37-1315"><a href="#cb37-1315" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Pairwise contagion test results.</span></span>
<span id="cb37-1316"><a href="#cb37-1316" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb37-1317"><a href="#cb37-1317" aria-hidden="true" tabindex="-1"></a>    tranquil <span class="op">=</span> returns_df[returns_df.index <span class="op">&lt;</span> crisis_start].dropna()</span>
<span id="cb37-1318"><a href="#cb37-1318" aria-hidden="true" tabindex="-1"></a>    crisis <span class="op">=</span> returns_df[</span>
<span id="cb37-1319"><a href="#cb37-1319" aria-hidden="true" tabindex="-1"></a>        (returns_df.index <span class="op">&gt;=</span> crisis_start) <span class="op">&amp;</span></span>
<span id="cb37-1320"><a href="#cb37-1320" aria-hidden="true" tabindex="-1"></a>        (returns_df.index <span class="op">&lt;=</span> crisis_end)</span>
<span id="cb37-1321"><a href="#cb37-1321" aria-hidden="true" tabindex="-1"></a>    ].dropna()</span>
<span id="cb37-1322"><a href="#cb37-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1323"><a href="#cb37-1323" aria-hidden="true" tabindex="-1"></a>    sectors <span class="op">=</span> returns_df.columns.tolist()</span>
<span id="cb37-1324"><a href="#cb37-1324" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-1325"><a href="#cb37-1325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1326"><a href="#cb37-1326" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> s1, s2 <span class="kw">in</span> itertools.combinations(sectors, <span class="dv">2</span>):</span>
<span id="cb37-1327"><a href="#cb37-1327" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> s1 <span class="kw">not</span> <span class="kw">in</span> tranquil.columns <span class="kw">or</span> s2 <span class="kw">not</span> <span class="kw">in</span> crisis.columns:</span>
<span id="cb37-1328"><a href="#cb37-1328" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-1329"><a href="#cb37-1329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1330"><a href="#cb37-1330" aria-hidden="true" tabindex="-1"></a>        rho_t <span class="op">=</span> tranquil[s1].corr(tranquil[s2])</span>
<span id="cb37-1331"><a href="#cb37-1331" aria-hidden="true" tabindex="-1"></a>        rho_c <span class="op">=</span> crisis[s1].corr(crisis[s2])</span>
<span id="cb37-1332"><a href="#cb37-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1333"><a href="#cb37-1333" aria-hidden="true" tabindex="-1"></a>        var_t <span class="op">=</span> tranquil[s1].var()</span>
<span id="cb37-1334"><a href="#cb37-1334" aria-hidden="true" tabindex="-1"></a>        var_c <span class="op">=</span> crisis[s1].var()</span>
<span id="cb37-1335"><a href="#cb37-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1336"><a href="#cb37-1336" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> var_t <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb37-1337"><a href="#cb37-1337" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb37-1338"><a href="#cb37-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1339"><a href="#cb37-1339" aria-hidden="true" tabindex="-1"></a>        delta <span class="op">=</span> var_c <span class="op">/</span> var_t <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb37-1340"><a href="#cb37-1340" aria-hidden="true" tabindex="-1"></a>        rho_adj <span class="op">=</span> rho_c <span class="op">/</span> np.sqrt(<span class="dv">1</span> <span class="op">+</span> delta <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> rho_c<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb37-1341"><a href="#cb37-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1342"><a href="#cb37-1342" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb37-1343"><a href="#cb37-1343" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sector_1"</span>: s1,</span>
<span id="cb37-1344"><a href="#cb37-1344" aria-hidden="true" tabindex="-1"></a>            <span class="st">"sector_2"</span>: s2,</span>
<span id="cb37-1345"><a href="#cb37-1345" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_tranquil"</span>: <span class="bu">round</span>(rho_t, <span class="dv">4</span>),</span>
<span id="cb37-1346"><a href="#cb37-1346" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_crisis"</span>: <span class="bu">round</span>(rho_c, <span class="dv">4</span>),</span>
<span id="cb37-1347"><a href="#cb37-1347" aria-hidden="true" tabindex="-1"></a>            <span class="st">"rho_adjusted"</span>: <span class="bu">round</span>(rho_adj, <span class="dv">4</span>),</span>
<span id="cb37-1348"><a href="#cb37-1348" aria-hidden="true" tabindex="-1"></a>            <span class="st">"contagion"</span>: rho_adj <span class="op">&gt;</span> rho_t</span>
<span id="cb37-1349"><a href="#cb37-1349" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb37-1350"><a href="#cb37-1350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1351"><a href="#cb37-1351" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb37-1352"><a href="#cb37-1352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1353"><a href="#cb37-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1356"><a href="#cb37-1356" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1357"><a href="#cb37-1357" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: contagion-covid</span></span>
<span id="cb37-1358"><a href="#cb37-1358" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1359"><a href="#cb37-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1360"><a href="#cb37-1360" aria-hidden="true" tabindex="-1"></a><span class="co"># Test for contagion during COVID-19 crash</span></span>
<span id="cb37-1361"><a href="#cb37-1361" aria-hidden="true" tabindex="-1"></a>contagion_covid <span class="op">=</span> forbes_rigobon_test(</span>
<span id="cb37-1362"><a href="#cb37-1362" aria-hidden="true" tabindex="-1"></a>    sector_wide,</span>
<span id="cb37-1363"><a href="#cb37-1363" aria-hidden="true" tabindex="-1"></a>    crisis_start<span class="op">=</span><span class="st">"2020-02-01"</span>,</span>
<span id="cb37-1364"><a href="#cb37-1364" aria-hidden="true" tabindex="-1"></a>    crisis_end<span class="op">=</span><span class="st">"2020-04-30"</span></span>
<span id="cb37-1365"><a href="#cb37-1365" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1366"><a href="#cb37-1366" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1367"><a href="#cb37-1367" aria-hidden="true" tabindex="-1"></a>n_pairs <span class="op">=</span> <span class="bu">len</span>(contagion_covid)</span>
<span id="cb37-1368"><a href="#cb37-1368" aria-hidden="true" tabindex="-1"></a>n_contagion <span class="op">=</span> contagion_covid[<span class="st">"contagion"</span>].<span class="bu">sum</span>()</span>
<span id="cb37-1369"><a href="#cb37-1369" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"COVID-19 contagion test: </span><span class="sc">{</span>n_contagion<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_pairs<span class="sc">}</span><span class="ss"> sector pairs "</span></span>
<span id="cb37-1370"><a href="#cb37-1370" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"show evidence of contagion (</span><span class="sc">{</span><span class="dv">100</span><span class="op">*</span>n_contagion<span class="op">/</span>n_pairs<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb37-1371"><a href="#cb37-1371" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1372"><a href="#cb37-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1375"><a href="#cb37-1375" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1376"><a href="#cb37-1376" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-contagion-results</span></span>
<span id="cb37-1377"><a href="#cb37-1377" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1378"><a href="#cb37-1378" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Forbes-Rigobon Contagion Test: COVID-19 Crisis Period"</span></span>
<span id="cb37-1379"><a href="#cb37-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1380"><a href="#cb37-1380" aria-hidden="true" tabindex="-1"></a>contagion_covid.sort_values(</span>
<span id="cb37-1381"><a href="#cb37-1381" aria-hidden="true" tabindex="-1"></a>    <span class="st">"rho_adjusted"</span>, ascending<span class="op">=</span><span class="va">False</span></span>
<span id="cb37-1382"><a href="#cb37-1382" aria-hidden="true" tabindex="-1"></a>).head(<span class="dv">15</span>)</span>
<span id="cb37-1383"><a href="#cb37-1383" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1384"><a href="#cb37-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1385"><a href="#cb37-1385" aria-hidden="true" tabindex="-1"></a><span class="fu">## Applications to Financial Stability</span></span>
<span id="cb37-1386"><a href="#cb37-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1387"><a href="#cb37-1387" aria-hidden="true" tabindex="-1"></a><span class="fu">### Market-Wide Stress Indicators</span></span>
<span id="cb37-1388"><a href="#cb37-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1389"><a href="#cb37-1389" aria-hidden="true" tabindex="-1"></a>We construct several market-wide stress indicators that aggregate the individual-level and sectoral tail risk measures developed above into a comprehensive system-level diagnostic.</span>
<span id="cb37-1390"><a href="#cb37-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1391"><a href="#cb37-1391" aria-hidden="true" tabindex="-1"></a>**Aggregate Crash Risk Index.** The cross-sectional average of firm-level NCSKEW provides a market-wide measure of crash risk that is forward-looking (it captures the buildup of negative skewness before a crash materializes):</span>
<span id="cb37-1392"><a href="#cb37-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1393"><a href="#cb37-1393" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1394"><a href="#cb37-1394" aria-hidden="true" tabindex="-1"></a>\text{ACRI}_y = \frac{1}{N_y}\sum_{i=1}^{N_y} \text{NCSKEW}_{i,y}</span>
<span id="cb37-1395"><a href="#cb37-1395" aria-hidden="true" tabindex="-1"></a>$$ {#eq-acri}</span>
<span id="cb37-1396"><a href="#cb37-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1397"><a href="#cb37-1397" aria-hidden="true" tabindex="-1"></a>**Market Tail Risk (MTR).** Following @kelly2014tail, we estimate the time-varying tail risk of the market portfolio using option-implied or realized tail measures. In the absence of a liquid options market in Vietnam, we use the realized version based on the Hill tail index estimated from rolling windows:</span>
<span id="cb37-1398"><a href="#cb37-1398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1399"><a href="#cb37-1399" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb37-1400"><a href="#cb37-1400" aria-hidden="true" tabindex="-1"></a>\text{MTR}_t = \hat{\xi}_t^{\text{Hill}} \cdot \hat{\sigma}_t</span>
<span id="cb37-1401"><a href="#cb37-1401" aria-hidden="true" tabindex="-1"></a>$$ {#eq-mtr}</span>
<span id="cb37-1402"><a href="#cb37-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1403"><a href="#cb37-1403" aria-hidden="true" tabindex="-1"></a>where $\hat{\xi}_t^{\text{Hill}}$ is the Hill estimator computed from a trailing 252-day window and $\hat{\sigma}_t$ is the conditional volatility (e.g., from GARCH). This interaction captures both the thickness of the tail and the current scale of volatility.</span>
<span id="cb37-1404"><a href="#cb37-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1407"><a href="#cb37-1407" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1408"><a href="#cb37-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: stability-indicators</span></span>
<span id="cb37-1409"><a href="#cb37-1409" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1410"><a href="#cb37-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1411"><a href="#cb37-1411" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate Crash Risk Index</span></span>
<span id="cb37-1412"><a href="#cb37-1412" aria-hidden="true" tabindex="-1"></a>acri <span class="op">=</span> (</span>
<span id="cb37-1413"><a href="#cb37-1413" aria-hidden="true" tabindex="-1"></a>    crash_risk.groupby(<span class="st">"year"</span>)</span>
<span id="cb37-1414"><a href="#cb37-1414" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb37-1415"><a href="#cb37-1415" aria-hidden="true" tabindex="-1"></a>        acri<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"mean"</span>),</span>
<span id="cb37-1416"><a href="#cb37-1416" aria-hidden="true" tabindex="-1"></a>        median_ncskew<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"median"</span>),</span>
<span id="cb37-1417"><a href="#cb37-1417" aria-hidden="true" tabindex="-1"></a>        pct_high_crash<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> x.quantile(<span class="fl">0.75</span>)).mean()),</span>
<span id="cb37-1418"><a href="#cb37-1418" aria-hidden="true" tabindex="-1"></a>        n_firms<span class="op">=</span>(<span class="st">"ncskew"</span>, <span class="st">"count"</span>)</span>
<span id="cb37-1419"><a href="#cb37-1419" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1420"><a href="#cb37-1420" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb37-1421"><a href="#cb37-1421" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1422"><a href="#cb37-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1423"><a href="#cb37-1423" aria-hidden="true" tabindex="-1"></a><span class="co"># Market Tail Risk: rolling Hill estimator x rolling volatility</span></span>
<span id="cb37-1424"><a href="#cb37-1424" aria-hidden="true" tabindex="-1"></a>mkt_returns <span class="op">=</span> market_daily[<span class="st">"mkt_ret"</span>].dropna().values</span>
<span id="cb37-1425"><a href="#cb37-1425" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> market_daily[<span class="st">"date"</span>].dropna().values</span>
<span id="cb37-1426"><a href="#cb37-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1427"><a href="#cb37-1427" aria-hidden="true" tabindex="-1"></a>mtr_list <span class="op">=</span> []</span>
<span id="cb37-1428"><a href="#cb37-1428" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> end_idx <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">504</span>, <span class="bu">len</span>(mkt_returns)):</span>
<span id="cb37-1429"><a href="#cb37-1429" aria-hidden="true" tabindex="-1"></a>    window_ret <span class="op">=</span> mkt_returns[end_idx <span class="op">-</span> <span class="dv">252</span>:end_idx]</span>
<span id="cb37-1430"><a href="#cb37-1430" aria-hidden="true" tabindex="-1"></a>    losses_pos <span class="op">=</span> <span class="op">-</span>window_ret[window_ret <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb37-1431"><a href="#cb37-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1432"><a href="#cb37-1432" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(losses_pos) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb37-1433"><a href="#cb37-1433" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb37-1434"><a href="#cb37-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1435"><a href="#cb37-1435" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hill estimator at k = 50</span></span>
<span id="cb37-1436"><a href="#cb37-1436" aria-hidden="true" tabindex="-1"></a>    sorted_losses <span class="op">=</span> np.sort(losses_pos)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1437"><a href="#cb37-1437" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">min</span>(<span class="dv">50</span>, <span class="bu">len</span>(sorted_losses) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb37-1438"><a href="#cb37-1438" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb37-1439"><a href="#cb37-1439" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb37-1440"><a href="#cb37-1440" aria-hidden="true" tabindex="-1"></a>    log_excess <span class="op">=</span> np.log(sorted_losses[:k]) <span class="op">-</span> np.log(sorted_losses[k])</span>
<span id="cb37-1441"><a href="#cb37-1441" aria-hidden="true" tabindex="-1"></a>    xi_hat <span class="op">=</span> log_excess.mean()</span>
<span id="cb37-1442"><a href="#cb37-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1443"><a href="#cb37-1443" aria-hidden="true" tabindex="-1"></a>    sigma_hat <span class="op">=</span> window_ret.std()</span>
<span id="cb37-1444"><a href="#cb37-1444" aria-hidden="true" tabindex="-1"></a>    mtr <span class="op">=</span> xi_hat <span class="op">*</span> sigma_hat</span>
<span id="cb37-1445"><a href="#cb37-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1446"><a href="#cb37-1446" aria-hidden="true" tabindex="-1"></a>    mtr_list.append({</span>
<span id="cb37-1447"><a href="#cb37-1447" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: dates[end_idx],</span>
<span id="cb37-1448"><a href="#cb37-1448" aria-hidden="true" tabindex="-1"></a>        <span class="st">"xi_hat"</span>: xi_hat,</span>
<span id="cb37-1449"><a href="#cb37-1449" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sigma_hat"</span>: sigma_hat,</span>
<span id="cb37-1450"><a href="#cb37-1450" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mtr"</span>: mtr</span>
<span id="cb37-1451"><a href="#cb37-1451" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-1452"><a href="#cb37-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1453"><a href="#cb37-1453" aria-hidden="true" tabindex="-1"></a>mtr_df <span class="op">=</span> pd.DataFrame(mtr_list)</span>
<span id="cb37-1454"><a href="#cb37-1454" aria-hidden="true" tabindex="-1"></a>mtr_df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(mtr_df[<span class="st">"date"</span>])</span>
<span id="cb37-1455"><a href="#cb37-1455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1456"><a href="#cb37-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1459"><a href="#cb37-1459" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1460"><a href="#cb37-1460" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-stability-dashboard</span></span>
<span id="cb37-1461"><a href="#cb37-1461" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1462"><a href="#cb37-1462" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Market Tail Risk Indicator Over Time"</span></span>
<span id="cb37-1463"><a href="#cb37-1463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1464"><a href="#cb37-1464" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-1465"><a href="#cb37-1465" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(mtr_df, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"mtr"</span>))</span>
<span id="cb37-1466"><a href="#cb37-1466" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb37-1467"><a href="#cb37-1467" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1468"><a href="#cb37-1468" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-1469"><a href="#cb37-1469" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb37-1470"><a href="#cb37-1470" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"MTR (Œæ √ó œÉ)"</span>,</span>
<span id="cb37-1471"><a href="#cb37-1471" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Market Tail Risk: Rolling Hill Index √ó Conditional Volatility"</span></span>
<span id="cb37-1472"><a href="#cb37-1472" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1473"><a href="#cb37-1473" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-1474"><a href="#cb37-1474" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb37-1475"><a href="#cb37-1475" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1476"><a href="#cb37-1476" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1477"><a href="#cb37-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1478"><a href="#cb37-1478" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sectoral Fragility</span></span>
<span id="cb37-1479"><a href="#cb37-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1480"><a href="#cb37-1480" aria-hidden="true" tabindex="-1"></a>Not all sectors are equally vulnerable to tail events. We decompose system-wide tail risk into sectoral contributions to identify the most fragile parts of the market.</span>
<span id="cb37-1481"><a href="#cb37-1481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1484"><a href="#cb37-1484" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1485"><a href="#cb37-1485" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sectoral-fragility</span></span>
<span id="cb37-1486"><a href="#cb37-1486" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1487"><a href="#cb37-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1488"><a href="#cb37-1488" aria-hidden="true" tabindex="-1"></a><span class="co"># Sector-level tail statistics</span></span>
<span id="cb37-1489"><a href="#cb37-1489" aria-hidden="true" tabindex="-1"></a>sector_tail_stats <span class="op">=</span> []</span>
<span id="cb37-1490"><a href="#cb37-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1491"><a href="#cb37-1491" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sector <span class="kw">in</span> sectors:</span>
<span id="cb37-1492"><a href="#cb37-1492" aria-hidden="true" tabindex="-1"></a>    sector_data <span class="op">=</span> sector_returns[sector_returns[<span class="st">"sector"</span>] <span class="op">==</span> sector][<span class="st">"ret"</span>].dropna()</span>
<span id="cb37-1493"><a href="#cb37-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1494"><a href="#cb37-1494" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(sector_data) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb37-1495"><a href="#cb37-1495" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb37-1496"><a href="#cb37-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1497"><a href="#cb37-1497" aria-hidden="true" tabindex="-1"></a>    s_data <span class="op">=</span> sector_data.values</span>
<span id="cb37-1498"><a href="#cb37-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1499"><a href="#cb37-1499" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skewness and kurtosis</span></span>
<span id="cb37-1500"><a href="#cb37-1500" aria-hidden="true" tabindex="-1"></a>    skew <span class="op">=</span> stats.skew(s_data)</span>
<span id="cb37-1501"><a href="#cb37-1501" aria-hidden="true" tabindex="-1"></a>    kurt <span class="op">=</span> stats.kurtosis(s_data)</span>
<span id="cb37-1502"><a href="#cb37-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1503"><a href="#cb37-1503" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VaR and ES at 1%</span></span>
<span id="cb37-1504"><a href="#cb37-1504" aria-hidden="true" tabindex="-1"></a>    var_1 <span class="op">=</span> <span class="op">-</span>np.quantile(s_data, <span class="fl">0.01</span>)</span>
<span id="cb37-1505"><a href="#cb37-1505" aria-hidden="true" tabindex="-1"></a>    es_1 <span class="op">=</span> <span class="op">-</span>s_data[s_data <span class="op">&lt;=</span> np.quantile(s_data, <span class="fl">0.01</span>)].mean()</span>
<span id="cb37-1506"><a href="#cb37-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1507"><a href="#cb37-1507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hill tail index (k=50)</span></span>
<span id="cb37-1508"><a href="#cb37-1508" aria-hidden="true" tabindex="-1"></a>    losses_pos <span class="op">=</span> <span class="op">-</span>s_data[s_data <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb37-1509"><a href="#cb37-1509" aria-hidden="true" tabindex="-1"></a>    sorted_l <span class="op">=</span> np.sort(losses_pos)[::<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb37-1510"><a href="#cb37-1510" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> <span class="bu">min</span>(<span class="dv">50</span>, <span class="bu">len</span>(sorted_l) <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb37-1511"><a href="#cb37-1511" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> k <span class="op">&gt;=</span> <span class="dv">10</span>:</span>
<span id="cb37-1512"><a href="#cb37-1512" aria-hidden="true" tabindex="-1"></a>        log_exc <span class="op">=</span> np.log(sorted_l[:k]) <span class="op">-</span> np.log(sorted_l[k])</span>
<span id="cb37-1513"><a href="#cb37-1513" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> log_exc.mean()</span>
<span id="cb37-1514"><a href="#cb37-1514" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb37-1515"><a href="#cb37-1515" aria-hidden="true" tabindex="-1"></a>        xi <span class="op">=</span> np.nan</span>
<span id="cb37-1516"><a href="#cb37-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1517"><a href="#cb37-1517" aria-hidden="true" tabindex="-1"></a>    sector_tail_stats.append({</span>
<span id="cb37-1518"><a href="#cb37-1518" aria-hidden="true" tabindex="-1"></a>        <span class="st">"sector"</span>: sector,</span>
<span id="cb37-1519"><a href="#cb37-1519" aria-hidden="true" tabindex="-1"></a>        <span class="st">"skewness"</span>: <span class="bu">round</span>(skew, <span class="dv">3</span>),</span>
<span id="cb37-1520"><a href="#cb37-1520" aria-hidden="true" tabindex="-1"></a>        <span class="st">"excess_kurtosis"</span>: <span class="bu">round</span>(kurt, <span class="dv">3</span>),</span>
<span id="cb37-1521"><a href="#cb37-1521" aria-hidden="true" tabindex="-1"></a>        <span class="st">"var_1pct"</span>: <span class="bu">round</span>(var_1, <span class="dv">4</span>),</span>
<span id="cb37-1522"><a href="#cb37-1522" aria-hidden="true" tabindex="-1"></a>        <span class="st">"es_1pct"</span>: <span class="bu">round</span>(es_1, <span class="dv">4</span>),</span>
<span id="cb37-1523"><a href="#cb37-1523" aria-hidden="true" tabindex="-1"></a>        <span class="st">"tail_index_xi"</span>: <span class="bu">round</span>(xi, <span class="dv">3</span>) <span class="cf">if</span> <span class="kw">not</span> np.isnan(xi) <span class="cf">else</span> np.nan,</span>
<span id="cb37-1524"><a href="#cb37-1524" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_obs"</span>: <span class="bu">len</span>(s_data)</span>
<span id="cb37-1525"><a href="#cb37-1525" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb37-1526"><a href="#cb37-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1527"><a href="#cb37-1527" aria-hidden="true" tabindex="-1"></a>fragility_df <span class="op">=</span> pd.DataFrame(sector_tail_stats)</span>
<span id="cb37-1528"><a href="#cb37-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1529"><a href="#cb37-1529" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1532"><a href="#cb37-1532" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1533"><a href="#cb37-1533" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-sectoral-fragility</span></span>
<span id="cb37-1534"><a href="#cb37-1534" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1535"><a href="#cb37-1535" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Sectoral Tail Risk Profile"</span></span>
<span id="cb37-1536"><a href="#cb37-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1537"><a href="#cb37-1537" aria-hidden="true" tabindex="-1"></a>fragility_df.sort_values(<span class="st">"es_1pct"</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb37-1538"><a href="#cb37-1538" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1539"><a href="#cb37-1539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1542"><a href="#cb37-1542" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1543"><a href="#cb37-1543" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-sector-scatter</span></span>
<span id="cb37-1544"><a href="#cb37-1544" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1545"><a href="#cb37-1545" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Sectoral Risk Map: Expected Shortfall vs. Tail Index"</span></span>
<span id="cb37-1546"><a href="#cb37-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1547"><a href="#cb37-1547" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb37-1548"><a href="#cb37-1548" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(</span>
<span id="cb37-1549"><a href="#cb37-1549" aria-hidden="true" tabindex="-1"></a>        fragility_df.dropna(),</span>
<span id="cb37-1550"><a href="#cb37-1550" aria-hidden="true" tabindex="-1"></a>        p9.aes(x<span class="op">=</span><span class="st">"tail_index_xi"</span>, y<span class="op">=</span><span class="st">"es_1pct"</span>, label<span class="op">=</span><span class="st">"sector"</span>)</span>
<span id="cb37-1551"><a href="#cb37-1551" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1552"><a href="#cb37-1552" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb37-1553"><a href="#cb37-1553" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_text(nudge_y<span class="op">=</span><span class="fl">0.002</span>, size<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb37-1554"><a href="#cb37-1554" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb37-1555"><a href="#cb37-1555" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Tail Index (Œæ, Hill)"</span>,</span>
<span id="cb37-1556"><a href="#cb37-1556" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"1</span><span class="sc">% E</span><span class="st">xpected Shortfall"</span>,</span>
<span id="cb37-1557"><a href="#cb37-1557" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Sector Fragility Map"</span></span>
<span id="cb37-1558"><a href="#cb37-1558" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1559"><a href="#cb37-1559" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb37-1560"><a href="#cb37-1560" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">7</span>))</span>
<span id="cb37-1561"><a href="#cb37-1561" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1562"><a href="#cb37-1562" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1563"><a href="#cb37-1563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1564"><a href="#cb37-1564" aria-hidden="true" tabindex="-1"></a>Sectors in the upper-right quadrant of @fig-sector-scatter exhibit both high expected shortfall (large average losses in the tail) and high tail index (heavier-than-typical tails). These represent the most fragile components of the market from a systemic stability perspective.</span>
<span id="cb37-1565"><a href="#cb37-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1566"><a href="#cb37-1566" aria-hidden="true" tabindex="-1"></a><span class="fu">### Crisis Diagnostics</span></span>
<span id="cb37-1567"><a href="#cb37-1567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1568"><a href="#cb37-1568" aria-hidden="true" tabindex="-1"></a>We construct a comprehensive crisis diagnostic framework that combines the indicators developed above to identify, characterize, and compare stress episodes in Vietnamese financial markets.</span>
<span id="cb37-1569"><a href="#cb37-1569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1572"><a href="#cb37-1572" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1573"><a href="#cb37-1573" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: crisis-diagnostics</span></span>
<span id="cb37-1574"><a href="#cb37-1574" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1575"><a href="#cb37-1575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1576"><a href="#cb37-1576" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify extreme co-exceedance days (system-wide stress events)</span></span>
<span id="cb37-1577"><a href="#cb37-1577" aria-hidden="true" tabindex="-1"></a>threshold_high_stress <span class="op">=</span> co_exceed_df[<span class="st">"co_exceedance"</span>].quantile(<span class="fl">0.99</span>)</span>
<span id="cb37-1578"><a href="#cb37-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1579"><a href="#cb37-1579" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> co_exceed_df[</span>
<span id="cb37-1580"><a href="#cb37-1580" aria-hidden="true" tabindex="-1"></a>    co_exceed_df[<span class="st">"co_exceedance"</span>] <span class="op">&gt;=</span> threshold_high_stress</span>
<span id="cb37-1581"><a href="#cb37-1581" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb37-1582"><a href="#cb37-1582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1583"><a href="#cb37-1583" aria-hidden="true" tabindex="-1"></a><span class="co"># Add market return on stress days</span></span>
<span id="cb37-1584"><a href="#cb37-1584" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> stress_events.merge(</span>
<span id="cb37-1585"><a href="#cb37-1585" aria-hidden="true" tabindex="-1"></a>    market_daily[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb37-1586"><a href="#cb37-1586" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1587"><a href="#cb37-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1588"><a href="#cb37-1588" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"System-wide stress days (top 1%): </span><span class="sc">{</span><span class="bu">len</span>(stress_events)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb37-1589"><a href="#cb37-1589" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average market return on stress days: "</span></span>
<span id="cb37-1590"><a href="#cb37-1590" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stress_events[<span class="st">'mkt_ret'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb37-1591"><a href="#cb37-1591" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average co-exceedance on stress days: "</span></span>
<span id="cb37-1592"><a href="#cb37-1592" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stress_events[<span class="st">'co_exceedance'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb37-1593"><a href="#cb37-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1594"><a href="#cb37-1594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1597"><a href="#cb37-1597" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb37-1598"><a href="#cb37-1598" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-crisis-episodes</span></span>
<span id="cb37-1599"><a href="#cb37-1599" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb37-1600"><a href="#cb37-1600" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Major Stress Episodes: Clustering of System-Wide Tail Events"</span></span>
<span id="cb37-1601"><a href="#cb37-1601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1602"><a href="#cb37-1602" aria-hidden="true" tabindex="-1"></a><span class="co"># Cluster stress days into episodes (within 10 trading days)</span></span>
<span id="cb37-1603"><a href="#cb37-1603" aria-hidden="true" tabindex="-1"></a>stress_events <span class="op">=</span> stress_events.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-1604"><a href="#cb37-1604" aria-hidden="true" tabindex="-1"></a>stress_events[<span class="st">"gap"</span>] <span class="op">=</span> stress_events[<span class="st">"date"</span>].diff().dt.days</span>
<span id="cb37-1605"><a href="#cb37-1605" aria-hidden="true" tabindex="-1"></a>stress_events[<span class="st">"episode"</span>] <span class="op">=</span> (stress_events[<span class="st">"gap"</span>] <span class="op">&gt;</span> <span class="dv">15</span>).cumsum()</span>
<span id="cb37-1606"><a href="#cb37-1606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1607"><a href="#cb37-1607" aria-hidden="true" tabindex="-1"></a>episode_summary <span class="op">=</span> (</span>
<span id="cb37-1608"><a href="#cb37-1608" aria-hidden="true" tabindex="-1"></a>    stress_events.groupby(<span class="st">"episode"</span>)</span>
<span id="cb37-1609"><a href="#cb37-1609" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb37-1610"><a href="#cb37-1610" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb37-1611"><a href="#cb37-1611" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>),</span>
<span id="cb37-1612"><a href="#cb37-1612" aria-hidden="true" tabindex="-1"></a>        n_stress_days<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"count"</span>),</span>
<span id="cb37-1613"><a href="#cb37-1613" aria-hidden="true" tabindex="-1"></a>        avg_market_return<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb37-1614"><a href="#cb37-1614" aria-hidden="true" tabindex="-1"></a>        min_market_return<span class="op">=</span>(<span class="st">"mkt_ret"</span>, <span class="st">"min"</span>),</span>
<span id="cb37-1615"><a href="#cb37-1615" aria-hidden="true" tabindex="-1"></a>        avg_coexceedance<span class="op">=</span>(<span class="st">"co_exceedance"</span>, <span class="st">"mean"</span>)</span>
<span id="cb37-1616"><a href="#cb37-1616" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb37-1617"><a href="#cb37-1617" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb37-1618"><a href="#cb37-1618" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"min_market_return"</span>)</span>
<span id="cb37-1619"><a href="#cb37-1619" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-1620"><a href="#cb37-1620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1621"><a href="#cb37-1621" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"avg_market_return"</span>] <span class="op">=</span> episode_summary[<span class="st">"avg_market_return"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-1622"><a href="#cb37-1622" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"min_market_return"</span>] <span class="op">=</span> episode_summary[<span class="st">"min_market_return"</span>].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb37-1623"><a href="#cb37-1623" aria-hidden="true" tabindex="-1"></a>episode_summary[<span class="st">"avg_coexceedance"</span>] <span class="op">=</span> episode_summary[<span class="st">"avg_coexceedance"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb37-1624"><a href="#cb37-1624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1625"><a href="#cb37-1625" aria-hidden="true" tabindex="-1"></a>episode_summary.head(<span class="dv">10</span>)</span>
<span id="cb37-1626"><a href="#cb37-1626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb37-1627"><a href="#cb37-1627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1628"><a href="#cb37-1628" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises</span></span>
<span id="cb37-1629"><a href="#cb37-1629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1630"><a href="#cb37-1630" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Crash Risk Determinants.** Estimate a panel regression of NCSKEW on lagged firm characteristics: size, book-to-market, leverage, return volatility, trading volume, state ownership dummy, and lagged NCSKEW. Include industry and year fixed effects. Cluster standard errors by firm. Which characteristics predict future crash risk? Does state ownership amplify or attenuate crash risk?</span></span>
<span id="cb37-1631"><a href="#cb37-1631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1632"><a href="#cb37-1632" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **VaR Model Comparison.** Implement a GARCH(1,1)-$t$ model for the market return and compute the one-day-ahead VaR at the 1% level. Compare its backtesting performance (Kupiec and Christoffersen tests) against the four static methods implemented in this chapter. Which model performs best in terms of unconditional coverage? Which in terms of independence?</span></span>
<span id="cb37-1633"><a href="#cb37-1633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1634"><a href="#cb37-1634" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Threshold Sensitivity.** Re-estimate the GPD model from @sec-gpd using thresholds at the 90th, 92.5th, 95th, and 97.5th percentiles. Plot the resulting VaR and ES estimates as a function of the threshold. At what threshold do the estimates stabilize? Relate your findings to the mean residual life plot.</span></span>
<span id="cb37-1635"><a href="#cb37-1635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1636"><a href="#cb37-1636" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Tail Dependence Across Market Regimes.** Split the sample into bull and bear regimes (e.g., above/below the 12-month moving average of the market index). Estimate pairwise tail dependence coefficients separately for each regime. Is tail dependence symmetric across regimes, or is it asymmetrically higher during bear markets?</span></span>
<span id="cb37-1637"><a href="#cb37-1637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1638"><a href="#cb37-1638" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Contagion During Multiple Crises.** Apply the Forbes-Rigobon contagion test to at least three distinct crisis episodes in Vietnam (e.g., 2011 banking stress, 2018 trade war, 2020 COVID-19, 2022 V·∫°n Th·ªãnh Ph√°t/corporate bond crisis). Compare the fraction of sector pairs showing contagion across episodes. Which crises were most contagious? What structural features of each crisis might explain the differences?</span></span>
<span id="cb37-1639"><a href="#cb37-1639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1640"><a href="#cb37-1640" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Price Limit Bias in Tail Estimation.** Simulate a stock return series from a Student-$t$ distribution with known parameters, then censor it at Vietnamese daily price limits ($\pm 7\%$ for HOSE, $\pm 10\%$ for HNX). Compare VaR, ES, and Hill tail index estimates from the censored and uncensored series. Quantify the underestimation bias as a function of the true tail thickness and price limit width. --&gt;</span></span>
<span id="cb37-1641"><a href="#cb37-1641" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1642"><a href="#cb37-1642" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb37-1643"><a href="#cb37-1643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1644"><a href="#cb37-1644" aria-hidden="true" tabindex="-1"></a>This chapter developed a comprehensive toolkit for measuring and diagnosing tail risk in Vietnamese equity markets. The key objects estimated (crash risk measures, VaR and Expected Shortfall, tail indices, and tail dependence coefficients) capture distinct but complementary aspects of extreme event behavior.</span>
<span id="cb37-1645"><a href="#cb37-1645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1646"><a href="#cb37-1646" aria-hidden="true" tabindex="-1"></a>At the individual stock level, the NCSKEW, DUVOL, and crash count measures quantify asymmetry in firm-specific return distributions, providing forward-looking indicators of crash vulnerability. At the portfolio level, EVT-based approaches to VaR and ES estimation avoid the parametric misspecification that plagues Gaussian and even Student-$t$ models in the deep tails. At the system level, tail dependence and co-exceedance measures reveal the extent to which crashes propagate across sectors, and the Forbes-Rigobon contagion test distinguishes genuine contagion from the mechanical increase in co-movement driven by higher volatility.</span>
<span id="cb37-1647"><a href="#cb37-1647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-1648"><a href="#cb37-1648" aria-hidden="true" tabindex="-1"></a>Several features of Vietnamese markets deserve emphasis. Price limits censor the observed return distribution, causing systematic underestimation of true tail risk. The concentration of trading among retail investors amplifies herding-driven crash dynamics. State ownership of large firms creates correlated exposure to policy shocks that is not captured by standard diversification. And the absence of deep derivatives markets limits the hedging instruments available for tail risk management, making accurate measurement all the more critical.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/61_tail_risk_extreme_events.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>