<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>22&nbsp; Institutional Ownership Analytics in Vietnam – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./52_institutional_trade_flow.html" rel="next">
<link href="./39_divop.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="22&nbsp; Institutional Ownership Analytics in Vietnam – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="22&nbsp; Institutional Ownership Analytics in Vietnam – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./50_institutional_ownership.html"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Data, Research Design, and Frontiers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./65_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#institutional-ownership-in-vietnam-a-distinct-landscape" id="toc-institutional-ownership-in-vietnam-a-distinct-landscape" class="nav-link active" data-scroll-target="#institutional-ownership-in-vietnam-a-distinct-landscape"><span class="header-section-number">22.1</span> Institutional Ownership in Vietnam: A Distinct Landscape</a></li>
  <li><a href="#sec-datacore" id="toc-sec-datacore" class="nav-link" data-scroll-target="#sec-datacore"><span class="header-section-number">22.2</span> Data Infrastructure: DataCore.vn</a></li>
  <li><a href="#sec-data-pipeline" id="toc-sec-data-pipeline" class="nav-link" data-scroll-target="#sec-data-pipeline"><span class="header-section-number">22.3</span> Data Pipeline</a>
  <ul class="collapse">
  <li><a href="#sec-price-pipeline" id="toc-sec-price-pipeline" class="nav-link" data-scroll-target="#sec-price-pipeline"><span class="header-section-number">22.3.1</span> Stock Price Data and Corporate Action Adjustments</a></li>
  <li><a href="#sec-ownership-data" id="toc-sec-ownership-data" class="nav-link" data-scroll-target="#sec-ownership-data"><span class="header-section-number">22.3.2</span> Ownership Structure Data</a></li>
  </ul></li>
  <li><a href="#sec-ownership-taxonomy" id="toc-sec-ownership-taxonomy" class="nav-link" data-scroll-target="#sec-ownership-taxonomy"><span class="header-section-number">22.4</span> Vietnam’s Ownership Taxonomy</a>
  <ul class="collapse">
  <li><a href="#the-five-ownership-categories" id="toc-the-five-ownership-categories" class="nav-link" data-scroll-target="#the-five-ownership-categories"><span class="header-section-number">22.4.1</span> The Five Ownership Categories</a></li>
  </ul></li>
  <li><a href="#sec-ownership-metrics" id="toc-sec-ownership-metrics" class="nav-link" data-scroll-target="#sec-ownership-metrics"><span class="header-section-number">22.5</span> Institutional Ownership Measures</a>
  <ul class="collapse">
  <li><a href="#sec-io-ratio" id="toc-sec-io-ratio" class="nav-link" data-scroll-target="#sec-io-ratio"><span class="header-section-number">22.5.1</span> Ownership Ratio</a></li>
  <li><a href="#sec-hhi" id="toc-sec-hhi" class="nav-link" data-scroll-target="#sec-hhi"><span class="header-section-number">22.5.2</span> Concentration: Herfindahl-Hirschman Index</a></li>
  <li><a href="#sec-breadth" id="toc-sec-breadth" class="nav-link" data-scroll-target="#sec-breadth"><span class="header-section-number">22.5.3</span> Breadth of Ownership</a></li>
  <li><a href="#time-series-visualization" id="toc-time-series-visualization" class="nav-link" data-scroll-target="#time-series-visualization"><span class="header-section-number">22.5.4</span> Time Series Visualization</a></li>
  </ul></li>
  <li><a href="#sec-foreign-ownership" id="toc-sec-foreign-ownership" class="nav-link" data-scroll-target="#sec-foreign-ownership"><span class="header-section-number">22.6</span> Foreign Ownership Dynamics</a>
  <ul class="collapse">
  <li><a href="#sec-fol" id="toc-sec-fol" class="nav-link" data-scroll-target="#sec-fol"><span class="header-section-number">22.6.1</span> Foreign Ownership Limits and the FOL Premium</a></li>
  </ul></li>
  <li><a href="#sec-trades" id="toc-sec-trades" class="nav-link" data-scroll-target="#sec-trades"><span class="header-section-number">22.7</span> Institutional Trades</a>
  <ul class="collapse">
  <li><a href="#sec-trade-inference" id="toc-sec-trade-inference" class="nav-link" data-scroll-target="#sec-trade-inference"><span class="header-section-number">22.7.1</span> Trade Inference in Vietnam</a></li>
  </ul></li>
  <li><a href="#sec-flows-turnover" id="toc-sec-flows-turnover" class="nav-link" data-scroll-target="#sec-flows-turnover"><span class="header-section-number">22.8</span> Fund-Level Flows and Turnover</a>
  <ul class="collapse">
  <li><a href="#portfolio-assets-and-returns-from-fund-holdings" id="toc-portfolio-assets-and-returns-from-fund-holdings" class="nav-link" data-scroll-target="#portfolio-assets-and-returns-from-fund-holdings"><span class="header-section-number">22.8.1</span> Portfolio Assets and Returns from Fund Holdings</a></li>
  <li><a href="#turnover-measures" id="toc-turnover-measures" class="nav-link" data-scroll-target="#turnover-measures"><span class="header-section-number">22.8.2</span> Turnover Measures</a></li>
  </ul></li>
  <li><a href="#sec-state-ownership" id="toc-sec-state-ownership" class="nav-link" data-scroll-target="#sec-state-ownership"><span class="header-section-number">22.9</span> State Ownership Analysis</a>
  <ul class="collapse">
  <li><a href="#equitization-and-the-decline-of-state-ownership" id="toc-equitization-and-the-decline-of-state-ownership" class="nav-link" data-scroll-target="#equitization-and-the-decline-of-state-ownership"><span class="header-section-number">22.9.1</span> Equitization and the Decline of State Ownership</a></li>
  </ul></li>
  <li><a href="#sec-modern-extensions" id="toc-sec-modern-extensions" class="nav-link" data-scroll-target="#sec-modern-extensions"><span class="header-section-number">22.10</span> Modern Extensions</a>
  <ul class="collapse">
  <li><a href="#sec-network" id="toc-sec-network" class="nav-link" data-scroll-target="#sec-network"><span class="header-section-number">22.10.1</span> Network Analysis of Co-Ownership</a></li>
  <li><a href="#sec-ml-classification" id="toc-sec-ml-classification" class="nav-link" data-scroll-target="#sec-ml-classification"><span class="header-section-number">22.10.2</span> ML-Enhanced Investor Classification</a></li>
  <li><a href="#sec-event-study" id="toc-sec-event-study" class="nav-link" data-scroll-target="#sec-event-study"><span class="header-section-number">22.10.3</span> Event Study: Ownership Disclosure Shocks</a></li>
  </ul></li>
  <li><a href="#sec-empirical-applications" id="toc-sec-empirical-applications" class="nav-link" data-scroll-target="#sec-empirical-applications"><span class="header-section-number">22.11</span> Empirical Applications</a>
  <ul class="collapse">
  <li><a href="#application-1-foreign-ownership-and-stock-returns-in-vietnam" id="toc-application-1-foreign-ownership-and-stock-returns-in-vietnam" class="nav-link" data-scroll-target="#application-1-foreign-ownership-and-stock-returns-in-vietnam"><span class="header-section-number">22.11.1</span> Application 1: Foreign Ownership and Stock Returns in Vietnam</a></li>
  <li><a href="#application-2-state-divestiture-and-value-creation" id="toc-application-2-state-divestiture-and-value-creation" class="nav-link" data-scroll-target="#application-2-state-divestiture-and-value-creation"><span class="header-section-number">22.11.2</span> Application 2: State Divestiture and Value Creation</a></li>
  <li><a href="#application-3-institutional-herding-in-vietnam" id="toc-application-3-institutional-herding-in-vietnam" class="nav-link" data-scroll-target="#application-3-institutional-herding-in-vietnam"><span class="header-section-number">22.11.3</span> Application 3: Institutional Herding in Vietnam</a></li>
  </ul></li>
  <li><a href="#sec-conclusion" id="toc-sec-conclusion" class="nav-link" data-scroll-target="#sec-conclusion"><span class="header-section-number">22.12</span> Conclusion and Practical Recommendations</a>
  <ul class="collapse">
  <li><a href="#summary-of-measures" id="toc-summary-of-measures" class="nav-link" data-scroll-target="#summary-of-measures"><span class="header-section-number">22.12.1</span> Summary of Measures</a></li>
  <li><a href="#data-quality-checklist-for-vietnam" id="toc-data-quality-checklist-for-vietnam" class="nav-link" data-scroll-target="#data-quality-checklist-for-vietnam"><span class="header-section-number">22.12.2</span> Data Quality Checklist for Vietnam</a></li>
  <li><a href="#comparison-with-us-framework" id="toc-comparison-with-us-framework" class="nav-link" data-scroll-target="#comparison-with-us-framework"><span class="header-section-number">22.12.3</span> Comparison with US Framework</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/50_institutional_ownership.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./50_institutional_ownership.html"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="institutional-ownership-in-vietnam-a-distinct-landscape" class="level2" data-number="22.1">
<h2 data-number="22.1" class="anchored" data-anchor-id="institutional-ownership-in-vietnam-a-distinct-landscape"><span class="header-section-number">22.1</span> Institutional Ownership in Vietnam: A Distinct Landscape</h2>
<p>Vietnam’s equity market presents a fundamentally different institutional ownership landscape from the mature markets of the US, Europe, or Japan. Since the Ho Chi Minh City Securities Trading Center (now HOSE) opened on July 28, 2000 with just two listed stocks, the market has grown to over 1,700 listed companies across three exchanges (HOSE, HNX, and UPCOM) with a combined market capitalization exceeding 200 billion USD. Yet the ownership structure remains distinctive in several critical ways:</p>
<ul>
<li><p><strong>Retail dominance.</strong> Individual investors account for approximately 85% of trading value on Vietnamese exchanges, far exceeding the institutional share. This contrasts sharply with the US, where institutional investors dominate both ownership and trading <span class="citation" data-cites="bao2024institutional">(<a href="references.html#ref-bao2024institutional" role="doc-biblioref">Bao Dinh and Tran 2024</a>)</span>. The implications for market efficiency, price discovery, and volatility are profound.</p></li>
<li><p><strong>State ownership legacy.</strong> Vietnam’s equitization (privatization) program, initiated under Đổi Mới reforms in 1986, means that the state remains a significant or controlling shareholder in many listed companies. As of 2022, SOEs (firms with state ownership &gt; 50%) account for approximately 30% of total market capitalization despite representing less than 10% of listed firms <span class="citation" data-cites="huang2023factors">(<a href="references.html#ref-huang2023factors" role="doc-biblioref">Huang, Liu, and Shu 2023</a>)</span>. State ownership introduces unique agency problems, governance dynamics, and liquidity constraints.</p></li>
<li><p><strong>Foreign Ownership Limits (FOLs).</strong> Vietnam imposes sector-specific caps on aggregate foreign ownership, typically 49% for most sectors, 30% for banking, and varying limits for aviation, media, and telecommunications. When a stock reaches its FOL, foreign investors can only buy from other foreign sellers, creating a segmented market with distinct pricing dynamics and a well-documented “FOL premium” <span class="citation" data-cites="vo2015foreign">(<a href="references.html#ref-vo2015foreign" role="doc-biblioref">Vo 2015</a>)</span>.</p></li>
<li><p><strong>Disclosure regime.</strong> Unlike the US quarterly 13F filing system, Vietnam’s ownership disclosure is event-driven and periodic. Major shareholders (≥5%) must disclose within 7 business days of crossing thresholds. Annual reports contain detailed shareholder registers. Semi-annual fund reports provide portfolio snapshots. This creates a patchwork of disclosure frequencies that require careful handling.</p></li>
</ul>
</section>
<section id="sec-datacore" class="level2" data-number="22.2">
<h2 data-number="22.2" class="anchored" data-anchor-id="sec-datacore"><span class="header-section-number">22.2</span> Data Infrastructure: DataCore.vn</h2>
<p><strong>DataCore.vn</strong> is a comprehensive Vietnamese financial data platform that provides academic-grade datasets for the Vietnamese market. Throughout this chapter, we assume all data is sourced exclusively from DataCore.vn, which provides:</p>
<div id="tbl-datacore-tables" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-datacore-tables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.1: DataCore.vn Data Tables Used in This Chapter
</figcaption>
<div aria-describedby="tbl-datacore-tables-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 34%">
<col style="width: 26%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">DataCore.vn Dataset</th>
<th style="text-align: left;">Content</th>
<th style="text-align: left;">Key Variables</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Stock Prices</strong></td>
<td style="text-align: left;">Daily/monthly OHLCV for HOSE, HNX, UPCOM</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>close</code>, <code>adjusted_close</code>, <code>volume</code>, <code>shares_outstanding</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Ownership Structure</strong></td>
<td style="text-align: left;">Shareholder composition snapshots</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>shareholder_name</code>, <code>shares_held</code>, <code>ownership_pct</code>, <code>shareholder_type</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Major Shareholders</strong></td>
<td style="text-align: left;">Detailed ≥5% holders</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>shareholder_name</code>, <code>shares_held</code>, <code>is_foreign</code>, <code>is_state</code>, <code>is_institution</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Corporate Actions</strong></td>
<td style="text-align: left;">Dividends, stock splits, bonus shares, rights issues</td>
<td style="text-align: left;"><code>ticker</code>, <code>ex_date</code>, <code>action_type</code>, <code>ratio</code>, <code>record_date</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Company Profile</strong></td>
<td style="text-align: left;">Sector, exchange, listing date, charter capital</td>
<td style="text-align: left;"><code>ticker</code>, <code>exchange</code>, <code>industry_code</code>, <code>listing_date</code>, <code>fol_limit</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Financial Statements</strong></td>
<td style="text-align: left;">Quarterly/annual financials</td>
<td style="text-align: left;"><code>ticker</code>, <code>period</code>, <code>revenue</code>, <code>net_income</code>, <code>total_assets</code>, <code>equity</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Foreign Ownership</strong></td>
<td style="text-align: left;">Daily foreign ownership tracking</td>
<td style="text-align: left;"><code>ticker</code>, <code>date</code>, <code>foreign_shares</code>, <code>foreign_pct</code>, <code>fol_limit</code>, <code>foreign_room</code></td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Fund Holdings</strong></td>
<td style="text-align: left;">Semi-annual fund portfolio disclosures</td>
<td style="text-align: left;"><code>fund_name</code>, <code>report_date</code>, <code>ticker</code>, <code>shares_held</code>, <code>market_value</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<div id="datacore-reader" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataCoreReader:</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Unified data reader for DataCore.vn datasets.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes data has been downloaded from DataCore.vn and stored locally.</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports both Parquet (recommended for performance) and CSV formats.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co">    data_dir : str or Path</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Root directory containing DataCore.vn data files</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co">    file_format : str</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co">        'parquet' or 'csv' (default: 'parquet')</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected file names in the data directory</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    FILE_MAP <span class="op">=</span> {</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'prices'</span>: <span class="st">'stock_prices'</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ownership'</span>: <span class="st">'ownership_structure'</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'major_shareholders'</span>: <span class="st">'major_shareholders'</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'corporate_actions'</span>: <span class="st">'corporate_actions'</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'company_profile'</span>: <span class="st">'company_profile'</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'financials'</span>: <span class="st">'financial_statements'</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'foreign_ownership'</span>: <span class="st">'foreign_ownership_daily'</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_holdings'</span>: <span class="st">'fund_holdings'</span>,</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_dir: Union[<span class="bu">str</span>, Path], file_format: <span class="bu">str</span> <span class="op">=</span> <span class="st">'parquet'</span>):</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_dir <span class="op">=</span> Path(data_dir)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fmt <span class="op">=</span> file_format</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache <span class="op">=</span> {}</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify data directory exists</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.data_dir.exists():</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Data directory not found: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Please download data from DataCore.vn and place it in this directory."</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"DataCore.vn reader initialized: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> [f.stem <span class="cf">for</span> f <span class="kw">in</span> <span class="va">self</span>.data_dir.glob(<span class="ss">f'*.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss">'</span>)]</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Available datasets: </span><span class="sc">{</span>available<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _read(<span class="va">self</span>, key: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read and cache a dataset."""</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="va">self</span>._cache:</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._cache[key]</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="va">self</span>.FILE_MAP.get(key, key)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        filepath <span class="op">=</span> <span class="va">self</span>.data_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> filepath.exists():</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Dataset not found: </span><span class="sc">{</span>filepath<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Expected file: </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.fmt <span class="op">==</span> <span class="st">'parquet'</span>:</span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_parquet(filepath)</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_csv(filepath, parse_dates<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Auto-detect and parse date columns</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower() <span class="kw">or</span> col.lower() <span class="kw">in</span> [<span class="st">'period'</span>, <span class="st">'ex_date'</span>, <span class="st">'record_date'</span>]:</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>                    df[col] <span class="op">=</span> pd.to_datetime(df[col])</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache[key] <span class="op">=</span> df</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows, </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> columns"</span>)</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prices(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'prices'</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'ownership'</span>)</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> major_shareholders(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'major_shareholders'</span>)</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> corporate_actions(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'corporate_actions'</span>)</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> company_profile(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'company_profile'</span>)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> financials(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'financials'</span>)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> foreign_ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'foreign_ownership'</span>)</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fund_holdings(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'fund_holdings'</span>)</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_cache(<span class="va">self</span>):</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Clear all cached datasets to free memory."""</span></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache.clear()</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize reader — adjust path to your local DataCore.vn data</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This chapter proceeds as follows. <a href="#sec-data-pipeline" class="quarto-xref"><span>Section 22.3</span></a> builds the complete data pipeline from raw DataCore.vn extracts to clean, analysis-ready datasets, with particular attention to corporate action adjustments. <a href="#sec-ownership-taxonomy" class="quarto-xref"><span>Section 22.4</span></a> defines Vietnam’s unique ownership taxonomy. <a href="#sec-ownership-metrics" class="quarto-xref"><span>Section 22.5</span></a> computes institutional ownership ratios, concentration, and breadth for the Vietnamese market. <a href="#sec-foreign-ownership" class="quarto-xref"><span>Section 22.6</span></a> develops specialized foreign ownership analytics including FOL utilization and room premium. <a href="#sec-trades" class="quarto-xref"><span>Section 22.7</span></a> derives institutional trades from ownership disclosure snapshots. <a href="#sec-flows-turnover" class="quarto-xref"><span>Section 22.8</span></a> computes fund-level flows and turnover. <a href="#sec-state-ownership" class="quarto-xref"><span>Section 22.9</span></a> analyzes state ownership dynamics. <a href="#sec-modern-extensions" class="quarto-xref"><span>Section 22.10</span></a> introduces network analysis, ML classification, and event-study frameworks. <a href="#sec-empirical-applications" class="quarto-xref"><span>Section 22.11</span></a> presents complete empirical applications, and <a href="60_textual.html" class="quarto-xref"><span>Chapter 36</span></a> concludes.</p>
</section>
<section id="sec-data-pipeline" class="level2" data-number="22.3">
<h2 data-number="22.3" class="anchored" data-anchor-id="sec-data-pipeline"><span class="header-section-number">22.3</span> Data Pipeline</h2>
<section id="sec-price-pipeline" class="level3" data-number="22.3.1">
<h3 data-number="22.3.1" class="anchored" data-anchor-id="sec-price-pipeline"><span class="header-section-number">22.3.1</span> Stock Price Data and Corporate Action Adjustments</h3>
<p>Vietnam’s equity market is notorious for frequent corporate actions, particularly stock dividends and bonus share issuances, that dramatically alter share counts. A company issuing a 30% stock dividend means every 100 shares become 130 shares, and the reference price adjusts downward proportionally. Failure to properly adjust historical shares and prices for these events is the single most common source of error in Vietnamese equity research.</p>
<div id="corporate-actions" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Corporate Action Adjustment Factors</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_adjustment_factors(corporate_actions: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Build cumulative adjustment factors from the corporate actions history.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">    In Vietnam, the most common share-altering corporate actions are:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Stock dividends (cổ tức bằng cổ phiếu): e.g., 30% → ratio = 0.30</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares × (1 + 0.30), price × (1 / 1.30)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Bonus shares (thưởng cổ phiếu): mechanically identical to stock dividends</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Stock splits (chia tách): e.g., 2:1 → ratio = 2.0</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares × 2, price × 0.5</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Rights issues (phát hành thêm): dilutive, but not all shareholders exercise</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">       We approximate with the subscription ratio</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Reverse splits (gộp cổ phiếu): rare in Vietnam</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares ÷ ratio, price × ratio</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">    We construct a FORWARD-LOOKING cumulative adjustment factor such that:</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">       adjusted_shares = raw_shares × cum_adj_factor(from_date, to_date)</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">       adjusted_price = raw_price / cum_adj_factor(from_date, to_date)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="co">    This is analogous to CRSP's cfacshr in the US context.</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate_actions : pd.DataFrame</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="co">        DataCore.vn corporate actions with columns:</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co">        ticker, ex_date, action_type, ratio</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="co">        action_type values:</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'stock_dividend': ratio = dividend rate (e.g., 0.30 for 30%)</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'bonus_shares': ratio = bonus rate (e.g., 0.20 for 20%)</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'stock_split': ratio = split factor (e.g., 2.0 for 2:1)</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'reverse_split': ratio = merge factor (e.g., 5.0 for 5:1 merge)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'rights_issue': ratio = subscription rate (e.g., 0.10 for 10:1)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'cash_dividend': ratio = VND per share (no share adjustment needed)</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjustment factors: ticker, ex_date, point_factor, cum_factor</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to share-altering events only</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>    share_events <span class="op">=</span> [<span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>, <span class="st">'stock_split'</span>, </span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'reverse_split'</span>, <span class="st">'rights_issue'</span>]</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>    ca <span class="op">=</span> corporate_actions[</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        corporate_actions[<span class="st">'action_type'</span>].isin(share_events)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(ca) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No share-altering corporate actions found."</span>)</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'point_factor'</span>, <span class="st">'cum_factor'</span>])</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute point adjustment factor for each event</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_point_factor(row):</span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>        atype <span class="op">=</span> row[<span class="st">'action_type'</span>]</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>        ratio <span class="op">=</span> row[<span class="st">'ratio'</span>]</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> atype <span class="kw">in</span> [<span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>]:</span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 30% stock dividend: 100 shares → 130 shares</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> ratio</span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'stock_split'</span>:</span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2:1 split: 100 shares → 200 shares</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ratio</span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'reverse_split'</span>:</span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5:1 reverse: 500 shares → 100 shares</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="op">/</span> ratio</span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'rights_issue'</span>:</span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Approximate: assume all rights exercised</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># In practice, this overestimates the adjustment</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> ratio</span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a>    ca[<span class="st">'point_factor'</span>] <span class="op">=</span> ca.<span class="bu">apply</span>(compute_point_factor, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort chronologically within each ticker</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>    ca <span class="op">=</span> ca.sort_values([<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative factor: product of all point factors from listing to date</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This gives us a running "total adjustment" for each ticker</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>    ca[<span class="st">'cum_factor'</span>] <span class="op">=</span> ca.groupby(<span class="st">'ticker'</span>)[<span class="st">'point_factor'</span>].cumprod()</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary statistics</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a>    n_tickers <span class="op">=</span> ca[<span class="st">'ticker'</span>].nunique()</span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>    n_events <span class="op">=</span> <span class="bu">len</span>(ca)</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>    avg_events <span class="op">=</span> n_events <span class="op">/</span> n_tickers <span class="cf">if</span> n_tickers <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Corporate action adjustment factors built:"</span>)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Tickers with adjustments: </span><span class="sc">{</span>n_tickers<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total share-altering events: </span><span class="sc">{</span>n_events<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-94"><a href="#cb2-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Average events per ticker: </span><span class="sc">{</span>avg_events<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb2-95"><a href="#cb2-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Event type distribution:"</span>)</span>
<span id="cb2-96"><a href="#cb2-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ca[<span class="st">'action_type'</span>].value_counts().to_string())</span>
<span id="cb2-97"><a href="#cb2-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-98"><a href="#cb2-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ca[[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'action_type'</span>, <span class="st">'ratio'</span>, </span>
<span id="cb2-99"><a href="#cb2-99" aria-hidden="true" tabindex="-1"></a>               <span class="st">'point_factor'</span>, <span class="st">'cum_factor'</span>]]</span>
<span id="cb2-100"><a href="#cb2-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_shares(shares: <span class="bu">float</span>, ticker: <span class="bu">str</span>, from_date, to_date, </span>
<span id="cb2-103"><a href="#cb2-103" aria-hidden="true" tabindex="-1"></a>                  adj_factors: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb2-104"><a href="#cb2-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-105"><a href="#cb2-105" aria-hidden="true" tabindex="-1"></a><span class="co">    Adjust a share count from one date to another for corporate actions.</span></span>
<span id="cb2-106"><a href="#cb2-106" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-107"><a href="#cb2-107" aria-hidden="true" tabindex="-1"></a><span class="co">    Example: If a company had a 30% stock dividend with ex_date between</span></span>
<span id="cb2-108"><a href="#cb2-108" aria-hidden="true" tabindex="-1"></a><span class="co">    from_date and to_date, then 1000 shares at from_date = 1300 shares </span></span>
<span id="cb2-109"><a href="#cb2-109" aria-hidden="true" tabindex="-1"></a><span class="co">    at to_date.</span></span>
<span id="cb2-110"><a href="#cb2-110" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-111"><a href="#cb2-111" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-112"><a href="#cb2-112" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-113"><a href="#cb2-113" aria-hidden="true" tabindex="-1"></a><span class="co">    shares : float</span></span>
<span id="cb2-114"><a href="#cb2-114" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of shares at from_date</span></span>
<span id="cb2-115"><a href="#cb2-115" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker : str</span></span>
<span id="cb2-116"><a href="#cb2-116" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock ticker</span></span>
<span id="cb2-117"><a href="#cb2-117" aria-hidden="true" tabindex="-1"></a><span class="co">    from_date, to_date : pd.Timestamp</span></span>
<span id="cb2-118"><a href="#cb2-118" aria-hidden="true" tabindex="-1"></a><span class="co">        Period for adjustment</span></span>
<span id="cb2-119"><a href="#cb2-119" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb2-120"><a href="#cb2-120" aria-hidden="true" tabindex="-1"></a><span class="co">        Output of build_adjustment_factors()</span></span>
<span id="cb2-121"><a href="#cb2-121" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb2-122"><a href="#cb2-122" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-123"><a href="#cb2-123" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-124"><a href="#cb2-124" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb2-125"><a href="#cb2-125" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjusted shares at to_date</span></span>
<span id="cb2-126"><a href="#cb2-126" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-127"><a href="#cb2-127" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> adj_factors[</span>
<span id="cb2-128"><a href="#cb2-128" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb2-129"><a href="#cb2-129" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&gt;</span> pd.Timestamp(from_date)) <span class="op">&amp;</span></span>
<span id="cb2-130"><a href="#cb2-130" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&lt;=</span> pd.Timestamp(to_date))</span>
<span id="cb2-131"><a href="#cb2-131" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-132"><a href="#cb2-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-133"><a href="#cb2-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(events) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb2-134"><a href="#cb2-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shares</span>
<span id="cb2-135"><a href="#cb2-135" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-136"><a href="#cb2-136" aria-hidden="true" tabindex="-1"></a>    total_factor <span class="op">=</span> events[<span class="st">'point_factor'</span>].prod()</span>
<span id="cb2-137"><a href="#cb2-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares <span class="op">*</span> total_factor</span>
<span id="cb2-138"><a href="#cb2-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-139"><a href="#cb2-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-140"><a href="#cb2-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb2-141"><a href="#cb2-141" aria-hidden="true" tabindex="-1"></a><span class="co"># adj_factors = build_adjustment_factors(dc.corporate_actions)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-important callout-titled" title="The Stock Dividend Problem in Vietnam">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>The Stock Dividend Problem in Vietnam
</div>
</div>
<div class="callout-body-container callout-body">
<p>Vietnamese companies issue stock dividends with remarkable frequency, many growth companies do so 2-3 times per year. Consider <strong>Vinhomes (VHM)</strong> or <strong>FPT Corporation</strong>: their share counts may double or triple over a 5-year period purely from stock dividends. If you compare raw ownership shares from 2019 to 2024 without adjustment, you will obtain nonsensical ownership ratios. <strong>Every time-series analysis of Vietnamese ownership data must use adjusted shares.</strong> This is the Vietnamese equivalent of the CRSP cfacshr adjustment factor problem in US data, but more severe because the events are more frequent and larger in magnitude.</p>
</div>
</div>
<div id="price-processing" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process Stock Price Data</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_price_data(prices: pd.DataFrame, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                       adj_factors: pd.DataFrame,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                       company_profile: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Process DataCore.vn stock price data:</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Align dates to month-end and quarter-end</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Merge company metadata (exchange, sector, FOL limit)</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Compute adjusted prices and shares outstanding</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Compute market capitalization</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Create quarter-end snapshots</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    prices : pd.DataFrame</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily/monthly price data from DataCore.vn</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    company_profile : pd.DataFrame</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Company metadata including exchange, sector, FOL</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Quarter-end processed stock data</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> prices.copy()</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize date</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'date'</span>])</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'month_end'</span>] <span class="op">=</span> df[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'quarter_end'</span>] <span class="op">=</span> df[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge company profile</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    profile_cols <span class="op">=</span> [<span class="st">'ticker'</span>, <span class="st">'exchange'</span>, <span class="st">'industry_code'</span>, <span class="st">'fol_limit'</span>, </span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'listing_date'</span>, <span class="st">'company_name'</span>]</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    profile_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> profile_cols <span class="cf">if</span> c <span class="kw">in</span> company_profile.columns]</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(company_profile[profile_cols], on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build cumulative adjustment factor for each ticker-date</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each observation, compute the total adjustment from listing to that date</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge adjustment events</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each ticker-date, find the cumulative factor as of that date</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_cum_factor_at_date(group):</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> group.name</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        ticker_adj <span class="op">=</span> adj_factors[adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ticker_adj) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'cum_adj_factor'</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> group</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each date, find cumulative factor (product of all events up to that date)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'cum_adj_factor'</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, event <span class="kw">in</span> ticker_adj.iterrows():</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> group[<span class="st">'date'</span>] <span class="op">&gt;=</span> event[<span class="st">'ex_date'</span>]</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>            group.loc[mask, <span class="st">'cum_adj_factor'</span>] <span class="op">*=</span> event[<span class="st">'point_factor'</span>]</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> group</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(get_cum_factor_at_date)</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted price and shares</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjusted_close should already be provided by DataCore.vn</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># But we compute our own for consistency</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'adjusted_close'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'adjusted_close'</span>] <span class="op">=</span> df[<span class="st">'close'</span>] <span class="op">/</span> df[<span class="st">'cum_adj_factor'</span>]</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted shares outstanding</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'adjusted_shares'</span>] <span class="op">=</span> df[<span class="st">'shares_outstanding'</span>] <span class="op">*</span> df[<span class="st">'cum_adj_factor'</span>]</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market capitalization (in billion VND)</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'market_cap'</span>] <span class="op">=</span> df[<span class="st">'close'</span>] <span class="op">*</span> df[<span class="st">'shares_outstanding'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly returns</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>].pct_change()</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep quarter-end observations</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For daily data: keep last trading day of each quarter</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    df_quarterly <span class="op">=</span> (df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'date'</span>])</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>                      .groupby([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>                      .last()</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>                      .reset_index())</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed price data:"</span>)</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total records (daily): </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Quarter-end records: </span><span class="sc">{</span><span class="bu">len</span>(df_quarterly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique tickers: </span><span class="sc">{</span>df_quarterly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_quarterly[<span class="st">'quarter_end'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>df_quarterly[<span class="st">'quarter_end'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Exchange distribution:"</span>)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_quarterly.groupby(<span class="st">'exchange'</span>)[<span class="st">'ticker'</span>].nunique().to_string())</span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_quarterly</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a><span class="co"># prices_q = process_price_data(dc.prices, adj_factors, dc.company_profile)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-ownership-data" class="level3" data-number="22.3.2">
<h3 data-number="22.3.2" class="anchored" data-anchor-id="sec-ownership-data"><span class="header-section-number">22.3.2</span> Ownership Structure Data</h3>
<p>Vietnamese ownership data captures the composition of shareholders as disclosed in annual reports, semi-annual reports, and event-driven disclosures. The key distinction from US 13F data is that Vietnamese disclosures provide a <strong>complete ownership decomposition</strong>, not just institutional long positions, but the full breakdown into state, institutional, foreign, and individual ownership.</p>
<div id="ownership-processing" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Process Ownership Structure Data</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OwnershipType:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's ownership taxonomy.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Unlike the US where 13F captures only institutional long positions,</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese disclosure provides a complete ownership decomposition.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    We classify shareholders into five mutually exclusive categories.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    STATE <span class="op">=</span> <span class="st">'state'</span>                    <span class="co"># Nhà nước (government entities, SOE parents)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    FOREIGN_INST <span class="op">=</span> <span class="st">'foreign_inst'</span>      <span class="co"># Tổ chức nước ngoài</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    DOMESTIC_INST <span class="op">=</span> <span class="st">'domestic_inst'</span>    <span class="co"># Tổ chức trong nước (non-state)</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    INDIVIDUAL <span class="op">=</span> <span class="st">'individual'</span>          <span class="co"># Cá nhân</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    TREASURY <span class="op">=</span> <span class="st">'treasury'</span>              <span class="co"># Cổ phiếu quỹ</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ALL_TYPES <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST, INDIVIDUAL, TREASURY]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    INSTITUTIONAL <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    FOREIGN <span class="op">=</span> [FOREIGN_INST]  <span class="co"># Can be expanded if foreign individuals are tracked</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_shareholders(ownership: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Classify shareholders into Vietnam's ownership taxonomy.</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">    DataCore.vn may provide a `shareholder_type` field, but naming </span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">    conventions vary. This function standardizes the classification </span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">    using a combination of provided flags and name-based heuristics.</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co">    The classification challenge in Vietnam (noted by @huang2023factors):</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">    DataCore.vn may not always cleanly separate institution types, so we </span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">    use a cascading approach:</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Use explicit flags (is_state, is_foreign, is_institution) if available</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Apply name-based heuristics for Vietnamese entity names</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Default to 'individual' for unclassified shareholders</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw ownership data from DataCore.vn</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership data with standardized `owner_type` column</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> ownership.copy()</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 1: Use explicit flags if available ---</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(col <span class="kw">in</span> df.columns <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'is_state'</span>, <span class="st">'is_foreign'</span>, <span class="st">'is_institution'</span>]):</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>        conditions <span class="op">=</span> [</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_state'</span>] <span class="op">==</span> <span class="va">True</span>),</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_foreign'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_institution'</span>] <span class="op">==</span> <span class="va">True</span>),</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_foreign'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_institution'</span>] <span class="op">!=</span> <span class="va">True</span>),</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_institution'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_state'</span>] <span class="op">!=</span> <span class="va">True</span>) <span class="op">&amp;</span> </span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">'is_foreign'</span>] <span class="op">!=</span> <span class="va">True</span>),</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        choices <span class="op">=</span> [</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>            OwnershipType.STATE,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            OwnershipType.FOREIGN_INST,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            OwnershipType.FOREIGN_INST,  <span class="co"># Foreign individuals often grouped</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>            OwnershipType.DOMESTIC_INST,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> np.select(conditions, choices, </span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>                                      default<span class="op">=</span>OwnershipType.INDIVIDUAL)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 2: Name-based heuristics ---</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'shareholder_name'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> df[<span class="st">'shareholder_name'</span>].<span class="bu">str</span>.lower().fillna(<span class="st">''</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># State entities: government ministries, SCIC, state corporations</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        state_keywords <span class="op">=</span> [</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bộ tài chính'</span>, <span class="st">'tổng công ty đầu tư'</span>, <span class="st">'scic'</span>, </span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ủy ban nhân dân'</span>, <span class="st">'nhà nước'</span>, <span class="st">'state capital'</span>,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tổng công ty'</span>, <span class="st">'vốn nhà nước'</span>, <span class="st">'bộ công thương'</span>,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bộ quốc phòng'</span>, <span class="st">'bộ giao thông'</span>, <span class="st">'vinashin'</span>,</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>        is_state <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> state_keywords)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Foreign entities: common fund names, foreign company patterns</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>        foreign_keywords <span class="op">=</span> [</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fund'</span>, <span class="st">'investment'</span>, <span class="st">'capital'</span>, <span class="st">'limited'</span>, <span class="st">'ltd'</span>, <span class="st">'inc'</span>,</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>            <span class="st">'corporation'</span>, <span class="st">'holdings'</span>, <span class="st">'asset management'</span>, <span class="st">'pte'</span>,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>            <span class="st">'gmbh'</span>, <span class="st">'management'</span>, <span class="st">'partners'</span>, <span class="st">'advisors'</span>,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dragon capital'</span>, <span class="st">'vinacapital'</span>, <span class="st">'templeton'</span>, </span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>            <span class="st">'blackrock'</span>, <span class="st">'jpmorgan'</span>, <span class="st">'samsung'</span>, <span class="st">'mirae'</span>,</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Also check for non-Vietnamese characters as a heuristic</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        is_foreign_name <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> foreign_keywords)</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Domestic institutions: Vietnamese bank, securities, insurance names</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>        domestic_inst_keywords <span class="op">=</span> [</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ngân hàng'</span>, <span class="st">'chứng khoán'</span>, <span class="st">'bảo hiểm'</span>, <span class="st">'quỹ đầu tư'</span>,</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">'công ty quản lý'</span>, <span class="st">'bảo việt'</span>, <span class="st">'techcombank'</span>, <span class="st">'vietcombank'</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bidv'</span>, <span class="st">'vietinbank'</span>, <span class="st">'vpbank'</span>, <span class="st">'mb bank'</span>, <span class="st">'ssi'</span>, <span class="st">'hsc'</span>,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">'vcsc'</span>, <span class="st">'vndirect'</span>, <span class="st">'fpt capital'</span>, <span class="st">'manulife'</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        is_domestic_inst <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> domestic_inst_keywords)</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Treasury shares</span></span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>        is_treasury <span class="op">=</span> name.<span class="bu">str</span>.contains(<span class="st">'cổ phiếu quỹ|treasury'</span>, case<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply classification cascade</span></span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.INDIVIDUAL  <span class="co"># Default</span></span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        df.loc[is_domestic_inst, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.DOMESTIC_INST</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>        df.loc[is_foreign_name, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.FOREIGN_INST</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>        df.loc[is_state, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.STATE</span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>        df.loc[is_treasury, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.TREASURY</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 3: Use shareholder_type directly ---</span></span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'shareholder_type'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>        type_map <span class="op">=</span> {</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state'</span>: OwnershipType.STATE,</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_institution'</span>: OwnershipType.FOREIGN_INST,</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_individual'</span>: OwnershipType.FOREIGN_INST,</span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a>            <span class="st">'domestic_institution'</span>: OwnershipType.DOMESTIC_INST,</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>            <span class="st">'individual'</span>: OwnershipType.INDIVIDUAL,</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>            <span class="st">'treasury'</span>: OwnershipType.TREASURY,</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> df[<span class="st">'shareholder_type'</span>].<span class="bu">str</span>.lower().<span class="bu">map</span>(type_map)</span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> df[<span class="st">'owner_type'</span>].fillna(OwnershipType.INDIVIDUAL)</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Cannot classify shareholders. Expected one of:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  1. Columns: is_state, is_foreign, is_institution</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  2. Column: shareholder_name (for heuristic classification)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  3. Column: shareholder_type (pre-classified)"</span></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary</span></span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Ownership classification results:"</span>)</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'owner_type'</span>].value_counts().to_string())</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a><span class="co"># ownership_classified = classify_shareholders(dc.ownership)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="sec-ownership-taxonomy" class="level2" data-number="22.4">
<h2 data-number="22.4" class="anchored" data-anchor-id="sec-ownership-taxonomy"><span class="header-section-number">22.4</span> Vietnam’s Ownership Taxonomy</h2>
<section id="the-five-ownership-categories" class="level3" data-number="22.4.1">
<h3 data-number="22.4.1" class="anchored" data-anchor-id="the-five-ownership-categories"><span class="header-section-number">22.4.1</span> The Five Ownership Categories</h3>
<p>Vietnam’s ownership structure is decomposed into five mutually exclusive categories that together sum to 100% of shares outstanding:</p>
<div id="tbl-ownership-taxonomy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ownership-taxonomy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.2: Vietnam’s Ownership Taxonomy
</figcaption>
<div aria-describedby="tbl-ownership-taxonomy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Category</th>
<th style="text-align: left;">Vietnamese Term</th>
<th style="text-align: left;">Description</th>
<th style="text-align: left;">Typical Share (2020s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>State</strong></td>
<td style="text-align: left;">Sở hữu Nhà nước</td>
<td style="text-align: left;">Government entities, SCIC, SOE parent companies</td>
<td style="text-align: left;">~15-25% of market cap</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Foreign Institutional</strong></td>
<td style="text-align: left;">Tổ chức nước ngoài</td>
<td style="text-align: left;">Foreign funds, banks, corporations</td>
<td style="text-align: left;">~15-20%</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Domestic Institutional</strong></td>
<td style="text-align: left;">Tổ chức trong nước</td>
<td style="text-align: left;">Vietnamese funds, banks, insurance, securities firms</td>
<td style="text-align: left;">~5-10%</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Individual</strong></td>
<td style="text-align: left;">Cá nhân</td>
<td style="text-align: left;">Retail investors (both Vietnamese and foreign individuals)</td>
<td style="text-align: left;">~55-65%</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Treasury</strong></td>
<td style="text-align: left;">Cổ phiếu quỹ</td>
<td style="text-align: left;">Company’s own repurchased shares</td>
<td style="text-align: left;">~0-2%</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>This taxonomy differs fundamentally from the US 13F framework in several ways:</p>
<ol type="1">
<li><strong>Completeness:</strong> We observe 100% of ownership, not just institutional long positions above $100 million AUM.</li>
<li><strong>State as a category:</strong> State ownership is a first-class analytical category, not subsumed under “All Others” as in the LSEG type code system.</li>
<li><strong>Individual visibility:</strong> We observe aggregate individual ownership directly, whereas in the US, individual ownership is merely the residual (100% − institutional ownership).</li>
<li><strong>No short position ambiguity:</strong> Vietnam’s market has very limited short-selling infrastructure, so ownership data genuinely represents long positions.</li>
</ol>
<div id="ownership-decomposition" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Compute Ownership Decomposition</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ownership_decomposition(ownership: pd.DataFrame,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                                     prices_q: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the full ownership decomposition for each stock at each </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    disclosure date.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    For each stock-date combination, aggregates shares held by each </span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership category and computes ownership ratios relative to </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    total shares outstanding.</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership data (output of classify_shareholders)</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_q : pd.DataFrame</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Quarter-end price data with shares_outstanding</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock-period level ownership decomposition with columns for</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">        each ownership type's share count and percentage</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate shares by ticker, date, and owner type</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> (ownership.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shares_held'</span>]</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>                    .<span class="bu">sum</span>()</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>                    .reset_index())</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to wide format: one column per ownership type</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> agg.pivot_table(</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>],</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'shares_held'</span>,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    type_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> wide.columns <span class="cf">if</span> c <span class="kw">in</span> OwnershipType.ALL_TYPES]</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    rename_map <span class="op">=</span> {t: <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> type_cols}</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> wide.rename(columns<span class="op">=</span>rename_map)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total institutional shares</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    inst_cols <span class="op">=</span> [<span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> OwnershipType.INSTITUTIONAL </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">if</span> <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="kw">in</span> wide.columns]</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'shares_institutional'</span>] <span class="op">=</span> wide[inst_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total foreign shares (for FOL tracking)</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>    foreign_cols <span class="op">=</span> [<span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> OwnershipType.FOREIGN </span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="kw">in</span> wide.columns]</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'shares_foreign_total'</span>] <span class="op">=</span> wide[foreign_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align with quarter-end dates for merging with price data</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'quarter_end'</span>] <span class="op">=</span> wide[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with price data to get shares outstanding</span></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> wide.merge(</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'shares_outstanding'</span>, </span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'adjusted_shares'</span>, <span class="st">'market_cap'</span>, <span class="st">'exchange'</span>, </span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'industry_code'</span>, <span class="st">'fol_limit'</span>, <span class="st">'close'</span>]],</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute ownership ratios</span></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>    tso <span class="op">=</span> merged[<span class="st">'shares_outstanding'</span>]</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> merged.columns:</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col.startswith(<span class="st">'shares_'</span>) <span class="kw">and</span> col <span class="op">!=</span> <span class="st">'shares_outstanding'</span>:</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>            ratio_col <span class="op">=</span> col.replace(<span class="st">'shares_'</span>, <span class="st">'pct_'</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>            merged[ratio_col] <span class="op">=</span> merged[col] <span class="op">/</span> tso</span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>            merged.loc[tso <span class="op">&lt;=</span> <span class="dv">0</span>, ratio_col] <span class="op">=</span> np.nan</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derived measures</span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'pct_free_float'</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> merged.get(<span class="st">'pct_state'</span>, <span class="dv">0</span>) <span class="op">-</span> merged.get(<span class="st">'pct_treasury'</span>, <span class="dv">0</span>)</span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SOE flag: state ownership &gt; 50%</span></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'is_soe'</span>] <span class="op">=</span> (merged.get(<span class="st">'pct_state'</span>, <span class="dv">0</span>) <span class="op">&gt;</span> <span class="fl">0.50</span>).astype(<span class="bu">int</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FOL utilization</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'fol_limit'</span> <span class="kw">in</span> merged.columns <span class="kw">and</span> <span class="st">'pct_foreign_total'</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'fol_utilization'</span>] <span class="op">=</span> merged[<span class="st">'pct_foreign_total'</span>] <span class="op">/</span> merged[<span class="st">'fol_limit'</span>]</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'foreign_room'</span>] <span class="op">=</span> merged[<span class="st">'fol_limit'</span>] <span class="op">-</span> merged[<span class="st">'pct_foreign_total'</span>]</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>        merged.loc[merged[<span class="st">'fol_limit'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, [<span class="st">'fol_utilization'</span>, <span class="st">'foreign_room'</span>]] <span class="op">=</span> np.nan</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of institutional owners (breadth)</span></span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    n_owners <span class="op">=</span> (ownership[ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>                .nunique()</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>                .reset_index()</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>                .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_inst_owners'</span>}))</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>    n_foreign_owners <span class="op">=</span> (ownership[ownership[<span class="st">'owner_type'</span>] <span class="op">==</span> OwnershipType.FOREIGN_INST]</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>                        .groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>                        .nunique()</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                        .reset_index()</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>                        .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_foreign_owners'</span>}))</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(n_owners, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(n_foreign_owners, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>    merged[[<span class="st">'n_inst_owners'</span>, <span class="st">'n_foreign_owners'</span>]] <span class="op">=</span> (</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>        merged[[<span class="st">'n_inst_owners'</span>, <span class="st">'n_foreign_owners'</span>]].fillna(<span class="dv">0</span>)</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Ownership decomposition computed:"</span>)</span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stock-period observations: </span><span class="sc">{</span><span class="bu">len</span>(merged)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique tickers: </span><span class="sc">{</span>merged[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Mean ownership structure:"</span>)</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>    pct_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> merged.columns <span class="cf">if</span> c.startswith(<span class="st">'pct_'</span>)]</span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(merged[pct_cols].mean().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a><span class="co"># ownership_decomp = compute_ownership_decomposition(</span></span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, prices_q</span></span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="sec-ownership-metrics" class="level2" data-number="22.5">
<h2 data-number="22.5" class="anchored" data-anchor-id="sec-ownership-metrics"><span class="header-section-number">22.5</span> Institutional Ownership Measures</h2>
<section id="sec-io-ratio" class="level3" data-number="22.5.1">
<h3 data-number="22.5.1" class="anchored" data-anchor-id="sec-io-ratio"><span class="header-section-number">22.5.1</span> Ownership Ratio</h3>
<p>The <strong>Institutional Ownership Ratio (IOR)</strong> for stock <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> in Vietnam is:</p>
<p><span id="eq-ior-vn"><span class="math display">\[
IOR_{i,t} = \frac{S_{i,t}^{state} + S_{i,t}^{foreign\_inst} + S_{i,t}^{domestic\_inst}}{TSO_{i,t}}
\tag{22.1}\]</span></span></p>
<p>where <span class="math inline">\(S_{i,t}^{type}\)</span> denotes adjusted shares held by each ownership category and <span class="math inline">\(TSO_{i,t}\)</span> is total shares outstanding. Unlike the US where the IOR can exceed 100% due to long-only reporting and short selling, the Vietnamese IOR is bounded by construction in <span class="math inline">\([0, 1]\)</span> because we observe the complete ownership decomposition.</p>
<p>We also compute category-specific ownership ratios:</p>
<p><span id="eq-ior-components"><span class="math display">\[
\begin{aligned}
IOR_{i,t}^{foreign} &amp;= \frac{S_{i,t}^{foreign\_inst}}{TSO_{i,t}},\\
IOR_{i,t}^{state} &amp;= \frac{S_{i,t}^{state}}{TSO_{i,t}},\\
IOR_{i,t}^{domestic} &amp;= \frac{S_{i,t}^{domestic\_inst}}{TSO_{i,t}}
\end{aligned}
\tag{22.2}\]</span></span></p>
</section>
<section id="sec-hhi" class="level3" data-number="22.5.2">
<h3 data-number="22.5.2" class="anchored" data-anchor-id="sec-hhi"><span class="header-section-number">22.5.2</span> Concentration: Herfindahl-Hirschman Index</h3>
<p>The <strong>Institutional Ownership Concentration</strong> via the Herfindahl-Hirschman Index is:</p>
<p><span id="eq-hhi-vn"><span class="math display">\[
IOC_{i,t}^{HHI} = \sum_{j=1}^{N_{i,t}} \left(\frac{S_{i,j,t}}{\sum_{k=1}^{N_{i,t}} S_{i,k,t}}\right)^2
\tag{22.3}\]</span></span></p>
<p>In Vietnam, the HHI is particularly informative because it captures the dominance of state shareholders. A company where the government holds 65% will have a mechanically high HHI even if the remaining 35% is diversely held.</p>
<p>We therefore compute <strong>separate HHI measures</strong> for different ownership categories:</p>
<p><span id="eq-hhi-decomposed"><span class="math display">\[
HHI_{i,t}^{total} = \sum_{j} w_{i,j,t}^2, \quad
HHI_{i,t}^{non-state} = \sum_{j \notin state} \left(\frac{S_{i,j,t}}{\sum_{k \notin state} S_{i,k,t}}\right)^2
\tag{22.4}\]</span></span></p>
<p>The non-state HHI is more comparable to the US institutional HHI, as it captures concentration among market-driven investors.</p>
</section>
<section id="sec-breadth" class="level3" data-number="22.5.3">
<h3 data-number="22.5.3" class="anchored" data-anchor-id="sec-breadth"><span class="header-section-number">22.5.3</span> Breadth of Ownership</h3>
<p>Following <span class="citation" data-cites="chen2002breadth">Chen, Hong, and Stein (<a href="references.html#ref-chen2002breadth" role="doc-biblioref">2002</a>)</span>, <strong>Institutional Breadth</strong> (<span class="math inline">\(N_{i,t}\)</span>) is the number of institutional investors holding stock <span class="math inline">\(i\)</span> in period <span class="math inline">\(t\)</span>. The <strong>Change in Breadth</strong> is:</p>
<p><span id="eq-dbreadth-vn"><span class="math display">\[
\Delta Breadth_{i,t} = \frac{N_{i,t}^{cont} - N_{i,t-1}^{cont}}{TotalInstitutions_{t-1}}
\tag{22.5}\]</span></span></p>
<p>where <span class="math inline">\(N_{i,t}^{cont}\)</span> counts only institutions that appear in the disclosure universe in both periods <span class="math inline">\(t\)</span> and <span class="math inline">\(t-1\)</span>, following the <span class="citation" data-cites="lehavy2008investor">Lehavy and Sloan (<a href="references.html#ref-lehavy2008investor" role="doc-biblioref">2008</a>)</span> algorithm. This adjustment is particularly important in Vietnam where:</p>
<ul>
<li>New funds launch frequently (especially ETFs tracking VN30)</li>
<li>Foreign funds enter and exit the market</li>
<li>Domestic securities firms consolidate or spin off asset management divisions</li>
</ul>
<div id="compute-all-metrics" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Compute All IO Metrics</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_io_metrics_vietnam(ownership: pd.DataFrame,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                                ownership_decomp: pd.DataFrame,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>                                adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute security-level institutional ownership metrics adapted for Vietnam.</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes:</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Ownership ratios by category (state, foreign, domestic inst, individual)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">    2. HHI concentration (total, non-state, foreign-only)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Number of institutional owners (total, foreign, domestic)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Change in breadth (Lehavy-Sloan adjusted)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    5. FOL-related metrics (utilization, room, near-cap indicator)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership data with individual shareholder records</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_decomp : pd.DataFrame</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Aggregated ownership decomposition (output of compute_ownership_decomposition)</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock-period level metrics</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with the ownership decomposition</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> ownership_decomp.copy()</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- HHI Concentration ---</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total HHI: across all institutional shareholders</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    inst_ownership <span class="op">=</span> ownership[</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_hhi_group(group):</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Compute HHI for a group of shareholders."""</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> group[<span class="st">'shares_held'</span>].<span class="bu">sum</span>()</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">'shares_held'</span>] <span class="op">/</span> total</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total institutional HHI</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    hhi_total <span class="op">=</span> (inst_ownership.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>                               .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>                               .reset_index(name<span class="op">=</span><span class="st">'hhi_institutional'</span>))</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_total, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-state HHI (exclude state shareholders)</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>    non_state <span class="op">=</span> ownership[</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin([OwnershipType.FOREIGN_INST, </span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                                       OwnershipType.DOMESTIC_INST])</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    hhi_nonstate <span class="op">=</span> (non_state.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>                             .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a>                             .reset_index(name<span class="op">=</span><span class="st">'hhi_non_state'</span>))</span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_nonstate, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Foreign-only HHI</span></span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>    foreign_only <span class="op">=</span> ownership[ownership[<span class="st">'owner_type'</span>] <span class="op">==</span> OwnershipType.FOREIGN_INST]</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    hhi_foreign <span class="op">=</span> (foreign_only.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>                               .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>                               .reset_index(name<span class="op">=</span><span class="st">'hhi_foreign'</span>))</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_foreign, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Change in Breadth (Lehavy-Sloan Algorithm) ---</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get list of all institutions filing in each period</span></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>    inst_by_period <span class="op">=</span> (inst_ownership.groupby(<span class="st">'date'</span>)[<span class="st">'shareholder_name'</span>]</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>                                     .<span class="bu">apply</span>(<span class="bu">set</span>)</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>                                     .to_dict())</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each stock-period: count continuing institutions</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_breadth_change(group):</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'dbreadth'</span>] <span class="op">=</span> np.nan</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(group)):</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>            current_date <span class="op">=</span> group.loc[i, <span class="st">'date'</span>]</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>            prev_date <span class="op">=</span> group.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'date'</span>]</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Institutions in universe for both periods</span></span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>            current_universe <span class="op">=</span> inst_by_period.get(current_date, <span class="bu">set</span>())</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>            prev_universe <span class="op">=</span> inst_by_period.get(prev_date, <span class="bu">set</span>())</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>            continuing_universe <span class="op">=</span> current_universe <span class="op">&amp;</span> prev_universe</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(prev_universe) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count continuing institutions holding this stock in each period</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>            ticker <span class="op">=</span> group.loc[i, <span class="st">'ticker'</span>]</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>            current_holders <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>                inst_ownership[</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span> </span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'date'</span>] <span class="op">==</span> current_date)</span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>                ][<span class="st">'shareholder_name'</span>]</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a>            prev_holders <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>                inst_ownership[</span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span> </span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'date'</span>] <span class="op">==</span> prev_date)</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>                ][<span class="st">'shareholder_name'</span>]</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count only continuing institutions</span></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>            n_current_cont <span class="op">=</span> <span class="bu">len</span>(current_holders <span class="op">&amp;</span> continuing_universe)</span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>            n_prev_cont <span class="op">=</span> <span class="bu">len</span>(prev_holders <span class="op">&amp;</span> continuing_universe)</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>            group.loc[i, <span class="st">'dbreadth'</span>] <span class="op">=</span> (</span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>                (n_current_cont <span class="op">-</span> n_prev_cont) <span class="op">/</span> <span class="bu">len</span>(prev_universe)</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> group</span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.groupby(<span class="st">'ticker'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(compute_breadth_change)</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- FOL Indicators ---</span></span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'fol_utilization'</span> <span class="kw">in</span> metrics.columns:</span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'near_fol_cap'</span>] <span class="op">=</span> (metrics[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.90</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'at_fol_cap'</span>] <span class="op">=</span> (metrics[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.98</span>).astype(<span class="bu">int</span>)</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"IO metrics computed for Vietnam:"</span>)</span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Observations: </span><span class="sc">{</span><span class="bu">len</span>(metrics)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Key metric distributions:"</span>)</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>    summary_cols <span class="op">=</span> [<span class="st">'pct_institutional'</span>, <span class="st">'pct_state'</span>, <span class="st">'pct_foreign_total'</span>,</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'hhi_institutional'</span>, <span class="st">'n_inst_owners'</span>, <span class="st">'dbreadth'</span>]</span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    summary_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> summary_cols <span class="cf">if</span> c <span class="kw">in</span> metrics.columns]</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(metrics[summary_cols].describe().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-138"><a href="#cb6-138" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics</span>
<span id="cb6-139"><a href="#cb6-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-140"><a href="#cb6-140" aria-hidden="true" tabindex="-1"></a><span class="co"># io_metrics = compute_io_metrics_vietnam(</span></span>
<span id="cb6-141"><a href="#cb6-141" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, ownership_decomp, adj_factors</span></span>
<span id="cb6-142"><a href="#cb6-142" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="time-series-visualization" class="level3" data-number="22.5.4">
<h3 data-number="22.5.4" class="anchored" data-anchor-id="time-series-visualization"><span class="header-section-number">22.5.4</span> Time Series Visualization</h3>
<div id="fig-io-timeseries-vn" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-fig-height="12" data-execution_count="9">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-io-timeseries-vn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_ownership_timeseries_vietnam(metrics: pd.DataFrame):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create publication-quality time series plots of Vietnamese </span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership structure evolution.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">14</span>))</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate across all stocks (market-cap weighted)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> metrics.groupby(<span class="st">'quarter_end'</span>).<span class="bu">apply</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_state'</span>: np.average(g[<span class="st">'pct_state'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                                     weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_foreign'</span>: np.average(g[<span class="st">'pct_foreign_total'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>                                       weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_domestic_inst'</span>: np.average(g[<span class="st">'pct_domestic_inst'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>                                             weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_individual'</span>: np.average(g[<span class="st">'pct_individual'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>                                          weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_stocks'</span>: g[<span class="st">'ticker'</span>].nunique(),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_mktcap'</span>: g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>(),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_n_inst'</span>: g[<span class="st">'n_inst_owners'</span>].median(),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_hhi'</span>: g[<span class="st">'hhi_institutional'</span>].median(),</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_soe'</span>: g[<span class="st">'is_soe'</span>].mean(),</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel A: Ownership Composition (Stacked Area) ----</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> ts[<span class="st">'quarter_end'</span>]</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    ax.stackplot(dates,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_state'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_foreign'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_domestic_inst'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_individual'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>                 labels<span class="op">=</span>[<span class="st">'State'</span>, <span class="st">'Foreign Institutional'</span>, </span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Domestic Institutional'</span>, <span class="st">'Individual'</span>],</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>                 colors<span class="op">=</span>[OWNER_COLORS[<span class="st">'State'</span>], OWNER_COLORS[<span class="st">'Foreign Institutional'</span>],</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                         OWNER_COLORS[<span class="st">'Domestic Institutional'</span>], OWNER_COLORS[<span class="st">'Individual'</span>]],</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Ownership Share (%)'</span>)</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel A: Ownership Composition of Vietnamese Listed Companies '</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'(Market-Cap Weighted)'</span>)</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel B: Institutional Ownership by Component ----</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_state'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'State'</span>,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'State'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_foreign'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'Foreign Institutional'</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Foreign Institutional'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_domestic_inst'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'Domestic Institutional'</span>,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Domestic Institutional'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>    total_inst <span class="op">=</span> (ts[<span class="st">'pct_state'</span>] <span class="op">+</span> ts[<span class="st">'pct_foreign'</span>] <span class="op">+</span> ts[<span class="st">'pct_domestic_inst'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, total_inst, label<span class="op">=</span><span class="st">'Total Institutional'</span>,</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Total Institutional'</span>], linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Ownership Ratio (%)'</span>)</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel B: Institutional Ownership Components'</span>)</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel C: Market Structure ----</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">2</span>]</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> ax.twinx()</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'n_stocks'</span>], color<span class="op">=</span><span class="st">'#1f77b4'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'# Listed Stocks'</span>)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    ax2.plot(dates, ts[<span class="st">'total_mktcap'</span>] <span class="op">/</span> <span class="dv">1000</span>, color<span class="op">=</span><span class="st">'#d62728'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Total Market Cap (Trillion VND)'</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Number of Listed Stocks'</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>)</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Market Cap (Trillion VND)'</span>, color<span class="op">=</span><span class="st">'#d62728'</span>)</span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel C: Vietnamese Stock Market Development'</span>)</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine legends</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    lines1, labels1 <span class="op">=</span> ax.get_legend_handles_labels()</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    lines2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    ax.legend(lines1 <span class="op">+</span> lines2, labels1 <span class="op">+</span> labels2, loc<span class="op">=</span><span class="st">'upper left'</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_ownership_timeseries_vn.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_ownership_timeseries_vietnam(io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-io-timeseries-vn-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.1
</figcaption>
</figure>
</div>
<div id="fig-io-by-exchange" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-io-by-exchange-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_io_by_exchange_size(metrics: pd.DataFrame):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot IO ratios by exchange and size quintile."""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[metrics[<span class="st">'market_cap'</span>].notna() <span class="op">&amp;</span> (metrics[<span class="st">'market_cap'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)].copy()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Size quintiles within each quarter</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'size_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'market_cap'</span>].transform(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="st">'Q1</span><span class="ch">\n</span><span class="st">(Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5</span><span class="ch">\n</span><span class="st">(Large)'</span>],</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>                          duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    metrics_to_plot <span class="op">=</span> [</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_institutional'</span>, <span class="st">'Total Institutional'</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_foreign_total'</span>, <span class="st">'Foreign Institutional'</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_state'</span>, <span class="st">'State'</span>),</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, (col, title) <span class="kw">in</span> <span class="bu">zip</span>(axes, metrics_to_plot):</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> exchange, color <span class="kw">in</span> EXCHANGE_COLORS.items():</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> df[df[<span class="st">'exchange'</span>] <span class="op">==</span> exchange]</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            means <span class="op">=</span> data.groupby(<span class="st">'size_quintile'</span>)[col].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>            ax.bar(np.arange(<span class="bu">len</span>(means)) <span class="op">+</span> <span class="bu">list</span>(EXCHANGE_COLORS.keys()).index(exchange) <span class="op">*</span> <span class="fl">0.25</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>                   means, width<span class="op">=</span><span class="fl">0.25</span>, label<span class="op">=</span>exchange, color<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'Size Quintile'</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="op">==</span> axes[<span class="dv">0</span>]:</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">'Mean Ownership (%)'</span>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        ax.set_xticks(np.arange(<span class="dv">5</span>) <span class="op">+</span> <span class="fl">0.25</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels([<span class="st">'Q1</span><span class="ch">\n</span><span class="st">(Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5</span><span class="ch">\n</span><span class="st">(Large)'</span>])</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_io_by_exchange_size.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_io_by_exchange_size(io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-io-by-exchange-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.2
</figcaption>
</figure>
</div>
<div id="tbl-io-summary" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="11">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-io-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.3: Summary Statistics of Ownership Structure in Vietnam by Size Quintile and Exchange (Pooled 2010-2024)
</figcaption>
<div aria-describedby="tbl-io-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tabulate_io_summary(metrics: pd.DataFrame, start_year: <span class="bu">int</span> <span class="op">=</span> <span class="dv">2010</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create publication-quality summary table of Vietnamese ownership</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">    structure by firm size.</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        (metrics[<span class="st">'quarter_end'</span>].dt.year <span class="op">&gt;=</span> start_year) <span class="op">&amp;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        (metrics[<span class="st">'market_cap'</span>].notna()) <span class="op">&amp;</span> (metrics[<span class="st">'market_cap'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'size_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'market_cap'</span>].transform(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="st">'Q1 (Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5 (Large)'</span>],</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                          duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> df.groupby(<span class="st">'size_quintile'</span>).agg(</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        N<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'count'</span>),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        Mean_MktCap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        Mean_IO_Total<span class="op">=</span>(<span class="st">'pct_institutional'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        Mean_State<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        Mean_Foreign<span class="op">=</span>(<span class="st">'pct_foreign_total'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        Mean_Domestic_Inst<span class="op">=</span>(<span class="st">'pct_domestic_inst'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>        Mean_Individual<span class="op">=</span>(<span class="st">'pct_individual'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>        Median_N_Owners<span class="op">=</span>(<span class="st">'n_inst_owners'</span>, <span class="st">'median'</span>),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>        Median_HHI<span class="op">=</span>(<span class="st">'hhi_institutional'</span>, <span class="st">'median'</span>),</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>        Pct_SOE<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        Mean_FOL_Util<span class="op">=</span>(<span class="st">'fol_utilization'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'N'</span>] <span class="op">=</span> table[<span class="st">'N'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Mean_MktCap'</span>] <span class="op">=</span> table[<span class="st">'Mean_MktCap'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">B VND"</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Mean_IO_Total'</span>, <span class="st">'Mean_State'</span>, <span class="st">'Mean_Foreign'</span>, </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Mean_Domestic_Inst'</span>, <span class="st">'Mean_Individual'</span>, <span class="st">'Pct_SOE'</span>, <span class="st">'Mean_FOL_Util'</span>]:</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        table[col] <span class="op">=</span> table[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.1%}</span><span class="ss">"</span> <span class="cf">if</span> pd.notna(x) <span class="cf">else</span> <span class="st">"—"</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Median_N_Owners'</span>] <span class="op">=</span> table[<span class="st">'Median_N_Owners'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Median_HHI'</span>] <span class="op">=</span> table[<span class="st">'Median_HHI'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> pd.notna(x) <span class="cf">else</span> <span class="st">"—"</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    table.columns <span class="op">=</span> [<span class="st">'N'</span>, <span class="st">'Mean Mkt Cap'</span>, <span class="st">'IO Total'</span>, <span class="st">'State'</span>, <span class="st">'Foreign'</span>, </span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'Dom. Inst.'</span>, <span class="st">'Individual'</span>, <span class="st">'Med. # Owners'</span>, </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'Med. HHI'</span>, <span class="st">'% SOE'</span>, <span class="st">'FOL Util.'</span>]</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co"># io_summary = tabulate_io_summary(io_metrics)</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="co"># print(io_summary.to_string())</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<hr>
</section>
</section>
<section id="sec-foreign-ownership" class="level2" data-number="22.6">
<h2 data-number="22.6" class="anchored" data-anchor-id="sec-foreign-ownership"><span class="header-section-number">22.6</span> Foreign Ownership Dynamics</h2>
<section id="sec-fol" class="level3" data-number="22.6.1">
<h3 data-number="22.6.1" class="anchored" data-anchor-id="sec-fol"><span class="header-section-number">22.6.1</span> Foreign Ownership Limits and the FOL Premium</h3>
<p>Vietnam’s Foreign Ownership Limits create a unique market segmentation. When a stock reaches its FOL, the only way for a new foreign investor to buy is if an existing foreign holder sells. This creates a de facto “foreign-only” market for FOL-constrained stocks, with documented price premiums <span class="citation" data-cites="vo2015foreign">(<a href="references.html#ref-vo2015foreign" role="doc-biblioref">Vo 2015</a>)</span>.</p>
<p>The <strong>FOL Utilization Ratio</strong> for stock <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> is:</p>
<p><span id="eq-fol-util"><span class="math display">\[
FOL\_Util_{i,t} = \frac{ForeignOwnership_{i,t}}{FOL\_Limit_i}
\tag{22.6}\]</span></span></p>
<p>Stocks are classified by FOL proximity (<a href="#tbl-fol-zones" class="quarto-xref">Table&nbsp;<span>22.4</span></a>).</p>
<div id="tbl-fol-zones" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-fol-zones-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.4: FOL Proximity Zones
</figcaption>
<div aria-describedby="tbl-fol-zones-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 48%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">FOL Zone</th>
<th style="text-align: left;">Utilization Range</th>
<th style="text-align: left;">Market Implication</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Green</strong></td>
<td style="text-align: left;">&lt; 50%</td>
<td style="text-align: left;">Ample foreign room; normal trading</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Yellow</strong></td>
<td style="text-align: left;">50-80%</td>
<td style="text-align: left;">Moderate room; some foreign interest pressure</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Orange</strong></td>
<td style="text-align: left;">80-95%</td>
<td style="text-align: left;">Limited room; foreign premium emerging</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Red</strong></td>
<td style="text-align: left;">95-100%</td>
<td style="text-align: left;">Near cap; significant foreign premium</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Capped</strong></td>
<td style="text-align: left;">≈ 100%</td>
<td style="text-align: left;">At limit; foreign-only secondary market</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<div id="fol-analysis" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Foreign Ownership Limit Analysis</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FOLAnalyzer:</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Analyze Foreign Ownership Limit dynamics in the Vietnamese market.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Key analyses:</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. FOL utilization tracking and classification</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. FOL premium estimation (price impact of being near cap)</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Foreign room dynamics (opening/closing events)</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Cross-sectional determinants of foreign ownership</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    FOL_ZONES <span class="op">=</span> {</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Green'</span>: (<span class="dv">0</span>, <span class="fl">0.50</span>),</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Yellow'</span>: (<span class="fl">0.50</span>, <span class="fl">0.80</span>),</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Orange'</span>: (<span class="fl">0.80</span>, <span class="fl">0.95</span>),</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Red'</span>: (<span class="fl">0.95</span>, <span class="fl">1.00</span>),</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Capped'</span>: (<span class="fl">1.00</span>, <span class="fl">1.50</span>),</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, io_metrics: pd.DataFrame,</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                 foreign_daily: Optional[pd.DataFrame] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">        io_metrics : pd.DataFrame</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="co">            Full ownership metrics from compute_io_metrics_vietnam()</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="co">        foreign_daily : pd.DataFrame, optional</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="co">            Daily foreign ownership tracking from DataCore.vn</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metrics <span class="op">=</span> io_metrics.copy()</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.foreign_daily <span class="op">=</span> foreign_daily</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> classify_fol_zones(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Classify stocks into FOL proximity zones."""</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span>.metrics.copy()</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'fol_utilization'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"FOL utilization not available in metrics."</span>)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> df</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        conditions <span class="op">=</span> []</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        choices <span class="op">=</span> []</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> zone, (lo, hi) <span class="kw">in</span> <span class="va">self</span>.FOL_ZONES.items():</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>            conditions.append(</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;=</span> lo) <span class="op">&amp;</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&lt;</span> hi)</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            choices.append(zone)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'fol_zone'</span>] <span class="op">=</span> np.select(conditions, choices, default<span class="op">=</span><span class="st">'Unknown'</span>)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Summary</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        zone_dist <span class="op">=</span> df.groupby(<span class="st">'fol_zone'</span>)[<span class="st">'ticker'</span>].nunique()</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"FOL Zone Distribution (unique stocks):"</span>)</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(zone_dist.to_string())</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> estimate_fol_premium(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a><span class="co">        Estimate the FOL premium using a cross-sectional approach.</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a><span class="co">        For each period, regress stock valuations (P/B or P/E) on FOL </span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a><span class="co">        utilization, controlling for fundamentals. The coefficient on </span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a><span class="co">        FOL utilization captures the premium investors pay for stocks </span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a><span class="co">        near their foreign ownership cap.</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="co">        Alternative: Compare returns of stocks transitioning between </span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a><span class="co">        FOL zones as a natural experiment.</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span>.metrics.copy()</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">'fol_utilization'</span>].notna() <span class="op">&amp;</span> df[<span class="st">'market_cap'</span>].notna()].copy()</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># FOL zone dummies</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'near_cap'</span>] <span class="op">=</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.90</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'at_cap'</span>] <span class="op">=</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.98</span>).astype(<span class="bu">int</span>)</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price-to-book as valuation measure</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Assumes 'equity' is available from financial data)</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'equity'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'pb_ratio'</span>] <span class="op">=</span> df[<span class="st">'market_cap'</span>] <span class="op">*</span> <span class="fl">1e9</span> <span class="op">/</span> df[<span class="st">'equity'</span>]</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use market cap as proxy for cross-sectional analysis</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'log_mktcap'</span>] <span class="op">=</span> np.log(df[<span class="st">'market_cap'</span>])</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fama-MacBeth style: run cross-sectional regressions each period</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> quarter, group <span class="kw">in</span> df.groupby(<span class="st">'quarter_end'</span>):</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.dropna(subset<span class="op">=</span>[<span class="st">'fol_utilization'</span>, <span class="st">'log_mktcap'</span>])</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> group[<span class="st">'log_mktcap'</span>]</span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(group[[<span class="st">'fol_utilization'</span>, <span class="st">'pct_state'</span>, </span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">'n_inst_owners'</span>]])</span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>                results.append({</span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'quarter'</span>: quarter,</span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'beta_fol'</span>: model.params.get(<span class="st">'fol_utilization'</span>, np.nan),</span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'tstat_fol'</span>: model.tvalues.get(<span class="st">'fol_utilization'</span>, np.nan),</span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'r2'</span>: model.rsquared,</span>
<span id="cb10-106"><a href="#cb10-106" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'n'</span>: <span class="bu">len</span>(group),</span>
<span id="cb10-107"><a href="#cb10-107" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb10-108"><a href="#cb10-108" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb10-109"><a href="#cb10-109" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb10-110"><a href="#cb10-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-111"><a href="#cb10-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> results:</span>
<span id="cb10-112"><a href="#cb10-112" aria-hidden="true" tabindex="-1"></a>            results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb10-113"><a href="#cb10-113" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"FOL Premium (Fama-MacBeth Regression):"</span>)</span>
<span id="cb10-114"><a href="#cb10-114" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Mean β(FOL_util): </span><span class="sc">{</span>results_df[<span class="st">'beta_fol'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb10-115"><a href="#cb10-115" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  t-statistic: </span><span class="sc">{</span>results_df[<span class="st">'beta_fol'</span>]<span class="sc">.</span>mean() <span class="op">/</span> <span class="st">"</span></span>
<span id="cb10-116"><a href="#cb10-116" aria-hidden="true" tabindex="-1"></a><span class="er">                  f"(results_df['beta_fol'].std() / np.sqrt(len(results_df))):.2f}")</span></span>
<span id="cb10-117"><a href="#cb10-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> results_df</span>
<span id="cb10-118"><a href="#cb10-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-119"><a href="#cb10-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd<span class="sc">.</span>DataFrame()</span>
<span id="cb10-120"><a href="#cb10-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-121"><a href="#cb10-121" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> analyze_foreign_room_events(<span class="va">self</span>) <span class="op">-&gt;</span> pd<span class="sc">.</span>DataFrame<span class="sc">:</span></span>
<span id="cb10-122"><a href="#cb10-122" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb10-123"><a href="#cb10-123" aria-hidden="true" tabindex="-1"></a><span class="co">        Analyze events where foreign room opens or closes.</span></span>
<span id="cb10-124"><a href="#cb10-124" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb10-125"><a href="#cb10-125" aria-hidden="true" tabindex="-1"></a><span class="co">        Room-opening events (FOL cap raised, foreign seller exits) can</span></span>
<span id="cb10-126"><a href="#cb10-126" aria-hidden="true" tabindex="-1"></a><span class="co">        trigger significant price movements as pent-up foreign demand </span></span>
<span id="cb10-127"><a href="#cb10-127" aria-hidden="true" tabindex="-1"></a><span class="co">        is released. Room-closing events (approaching cap) can create</span></span>
<span id="cb10-128"><a href="#cb10-128" aria-hidden="true" tabindex="-1"></a><span class="co">        selling pressure as foreign investors anticipate illiquidity.</span></span>
<span id="cb10-129"><a href="#cb10-129" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb10-130"><a href="#cb10-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span><span class="sc">.</span>foreign_daily <span class="kw">is</span> <span class="va">None</span><span class="sc">:</span></span>
<span id="cb10-131"><a href="#cb10-131" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Daily foreign ownership data required for event analysis."</span>)</span>
<span id="cb10-132"><a href="#cb10-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd<span class="sc">.</span>DataFrame()</span>
<span id="cb10-133"><a href="#cb10-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-134"><a href="#cb10-134" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span><span class="sc">.</span>foreign_daily<span class="sc">.</span>copy()</span>
<span id="cb10-135"><a href="#cb10-135" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df<span class="sc">.</span>sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb10-136"><a href="#cb10-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-137"><a href="#cb10-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute daily change in foreign room</span></span>
<span id="cb10-138"><a href="#cb10-138" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'foreign_room_change'</span>] <span class="op">=</span> df<span class="sc">.</span>groupby(<span class="st">'ticker'</span>)[<span class="st">'foreign_room'</span>]<span class="sc">.</span>diff()</span>
<span id="cb10-139"><a href="#cb10-139" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-140"><a href="#cb10-140" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify room-opening events (room increases by &gt; 1 percentage point)</span></span>
<span id="cb10-141"><a href="#cb10-141" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'room_open_event'</span>] <span class="op">=</span> (df[<span class="st">'foreign_room_change'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>)<span class="sc">.</span>astype(<span class="bu">int</span>)</span>
<span id="cb10-142"><a href="#cb10-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-143"><a href="#cb10-143" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify room-closing events (room decreases to &lt; 2%)</span></span>
<span id="cb10-144"><a href="#cb10-144" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'room_close_event'</span>] <span class="op">=</span> (</span>
<span id="cb10-145"><a href="#cb10-145" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'foreign_room'</span>] <span class="op">&lt;</span> <span class="fl">0.02</span>) <span class="op">&amp;</span> </span>
<span id="cb10-146"><a href="#cb10-146" aria-hidden="true" tabindex="-1"></a>            (df.groupby(<span class="st">'ticker'</span>)[<span class="st">'foreign_room'</span>].shift(<span class="dv">1</span>) <span class="op">&gt;=</span> <span class="fl">0.02</span>)</span>
<span id="cb10-147"><a href="#cb10-147" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">.</span>astype(<span class="bu">int</span>)</span>
<span id="cb10-148"><a href="#cb10-148" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-149"><a href="#cb10-149" aria-hidden="true" tabindex="-1"></a>        events <span class="op">=</span> df[</span>
<span id="cb10-150"><a href="#cb10-150" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'room_open_event'</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">|</span> (df[<span class="st">'room_close_event'</span>] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb10-151"><a href="#cb10-151" aria-hidden="true" tabindex="-1"></a>        ]<span class="sc">.</span>copy()</span>
<span id="cb10-152"><a href="#cb10-152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-153"><a href="#cb10-153" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Foreign room events identified:"</span>)</span>
<span id="cb10-154"><a href="#cb10-154" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Room-opening events: </span><span class="sc">{</span>df[<span class="st">'room_open_event'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-155"><a href="#cb10-155" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Room-closing events: </span><span class="sc">{</span>df[<span class="st">'room_close_event'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-156"><a href="#cb10-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-157"><a href="#cb10-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> events</span>
<span id="cb10-158"><a href="#cb10-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-159"><a href="#cb10-159" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_analyzer = FOLAnalyzer(io_metrics, dc.foreign_ownership)</span></span>
<span id="cb10-160"><a href="#cb10-160" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_classified = fol_analyzer.classify_fol_zones()</span></span>
<span id="cb10-161"><a href="#cb10-161" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_premium = fol_analyzer.estimate_fol_premium()</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-fol-utilization" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fol-utilization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fol_utilization(metrics: pd.DataFrame):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot FOL utilization distribution by sector."""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[metrics[<span class="st">'fol_utilization'</span>].notna()].copy()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign broad sectors</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    sector_map <span class="op">=</span> {</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Banking'</span>: [<span class="st">'VCB'</span>, <span class="st">'BID'</span>, <span class="st">'CTG'</span>, <span class="st">'TCB'</span>, <span class="st">'VPB'</span>, <span class="st">'MBB'</span>, <span class="st">'ACB'</span>, <span class="st">'HDB'</span>, <span class="st">'STB'</span>, <span class="st">'TPB'</span>],</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real Estate'</span>: [<span class="st">'VHM'</span>, <span class="st">'VIC'</span>, <span class="st">'NVL'</span>, <span class="st">'KDH'</span>, <span class="st">'DXG'</span>, <span class="st">'HDG'</span>, <span class="st">'VRE'</span>],</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Technology'</span>: [<span class="st">'FPT'</span>, <span class="st">'CMG'</span>, <span class="st">'FOX'</span>],</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Consumer'</span>: [<span class="st">'VNM'</span>, <span class="st">'MSN'</span>, <span class="st">'SAB'</span>, <span class="st">'MWG'</span>, <span class="st">'PNJ'</span>],</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sector, tickers <span class="kw">in</span> sector_map.items():</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> df[df[<span class="st">'ticker'</span>].isin(tickers)][<span class="st">'fol_utilization'</span>]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>            ax.hist(data <span class="op">*</span> <span class="dv">100</span>, bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, label<span class="op">=</span>sector, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Banking FOL (30%)'</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="dv">49</span>, color<span class="op">=</span><span class="st">'blue'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Standard FOL (49%)'</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'FOL Utilization (%)'</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Foreign Ownership Limit Utilization Distribution'</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_fol_utilization.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_fol_utilization(io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-fol-utilization-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.3
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-trades" class="level2" data-number="22.7">
<h2 data-number="22.7" class="anchored" data-anchor-id="sec-trades"><span class="header-section-number">22.7</span> Institutional Trades</h2>
<section id="sec-trade-inference" class="level3" data-number="22.7.1">
<h3 data-number="22.7.1" class="anchored" data-anchor-id="sec-trade-inference"><span class="header-section-number">22.7.1</span> Trade Inference in Vietnam</h3>
<p>In the US, institutional trades are inferred from quarterly 13F holding snapshots. In Vietnam, the challenge is more acute because disclosure frequency varies:</p>
<ul>
<li><strong>Major shareholders (</strong><span class="math inline">\(\ge\)</span> <strong>5%)</strong>: Must disclose within 7 business days of crossing ownership thresholds (5%, 10%, 15%, 20%, 25%, 50%, 65%, 75%)</li>
<li><strong>Fund portfolio reports:</strong> Semi-annual disclosure required; some funds report quarterly</li>
<li><strong>Annual reports:</strong> Provide complete shareholder register but only once per year</li>
<li><strong>Daily foreign ownership:</strong> HOSE/HNX publish aggregate daily foreign buy/sell data</li>
</ul>
<p>We derive trades from the <strong>change in ownership between consecutive disclosure dates</strong>, applying the same logic as the US <span class="citation" data-cites="ben2013hedge">Ben-David et al. (<a href="references.html#ref-ben2013hedge" role="doc-biblioref">2013</a>)</span> algorithm but adapted for Vietnam’s irregular disclosure intervals.</p>
<div id="derive-trades-vn" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Derive Institutional Trades</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> derive_trades_vietnam(ownership: pd.DataFrame,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>                           adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Derive institutional trades from changes in ownership disclosures.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Adapted from Ben-David, Franzoni, and Moussawi (2012) for </span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's irregular disclosure frequency.</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Key differences from US approach:</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Disclosure intervals are irregular (not always quarterly)</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">    2. We observe ALL institutional types, not just 13F filers</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co">    3. No $100M AUM threshold (we see all institutional holders)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Must adjust for corporate actions between disclosure dates</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Trade types:</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="co">    +1: Initiating Buy (new position)</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="co">    +2: Incremental Buy (increased existing position)</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="co">    -1: Terminating Sale (fully exited position)</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -2: Incremental Sale (reduced existing position)</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership with: ticker, date, shareholder_name, </span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="co">        shares_held, owner_type</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co">        Trade-level data: date, shareholder_name, ticker, trade, </span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co">        buysale, owner_type</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Focus on institutional shareholders only</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'date'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    trades_list <span class="op">=</span> []</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (shareholder, ticker), group <span class="kw">in</span> inst.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>]):</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(group)):</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>            current <span class="op">=</span> group.iloc[i]</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>            current_date <span class="op">=</span> current[<span class="st">'date'</span>]</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>            current_shares <span class="op">=</span> current[<span class="st">'shares_held'</span>]</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>            owner_type <span class="op">=</span> current[<span class="st">'owner_type'</span>]</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># First observation: if institution appears, it's an initiating buy</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>                <span class="co"># (we don't know if they held before our data starts)</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Skip the very first observation to avoid false initiating buys</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            prev <span class="op">=</span> group.iloc[i <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            prev_date <span class="op">=</span> prev[<span class="st">'date'</span>]</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>            prev_shares <span class="op">=</span> prev[<span class="st">'shares_held'</span>]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Adjust previous shares for corporate actions between dates</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>            prev_shares_adj <span class="op">=</span> adjust_shares(</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>                prev_shares, ticker, prev_date, current_date, adj_factors</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute trade (in adjusted shares)</span></span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>            trade <span class="op">=</span> current_shares <span class="op">-</span> prev_shares_adj</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Classify trade type</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(trade) <span class="op">&lt;</span> <span class="dv">1</span>:  <span class="co"># De minimis threshold</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_shares_adj <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">and</span> current_shares <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Initiating buy</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> prev_shares_adj <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> current_shares <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  <span class="co"># Terminating sale</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> trade <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="dv">2</span>  <span class="co"># Incremental buy</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="op">-</span><span class="dv">2</span>  <span class="co"># Incremental sale</span></span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>            trades_list.append({</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: current_date,</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>                <span class="st">'shareholder_name'</span>: shareholder,</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: ticker,</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>                <span class="st">'trade'</span>: trade,</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>                <span class="st">'prev_shares_adj'</span>: prev_shares_adj,</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>                <span class="st">'current_shares'</span>: current_shares,</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>                <span class="st">'buysale'</span>: buysale,</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>                <span class="st">'owner_type'</span>: owner_type,</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>                <span class="st">'days_between'</span>: (current_date <span class="op">-</span> prev_date).days,</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> pd.DataFrame(trades_list)</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(trades) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Trades derived: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Trade type distribution:"</span>)</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> {<span class="dv">1</span>: <span class="st">'Initiating Buy'</span>, <span class="dv">2</span>: <span class="st">'Incremental Buy'</span>,</span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>                  <span class="op">-</span><span class="dv">1</span>: <span class="st">'Terminating Sale'</span>, <span class="op">-</span><span class="dv">2</span>: <span class="st">'Incremental Sale'</span>}</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bs, label <span class="kw">in</span> <span class="bu">sorted</span>(labels.items()):</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> (trades[<span class="st">'buysale'</span>] <span class="op">==</span> bs).<span class="bu">sum</span>()</span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>n<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>n<span class="op">/</span><span class="bu">len</span>(trades)<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">By owner type:"</span>)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(trades.groupby(<span class="st">'owner_type'</span>)[<span class="st">'trade'</span>].agg([<span class="st">'count'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>])</span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>              .<span class="bu">round</span>(<span class="dv">0</span>).to_string())</span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="co"># trades = derive_trades_vietnam(ownership_classified, adj_factors)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="callout callout-style-default callout-warning callout-titled" title="Corporate Action Adjustment in Trade Derivation">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>Corporate Action Adjustment in Trade Derivation
</div>
</div>
<div class="callout-body-container callout-body">
<p>When computing trades as <span class="math inline">\(\Delta Shares = Shares_t - Shares_{t-1}\)</span>, the previous period’s shares <strong>must</strong> be adjusted for any corporate actions between <span class="math inline">\(t-1\)</span> and <span class="math inline">\(t\)</span>. If VNM issued a 20% stock dividend between the two disclosure dates, then 1,000 shares at <span class="math inline">\(t-1\)</span> should be compared to 1,200 adjusted shares, not 1,000 raw shares. Failing to make this adjustment would create a phantom “buy” of 200 shares that never actually occurred.</p>
</div>
</div>
<div id="vectorized-trades-vn" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> derive_trades_vectorized_vietnam(ownership: pd.DataFrame,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                      adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Vectorized version of Vietnamese trade derivation.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses pandas groupby and vectorized operations instead of Python loops.</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Approximately 20-50x faster for large datasets.</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Note: Corporate action adjustment is applied per-group, which still</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    requires some iteration but is much faster than row-by-row.</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL) <span class="op">&amp;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst.sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'date'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged values</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_date'</span>] <span class="op">=</span> inst.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'date'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_shares'</span>] <span class="op">=</span> inst.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'shares_held'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'is_first'</span>] <span class="op">=</span> inst[<span class="st">'prev_date'</span>].isna()</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove first observations (no prior to compare)</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst[<span class="op">~</span>inst[<span class="st">'is_first'</span>]].copy()</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust previous shares for corporate actions</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vectorized: for each row, apply adjustment between prev_date and date</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> adjust_row(row):</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> adjust_shares(</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'prev_shares'</span>], row[<span class="st">'ticker'</span>], </span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'prev_date'</span>], row[<span class="st">'date'</span>], adj_factors</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_shares_adj'</span>] <span class="op">=</span> inst.<span class="bu">apply</span>(adjust_row, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute trade</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'trade'</span>] <span class="op">=</span> inst[<span class="st">'shares_held'</span>] <span class="op">-</span> inst[<span class="st">'prev_shares_adj'</span>]</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'days_between'</span>] <span class="op">=</span> (inst[<span class="st">'date'</span>] <span class="op">-</span> inst[<span class="st">'prev_date'</span>]).dt.days</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classify trade type</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'buysale'</span>] <span class="op">=</span> np.select(</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>            (inst[<span class="st">'prev_shares_adj'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (inst[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>            (inst[<span class="st">'prev_shares_adj'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (inst[<span class="st">'shares_held'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>            inst[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>            inst[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>, <span class="op">-</span><span class="dv">2</span>],</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="dv">0</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove zero trades</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> inst[inst[<span class="st">'buysale'</span>] <span class="op">!=</span> <span class="dv">0</span>].copy()</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[[<span class="st">'date'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'trade'</span>, </span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'buysale'</span>, <span class="st">'owner_type'</span>, <span class="st">'days_between'</span>,</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'prev_shares_adj'</span>, <span class="st">'shares_held'</span>]].copy()</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades.rename(columns<span class="op">=</span>{<span class="st">'shares_held'</span>: <span class="st">'current_shares'</span>})</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Vectorized trades: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="co"># trades = derive_trades_vectorized_vietnam(ownership_classified, adj_factors)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-flows-turnover" class="level2" data-number="22.8">
<h2 data-number="22.8" class="anchored" data-anchor-id="sec-flows-turnover"><span class="header-section-number">22.8</span> Fund-Level Flows and Turnover</h2>
<section id="portfolio-assets-and-returns-from-fund-holdings" class="level3" data-number="22.8.1">
<h3 data-number="22.8.1" class="anchored" data-anchor-id="portfolio-assets-and-returns-from-fund-holdings"><span class="header-section-number">22.8.1</span> Portfolio Assets and Returns from Fund Holdings</h3>
<p>Using DataCore.vn’s fund holdings data, we compute fund-level portfolio analytics analogous to the US 13F approach:</p>
<p><span id="eq-assets-vn"><span class="math display">\[
Assets_{j,t} = \sum_{i=1}^{N_{j,t}} S_{i,j,t} \times P_{i,t}
\tag{22.7}\]</span></span></p>
<p><span id="eq-hret-vn"><span class="math display">\[
R_{j,t \to t+1}^{holdings} = \frac{\sum_{i} S_{i,j,t} \times P_{i,t} \times R_{i,t \to t+1}}{\sum_{i} S_{i,j,t} \times P_{i,t}}
\tag{22.8}\]</span></span></p>
<p><span id="eq-flows-vn"><span class="math display">\[
NetFlows_{j,t} = Assets_{j,t} - Assets_{j,t-1} \times (1 + R_{j,t-1 \to t}^{holdings})
\tag{22.9}\]</span></span></p>
</section>
<section id="turnover-measures" class="level3" data-number="22.8.2">
<h3 data-number="22.8.2" class="anchored" data-anchor-id="turnover-measures"><span class="header-section-number">22.8.2</span> Turnover Measures</h3>
<p>Following <span class="citation" data-cites="carhart1997persistence">Carhart (<a href="references.html#ref-carhart1997persistence" role="doc-biblioref">1997</a>)</span>, adapted for Vietnam’s fund reporting:</p>
<p><span id="eq-turnover-vn"><span class="math display">\[
Turnover_{j,t}^{Carhart} = \frac{\min(TotalBuys_{j,t}, TotalSales_{j,t})}{\overline{Assets}_{j,t}}
\tag{22.10}\]</span></span></p>
<div id="fund-analytics" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 8: Fund-Level Portfolio Analytics</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_fund_analytics(fund_holdings: pd.DataFrame,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                            prices_q: pd.DataFrame,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>                            adj_factors: pd.DataFrame) <span class="op">-&gt;</span> Dict:</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute fund-level portfolio analytics from DataCore.vn fund holdings.</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese fund disclosure is typically semi-annual (some quarterly),</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    which limits the frequency of these analytics compared to the US</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    quarterly approach.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    dict with keys:</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">        'fund_assets': pd.DataFrame of fund-level assets and returns</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">        'fund_trades': pd.DataFrame of fund-level derived trades</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">        'fund_aggregates': pd.DataFrame of flows and turnover</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fund_holdings.copy()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fh[fh[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with prices</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fh.merge(</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'ret'</span>]],</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'report_date'</span>],</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio value</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    fh[<span class="st">'holding_value'</span>] <span class="op">=</span> fh[<span class="st">'shares_held'</span>] <span class="op">*</span> fh[<span class="st">'close'</span>]</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Assets ---</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    fund_assets <span class="op">=</span> fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>]).agg(</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        total_assets<span class="op">=</span>(<span class="st">'holding_value'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e9</span>),  <span class="co"># Billion VND</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Holdings return (value-weighted)</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    fh[<span class="st">'weight'</span>] <span class="op">=</span> fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])[<span class="st">'holding_value'</span>].transform(</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x <span class="op">/</span> x.<span class="bu">sum</span>()</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    fund_hret <span class="op">=</span> (fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                   .<span class="bu">apply</span>(<span class="kw">lambda</span> g: np.average(g[<span class="st">'ret'</span>].fillna(<span class="dv">0</span>), weights<span class="op">=</span>g[<span class="st">'weight'</span>]))</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>                   .reset_index(name<span class="op">=</span><span class="st">'holdings_return'</span>))</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    fund_assets <span class="op">=</span> fund_assets.merge(fund_hret, on<span class="op">=</span>[<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Trades ---</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derive trades from changes in holdings</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    fh_sorted <span class="op">=</span> fh.sort_values([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_shares'</span>] <span class="op">=</span> fh_sorted.groupby([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'shares_held'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_date'</span>] <span class="op">=</span> fh_sorted.groupby([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'report_date'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust for corporate actions</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_shares_adj'</span>] <span class="op">=</span> fh_sorted.<span class="bu">apply</span>(</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: adjust_shares(r[<span class="st">'prev_shares'</span>], r[<span class="st">'ticker'</span>], </span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                                r[<span class="st">'prev_date'</span>], r[<span class="st">'report_date'</span>], adj_factors)</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(r[<span class="st">'prev_shares'</span>]) <span class="cf">else</span> np.nan,</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'trade'</span>] <span class="op">=</span> fh_sorted[<span class="st">'shares_held'</span>] <span class="op">-</span> fh_sorted[<span class="st">'prev_shares_adj'</span>]</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'trade_value'</span>] <span class="op">=</span> fh_sorted[<span class="st">'trade'</span>] <span class="op">*</span> fh_sorted[<span class="st">'close'</span>] <span class="op">/</span> <span class="fl">1e9</span>  <span class="co"># Billion VND</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate buys and sells per fund-period</span></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    fund_trades <span class="op">=</span> fh_sorted[fh_sorted[<span class="st">'trade'</span>].notna()].copy()</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>    fund_flows <span class="op">=</span> fund_trades.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>]).agg(</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>        total_buys<span class="op">=</span>(<span class="st">'trade_value'</span>, <span class="kw">lambda</span> x: x[x <span class="op">&gt;</span> <span class="dv">0</span>].<span class="bu">sum</span>()),</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>        total_sales<span class="op">=</span>(<span class="st">'trade_value'</span>, <span class="kw">lambda</span> x: <span class="op">-</span>x[x <span class="op">&lt;</span> <span class="dv">0</span>].<span class="bu">sum</span>()),</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Aggregates ---</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>    fund_agg <span class="op">=</span> fund_assets.merge(fund_flows, on<span class="op">=</span>[<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]] <span class="op">=</span> fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]].fillna(<span class="dv">0</span>)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    fund_agg <span class="op">=</span> fund_agg.sort_values([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'lag_assets'</span>] <span class="op">=</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'total_assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'lag_hret'</span>] <span class="op">=</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'holdings_return'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Net flows</span></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'net_flows'</span>] <span class="op">=</span> (fund_agg[<span class="st">'total_assets'</span>] <span class="op">-</span> </span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>                              fund_agg[<span class="st">'lag_assets'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> fund_agg[<span class="st">'holdings_return'</span>]))</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover (Carhart definition)</span></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'avg_assets'</span>] <span class="op">=</span> (fund_agg[<span class="st">'total_assets'</span>] <span class="op">+</span> fund_agg[<span class="st">'lag_assets'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'turnover'</span>] <span class="op">=</span> (</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> fund_agg[<span class="st">'avg_assets'</span>]</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-94"><a href="#cb14-94" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualize (approximate, since disclosure may be semi-annual)</span></span>
<span id="cb14-95"><a href="#cb14-95" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'periods_per_year'</span>] <span class="op">=</span> <span class="dv">365</span> <span class="op">/</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'report_date'</span>].diff().dt.days</span>
<span id="cb14-96"><a href="#cb14-96" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'turnover_annual'</span>] <span class="op">=</span> fund_agg[<span class="st">'turnover'</span>] <span class="op">*</span> fund_agg[<span class="st">'periods_per_year'</span>].fillna(<span class="dv">2</span>)</span>
<span id="cb14-97"><a href="#cb14-97" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-98"><a href="#cb14-98" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fund analytics computed:"</span>)</span>
<span id="cb14-99"><a href="#cb14-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique funds: </span><span class="sc">{</span>fund_agg[<span class="st">'fund_name'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb14-100"><a href="#cb14-100" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Fund-period observations: </span><span class="sc">{</span><span class="bu">len</span>(fund_agg)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb14-101"><a href="#cb14-101" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Turnover statistics:"</span>)</span>
<span id="cb14-102"><a href="#cb14-102" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(fund_agg[[<span class="st">'turnover'</span>, <span class="st">'turnover_annual'</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb14-103"><a href="#cb14-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-104"><a href="#cb14-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb14-105"><a href="#cb14-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_assets'</span>: fund_assets,</span>
<span id="cb14-106"><a href="#cb14-106" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_trades'</span>: fund_trades,</span>
<span id="cb14-107"><a href="#cb14-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_aggregates'</span>: fund_agg,</span>
<span id="cb14-108"><a href="#cb14-108" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-109"><a href="#cb14-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-110"><a href="#cb14-110" aria-hidden="true" tabindex="-1"></a><span class="co"># fund_analytics = compute_fund_analytics(dc.fund_holdings, prices_q, adj_factors)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="sec-state-ownership" class="level2" data-number="22.9">
<h2 data-number="22.9" class="anchored" data-anchor-id="sec-state-ownership"><span class="header-section-number">22.9</span> State Ownership Analysis</h2>
<section id="equitization-and-the-decline-of-state-ownership" class="level3" data-number="22.9.1">
<h3 data-number="22.9.1" class="anchored" data-anchor-id="equitization-and-the-decline-of-state-ownership"><span class="header-section-number">22.9.1</span> Equitization and the Decline of State Ownership</h3>
<p>Vietnam’s equitization (cổ phần hóa) program has been a defining feature of the market since the early 2000s. The program converts state-owned enterprises into joint-stock companies, typically with the state retaining a controlling or significant minority stake that is then gradually reduced through secondary offerings.</p>
<div id="state-ownership-analysis" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 9: State Ownership Analysis</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_state_ownership(metrics: pd.DataFrame) <span class="op">-&gt;</span> Dict:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Comprehensive analysis of state ownership in Vietnam.</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Aggregate state ownership trends</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    2. SOE population dynamics (entry/exit from SOE classification)</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Equitization event detection (large drops in state ownership)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">    4. State ownership by sector and size</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Governance implications (state as blockholder)</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 1. Aggregate Trends ---</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>).agg(</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        n_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'sum'</span>),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        n_total<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        pct_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>        mean_state_pct<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>        median_state_pct<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'median'</span>),</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market cap share of SOEs</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        soe_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="kw">lambda</span> x: x[df.loc[x.index, <span class="st">'is_soe'</span>] <span class="op">==</span> <span class="dv">1</span>].<span class="bu">sum</span>()),</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>        total_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'sum'</span>),</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">'soe_mktcap_share'</span>] <span class="op">=</span> ts[<span class="st">'soe_mktcap'</span>] <span class="op">/</span> ts[<span class="st">'total_mktcap'</span>]</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 2. Equitization Events ---</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect large drops in state ownership (&gt;10 percentage points)</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    df_sorted <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    df_sorted[<span class="st">'state_change'</span>] <span class="op">=</span> df_sorted.groupby(<span class="st">'ticker'</span>)[<span class="st">'pct_state'</span>].diff()</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    equitization_events <span class="op">=</span> df_sorted[</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        df_sorted[<span class="st">'state_change'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.10</span>  <span class="co"># &gt; 10pp drop</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'pct_state'</span>, <span class="st">'state_change'</span>, <span class="st">'market_cap'</span>]].copy()</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 3. By Sector ---</span></span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'industry_code'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        by_sector <span class="op">=</span> df.groupby(<span class="st">'industry_code'</span>).agg(</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>            mean_state<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>            pct_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>            n_firms<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        ).sort_values(<span class="st">'mean_state'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        by_sector <span class="op">=</span> <span class="va">None</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"State Ownership Analysis:"</span>)</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Current SOE count: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'n_soe'</span>]<span class="sc">:.0f}</span><span class="ss"> / </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'n_total'</span>]<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  SOE market cap share: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'soe_mktcap_share'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean state ownership: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'mean_state_pct'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Equitization events detected: </span><span class="sc">{</span><span class="bu">len</span>(equitization_events)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trends'</span>: ts,</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">'equitization_events'</span>: equitization_events,</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">'by_sector'</span>: by_sector,</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a><span class="co"># state_analysis = analyze_state_ownership(io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-state-ownership" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-fig-height="10" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-state-ownership-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_state_ownership(state_analysis: Dict, metrics: pd.DataFrame):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot state ownership dynamics."""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> state_analysis[<span class="st">'trends'</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Panel A: SOE trends</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'pct_soe'</span>] <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">% o</span><span class="st">f Firms that are SOEs'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#d62728'</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'soe_mktcap_share'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'SOE Market Cap Share (%)'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'mean_state_pct'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Mean State Ownership (%)'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#2ca02c'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Percentage'</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel A: State Ownership and SOE Prevalence Over Time'</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    ax.legend(frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Panel B: Distribution</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use most recent period</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> metrics[metrics[<span class="st">'quarter_end'</span>] <span class="op">==</span> metrics[<span class="st">'quarter_end'</span>].<span class="bu">max</span>()]</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    state_pct <span class="op">=</span> latest[<span class="st">'pct_state'</span>].dropna() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    ax.hist(state_pct, bins<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'#d62728'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'50% (SOE threshold)'</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'State Ownership (%)'</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Number of Companies'</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel B: Distribution of State Ownership (Most Recent Quarter)'</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_state_ownership.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_state_ownership(state_analysis, io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-state-ownership-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;22.4
</figcaption>
</figure>
</div>
<hr>
</section>
</section>
<section id="sec-modern-extensions" class="level2" data-number="22.10">
<h2 data-number="22.10" class="anchored" data-anchor-id="sec-modern-extensions"><span class="header-section-number">22.10</span> Modern Extensions</h2>
<section id="sec-network" class="level3" data-number="22.10.1">
<h3 data-number="22.10.1" class="anchored" data-anchor-id="sec-network"><span class="header-section-number">22.10.1</span> Network Analysis of Co-Ownership</h3>
<p>Institutional co-ownership networks capture how stocks are connected through shared investors. In Vietnam, these networks reveal the influence structure of major domestic conglomerates (e.g., Vingroup, Masan, FPT) and the overlap between foreign fund portfolios.</p>
<div id="coownership-network" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_stock_coownership_network(ownership: pd.DataFrame,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                                         period: <span class="bu">str</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                                         min_overlap: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct a stock-level co-ownership network.</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Two stocks are connected if they share institutional investors.</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Edge weight = number of shared institutional investors.</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">    This is particularly informative in Vietnam where:</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - Foreign fund portfolios concentrate on the same blue-chips</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - Conglomerate cross-holdings create explicit linkages</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    - State ownership creates implicit connections (SCIC holds multiple stocks)</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership data</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">    period : str</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Analysis date</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">    min_overlap : int</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum shared investors to create an edge</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">    dict with network statistics and adjacency data</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> pd.Timestamp(period)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get institutional holders for this period</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'date'</span>] <span class="op">==</span> date) <span class="op">&amp;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL))</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'ticker'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'owner_type'</span>]].copy()</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create bipartite mapping: institution → set of stocks held</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    inst_to_stocks <span class="op">=</span> inst.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'ticker'</span>].<span class="bu">apply</span>(<span class="bu">set</span>).to_dict()</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stock → set of institutions</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    stock_to_inst <span class="op">=</span> inst.groupby(<span class="st">'ticker'</span>)[<span class="st">'shareholder_name'</span>].<span class="bu">apply</span>(<span class="bu">set</span>).to_dict()</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build stock-level network</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    stocks <span class="op">=</span> <span class="bu">list</span>(stock_to_inst.keys())</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> nx.Graph()</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(stocks)):</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(stocks)):</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>            shared <span class="op">=</span> stock_to_inst[stocks[i]] <span class="op">&amp;</span> stock_to_inst[stocks[j]]</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(shared) <span class="op">&gt;=</span> min_overlap:</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>                G.add_edge(stocks[i], stocks[j], weight<span class="op">=</span><span class="bu">len</span>(shared),</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>                           shared_investors<span class="op">=</span><span class="bu">list</span>(shared)[:<span class="dv">5</span>])  <span class="co"># Store sample</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add node attributes</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> stock <span class="kw">in</span> stocks:</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stock <span class="kw">in</span> G.nodes:</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>            G.nodes[stock][<span class="st">'n_inst_holders'</span>] <span class="op">=</span> <span class="bu">len</span>(stock_to_inst[stock])</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Network statistics</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_nodes'</span>: G.number_of_nodes(),</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_edges'</span>: G.number_of_edges(),</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'density'</span>: nx.density(G) <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_clustering'</span>: nx.average_clustering(G, weight<span class="op">=</span><span class="st">'weight'</span>) <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_components'</span>: nx.number_connected_components(G),</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Centrality measures</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>        degree_cent <span class="op">=</span> nx.degree_centrality(G)</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>        stats[<span class="st">'most_connected'</span>] <span class="op">=</span> <span class="bu">sorted</span>(degree_cent.items(), </span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>                                          key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">10</span>]</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>                eigen_cent <span class="op">=</span> nx.eigenvector_centrality_numpy(G, weight<span class="op">=</span><span class="st">'weight'</span>)</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>                stats[<span class="st">'most_central'</span>] <span class="op">=</span> <span class="bu">sorted</span>(eigen_cent.items(),</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>                                                key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">10</span>]</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>                stats[<span class="st">'most_central'</span>] <span class="op">=</span> []</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Co-Ownership Network (</span><span class="sc">{</span>period<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> stats.items():</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'most_connected'</span>, <span class="st">'most_central'</span>]:</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'most_connected'</span> <span class="kw">in</span> stats:</span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Most connected stocks:"</span>)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> stock, cent <span class="kw">in</span> stats[<span class="st">'most_connected'</span>][:<span class="dv">5</span>]:</span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>stock<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>cent<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'graph'</span>: G, <span class="st">'stats'</span>: stats}</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="co"># network = construct_stock_coownership_network(</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, '2024-06-30'</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-ml-classification" class="level3" data-number="22.10.2">
<h3 data-number="22.10.2" class="anchored" data-anchor-id="sec-ml-classification"><span class="header-section-number">22.10.2</span> ML-Enhanced Investor Classification</h3>
<p>Vietnam’s investor classification challenge is distinct from the US. While the US has the Bushee typology based on portfolio turnover and concentration, Vietnam requires classification of both investor <strong>type</strong> (when not explicitly labeled) and investor <strong>behavior</strong> (active vs passive, short-term vs long-term).</p>
<div id="ml-classification-vn" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_investors_vietnam(ownership: pd.DataFrame,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                prices_q: pd.DataFrame,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                n_clusters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    ML-based classification of Vietnamese institutional investors.</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Features adapted for Vietnam's market:</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Portfolio concentration (HHI of holdings)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Holding duration (average time in positions)</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Size preference (average market cap of holdings)</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Sector concentration</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Foreign/domestic indicator</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    6. Trading frequency (inverse of average days between disclosures)</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Expected clusters for Vietnam:</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">    - Passive State Holders: SOE parents, SCIC - low turnover, concentrated</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">    - Active Foreign Funds: Dragon Capital, VinaCapital - moderate turnover</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">    - Domestic Securities Firms: SSI, VNDirect - high turnover, diversified</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">    - Long-Term Foreign: Pension funds, sovereign wealth - low turnover</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with price data</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst.merge(</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'close'</span>, <span class="st">'market_cap'</span>]],</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>],</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'holding_value'</span>] <span class="op">=</span> inst[<span class="st">'shares_held'</span>] <span class="op">*</span> inst[<span class="st">'close'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute features per investor-period</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> inst.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'date'</span>]).agg(</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        total_value<span class="op">=</span>(<span class="st">'holding_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        hhi_portfolio<span class="op">=</span>(<span class="st">'holding_value'</span>, </span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">lambda</span> x: ((x<span class="op">/</span>x.<span class="bu">sum</span>())<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>() <span class="cf">if</span> x.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan),</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        avg_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        is_foreign<span class="op">=</span>(<span class="st">'owner_type'</span>, </span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>                     <span class="kw">lambda</span> x: (x <span class="op">==</span> OwnershipType.FOREIGN_INST).<span class="bu">any</span>().astype(<span class="bu">int</span>)),</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        is_state<span class="op">=</span>(<span class="st">'owner_type'</span>, </span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">lambda</span> x: (x <span class="op">==</span> OwnershipType.STATE).<span class="bu">any</span>().astype(<span class="bu">int</span>)),</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average across all periods per investor</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>    investor_features <span class="op">=</span> features.groupby(<span class="st">'shareholder_name'</span>).agg(</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>        avg_n_stocks<span class="op">=</span>(<span class="st">'n_stocks'</span>, <span class="st">'mean'</span>),</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>        avg_hhi<span class="op">=</span>(<span class="st">'hhi_portfolio'</span>, <span class="st">'mean'</span>),</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>        avg_mktcap<span class="op">=</span>(<span class="st">'avg_mktcap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        avg_total_value<span class="op">=</span>(<span class="st">'total_value'</span>, <span class="st">'mean'</span>),</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>        is_foreign<span class="op">=</span>(<span class="st">'is_foreign'</span>, <span class="st">'max'</span>),</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>        is_state<span class="op">=</span>(<span class="st">'is_state'</span>, <span class="st">'max'</span>),</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>        n_periods<span class="op">=</span>(<span class="st">'date'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    ).dropna()</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feature matrix</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [<span class="st">'avg_n_stocks'</span>, <span class="st">'avg_hhi'</span>, <span class="st">'avg_mktcap'</span>, <span class="st">'avg_total_value'</span>]</span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> investor_features[feature_cols].copy()</span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log-transform</span></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> feature_cols:</span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a>        X[col] <span class="op">=</span> np.log1p(X[col].clip(lower<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add binary features</span></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'is_foreign'</span>] <span class="op">=</span> investor_features[<span class="st">'is_foreign'</span>]</span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'is_state'</span>] <span class="op">=</span> investor_features[<span class="st">'is_state'</span>]</span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># K-means</span></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a>    kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>n_clusters, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a>    investor_features[<span class="st">'cluster'</span>] <span class="op">=</span> kmeans.fit_predict(X_scaled)</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Label clusters</span></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a>    cluster_profiles <span class="op">=</span> investor_features.groupby(<span class="st">'cluster'</span>).agg({</span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_n_stocks'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_hhi'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_total_value'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_foreign'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_state'</span>: <span class="st">'mean'</span>,</span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shareholder_name'</span>: <span class="st">'count'</span>,</span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a>    }).rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_investors'</span>})</span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Investor Clusters:"</span>)</span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cluster_profiles.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> investor_features</span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a><span class="co"># investor_classes = classify_investors_vietnam(ownership_classified, prices_q)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-event-study" class="level3" data-number="22.10.3">
<h3 data-number="22.10.3" class="anchored" data-anchor-id="sec-event-study"><span class="header-section-number">22.10.3</span> Event Study: Ownership Disclosure Shocks</h3>
<p>Vietnam’s threshold-based major shareholder disclosure creates natural events for studying the price impact of ownership changes.</p>
<div id="event-study" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ownership_event_study(major_shareholders: pd.DataFrame,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                           prices: pd.DataFrame,</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                           event_window: Tuple[<span class="bu">int</span>, <span class="bu">int</span>] <span class="op">=</span> (<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>),</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                           estimation_window: <span class="bu">int</span> <span class="op">=</span> <span class="dv">120</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Event study of ownership disclosure announcements.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam requires major shareholders (≥5%) to disclose within 7 </span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    business days of crossing ownership thresholds. These disclosures </span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    can be informationally significant, especially:</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Foreign fund accumulation (signal of quality)</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    2. State divestiture (equitization signal)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Insider purchases (management confidence signal)</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses market model for expected returns:</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    E[R_i,t] = α_i + β_i × R_m,t</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">    major_shareholders : pd.DataFrame</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Disclosure events from DataCore.vn</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">    prices : pd.DataFrame</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily stock prices</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">    event_window : tuple</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">        (pre_event_days, post_event_days)</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a><span class="co">    estimation_window : int</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="co">        Days before event window for market model estimation</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> major_shareholders.copy()</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> events.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify significant ownership changes</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    events[<span class="st">'ownership_change'</span>] <span class="op">=</span> events.groupby(</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'ticker'</span>, <span class="st">'shareholder_name'</span>]</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'ownership_pct'</span>].diff()</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    significant_events <span class="op">=</span> events[</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        events[<span class="st">'ownership_change'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">0.01</span>  <span class="co"># &gt; 1 percentage point</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    significant_events[<span class="st">'event_type'</span>] <span class="op">=</span> np.where(</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        significant_events[<span class="st">'ownership_change'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'accumulation'</span>, <span class="st">'divestiture'</span></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with daily prices</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    prices_daily <span class="op">=</span> prices[[<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'ret'</span>]].copy()</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    prices_daily <span class="op">=</span> prices_daily.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VN-Index as market return (ticker code depends on data provider)</span></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VNINDEX'</span> <span class="kw">in</span> prices_daily[<span class="st">'ticker'</span>].values:</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> prices_daily[prices_daily[<span class="st">'ticker'</span>] <span class="op">==</span> <span class="st">'VNINDEX'</span>][[<span class="st">'date'</span>, <span class="st">'ret'</span>]].copy()</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> market_ret.rename(columns<span class="op">=</span>{<span class="st">'ret'</span>: <span class="st">'mkt_ret'</span>})</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use equal-weighted market return as proxy</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> (prices_daily.groupby(<span class="st">'date'</span>)[<span class="st">'ret'</span>]</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>                                  .mean()</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>                                  .reset_index()</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>                                  .rename(columns<span class="op">=</span>{<span class="st">'ret'</span>: <span class="st">'mkt_ret'</span>}))</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each event, compute abnormal returns</span></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    pre, post <span class="op">=</span> event_window</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> significant_events.iterrows():</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> event[<span class="st">'ticker'</span>]</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>        event_date <span class="op">=</span> event[<span class="st">'date'</span>]</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get stock returns around the event</span></span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> prices_daily[prices_daily[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> stock_ret.merge(market_ret, on<span class="op">=</span><span class="st">'date'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> stock_ret.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find event date index</span></span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> stock_ret[stock_ret[<span class="st">'date'</span>] <span class="op">&gt;=</span> event_date].index</span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> event_idx[<span class="dv">0</span>]</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimation window</span></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>        est_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, event_idx <span class="op">-</span> estimation_window <span class="op">+</span> pre)</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        est_end <span class="op">=</span> event_idx <span class="op">+</span> pre</span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>        est_data <span class="op">=</span> stock_ret.iloc[est_start:est_end].dropna(subset<span class="op">=</span>[<span class="st">'ret'</span>, <span class="st">'mkt_ret'</span>])</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(est_data) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market model</span></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(est_data[<span class="st">'mkt_ret'</span>])</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> est_data[<span class="st">'ret'</span>]</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb19-91"><a href="#cb19-91" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb19-92"><a href="#cb19-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb19-93"><a href="#cb19-93" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb19-94"><a href="#cb19-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-95"><a href="#cb19-95" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event window abnormal returns</span></span>
<span id="cb19-96"><a href="#cb19-96" aria-hidden="true" tabindex="-1"></a>        ew_start <span class="op">=</span> event_idx <span class="op">+</span> pre</span>
<span id="cb19-97"><a href="#cb19-97" aria-hidden="true" tabindex="-1"></a>        ew_end <span class="op">=</span> <span class="bu">min</span>(event_idx <span class="op">+</span> post <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(stock_ret))</span>
<span id="cb19-98"><a href="#cb19-98" aria-hidden="true" tabindex="-1"></a>        event_data <span class="op">=</span> stock_ret.iloc[ew_start:ew_end].copy()</span>
<span id="cb19-99"><a href="#cb19-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-100"><a href="#cb19-100" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb19-101"><a href="#cb19-101" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb19-102"><a href="#cb19-102" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-103"><a href="#cb19-103" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'expected_ret'</span>] <span class="op">=</span> (model.params[<span class="st">'const'</span>] <span class="op">+</span> </span>
<span id="cb19-104"><a href="#cb19-104" aria-hidden="true" tabindex="-1"></a>                                       model.params[<span class="st">'mkt_ret'</span>] <span class="op">*</span> event_data[<span class="st">'mkt_ret'</span>])</span>
<span id="cb19-105"><a href="#cb19-105" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'abnormal_ret'</span>] <span class="op">=</span> event_data[<span class="st">'ret'</span>] <span class="op">-</span> event_data[<span class="st">'expected_ret'</span>]</span>
<span id="cb19-106"><a href="#cb19-106" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'car'</span>] <span class="op">=</span> event_data[<span class="st">'abnormal_ret'</span>].cumsum()</span>
<span id="cb19-107"><a href="#cb19-107" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_day'</span>] <span class="op">=</span> <span class="bu">range</span>(pre, pre <span class="op">+</span> <span class="bu">len</span>(event_data))</span>
<span id="cb19-108"><a href="#cb19-108" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'ticker'</span>] <span class="op">=</span> ticker</span>
<span id="cb19-109"><a href="#cb19-109" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_date'</span>] <span class="op">=</span> event_date</span>
<span id="cb19-110"><a href="#cb19-110" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_type'</span>] <span class="op">=</span> event[<span class="st">'event_type'</span>]</span>
<span id="cb19-111"><a href="#cb19-111" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'ownership_change'</span>] <span class="op">=</span> event[<span class="st">'ownership_change'</span>]</span>
<span id="cb19-112"><a href="#cb19-112" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'shareholder_name'</span>] <span class="op">=</span> event[<span class="st">'shareholder_name'</span>]</span>
<span id="cb19-113"><a href="#cb19-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-114"><a href="#cb19-114" aria-hidden="true" tabindex="-1"></a>        results.append(event_data)</span>
<span id="cb19-115"><a href="#cb19-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-116"><a href="#cb19-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb19-117"><a href="#cb19-117" aria-hidden="true" tabindex="-1"></a>        all_results <span class="op">=</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-118"><a href="#cb19-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-119"><a href="#cb19-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Average CARs by event type</span></span>
<span id="cb19-120"><a href="#cb19-120" aria-hidden="true" tabindex="-1"></a>        avg_car <span class="op">=</span> (all_results.groupby([<span class="st">'event_type'</span>, <span class="st">'event_day'</span>])[<span class="st">'car'</span>]</span>
<span id="cb19-121"><a href="#cb19-121" aria-hidden="true" tabindex="-1"></a>                              .agg([<span class="st">'mean'</span>, <span class="st">'std'</span>, <span class="st">'count'</span>])</span>
<span id="cb19-122"><a href="#cb19-122" aria-hidden="true" tabindex="-1"></a>                              .reset_index())</span>
<span id="cb19-123"><a href="#cb19-123" aria-hidden="true" tabindex="-1"></a>        avg_car[<span class="st">'t_stat'</span>] <span class="op">=</span> avg_car[<span class="st">'mean'</span>] <span class="op">/</span> (avg_car[<span class="st">'std'</span>] <span class="op">/</span> np.sqrt(avg_car[<span class="st">'count'</span>]))</span>
<span id="cb19-124"><a href="#cb19-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-125"><a href="#cb19-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Event Study Results:"</span>)</span>
<span id="cb19-126"><a href="#cb19-126" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Total events: </span><span class="sc">{</span>significant_events[<span class="st">'event_type'</span>]<span class="sc">.</span>value_counts()<span class="sc">.</span>to_string()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-127"><a href="#cb19-127" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-128"><a href="#cb19-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># CAR at event day 0, +5, +10, +20</span></span>
<span id="cb19-129"><a href="#cb19-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> et <span class="kw">in</span> [<span class="st">'accumulation'</span>, <span class="st">'divestiture'</span>]:</span>
<span id="cb19-130"><a href="#cb19-130" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  </span><span class="sc">{</span>et<span class="sc">.</span>title()<span class="sc">}</span><span class="ss"> Events:"</span>)</span>
<span id="cb19-131"><a href="#cb19-131" aria-hidden="true" tabindex="-1"></a>            subset <span class="op">=</span> avg_car[avg_car[<span class="st">'event_type'</span>] <span class="op">==</span> et]</span>
<span id="cb19-132"><a href="#cb19-132" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> day <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>]:</span>
<span id="cb19-133"><a href="#cb19-133" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> subset[subset[<span class="st">'event_day'</span>] <span class="op">==</span> day]</span>
<span id="cb19-134"><a href="#cb19-134" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(row) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb19-135"><a href="#cb19-135" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    CAR(</span><span class="sc">{</span>day<span class="sc">:+d}</span><span class="ss">): </span><span class="sc">{</span>row<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'mean'</span>]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb19-136"><a href="#cb19-136" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f"(t=</span><span class="sc">{</span>row<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb19-137"><a href="#cb19-137" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-138"><a href="#cb19-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_results</span>
<span id="cb19-139"><a href="#cb19-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-140"><a href="#cb19-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb19-141"><a href="#cb19-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-142"><a href="#cb19-142" aria-hidden="true" tabindex="-1"></a><span class="co"># event_results = ownership_event_study(dc.major_shareholders, dc.prices)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<hr>
</section>
</section>
<section id="sec-empirical-applications" class="level2" data-number="22.11">
<h2 data-number="22.11" class="anchored" data-anchor-id="sec-empirical-applications"><span class="header-section-number">22.11</span> Empirical Applications</h2>
<section id="application-1-foreign-ownership-and-stock-returns-in-vietnam" class="level3" data-number="22.11.1">
<h3 data-number="22.11.1" class="anchored" data-anchor-id="application-1-foreign-ownership-and-stock-returns-in-vietnam"><span class="header-section-number">22.11.1</span> Application 1: Foreign Ownership and Stock Returns in Vietnam</h3>
<p>Does foreign institutional ownership predict returns in Vietnam? <span class="citation" data-cites="huang2023factors">Huang, Liu, and Shu (<a href="references.html#ref-huang2023factors" role="doc-biblioref">2023</a>)</span> find evidence consistent with the information advantage hypothesis.</p>
<div id="foreign-io-returns" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_foreign_io_returns(metrics: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Test whether changes in foreign institutional ownership predict </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    future stock returns in Vietnam.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Methodology:</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Sort stocks into quintiles by change in foreign IO</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Compute equal-weighted and VN-Index-adjusted returns</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Report portfolio returns and long-short spread</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    This adapts the Chen, Hong, and Stein (2002) breadth test </span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">    specifically for Vietnam's foreign ownership component.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change in foreign IO</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'delta_foreign'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'pct_foreign_total'</span>].diff()</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward quarterly return</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'fwd_ret'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'ret'</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop missing</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'delta_foreign'</span>, <span class="st">'fwd_ret'</span>])</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quintile portfolios each quarter</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'foreign_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'delta_foreign'</span>].transform(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio returns</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> (df.groupby([<span class="st">'quarter_end'</span>, <span class="st">'foreign_quintile'</span>])[<span class="st">'fwd_ret'</span>]</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>                  .mean()</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>                  .reset_index())</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    port_wide <span class="op">=</span> port_ret.pivot(index<span class="op">=</span><span class="st">'quarter_end'</span>, columns<span class="op">=</span><span class="st">'foreign_quintile'</span>, </span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>                                values<span class="op">=</span><span class="st">'fwd_ret'</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    port_wide[<span class="st">'LS'</span>] <span class="op">=</span> port_wide[<span class="dv">5</span>] <span class="op">-</span> port_wide[<span class="dv">1</span>]</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test significance</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="st">'LS'</span>]:</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> port_wide[q].dropna()</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> data.mean()</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (data.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(data)))</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        results[q] <span class="op">=</span> {</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Mean Return (%)'</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-statistic'</span>: t_stat,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'N quarters'</span>: <span class="bu">len</span>(data),</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results).T</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    results_df.index.name <span class="op">=</span> <span class="st">'ΔForeign IO Quintile'</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Foreign Ownership Change and Future Returns (Vietnam)"</span>)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(results_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="co"># foreign_return_results = test_foreign_io_returns(io_metrics)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="application-2-state-divestiture-and-value-creation" class="level3" data-number="22.11.2">
<h3 data-number="22.11.2" class="anchored" data-anchor-id="application-2-state-divestiture-and-value-creation"><span class="header-section-number">22.11.2</span> Application 2: State Divestiture and Value Creation</h3>
<div id="equitization-value" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_equitization_value(metrics: pd.DataFrame, </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                state_analysis: Dict) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Test whether reductions in state ownership are associated with </span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">    subsequent value creation (higher returns, improved governance).</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Hypothesis: State divestiture reduces agency costs, improves </span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co">    operational efficiency, and attracts institutional investors,</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">    leading to positive abnormal returns.</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses a difference-in-differences approach:</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Treatment: Firms experiencing &gt;10pp drop in state ownership</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Control: Matched firms with stable state ownership</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> state_analysis[<span class="st">'equitization_events'</span>]</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(events) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No equitization events detected."</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get treated firms and their event quarters</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    treated <span class="op">=</span> events[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>]].drop_duplicates()</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    treated[<span class="st">'treated'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with metrics</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(treated, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'treated'</span>] <span class="op">=</span> df[<span class="st">'treated'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre/post comparison for treated firms</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    treated_tickers <span class="op">=</span> treated[<span class="st">'ticker'</span>].unique()</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker <span class="kw">in</span> treated_tickers:</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        firm <span class="op">=</span> df[df[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].sort_values(<span class="st">'quarter_end'</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        event_row <span class="op">=</span> firm[firm[<span class="st">'treated'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_row) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>        event_q <span class="op">=</span> event_row.iloc[<span class="dv">0</span>][<span class="st">'quarter_end'</span>]</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-event (4 quarters before)</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        pre <span class="op">=</span> firm[firm[<span class="st">'quarter_end'</span>] <span class="op">&lt;</span> event_q].tail(<span class="dv">4</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-event (4 quarters after)</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>        post <span class="op">=</span> firm[firm[<span class="st">'quarter_end'</span>] <span class="op">&gt;</span> event_q].head(<span class="dv">4</span>)</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(pre) <span class="op">&lt;</span> <span class="dv">2</span> <span class="kw">or</span> <span class="bu">len</span>(post) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">'event_quarter'</span>: event_q,</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state_pct_pre'</span>: pre[<span class="st">'pct_state'</span>].mean(),</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state_pct_post'</span>: post[<span class="st">'pct_state'</span>].mean(),</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_pct_pre'</span>: pre[<span class="st">'pct_foreign_total'</span>].mean(),</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_pct_post'</span>: post[<span class="st">'pct_foreign_total'</span>].mean(),</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_inst_pre'</span>: pre[<span class="st">'n_inst_owners'</span>].mean(),</span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_inst_post'</span>: post[<span class="st">'n_inst_owners'</span>].mean(),</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ret_pre'</span>: pre[<span class="st">'ret'</span>].mean(),</span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ret_post'</span>: post[<span class="st">'ret'</span>].mean(),</span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>        results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Paired t-tests</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Equitization Value Analysis"</span>)</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> [<span class="st">'state_pct'</span>, <span class="st">'foreign_pct'</span>, <span class="st">'n_inst'</span>, <span class="st">'ret'</span>]:</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>            pre_col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_pre'</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>            post_col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_post'</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">=</span> results_df[post_col] <span class="op">-</span> results_df[pre_col]</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            t_stat, p_val <span class="op">=</span> stats.ttest_1samp(diff.dropna(), <span class="dv">0</span>)</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Δ</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>diff<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss"> (t=</span><span class="sc">{</span>t_stat<span class="sc">:.2f}</span><span class="ss">, p=</span><span class="sc">{</span>p_val<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results_df</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a><span class="co"># equitization_results = analyze_equitization_value(io_metrics, state_analysis)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="application-3-institutional-herding-in-vietnam" class="level3" data-number="22.11.3">
<h3 data-number="22.11.3" class="anchored" data-anchor-id="application-3-institutional-herding-in-vietnam"><span class="header-section-number">22.11.3</span> Application 3: Institutional Herding in Vietnam</h3>
<div id="herding-vn" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_herding_vietnam(trades: pd.DataFrame,</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                             owner_types: Optional[List[<span class="bu">str</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the Lakonishok, Shleifer, and Vishny (1992) herding measure</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="co">    adapted for the Vietnamese market.</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Can be computed separately for:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co">    - All institutional investors</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - Foreign institutions only</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - Domestic institutions only</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="co">    The herding measure captures whether institutions systematically</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">    trade in the same direction beyond what chance would predict.</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.stats <span class="im">import</span> binom</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> trades.copy()</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> owner_types:</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> t[t[<span class="st">'owner_type'</span>].isin(owner_types)]</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    t[<span class="st">'is_buy'</span>] <span class="op">=</span> (t[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each stock-period</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> t.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>]).agg(</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        n_traders<span class="op">=</span>(<span class="st">'shareholder_name'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>        n_buyers<span class="op">=</span>(<span class="st">'is_buy'</span>, <span class="st">'sum'</span>),</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Minimum traders threshold</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> stock_trades[stock_trades[<span class="st">'n_traders'</span>] <span class="op">&gt;=</span> <span class="dv">3</span>]</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'p_buy'</span>] <span class="op">=</span> stock_trades[<span class="st">'n_buyers'</span>] <span class="op">/</span> stock_trades[<span class="st">'n_traders'</span>]</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected proportion per period</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>    E_p <span class="op">=</span> stock_trades.groupby(<span class="st">'date'</span>).<span class="bu">apply</span>(</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: g[<span class="st">'n_buyers'</span>].<span class="bu">sum</span>() <span class="op">/</span> g[<span class="st">'n_traders'</span>].<span class="bu">sum</span>()</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>    ).reset_index(name<span class="op">=</span><span class="st">'E_p'</span>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> stock_trades.merge(E_p, on<span class="op">=</span><span class="st">'date'</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjustment factor</span></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expected_abs_dev(n, p):</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> np.arange(<span class="dv">0</span>, n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> binom.pmf(k, n, p)</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(probs <span class="op">*</span> np.<span class="bu">abs</span>(k <span class="op">/</span> n <span class="op">-</span> p))</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'adj_factor'</span>] <span class="op">=</span> stock_trades.<span class="bu">apply</span>(</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: expected_abs_dev(<span class="bu">int</span>(r[<span class="st">'n_traders'</span>]), r[<span class="st">'E_p'</span>]), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'hm'</span>] <span class="op">=</span> (np.<span class="bu">abs</span>(stock_trades[<span class="st">'p_buy'</span>] <span class="op">-</span> stock_trades[<span class="st">'E_p'</span>]) <span class="op">-</span> </span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>                           stock_trades[<span class="st">'adj_factor'</span>])</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'buy_herd'</span>] <span class="op">=</span> np.where(</span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        stock_trades[<span class="st">'p_buy'</span>] <span class="op">&gt;</span> stock_trades[<span class="st">'E_p'</span>], stock_trades[<span class="st">'hm'</span>], np.nan</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'sell_herd'</span>] <span class="op">=</span> np.where(</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>        stock_trades[<span class="st">'p_buy'</span>] <span class="op">&lt;</span> stock_trades[<span class="st">'E_p'</span>], stock_trades[<span class="st">'hm'</span>], np.nan</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time series of herding</span></span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>    ts_herding <span class="op">=</span> stock_trades.groupby(<span class="st">'date'</span>).agg(</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>        mean_hm<span class="op">=</span>(<span class="st">'hm'</span>, <span class="st">'mean'</span>),</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>        mean_buy_herd<span class="op">=</span>(<span class="st">'buy_herd'</span>, <span class="st">'mean'</span>),</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>        mean_sell_herd<span class="op">=</span>(<span class="st">'sell_herd'</span>, <span class="st">'mean'</span>),</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>        pct_herding<span class="op">=</span>(<span class="st">'hm'</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean()),</span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Herding Analysis (</span><span class="sc">{</span>owner_types <span class="kw">or</span> <span class="st">'All Institutions'</span><span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean HM: </span><span class="sc">{</span>stock_trades[<span class="st">'hm'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Buy Herding: </span><span class="sc">{</span>stock_trades[<span class="st">'buy_herd'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Sell Herding: </span><span class="sc">{</span>stock_trades[<span class="st">'sell_herd'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  % stocks with herding: </span><span class="sc">{</span>(stock_trades[<span class="st">'hm'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-76"><a href="#cb22-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stock_trades, ts_herding</span>
<span id="cb22-77"><a href="#cb22-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-78"><a href="#cb22-78" aria-hidden="true" tabindex="-1"></a><span class="co"># herding_all, herding_ts = compute_herding_vietnam(trades)</span></span>
<span id="cb22-79"><a href="#cb22-79" aria-hidden="true" tabindex="-1"></a><span class="co"># herding_foreign, _ = compute_herding_vietnam(</span></span>
<span id="cb22-80"><a href="#cb22-80" aria-hidden="true" tabindex="-1"></a><span class="co">#     trades, owner_types=[OwnershipType.FOREIGN_INST]</span></span>
<span id="cb22-81"><a href="#cb22-81" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-conclusion" class="level2" data-number="22.12">
<h2 data-number="22.12" class="anchored" data-anchor-id="sec-conclusion"><span class="header-section-number">22.12</span> Conclusion and Practical Recommendations</h2>
<section id="summary-of-measures" class="level3" data-number="22.12.1">
<h3 data-number="22.12.1" class="anchored" data-anchor-id="summary-of-measures"><span class="header-section-number">22.12.1</span> Summary of Measures</h3>
<p><a href="#tbl-summary-all" class="quarto-xref">Table&nbsp;<span>22.5</span></a> summarizes all institutional ownership measures developed in this chapter for the Vietnamese market.</p>
<div id="tbl-summary-all" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.5: Summary of All Ownership Measures for Vietnam
</figcaption>
<div aria-describedby="tbl-summary-all-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 24%">
<col style="width: 26%">
<col style="width: 24%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Measure</th>
<th style="text-align: left;">Definition</th>
<th style="text-align: left;">Key Adaptation for Vietnam</th>
<th style="text-align: left;">Python Function</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">IO Ratio</td>
<td style="text-align: left;">Inst. shares / TSO</td>
<td style="text-align: left;">Decomposed into state, foreign, domestic</td>
<td style="text-align: left;"><code>compute_ownership_decomposition()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">HHI Concentration</td>
<td style="text-align: left;"><span class="math inline">\(\sum w_j^2\)</span></td>
<td style="text-align: left;">Separate HHI for total, non-state, foreign</td>
<td style="text-align: left;"><code>compute_io_metrics_vietnam()</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">ΔBreadth</td>
<td style="text-align: left;">Lehavy-Sloan adjusted</td>
<td style="text-align: left;">Applied to irregular disclosure intervals</td>
<td style="text-align: left;"><code>compute_io_metrics_vietnam()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">FOL Utilization</td>
<td style="text-align: left;">Foreign % / FOL limit</td>
<td style="text-align: left;">Vietnam-specific; no US equivalent</td>
<td style="text-align: left;"><code>FOLAnalyzer</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">FOL Premium</td>
<td style="text-align: left;">Price impact of FOL proximity</td>
<td style="text-align: left;">Cross-sectional regression approach</td>
<td style="text-align: left;"><code>FOLAnalyzer.estimate_fol_premium()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Trades</td>
<td style="text-align: left;">ΔShares (corp-action adjusted)</td>
<td style="text-align: left;">Critical: adjust for stock dividends</td>
<td style="text-align: left;"><code>derive_trades_vectorized_vietnam()</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fund Turnover</td>
<td style="text-align: left;">min(B,S)/avg(A)</td>
<td style="text-align: left;">Semi-annual frequency; annualized</td>
<td style="text-align: left;"><code>compute_fund_analytics()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">SOE Status</td>
<td style="text-align: left;">State ownership &gt; 50%</td>
<td style="text-align: left;">Tracks equitization program</td>
<td style="text-align: left;"><code>analyze_state_ownership()</code></td>
</tr>
<tr class="odd">
<td style="text-align: left;">LSV Herding</td>
<td style="text-align: left;"><span class="math inline">\(|p - E[p]| - E[|p - E[p]|]\)</span></td>
<td style="text-align: left;">Separate foreign vs domestic herding</td>
<td style="text-align: left;"><code>compute_herding_vietnam()</code></td>
</tr>
<tr class="even">
<td style="text-align: left;">Co-Ownership Network</td>
<td style="text-align: left;">Shared institutional holders</td>
<td style="text-align: left;">Reveals conglomerate linkages</td>
<td style="text-align: left;"><code>construct_stock_coownership_network()</code></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="data-quality-checklist-for-vietnam" class="level3" data-number="22.12.2">
<h3 data-number="22.12.2" class="anchored" data-anchor-id="data-quality-checklist-for-vietnam"><span class="header-section-number">22.12.2</span> Data Quality Checklist for Vietnam</h3>
<div class="callout callout-style-default callout-tip callout-titled" title="Vietnam Data Quality Checklist">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Vietnam Data Quality Checklist
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><label><input type="checkbox"><strong>Corporate actions:</strong> Have you built and applied adjustment factors for ALL stock dividends, bonus shares, splits, and rights issues?</label></li>
<li><label><input type="checkbox"><strong>Shareholder classification:</strong> Have you verified the owner type classification (state vs foreign vs domestic institutional vs individual)?</label></li>
<li><label><input type="checkbox"><strong>FOL limits:</strong> Are sector-specific FOL limits correctly assigned (30% for banks, 49% standard, unlimited for some sectors)?</label></li>
<li><label><input type="checkbox"><strong>Disclosure dates:</strong> Are you using the actual disclosure date (not the record date or ex-date) for ownership snapshots?</label></li>
<li><label><input type="checkbox"><strong>Treasury shares:</strong> Are treasury shares excluded from ownership ratio denominators?</label></li>
<li><label><input type="checkbox"><strong>UPCOM coverage:</strong> Does your sample include or exclude UPCOM stocks (which have weaker disclosure requirements)?</label></li>
<li><label><input type="checkbox"><strong>Cross-listings:</strong> Are you handling NVDR (Non-Voting Depository Receipts) if applicable after market reforms?</label></li>
<li><label><input type="checkbox"><strong>Name consistency:</strong> Are shareholder names standardized across disclosure periods (Vietnamese names can have multiple romanization forms)?</label></li>
<li><label><input type="checkbox"><strong>Trade adjustment:</strong> When deriving trades between periods, have you adjusted previous shares for ALL intervening corporate actions?</label></li>
<li><label><input type="checkbox"><strong>Fund mandate changes:</strong> For fund analytics, have you accounted for fund mergers, closures, and mandate changes that affect time-series continuity?</label></li>
</ol>
</div>
</div>
</section>
<section id="comparison-with-us-framework" class="level3" data-number="22.12.3">
<h3 data-number="22.12.3" class="anchored" data-anchor-id="comparison-with-us-framework"><span class="header-section-number">22.12.3</span> Comparison with US Framework</h3>
<div id="tbl-us-vn-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-us-vn-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;22.6: US vs Vietnam Institutional Ownership Framework Comparison
</figcaption>
<div aria-describedby="tbl-us-vn-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 26%">
<col style="width: 29%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Dimension</th>
<th style="text-align: left;">US (WRDS/13F)</th>
<th style="text-align: left;">Vietnam (DataCore.vn)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><strong>Disclosure</strong></td>
<td style="text-align: left;">Quarterly 13F (mandatory)</td>
<td style="text-align: left;">Annual reports + event-driven</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Coverage</strong></td>
<td style="text-align: left;">Institutions &gt; $100M AUM</td>
<td style="text-align: left;">All shareholders in annual reports</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Ownership observed</strong></td>
<td style="text-align: left;">Long positions only</td>
<td style="text-align: left;">Complete decomposition</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>IO can exceed 100%</strong></td>
<td style="text-align: left;">Yes (short selling)</td>
<td style="text-align: left;">No (by construction)</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Permanent ID</strong></td>
<td style="text-align: left;">CRSP PERMNO</td>
<td style="text-align: left;">Ticker (with manual tracking of changes)</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Adjustment factors</strong></td>
<td style="text-align: left;">CRSP cfacshr</td>
<td style="text-align: left;">Must build from corporate actions</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Investor classification</strong></td>
<td style="text-align: left;">LSEG typecode / Bushee</td>
<td style="text-align: left;">State/Foreign/Domestic/Individual</td>
</tr>
<tr class="even">
<td style="text-align: left;"><strong>Short selling</strong></td>
<td style="text-align: left;">Not in 13F; exists in market</td>
<td style="text-align: left;">Very limited; not a concern</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><strong>Unique features</strong></td>
<td style="text-align: left;">—</td>
<td style="text-align: left;">FOL, SOE ownership, stock dividend frequency</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-bao2024institutional" class="csl-entry" role="listitem">
Bao Dinh, Ngoc, and Van Nguyen Hong Tran. 2024. <span>“Institutional Ownership and Stock Liquidity: Evidence from an Emerging Market.”</span> <em>SAGE Open</em> 14 (1): 21582440241239116.
</div>
<div id="ref-ben2013hedge" class="csl-entry" role="listitem">
Ben-David, ITZHAK, Francesco Franzoni, Augustin Landier, and Rabih Moussawi. 2013. <span>“Do Hedge Funds Manipulate Stock Prices?”</span> <em>The Journal of Finance</em> 68 (6): 2383–2434.
</div>
<div id="ref-carhart1997persistence" class="csl-entry" role="listitem">
Carhart, Mark M. 1997. <span>“On Persistence in Mutual Fund Performance.”</span> <em>The Journal of Finance</em> 52 (1): 57–82.
</div>
<div id="ref-chen2002breadth" class="csl-entry" role="listitem">
Chen, Joseph, Harrison Hong, and Jeremy C Stein. 2002. <span>“Breadth of Ownership and Stock Returns.”</span> <em>Journal of Financial Economics</em> 66 (2-3): 171–205.
</div>
<div id="ref-huang2023factors" class="csl-entry" role="listitem">
Huang, Xiangqian, Clark Liu, and Tao Shu. 2023. <span>“Factors and Anomalies in the Vietnamese Stock Market.”</span> <em>Pacific-Basin Finance Journal</em> 82: 102176.
</div>
<div id="ref-lehavy2008investor" class="csl-entry" role="listitem">
Lehavy, Reuven, and Richard G Sloan. 2008. <span>“Investor Recognition and Stock Returns.”</span> <em>Review of Accounting Studies</em> 13 (2): 327–61.
</div>
<div id="ref-vo2015foreign" class="csl-entry" role="listitem">
Vo, Xuan Vinh. 2015. <span>“Foreign Ownership and Stock Return Volatility–Evidence from Vietnam.”</span> <em>Journal of Multinational Financial Management</em> 30: 101–9.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./39_divop.html" class="pagination-link" aria-label="Measuring Divergence of Investor Opinion">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./52_institutional_trade_flow.html" class="pagination-link" aria-label="Institutional Trades, Flows, and Turnover Ratios">
        <span class="nav-page-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Institutional Ownership Analytics in Vietnam</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Global Setup and Configuration</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.ticker <span class="im">as</span> mticker</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.spatial.distance <span class="im">import</span> pdist, squareform</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Optional, Union, Dict, List, Tuple</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting configuration — academic style</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.family'</span>: <span class="st">'serif'</span>,</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.serif'</span>: [<span class="st">'Times New Roman'</span>, <span class="st">'DejaVu Serif'</span>],</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.titlesize'</span>: <span class="dv">13</span>,</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.labelsize'</span>: <span class="dv">11</span>,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'xtick.labelsize'</span>: <span class="dv">10</span>,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ytick.labelsize'</span>: <span class="dv">10</span>,</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'legend.fontsize'</span>: <span class="dv">10</span>,</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.titlesize'</span>: <span class="dv">14</span>,</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span>,</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.grid'</span>: <span class="va">True</span>,</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grid.alpha'</span>: <span class="fl">0.3</span>,</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'grid.linestyle'</span>: <span class="st">'--'</span>,</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Color palette for ownership types</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>OWNER_COLORS <span class="op">=</span> {</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'State'</span>: <span class="st">'#d62728'</span>,</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Foreign Institutional'</span>: <span class="st">'#1f77b4'</span>,</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Domestic Institutional'</span>: <span class="st">'#2ca02c'</span>,</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Individual'</span>: <span class="st">'#ff7f0e'</span>,</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Treasury'</span>: <span class="st">'#9467bd'</span>,</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Total Institutional'</span>: <span class="st">'#333333'</span>,</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Exchange colors</span></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>EXCHANGE_COLORS <span class="op">=</span> {<span class="st">'HOSE'</span>: <span class="st">'#1f77b4'</span>, <span class="st">'HNX'</span>: <span class="st">'#ff7f0e'</span>, <span class="st">'UPCOM'</span>: <span class="st">'#2ca02c'</span>}</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.max_columns'</span>, <span class="dv">20</span>)</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.width'</span>, <span class="dv">120</span>)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">'display.float_format'</span>, <span class="st">'</span><span class="sc">{:.4f}</span><span class="st">'</span>.<span class="bu">format</span>)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="fu">## Institutional Ownership in Vietnam: A Distinct Landscape</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>Vietnam's equity market presents a fundamentally different institutional ownership landscape from the mature markets of the US, Europe, or Japan. Since the Ho Chi Minh City Securities Trading Center (now HOSE) opened on July 28, 2000 with just two listed stocks, the market has grown to over 1,700 listed companies across three exchanges (HOSE, HNX, and UPCOM) with a combined market capitalization exceeding 200 billion USD. Yet the ownership structure remains distinctive in several critical ways:</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Retail dominance.** Individual investors account for approximately 85% of trading value on Vietnamese exchanges, far exceeding the institutional share. This contrasts sharply with the US, where institutional investors dominate both ownership and trading <span class="co">[</span><span class="ot">@bao2024institutional</span><span class="co">]</span>. The implications for market efficiency, price discovery, and volatility are profound.</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**State ownership legacy.** Vietnam's equitization (privatization) program, initiated under Đổi Mới reforms in 1986, means that the state remains a significant or controlling shareholder in many listed companies. As of 2022, SOEs (firms with state ownership <span class="sc">\&gt;</span> 50%) account for approximately 30% of total market capitalization despite representing less than 10% of listed firms <span class="co">[</span><span class="ot">@huang2023factors</span><span class="co">]</span>. State ownership introduces unique agency problems, governance dynamics, and liquidity constraints.</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Foreign Ownership Limits (FOLs).** Vietnam imposes sector-specific caps on aggregate foreign ownership, typically 49% for most sectors, 30% for banking, and varying limits for aviation, media, and telecommunications. When a stock reaches its FOL, foreign investors can only buy from other foreign sellers, creating a segmented market with distinct pricing dynamics and a well-documented "FOL premium" <span class="co">[</span><span class="ot">@vo2015foreign</span><span class="co">]</span>.</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Disclosure regime.** Unlike the US quarterly 13F filing system, Vietnam's ownership disclosure is event-driven and periodic. Major shareholders (≥5%) must disclose within 7 business days of crossing thresholds. Annual reports contain detailed shareholder registers. Semi-annual fund reports provide portfolio snapshots. This creates a patchwork of disclosure frequencies that require careful handling.</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Infrastructure: DataCore.vn {#sec-datacore}</span></span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>**DataCore.vn** is a comprehensive Vietnamese financial data platform that provides academic-grade datasets for the Vietnamese market. Throughout this chapter, we assume all data is sourced exclusively from DataCore.vn, which provides:</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> DataCore.vn Dataset <span class="pp">|</span> Content <span class="pp">|</span> Key Variables <span class="pp">|</span></span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a><span class="pp">|:------------------------|:------------------|:---------------------------|</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Stock Prices** <span class="pp">|</span> Daily/monthly OHLCV for HOSE, HNX, UPCOM <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`close`</span>, <span class="in">`adjusted_close`</span>, <span class="in">`volume`</span>, <span class="in">`shares_outstanding`</span> <span class="pp">|</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Ownership Structure** <span class="pp">|</span> Shareholder composition snapshots <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`shareholder_name`</span>, <span class="in">`shares_held`</span>, <span class="in">`ownership_pct`</span>, <span class="in">`shareholder_type`</span> <span class="pp">|</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Major Shareholders** <span class="pp">|</span> Detailed ≥5% holders <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`shareholder_name`</span>, <span class="in">`shares_held`</span>, <span class="in">`is_foreign`</span>, <span class="in">`is_state`</span>, <span class="in">`is_institution`</span> <span class="pp">|</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Corporate Actions** <span class="pp">|</span> Dividends, stock splits, bonus shares, rights issues <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`ex_date`</span>, <span class="in">`action_type`</span>, <span class="in">`ratio`</span>, <span class="in">`record_date`</span> <span class="pp">|</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Company Profile** <span class="pp">|</span> Sector, exchange, listing date, charter capital <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`exchange`</span>, <span class="in">`industry_code`</span>, <span class="in">`listing_date`</span>, <span class="in">`fol_limit`</span> <span class="pp">|</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Financial Statements** <span class="pp">|</span> Quarterly/annual financials <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`period`</span>, <span class="in">`revenue`</span>, <span class="in">`net_income`</span>, <span class="in">`total_assets`</span>, <span class="in">`equity`</span> <span class="pp">|</span></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Foreign Ownership** <span class="pp">|</span> Daily foreign ownership tracking <span class="pp">|</span> <span class="in">`ticker`</span>, <span class="in">`date`</span>, <span class="in">`foreign_shares`</span>, <span class="in">`foreign_pct`</span>, <span class="in">`fol_limit`</span>, <span class="in">`foreign_room`</span> <span class="pp">|</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Fund Holdings** <span class="pp">|</span> Semi-annual fund portfolio disclosures <span class="pp">|</span> <span class="in">`fund_name`</span>, <span class="in">`report_date`</span>, <span class="in">`ticker`</span>, <span class="in">`shares_held`</span>, <span class="in">`market_value`</span> <span class="pp">|</span></span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>: DataCore.vn Data Tables Used in This Chapter {#tbl-datacore-tables}</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: datacore-reader</span></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "DataCore.vn Unified Data Reader"</span></span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DataCoreReader:</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="co">    Unified data reader for DataCore.vn datasets.</span></span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a><span class="co">    Assumes data has been downloaded from DataCore.vn and stored locally.</span></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports both Parquet (recommended for performance) and CSV formats.</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a><span class="co">    data_dir : str or Path</span></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a><span class="co">        Root directory containing DataCore.vn data files</span></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a><span class="co">    file_format : str</span></span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a><span class="co">        'parquet' or 'csv' (default: 'parquet')</span></span>
<span id="cb23-118"><a href="#cb23-118" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-119"><a href="#cb23-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected file names in the data directory</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a>    FILE_MAP <span class="op">=</span> {</span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">'prices'</span>: <span class="st">'stock_prices'</span>,</span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ownership'</span>: <span class="st">'ownership_structure'</span>,</span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">'major_shareholders'</span>: <span class="st">'major_shareholders'</span>,</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'corporate_actions'</span>: <span class="st">'corporate_actions'</span>,</span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'company_profile'</span>: <span class="st">'company_profile'</span>,</span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">'financials'</span>: <span class="st">'financial_statements'</span>,</span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">'foreign_ownership'</span>: <span class="st">'foreign_ownership_daily'</span>,</span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_holdings'</span>: <span class="st">'fund_holdings'</span>,</span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data_dir: Union[<span class="bu">str</span>, Path], file_format: <span class="bu">str</span> <span class="op">=</span> <span class="st">'parquet'</span>):</span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data_dir <span class="op">=</span> Path(data_dir)</span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fmt <span class="op">=</span> file_format</span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache <span class="op">=</span> {}</span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Verify data directory exists</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> <span class="va">self</span>.data_dir.exists():</span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Data directory not found: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Please download data from DataCore.vn and place it in this directory."</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"DataCore.vn reader initialized: </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> [f.stem <span class="cf">for</span> f <span class="kw">in</span> <span class="va">self</span>.data_dir.glob(<span class="ss">f'*.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss">'</span>)]</span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Available datasets: </span><span class="sc">{</span>available<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _read(<span class="va">self</span>, key: <span class="bu">str</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read and cache a dataset."""</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> key <span class="kw">in</span> <span class="va">self</span>._cache:</span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>._cache[key]</span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>        fname <span class="op">=</span> <span class="va">self</span>.FILE_MAP.get(key, key)</span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a>        filepath <span class="op">=</span> <span class="va">self</span>.data_dir <span class="op">/</span> <span class="ss">f"</span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> filepath.exists():</span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>            <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Dataset not found: </span><span class="sc">{</span>filepath<span class="sc">}</span><span class="ch">\n</span><span class="ss">"</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"Expected file: </span><span class="sc">{</span>fname<span class="sc">}</span><span class="ss">.</span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>fmt<span class="sc">}</span><span class="ss"> in </span><span class="sc">{</span><span class="va">self</span><span class="sc">.</span>data_dir<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.fmt <span class="op">==</span> <span class="st">'parquet'</span>:</span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_parquet(filepath)</span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.read_csv(filepath, parse_dates<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Auto-detect and parse date columns</span></span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">'date'</span> <span class="kw">in</span> col.lower() <span class="kw">or</span> col.lower() <span class="kw">in</span> [<span class="st">'period'</span>, <span class="st">'ex_date'</span>, <span class="st">'record_date'</span>]:</span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a>                    df[col] <span class="op">=</span> pd.to_datetime(df[col])</span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">pass</span></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache[key] <span class="op">=</span> df</span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span>key<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss"> rows, </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> columns"</span>)</span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> prices(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'prices'</span>)</span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'ownership'</span>)</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> major_shareholders(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'major_shareholders'</span>)</span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> corporate_actions(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'corporate_actions'</span>)</span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> company_profile(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'company_profile'</span>)</span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-199"><a href="#cb23-199" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-200"><a href="#cb23-200" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> financials(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'financials'</span>)</span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> foreign_ownership(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'foreign_ownership'</span>)</span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fund_holdings(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._read(<span class="st">'fund_holdings'</span>)</span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> clear_cache(<span class="va">self</span>):</span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Clear all cached datasets to free memory."""</span></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._cache.clear()</span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize reader — adjust path to your local DataCore.vn data</span></span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a><span class="co"># dc = DataCoreReader('/path/to/datacore_data', file_format='parquet')</span></span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a>This chapter proceeds as follows. @sec-data-pipeline builds the complete data pipeline from raw DataCore.vn extracts to clean, analysis-ready datasets, with particular attention to corporate action adjustments. @sec-ownership-taxonomy defines Vietnam's unique ownership taxonomy. @sec-ownership-metrics computes institutional ownership ratios, concentration, and breadth for the Vietnamese market. @sec-foreign-ownership develops specialized foreign ownership analytics including FOL utilization and room premium. @sec-trades derives institutional trades from ownership disclosure snapshots. @sec-flows-turnover computes fund-level flows and turnover. @sec-state-ownership analyzes state ownership dynamics. @sec-modern-extensions introduces network analysis, ML classification, and event-study frameworks. @sec-empirical-applications presents complete empirical applications, and @sec-conclusion concludes.</span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Pipeline {#sec-data-pipeline}</span></span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stock Price Data and Corporate Action Adjustments {#sec-price-pipeline}</span></span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>Vietnam's equity market is notorious for frequent corporate actions, particularly stock dividends and bonus share issuances, that dramatically alter share counts. A company issuing a 30% stock dividend means every 100 shares become 130 shares, and the reference price adjusts downward proportionally. Failure to properly adjust historical shares and prices for these events is the single most common source of error in Vietnamese equity research.</span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: corporate-actions</span></span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Build Cumulative Adjustment Factors from Corporate Actions"</span></span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Corporate Action Adjustment Factors</span></span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_adjustment_factors(corporate_actions: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a><span class="co">    Build cumulative adjustment factors from the corporate actions history.</span></span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a><span class="co">    In Vietnam, the most common share-altering corporate actions are:</span></span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Stock dividends (cổ tức bằng cổ phiếu): e.g., 30% → ratio = 0.30</span></span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares × (1 + 0.30), price × (1 / 1.30)</span></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Bonus shares (thưởng cổ phiếu): mechanically identical to stock dividends</span></span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Stock splits (chia tách): e.g., 2:1 → ratio = 2.0</span></span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares × 2, price × 0.5</span></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Rights issues (phát hành thêm): dilutive, but not all shareholders exercise</span></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a><span class="co">       We approximate with the subscription ratio</span></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Reverse splits (gộp cổ phiếu): rare in Vietnam</span></span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a><span class="co">       Effect: shares ÷ ratio, price × ratio</span></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a><span class="co">    We construct a FORWARD-LOOKING cumulative adjustment factor such that:</span></span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a><span class="co">       adjusted_shares = raw_shares × cum_adj_factor(from_date, to_date)</span></span>
<span id="cb23-255"><a href="#cb23-255" aria-hidden="true" tabindex="-1"></a><span class="co">       adjusted_price = raw_price / cum_adj_factor(from_date, to_date)</span></span>
<span id="cb23-256"><a href="#cb23-256" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a><span class="co">    This is analogous to CRSP's cfacshr in the US context.</span></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a><span class="co">    corporate_actions : pd.DataFrame</span></span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a><span class="co">        DataCore.vn corporate actions with columns:</span></span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a><span class="co">        ticker, ex_date, action_type, ratio</span></span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a><span class="co">        action_type values:</span></span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'stock_dividend': ratio = dividend rate (e.g., 0.30 for 30%)</span></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'bonus_shares': ratio = bonus rate (e.g., 0.20 for 20%)</span></span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'stock_split': ratio = split factor (e.g., 2.0 for 2:1)</span></span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'reverse_split': ratio = merge factor (e.g., 5.0 for 5:1 merge)</span></span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'rights_issue': ratio = subscription rate (e.g., 0.10 for 10:1)</span></span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'cash_dividend': ratio = VND per share (no share adjustment needed)</span></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjustment factors: ticker, ex_date, point_factor, cum_factor</span></span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter to share-altering events only</span></span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>    share_events <span class="op">=</span> [<span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>, <span class="st">'stock_split'</span>, </span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'reverse_split'</span>, <span class="st">'rights_issue'</span>]</span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>    ca <span class="op">=</span> corporate_actions[</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>        corporate_actions[<span class="st">'action_type'</span>].isin(share_events)</span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(ca) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No share-altering corporate actions found."</span>)</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(columns<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'point_factor'</span>, <span class="st">'cum_factor'</span>])</span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute point adjustment factor for each event</span></span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_point_factor(row):</span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a>        atype <span class="op">=</span> row[<span class="st">'action_type'</span>]</span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a>        ratio <span class="op">=</span> row[<span class="st">'ratio'</span>]</span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-294"><a href="#cb23-294" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> atype <span class="kw">in</span> [<span class="st">'stock_dividend'</span>, <span class="st">'bonus_shares'</span>]:</span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 30% stock dividend: 100 shares → 130 shares</span></span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> ratio</span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'stock_split'</span>:</span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 2:1 split: 100 shares → 200 shares</span></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ratio</span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'reverse_split'</span>:</span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a>            <span class="co"># 5:1 reverse: 500 shares → 100 shares</span></span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span> <span class="op">/</span> ratio</span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> atype <span class="op">==</span> <span class="st">'rights_issue'</span>:</span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Approximate: assume all rights exercised</span></span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a>            <span class="co"># In practice, this overestimates the adjustment</span></span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">1</span> <span class="op">+</span> ratio</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="fl">1.0</span></span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>    ca[<span class="st">'point_factor'</span>] <span class="op">=</span> ca.<span class="bu">apply</span>(compute_point_factor, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort chronologically within each ticker</span></span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>    ca <span class="op">=</span> ca.sort_values([<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative factor: product of all point factors from listing to date</span></span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This gives us a running "total adjustment" for each ticker</span></span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a>    ca[<span class="st">'cum_factor'</span>] <span class="op">=</span> ca.groupby(<span class="st">'ticker'</span>)[<span class="st">'point_factor'</span>].cumprod()</span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary statistics</span></span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a>    n_tickers <span class="op">=</span> ca[<span class="st">'ticker'</span>].nunique()</span>
<span id="cb23-321"><a href="#cb23-321" aria-hidden="true" tabindex="-1"></a>    n_events <span class="op">=</span> <span class="bu">len</span>(ca)</span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a>    avg_events <span class="op">=</span> n_events <span class="op">/</span> n_tickers <span class="cf">if</span> n_tickers <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Corporate action adjustment factors built:"</span>)</span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Tickers with adjustments: </span><span class="sc">{</span>n_tickers<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total share-altering events: </span><span class="sc">{</span>n_events<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Average events per ticker: </span><span class="sc">{</span>avg_events<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Event type distribution:"</span>)</span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(ca[<span class="st">'action_type'</span>].value_counts().to_string())</span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ca[[<span class="st">'ticker'</span>, <span class="st">'ex_date'</span>, <span class="st">'action_type'</span>, <span class="st">'ratio'</span>, </span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a>               <span class="st">'point_factor'</span>, <span class="st">'cum_factor'</span>]]</span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_shares(shares: <span class="bu">float</span>, ticker: <span class="bu">str</span>, from_date, to_date, </span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a>                  adj_factors: pd.DataFrame) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a><span class="co">    Adjust a share count from one date to another for corporate actions.</span></span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a><span class="co">    Example: If a company had a 30% stock dividend with ex_date between</span></span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a><span class="co">    from_date and to_date, then 1000 shares at from_date = 1300 shares </span></span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a><span class="co">    at to_date.</span></span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a><span class="co">    shares : float</span></span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of shares at from_date</span></span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a><span class="co">    ticker : str</span></span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock ticker</span></span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a><span class="co">    from_date, to_date : pd.Timestamp</span></span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a><span class="co">        Period for adjustment</span></span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a><span class="co">        Output of build_adjustment_factors()</span></span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-356"><a href="#cb23-356" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-357"><a href="#cb23-357" aria-hidden="true" tabindex="-1"></a><span class="co">    float</span></span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a><span class="co">        Adjusted shares at to_date</span></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> adj_factors[</span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&gt;</span> pd.Timestamp(from_date)) <span class="op">&amp;</span></span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a>        (adj_factors[<span class="st">'ex_date'</span>] <span class="op">&lt;=</span> pd.Timestamp(to_date))</span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(events) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> shares</span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a>    total_factor <span class="op">=</span> events[<span class="st">'point_factor'</span>].prod()</span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares <span class="op">*</span> total_factor</span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage:</span></span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a><span class="co"># adj_factors = build_adjustment_factors(dc.corporate_actions)</span></span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a>::: {.callout-important title="The Stock Dividend Problem in Vietnam"}</span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a>Vietnamese companies issue stock dividends with remarkable frequency, many growth companies do so 2-3 times per year. Consider **Vinhomes (VHM)** or **FPT Corporation**: their share counts may double or triple over a 5-year period purely from stock dividends. If you compare raw ownership shares from 2019 to 2024 without adjustment, you will obtain nonsensical ownership ratios. **Every time-series analysis of Vietnamese ownership data must use adjusted shares.** This is the Vietnamese equivalent of the CRSP cfacshr adjustment factor problem in US data, but more severe because the events are more frequent and larger in magnitude.</span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: price-processing</span></span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Process DataCore.vn Price Data with Adjustments"</span></span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Process Stock Price Data</span></span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_price_data(prices: pd.DataFrame, </span>
<span id="cb23-393"><a href="#cb23-393" aria-hidden="true" tabindex="-1"></a>                       adj_factors: pd.DataFrame,</span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a>                       company_profile: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a><span class="co">    Process DataCore.vn stock price data:</span></span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Align dates to month-end and quarter-end</span></span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Merge company metadata (exchange, sector, FOL limit)</span></span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Compute adjusted prices and shares outstanding</span></span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Compute market capitalization</span></span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a><span class="co">    5. Create quarter-end snapshots</span></span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a><span class="co">    prices : pd.DataFrame</span></span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily/monthly price data from DataCore.vn</span></span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a><span class="co">    company_profile : pd.DataFrame</span></span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a><span class="co">        Company metadata including exchange, sector, FOL</span></span>
<span id="cb23-411"><a href="#cb23-411" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-412"><a href="#cb23-412" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a><span class="co">        Quarter-end processed stock data</span></span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> prices.copy()</span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize date</span></span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">'date'</span>])</span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'month_end'</span>] <span class="op">=</span> df[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'quarter_end'</span>] <span class="op">=</span> df[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge company profile</span></span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a>    profile_cols <span class="op">=</span> [<span class="st">'ticker'</span>, <span class="st">'exchange'</span>, <span class="st">'industry_code'</span>, <span class="st">'fol_limit'</span>, </span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'listing_date'</span>, <span class="st">'company_name'</span>]</span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a>    profile_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> profile_cols <span class="cf">if</span> c <span class="kw">in</span> company_profile.columns]</span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(company_profile[profile_cols], on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build cumulative adjustment factor for each ticker-date</span></span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each observation, compute the total adjustment from listing to that date</span></span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge adjustment events</span></span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each ticker-date, find the cumulative factor as of that date</span></span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_cum_factor_at_date(group):</span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> group.name</span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a>        ticker_adj <span class="op">=</span> adj_factors[adj_factors[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(ticker_adj) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'cum_adj_factor'</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> group</span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each date, find cumulative factor (product of all events up to that date)</span></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>)</span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'cum_adj_factor'</span>] <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, event <span class="kw">in</span> ticker_adj.iterrows():</span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> group[<span class="st">'date'</span>] <span class="op">&gt;=</span> event[<span class="st">'ex_date'</span>]</span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>            group.loc[mask, <span class="st">'cum_adj_factor'</span>] <span class="op">*=</span> event[<span class="st">'point_factor'</span>]</span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> group</span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(get_cum_factor_at_date)</span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted price and shares</span></span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a>    <span class="co"># adjusted_close should already be provided by DataCore.vn</span></span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a>    <span class="co"># But we compute our own for consistency</span></span>
<span id="cb23-459"><a href="#cb23-459" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'adjusted_close'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-460"><a href="#cb23-460" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'adjusted_close'</span>] <span class="op">=</span> df[<span class="st">'close'</span>] <span class="op">/</span> df[<span class="st">'cum_adj_factor'</span>]</span>
<span id="cb23-461"><a href="#cb23-461" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-462"><a href="#cb23-462" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjusted shares outstanding</span></span>
<span id="cb23-463"><a href="#cb23-463" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'adjusted_shares'</span>] <span class="op">=</span> df[<span class="st">'shares_outstanding'</span>] <span class="op">*</span> df[<span class="st">'cum_adj_factor'</span>]</span>
<span id="cb23-464"><a href="#cb23-464" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-465"><a href="#cb23-465" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market capitalization (in billion VND)</span></span>
<span id="cb23-466"><a href="#cb23-466" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'market_cap'</span>] <span class="op">=</span> df[<span class="st">'close'</span>] <span class="op">*</span> df[<span class="st">'shares_outstanding'</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb23-467"><a href="#cb23-467" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-468"><a href="#cb23-468" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly returns</span></span>
<span id="cb23-469"><a href="#cb23-469" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-470"><a href="#cb23-470" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'ret'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>].pct_change()</span>
<span id="cb23-471"><a href="#cb23-471" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-472"><a href="#cb23-472" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep quarter-end observations</span></span>
<span id="cb23-473"><a href="#cb23-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For daily data: keep last trading day of each quarter</span></span>
<span id="cb23-474"><a href="#cb23-474" aria-hidden="true" tabindex="-1"></a>    df_quarterly <span class="op">=</span> (df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-475"><a href="#cb23-475" aria-hidden="true" tabindex="-1"></a>                      .groupby([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb23-476"><a href="#cb23-476" aria-hidden="true" tabindex="-1"></a>                      .last()</span>
<span id="cb23-477"><a href="#cb23-477" aria-hidden="true" tabindex="-1"></a>                      .reset_index())</span>
<span id="cb23-478"><a href="#cb23-478" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-479"><a href="#cb23-479" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processed price data:"</span>)</span>
<span id="cb23-480"><a href="#cb23-480" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Total records (daily): </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-481"><a href="#cb23-481" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Quarter-end records: </span><span class="sc">{</span><span class="bu">len</span>(df_quarterly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-482"><a href="#cb23-482" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique tickers: </span><span class="sc">{</span>df_quarterly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-483"><a href="#cb23-483" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Date range: </span><span class="sc">{</span>df_quarterly[<span class="st">'quarter_end'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb23-484"><a href="#cb23-484" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>df_quarterly[<span class="st">'quarter_end'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-485"><a href="#cb23-485" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Exchange distribution:"</span>)</span>
<span id="cb23-486"><a href="#cb23-486" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df_quarterly.groupby(<span class="st">'exchange'</span>)[<span class="st">'ticker'</span>].nunique().to_string())</span>
<span id="cb23-487"><a href="#cb23-487" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-488"><a href="#cb23-488" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_quarterly</span>
<span id="cb23-489"><a href="#cb23-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-490"><a href="#cb23-490" aria-hidden="true" tabindex="-1"></a><span class="co"># prices_q = process_price_data(dc.prices, adj_factors, dc.company_profile)</span></span>
<span id="cb23-491"><a href="#cb23-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-492"><a href="#cb23-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-493"><a href="#cb23-493" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ownership Structure Data {#sec-ownership-data}</span></span>
<span id="cb23-494"><a href="#cb23-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-495"><a href="#cb23-495" aria-hidden="true" tabindex="-1"></a>Vietnamese ownership data captures the composition of shareholders as disclosed in annual reports, semi-annual reports, and event-driven disclosures. The key distinction from US 13F data is that Vietnamese disclosures provide a **complete ownership decomposition**, not just institutional long positions, but the full breakdown into state, institutional, foreign, and individual ownership.</span>
<span id="cb23-496"><a href="#cb23-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-499"><a href="#cb23-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-500"><a href="#cb23-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ownership-processing</span></span>
<span id="cb23-501"><a href="#cb23-501" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Process and Standardize Ownership Structure Data"</span></span>
<span id="cb23-502"><a href="#cb23-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-503"><a href="#cb23-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-504"><a href="#cb23-504" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-505"><a href="#cb23-505" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Process Ownership Structure Data</span></span>
<span id="cb23-506"><a href="#cb23-506" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-507"><a href="#cb23-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-508"><a href="#cb23-508" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OwnershipType:</span>
<span id="cb23-509"><a href="#cb23-509" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-510"><a href="#cb23-510" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's ownership taxonomy.</span></span>
<span id="cb23-511"><a href="#cb23-511" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-512"><a href="#cb23-512" aria-hidden="true" tabindex="-1"></a><span class="co">    Unlike the US where 13F captures only institutional long positions,</span></span>
<span id="cb23-513"><a href="#cb23-513" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese disclosure provides a complete ownership decomposition.</span></span>
<span id="cb23-514"><a href="#cb23-514" aria-hidden="true" tabindex="-1"></a><span class="co">    We classify shareholders into five mutually exclusive categories.</span></span>
<span id="cb23-515"><a href="#cb23-515" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-516"><a href="#cb23-516" aria-hidden="true" tabindex="-1"></a>    STATE <span class="op">=</span> <span class="st">'state'</span>                    <span class="co"># Nhà nước (government entities, SOE parents)</span></span>
<span id="cb23-517"><a href="#cb23-517" aria-hidden="true" tabindex="-1"></a>    FOREIGN_INST <span class="op">=</span> <span class="st">'foreign_inst'</span>      <span class="co"># Tổ chức nước ngoài</span></span>
<span id="cb23-518"><a href="#cb23-518" aria-hidden="true" tabindex="-1"></a>    DOMESTIC_INST <span class="op">=</span> <span class="st">'domestic_inst'</span>    <span class="co"># Tổ chức trong nước (non-state)</span></span>
<span id="cb23-519"><a href="#cb23-519" aria-hidden="true" tabindex="-1"></a>    INDIVIDUAL <span class="op">=</span> <span class="st">'individual'</span>          <span class="co"># Cá nhân</span></span>
<span id="cb23-520"><a href="#cb23-520" aria-hidden="true" tabindex="-1"></a>    TREASURY <span class="op">=</span> <span class="st">'treasury'</span>              <span class="co"># Cổ phiếu quỹ</span></span>
<span id="cb23-521"><a href="#cb23-521" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-522"><a href="#cb23-522" aria-hidden="true" tabindex="-1"></a>    ALL_TYPES <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST, INDIVIDUAL, TREASURY]</span>
<span id="cb23-523"><a href="#cb23-523" aria-hidden="true" tabindex="-1"></a>    INSTITUTIONAL <span class="op">=</span> [STATE, FOREIGN_INST, DOMESTIC_INST]</span>
<span id="cb23-524"><a href="#cb23-524" aria-hidden="true" tabindex="-1"></a>    FOREIGN <span class="op">=</span> [FOREIGN_INST]  <span class="co"># Can be expanded if foreign individuals are tracked</span></span>
<span id="cb23-525"><a href="#cb23-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-526"><a href="#cb23-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-527"><a href="#cb23-527" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_shareholders(ownership: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-528"><a href="#cb23-528" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-529"><a href="#cb23-529" aria-hidden="true" tabindex="-1"></a><span class="co">    Classify shareholders into Vietnam's ownership taxonomy.</span></span>
<span id="cb23-530"><a href="#cb23-530" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-531"><a href="#cb23-531" aria-hidden="true" tabindex="-1"></a><span class="co">    DataCore.vn may provide a `shareholder_type` field, but naming </span></span>
<span id="cb23-532"><a href="#cb23-532" aria-hidden="true" tabindex="-1"></a><span class="co">    conventions vary. This function standardizes the classification </span></span>
<span id="cb23-533"><a href="#cb23-533" aria-hidden="true" tabindex="-1"></a><span class="co">    using a combination of provided flags and name-based heuristics.</span></span>
<span id="cb23-534"><a href="#cb23-534" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-535"><a href="#cb23-535" aria-hidden="true" tabindex="-1"></a><span class="co">    The classification challenge in Vietnam (noted by @huang2023factors):</span></span>
<span id="cb23-536"><a href="#cb23-536" aria-hidden="true" tabindex="-1"></a><span class="co">    DataCore.vn may not always cleanly separate institution types, so we </span></span>
<span id="cb23-537"><a href="#cb23-537" aria-hidden="true" tabindex="-1"></a><span class="co">    use a cascading approach:</span></span>
<span id="cb23-538"><a href="#cb23-538" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Use explicit flags (is_state, is_foreign, is_institution) if available</span></span>
<span id="cb23-539"><a href="#cb23-539" aria-hidden="true" tabindex="-1"></a><span class="co">    2. Apply name-based heuristics for Vietnamese entity names</span></span>
<span id="cb23-540"><a href="#cb23-540" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Default to 'individual' for unclassified shareholders</span></span>
<span id="cb23-541"><a href="#cb23-541" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-542"><a href="#cb23-542" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-543"><a href="#cb23-543" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-544"><a href="#cb23-544" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb23-545"><a href="#cb23-545" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw ownership data from DataCore.vn</span></span>
<span id="cb23-546"><a href="#cb23-546" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-547"><a href="#cb23-547" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-548"><a href="#cb23-548" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-549"><a href="#cb23-549" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-550"><a href="#cb23-550" aria-hidden="true" tabindex="-1"></a><span class="co">        Ownership data with standardized `owner_type` column</span></span>
<span id="cb23-551"><a href="#cb23-551" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-552"><a href="#cb23-552" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> ownership.copy()</span>
<span id="cb23-553"><a href="#cb23-553" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-554"><a href="#cb23-554" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 1: Use explicit flags if available ---</span></span>
<span id="cb23-555"><a href="#cb23-555" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">all</span>(col <span class="kw">in</span> df.columns <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'is_state'</span>, <span class="st">'is_foreign'</span>, <span class="st">'is_institution'</span>]):</span>
<span id="cb23-556"><a href="#cb23-556" aria-hidden="true" tabindex="-1"></a>        conditions <span class="op">=</span> [</span>
<span id="cb23-557"><a href="#cb23-557" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_state'</span>] <span class="op">==</span> <span class="va">True</span>),</span>
<span id="cb23-558"><a href="#cb23-558" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_foreign'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_institution'</span>] <span class="op">==</span> <span class="va">True</span>),</span>
<span id="cb23-559"><a href="#cb23-559" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_foreign'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_institution'</span>] <span class="op">!=</span> <span class="va">True</span>),</span>
<span id="cb23-560"><a href="#cb23-560" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'is_institution'</span>] <span class="op">==</span> <span class="va">True</span>) <span class="op">&amp;</span> (df[<span class="st">'is_state'</span>] <span class="op">!=</span> <span class="va">True</span>) <span class="op">&amp;</span> </span>
<span id="cb23-561"><a href="#cb23-561" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">'is_foreign'</span>] <span class="op">!=</span> <span class="va">True</span>),</span>
<span id="cb23-562"><a href="#cb23-562" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb23-563"><a href="#cb23-563" aria-hidden="true" tabindex="-1"></a>        choices <span class="op">=</span> [</span>
<span id="cb23-564"><a href="#cb23-564" aria-hidden="true" tabindex="-1"></a>            OwnershipType.STATE,</span>
<span id="cb23-565"><a href="#cb23-565" aria-hidden="true" tabindex="-1"></a>            OwnershipType.FOREIGN_INST,</span>
<span id="cb23-566"><a href="#cb23-566" aria-hidden="true" tabindex="-1"></a>            OwnershipType.FOREIGN_INST,  <span class="co"># Foreign individuals often grouped</span></span>
<span id="cb23-567"><a href="#cb23-567" aria-hidden="true" tabindex="-1"></a>            OwnershipType.DOMESTIC_INST,</span>
<span id="cb23-568"><a href="#cb23-568" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb23-569"><a href="#cb23-569" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> np.select(conditions, choices, </span>
<span id="cb23-570"><a href="#cb23-570" aria-hidden="true" tabindex="-1"></a>                                      default<span class="op">=</span>OwnershipType.INDIVIDUAL)</span>
<span id="cb23-571"><a href="#cb23-571" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-572"><a href="#cb23-572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 2: Name-based heuristics ---</span></span>
<span id="cb23-573"><a href="#cb23-573" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'shareholder_name'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-574"><a href="#cb23-574" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> df[<span class="st">'shareholder_name'</span>].<span class="bu">str</span>.lower().fillna(<span class="st">''</span>)</span>
<span id="cb23-575"><a href="#cb23-575" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-576"><a href="#cb23-576" aria-hidden="true" tabindex="-1"></a>        <span class="co"># State entities: government ministries, SCIC, state corporations</span></span>
<span id="cb23-577"><a href="#cb23-577" aria-hidden="true" tabindex="-1"></a>        state_keywords <span class="op">=</span> [</span>
<span id="cb23-578"><a href="#cb23-578" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bộ tài chính'</span>, <span class="st">'tổng công ty đầu tư'</span>, <span class="st">'scic'</span>, </span>
<span id="cb23-579"><a href="#cb23-579" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ủy ban nhân dân'</span>, <span class="st">'nhà nước'</span>, <span class="st">'state capital'</span>,</span>
<span id="cb23-580"><a href="#cb23-580" aria-hidden="true" tabindex="-1"></a>            <span class="st">'tổng công ty'</span>, <span class="st">'vốn nhà nước'</span>, <span class="st">'bộ công thương'</span>,</span>
<span id="cb23-581"><a href="#cb23-581" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bộ quốc phòng'</span>, <span class="st">'bộ giao thông'</span>, <span class="st">'vinashin'</span>,</span>
<span id="cb23-582"><a href="#cb23-582" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb23-583"><a href="#cb23-583" aria-hidden="true" tabindex="-1"></a>        is_state <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb23-584"><a href="#cb23-584" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> state_keywords)</span>
<span id="cb23-585"><a href="#cb23-585" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-586"><a href="#cb23-586" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-587"><a href="#cb23-587" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Foreign entities: common fund names, foreign company patterns</span></span>
<span id="cb23-588"><a href="#cb23-588" aria-hidden="true" tabindex="-1"></a>        foreign_keywords <span class="op">=</span> [</span>
<span id="cb23-589"><a href="#cb23-589" aria-hidden="true" tabindex="-1"></a>            <span class="st">'fund'</span>, <span class="st">'investment'</span>, <span class="st">'capital'</span>, <span class="st">'limited'</span>, <span class="st">'ltd'</span>, <span class="st">'inc'</span>,</span>
<span id="cb23-590"><a href="#cb23-590" aria-hidden="true" tabindex="-1"></a>            <span class="st">'corporation'</span>, <span class="st">'holdings'</span>, <span class="st">'asset management'</span>, <span class="st">'pte'</span>,</span>
<span id="cb23-591"><a href="#cb23-591" aria-hidden="true" tabindex="-1"></a>            <span class="st">'gmbh'</span>, <span class="st">'management'</span>, <span class="st">'partners'</span>, <span class="st">'advisors'</span>,</span>
<span id="cb23-592"><a href="#cb23-592" aria-hidden="true" tabindex="-1"></a>            <span class="st">'dragon capital'</span>, <span class="st">'vinacapital'</span>, <span class="st">'templeton'</span>, </span>
<span id="cb23-593"><a href="#cb23-593" aria-hidden="true" tabindex="-1"></a>            <span class="st">'blackrock'</span>, <span class="st">'jpmorgan'</span>, <span class="st">'samsung'</span>, <span class="st">'mirae'</span>,</span>
<span id="cb23-594"><a href="#cb23-594" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb23-595"><a href="#cb23-595" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Also check for non-Vietnamese characters as a heuristic</span></span>
<span id="cb23-596"><a href="#cb23-596" aria-hidden="true" tabindex="-1"></a>        is_foreign_name <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb23-597"><a href="#cb23-597" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> foreign_keywords)</span>
<span id="cb23-598"><a href="#cb23-598" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-599"><a href="#cb23-599" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-600"><a href="#cb23-600" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Domestic institutions: Vietnamese bank, securities, insurance names</span></span>
<span id="cb23-601"><a href="#cb23-601" aria-hidden="true" tabindex="-1"></a>        domestic_inst_keywords <span class="op">=</span> [</span>
<span id="cb23-602"><a href="#cb23-602" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ngân hàng'</span>, <span class="st">'chứng khoán'</span>, <span class="st">'bảo hiểm'</span>, <span class="st">'quỹ đầu tư'</span>,</span>
<span id="cb23-603"><a href="#cb23-603" aria-hidden="true" tabindex="-1"></a>            <span class="st">'công ty quản lý'</span>, <span class="st">'bảo việt'</span>, <span class="st">'techcombank'</span>, <span class="st">'vietcombank'</span>,</span>
<span id="cb23-604"><a href="#cb23-604" aria-hidden="true" tabindex="-1"></a>            <span class="st">'bidv'</span>, <span class="st">'vietinbank'</span>, <span class="st">'vpbank'</span>, <span class="st">'mb bank'</span>, <span class="st">'ssi'</span>, <span class="st">'hsc'</span>,</span>
<span id="cb23-605"><a href="#cb23-605" aria-hidden="true" tabindex="-1"></a>            <span class="st">'vcsc'</span>, <span class="st">'vndirect'</span>, <span class="st">'fpt capital'</span>, <span class="st">'manulife'</span>,</span>
<span id="cb23-606"><a href="#cb23-606" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb23-607"><a href="#cb23-607" aria-hidden="true" tabindex="-1"></a>        is_domestic_inst <span class="op">=</span> name.<span class="bu">apply</span>(</span>
<span id="cb23-608"><a href="#cb23-608" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: <span class="bu">any</span>(kw <span class="kw">in</span> x <span class="cf">for</span> kw <span class="kw">in</span> domestic_inst_keywords)</span>
<span id="cb23-609"><a href="#cb23-609" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-610"><a href="#cb23-610" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-611"><a href="#cb23-611" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Treasury shares</span></span>
<span id="cb23-612"><a href="#cb23-612" aria-hidden="true" tabindex="-1"></a>        is_treasury <span class="op">=</span> name.<span class="bu">str</span>.contains(<span class="st">'cổ phiếu quỹ|treasury'</span>, case<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-613"><a href="#cb23-613" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-614"><a href="#cb23-614" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply classification cascade</span></span>
<span id="cb23-615"><a href="#cb23-615" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.INDIVIDUAL  <span class="co"># Default</span></span>
<span id="cb23-616"><a href="#cb23-616" aria-hidden="true" tabindex="-1"></a>        df.loc[is_domestic_inst, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.DOMESTIC_INST</span>
<span id="cb23-617"><a href="#cb23-617" aria-hidden="true" tabindex="-1"></a>        df.loc[is_foreign_name, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.FOREIGN_INST</span>
<span id="cb23-618"><a href="#cb23-618" aria-hidden="true" tabindex="-1"></a>        df.loc[is_state, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.STATE</span>
<span id="cb23-619"><a href="#cb23-619" aria-hidden="true" tabindex="-1"></a>        df.loc[is_treasury, <span class="st">'owner_type'</span>] <span class="op">=</span> OwnershipType.TREASURY</span>
<span id="cb23-620"><a href="#cb23-620" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-621"><a href="#cb23-621" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Method 3: Use shareholder_type directly ---</span></span>
<span id="cb23-622"><a href="#cb23-622" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">'shareholder_type'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-623"><a href="#cb23-623" aria-hidden="true" tabindex="-1"></a>        type_map <span class="op">=</span> {</span>
<span id="cb23-624"><a href="#cb23-624" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state'</span>: OwnershipType.STATE,</span>
<span id="cb23-625"><a href="#cb23-625" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_institution'</span>: OwnershipType.FOREIGN_INST,</span>
<span id="cb23-626"><a href="#cb23-626" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_individual'</span>: OwnershipType.FOREIGN_INST,</span>
<span id="cb23-627"><a href="#cb23-627" aria-hidden="true" tabindex="-1"></a>            <span class="st">'domestic_institution'</span>: OwnershipType.DOMESTIC_INST,</span>
<span id="cb23-628"><a href="#cb23-628" aria-hidden="true" tabindex="-1"></a>            <span class="st">'individual'</span>: OwnershipType.INDIVIDUAL,</span>
<span id="cb23-629"><a href="#cb23-629" aria-hidden="true" tabindex="-1"></a>            <span class="st">'treasury'</span>: OwnershipType.TREASURY,</span>
<span id="cb23-630"><a href="#cb23-630" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-631"><a href="#cb23-631" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> df[<span class="st">'shareholder_type'</span>].<span class="bu">str</span>.lower().<span class="bu">map</span>(type_map)</span>
<span id="cb23-632"><a href="#cb23-632" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'owner_type'</span>] <span class="op">=</span> df[<span class="st">'owner_type'</span>].fillna(OwnershipType.INDIVIDUAL)</span>
<span id="cb23-633"><a href="#cb23-633" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-634"><a href="#cb23-634" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-635"><a href="#cb23-635" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb23-636"><a href="#cb23-636" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Cannot classify shareholders. Expected one of:</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb23-637"><a href="#cb23-637" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  1. Columns: is_state, is_foreign, is_institution</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb23-638"><a href="#cb23-638" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  2. Column: shareholder_name (for heuristic classification)</span><span class="ch">\n</span><span class="st">"</span></span>
<span id="cb23-639"><a href="#cb23-639" aria-hidden="true" tabindex="-1"></a>            <span class="st">"  3. Column: shareholder_type (pre-classified)"</span></span>
<span id="cb23-640"><a href="#cb23-640" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-641"><a href="#cb23-641" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-642"><a href="#cb23-642" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Summary</span></span>
<span id="cb23-643"><a href="#cb23-643" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Ownership classification results:"</span>)</span>
<span id="cb23-644"><a href="#cb23-644" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(df[<span class="st">'owner_type'</span>].value_counts().to_string())</span>
<span id="cb23-645"><a href="#cb23-645" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-646"><a href="#cb23-646" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb23-647"><a href="#cb23-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-648"><a href="#cb23-648" aria-hidden="true" tabindex="-1"></a><span class="co"># ownership_classified = classify_shareholders(dc.ownership)</span></span>
<span id="cb23-649"><a href="#cb23-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-650"><a href="#cb23-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-651"><a href="#cb23-651" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb23-652"><a href="#cb23-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-653"><a href="#cb23-653" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vietnam's Ownership Taxonomy {#sec-ownership-taxonomy}</span></span>
<span id="cb23-654"><a href="#cb23-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-655"><a href="#cb23-655" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Five Ownership Categories</span></span>
<span id="cb23-656"><a href="#cb23-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-657"><a href="#cb23-657" aria-hidden="true" tabindex="-1"></a>Vietnam's ownership structure is decomposed into five mutually exclusive categories that together sum to 100% of shares outstanding:</span>
<span id="cb23-658"><a href="#cb23-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-659"><a href="#cb23-659" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Category <span class="pp">|</span> Vietnamese Term <span class="pp">|</span> Description <span class="pp">|</span> Typical Share (2020s) <span class="pp">|</span></span>
<span id="cb23-660"><a href="#cb23-660" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----------------|:-----------------|:-----------------|:------------------|</span></span>
<span id="cb23-661"><a href="#cb23-661" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **State** <span class="pp">|</span> Sở hữu Nhà nước <span class="pp">|</span> Government entities, SCIC, SOE parent companies <span class="pp">|</span> \~15-25% of market cap <span class="pp">|</span></span>
<span id="cb23-662"><a href="#cb23-662" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Foreign Institutional** <span class="pp">|</span> Tổ chức nước ngoài <span class="pp">|</span> Foreign funds, banks, corporations <span class="pp">|</span> \~15-20% <span class="pp">|</span></span>
<span id="cb23-663"><a href="#cb23-663" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Domestic Institutional** <span class="pp">|</span> Tổ chức trong nước <span class="pp">|</span> Vietnamese funds, banks, insurance, securities firms <span class="pp">|</span> \~5-10% <span class="pp">|</span></span>
<span id="cb23-664"><a href="#cb23-664" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Individual** <span class="pp">|</span> Cá nhân <span class="pp">|</span> Retail investors (both Vietnamese and foreign individuals) <span class="pp">|</span> \~55-65% <span class="pp">|</span></span>
<span id="cb23-665"><a href="#cb23-665" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Treasury** <span class="pp">|</span> Cổ phiếu quỹ <span class="pp">|</span> Company's own repurchased shares <span class="pp">|</span> \~0-2% <span class="pp">|</span></span>
<span id="cb23-666"><a href="#cb23-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-667"><a href="#cb23-667" aria-hidden="true" tabindex="-1"></a>: Vietnam's Ownership Taxonomy {#tbl-ownership-taxonomy}</span>
<span id="cb23-668"><a href="#cb23-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-669"><a href="#cb23-669" aria-hidden="true" tabindex="-1"></a>This taxonomy differs fundamentally from the US 13F framework in several ways:</span>
<span id="cb23-670"><a href="#cb23-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-671"><a href="#cb23-671" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Completeness:** We observe 100% of ownership, not just institutional long positions above \$100 million AUM.</span>
<span id="cb23-672"><a href="#cb23-672" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**State as a category:** State ownership is a first-class analytical category, not subsumed under "All Others" as in the LSEG type code system.</span>
<span id="cb23-673"><a href="#cb23-673" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Individual visibility:** We observe aggregate individual ownership directly, whereas in the US, individual ownership is merely the residual (100% − institutional ownership).</span>
<span id="cb23-674"><a href="#cb23-674" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**No short position ambiguity:** Vietnam's market has very limited short-selling infrastructure, so ownership data genuinely represents long positions.</span>
<span id="cb23-675"><a href="#cb23-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-678"><a href="#cb23-678" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-679"><a href="#cb23-679" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ownership-decomposition</span></span>
<span id="cb23-680"><a href="#cb23-680" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute Full Ownership Decomposition for Each Stock-Period"</span></span>
<span id="cb23-681"><a href="#cb23-681" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-682"><a href="#cb23-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-683"><a href="#cb23-683" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-684"><a href="#cb23-684" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Compute Ownership Decomposition</span></span>
<span id="cb23-685"><a href="#cb23-685" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-686"><a href="#cb23-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-687"><a href="#cb23-687" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ownership_decomposition(ownership: pd.DataFrame,</span>
<span id="cb23-688"><a href="#cb23-688" aria-hidden="true" tabindex="-1"></a>                                     prices_q: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-689"><a href="#cb23-689" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-690"><a href="#cb23-690" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute the full ownership decomposition for each stock at each </span></span>
<span id="cb23-691"><a href="#cb23-691" aria-hidden="true" tabindex="-1"></a><span class="co">    disclosure date.</span></span>
<span id="cb23-692"><a href="#cb23-692" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-693"><a href="#cb23-693" aria-hidden="true" tabindex="-1"></a><span class="co">    For each stock-date combination, aggregates shares held by each </span></span>
<span id="cb23-694"><a href="#cb23-694" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership category and computes ownership ratios relative to </span></span>
<span id="cb23-695"><a href="#cb23-695" aria-hidden="true" tabindex="-1"></a><span class="co">    total shares outstanding.</span></span>
<span id="cb23-696"><a href="#cb23-696" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-697"><a href="#cb23-697" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-698"><a href="#cb23-698" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-699"><a href="#cb23-699" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb23-700"><a href="#cb23-700" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership data (output of classify_shareholders)</span></span>
<span id="cb23-701"><a href="#cb23-701" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_q : pd.DataFrame</span></span>
<span id="cb23-702"><a href="#cb23-702" aria-hidden="true" tabindex="-1"></a><span class="co">        Quarter-end price data with shares_outstanding</span></span>
<span id="cb23-703"><a href="#cb23-703" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-704"><a href="#cb23-704" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-705"><a href="#cb23-705" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-706"><a href="#cb23-706" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-707"><a href="#cb23-707" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock-period level ownership decomposition with columns for</span></span>
<span id="cb23-708"><a href="#cb23-708" aria-hidden="true" tabindex="-1"></a><span class="co">        each ownership type's share count and percentage</span></span>
<span id="cb23-709"><a href="#cb23-709" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-710"><a href="#cb23-710" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate shares by ticker, date, and owner type</span></span>
<span id="cb23-711"><a href="#cb23-711" aria-hidden="true" tabindex="-1"></a>    agg <span class="op">=</span> (ownership.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'owner_type'</span>])[<span class="st">'shares_held'</span>]</span>
<span id="cb23-712"><a href="#cb23-712" aria-hidden="true" tabindex="-1"></a>                    .<span class="bu">sum</span>()</span>
<span id="cb23-713"><a href="#cb23-713" aria-hidden="true" tabindex="-1"></a>                    .reset_index())</span>
<span id="cb23-714"><a href="#cb23-714" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-715"><a href="#cb23-715" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to wide format: one column per ownership type</span></span>
<span id="cb23-716"><a href="#cb23-716" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> agg.pivot_table(</span>
<span id="cb23-717"><a href="#cb23-717" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>],</span>
<span id="cb23-718"><a href="#cb23-718" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span><span class="st">'owner_type'</span>,</span>
<span id="cb23-719"><a href="#cb23-719" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span><span class="st">'shares_held'</span>,</span>
<span id="cb23-720"><a href="#cb23-720" aria-hidden="true" tabindex="-1"></a>        fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb23-721"><a href="#cb23-721" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-722"><a href="#cb23-722" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-723"><a href="#cb23-723" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rename columns</span></span>
<span id="cb23-724"><a href="#cb23-724" aria-hidden="true" tabindex="-1"></a>    type_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> wide.columns <span class="cf">if</span> c <span class="kw">in</span> OwnershipType.ALL_TYPES]</span>
<span id="cb23-725"><a href="#cb23-725" aria-hidden="true" tabindex="-1"></a>    rename_map <span class="op">=</span> {t: <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> type_cols}</span>
<span id="cb23-726"><a href="#cb23-726" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> wide.rename(columns<span class="op">=</span>rename_map)</span>
<span id="cb23-727"><a href="#cb23-727" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-728"><a href="#cb23-728" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total institutional shares</span></span>
<span id="cb23-729"><a href="#cb23-729" aria-hidden="true" tabindex="-1"></a>    inst_cols <span class="op">=</span> [<span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> OwnershipType.INSTITUTIONAL </span>
<span id="cb23-730"><a href="#cb23-730" aria-hidden="true" tabindex="-1"></a>                 <span class="cf">if</span> <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="kw">in</span> wide.columns]</span>
<span id="cb23-731"><a href="#cb23-731" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'shares_institutional'</span>] <span class="op">=</span> wide[inst_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-732"><a href="#cb23-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-733"><a href="#cb23-733" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total foreign shares (for FOL tracking)</span></span>
<span id="cb23-734"><a href="#cb23-734" aria-hidden="true" tabindex="-1"></a>    foreign_cols <span class="op">=</span> [<span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> t <span class="kw">in</span> OwnershipType.FOREIGN </span>
<span id="cb23-735"><a href="#cb23-735" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="ss">f'shares_</span><span class="sc">{</span>t<span class="sc">}</span><span class="ss">'</span> <span class="kw">in</span> wide.columns]</span>
<span id="cb23-736"><a href="#cb23-736" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'shares_foreign_total'</span>] <span class="op">=</span> wide[foreign_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-737"><a href="#cb23-737" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-738"><a href="#cb23-738" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align with quarter-end dates for merging with price data</span></span>
<span id="cb23-739"><a href="#cb23-739" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">'quarter_end'</span>] <span class="op">=</span> wide[<span class="st">'date'</span>] <span class="op">+</span> pd.offsets.QuarterEnd(<span class="dv">0</span>)</span>
<span id="cb23-740"><a href="#cb23-740" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-741"><a href="#cb23-741" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with price data to get shares outstanding</span></span>
<span id="cb23-742"><a href="#cb23-742" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> wide.merge(</span>
<span id="cb23-743"><a href="#cb23-743" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'shares_outstanding'</span>, </span>
<span id="cb23-744"><a href="#cb23-744" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'adjusted_shares'</span>, <span class="st">'market_cap'</span>, <span class="st">'exchange'</span>, </span>
<span id="cb23-745"><a href="#cb23-745" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'industry_code'</span>, <span class="st">'fol_limit'</span>, <span class="st">'close'</span>]],</span>
<span id="cb23-746"><a href="#cb23-746" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb23-747"><a href="#cb23-747" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb23-748"><a href="#cb23-748" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-749"><a href="#cb23-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-750"><a href="#cb23-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute ownership ratios</span></span>
<span id="cb23-751"><a href="#cb23-751" aria-hidden="true" tabindex="-1"></a>    tso <span class="op">=</span> merged[<span class="st">'shares_outstanding'</span>]</span>
<span id="cb23-752"><a href="#cb23-752" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> merged.columns:</span>
<span id="cb23-753"><a href="#cb23-753" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col.startswith(<span class="st">'shares_'</span>) <span class="kw">and</span> col <span class="op">!=</span> <span class="st">'shares_outstanding'</span>:</span>
<span id="cb23-754"><a href="#cb23-754" aria-hidden="true" tabindex="-1"></a>            ratio_col <span class="op">=</span> col.replace(<span class="st">'shares_'</span>, <span class="st">'pct_'</span>)</span>
<span id="cb23-755"><a href="#cb23-755" aria-hidden="true" tabindex="-1"></a>            merged[ratio_col] <span class="op">=</span> merged[col] <span class="op">/</span> tso</span>
<span id="cb23-756"><a href="#cb23-756" aria-hidden="true" tabindex="-1"></a>            merged.loc[tso <span class="op">&lt;=</span> <span class="dv">0</span>, ratio_col] <span class="op">=</span> np.nan</span>
<span id="cb23-757"><a href="#cb23-757" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-758"><a href="#cb23-758" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derived measures</span></span>
<span id="cb23-759"><a href="#cb23-759" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'pct_free_float'</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> merged.get(<span class="st">'pct_state'</span>, <span class="dv">0</span>) <span class="op">-</span> merged.get(<span class="st">'pct_treasury'</span>, <span class="dv">0</span>)</span>
<span id="cb23-760"><a href="#cb23-760" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-761"><a href="#cb23-761" aria-hidden="true" tabindex="-1"></a>    <span class="co"># SOE flag: state ownership &gt; 50%</span></span>
<span id="cb23-762"><a href="#cb23-762" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'is_soe'</span>] <span class="op">=</span> (merged.get(<span class="st">'pct_state'</span>, <span class="dv">0</span>) <span class="op">&gt;</span> <span class="fl">0.50</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-763"><a href="#cb23-763" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-764"><a href="#cb23-764" aria-hidden="true" tabindex="-1"></a>    <span class="co"># FOL utilization</span></span>
<span id="cb23-765"><a href="#cb23-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'fol_limit'</span> <span class="kw">in</span> merged.columns <span class="kw">and</span> <span class="st">'pct_foreign_total'</span> <span class="kw">in</span> merged.columns:</span>
<span id="cb23-766"><a href="#cb23-766" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'fol_utilization'</span>] <span class="op">=</span> merged[<span class="st">'pct_foreign_total'</span>] <span class="op">/</span> merged[<span class="st">'fol_limit'</span>]</span>
<span id="cb23-767"><a href="#cb23-767" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'foreign_room'</span>] <span class="op">=</span> merged[<span class="st">'fol_limit'</span>] <span class="op">-</span> merged[<span class="st">'pct_foreign_total'</span>]</span>
<span id="cb23-768"><a href="#cb23-768" aria-hidden="true" tabindex="-1"></a>        merged.loc[merged[<span class="st">'fol_limit'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, [<span class="st">'fol_utilization'</span>, <span class="st">'foreign_room'</span>]] <span class="op">=</span> np.nan</span>
<span id="cb23-769"><a href="#cb23-769" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-770"><a href="#cb23-770" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Number of institutional owners (breadth)</span></span>
<span id="cb23-771"><a href="#cb23-771" aria-hidden="true" tabindex="-1"></a>    n_owners <span class="op">=</span> (ownership[ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)]</span>
<span id="cb23-772"><a href="#cb23-772" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-773"><a href="#cb23-773" aria-hidden="true" tabindex="-1"></a>                .nunique()</span>
<span id="cb23-774"><a href="#cb23-774" aria-hidden="true" tabindex="-1"></a>                .reset_index()</span>
<span id="cb23-775"><a href="#cb23-775" aria-hidden="true" tabindex="-1"></a>                .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_inst_owners'</span>}))</span>
<span id="cb23-776"><a href="#cb23-776" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-777"><a href="#cb23-777" aria-hidden="true" tabindex="-1"></a>    n_foreign_owners <span class="op">=</span> (ownership[ownership[<span class="st">'owner_type'</span>] <span class="op">==</span> OwnershipType.FOREIGN_INST]</span>
<span id="cb23-778"><a href="#cb23-778" aria-hidden="true" tabindex="-1"></a>                        .groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])[<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-779"><a href="#cb23-779" aria-hidden="true" tabindex="-1"></a>                        .nunique()</span>
<span id="cb23-780"><a href="#cb23-780" aria-hidden="true" tabindex="-1"></a>                        .reset_index()</span>
<span id="cb23-781"><a href="#cb23-781" aria-hidden="true" tabindex="-1"></a>                        .rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_foreign_owners'</span>}))</span>
<span id="cb23-782"><a href="#cb23-782" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-783"><a href="#cb23-783" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(n_owners, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-784"><a href="#cb23-784" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(n_foreign_owners, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-785"><a href="#cb23-785" aria-hidden="true" tabindex="-1"></a>    merged[[<span class="st">'n_inst_owners'</span>, <span class="st">'n_foreign_owners'</span>]] <span class="op">=</span> (</span>
<span id="cb23-786"><a href="#cb23-786" aria-hidden="true" tabindex="-1"></a>        merged[[<span class="st">'n_inst_owners'</span>, <span class="st">'n_foreign_owners'</span>]].fillna(<span class="dv">0</span>)</span>
<span id="cb23-787"><a href="#cb23-787" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-788"><a href="#cb23-788" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-789"><a href="#cb23-789" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Ownership decomposition computed:"</span>)</span>
<span id="cb23-790"><a href="#cb23-790" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Stock-period observations: </span><span class="sc">{</span><span class="bu">len</span>(merged)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-791"><a href="#cb23-791" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique tickers: </span><span class="sc">{</span>merged[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-792"><a href="#cb23-792" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Mean ownership structure:"</span>)</span>
<span id="cb23-793"><a href="#cb23-793" aria-hidden="true" tabindex="-1"></a>    pct_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> merged.columns <span class="cf">if</span> c.startswith(<span class="st">'pct_'</span>)]</span>
<span id="cb23-794"><a href="#cb23-794" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(merged[pct_cols].mean().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb23-795"><a href="#cb23-795" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-796"><a href="#cb23-796" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb23-797"><a href="#cb23-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-798"><a href="#cb23-798" aria-hidden="true" tabindex="-1"></a><span class="co"># ownership_decomp = compute_ownership_decomposition(</span></span>
<span id="cb23-799"><a href="#cb23-799" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, prices_q</span></span>
<span id="cb23-800"><a href="#cb23-800" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb23-801"><a href="#cb23-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-802"><a href="#cb23-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-803"><a href="#cb23-803" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb23-804"><a href="#cb23-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-805"><a href="#cb23-805" aria-hidden="true" tabindex="-1"></a><span class="fu">## Institutional Ownership Measures {#sec-ownership-metrics}</span></span>
<span id="cb23-806"><a href="#cb23-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-807"><a href="#cb23-807" aria-hidden="true" tabindex="-1"></a><span class="fu">### Ownership Ratio {#sec-io-ratio}</span></span>
<span id="cb23-808"><a href="#cb23-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-809"><a href="#cb23-809" aria-hidden="true" tabindex="-1"></a>The **Institutional Ownership Ratio (IOR)** for stock $i$ at time $t$ in Vietnam is:</span>
<span id="cb23-810"><a href="#cb23-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-811"><a href="#cb23-811" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-812"><a href="#cb23-812" aria-hidden="true" tabindex="-1"></a>IOR_{i,t} = \frac{S_{i,t}^{state} + S_{i,t}^{foreign<span class="sc">\_</span>inst} + S_{i,t}^{domestic<span class="sc">\_</span>inst}}{TSO_{i,t}}</span>
<span id="cb23-813"><a href="#cb23-813" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ior-vn}</span>
<span id="cb23-814"><a href="#cb23-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-815"><a href="#cb23-815" aria-hidden="true" tabindex="-1"></a>where $S_{i,t}^{type}$ denotes adjusted shares held by each ownership category and $TSO_{i,t}$ is total shares outstanding. Unlike the US where the IOR can exceed 100% due to long-only reporting and short selling, the Vietnamese IOR is bounded by construction in $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$ because we observe the complete ownership decomposition.</span>
<span id="cb23-816"><a href="#cb23-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-817"><a href="#cb23-817" aria-hidden="true" tabindex="-1"></a>We also compute category-specific ownership ratios:</span>
<span id="cb23-818"><a href="#cb23-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-819"><a href="#cb23-819" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-820"><a href="#cb23-820" aria-hidden="true" tabindex="-1"></a>\begin{aligned}</span>
<span id="cb23-821"><a href="#cb23-821" aria-hidden="true" tabindex="-1"></a>IOR_{i,t}^{foreign} &amp;= \frac{S_{i,t}^{foreign<span class="sc">\_</span>inst}}{TSO_{i,t}},<span class="sc">\\</span></span>
<span id="cb23-822"><a href="#cb23-822" aria-hidden="true" tabindex="-1"></a>IOR_{i,t}^{state} &amp;= \frac{S_{i,t}^{state}}{TSO_{i,t}},<span class="sc">\\</span></span>
<span id="cb23-823"><a href="#cb23-823" aria-hidden="true" tabindex="-1"></a>IOR_{i,t}^{domestic} &amp;= \frac{S_{i,t}^{domestic<span class="sc">\_</span>inst}}{TSO_{i,t}}</span>
<span id="cb23-824"><a href="#cb23-824" aria-hidden="true" tabindex="-1"></a>\end{aligned}</span>
<span id="cb23-825"><a href="#cb23-825" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ior-components}</span>
<span id="cb23-826"><a href="#cb23-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-827"><a href="#cb23-827" aria-hidden="true" tabindex="-1"></a><span class="fu">### Concentration: Herfindahl-Hirschman Index {#sec-hhi}</span></span>
<span id="cb23-828"><a href="#cb23-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-829"><a href="#cb23-829" aria-hidden="true" tabindex="-1"></a>The **Institutional Ownership Concentration** via the Herfindahl-Hirschman Index is:</span>
<span id="cb23-830"><a href="#cb23-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-831"><a href="#cb23-831" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-832"><a href="#cb23-832" aria-hidden="true" tabindex="-1"></a>IOC_{i,t}^{HHI} = \sum_{j=1}^{N_{i,t}} \left(\frac{S_{i,j,t}}{\sum_{k=1}^{N_{i,t}} S_{i,k,t}}\right)^2</span>
<span id="cb23-833"><a href="#cb23-833" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hhi-vn}</span>
<span id="cb23-834"><a href="#cb23-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-835"><a href="#cb23-835" aria-hidden="true" tabindex="-1"></a>In Vietnam, the HHI is particularly informative because it captures the dominance of state shareholders. A company where the government holds 65% will have a mechanically high HHI even if the remaining 35% is diversely held.</span>
<span id="cb23-836"><a href="#cb23-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-837"><a href="#cb23-837" aria-hidden="true" tabindex="-1"></a>We therefore compute **separate HHI measures** for different ownership categories:</span>
<span id="cb23-838"><a href="#cb23-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-839"><a href="#cb23-839" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-840"><a href="#cb23-840" aria-hidden="true" tabindex="-1"></a>HHI_{i,t}^{total} = \sum_{j} w_{i,j,t}^2, \quad</span>
<span id="cb23-841"><a href="#cb23-841" aria-hidden="true" tabindex="-1"></a>HHI_{i,t}^{non-state} = \sum_{j \notin state} \left(\frac{S_{i,j,t}}{\sum_{k \notin state} S_{i,k,t}}\right)^2</span>
<span id="cb23-842"><a href="#cb23-842" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hhi-decomposed}</span>
<span id="cb23-843"><a href="#cb23-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-844"><a href="#cb23-844" aria-hidden="true" tabindex="-1"></a>The non-state HHI is more comparable to the US institutional HHI, as it captures concentration among market-driven investors.</span>
<span id="cb23-845"><a href="#cb23-845" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-846"><a href="#cb23-846" aria-hidden="true" tabindex="-1"></a><span class="fu">### Breadth of Ownership {#sec-breadth}</span></span>
<span id="cb23-847"><a href="#cb23-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-848"><a href="#cb23-848" aria-hidden="true" tabindex="-1"></a>Following @chen2002breadth, **Institutional Breadth** ($N_{i,t}$) is the number of institutional investors holding stock $i$ in period $t$. The **Change in Breadth** is:</span>
<span id="cb23-849"><a href="#cb23-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-850"><a href="#cb23-850" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-851"><a href="#cb23-851" aria-hidden="true" tabindex="-1"></a>\Delta Breadth_{i,t} = \frac{N_{i,t}^{cont} - N_{i,t-1}^{cont}}{TotalInstitutions_{t-1}}</span>
<span id="cb23-852"><a href="#cb23-852" aria-hidden="true" tabindex="-1"></a>$$ {#eq-dbreadth-vn}</span>
<span id="cb23-853"><a href="#cb23-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-854"><a href="#cb23-854" aria-hidden="true" tabindex="-1"></a>where $N_{i,t}^{cont}$ counts only institutions that appear in the disclosure universe in both periods $t$ and $t-1$, following the @lehavy2008investor algorithm. This adjustment is particularly important in Vietnam where:</span>
<span id="cb23-855"><a href="#cb23-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-856"><a href="#cb23-856" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>New funds launch frequently (especially ETFs tracking VN30)</span>
<span id="cb23-857"><a href="#cb23-857" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Foreign funds enter and exit the market</span>
<span id="cb23-858"><a href="#cb23-858" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Domestic securities firms consolidate or spin off asset management divisions</span>
<span id="cb23-859"><a href="#cb23-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-862"><a href="#cb23-862" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-863"><a href="#cb23-863" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-all-metrics</span></span>
<span id="cb23-864"><a href="#cb23-864" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute All Institutional Ownership Metrics for Vietnam"</span></span>
<span id="cb23-865"><a href="#cb23-865" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-866"><a href="#cb23-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-867"><a href="#cb23-867" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-868"><a href="#cb23-868" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Compute All IO Metrics</span></span>
<span id="cb23-869"><a href="#cb23-869" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-870"><a href="#cb23-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-871"><a href="#cb23-871" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_io_metrics_vietnam(ownership: pd.DataFrame,</span>
<span id="cb23-872"><a href="#cb23-872" aria-hidden="true" tabindex="-1"></a>                                ownership_decomp: pd.DataFrame,</span>
<span id="cb23-873"><a href="#cb23-873" aria-hidden="true" tabindex="-1"></a>                                adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-874"><a href="#cb23-874" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-875"><a href="#cb23-875" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute security-level institutional ownership metrics adapted for Vietnam.</span></span>
<span id="cb23-876"><a href="#cb23-876" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-877"><a href="#cb23-877" aria-hidden="true" tabindex="-1"></a><span class="co">    Computes:</span></span>
<span id="cb23-878"><a href="#cb23-878" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Ownership ratios by category (state, foreign, domestic inst, individual)</span></span>
<span id="cb23-879"><a href="#cb23-879" aria-hidden="true" tabindex="-1"></a><span class="co">    2. HHI concentration (total, non-state, foreign-only)</span></span>
<span id="cb23-880"><a href="#cb23-880" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Number of institutional owners (total, foreign, domestic)</span></span>
<span id="cb23-881"><a href="#cb23-881" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Change in breadth (Lehavy-Sloan adjusted)</span></span>
<span id="cb23-882"><a href="#cb23-882" aria-hidden="true" tabindex="-1"></a><span class="co">    5. FOL-related metrics (utilization, room, near-cap indicator)</span></span>
<span id="cb23-883"><a href="#cb23-883" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-884"><a href="#cb23-884" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-885"><a href="#cb23-885" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-886"><a href="#cb23-886" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb23-887"><a href="#cb23-887" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership data with individual shareholder records</span></span>
<span id="cb23-888"><a href="#cb23-888" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership_decomp : pd.DataFrame</span></span>
<span id="cb23-889"><a href="#cb23-889" aria-hidden="true" tabindex="-1"></a><span class="co">        Aggregated ownership decomposition (output of compute_ownership_decomposition)</span></span>
<span id="cb23-890"><a href="#cb23-890" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb23-891"><a href="#cb23-891" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb23-892"><a href="#cb23-892" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-893"><a href="#cb23-893" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-894"><a href="#cb23-894" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-895"><a href="#cb23-895" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-896"><a href="#cb23-896" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock-period level metrics</span></span>
<span id="cb23-897"><a href="#cb23-897" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-898"><a href="#cb23-898" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start with the ownership decomposition</span></span>
<span id="cb23-899"><a href="#cb23-899" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> ownership_decomp.copy()</span>
<span id="cb23-900"><a href="#cb23-900" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-901"><a href="#cb23-901" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- HHI Concentration ---</span></span>
<span id="cb23-902"><a href="#cb23-902" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total HHI: across all institutional shareholders</span></span>
<span id="cb23-903"><a href="#cb23-903" aria-hidden="true" tabindex="-1"></a>    inst_ownership <span class="op">=</span> ownership[</span>
<span id="cb23-904"><a href="#cb23-904" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb23-905"><a href="#cb23-905" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb23-906"><a href="#cb23-906" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-907"><a href="#cb23-907" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_hhi_group(group):</span>
<span id="cb23-908"><a href="#cb23-908" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Compute HHI for a group of shareholders."""</span></span>
<span id="cb23-909"><a href="#cb23-909" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> group[<span class="st">'shares_held'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-910"><a href="#cb23-910" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb23-911"><a href="#cb23-911" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb23-912"><a href="#cb23-912" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">'shares_held'</span>] <span class="op">/</span> total</span>
<span id="cb23-913"><a href="#cb23-913" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb23-914"><a href="#cb23-914" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-915"><a href="#cb23-915" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total institutional HHI</span></span>
<span id="cb23-916"><a href="#cb23-916" aria-hidden="true" tabindex="-1"></a>    hhi_total <span class="op">=</span> (inst_ownership.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-917"><a href="#cb23-917" aria-hidden="true" tabindex="-1"></a>                               .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb23-918"><a href="#cb23-918" aria-hidden="true" tabindex="-1"></a>                               .reset_index(name<span class="op">=</span><span class="st">'hhi_institutional'</span>))</span>
<span id="cb23-919"><a href="#cb23-919" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_total, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-920"><a href="#cb23-920" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-921"><a href="#cb23-921" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Non-state HHI (exclude state shareholders)</span></span>
<span id="cb23-922"><a href="#cb23-922" aria-hidden="true" tabindex="-1"></a>    non_state <span class="op">=</span> ownership[</span>
<span id="cb23-923"><a href="#cb23-923" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin([OwnershipType.FOREIGN_INST, </span>
<span id="cb23-924"><a href="#cb23-924" aria-hidden="true" tabindex="-1"></a>                                       OwnershipType.DOMESTIC_INST])</span>
<span id="cb23-925"><a href="#cb23-925" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-926"><a href="#cb23-926" aria-hidden="true" tabindex="-1"></a>    hhi_nonstate <span class="op">=</span> (non_state.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-927"><a href="#cb23-927" aria-hidden="true" tabindex="-1"></a>                             .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb23-928"><a href="#cb23-928" aria-hidden="true" tabindex="-1"></a>                             .reset_index(name<span class="op">=</span><span class="st">'hhi_non_state'</span>))</span>
<span id="cb23-929"><a href="#cb23-929" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_nonstate, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-930"><a href="#cb23-930" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-931"><a href="#cb23-931" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Foreign-only HHI</span></span>
<span id="cb23-932"><a href="#cb23-932" aria-hidden="true" tabindex="-1"></a>    foreign_only <span class="op">=</span> ownership[ownership[<span class="st">'owner_type'</span>] <span class="op">==</span> OwnershipType.FOREIGN_INST]</span>
<span id="cb23-933"><a href="#cb23-933" aria-hidden="true" tabindex="-1"></a>    hhi_foreign <span class="op">=</span> (foreign_only.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-934"><a href="#cb23-934" aria-hidden="true" tabindex="-1"></a>                               .<span class="bu">apply</span>(compute_hhi_group)</span>
<span id="cb23-935"><a href="#cb23-935" aria-hidden="true" tabindex="-1"></a>                               .reset_index(name<span class="op">=</span><span class="st">'hhi_foreign'</span>))</span>
<span id="cb23-936"><a href="#cb23-936" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.merge(hhi_foreign, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-937"><a href="#cb23-937" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-938"><a href="#cb23-938" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Change in Breadth (Lehavy-Sloan Algorithm) ---</span></span>
<span id="cb23-939"><a href="#cb23-939" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-940"><a href="#cb23-940" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-941"><a href="#cb23-941" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get list of all institutions filing in each period</span></span>
<span id="cb23-942"><a href="#cb23-942" aria-hidden="true" tabindex="-1"></a>    inst_by_period <span class="op">=</span> (inst_ownership.groupby(<span class="st">'date'</span>)[<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-943"><a href="#cb23-943" aria-hidden="true" tabindex="-1"></a>                                     .<span class="bu">apply</span>(<span class="bu">set</span>)</span>
<span id="cb23-944"><a href="#cb23-944" aria-hidden="true" tabindex="-1"></a>                                     .to_dict())</span>
<span id="cb23-945"><a href="#cb23-945" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-946"><a href="#cb23-946" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each stock-period: count continuing institutions</span></span>
<span id="cb23-947"><a href="#cb23-947" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> compute_breadth_change(group):</span>
<span id="cb23-948"><a href="#cb23-948" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-949"><a href="#cb23-949" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'dbreadth'</span>] <span class="op">=</span> np.nan</span>
<span id="cb23-950"><a href="#cb23-950" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-951"><a href="#cb23-951" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(group)):</span>
<span id="cb23-952"><a href="#cb23-952" aria-hidden="true" tabindex="-1"></a>            current_date <span class="op">=</span> group.loc[i, <span class="st">'date'</span>]</span>
<span id="cb23-953"><a href="#cb23-953" aria-hidden="true" tabindex="-1"></a>            prev_date <span class="op">=</span> group.loc[i<span class="op">-</span><span class="dv">1</span>, <span class="st">'date'</span>]</span>
<span id="cb23-954"><a href="#cb23-954" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-955"><a href="#cb23-955" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Institutions in universe for both periods</span></span>
<span id="cb23-956"><a href="#cb23-956" aria-hidden="true" tabindex="-1"></a>            current_universe <span class="op">=</span> inst_by_period.get(current_date, <span class="bu">set</span>())</span>
<span id="cb23-957"><a href="#cb23-957" aria-hidden="true" tabindex="-1"></a>            prev_universe <span class="op">=</span> inst_by_period.get(prev_date, <span class="bu">set</span>())</span>
<span id="cb23-958"><a href="#cb23-958" aria-hidden="true" tabindex="-1"></a>            continuing_universe <span class="op">=</span> current_universe <span class="op">&amp;</span> prev_universe</span>
<span id="cb23-959"><a href="#cb23-959" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-960"><a href="#cb23-960" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(prev_universe) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-961"><a href="#cb23-961" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-962"><a href="#cb23-962" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-963"><a href="#cb23-963" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count continuing institutions holding this stock in each period</span></span>
<span id="cb23-964"><a href="#cb23-964" aria-hidden="true" tabindex="-1"></a>            ticker <span class="op">=</span> group.loc[i, <span class="st">'ticker'</span>]</span>
<span id="cb23-965"><a href="#cb23-965" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-966"><a href="#cb23-966" aria-hidden="true" tabindex="-1"></a>            current_holders <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb23-967"><a href="#cb23-967" aria-hidden="true" tabindex="-1"></a>                inst_ownership[</span>
<span id="cb23-968"><a href="#cb23-968" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span> </span>
<span id="cb23-969"><a href="#cb23-969" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'date'</span>] <span class="op">==</span> current_date)</span>
<span id="cb23-970"><a href="#cb23-970" aria-hidden="true" tabindex="-1"></a>                ][<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-971"><a href="#cb23-971" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-972"><a href="#cb23-972" aria-hidden="true" tabindex="-1"></a>            prev_holders <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb23-973"><a href="#cb23-973" aria-hidden="true" tabindex="-1"></a>                inst_ownership[</span>
<span id="cb23-974"><a href="#cb23-974" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span> </span>
<span id="cb23-975"><a href="#cb23-975" aria-hidden="true" tabindex="-1"></a>                    (inst_ownership[<span class="st">'date'</span>] <span class="op">==</span> prev_date)</span>
<span id="cb23-976"><a href="#cb23-976" aria-hidden="true" tabindex="-1"></a>                ][<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-977"><a href="#cb23-977" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-978"><a href="#cb23-978" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-979"><a href="#cb23-979" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Count only continuing institutions</span></span>
<span id="cb23-980"><a href="#cb23-980" aria-hidden="true" tabindex="-1"></a>            n_current_cont <span class="op">=</span> <span class="bu">len</span>(current_holders <span class="op">&amp;</span> continuing_universe)</span>
<span id="cb23-981"><a href="#cb23-981" aria-hidden="true" tabindex="-1"></a>            n_prev_cont <span class="op">=</span> <span class="bu">len</span>(prev_holders <span class="op">&amp;</span> continuing_universe)</span>
<span id="cb23-982"><a href="#cb23-982" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-983"><a href="#cb23-983" aria-hidden="true" tabindex="-1"></a>            group.loc[i, <span class="st">'dbreadth'</span>] <span class="op">=</span> (</span>
<span id="cb23-984"><a href="#cb23-984" aria-hidden="true" tabindex="-1"></a>                (n_current_cont <span class="op">-</span> n_prev_cont) <span class="op">/</span> <span class="bu">len</span>(prev_universe)</span>
<span id="cb23-985"><a href="#cb23-985" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-986"><a href="#cb23-986" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-987"><a href="#cb23-987" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> group</span>
<span id="cb23-988"><a href="#cb23-988" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-989"><a href="#cb23-989" aria-hidden="true" tabindex="-1"></a>    metrics <span class="op">=</span> metrics.groupby(<span class="st">'ticker'</span>, group_keys<span class="op">=</span><span class="va">False</span>).<span class="bu">apply</span>(compute_breadth_change)</span>
<span id="cb23-990"><a href="#cb23-990" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-991"><a href="#cb23-991" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- FOL Indicators ---</span></span>
<span id="cb23-992"><a href="#cb23-992" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'fol_utilization'</span> <span class="kw">in</span> metrics.columns:</span>
<span id="cb23-993"><a href="#cb23-993" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'near_fol_cap'</span>] <span class="op">=</span> (metrics[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.90</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-994"><a href="#cb23-994" aria-hidden="true" tabindex="-1"></a>        metrics[<span class="st">'at_fol_cap'</span>] <span class="op">=</span> (metrics[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.98</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-995"><a href="#cb23-995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-996"><a href="#cb23-996" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"IO metrics computed for Vietnam:"</span>)</span>
<span id="cb23-997"><a href="#cb23-997" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Observations: </span><span class="sc">{</span><span class="bu">len</span>(metrics)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-998"><a href="#cb23-998" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Key metric distributions:"</span>)</span>
<span id="cb23-999"><a href="#cb23-999" aria-hidden="true" tabindex="-1"></a>    summary_cols <span class="op">=</span> [<span class="st">'pct_institutional'</span>, <span class="st">'pct_state'</span>, <span class="st">'pct_foreign_total'</span>,</span>
<span id="cb23-1000"><a href="#cb23-1000" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'hhi_institutional'</span>, <span class="st">'n_inst_owners'</span>, <span class="st">'dbreadth'</span>]</span>
<span id="cb23-1001"><a href="#cb23-1001" aria-hidden="true" tabindex="-1"></a>    summary_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> summary_cols <span class="cf">if</span> c <span class="kw">in</span> metrics.columns]</span>
<span id="cb23-1002"><a href="#cb23-1002" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(metrics[summary_cols].describe().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb23-1003"><a href="#cb23-1003" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1004"><a href="#cb23-1004" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> metrics</span>
<span id="cb23-1005"><a href="#cb23-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1006"><a href="#cb23-1006" aria-hidden="true" tabindex="-1"></a><span class="co"># io_metrics = compute_io_metrics_vietnam(</span></span>
<span id="cb23-1007"><a href="#cb23-1007" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, ownership_decomp, adj_factors</span></span>
<span id="cb23-1008"><a href="#cb23-1008" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb23-1009"><a href="#cb23-1009" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1010"><a href="#cb23-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1011"><a href="#cb23-1011" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Series Visualization</span></span>
<span id="cb23-1012"><a href="#cb23-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1015"><a href="#cb23-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1016"><a href="#cb23-1016" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-io-timeseries-vn</span></span>
<span id="cb23-1017"><a href="#cb23-1017" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Time Series of Ownership Structure in Vietnamese Listed Companies. Panel A shows the evolution of ownership composition across all HOSE/HNX stocks. Panel B decomposes institutional ownership by foreign vs domestic components. The decline in state ownership reflects Vietnam's ongoing equitization program, while the growth in foreign institutional ownership tracks the market's progressive opening to international investors."</span></span>
<span id="cb23-1018"><a href="#cb23-1018" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 12</span></span>
<span id="cb23-1019"><a href="#cb23-1019" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1020"><a href="#cb23-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1021"><a href="#cb23-1021" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_ownership_timeseries_vietnam(metrics: pd.DataFrame):</span>
<span id="cb23-1022"><a href="#cb23-1022" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1023"><a href="#cb23-1023" aria-hidden="true" tabindex="-1"></a><span class="co">    Create publication-quality time series plots of Vietnamese </span></span>
<span id="cb23-1024"><a href="#cb23-1024" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership structure evolution.</span></span>
<span id="cb23-1025"><a href="#cb23-1025" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1026"><a href="#cb23-1026" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">3</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">14</span>))</span>
<span id="cb23-1027"><a href="#cb23-1027" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1028"><a href="#cb23-1028" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate across all stocks (market-cap weighted)</span></span>
<span id="cb23-1029"><a href="#cb23-1029" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> metrics.groupby(<span class="st">'quarter_end'</span>).<span class="bu">apply</span>(</span>
<span id="cb23-1030"><a href="#cb23-1030" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: pd.Series({</span>
<span id="cb23-1031"><a href="#cb23-1031" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_state'</span>: np.average(g[<span class="st">'pct_state'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb23-1032"><a href="#cb23-1032" aria-hidden="true" tabindex="-1"></a>                                     weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb23-1033"><a href="#cb23-1033" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_foreign'</span>: np.average(g[<span class="st">'pct_foreign_total'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb23-1034"><a href="#cb23-1034" aria-hidden="true" tabindex="-1"></a>                                       weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb23-1035"><a href="#cb23-1035" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_domestic_inst'</span>: np.average(g[<span class="st">'pct_domestic_inst'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb23-1036"><a href="#cb23-1036" aria-hidden="true" tabindex="-1"></a>                                             weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb23-1037"><a href="#cb23-1037" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_individual'</span>: np.average(g[<span class="st">'pct_individual'</span>].fillna(<span class="dv">0</span>), </span>
<span id="cb23-1038"><a href="#cb23-1038" aria-hidden="true" tabindex="-1"></a>                                          weights<span class="op">=</span>g[<span class="st">'market_cap'</span>].fillna(<span class="dv">1</span>)),</span>
<span id="cb23-1039"><a href="#cb23-1039" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_stocks'</span>: g[<span class="st">'ticker'</span>].nunique(),</span>
<span id="cb23-1040"><a href="#cb23-1040" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total_mktcap'</span>: g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>(),</span>
<span id="cb23-1041"><a href="#cb23-1041" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_n_inst'</span>: g[<span class="st">'n_inst_owners'</span>].median(),</span>
<span id="cb23-1042"><a href="#cb23-1042" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_hhi'</span>: g[<span class="st">'hhi_institutional'</span>].median(),</span>
<span id="cb23-1043"><a href="#cb23-1043" aria-hidden="true" tabindex="-1"></a>            <span class="st">'pct_soe'</span>: g[<span class="st">'is_soe'</span>].mean(),</span>
<span id="cb23-1044"><a href="#cb23-1044" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-1045"><a href="#cb23-1045" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-1046"><a href="#cb23-1046" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1047"><a href="#cb23-1047" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel A: Ownership Composition (Stacked Area) ----</span></span>
<span id="cb23-1048"><a href="#cb23-1048" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb23-1049"><a href="#cb23-1049" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> ts[<span class="st">'quarter_end'</span>]</span>
<span id="cb23-1050"><a href="#cb23-1050" aria-hidden="true" tabindex="-1"></a>    ax.stackplot(dates,</span>
<span id="cb23-1051"><a href="#cb23-1051" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_state'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1052"><a href="#cb23-1052" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_foreign'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1053"><a href="#cb23-1053" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_domestic_inst'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1054"><a href="#cb23-1054" aria-hidden="true" tabindex="-1"></a>                 ts[<span class="st">'pct_individual'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1055"><a href="#cb23-1055" aria-hidden="true" tabindex="-1"></a>                 labels<span class="op">=</span>[<span class="st">'State'</span>, <span class="st">'Foreign Institutional'</span>, </span>
<span id="cb23-1056"><a href="#cb23-1056" aria-hidden="true" tabindex="-1"></a>                         <span class="st">'Domestic Institutional'</span>, <span class="st">'Individual'</span>],</span>
<span id="cb23-1057"><a href="#cb23-1057" aria-hidden="true" tabindex="-1"></a>                 colors<span class="op">=</span>[OWNER_COLORS[<span class="st">'State'</span>], OWNER_COLORS[<span class="st">'Foreign Institutional'</span>],</span>
<span id="cb23-1058"><a href="#cb23-1058" aria-hidden="true" tabindex="-1"></a>                         OWNER_COLORS[<span class="st">'Domestic Institutional'</span>], OWNER_COLORS[<span class="st">'Individual'</span>]],</span>
<span id="cb23-1059"><a href="#cb23-1059" aria-hidden="true" tabindex="-1"></a>                 alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb23-1060"><a href="#cb23-1060" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Ownership Share (%)'</span>)</span>
<span id="cb23-1061"><a href="#cb23-1061" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel A: Ownership Composition of Vietnamese Listed Companies '</span></span>
<span id="cb23-1062"><a href="#cb23-1062" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'(Market-Cap Weighted)'</span>)</span>
<span id="cb23-1063"><a href="#cb23-1063" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb23-1064"><a href="#cb23-1064" aria-hidden="true" tabindex="-1"></a>    ax.set_ylim(<span class="dv">0</span>, <span class="dv">100</span>)</span>
<span id="cb23-1065"><a href="#cb23-1065" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1066"><a href="#cb23-1066" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel B: Institutional Ownership by Component ----</span></span>
<span id="cb23-1067"><a href="#cb23-1067" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb23-1068"><a href="#cb23-1068" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_state'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'State'</span>,</span>
<span id="cb23-1069"><a href="#cb23-1069" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'State'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-1070"><a href="#cb23-1070" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_foreign'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'Foreign Institutional'</span>,</span>
<span id="cb23-1071"><a href="#cb23-1071" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Foreign Institutional'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-1072"><a href="#cb23-1072" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'pct_domestic_inst'</span>] <span class="op">*</span> <span class="dv">100</span>, label<span class="op">=</span><span class="st">'Domestic Institutional'</span>,</span>
<span id="cb23-1073"><a href="#cb23-1073" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Domestic Institutional'</span>], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb23-1074"><a href="#cb23-1074" aria-hidden="true" tabindex="-1"></a>    total_inst <span class="op">=</span> (ts[<span class="st">'pct_state'</span>] <span class="op">+</span> ts[<span class="st">'pct_foreign'</span>] <span class="op">+</span> ts[<span class="st">'pct_domestic_inst'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-1075"><a href="#cb23-1075" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, total_inst, label<span class="op">=</span><span class="st">'Total Institutional'</span>,</span>
<span id="cb23-1076"><a href="#cb23-1076" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>OWNER_COLORS[<span class="st">'Total Institutional'</span>], linewidth<span class="op">=</span><span class="fl">2.5</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb23-1077"><a href="#cb23-1077" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Ownership Ratio (%)'</span>)</span>
<span id="cb23-1078"><a href="#cb23-1078" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel B: Institutional Ownership Components'</span>)</span>
<span id="cb23-1079"><a href="#cb23-1079" aria-hidden="true" tabindex="-1"></a>    ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb23-1080"><a href="#cb23-1080" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1081"><a href="#cb23-1081" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Panel C: Market Structure ----</span></span>
<span id="cb23-1082"><a href="#cb23-1082" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">2</span>]</span>
<span id="cb23-1083"><a href="#cb23-1083" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> ax.twinx()</span>
<span id="cb23-1084"><a href="#cb23-1084" aria-hidden="true" tabindex="-1"></a>    ax.plot(dates, ts[<span class="st">'n_stocks'</span>], color<span class="op">=</span><span class="st">'#1f77b4'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'# Listed Stocks'</span>)</span>
<span id="cb23-1085"><a href="#cb23-1085" aria-hidden="true" tabindex="-1"></a>    ax2.plot(dates, ts[<span class="st">'total_mktcap'</span>] <span class="op">/</span> <span class="dv">1000</span>, color<span class="op">=</span><span class="st">'#d62728'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, </span>
<span id="cb23-1086"><a href="#cb23-1086" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Total Market Cap (Trillion VND)'</span>)</span>
<span id="cb23-1087"><a href="#cb23-1087" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Number of Listed Stocks'</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>)</span>
<span id="cb23-1088"><a href="#cb23-1088" aria-hidden="true" tabindex="-1"></a>    ax2.set_ylabel(<span class="st">'Market Cap (Trillion VND)'</span>, color<span class="op">=</span><span class="st">'#d62728'</span>)</span>
<span id="cb23-1089"><a href="#cb23-1089" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel C: Vietnamese Stock Market Development'</span>)</span>
<span id="cb23-1090"><a href="#cb23-1090" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1091"><a href="#cb23-1091" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine legends</span></span>
<span id="cb23-1092"><a href="#cb23-1092" aria-hidden="true" tabindex="-1"></a>    lines1, labels1 <span class="op">=</span> ax.get_legend_handles_labels()</span>
<span id="cb23-1093"><a href="#cb23-1093" aria-hidden="true" tabindex="-1"></a>    lines2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb23-1094"><a href="#cb23-1094" aria-hidden="true" tabindex="-1"></a>    ax.legend(lines1 <span class="op">+</span> lines2, labels1 <span class="op">+</span> labels2, loc<span class="op">=</span><span class="st">'upper left'</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb23-1095"><a href="#cb23-1095" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1096"><a href="#cb23-1096" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb23-1097"><a href="#cb23-1097" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_ownership_timeseries_vn.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb23-1098"><a href="#cb23-1098" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb23-1099"><a href="#cb23-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1100"><a href="#cb23-1100" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_ownership_timeseries_vietnam(io_metrics)</span></span>
<span id="cb23-1101"><a href="#cb23-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1102"><a href="#cb23-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1105"><a href="#cb23-1105" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1106"><a href="#cb23-1106" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-io-by-exchange</span></span>
<span id="cb23-1107"><a href="#cb23-1107" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Mean Institutional Ownership by Exchange and Size Quintile. HOSE-listed firms attract significantly more institutional (especially foreign) ownership than HNX or UPCOM firms, consistent with size, liquidity, and governance quality differences across exchanges."</span></span>
<span id="cb23-1108"><a href="#cb23-1108" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1109"><a href="#cb23-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1110"><a href="#cb23-1110" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_io_by_exchange_size(metrics: pd.DataFrame):</span>
<span id="cb23-1111"><a href="#cb23-1111" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot IO ratios by exchange and size quintile."""</span></span>
<span id="cb23-1112"><a href="#cb23-1112" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[metrics[<span class="st">'market_cap'</span>].notna() <span class="op">&amp;</span> (metrics[<span class="st">'market_cap'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)].copy()</span>
<span id="cb23-1113"><a href="#cb23-1113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1114"><a href="#cb23-1114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Size quintiles within each quarter</span></span>
<span id="cb23-1115"><a href="#cb23-1115" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'size_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'market_cap'</span>].transform(</span>
<span id="cb23-1116"><a href="#cb23-1116" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="st">'Q1</span><span class="ch">\n</span><span class="st">(Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5</span><span class="ch">\n</span><span class="st">(Large)'</span>],</span>
<span id="cb23-1117"><a href="#cb23-1117" aria-hidden="true" tabindex="-1"></a>                          duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb23-1118"><a href="#cb23-1118" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1119"><a href="#cb23-1119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1120"><a href="#cb23-1120" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">5</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-1121"><a href="#cb23-1121" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1122"><a href="#cb23-1122" aria-hidden="true" tabindex="-1"></a>    metrics_to_plot <span class="op">=</span> [</span>
<span id="cb23-1123"><a href="#cb23-1123" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_institutional'</span>, <span class="st">'Total Institutional'</span>),</span>
<span id="cb23-1124"><a href="#cb23-1124" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_foreign_total'</span>, <span class="st">'Foreign Institutional'</span>),</span>
<span id="cb23-1125"><a href="#cb23-1125" aria-hidden="true" tabindex="-1"></a>        (<span class="st">'pct_state'</span>, <span class="st">'State'</span>),</span>
<span id="cb23-1126"><a href="#cb23-1126" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-1127"><a href="#cb23-1127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1128"><a href="#cb23-1128" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ax, (col, title) <span class="kw">in</span> <span class="bu">zip</span>(axes, metrics_to_plot):</span>
<span id="cb23-1129"><a href="#cb23-1129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> exchange, color <span class="kw">in</span> EXCHANGE_COLORS.items():</span>
<span id="cb23-1130"><a href="#cb23-1130" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> df[df[<span class="st">'exchange'</span>] <span class="op">==</span> exchange]</span>
<span id="cb23-1131"><a href="#cb23-1131" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-1132"><a href="#cb23-1132" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-1133"><a href="#cb23-1133" aria-hidden="true" tabindex="-1"></a>            means <span class="op">=</span> data.groupby(<span class="st">'size_quintile'</span>)[col].mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-1134"><a href="#cb23-1134" aria-hidden="true" tabindex="-1"></a>            ax.bar(np.arange(<span class="bu">len</span>(means)) <span class="op">+</span> <span class="bu">list</span>(EXCHANGE_COLORS.keys()).index(exchange) <span class="op">*</span> <span class="fl">0.25</span>,</span>
<span id="cb23-1135"><a href="#cb23-1135" aria-hidden="true" tabindex="-1"></a>                   means, width<span class="op">=</span><span class="fl">0.25</span>, label<span class="op">=</span>exchange, color<span class="op">=</span>color, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb23-1136"><a href="#cb23-1136" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1137"><a href="#cb23-1137" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb23-1138"><a href="#cb23-1138" aria-hidden="true" tabindex="-1"></a>        ax.set_xlabel(<span class="st">'Size Quintile'</span>)</span>
<span id="cb23-1139"><a href="#cb23-1139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> ax <span class="op">==</span> axes[<span class="dv">0</span>]:</span>
<span id="cb23-1140"><a href="#cb23-1140" aria-hidden="true" tabindex="-1"></a>            ax.set_ylabel(<span class="st">'Mean Ownership (%)'</span>)</span>
<span id="cb23-1141"><a href="#cb23-1141" aria-hidden="true" tabindex="-1"></a>        ax.legend()</span>
<span id="cb23-1142"><a href="#cb23-1142" aria-hidden="true" tabindex="-1"></a>        ax.set_xticks(np.arange(<span class="dv">5</span>) <span class="op">+</span> <span class="fl">0.25</span>)</span>
<span id="cb23-1143"><a href="#cb23-1143" aria-hidden="true" tabindex="-1"></a>        ax.set_xticklabels([<span class="st">'Q1</span><span class="ch">\n</span><span class="st">(Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5</span><span class="ch">\n</span><span class="st">(Large)'</span>])</span>
<span id="cb23-1144"><a href="#cb23-1144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1145"><a href="#cb23-1145" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb23-1146"><a href="#cb23-1146" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_io_by_exchange_size.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb23-1147"><a href="#cb23-1147" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb23-1148"><a href="#cb23-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1149"><a href="#cb23-1149" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_io_by_exchange_size(io_metrics)</span></span>
<span id="cb23-1150"><a href="#cb23-1150" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1151"><a href="#cb23-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1154"><a href="#cb23-1154" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1155"><a href="#cb23-1155" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-io-summary</span></span>
<span id="cb23-1156"><a href="#cb23-1156" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary Statistics of Ownership Structure in Vietnam by Size Quintile and Exchange (Pooled 2010-2024)"</span></span>
<span id="cb23-1157"><a href="#cb23-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1158"><a href="#cb23-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1159"><a href="#cb23-1159" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> tabulate_io_summary(metrics: pd.DataFrame, start_year: <span class="bu">int</span> <span class="op">=</span> <span class="dv">2010</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-1160"><a href="#cb23-1160" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1161"><a href="#cb23-1161" aria-hidden="true" tabindex="-1"></a><span class="co">    Create publication-quality summary table of Vietnamese ownership</span></span>
<span id="cb23-1162"><a href="#cb23-1162" aria-hidden="true" tabindex="-1"></a><span class="co">    structure by firm size.</span></span>
<span id="cb23-1163"><a href="#cb23-1163" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1164"><a href="#cb23-1164" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[</span>
<span id="cb23-1165"><a href="#cb23-1165" aria-hidden="true" tabindex="-1"></a>        (metrics[<span class="st">'quarter_end'</span>].dt.year <span class="op">&gt;=</span> start_year) <span class="op">&amp;</span></span>
<span id="cb23-1166"><a href="#cb23-1166" aria-hidden="true" tabindex="-1"></a>        (metrics[<span class="st">'market_cap'</span>].notna()) <span class="op">&amp;</span> (metrics[<span class="st">'market_cap'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb23-1167"><a href="#cb23-1167" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb23-1168"><a href="#cb23-1168" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1169"><a href="#cb23-1169" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'size_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'market_cap'</span>].transform(</span>
<span id="cb23-1170"><a href="#cb23-1170" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="st">'Q1 (Small)'</span>, <span class="st">'Q2'</span>, <span class="st">'Q3'</span>, <span class="st">'Q4'</span>, <span class="st">'Q5 (Large)'</span>],</span>
<span id="cb23-1171"><a href="#cb23-1171" aria-hidden="true" tabindex="-1"></a>                          duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb23-1172"><a href="#cb23-1172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1173"><a href="#cb23-1173" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1174"><a href="#cb23-1174" aria-hidden="true" tabindex="-1"></a>    table <span class="op">=</span> df.groupby(<span class="st">'size_quintile'</span>).agg(</span>
<span id="cb23-1175"><a href="#cb23-1175" aria-hidden="true" tabindex="-1"></a>        N<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'count'</span>),</span>
<span id="cb23-1176"><a href="#cb23-1176" aria-hidden="true" tabindex="-1"></a>        Mean_MktCap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1177"><a href="#cb23-1177" aria-hidden="true" tabindex="-1"></a>        Mean_IO_Total<span class="op">=</span>(<span class="st">'pct_institutional'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1178"><a href="#cb23-1178" aria-hidden="true" tabindex="-1"></a>        Mean_State<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1179"><a href="#cb23-1179" aria-hidden="true" tabindex="-1"></a>        Mean_Foreign<span class="op">=</span>(<span class="st">'pct_foreign_total'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1180"><a href="#cb23-1180" aria-hidden="true" tabindex="-1"></a>        Mean_Domestic_Inst<span class="op">=</span>(<span class="st">'pct_domestic_inst'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1181"><a href="#cb23-1181" aria-hidden="true" tabindex="-1"></a>        Mean_Individual<span class="op">=</span>(<span class="st">'pct_individual'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1182"><a href="#cb23-1182" aria-hidden="true" tabindex="-1"></a>        Median_N_Owners<span class="op">=</span>(<span class="st">'n_inst_owners'</span>, <span class="st">'median'</span>),</span>
<span id="cb23-1183"><a href="#cb23-1183" aria-hidden="true" tabindex="-1"></a>        Median_HHI<span class="op">=</span>(<span class="st">'hhi_institutional'</span>, <span class="st">'median'</span>),</span>
<span id="cb23-1184"><a href="#cb23-1184" aria-hidden="true" tabindex="-1"></a>        Pct_SOE<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1185"><a href="#cb23-1185" aria-hidden="true" tabindex="-1"></a>        Mean_FOL_Util<span class="op">=</span>(<span class="st">'fol_utilization'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1186"><a href="#cb23-1186" aria-hidden="true" tabindex="-1"></a>    ).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb23-1187"><a href="#cb23-1187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1188"><a href="#cb23-1188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format</span></span>
<span id="cb23-1189"><a href="#cb23-1189" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'N'</span>] <span class="op">=</span> table[<span class="st">'N'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-1190"><a href="#cb23-1190" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Mean_MktCap'</span>] <span class="op">=</span> table[<span class="st">'Mean_MktCap'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:,.0f}</span><span class="ss">B VND"</span>)</span>
<span id="cb23-1191"><a href="#cb23-1191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'Mean_IO_Total'</span>, <span class="st">'Mean_State'</span>, <span class="st">'Mean_Foreign'</span>, </span>
<span id="cb23-1192"><a href="#cb23-1192" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Mean_Domestic_Inst'</span>, <span class="st">'Mean_Individual'</span>, <span class="st">'Pct_SOE'</span>, <span class="st">'Mean_FOL_Util'</span>]:</span>
<span id="cb23-1193"><a href="#cb23-1193" aria-hidden="true" tabindex="-1"></a>        table[col] <span class="op">=</span> table[col].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.1%}</span><span class="ss">"</span> <span class="cf">if</span> pd.notna(x) <span class="cf">else</span> <span class="st">"—"</span>)</span>
<span id="cb23-1194"><a href="#cb23-1194" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Median_N_Owners'</span>] <span class="op">=</span> table[<span class="st">'Median_N_Owners'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-1195"><a href="#cb23-1195" aria-hidden="true" tabindex="-1"></a>    table[<span class="st">'Median_HHI'</span>] <span class="op">=</span> table[<span class="st">'Median_HHI'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:.3f}</span><span class="ss">"</span> <span class="cf">if</span> pd.notna(x) <span class="cf">else</span> <span class="st">"—"</span>)</span>
<span id="cb23-1196"><a href="#cb23-1196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1197"><a href="#cb23-1197" aria-hidden="true" tabindex="-1"></a>    table.columns <span class="op">=</span> [<span class="st">'N'</span>, <span class="st">'Mean Mkt Cap'</span>, <span class="st">'IO Total'</span>, <span class="st">'State'</span>, <span class="st">'Foreign'</span>, </span>
<span id="cb23-1198"><a href="#cb23-1198" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'Dom. Inst.'</span>, <span class="st">'Individual'</span>, <span class="st">'Med. # Owners'</span>, </span>
<span id="cb23-1199"><a href="#cb23-1199" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'Med. HHI'</span>, <span class="st">'% SOE'</span>, <span class="st">'FOL Util.'</span>]</span>
<span id="cb23-1200"><a href="#cb23-1200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1201"><a href="#cb23-1201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> table</span>
<span id="cb23-1202"><a href="#cb23-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1203"><a href="#cb23-1203" aria-hidden="true" tabindex="-1"></a><span class="co"># io_summary = tabulate_io_summary(io_metrics)</span></span>
<span id="cb23-1204"><a href="#cb23-1204" aria-hidden="true" tabindex="-1"></a><span class="co"># print(io_summary.to_string())</span></span>
<span id="cb23-1205"><a href="#cb23-1205" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1206"><a href="#cb23-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1207"><a href="#cb23-1207" aria-hidden="true" tabindex="-1"></a>------------------------------------------------------------------------</span>
<span id="cb23-1208"><a href="#cb23-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1209"><a href="#cb23-1209" aria-hidden="true" tabindex="-1"></a><span class="fu">## Foreign Ownership Dynamics {#sec-foreign-ownership}</span></span>
<span id="cb23-1210"><a href="#cb23-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1211"><a href="#cb23-1211" aria-hidden="true" tabindex="-1"></a><span class="fu">### Foreign Ownership Limits and the FOL Premium {#sec-fol}</span></span>
<span id="cb23-1212"><a href="#cb23-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1213"><a href="#cb23-1213" aria-hidden="true" tabindex="-1"></a>Vietnam's Foreign Ownership Limits create a unique market segmentation. When a stock reaches its FOL, the only way for a new foreign investor to buy is if an existing foreign holder sells. This creates a de facto "foreign-only" market for FOL-constrained stocks, with documented price premiums <span class="co">[</span><span class="ot">@vo2015foreign</span><span class="co">]</span>.</span>
<span id="cb23-1214"><a href="#cb23-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1215"><a href="#cb23-1215" aria-hidden="true" tabindex="-1"></a>The **FOL Utilization Ratio** for stock $i$ at time $t$ is:</span>
<span id="cb23-1216"><a href="#cb23-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1217"><a href="#cb23-1217" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-1218"><a href="#cb23-1218" aria-hidden="true" tabindex="-1"></a>FOL<span class="sc">\_</span>Util_{i,t} = \frac{ForeignOwnership_{i,t}}{FOL<span class="sc">\_</span>Limit_i}</span>
<span id="cb23-1219"><a href="#cb23-1219" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fol-util}</span>
<span id="cb23-1220"><a href="#cb23-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1221"><a href="#cb23-1221" aria-hidden="true" tabindex="-1"></a>Stocks are classified by FOL proximity (@tbl-fol-zones).</span>
<span id="cb23-1222"><a href="#cb23-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1223"><a href="#cb23-1223" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> FOL Zone   <span class="pp">|</span> Utilization Range <span class="pp">|</span> Market Implication                            <span class="pp">|</span></span>
<span id="cb23-1224"><a href="#cb23-1224" aria-hidden="true" tabindex="-1"></a><span class="pp">|:------------------|:------------------|:-----------------------------------|</span></span>
<span id="cb23-1225"><a href="#cb23-1225" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Green**  <span class="pp">|</span> <span class="sc">\&lt;</span> 50%            <span class="pp">|</span> Ample foreign room; normal trading            <span class="pp">|</span></span>
<span id="cb23-1226"><a href="#cb23-1226" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Yellow** <span class="pp">|</span> 50-80%            <span class="pp">|</span> Moderate room; some foreign interest pressure <span class="pp">|</span></span>
<span id="cb23-1227"><a href="#cb23-1227" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Orange** <span class="pp">|</span> 80-95%            <span class="pp">|</span> Limited room; foreign premium emerging        <span class="pp">|</span></span>
<span id="cb23-1228"><a href="#cb23-1228" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Red**    <span class="pp">|</span> 95-100%           <span class="pp">|</span> Near cap; significant foreign premium         <span class="pp">|</span></span>
<span id="cb23-1229"><a href="#cb23-1229" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> **Capped** <span class="pp">|</span> ≈ 100%            <span class="pp">|</span> At limit; foreign-only secondary market       <span class="pp">|</span></span>
<span id="cb23-1230"><a href="#cb23-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1231"><a href="#cb23-1231" aria-hidden="true" tabindex="-1"></a>: FOL Proximity Zones {#tbl-fol-zones}</span>
<span id="cb23-1232"><a href="#cb23-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1235"><a href="#cb23-1235" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1236"><a href="#cb23-1236" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fol-analysis</span></span>
<span id="cb23-1237"><a href="#cb23-1237" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Comprehensive Foreign Ownership Limit Analysis"</span></span>
<span id="cb23-1238"><a href="#cb23-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1239"><a href="#cb23-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1240"><a href="#cb23-1240" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1241"><a href="#cb23-1241" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: Foreign Ownership Limit Analysis</span></span>
<span id="cb23-1242"><a href="#cb23-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1243"><a href="#cb23-1243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1244"><a href="#cb23-1244" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FOLAnalyzer:</span>
<span id="cb23-1245"><a href="#cb23-1245" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1246"><a href="#cb23-1246" aria-hidden="true" tabindex="-1"></a><span class="co">    Analyze Foreign Ownership Limit dynamics in the Vietnamese market.</span></span>
<span id="cb23-1247"><a href="#cb23-1247" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1248"><a href="#cb23-1248" aria-hidden="true" tabindex="-1"></a><span class="co">    Key analyses:</span></span>
<span id="cb23-1249"><a href="#cb23-1249" aria-hidden="true" tabindex="-1"></a><span class="co">    1. FOL utilization tracking and classification</span></span>
<span id="cb23-1250"><a href="#cb23-1250" aria-hidden="true" tabindex="-1"></a><span class="co">    2. FOL premium estimation (price impact of being near cap)</span></span>
<span id="cb23-1251"><a href="#cb23-1251" aria-hidden="true" tabindex="-1"></a><span class="co">    3. Foreign room dynamics (opening/closing events)</span></span>
<span id="cb23-1252"><a href="#cb23-1252" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Cross-sectional determinants of foreign ownership</span></span>
<span id="cb23-1253"><a href="#cb23-1253" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1254"><a href="#cb23-1254" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1255"><a href="#cb23-1255" aria-hidden="true" tabindex="-1"></a>    FOL_ZONES <span class="op">=</span> {</span>
<span id="cb23-1256"><a href="#cb23-1256" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Green'</span>: (<span class="dv">0</span>, <span class="fl">0.50</span>),</span>
<span id="cb23-1257"><a href="#cb23-1257" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Yellow'</span>: (<span class="fl">0.50</span>, <span class="fl">0.80</span>),</span>
<span id="cb23-1258"><a href="#cb23-1258" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Orange'</span>: (<span class="fl">0.80</span>, <span class="fl">0.95</span>),</span>
<span id="cb23-1259"><a href="#cb23-1259" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Red'</span>: (<span class="fl">0.95</span>, <span class="fl">1.00</span>),</span>
<span id="cb23-1260"><a href="#cb23-1260" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Capped'</span>: (<span class="fl">1.00</span>, <span class="fl">1.50</span>),</span>
<span id="cb23-1261"><a href="#cb23-1261" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1262"><a href="#cb23-1262" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1263"><a href="#cb23-1263" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, io_metrics: pd.DataFrame,</span>
<span id="cb23-1264"><a href="#cb23-1264" aria-hidden="true" tabindex="-1"></a>                 foreign_daily: Optional[pd.DataFrame] <span class="op">=</span> <span class="va">None</span>):</span>
<span id="cb23-1265"><a href="#cb23-1265" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-1266"><a href="#cb23-1266" aria-hidden="true" tabindex="-1"></a><span class="co">        Parameters</span></span>
<span id="cb23-1267"><a href="#cb23-1267" aria-hidden="true" tabindex="-1"></a><span class="co">        ----------</span></span>
<span id="cb23-1268"><a href="#cb23-1268" aria-hidden="true" tabindex="-1"></a><span class="co">        io_metrics : pd.DataFrame</span></span>
<span id="cb23-1269"><a href="#cb23-1269" aria-hidden="true" tabindex="-1"></a><span class="co">            Full ownership metrics from compute_io_metrics_vietnam()</span></span>
<span id="cb23-1270"><a href="#cb23-1270" aria-hidden="true" tabindex="-1"></a><span class="co">        foreign_daily : pd.DataFrame, optional</span></span>
<span id="cb23-1271"><a href="#cb23-1271" aria-hidden="true" tabindex="-1"></a><span class="co">            Daily foreign ownership tracking from DataCore.vn</span></span>
<span id="cb23-1272"><a href="#cb23-1272" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-1273"><a href="#cb23-1273" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metrics <span class="op">=</span> io_metrics.copy()</span>
<span id="cb23-1274"><a href="#cb23-1274" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.foreign_daily <span class="op">=</span> foreign_daily</span>
<span id="cb23-1275"><a href="#cb23-1275" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1276"><a href="#cb23-1276" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> classify_fol_zones(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-1277"><a href="#cb23-1277" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Classify stocks into FOL proximity zones."""</span></span>
<span id="cb23-1278"><a href="#cb23-1278" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span>.metrics.copy()</span>
<span id="cb23-1279"><a href="#cb23-1279" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1280"><a href="#cb23-1280" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'fol_utilization'</span> <span class="kw">not</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-1281"><a href="#cb23-1281" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"FOL utilization not available in metrics."</span>)</span>
<span id="cb23-1282"><a href="#cb23-1282" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> df</span>
<span id="cb23-1283"><a href="#cb23-1283" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1284"><a href="#cb23-1284" aria-hidden="true" tabindex="-1"></a>        conditions <span class="op">=</span> []</span>
<span id="cb23-1285"><a href="#cb23-1285" aria-hidden="true" tabindex="-1"></a>        choices <span class="op">=</span> []</span>
<span id="cb23-1286"><a href="#cb23-1286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> zone, (lo, hi) <span class="kw">in</span> <span class="va">self</span>.FOL_ZONES.items():</span>
<span id="cb23-1287"><a href="#cb23-1287" aria-hidden="true" tabindex="-1"></a>            conditions.append(</span>
<span id="cb23-1288"><a href="#cb23-1288" aria-hidden="true" tabindex="-1"></a>                (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;=</span> lo) <span class="op">&amp;</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&lt;</span> hi)</span>
<span id="cb23-1289"><a href="#cb23-1289" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-1290"><a href="#cb23-1290" aria-hidden="true" tabindex="-1"></a>            choices.append(zone)</span>
<span id="cb23-1291"><a href="#cb23-1291" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1292"><a href="#cb23-1292" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'fol_zone'</span>] <span class="op">=</span> np.select(conditions, choices, default<span class="op">=</span><span class="st">'Unknown'</span>)</span>
<span id="cb23-1293"><a href="#cb23-1293" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1294"><a href="#cb23-1294" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Summary</span></span>
<span id="cb23-1295"><a href="#cb23-1295" aria-hidden="true" tabindex="-1"></a>        zone_dist <span class="op">=</span> df.groupby(<span class="st">'fol_zone'</span>)[<span class="st">'ticker'</span>].nunique()</span>
<span id="cb23-1296"><a href="#cb23-1296" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"FOL Zone Distribution (unique stocks):"</span>)</span>
<span id="cb23-1297"><a href="#cb23-1297" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(zone_dist.to_string())</span>
<span id="cb23-1298"><a href="#cb23-1298" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1299"><a href="#cb23-1299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df</span>
<span id="cb23-1300"><a href="#cb23-1300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1301"><a href="#cb23-1301" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> estimate_fol_premium(<span class="va">self</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-1302"><a href="#cb23-1302" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-1303"><a href="#cb23-1303" aria-hidden="true" tabindex="-1"></a><span class="co">        Estimate the FOL premium using a cross-sectional approach.</span></span>
<span id="cb23-1304"><a href="#cb23-1304" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb23-1305"><a href="#cb23-1305" aria-hidden="true" tabindex="-1"></a><span class="co">        For each period, regress stock valuations (P/B or P/E) on FOL </span></span>
<span id="cb23-1306"><a href="#cb23-1306" aria-hidden="true" tabindex="-1"></a><span class="co">        utilization, controlling for fundamentals. The coefficient on </span></span>
<span id="cb23-1307"><a href="#cb23-1307" aria-hidden="true" tabindex="-1"></a><span class="co">        FOL utilization captures the premium investors pay for stocks </span></span>
<span id="cb23-1308"><a href="#cb23-1308" aria-hidden="true" tabindex="-1"></a><span class="co">        near their foreign ownership cap.</span></span>
<span id="cb23-1309"><a href="#cb23-1309" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb23-1310"><a href="#cb23-1310" aria-hidden="true" tabindex="-1"></a><span class="co">        Alternative: Compare returns of stocks transitioning between </span></span>
<span id="cb23-1311"><a href="#cb23-1311" aria-hidden="true" tabindex="-1"></a><span class="co">        FOL zones as a natural experiment.</span></span>
<span id="cb23-1312"><a href="#cb23-1312" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-1313"><a href="#cb23-1313" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span>.metrics.copy()</span>
<span id="cb23-1314"><a href="#cb23-1314" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">'fol_utilization'</span>].notna() <span class="op">&amp;</span> df[<span class="st">'market_cap'</span>].notna()].copy()</span>
<span id="cb23-1315"><a href="#cb23-1315" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1316"><a href="#cb23-1316" aria-hidden="true" tabindex="-1"></a>        <span class="co"># FOL zone dummies</span></span>
<span id="cb23-1317"><a href="#cb23-1317" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'near_cap'</span>] <span class="op">=</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.90</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-1318"><a href="#cb23-1318" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'at_cap'</span>] <span class="op">=</span> (df[<span class="st">'fol_utilization'</span>] <span class="op">&gt;</span> <span class="fl">0.98</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-1319"><a href="#cb23-1319" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1320"><a href="#cb23-1320" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price-to-book as valuation measure</span></span>
<span id="cb23-1321"><a href="#cb23-1321" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (Assumes 'equity' is available from financial data)</span></span>
<span id="cb23-1322"><a href="#cb23-1322" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'equity'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-1323"><a href="#cb23-1323" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'pb_ratio'</span>] <span class="op">=</span> df[<span class="st">'market_cap'</span>] <span class="op">*</span> <span class="fl">1e9</span> <span class="op">/</span> df[<span class="st">'equity'</span>]</span>
<span id="cb23-1324"><a href="#cb23-1324" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-1325"><a href="#cb23-1325" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use market cap as proxy for cross-sectional analysis</span></span>
<span id="cb23-1326"><a href="#cb23-1326" aria-hidden="true" tabindex="-1"></a>            df[<span class="st">'log_mktcap'</span>] <span class="op">=</span> np.log(df[<span class="st">'market_cap'</span>])</span>
<span id="cb23-1327"><a href="#cb23-1327" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1328"><a href="#cb23-1328" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fama-MacBeth style: run cross-sectional regressions each period</span></span>
<span id="cb23-1329"><a href="#cb23-1329" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb23-1330"><a href="#cb23-1330" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> quarter, group <span class="kw">in</span> df.groupby(<span class="st">'quarter_end'</span>):</span>
<span id="cb23-1331"><a href="#cb23-1331" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.dropna(subset<span class="op">=</span>[<span class="st">'fol_utilization'</span>, <span class="st">'log_mktcap'</span>])</span>
<span id="cb23-1332"><a href="#cb23-1332" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb23-1333"><a href="#cb23-1333" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-1334"><a href="#cb23-1334" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1335"><a href="#cb23-1335" aria-hidden="true" tabindex="-1"></a>            y <span class="op">=</span> group[<span class="st">'log_mktcap'</span>]</span>
<span id="cb23-1336"><a href="#cb23-1336" aria-hidden="true" tabindex="-1"></a>            X <span class="op">=</span> sm.add_constant(group[[<span class="st">'fol_utilization'</span>, <span class="st">'pct_state'</span>, </span>
<span id="cb23-1337"><a href="#cb23-1337" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">'n_inst_owners'</span>]])</span>
<span id="cb23-1338"><a href="#cb23-1338" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb23-1339"><a href="#cb23-1339" aria-hidden="true" tabindex="-1"></a>                model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb23-1340"><a href="#cb23-1340" aria-hidden="true" tabindex="-1"></a>                results.append({</span>
<span id="cb23-1341"><a href="#cb23-1341" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'quarter'</span>: quarter,</span>
<span id="cb23-1342"><a href="#cb23-1342" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'beta_fol'</span>: model.params.get(<span class="st">'fol_utilization'</span>, np.nan),</span>
<span id="cb23-1343"><a href="#cb23-1343" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'tstat_fol'</span>: model.tvalues.get(<span class="st">'fol_utilization'</span>, np.nan),</span>
<span id="cb23-1344"><a href="#cb23-1344" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'r2'</span>: model.rsquared,</span>
<span id="cb23-1345"><a href="#cb23-1345" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'n'</span>: <span class="bu">len</span>(group),</span>
<span id="cb23-1346"><a href="#cb23-1346" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb23-1347"><a href="#cb23-1347" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb23-1348"><a href="#cb23-1348" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-1349"><a href="#cb23-1349" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1350"><a href="#cb23-1350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> results:</span>
<span id="cb23-1351"><a href="#cb23-1351" aria-hidden="true" tabindex="-1"></a>            results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb23-1352"><a href="#cb23-1352" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"FOL Premium (Fama-MacBeth Regression):"</span>)</span>
<span id="cb23-1353"><a href="#cb23-1353" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Mean β(FOL_util): </span><span class="sc">{</span>results_df[<span class="st">'beta_fol'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-1354"><a href="#cb23-1354" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  t-statistic: </span><span class="sc">{</span>results_df[<span class="st">'beta_fol'</span>]<span class="sc">.</span>mean() <span class="op">/</span> <span class="st">"</span></span>
<span id="cb23-1355"><a href="#cb23-1355" aria-hidden="true" tabindex="-1"></a><span class="er">                  f"(results_df['beta_fol'].std() / np.sqrt(len(results_df))):.2f}")</span></span>
<span id="cb23-1356"><a href="#cb23-1356" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> results_df</span>
<span id="cb23-1357"><a href="#cb23-1357" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1358"><a href="#cb23-1358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd<span class="sc">.</span>DataFrame()</span>
<span id="cb23-1359"><a href="#cb23-1359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1360"><a href="#cb23-1360" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> analyze_foreign_room_events(<span class="va">self</span>) <span class="op">-&gt;</span> pd<span class="sc">.</span>DataFrame<span class="sc">:</span></span>
<span id="cb23-1361"><a href="#cb23-1361" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb23-1362"><a href="#cb23-1362" aria-hidden="true" tabindex="-1"></a><span class="co">        Analyze events where foreign room opens or closes.</span></span>
<span id="cb23-1363"><a href="#cb23-1363" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb23-1364"><a href="#cb23-1364" aria-hidden="true" tabindex="-1"></a><span class="co">        Room-opening events (FOL cap raised, foreign seller exits) can</span></span>
<span id="cb23-1365"><a href="#cb23-1365" aria-hidden="true" tabindex="-1"></a><span class="co">        trigger significant price movements as pent-up foreign demand </span></span>
<span id="cb23-1366"><a href="#cb23-1366" aria-hidden="true" tabindex="-1"></a><span class="co">        is released. Room-closing events (approaching cap) can create</span></span>
<span id="cb23-1367"><a href="#cb23-1367" aria-hidden="true" tabindex="-1"></a><span class="co">        selling pressure as foreign investors anticipate illiquidity.</span></span>
<span id="cb23-1368"><a href="#cb23-1368" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb23-1369"><a href="#cb23-1369" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span><span class="sc">.</span>foreign_daily <span class="kw">is</span> <span class="va">None</span><span class="sc">:</span></span>
<span id="cb23-1370"><a href="#cb23-1370" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"Daily foreign ownership data required for event analysis."</span>)</span>
<span id="cb23-1371"><a href="#cb23-1371" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd<span class="sc">.</span>DataFrame()</span>
<span id="cb23-1372"><a href="#cb23-1372" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1373"><a href="#cb23-1373" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="va">self</span><span class="sc">.</span>foreign_daily<span class="sc">.</span>copy()</span>
<span id="cb23-1374"><a href="#cb23-1374" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df<span class="sc">.</span>sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-1375"><a href="#cb23-1375" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1376"><a href="#cb23-1376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute daily change in foreign room</span></span>
<span id="cb23-1377"><a href="#cb23-1377" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'foreign_room_change'</span>] <span class="op">=</span> df<span class="sc">.</span>groupby(<span class="st">'ticker'</span>)[<span class="st">'foreign_room'</span>]<span class="sc">.</span>diff()</span>
<span id="cb23-1378"><a href="#cb23-1378" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1379"><a href="#cb23-1379" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify room-opening events (room increases by &gt; 1 percentage point)</span></span>
<span id="cb23-1380"><a href="#cb23-1380" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'room_open_event'</span>] <span class="op">=</span> (df[<span class="st">'foreign_room_change'</span>] <span class="op">&gt;</span> <span class="fl">0.01</span>)<span class="sc">.</span>astype(<span class="bu">int</span>)</span>
<span id="cb23-1381"><a href="#cb23-1381" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1382"><a href="#cb23-1382" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Identify room-closing events (room decreases to &lt; 2%)</span></span>
<span id="cb23-1383"><a href="#cb23-1383" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'room_close_event'</span>] <span class="op">=</span> (</span>
<span id="cb23-1384"><a href="#cb23-1384" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'foreign_room'</span>] <span class="op">&lt;</span> <span class="fl">0.02</span>) <span class="op">&amp;</span> </span>
<span id="cb23-1385"><a href="#cb23-1385" aria-hidden="true" tabindex="-1"></a>            (df.groupby(<span class="st">'ticker'</span>)[<span class="st">'foreign_room'</span>].shift(<span class="dv">1</span>) <span class="op">&gt;=</span> <span class="fl">0.02</span>)</span>
<span id="cb23-1386"><a href="#cb23-1386" aria-hidden="true" tabindex="-1"></a>        )<span class="sc">.</span>astype(<span class="bu">int</span>)</span>
<span id="cb23-1387"><a href="#cb23-1387" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1388"><a href="#cb23-1388" aria-hidden="true" tabindex="-1"></a>        events <span class="op">=</span> df[</span>
<span id="cb23-1389"><a href="#cb23-1389" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'room_open_event'</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">|</span> (df[<span class="st">'room_close_event'</span>] <span class="op">==</span> <span class="dv">1</span>)</span>
<span id="cb23-1390"><a href="#cb23-1390" aria-hidden="true" tabindex="-1"></a>        ]<span class="sc">.</span>copy()</span>
<span id="cb23-1391"><a href="#cb23-1391" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1392"><a href="#cb23-1392" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Foreign room events identified:"</span>)</span>
<span id="cb23-1393"><a href="#cb23-1393" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Room-opening events: </span><span class="sc">{</span>df[<span class="st">'room_open_event'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1394"><a href="#cb23-1394" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Room-closing events: </span><span class="sc">{</span>df[<span class="st">'room_close_event'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1395"><a href="#cb23-1395" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1396"><a href="#cb23-1396" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> events</span>
<span id="cb23-1397"><a href="#cb23-1397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1398"><a href="#cb23-1398" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_analyzer = FOLAnalyzer(io_metrics, dc.foreign_ownership)</span></span>
<span id="cb23-1399"><a href="#cb23-1399" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_classified = fol_analyzer.classify_fol_zones()</span></span>
<span id="cb23-1400"><a href="#cb23-1400" aria-hidden="true" tabindex="-1"></a><span class="co"># fol_premium = fol_analyzer.estimate_fol_premium()</span></span>
<span id="cb23-1401"><a href="#cb23-1401" aria-hidden="true" tabindex="-1"></a><span class="sc">```</span></span>
<span id="cb23-1402"><a href="#cb23-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1405"><a href="#cb23-1405" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1406"><a href="#cb23-1406" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fol-utilization</span></span>
<span id="cb23-1407"><a href="#cb23-1407" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Foreign Ownership Limit Utilization Distribution by Sector. Banking stocks cluster near the 30% cap, while many large-cap non-bank stocks approach the standard 49% limit. The bimodal distribution in 'Others' reflects the mix of stocks with and without meaningful foreign interest."</span></span>
<span id="cb23-1408"><a href="#cb23-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1409"><a href="#cb23-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1410"><a href="#cb23-1410" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_fol_utilization(metrics: pd.DataFrame)<span class="sc">:</span></span>
<span id="cb23-1411"><a href="#cb23-1411" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Plot FOL utilization distribution by sector."""</span></span>
<span id="cb23-1412"><a href="#cb23-1412" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics[metrics[<span class="st">'fol_utilization'</span>].notna()]<span class="sc">.</span>copy()</span>
<span id="cb23-1413"><a href="#cb23-1413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1414"><a href="#cb23-1414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign broad sectors</span></span>
<span id="cb23-1415"><a href="#cb23-1415" aria-hidden="true" tabindex="-1"></a>    sector_map <span class="op">=</span> {</span>
<span id="cb23-1416"><a href="#cb23-1416" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Banking'</span>: [<span class="st">'VCB'</span>, <span class="st">'BID'</span>, <span class="st">'CTG'</span>, <span class="st">'TCB'</span>, <span class="st">'VPB'</span>, <span class="st">'MBB'</span>, <span class="st">'ACB'</span>, <span class="st">'HDB'</span>, <span class="st">'STB'</span>, <span class="st">'TPB'</span>],</span>
<span id="cb23-1417"><a href="#cb23-1417" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Real Estate'</span>: [<span class="st">'VHM'</span>, <span class="st">'VIC'</span>, <span class="st">'NVL'</span>, <span class="st">'KDH'</span>, <span class="st">'DXG'</span>, <span class="st">'HDG'</span>, <span class="st">'VRE'</span>],</span>
<span id="cb23-1418"><a href="#cb23-1418" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Technology'</span>: [<span class="st">'FPT'</span>, <span class="st">'CMG'</span>, <span class="st">'FOX'</span>],</span>
<span id="cb23-1419"><a href="#cb23-1419" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Consumer'</span>: [<span class="st">'VNM'</span>, <span class="st">'MSN'</span>, <span class="st">'SAB'</span>, <span class="st">'MWG'</span>, <span class="st">'PNJ'</span>],</span>
<span id="cb23-1420"><a href="#cb23-1420" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1421"><a href="#cb23-1421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1422"><a href="#cb23-1422" aria-hidden="true" tabindex="-1"></a>    fig<span class="sc">,</span> ax <span class="op">=</span> plt<span class="sc">.</span>subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb23-1423"><a href="#cb23-1423" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1424"><a href="#cb23-1424" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sector<span class="sc">,</span> tickers <span class="kw">in</span> sector_map<span class="sc">.</span>items()<span class="sc">:</span></span>
<span id="cb23-1425"><a href="#cb23-1425" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> df[df[<span class="st">'ticker'</span>].isin(tickers)][<span class="st">'fol_utilization'</span>]</span>
<span id="cb23-1426"><a href="#cb23-1426" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&gt;</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1427"><a href="#cb23-1427" aria-hidden="true" tabindex="-1"></a>            ax<span class="sc">.</span>hist(data <span class="op">*</span> <span class="dv">100</span>, bins<span class="op">=</span><span class="dv">30</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, label<span class="op">=</span>sector, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-1428"><a href="#cb23-1428" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1429"><a href="#cb23-1429" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>axvline(x<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'red'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Banking FOL (30%)'</span>)</span>
<span id="cb23-1430"><a href="#cb23-1430" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>axvline(x<span class="op">=</span><span class="dv">49</span>, color<span class="op">=</span><span class="st">'blue'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'Standard FOL (49%)'</span>)</span>
<span id="cb23-1431"><a href="#cb23-1431" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>set_xlabel(<span class="st">'FOL Utilization (%)'</span>)</span>
<span id="cb23-1432"><a href="#cb23-1432" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb23-1433"><a href="#cb23-1433" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>set_title(<span class="st">'Foreign Ownership Limit Utilization Distribution'</span>)</span>
<span id="cb23-1434"><a href="#cb23-1434" aria-hidden="true" tabindex="-1"></a>    ax<span class="sc">.</span>legend()</span>
<span id="cb23-1435"><a href="#cb23-1435" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1436"><a href="#cb23-1436" aria-hidden="true" tabindex="-1"></a>    plt<span class="sc">.</span>tight_layout()</span>
<span id="cb23-1437"><a href="#cb23-1437" aria-hidden="true" tabindex="-1"></a>    plt<span class="sc">.</span>savefig(<span class="st">'fig_fol_utilization.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb23-1438"><a href="#cb23-1438" aria-hidden="true" tabindex="-1"></a>    plt<span class="sc">.</span>show()</span>
<span id="cb23-1439"><a href="#cb23-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1440"><a href="#cb23-1440" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_fol_utilization(io_metrics)</span></span>
<span id="cb23-1441"><a href="#cb23-1441" aria-hidden="true" tabindex="-1"></a><span class="sc">```</span></span>
<span id="cb23-1442"><a href="#cb23-1442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1443"><a href="#cb23-1443" aria-hidden="true" tabindex="-1"></a><span class="co">## Institutional Trades {#sec-trades}</span></span>
<span id="cb23-1444"><a href="#cb23-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1445"><a href="#cb23-1445" aria-hidden="true" tabindex="-1"></a><span class="co">### Trade Inference in Vietnam {#sec-trade-inference}</span></span>
<span id="cb23-1446"><a href="#cb23-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1447"><a href="#cb23-1447" aria-hidden="true" tabindex="-1"></a>In the US<span class="sc">,</span> institutional trades are inferred <span class="im">from</span> quarterly <span class="dv">13</span><span class="er">F</span> holding snapshots<span class="sc">.</span> In Vietnam<span class="sc">,</span> the challenge <span class="kw">is</span> more acute because disclosure frequency varies<span class="sc">:</span></span>
<span id="cb23-1448"><a href="#cb23-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1449"><a href="#cb23-1449" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>   <span class="op">**</span>Major shareholders (<span class="op">**</span>$\ge$ <span class="op">**</span><span class="dv">5</span><span class="op">%</span>)<span class="op">**</span><span class="sc">:</span> Must disclose within <span class="dv">7</span> business days of crossing ownership thresholds (<span class="dv">5</span><span class="op">%</span>, <span class="dv">10</span><span class="op">%</span>, <span class="dv">15</span><span class="op">%</span>, <span class="dv">20</span><span class="op">%</span>, <span class="dv">25</span><span class="op">%</span>, <span class="dv">50</span><span class="op">%</span>, <span class="dv">65</span><span class="op">%</span>, <span class="dv">75</span><span class="op">%</span>)</span>
<span id="cb23-1450"><a href="#cb23-1450" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>   <span class="op">**</span>Fund portfolio reports<span class="sc">:</span><span class="op">**</span> Semi<span class="op">-</span>annual disclosure required<span class="op">;</span> some funds report quarterly</span>
<span id="cb23-1451"><a href="#cb23-1451" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>   <span class="op">**</span>Annual reports<span class="sc">:</span><span class="op">**</span> Provide complete shareholder register but only once per year</span>
<span id="cb23-1452"><a href="#cb23-1452" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>   <span class="op">**</span>Daily foreign ownership<span class="sc">:</span><span class="op">**</span> HOSE<span class="op">/</span>HNX publish aggregate daily foreign buy<span class="op">/</span>sell data</span>
<span id="cb23-1453"><a href="#cb23-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1454"><a href="#cb23-1454" aria-hidden="true" tabindex="-1"></a>We derive trades <span class="im">from</span> the <span class="op">**</span>change <span class="kw">in</span> ownership between consecutive disclosure dates<span class="op">**</span><span class="sc">,</span> applying the same logic <span class="im">as</span> the US <span class="op">@</span>ben2013hedge algorithm but adapted <span class="cf">for</span> Vietnam<span class="st">'s irregular disclosure intervals.</span></span>
<span id="cb23-1455"><a href="#cb23-1455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1458"><a href="#cb23-1458" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1459"><a href="#cb23-1459" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: derive-trades-vn</span></span>
<span id="cb23-1460"><a href="#cb23-1460" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Derive Institutional Trades from Vietnamese Ownership Disclosures"</span></span>
<span id="cb23-1461"><a href="#cb23-1461" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1462"><a href="#cb23-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1463"><a href="#cb23-1463" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1464"><a href="#cb23-1464" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Derive Institutional Trades</span></span>
<span id="cb23-1465"><a href="#cb23-1465" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1466"><a href="#cb23-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1467"><a href="#cb23-1467" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> derive_trades_vietnam(ownership: pd.DataFrame,</span>
<span id="cb23-1468"><a href="#cb23-1468" aria-hidden="true" tabindex="-1"></a>                           adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd<span class="sc">.</span>DataFrame<span class="sc">:</span></span>
<span id="cb23-1469"><a href="#cb23-1469" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1470"><a href="#cb23-1470" aria-hidden="true" tabindex="-1"></a><span class="co">    Derive institutional trades from changes in ownership disclosures.</span></span>
<span id="cb23-1471"><a href="#cb23-1471" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1472"><a href="#cb23-1472" aria-hidden="true" tabindex="-1"></a><span class="co">    Adapted from Ben-David, Franzoni, and Moussawi (2012) for </span></span>
<span id="cb23-1473"><a href="#cb23-1473" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnam's irregular disclosure frequency.</span></span>
<span id="cb23-1474"><a href="#cb23-1474" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1475"><a href="#cb23-1475" aria-hidden="true" tabindex="-1"></a><span class="co">    Key differences from US approach:</span></span>
<span id="cb23-1476"><a href="#cb23-1476" aria-hidden="true" tabindex="-1"></a><span class="co">    1. Disclosure intervals are irregular (not always quarterly)</span></span>
<span id="cb23-1477"><a href="#cb23-1477" aria-hidden="true" tabindex="-1"></a><span class="co">    2. We observe ALL institutional types, not just 13F filers</span></span>
<span id="cb23-1478"><a href="#cb23-1478" aria-hidden="true" tabindex="-1"></a><span class="co">    3. No $100M AUM threshold (we see all institutional holders)</span></span>
<span id="cb23-1479"><a href="#cb23-1479" aria-hidden="true" tabindex="-1"></a><span class="co">    4. Must adjust for corporate actions between disclosure dates</span></span>
<span id="cb23-1480"><a href="#cb23-1480" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1481"><a href="#cb23-1481" aria-hidden="true" tabindex="-1"></a><span class="co">    Trade types:</span></span>
<span id="cb23-1482"><a href="#cb23-1482" aria-hidden="true" tabindex="-1"></a><span class="co">    +1: Initiating Buy (new position)</span></span>
<span id="cb23-1483"><a href="#cb23-1483" aria-hidden="true" tabindex="-1"></a><span class="co">    +2: Incremental Buy (increased existing position)</span></span>
<span id="cb23-1484"><a href="#cb23-1484" aria-hidden="true" tabindex="-1"></a><span class="co">    -1: Terminating Sale (fully exited position)</span></span>
<span id="cb23-1485"><a href="#cb23-1485" aria-hidden="true" tabindex="-1"></a><span class="co">    -2: Incremental Sale (reduced existing position)</span></span>
<span id="cb23-1486"><a href="#cb23-1486" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1487"><a href="#cb23-1487" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-1488"><a href="#cb23-1488" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-1489"><a href="#cb23-1489" aria-hidden="true" tabindex="-1"></a><span class="co">    ownership : pd.DataFrame</span></span>
<span id="cb23-1490"><a href="#cb23-1490" aria-hidden="true" tabindex="-1"></a><span class="co">        Classified ownership with: ticker, date, shareholder_name, </span></span>
<span id="cb23-1491"><a href="#cb23-1491" aria-hidden="true" tabindex="-1"></a><span class="co">        shares_held, owner_type</span></span>
<span id="cb23-1492"><a href="#cb23-1492" aria-hidden="true" tabindex="-1"></a><span class="co">    adj_factors : pd.DataFrame</span></span>
<span id="cb23-1493"><a href="#cb23-1493" aria-hidden="true" tabindex="-1"></a><span class="co">        Corporate action adjustment factors</span></span>
<span id="cb23-1494"><a href="#cb23-1494" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1495"><a href="#cb23-1495" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-1496"><a href="#cb23-1496" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-1497"><a href="#cb23-1497" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb23-1498"><a href="#cb23-1498" aria-hidden="true" tabindex="-1"></a><span class="co">        Trade-level data: date, shareholder_name, ticker, trade, </span></span>
<span id="cb23-1499"><a href="#cb23-1499" aria-hidden="true" tabindex="-1"></a><span class="co">        buysale, owner_type</span></span>
<span id="cb23-1500"><a href="#cb23-1500" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1501"><a href="#cb23-1501" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Focus on institutional shareholders only</span></span>
<span id="cb23-1502"><a href="#cb23-1502" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb23-1503"><a href="#cb23-1503" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb23-1504"><a href="#cb23-1504" aria-hidden="true" tabindex="-1"></a>    ]<span class="sc">.</span>copy()</span>
<span id="cb23-1505"><a href="#cb23-1505" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1506"><a href="#cb23-1506" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst<span class="sc">.</span>sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'date'</span>])<span class="sc">.</span>reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-1507"><a href="#cb23-1507" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1508"><a href="#cb23-1508" aria-hidden="true" tabindex="-1"></a>    trades_list <span class="op">=</span> []</span>
<span id="cb23-1509"><a href="#cb23-1509" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1510"><a href="#cb23-1510" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (shareholder, ticker)<span class="sc">,</span> group <span class="kw">in</span> inst<span class="sc">.</span>groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])<span class="sc">:</span></span>
<span id="cb23-1511"><a href="#cb23-1511" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group<span class="sc">.</span>reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-1512"><a href="#cb23-1512" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1513"><a href="#cb23-1513" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(group))<span class="sc">:</span></span>
<span id="cb23-1514"><a href="#cb23-1514" aria-hidden="true" tabindex="-1"></a>            current <span class="op">=</span> group<span class="sc">.</span>iloc[i]</span>
<span id="cb23-1515"><a href="#cb23-1515" aria-hidden="true" tabindex="-1"></a>            current_date <span class="op">=</span> current[<span class="st">'date'</span>]</span>
<span id="cb23-1516"><a href="#cb23-1516" aria-hidden="true" tabindex="-1"></a>            current_shares <span class="op">=</span> current[<span class="st">'shares_held'</span>]</span>
<span id="cb23-1517"><a href="#cb23-1517" aria-hidden="true" tabindex="-1"></a>            owner_type <span class="op">=</span> current[<span class="st">'owner_type'</span>]</span>
<span id="cb23-1518"><a href="#cb23-1518" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1519"><a href="#cb23-1519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">==</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1520"><a href="#cb23-1520" aria-hidden="true" tabindex="-1"></a>                <span class="co"># First observation: if institution appears, it's an initiating buy</span></span>
<span id="cb23-1521"><a href="#cb23-1521" aria-hidden="true" tabindex="-1"></a>                <span class="co"># (we don't know if they held before our data starts)</span></span>
<span id="cb23-1522"><a href="#cb23-1522" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Skip the very first observation to avoid false initiating buys</span></span>
<span id="cb23-1523"><a href="#cb23-1523" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-1524"><a href="#cb23-1524" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1525"><a href="#cb23-1525" aria-hidden="true" tabindex="-1"></a>            prev <span class="op">=</span> group<span class="sc">.</span>iloc[i <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb23-1526"><a href="#cb23-1526" aria-hidden="true" tabindex="-1"></a>            prev_date <span class="op">=</span> prev[<span class="st">'date'</span>]</span>
<span id="cb23-1527"><a href="#cb23-1527" aria-hidden="true" tabindex="-1"></a>            prev_shares <span class="op">=</span> prev[<span class="st">'shares_held'</span>]</span>
<span id="cb23-1528"><a href="#cb23-1528" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1529"><a href="#cb23-1529" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Adjust previous shares for corporate actions between dates</span></span>
<span id="cb23-1530"><a href="#cb23-1530" aria-hidden="true" tabindex="-1"></a>            prev_shares_adj <span class="op">=</span> adjust_shares(</span>
<span id="cb23-1531"><a href="#cb23-1531" aria-hidden="true" tabindex="-1"></a>                prev_shares, ticker, prev_date, current_date, adj_factors</span>
<span id="cb23-1532"><a href="#cb23-1532" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-1533"><a href="#cb23-1533" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1534"><a href="#cb23-1534" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute trade (in adjusted shares)</span></span>
<span id="cb23-1535"><a href="#cb23-1535" aria-hidden="true" tabindex="-1"></a>            trade <span class="op">=</span> current_shares <span class="op">-</span> prev_shares_adj</span>
<span id="cb23-1536"><a href="#cb23-1536" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1537"><a href="#cb23-1537" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Classify trade type</span></span>
<span id="cb23-1538"><a href="#cb23-1538" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">abs</span>(trade) <span class="op">&lt;</span> <span class="dv">1</span><span class="sc">:</span>  <span class="co"># De minimis threshold</span></span>
<span id="cb23-1539"><a href="#cb23-1539" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb23-1540"><a href="#cb23-1540" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1541"><a href="#cb23-1541" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_shares_adj <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">and</span> current_shares <span class="op">&gt;</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1542"><a href="#cb23-1542" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Initiating buy</span></span>
<span id="cb23-1543"><a href="#cb23-1543" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> prev_shares_adj <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> current_shares <span class="op">&lt;=</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1544"><a href="#cb23-1544" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="op">-</span><span class="dv">1</span>  <span class="co"># Terminating sale</span></span>
<span id="cb23-1545"><a href="#cb23-1545" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> trade <span class="op">&gt;</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1546"><a href="#cb23-1546" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="dv">2</span>  <span class="co"># Incremental buy</span></span>
<span id="cb23-1547"><a href="#cb23-1547" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span><span class="sc">:</span></span>
<span id="cb23-1548"><a href="#cb23-1548" aria-hidden="true" tabindex="-1"></a>                buysale <span class="op">=</span> <span class="op">-</span><span class="dv">2</span>  <span class="co"># Incremental sale</span></span>
<span id="cb23-1549"><a href="#cb23-1549" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-1550"><a href="#cb23-1550" aria-hidden="true" tabindex="-1"></a>            trades_list<span class="sc">.</span>append({</span>
<span id="cb23-1551"><a href="#cb23-1551" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: current_date,</span>
<span id="cb23-1552"><a href="#cb23-1552" aria-hidden="true" tabindex="-1"></a>                <span class="st">'shareholder_name'</span>: shareholder,</span>
<span id="cb23-1553"><a href="#cb23-1553" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: ticker,</span>
<span id="cb23-1554"><a href="#cb23-1554" aria-hidden="true" tabindex="-1"></a>                <span class="st">'trade'</span>: trade,</span>
<span id="cb23-1555"><a href="#cb23-1555" aria-hidden="true" tabindex="-1"></a>                <span class="st">'prev_shares_adj'</span>: prev_shares_adj,</span>
<span id="cb23-1556"><a href="#cb23-1556" aria-hidden="true" tabindex="-1"></a>                <span class="st">'current_shares'</span>: current_shares,</span>
<span id="cb23-1557"><a href="#cb23-1557" aria-hidden="true" tabindex="-1"></a>                <span class="st">'buysale'</span>: buysale,</span>
<span id="cb23-1558"><a href="#cb23-1558" aria-hidden="true" tabindex="-1"></a>                <span class="st">'owner_type'</span>: owner_type,</span>
<span id="cb23-1559"><a href="#cb23-1559" aria-hidden="true" tabindex="-1"></a>                <span class="st">'days_between'</span>: (current_date <span class="op">-</span> prev_date).days,</span>
<span id="cb23-1560"><a href="#cb23-1560" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb23-1561"><a href="#cb23-1561" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1562"><a href="#cb23-1562" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> pd<span class="sc">.</span>DataFrame(trades_list)</span>
<span id="cb23-1563"><a href="#cb23-1563" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1564"><a href="#cb23-1564" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(trades) <span class="op">&gt;</span> <span class="dv">0</span><span class="sc">:</span></span>
<span id="cb23-1565"><a href="#cb23-1565" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Trades derived: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1566"><a href="#cb23-1566" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Trade type distribution:"</span>)</span>
<span id="cb23-1567"><a href="#cb23-1567" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> {<span class="dv">1</span>: <span class="st">'Initiating Buy'</span>, <span class="dv">2</span>: <span class="st">'Incremental Buy'</span>,</span>
<span id="cb23-1568"><a href="#cb23-1568" aria-hidden="true" tabindex="-1"></a>                  <span class="op">-</span><span class="dv">1</span>: <span class="st">'Terminating Sale'</span>, <span class="op">-</span><span class="dv">2</span>: <span class="st">'Incremental Sale'</span>}</span>
<span id="cb23-1569"><a href="#cb23-1569" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bs<span class="sc">,</span> label <span class="kw">in</span> <span class="bu">sorted</span>(labels.items())<span class="sc">:</span></span>
<span id="cb23-1570"><a href="#cb23-1570" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> (trades[<span class="st">'buysale'</span>] <span class="op">==</span> bs)<span class="sc">.</span><span class="bu">sum</span>()</span>
<span id="cb23-1571"><a href="#cb23-1571" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>n<span class="sc">:,}</span><span class="ss"> (</span><span class="sc">{</span>n<span class="op">/</span><span class="bu">len</span>(trades)<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb23-1572"><a href="#cb23-1572" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-1573"><a href="#cb23-1573" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">By owner type:"</span>)</span>
<span id="cb23-1574"><a href="#cb23-1574" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(trades.groupby(<span class="st">'owner_type'</span>)[<span class="st">'trade'</span>].agg([<span class="st">'count'</span>, <span class="st">'mean'</span>, <span class="st">'median'</span>])</span>
<span id="cb23-1575"><a href="#cb23-1575" aria-hidden="true" tabindex="-1"></a>              .<span class="bu">round</span>(<span class="dv">0</span>).to_string())</span>
<span id="cb23-1576"><a href="#cb23-1576" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1577"><a href="#cb23-1577" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span>
<span id="cb23-1578"><a href="#cb23-1578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1579"><a href="#cb23-1579" aria-hidden="true" tabindex="-1"></a><span class="co"># trades = derive_trades_vietnam(ownership_classified, adj_factors)</span></span>
<span id="cb23-1580"><a href="#cb23-1580" aria-hidden="true" tabindex="-1"></a><span class="sc">```</span></span>
<span id="cb23-1581"><a href="#cb23-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1582"><a href="#cb23-1582" aria-hidden="true" tabindex="-1"></a><span class="sc">:::</span> {.callout<span class="op">-</span>warning title<span class="op">=</span><span class="st">"Corporate Action Adjustment in Trade Derivation"</span>}</span>
<span id="cb23-1583"><a href="#cb23-1583" aria-hidden="true" tabindex="-1"></a>When computing trades <span class="im">as</span> <span class="sc">$\</span>Delta Shares <span class="op">=</span> Shares_t <span class="op">-</span> Shares_{t<span class="op">-</span><span class="dv">1</span>}<span class="sc">$,</span> the previous period<span class="st">'s shares **must** be adjusted for any corporate actions between $t-1$ and $t$. If VNM issued a 20</span><span class="sc">% s</span><span class="st">tock dividend between the two disclosure dates, then 1,000 shares at $t-1$ should be compared to 1,200 adjusted shares, not 1,000 raw shares. Failing to make this adjustment would create a phantom "buy" of 200 shares that never actually occurred.</span></span>
<span id="cb23-1584"><a href="#cb23-1584" aria-hidden="true" tabindex="-1"></a><span class="er">:::</span></span>
<span id="cb23-1585"><a href="#cb23-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1588"><a href="#cb23-1588" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1589"><a href="#cb23-1589" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vectorized-trades-vn</span></span>
<span id="cb23-1590"><a href="#cb23-1590" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Vectorized Trade Derivation for Large Datasets"</span></span>
<span id="cb23-1591"><a href="#cb23-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1592"><a href="#cb23-1592" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> derive_trades_vectorized_vietnam(ownership: pd.DataFrame,</span>
<span id="cb23-1593"><a href="#cb23-1593" aria-hidden="true" tabindex="-1"></a>                                      adj_factors: pd.DataFrame) <span class="op">-&gt;</span> pd<span class="sc">.</span>DataFrame<span class="sc">:</span></span>
<span id="cb23-1594"><a href="#cb23-1594" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1595"><a href="#cb23-1595" aria-hidden="true" tabindex="-1"></a><span class="co">    Vectorized version of Vietnamese trade derivation.</span></span>
<span id="cb23-1596"><a href="#cb23-1596" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1597"><a href="#cb23-1597" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses pandas groupby and vectorized operations instead of Python loops.</span></span>
<span id="cb23-1598"><a href="#cb23-1598" aria-hidden="true" tabindex="-1"></a><span class="co">    Approximately 20-50x faster for large datasets.</span></span>
<span id="cb23-1599"><a href="#cb23-1599" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-1600"><a href="#cb23-1600" aria-hidden="true" tabindex="-1"></a><span class="co">    Note: Corporate action adjustment is applied per-group, which still</span></span>
<span id="cb23-1601"><a href="#cb23-1601" aria-hidden="true" tabindex="-1"></a><span class="co">    requires some iteration but is much faster than row-by-row.</span></span>
<span id="cb23-1602"><a href="#cb23-1602" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1603"><a href="#cb23-1603" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb23-1604"><a href="#cb23-1604" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL) <span class="op">&amp;</span></span>
<span id="cb23-1605"><a href="#cb23-1605" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb23-1606"><a href="#cb23-1606" aria-hidden="true" tabindex="-1"></a>    ]<span class="sc">.</span>copy()</span>
<span id="cb23-1607"><a href="#cb23-1607" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1608"><a href="#cb23-1608" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst<span class="sc">.</span>sort_values([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'date'</span>])<span class="sc">.</span>reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-1609"><a href="#cb23-1609" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1610"><a href="#cb23-1610" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged values</span></span>
<span id="cb23-1611"><a href="#cb23-1611" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_date'</span>] <span class="op">=</span> inst<span class="sc">.</span>groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'date'</span>]<span class="sc">.</span>shift(<span class="dv">1</span>)</span>
<span id="cb23-1612"><a href="#cb23-1612" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_shares'</span>] <span class="op">=</span> inst<span class="sc">.</span>groupby([<span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'shares_held'</span>]<span class="sc">.</span>shift(<span class="dv">1</span>)</span>
<span id="cb23-1613"><a href="#cb23-1613" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'is_first'</span>] <span class="op">=</span> inst[<span class="st">'prev_date'</span>]<span class="sc">.</span>isna()</span>
<span id="cb23-1614"><a href="#cb23-1614" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1615"><a href="#cb23-1615" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove first observations (no prior to compare)</span></span>
<span id="cb23-1616"><a href="#cb23-1616" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst[<span class="op">~</span>inst[<span class="st">'is_first'</span>]]<span class="sc">.</span>copy()</span>
<span id="cb23-1617"><a href="#cb23-1617" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1618"><a href="#cb23-1618" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust previous shares for corporate actions</span></span>
<span id="cb23-1619"><a href="#cb23-1619" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vectorized: for each row, apply adjustment between prev_date and date</span></span>
<span id="cb23-1620"><a href="#cb23-1620" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> adjust_row(row)<span class="sc">:</span></span>
<span id="cb23-1621"><a href="#cb23-1621" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> adjust_shares(</span>
<span id="cb23-1622"><a href="#cb23-1622" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'prev_shares'</span>], row[<span class="st">'ticker'</span>], </span>
<span id="cb23-1623"><a href="#cb23-1623" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'prev_date'</span>], row[<span class="st">'date'</span>], adj_factors</span>
<span id="cb23-1624"><a href="#cb23-1624" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-1625"><a href="#cb23-1625" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1626"><a href="#cb23-1626" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'prev_shares_adj'</span>] <span class="op">=</span> inst<span class="sc">.</span><span class="bu">apply</span>(adjust_row, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-1627"><a href="#cb23-1627" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1628"><a href="#cb23-1628" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute trade</span></span>
<span id="cb23-1629"><a href="#cb23-1629" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'trade'</span>] <span class="op">=</span> inst[<span class="st">'shares_held'</span>] <span class="op">-</span> inst[<span class="st">'prev_shares_adj'</span>]</span>
<span id="cb23-1630"><a href="#cb23-1630" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'days_between'</span>] <span class="op">=</span> (inst[<span class="st">'date'</span>] <span class="op">-</span> inst[<span class="st">'prev_date'</span>])<span class="sc">.</span>dt<span class="sc">.</span>days</span>
<span id="cb23-1631"><a href="#cb23-1631" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1632"><a href="#cb23-1632" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Classify trade type</span></span>
<span id="cb23-1633"><a href="#cb23-1633" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'buysale'</span>] <span class="op">=</span> np<span class="sc">.</span>select(</span>
<span id="cb23-1634"><a href="#cb23-1634" aria-hidden="true" tabindex="-1"></a>        [</span>
<span id="cb23-1635"><a href="#cb23-1635" aria-hidden="true" tabindex="-1"></a>            (inst[<span class="st">'prev_shares_adj'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">&amp;</span> (inst[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>),</span>
<span id="cb23-1636"><a href="#cb23-1636" aria-hidden="true" tabindex="-1"></a>            (inst[<span class="st">'prev_shares_adj'</span>] <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (inst[<span class="st">'shares_held'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>),</span>
<span id="cb23-1637"><a href="#cb23-1637" aria-hidden="true" tabindex="-1"></a>            inst[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb23-1638"><a href="#cb23-1638" aria-hidden="true" tabindex="-1"></a>            inst[<span class="st">'trade'</span>] <span class="op">&lt;</span> <span class="dv">0</span>,</span>
<span id="cb23-1639"><a href="#cb23-1639" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb23-1640"><a href="#cb23-1640" aria-hidden="true" tabindex="-1"></a>        [<span class="dv">1</span>, <span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>, <span class="op">-</span><span class="dv">2</span>],</span>
<span id="cb23-1641"><a href="#cb23-1641" aria-hidden="true" tabindex="-1"></a>        default<span class="op">=</span><span class="dv">0</span></span>
<span id="cb23-1642"><a href="#cb23-1642" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1643"><a href="#cb23-1643" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1644"><a href="#cb23-1644" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove zero trades</span></span>
<span id="cb23-1645"><a href="#cb23-1645" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> inst[inst[<span class="st">'buysale'</span>] <span class="op">!=</span> <span class="dv">0</span>]<span class="sc">.</span>copy()</span>
<span id="cb23-1646"><a href="#cb23-1646" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1647"><a href="#cb23-1647" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades[[<span class="st">'date'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'ticker'</span>, <span class="st">'trade'</span>, </span>
<span id="cb23-1648"><a href="#cb23-1648" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'buysale'</span>, <span class="st">'owner_type'</span>, <span class="st">'days_between'</span>,</span>
<span id="cb23-1649"><a href="#cb23-1649" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'prev_shares_adj'</span>, <span class="st">'shares_held'</span>]]<span class="sc">.</span>copy()</span>
<span id="cb23-1650"><a href="#cb23-1650" aria-hidden="true" tabindex="-1"></a>    trades <span class="op">=</span> trades<span class="sc">.</span>rename(columns<span class="op">=</span>{<span class="st">'shares_held'</span>: <span class="st">'current_shares'</span>})</span>
<span id="cb23-1651"><a href="#cb23-1651" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1652"><a href="#cb23-1652" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Vectorized trades: </span><span class="sc">{</span><span class="bu">len</span>(trades)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1653"><a href="#cb23-1653" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trades</span>
<span id="cb23-1654"><a href="#cb23-1654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1655"><a href="#cb23-1655" aria-hidden="true" tabindex="-1"></a><span class="co"># trades = derive_trades_vectorized_vietnam(ownership_classified, adj_factors)</span></span>
<span id="cb23-1656"><a href="#cb23-1656" aria-hidden="true" tabindex="-1"></a><span class="sc">```</span></span>
<span id="cb23-1657"><a href="#cb23-1657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1658"><a href="#cb23-1658" aria-hidden="true" tabindex="-1"></a><span class="co">## Fund-Level Flows and Turnover {#sec-flows-turnover}</span></span>
<span id="cb23-1659"><a href="#cb23-1659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1660"><a href="#cb23-1660" aria-hidden="true" tabindex="-1"></a><span class="co">### Portfolio Assets and Returns from Fund Holdings</span></span>
<span id="cb23-1661"><a href="#cb23-1661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1662"><a href="#cb23-1662" aria-hidden="true" tabindex="-1"></a>Using DataCore<span class="sc">.</span>vn<span class="st">'s fund holdings data, we compute fund-level portfolio analytics analogous to the US 13F approach:</span></span>
<span id="cb23-1663"><a href="#cb23-1663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1664"><a href="#cb23-1664" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb23-1665"><a href="#cb23-1665" aria-hidden="true" tabindex="-1"></a><span class="er">Assets_{j,t} = \sum_{i=1}^{N_{j,t}} S_{i,j,t} \times P_{i,t}</span></span>
<span id="cb23-1666"><a href="#cb23-1666" aria-hidden="true" tabindex="-1"></a><span class="sc">$$</span> {<span class="co">#eq-assets-vn}</span></span>
<span id="cb23-1667"><a href="#cb23-1667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1668"><a href="#cb23-1668" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-1669"><a href="#cb23-1669" aria-hidden="true" tabindex="-1"></a>R_{j,t \to t<span class="op">+</span><span class="dv">1</span>}<span class="op">^</span>{holdings} <span class="op">=</span> \frac{\sum_{i} S_{i,j,t} \times P_{i,t} \times R_{i,t \to t<span class="op">+</span><span class="dv">1</span>}}{\sum_{i} S_{i,j,t} \times P_{i,t}}</span>
<span id="cb23-1670"><a href="#cb23-1670" aria-hidden="true" tabindex="-1"></a>$$ {<span class="co">#eq-hret-vn}</span></span>
<span id="cb23-1671"><a href="#cb23-1671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1672"><a href="#cb23-1672" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb23-1673"><a href="#cb23-1673" aria-hidden="true" tabindex="-1"></a>NetFlows_{j,t} <span class="op">=</span> Assets_{j,t} <span class="op">-</span> Assets_{j,t<span class="op">-</span><span class="dv">1</span>} \times (<span class="dv">1</span> <span class="op">+</span> R_{j,t<span class="op">-</span><span class="dv">1</span> \to t}<span class="op">^</span>{holdings})</span>
<span id="cb23-1674"><a href="#cb23-1674" aria-hidden="true" tabindex="-1"></a>$$ {<span class="co">#eq-flows-vn}</span></span>
<span id="cb23-1675"><a href="#cb23-1675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1676"><a href="#cb23-1676" aria-hidden="true" tabindex="-1"></a><span class="co">### Turnover Measures</span></span>
<span id="cb23-1677"><a href="#cb23-1677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1678"><a href="#cb23-1678" aria-hidden="true" tabindex="-1"></a>Following <span class="op">@</span>carhart1997persistence, adapted <span class="cf">for</span> Vietnam<span class="st">'s fund reporting:</span></span>
<span id="cb23-1679"><a href="#cb23-1679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1680"><a href="#cb23-1680" aria-hidden="true" tabindex="-1"></a><span class="er">$$</span></span>
<span id="cb23-1681"><a href="#cb23-1681" aria-hidden="true" tabindex="-1"></a><span class="er">Turnover_{j,t}^{Carhart} = \frac{\min</span>(TotalBuys_{j,t}, TotalSales_{j,t})}{\overline{Assets}_{j,t}}</span>
<span id="cb23-1682"><a href="#cb23-1682" aria-hidden="true" tabindex="-1"></a>$$ {<span class="co">#eq-turnover-vn}</span></span>
<span id="cb23-1683"><a href="#cb23-1683" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1686"><a href="#cb23-1686" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1687"><a href="#cb23-1687" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fund-analytics</span></span>
<span id="cb23-1688"><a href="#cb23-1688" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Fund-Level Portfolio Analytics from DataCore.vn Fund Holdings"</span></span>
<span id="cb23-1689"><a href="#cb23-1689" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1690"><a href="#cb23-1690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1691"><a href="#cb23-1691" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1692"><a href="#cb23-1692" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 8: Fund-Level Portfolio Analytics</span></span>
<span id="cb23-1693"><a href="#cb23-1693" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1694"><a href="#cb23-1694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1695"><a href="#cb23-1695" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_fund_analytics(fund_holdings: pd.DataFrame,</span>
<span id="cb23-1696"><a href="#cb23-1696" aria-hidden="true" tabindex="-1"></a>                            prices_q: pd.DataFrame,</span>
<span id="cb23-1697"><a href="#cb23-1697" aria-hidden="true" tabindex="-1"></a>                            adj_factors: pd.DataFrame) <span class="op">-&gt;</span> Dict:</span>
<span id="cb23-1698"><a href="#cb23-1698" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-1699"><a href="#cb23-1699" aria-hidden="true" tabindex="-1"></a><span class="st">    Compute fund-level portfolio analytics from DataCore.vn fund holdings.</span></span>
<span id="cb23-1700"><a href="#cb23-1700" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1701"><a href="#cb23-1701" aria-hidden="true" tabindex="-1"></a><span class="st">    Vietnamese fund disclosure is typically semi-annual (some quarterly),</span></span>
<span id="cb23-1702"><a href="#cb23-1702" aria-hidden="true" tabindex="-1"></a><span class="st">    which limits the frequency of these analytics compared to the US</span></span>
<span id="cb23-1703"><a href="#cb23-1703" aria-hidden="true" tabindex="-1"></a><span class="st">    quarterly approach.</span></span>
<span id="cb23-1704"><a href="#cb23-1704" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1705"><a href="#cb23-1705" aria-hidden="true" tabindex="-1"></a><span class="st">    Returns</span></span>
<span id="cb23-1706"><a href="#cb23-1706" aria-hidden="true" tabindex="-1"></a><span class="st">    -------</span></span>
<span id="cb23-1707"><a href="#cb23-1707" aria-hidden="true" tabindex="-1"></a><span class="st">    dict with keys:</span></span>
<span id="cb23-1708"><a href="#cb23-1708" aria-hidden="true" tabindex="-1"></a><span class="st">        'fund_assets': pd.DataFrame of fund-level assets and returns</span></span>
<span id="cb23-1709"><a href="#cb23-1709" aria-hidden="true" tabindex="-1"></a><span class="st">        'fund_trades': pd.DataFrame of fund-level derived trades</span></span>
<span id="cb23-1710"><a href="#cb23-1710" aria-hidden="true" tabindex="-1"></a><span class="st">        'fund_aggregates': pd.DataFrame of flows and turnover</span></span>
<span id="cb23-1711"><a href="#cb23-1711" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-1712"><a href="#cb23-1712" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fund_holdings.copy()</span>
<span id="cb23-1713"><a href="#cb23-1713" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fh[fh[<span class="st">'shares_held'</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb23-1714"><a href="#cb23-1714" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1715"><a href="#cb23-1715" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with prices</span></span>
<span id="cb23-1716"><a href="#cb23-1716" aria-hidden="true" tabindex="-1"></a>    fh <span class="op">=</span> fh.merge(</span>
<span id="cb23-1717"><a href="#cb23-1717" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'ret'</span>]],</span>
<span id="cb23-1718"><a href="#cb23-1718" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'report_date'</span>],</span>
<span id="cb23-1719"><a href="#cb23-1719" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb23-1720"><a href="#cb23-1720" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb23-1721"><a href="#cb23-1721" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1722"><a href="#cb23-1722" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1723"><a href="#cb23-1723" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio value</span></span>
<span id="cb23-1724"><a href="#cb23-1724" aria-hidden="true" tabindex="-1"></a>    fh[<span class="st">'holding_value'</span>] <span class="op">=</span> fh[<span class="st">'shares_held'</span>] <span class="op">*</span> fh[<span class="st">'close'</span>]</span>
<span id="cb23-1725"><a href="#cb23-1725" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1726"><a href="#cb23-1726" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Assets ---</span></span>
<span id="cb23-1727"><a href="#cb23-1727" aria-hidden="true" tabindex="-1"></a>    fund_assets <span class="op">=</span> fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>]).agg(</span>
<span id="cb23-1728"><a href="#cb23-1728" aria-hidden="true" tabindex="-1"></a>        total_assets<span class="op">=</span>(<span class="st">'holding_value'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e9</span>),  <span class="co"># Billion VND</span></span>
<span id="cb23-1729"><a href="#cb23-1729" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-1730"><a href="#cb23-1730" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-1731"><a href="#cb23-1731" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1732"><a href="#cb23-1732" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Holdings return (value-weighted)</span></span>
<span id="cb23-1733"><a href="#cb23-1733" aria-hidden="true" tabindex="-1"></a>    fh[<span class="st">'weight'</span>] <span class="op">=</span> fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])[<span class="st">'holding_value'</span>].transform(</span>
<span id="cb23-1734"><a href="#cb23-1734" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x <span class="op">/</span> x.<span class="bu">sum</span>()</span>
<span id="cb23-1735"><a href="#cb23-1735" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1736"><a href="#cb23-1736" aria-hidden="true" tabindex="-1"></a>    fund_hret <span class="op">=</span> (fh.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb23-1737"><a href="#cb23-1737" aria-hidden="true" tabindex="-1"></a>                   .<span class="bu">apply</span>(<span class="kw">lambda</span> g: np.average(g[<span class="st">'ret'</span>].fillna(<span class="dv">0</span>), weights<span class="op">=</span>g[<span class="st">'weight'</span>]))</span>
<span id="cb23-1738"><a href="#cb23-1738" aria-hidden="true" tabindex="-1"></a>                   .reset_index(name<span class="op">=</span><span class="st">'holdings_return'</span>))</span>
<span id="cb23-1739"><a href="#cb23-1739" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1740"><a href="#cb23-1740" aria-hidden="true" tabindex="-1"></a>    fund_assets <span class="op">=</span> fund_assets.merge(fund_hret, on<span class="op">=</span>[<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb23-1741"><a href="#cb23-1741" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1742"><a href="#cb23-1742" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Trades ---</span></span>
<span id="cb23-1743"><a href="#cb23-1743" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Derive trades from changes in holdings</span></span>
<span id="cb23-1744"><a href="#cb23-1744" aria-hidden="true" tabindex="-1"></a>    fh_sorted <span class="op">=</span> fh.sort_values([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb23-1745"><a href="#cb23-1745" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_shares'</span>] <span class="op">=</span> fh_sorted.groupby([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'shares_held'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-1746"><a href="#cb23-1746" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_date'</span>] <span class="op">=</span> fh_sorted.groupby([<span class="st">'fund_name'</span>, <span class="st">'ticker'</span>])[<span class="st">'report_date'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-1747"><a href="#cb23-1747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1748"><a href="#cb23-1748" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust for corporate actions</span></span>
<span id="cb23-1749"><a href="#cb23-1749" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'prev_shares_adj'</span>] <span class="op">=</span> fh_sorted.<span class="bu">apply</span>(</span>
<span id="cb23-1750"><a href="#cb23-1750" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: adjust_shares(r[<span class="st">'prev_shares'</span>], r[<span class="st">'ticker'</span>], </span>
<span id="cb23-1751"><a href="#cb23-1751" aria-hidden="true" tabindex="-1"></a>                                r[<span class="st">'prev_date'</span>], r[<span class="st">'report_date'</span>], adj_factors)</span>
<span id="cb23-1752"><a href="#cb23-1752" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> pd.notna(r[<span class="st">'prev_shares'</span>]) <span class="cf">else</span> np.nan,</span>
<span id="cb23-1753"><a href="#cb23-1753" aria-hidden="true" tabindex="-1"></a>        axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb23-1754"><a href="#cb23-1754" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1755"><a href="#cb23-1755" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1756"><a href="#cb23-1756" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'trade'</span>] <span class="op">=</span> fh_sorted[<span class="st">'shares_held'</span>] <span class="op">-</span> fh_sorted[<span class="st">'prev_shares_adj'</span>]</span>
<span id="cb23-1757"><a href="#cb23-1757" aria-hidden="true" tabindex="-1"></a>    fh_sorted[<span class="st">'trade_value'</span>] <span class="op">=</span> fh_sorted[<span class="st">'trade'</span>] <span class="op">*</span> fh_sorted[<span class="st">'close'</span>] <span class="op">/</span> <span class="fl">1e9</span>  <span class="co"># Billion VND</span></span>
<span id="cb23-1758"><a href="#cb23-1758" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1759"><a href="#cb23-1759" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aggregate buys and sells per fund-period</span></span>
<span id="cb23-1760"><a href="#cb23-1760" aria-hidden="true" tabindex="-1"></a>    fund_trades <span class="op">=</span> fh_sorted[fh_sorted[<span class="st">'trade'</span>].notna()].copy()</span>
<span id="cb23-1761"><a href="#cb23-1761" aria-hidden="true" tabindex="-1"></a>    fund_flows <span class="op">=</span> fund_trades.groupby([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>]).agg(</span>
<span id="cb23-1762"><a href="#cb23-1762" aria-hidden="true" tabindex="-1"></a>        total_buys<span class="op">=</span>(<span class="st">'trade_value'</span>, <span class="kw">lambda</span> x: x[x <span class="op">&gt;</span> <span class="dv">0</span>].<span class="bu">sum</span>()),</span>
<span id="cb23-1763"><a href="#cb23-1763" aria-hidden="true" tabindex="-1"></a>        total_sales<span class="op">=</span>(<span class="st">'trade_value'</span>, <span class="kw">lambda</span> x: <span class="op">-</span>x[x <span class="op">&lt;</span> <span class="dv">0</span>].<span class="bu">sum</span>()),</span>
<span id="cb23-1764"><a href="#cb23-1764" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-1765"><a href="#cb23-1765" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1766"><a href="#cb23-1766" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Fund-Level Aggregates ---</span></span>
<span id="cb23-1767"><a href="#cb23-1767" aria-hidden="true" tabindex="-1"></a>    fund_agg <span class="op">=</span> fund_assets.merge(fund_flows, on<span class="op">=</span>[<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-1768"><a href="#cb23-1768" aria-hidden="true" tabindex="-1"></a>    fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]] <span class="op">=</span> fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]].fillna(<span class="dv">0</span>)</span>
<span id="cb23-1769"><a href="#cb23-1769" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1770"><a href="#cb23-1770" aria-hidden="true" tabindex="-1"></a>    fund_agg <span class="op">=</span> fund_agg.sort_values([<span class="st">'fund_name'</span>, <span class="st">'report_date'</span>])</span>
<span id="cb23-1771"><a href="#cb23-1771" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'lag_assets'</span>] <span class="op">=</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'total_assets'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-1772"><a href="#cb23-1772" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'lag_hret'</span>] <span class="op">=</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'holdings_return'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-1773"><a href="#cb23-1773" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1774"><a href="#cb23-1774" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Net flows</span></span>
<span id="cb23-1775"><a href="#cb23-1775" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'net_flows'</span>] <span class="op">=</span> (fund_agg[<span class="st">'total_assets'</span>] <span class="op">-</span> </span>
<span id="cb23-1776"><a href="#cb23-1776" aria-hidden="true" tabindex="-1"></a>                              fund_agg[<span class="st">'lag_assets'</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> fund_agg[<span class="st">'holdings_return'</span>]))</span>
<span id="cb23-1777"><a href="#cb23-1777" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1778"><a href="#cb23-1778" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover (Carhart definition)</span></span>
<span id="cb23-1779"><a href="#cb23-1779" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'avg_assets'</span>] <span class="op">=</span> (fund_agg[<span class="st">'total_assets'</span>] <span class="op">+</span> fund_agg[<span class="st">'lag_assets'</span>]) <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb23-1780"><a href="#cb23-1780" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'turnover'</span>] <span class="op">=</span> (</span>
<span id="cb23-1781"><a href="#cb23-1781" aria-hidden="true" tabindex="-1"></a>        fund_agg[[<span class="st">'total_buys'</span>, <span class="st">'total_sales'</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>) <span class="op">/</span> fund_agg[<span class="st">'avg_assets'</span>]</span>
<span id="cb23-1782"><a href="#cb23-1782" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1783"><a href="#cb23-1783" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1784"><a href="#cb23-1784" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualize (approximate, since disclosure may be semi-annual)</span></span>
<span id="cb23-1785"><a href="#cb23-1785" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'periods_per_year'</span>] <span class="op">=</span> <span class="dv">365</span> <span class="op">/</span> fund_agg.groupby(<span class="st">'fund_name'</span>)[<span class="st">'report_date'</span>].diff().dt.days</span>
<span id="cb23-1786"><a href="#cb23-1786" aria-hidden="true" tabindex="-1"></a>    fund_agg[<span class="st">'turnover_annual'</span>] <span class="op">=</span> fund_agg[<span class="st">'turnover'</span>] <span class="op">*</span> fund_agg[<span class="st">'periods_per_year'</span>].fillna(<span class="dv">2</span>)</span>
<span id="cb23-1787"><a href="#cb23-1787" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1788"><a href="#cb23-1788" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Fund analytics computed:"</span>)</span>
<span id="cb23-1789"><a href="#cb23-1789" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Unique funds: </span><span class="sc">{</span>fund_agg[<span class="st">'fund_name'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1790"><a href="#cb23-1790" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Fund-period observations: </span><span class="sc">{</span><span class="bu">len</span>(fund_agg)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1791"><a href="#cb23-1791" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Turnover statistics:"</span>)</span>
<span id="cb23-1792"><a href="#cb23-1792" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(fund_agg[[<span class="st">'turnover'</span>, <span class="st">'turnover_annual'</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb23-1793"><a href="#cb23-1793" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1794"><a href="#cb23-1794" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb23-1795"><a href="#cb23-1795" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_assets'</span>: fund_assets,</span>
<span id="cb23-1796"><a href="#cb23-1796" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_trades'</span>: fund_trades,</span>
<span id="cb23-1797"><a href="#cb23-1797" aria-hidden="true" tabindex="-1"></a>        <span class="st">'fund_aggregates'</span>: fund_agg,</span>
<span id="cb23-1798"><a href="#cb23-1798" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1799"><a href="#cb23-1799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1800"><a href="#cb23-1800" aria-hidden="true" tabindex="-1"></a><span class="co"># fund_analytics = compute_fund_analytics(dc.fund_holdings, prices_q, adj_factors)</span></span>
<span id="cb23-1801"><a href="#cb23-1801" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-1802"><a href="#cb23-1802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1803"><a href="#cb23-1803" aria-hidden="true" tabindex="-1"></a><span class="op">------------------------------------------------------------------------</span></span>
<span id="cb23-1804"><a href="#cb23-1804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1805"><a href="#cb23-1805" aria-hidden="true" tabindex="-1"></a><span class="co">## State Ownership Analysis {#sec-state-ownership}</span></span>
<span id="cb23-1806"><a href="#cb23-1806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1807"><a href="#cb23-1807" aria-hidden="true" tabindex="-1"></a><span class="co">### Equitization and the Decline of State Ownership</span></span>
<span id="cb23-1808"><a href="#cb23-1808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1809"><a href="#cb23-1809" aria-hidden="true" tabindex="-1"></a>Vietnam<span class="st">'s equitization (cổ phần hóa) program has been a defining feature of the market since the early 2000s. The program converts state-owned enterprises into joint-stock companies, typically with the state retaining a controlling or significant minority stake that is then gradually reduced through secondary offerings.</span></span>
<span id="cb23-1810"><a href="#cb23-1810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1813"><a href="#cb23-1813" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1814"><a href="#cb23-1814" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: state-ownership-analysis</span></span>
<span id="cb23-1815"><a href="#cb23-1815" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Analyze State Ownership Dynamics and Equitization Trends"</span></span>
<span id="cb23-1816"><a href="#cb23-1816" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1817"><a href="#cb23-1817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1818"><a href="#cb23-1818" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1819"><a href="#cb23-1819" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 9: State Ownership Analysis</span></span>
<span id="cb23-1820"><a href="#cb23-1820" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================================</span></span>
<span id="cb23-1821"><a href="#cb23-1821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1822"><a href="#cb23-1822" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_state_ownership(metrics: pd.DataFrame) <span class="op">-&gt;</span> Dict:</span>
<span id="cb23-1823"><a href="#cb23-1823" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-1824"><a href="#cb23-1824" aria-hidden="true" tabindex="-1"></a><span class="st">    Comprehensive analysis of state ownership in Vietnam.</span></span>
<span id="cb23-1825"><a href="#cb23-1825" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1826"><a href="#cb23-1826" aria-hidden="true" tabindex="-1"></a><span class="st">    Computes:</span></span>
<span id="cb23-1827"><a href="#cb23-1827" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Aggregate state ownership trends</span></span>
<span id="cb23-1828"><a href="#cb23-1828" aria-hidden="true" tabindex="-1"></a><span class="st">    2. SOE population dynamics (entry/exit from SOE classification)</span></span>
<span id="cb23-1829"><a href="#cb23-1829" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Equitization event detection (large drops in state ownership)</span></span>
<span id="cb23-1830"><a href="#cb23-1830" aria-hidden="true" tabindex="-1"></a><span class="st">    4. State ownership by sector and size</span></span>
<span id="cb23-1831"><a href="#cb23-1831" aria-hidden="true" tabindex="-1"></a><span class="st">    5. Governance implications (state as blockholder)</span></span>
<span id="cb23-1832"><a href="#cb23-1832" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-1833"><a href="#cb23-1833" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb23-1834"><a href="#cb23-1834" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1835"><a href="#cb23-1835" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 1. Aggregate Trends ---</span></span>
<span id="cb23-1836"><a href="#cb23-1836" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>).agg(</span>
<span id="cb23-1837"><a href="#cb23-1837" aria-hidden="true" tabindex="-1"></a>        n_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'sum'</span>),</span>
<span id="cb23-1838"><a href="#cb23-1838" aria-hidden="true" tabindex="-1"></a>        n_total<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-1839"><a href="#cb23-1839" aria-hidden="true" tabindex="-1"></a>        pct_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1840"><a href="#cb23-1840" aria-hidden="true" tabindex="-1"></a>        mean_state_pct<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1841"><a href="#cb23-1841" aria-hidden="true" tabindex="-1"></a>        median_state_pct<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'median'</span>),</span>
<span id="cb23-1842"><a href="#cb23-1842" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market cap share of SOEs</span></span>
<span id="cb23-1843"><a href="#cb23-1843" aria-hidden="true" tabindex="-1"></a>        soe_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="kw">lambda</span> x: x[df.loc[x.index, <span class="st">'is_soe'</span>] <span class="op">==</span> <span class="dv">1</span>].<span class="bu">sum</span>()),</span>
<span id="cb23-1844"><a href="#cb23-1844" aria-hidden="true" tabindex="-1"></a>        total_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'sum'</span>),</span>
<span id="cb23-1845"><a href="#cb23-1845" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-1846"><a href="#cb23-1846" aria-hidden="true" tabindex="-1"></a>    ts[<span class="st">'soe_mktcap_share'</span>] <span class="op">=</span> ts[<span class="st">'soe_mktcap'</span>] <span class="op">/</span> ts[<span class="st">'total_mktcap'</span>]</span>
<span id="cb23-1847"><a href="#cb23-1847" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1848"><a href="#cb23-1848" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 2. Equitization Events ---</span></span>
<span id="cb23-1849"><a href="#cb23-1849" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect large drops in state ownership (&gt;10 percentage points)</span></span>
<span id="cb23-1850"><a href="#cb23-1850" aria-hidden="true" tabindex="-1"></a>    df_sorted <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb23-1851"><a href="#cb23-1851" aria-hidden="true" tabindex="-1"></a>    df_sorted[<span class="st">'state_change'</span>] <span class="op">=</span> df_sorted.groupby(<span class="st">'ticker'</span>)[<span class="st">'pct_state'</span>].diff()</span>
<span id="cb23-1852"><a href="#cb23-1852" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1853"><a href="#cb23-1853" aria-hidden="true" tabindex="-1"></a>    equitization_events <span class="op">=</span> df_sorted[</span>
<span id="cb23-1854"><a href="#cb23-1854" aria-hidden="true" tabindex="-1"></a>        df_sorted[<span class="st">'state_change'</span>] <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.10</span>  <span class="co"># &gt; 10pp drop</span></span>
<span id="cb23-1855"><a href="#cb23-1855" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'pct_state'</span>, <span class="st">'state_change'</span>, <span class="st">'market_cap'</span>]].copy()</span>
<span id="cb23-1856"><a href="#cb23-1856" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1857"><a href="#cb23-1857" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- 3. By Sector ---</span></span>
<span id="cb23-1858"><a href="#cb23-1858" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'industry_code'</span> <span class="kw">in</span> df.columns:</span>
<span id="cb23-1859"><a href="#cb23-1859" aria-hidden="true" tabindex="-1"></a>        by_sector <span class="op">=</span> df.groupby(<span class="st">'industry_code'</span>).agg(</span>
<span id="cb23-1860"><a href="#cb23-1860" aria-hidden="true" tabindex="-1"></a>            mean_state<span class="op">=</span>(<span class="st">'pct_state'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1861"><a href="#cb23-1861" aria-hidden="true" tabindex="-1"></a>            pct_soe<span class="op">=</span>(<span class="st">'is_soe'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1862"><a href="#cb23-1862" aria-hidden="true" tabindex="-1"></a>            n_firms<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-1863"><a href="#cb23-1863" aria-hidden="true" tabindex="-1"></a>        ).sort_values(<span class="st">'mean_state'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-1864"><a href="#cb23-1864" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-1865"><a href="#cb23-1865" aria-hidden="true" tabindex="-1"></a>        by_sector <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-1866"><a href="#cb23-1866" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1867"><a href="#cb23-1867" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"State Ownership Analysis:"</span>)</span>
<span id="cb23-1868"><a href="#cb23-1868" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Current SOE count: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'n_soe'</span>]<span class="sc">:.0f}</span><span class="ss"> / </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'n_total'</span>]<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-1869"><a href="#cb23-1869" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  SOE market cap share: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'soe_mktcap_share'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-1870"><a href="#cb23-1870" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean state ownership: </span><span class="sc">{</span>ts<span class="sc">.</span>iloc[<span class="op">-</span><span class="dv">1</span>][<span class="st">'mean_state_pct'</span>]<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-1871"><a href="#cb23-1871" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Equitization events detected: </span><span class="sc">{</span><span class="bu">len</span>(equitization_events)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb23-1872"><a href="#cb23-1872" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1873"><a href="#cb23-1873" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb23-1874"><a href="#cb23-1874" aria-hidden="true" tabindex="-1"></a>        <span class="st">'trends'</span>: ts,</span>
<span id="cb23-1875"><a href="#cb23-1875" aria-hidden="true" tabindex="-1"></a>        <span class="st">'equitization_events'</span>: equitization_events,</span>
<span id="cb23-1876"><a href="#cb23-1876" aria-hidden="true" tabindex="-1"></a>        <span class="st">'by_sector'</span>: by_sector,</span>
<span id="cb23-1877"><a href="#cb23-1877" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-1878"><a href="#cb23-1878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1879"><a href="#cb23-1879" aria-hidden="true" tabindex="-1"></a><span class="co"># state_analysis = analyze_state_ownership(io_metrics)</span></span>
<span id="cb23-1880"><a href="#cb23-1880" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-1881"><a href="#cb23-1881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1884"><a href="#cb23-1884" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1885"><a href="#cb23-1885" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-state-ownership</span></span>
<span id="cb23-1886"><a href="#cb23-1886" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Evolution of State Ownership in Vietnam. Panel A shows the declining share of SOEs and their market cap weight. Panel B shows the distribution of state ownership percentages, illustrating the bimodal pattern between firms with negligible state ownership and those with dominant state control."</span></span>
<span id="cb23-1887"><a href="#cb23-1887" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 10</span></span>
<span id="cb23-1888"><a href="#cb23-1888" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1889"><a href="#cb23-1889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1890"><a href="#cb23-1890" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_state_ownership(state_analysis: Dict, metrics: pd.DataFrame):</span>
<span id="cb23-1891"><a href="#cb23-1891" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""Plot state ownership dynamics."""</span></span>
<span id="cb23-1892"><a href="#cb23-1892" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb23-1893"><a href="#cb23-1893" aria-hidden="true" tabindex="-1"></a>    ts <span class="op">=</span> state_analysis[<span class="st">'trends'</span>]</span>
<span id="cb23-1894"><a href="#cb23-1894" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1895"><a href="#cb23-1895" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Panel A: SOE trends</span></span>
<span id="cb23-1896"><a href="#cb23-1896" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">0</span>]</span>
<span id="cb23-1897"><a href="#cb23-1897" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'pct_soe'</span>] <span class="op">*</span> <span class="dv">100</span>, </span>
<span id="cb23-1898"><a href="#cb23-1898" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'</span><span class="sc">% o</span><span class="st">f Firms that are SOEs'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#d62728'</span>)</span>
<span id="cb23-1899"><a href="#cb23-1899" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'soe_mktcap_share'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1900"><a href="#cb23-1900" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'SOE Market Cap Share (%)'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#1f77b4'</span>)</span>
<span id="cb23-1901"><a href="#cb23-1901" aria-hidden="true" tabindex="-1"></a>    ax.plot(ts[<span class="st">'quarter_end'</span>], ts[<span class="st">'mean_state_pct'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-1902"><a href="#cb23-1902" aria-hidden="true" tabindex="-1"></a>            label<span class="op">=</span><span class="st">'Mean State Ownership (%)'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">'#2ca02c'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>)</span>
<span id="cb23-1903"><a href="#cb23-1903" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Percentage'</span>)</span>
<span id="cb23-1904"><a href="#cb23-1904" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel A: State Ownership and SOE Prevalence Over Time'</span>)</span>
<span id="cb23-1905"><a href="#cb23-1905" aria-hidden="true" tabindex="-1"></a>    ax.legend(frameon<span class="op">=</span><span class="va">True</span>, framealpha<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb23-1906"><a href="#cb23-1906" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1907"><a href="#cb23-1907" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Panel B: Distribution</span></span>
<span id="cb23-1908"><a href="#cb23-1908" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> axes[<span class="dv">1</span>]</span>
<span id="cb23-1909"><a href="#cb23-1909" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use most recent period</span></span>
<span id="cb23-1910"><a href="#cb23-1910" aria-hidden="true" tabindex="-1"></a>    latest <span class="op">=</span> metrics[metrics[<span class="st">'quarter_end'</span>] <span class="op">==</span> metrics[<span class="st">'quarter_end'</span>].<span class="bu">max</span>()]</span>
<span id="cb23-1911"><a href="#cb23-1911" aria-hidden="true" tabindex="-1"></a>    state_pct <span class="op">=</span> latest[<span class="st">'pct_state'</span>].dropna() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-1912"><a href="#cb23-1912" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1913"><a href="#cb23-1913" aria-hidden="true" tabindex="-1"></a>    ax.hist(state_pct, bins<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'#d62728'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'black'</span>)</span>
<span id="cb23-1914"><a href="#cb23-1914" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'black'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span><span class="st">'50% (SOE threshold)'</span>)</span>
<span id="cb23-1915"><a href="#cb23-1915" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'State Ownership (%)'</span>)</span>
<span id="cb23-1916"><a href="#cb23-1916" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Number of Companies'</span>)</span>
<span id="cb23-1917"><a href="#cb23-1917" aria-hidden="true" tabindex="-1"></a>    ax.set_title(<span class="st">'Panel B: Distribution of State Ownership (Most Recent Quarter)'</span>)</span>
<span id="cb23-1918"><a href="#cb23-1918" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb23-1919"><a href="#cb23-1919" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1920"><a href="#cb23-1920" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb23-1921"><a href="#cb23-1921" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'fig_state_ownership.png'</span>, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">'tight'</span>)</span>
<span id="cb23-1922"><a href="#cb23-1922" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb23-1923"><a href="#cb23-1923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1924"><a href="#cb23-1924" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_state_ownership(state_analysis, io_metrics)</span></span>
<span id="cb23-1925"><a href="#cb23-1925" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-1926"><a href="#cb23-1926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1927"><a href="#cb23-1927" aria-hidden="true" tabindex="-1"></a><span class="op">------------------------------------------------------------------------</span></span>
<span id="cb23-1928"><a href="#cb23-1928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1929"><a href="#cb23-1929" aria-hidden="true" tabindex="-1"></a><span class="co">## Modern Extensions {#sec-modern-extensions}</span></span>
<span id="cb23-1930"><a href="#cb23-1930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1931"><a href="#cb23-1931" aria-hidden="true" tabindex="-1"></a><span class="co">### Network Analysis of Co-Ownership {#sec-network}</span></span>
<span id="cb23-1932"><a href="#cb23-1932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1933"><a href="#cb23-1933" aria-hidden="true" tabindex="-1"></a>Institutional co<span class="op">-</span>ownership networks capture how stocks are connected through shared investors. In Vietnam, these networks reveal the influence structure of major domestic conglomerates (e.g., Vingroup, Masan, FPT) <span class="kw">and</span> the overlap between foreign fund portfolios.</span>
<span id="cb23-1934"><a href="#cb23-1934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1937"><a href="#cb23-1937" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1938"><a href="#cb23-1938" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: coownership-network</span></span>
<span id="cb23-1939"><a href="#cb23-1939" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Construct Co-Ownership Network for Vietnamese Stocks"</span></span>
<span id="cb23-1940"><a href="#cb23-1940" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1941"><a href="#cb23-1941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1942"><a href="#cb23-1942" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_stock_coownership_network(ownership: pd.DataFrame,</span>
<span id="cb23-1943"><a href="#cb23-1943" aria-hidden="true" tabindex="-1"></a>                                         period: <span class="bu">str</span>,</span>
<span id="cb23-1944"><a href="#cb23-1944" aria-hidden="true" tabindex="-1"></a>                                         min_overlap: <span class="bu">int</span> <span class="op">=</span> <span class="dv">3</span>) <span class="op">-&gt;</span> Dict:</span>
<span id="cb23-1945"><a href="#cb23-1945" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-1946"><a href="#cb23-1946" aria-hidden="true" tabindex="-1"></a><span class="st">    Construct a stock-level co-ownership network.</span></span>
<span id="cb23-1947"><a href="#cb23-1947" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1948"><a href="#cb23-1948" aria-hidden="true" tabindex="-1"></a><span class="st">    Two stocks are connected if they share institutional investors.</span></span>
<span id="cb23-1949"><a href="#cb23-1949" aria-hidden="true" tabindex="-1"></a><span class="st">    Edge weight = number of shared institutional investors.</span></span>
<span id="cb23-1950"><a href="#cb23-1950" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1951"><a href="#cb23-1951" aria-hidden="true" tabindex="-1"></a><span class="st">    This is particularly informative in Vietnam where:</span></span>
<span id="cb23-1952"><a href="#cb23-1952" aria-hidden="true" tabindex="-1"></a><span class="st">    - Foreign fund portfolios concentrate on the same blue-chips</span></span>
<span id="cb23-1953"><a href="#cb23-1953" aria-hidden="true" tabindex="-1"></a><span class="st">    - Conglomerate cross-holdings create explicit linkages</span></span>
<span id="cb23-1954"><a href="#cb23-1954" aria-hidden="true" tabindex="-1"></a><span class="st">    - State ownership creates implicit connections (SCIC holds multiple stocks)</span></span>
<span id="cb23-1955"><a href="#cb23-1955" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1956"><a href="#cb23-1956" aria-hidden="true" tabindex="-1"></a><span class="st">    Parameters</span></span>
<span id="cb23-1957"><a href="#cb23-1957" aria-hidden="true" tabindex="-1"></a><span class="st">    ----------</span></span>
<span id="cb23-1958"><a href="#cb23-1958" aria-hidden="true" tabindex="-1"></a><span class="st">    ownership : pd.DataFrame</span></span>
<span id="cb23-1959"><a href="#cb23-1959" aria-hidden="true" tabindex="-1"></a><span class="st">        Classified ownership data</span></span>
<span id="cb23-1960"><a href="#cb23-1960" aria-hidden="true" tabindex="-1"></a><span class="st">    period : str</span></span>
<span id="cb23-1961"><a href="#cb23-1961" aria-hidden="true" tabindex="-1"></a><span class="st">        Analysis date</span></span>
<span id="cb23-1962"><a href="#cb23-1962" aria-hidden="true" tabindex="-1"></a><span class="st">    min_overlap : int</span></span>
<span id="cb23-1963"><a href="#cb23-1963" aria-hidden="true" tabindex="-1"></a><span class="st">        Minimum shared investors to create an edge</span></span>
<span id="cb23-1964"><a href="#cb23-1964" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-1965"><a href="#cb23-1965" aria-hidden="true" tabindex="-1"></a><span class="st">    Returns</span></span>
<span id="cb23-1966"><a href="#cb23-1966" aria-hidden="true" tabindex="-1"></a><span class="st">    -------</span></span>
<span id="cb23-1967"><a href="#cb23-1967" aria-hidden="true" tabindex="-1"></a><span class="st">    dict with network statistics and adjacency data</span></span>
<span id="cb23-1968"><a href="#cb23-1968" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-1969"><a href="#cb23-1969" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> networkx <span class="im">as</span> nx</span>
<span id="cb23-1970"><a href="#cb23-1970" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1971"><a href="#cb23-1971" aria-hidden="true" tabindex="-1"></a>    date <span class="op">=</span> pd.Timestamp(period)</span>
<span id="cb23-1972"><a href="#cb23-1972" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1973"><a href="#cb23-1973" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get institutional holders for this period</span></span>
<span id="cb23-1974"><a href="#cb23-1974" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb23-1975"><a href="#cb23-1975" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'date'</span>] <span class="op">==</span> date) <span class="op">&amp;</span></span>
<span id="cb23-1976"><a href="#cb23-1976" aria-hidden="true" tabindex="-1"></a>        (ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL))</span>
<span id="cb23-1977"><a href="#cb23-1977" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'ticker'</span>, <span class="st">'shareholder_name'</span>, <span class="st">'owner_type'</span>]].copy()</span>
<span id="cb23-1978"><a href="#cb23-1978" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1979"><a href="#cb23-1979" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create bipartite mapping: institution → set of stocks held</span></span>
<span id="cb23-1980"><a href="#cb23-1980" aria-hidden="true" tabindex="-1"></a>    inst_to_stocks <span class="op">=</span> inst.groupby(<span class="st">'shareholder_name'</span>)[<span class="st">'ticker'</span>].<span class="bu">apply</span>(<span class="bu">set</span>).to_dict()</span>
<span id="cb23-1981"><a href="#cb23-1981" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1982"><a href="#cb23-1982" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Stock → set of institutions</span></span>
<span id="cb23-1983"><a href="#cb23-1983" aria-hidden="true" tabindex="-1"></a>    stock_to_inst <span class="op">=</span> inst.groupby(<span class="st">'ticker'</span>)[<span class="st">'shareholder_name'</span>].<span class="bu">apply</span>(<span class="bu">set</span>).to_dict()</span>
<span id="cb23-1984"><a href="#cb23-1984" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1985"><a href="#cb23-1985" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build stock-level network</span></span>
<span id="cb23-1986"><a href="#cb23-1986" aria-hidden="true" tabindex="-1"></a>    stocks <span class="op">=</span> <span class="bu">list</span>(stock_to_inst.keys())</span>
<span id="cb23-1987"><a href="#cb23-1987" aria-hidden="true" tabindex="-1"></a>    G <span class="op">=</span> nx.Graph()</span>
<span id="cb23-1988"><a href="#cb23-1988" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1989"><a href="#cb23-1989" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(stocks)):</span>
<span id="cb23-1990"><a href="#cb23-1990" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(i <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(stocks)):</span>
<span id="cb23-1991"><a href="#cb23-1991" aria-hidden="true" tabindex="-1"></a>            shared <span class="op">=</span> stock_to_inst[stocks[i]] <span class="op">&amp;</span> stock_to_inst[stocks[j]]</span>
<span id="cb23-1992"><a href="#cb23-1992" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(shared) <span class="op">&gt;=</span> min_overlap:</span>
<span id="cb23-1993"><a href="#cb23-1993" aria-hidden="true" tabindex="-1"></a>                G.add_edge(stocks[i], stocks[j], weight<span class="op">=</span><span class="bu">len</span>(shared),</span>
<span id="cb23-1994"><a href="#cb23-1994" aria-hidden="true" tabindex="-1"></a>                           shared_investors<span class="op">=</span><span class="bu">list</span>(shared)[:<span class="dv">5</span>])  <span class="co"># Store sample</span></span>
<span id="cb23-1995"><a href="#cb23-1995" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1996"><a href="#cb23-1996" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add node attributes</span></span>
<span id="cb23-1997"><a href="#cb23-1997" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> stock <span class="kw">in</span> stocks:</span>
<span id="cb23-1998"><a href="#cb23-1998" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> stock <span class="kw">in</span> G.nodes:</span>
<span id="cb23-1999"><a href="#cb23-1999" aria-hidden="true" tabindex="-1"></a>            G.nodes[stock][<span class="st">'n_inst_holders'</span>] <span class="op">=</span> <span class="bu">len</span>(stock_to_inst[stock])</span>
<span id="cb23-2000"><a href="#cb23-2000" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2001"><a href="#cb23-2001" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Network statistics</span></span>
<span id="cb23-2002"><a href="#cb23-2002" aria-hidden="true" tabindex="-1"></a>    stats <span class="op">=</span> {</span>
<span id="cb23-2003"><a href="#cb23-2003" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_nodes'</span>: G.number_of_nodes(),</span>
<span id="cb23-2004"><a href="#cb23-2004" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_edges'</span>: G.number_of_edges(),</span>
<span id="cb23-2005"><a href="#cb23-2005" aria-hidden="true" tabindex="-1"></a>        <span class="st">'density'</span>: nx.density(G) <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb23-2006"><a href="#cb23-2006" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_clustering'</span>: nx.average_clustering(G, weight<span class="op">=</span><span class="st">'weight'</span>) <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb23-2007"><a href="#cb23-2007" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_components'</span>: nx.number_connected_components(G),</span>
<span id="cb23-2008"><a href="#cb23-2008" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-2009"><a href="#cb23-2009" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2010"><a href="#cb23-2010" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Centrality measures</span></span>
<span id="cb23-2011"><a href="#cb23-2011" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-2012"><a href="#cb23-2012" aria-hidden="true" tabindex="-1"></a>        degree_cent <span class="op">=</span> nx.degree_centrality(G)</span>
<span id="cb23-2013"><a href="#cb23-2013" aria-hidden="true" tabindex="-1"></a>        stats[<span class="st">'most_connected'</span>] <span class="op">=</span> <span class="bu">sorted</span>(degree_cent.items(), </span>
<span id="cb23-2014"><a href="#cb23-2014" aria-hidden="true" tabindex="-1"></a>                                          key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">10</span>]</span>
<span id="cb23-2015"><a href="#cb23-2015" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2016"><a href="#cb23-2016" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> G.number_of_nodes() <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb23-2017"><a href="#cb23-2017" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb23-2018"><a href="#cb23-2018" aria-hidden="true" tabindex="-1"></a>                eigen_cent <span class="op">=</span> nx.eigenvector_centrality_numpy(G, weight<span class="op">=</span><span class="st">'weight'</span>)</span>
<span id="cb23-2019"><a href="#cb23-2019" aria-hidden="true" tabindex="-1"></a>                stats[<span class="st">'most_central'</span>] <span class="op">=</span> <span class="bu">sorted</span>(eigen_cent.items(),</span>
<span id="cb23-2020"><a href="#cb23-2020" aria-hidden="true" tabindex="-1"></a>                                                key<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="dv">1</span>], reverse<span class="op">=</span><span class="va">True</span>)[:<span class="dv">10</span>]</span>
<span id="cb23-2021"><a href="#cb23-2021" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb23-2022"><a href="#cb23-2022" aria-hidden="true" tabindex="-1"></a>                stats[<span class="st">'most_central'</span>] <span class="op">=</span> []</span>
<span id="cb23-2023"><a href="#cb23-2023" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2024"><a href="#cb23-2024" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Co-Ownership Network (</span><span class="sc">{</span>period<span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb23-2025"><a href="#cb23-2025" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> stats.items():</span>
<span id="cb23-2026"><a href="#cb23-2026" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'most_connected'</span>, <span class="st">'most_central'</span>]:</span>
<span id="cb23-2027"><a href="#cb23-2027" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-2028"><a href="#cb23-2028" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2029"><a href="#cb23-2029" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'most_connected'</span> <span class="kw">in</span> stats:</span>
<span id="cb23-2030"><a href="#cb23-2030" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Most connected stocks:"</span>)</span>
<span id="cb23-2031"><a href="#cb23-2031" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> stock, cent <span class="kw">in</span> stats[<span class="st">'most_connected'</span>][:<span class="dv">5</span>]:</span>
<span id="cb23-2032"><a href="#cb23-2032" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>stock<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>cent<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb23-2033"><a href="#cb23-2033" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2034"><a href="#cb23-2034" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">'graph'</span>: G, <span class="st">'stats'</span>: stats}</span>
<span id="cb23-2035"><a href="#cb23-2035" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2036"><a href="#cb23-2036" aria-hidden="true" tabindex="-1"></a><span class="co"># network = construct_stock_coownership_network(</span></span>
<span id="cb23-2037"><a href="#cb23-2037" aria-hidden="true" tabindex="-1"></a><span class="co">#     ownership_classified, '2024-06-30'</span></span>
<span id="cb23-2038"><a href="#cb23-2038" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb23-2039"><a href="#cb23-2039" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2040"><a href="#cb23-2040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2041"><a href="#cb23-2041" aria-hidden="true" tabindex="-1"></a><span class="co">### ML-Enhanced Investor Classification {#sec-ml-classification}</span></span>
<span id="cb23-2042"><a href="#cb23-2042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2043"><a href="#cb23-2043" aria-hidden="true" tabindex="-1"></a>Vietnam<span class="st">'s investor classification challenge is distinct from the US. While the US has the Bushee typology based on portfolio turnover and concentration, Vietnam requires classification of both investor **type** (when not explicitly labeled) and investor **behavior** (active vs passive, short-term vs long-term).</span></span>
<span id="cb23-2044"><a href="#cb23-2044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2047"><a href="#cb23-2047" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-2048"><a href="#cb23-2048" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ml-classification-vn</span></span>
<span id="cb23-2049"><a href="#cb23-2049" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Machine Learning Investor Classification for Vietnam"</span></span>
<span id="cb23-2050"><a href="#cb23-2050" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-2051"><a href="#cb23-2051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2052"><a href="#cb23-2052" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_investors_vietnam(ownership: pd.DataFrame,</span>
<span id="cb23-2053"><a href="#cb23-2053" aria-hidden="true" tabindex="-1"></a>                                prices_q: pd.DataFrame,</span>
<span id="cb23-2054"><a href="#cb23-2054" aria-hidden="true" tabindex="-1"></a>                                n_clusters: <span class="bu">int</span> <span class="op">=</span> <span class="dv">4</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2055"><a href="#cb23-2055" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-2056"><a href="#cb23-2056" aria-hidden="true" tabindex="-1"></a><span class="st">    ML-based classification of Vietnamese institutional investors.</span></span>
<span id="cb23-2057"><a href="#cb23-2057" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2058"><a href="#cb23-2058" aria-hidden="true" tabindex="-1"></a><span class="st">    Features adapted for Vietnam's market:</span></span>
<span id="cb23-2059"><a href="#cb23-2059" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Portfolio concentration (HHI of holdings)</span></span>
<span id="cb23-2060"><a href="#cb23-2060" aria-hidden="true" tabindex="-1"></a><span class="st">    2. Holding duration (average time in positions)</span></span>
<span id="cb23-2061"><a href="#cb23-2061" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Size preference (average market cap of holdings)</span></span>
<span id="cb23-2062"><a href="#cb23-2062" aria-hidden="true" tabindex="-1"></a><span class="st">    4. Sector concentration</span></span>
<span id="cb23-2063"><a href="#cb23-2063" aria-hidden="true" tabindex="-1"></a><span class="st">    5. Foreign/domestic indicator</span></span>
<span id="cb23-2064"><a href="#cb23-2064" aria-hidden="true" tabindex="-1"></a><span class="st">    6. Trading frequency (inverse of average days between disclosures)</span></span>
<span id="cb23-2065"><a href="#cb23-2065" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2066"><a href="#cb23-2066" aria-hidden="true" tabindex="-1"></a><span class="st">    Expected clusters for Vietnam:</span></span>
<span id="cb23-2067"><a href="#cb23-2067" aria-hidden="true" tabindex="-1"></a><span class="st">    - Passive State Holders: SOE parents, SCIC - low turnover, concentrated</span></span>
<span id="cb23-2068"><a href="#cb23-2068" aria-hidden="true" tabindex="-1"></a><span class="st">    - Active Foreign Funds: Dragon Capital, VinaCapital - moderate turnover</span></span>
<span id="cb23-2069"><a href="#cb23-2069" aria-hidden="true" tabindex="-1"></a><span class="st">    - Domestic Securities Firms: SSI, VNDirect - high turnover, diversified</span></span>
<span id="cb23-2070"><a href="#cb23-2070" aria-hidden="true" tabindex="-1"></a><span class="st">    - Long-Term Foreign: Pension funds, sovereign wealth - low turnover</span></span>
<span id="cb23-2071"><a href="#cb23-2071" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-2072"><a href="#cb23-2072" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.cluster <span class="im">import</span> KMeans</span>
<span id="cb23-2073"><a href="#cb23-2073" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb23-2074"><a href="#cb23-2074" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2075"><a href="#cb23-2075" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> ownership[</span>
<span id="cb23-2076"><a href="#cb23-2076" aria-hidden="true" tabindex="-1"></a>        ownership[<span class="st">'owner_type'</span>].isin(OwnershipType.INSTITUTIONAL)</span>
<span id="cb23-2077"><a href="#cb23-2077" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb23-2078"><a href="#cb23-2078" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2079"><a href="#cb23-2079" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with price data</span></span>
<span id="cb23-2080"><a href="#cb23-2080" aria-hidden="true" tabindex="-1"></a>    inst <span class="op">=</span> inst.merge(</span>
<span id="cb23-2081"><a href="#cb23-2081" aria-hidden="true" tabindex="-1"></a>        prices_q[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>, <span class="st">'close'</span>, <span class="st">'market_cap'</span>]],</span>
<span id="cb23-2082"><a href="#cb23-2082" aria-hidden="true" tabindex="-1"></a>        left_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>],</span>
<span id="cb23-2083"><a href="#cb23-2083" aria-hidden="true" tabindex="-1"></a>        right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>],</span>
<span id="cb23-2084"><a href="#cb23-2084" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb23-2085"><a href="#cb23-2085" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2086"><a href="#cb23-2086" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2087"><a href="#cb23-2087" aria-hidden="true" tabindex="-1"></a>    inst[<span class="st">'holding_value'</span>] <span class="op">=</span> inst[<span class="st">'shares_held'</span>] <span class="op">*</span> inst[<span class="st">'close'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-2088"><a href="#cb23-2088" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2089"><a href="#cb23-2089" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute features per investor-period</span></span>
<span id="cb23-2090"><a href="#cb23-2090" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> inst.groupby([<span class="st">'shareholder_name'</span>, <span class="st">'date'</span>]).agg(</span>
<span id="cb23-2091"><a href="#cb23-2091" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-2092"><a href="#cb23-2092" aria-hidden="true" tabindex="-1"></a>        total_value<span class="op">=</span>(<span class="st">'holding_value'</span>, <span class="st">'sum'</span>),</span>
<span id="cb23-2093"><a href="#cb23-2093" aria-hidden="true" tabindex="-1"></a>        hhi_portfolio<span class="op">=</span>(<span class="st">'holding_value'</span>, </span>
<span id="cb23-2094"><a href="#cb23-2094" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">lambda</span> x: ((x<span class="op">/</span>x.<span class="bu">sum</span>())<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>() <span class="cf">if</span> x.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan),</span>
<span id="cb23-2095"><a href="#cb23-2095" aria-hidden="true" tabindex="-1"></a>        avg_mktcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2096"><a href="#cb23-2096" aria-hidden="true" tabindex="-1"></a>        is_foreign<span class="op">=</span>(<span class="st">'owner_type'</span>, </span>
<span id="cb23-2097"><a href="#cb23-2097" aria-hidden="true" tabindex="-1"></a>                     <span class="kw">lambda</span> x: (x <span class="op">==</span> OwnershipType.FOREIGN_INST).<span class="bu">any</span>().astype(<span class="bu">int</span>)),</span>
<span id="cb23-2098"><a href="#cb23-2098" aria-hidden="true" tabindex="-1"></a>        is_state<span class="op">=</span>(<span class="st">'owner_type'</span>, </span>
<span id="cb23-2099"><a href="#cb23-2099" aria-hidden="true" tabindex="-1"></a>                   <span class="kw">lambda</span> x: (x <span class="op">==</span> OwnershipType.STATE).<span class="bu">any</span>().astype(<span class="bu">int</span>)),</span>
<span id="cb23-2100"><a href="#cb23-2100" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-2101"><a href="#cb23-2101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2102"><a href="#cb23-2102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average across all periods per investor</span></span>
<span id="cb23-2103"><a href="#cb23-2103" aria-hidden="true" tabindex="-1"></a>    investor_features <span class="op">=</span> features.groupby(<span class="st">'shareholder_name'</span>).agg(</span>
<span id="cb23-2104"><a href="#cb23-2104" aria-hidden="true" tabindex="-1"></a>        avg_n_stocks<span class="op">=</span>(<span class="st">'n_stocks'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2105"><a href="#cb23-2105" aria-hidden="true" tabindex="-1"></a>        avg_hhi<span class="op">=</span>(<span class="st">'hhi_portfolio'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2106"><a href="#cb23-2106" aria-hidden="true" tabindex="-1"></a>        avg_mktcap<span class="op">=</span>(<span class="st">'avg_mktcap'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2107"><a href="#cb23-2107" aria-hidden="true" tabindex="-1"></a>        avg_total_value<span class="op">=</span>(<span class="st">'total_value'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2108"><a href="#cb23-2108" aria-hidden="true" tabindex="-1"></a>        is_foreign<span class="op">=</span>(<span class="st">'is_foreign'</span>, <span class="st">'max'</span>),</span>
<span id="cb23-2109"><a href="#cb23-2109" aria-hidden="true" tabindex="-1"></a>        is_state<span class="op">=</span>(<span class="st">'is_state'</span>, <span class="st">'max'</span>),</span>
<span id="cb23-2110"><a href="#cb23-2110" aria-hidden="true" tabindex="-1"></a>        n_periods<span class="op">=</span>(<span class="st">'date'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-2111"><a href="#cb23-2111" aria-hidden="true" tabindex="-1"></a>    ).dropna()</span>
<span id="cb23-2112"><a href="#cb23-2112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2113"><a href="#cb23-2113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feature matrix</span></span>
<span id="cb23-2114"><a href="#cb23-2114" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [<span class="st">'avg_n_stocks'</span>, <span class="st">'avg_hhi'</span>, <span class="st">'avg_mktcap'</span>, <span class="st">'avg_total_value'</span>]</span>
<span id="cb23-2115"><a href="#cb23-2115" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> investor_features[feature_cols].copy()</span>
<span id="cb23-2116"><a href="#cb23-2116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2117"><a href="#cb23-2117" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log-transform</span></span>
<span id="cb23-2118"><a href="#cb23-2118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> feature_cols:</span>
<span id="cb23-2119"><a href="#cb23-2119" aria-hidden="true" tabindex="-1"></a>        X[col] <span class="op">=</span> np.log1p(X[col].clip(lower<span class="op">=</span><span class="dv">0</span>))</span>
<span id="cb23-2120"><a href="#cb23-2120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2121"><a href="#cb23-2121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add binary features</span></span>
<span id="cb23-2122"><a href="#cb23-2122" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'is_foreign'</span>] <span class="op">=</span> investor_features[<span class="st">'is_foreign'</span>]</span>
<span id="cb23-2123"><a href="#cb23-2123" aria-hidden="true" tabindex="-1"></a>    X[<span class="st">'is_state'</span>] <span class="op">=</span> investor_features[<span class="st">'is_state'</span>]</span>
<span id="cb23-2124"><a href="#cb23-2124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2125"><a href="#cb23-2125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize</span></span>
<span id="cb23-2126"><a href="#cb23-2126" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb23-2127"><a href="#cb23-2127" aria-hidden="true" tabindex="-1"></a>    X_scaled <span class="op">=</span> scaler.fit_transform(X)</span>
<span id="cb23-2128"><a href="#cb23-2128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2129"><a href="#cb23-2129" aria-hidden="true" tabindex="-1"></a>    <span class="co"># K-means</span></span>
<span id="cb23-2130"><a href="#cb23-2130" aria-hidden="true" tabindex="-1"></a>    kmeans <span class="op">=</span> KMeans(n_clusters<span class="op">=</span>n_clusters, random_state<span class="op">=</span><span class="dv">42</span>, n_init<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb23-2131"><a href="#cb23-2131" aria-hidden="true" tabindex="-1"></a>    investor_features[<span class="st">'cluster'</span>] <span class="op">=</span> kmeans.fit_predict(X_scaled)</span>
<span id="cb23-2132"><a href="#cb23-2132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2133"><a href="#cb23-2133" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Label clusters</span></span>
<span id="cb23-2134"><a href="#cb23-2134" aria-hidden="true" tabindex="-1"></a>    cluster_profiles <span class="op">=</span> investor_features.groupby(<span class="st">'cluster'</span>).agg({</span>
<span id="cb23-2135"><a href="#cb23-2135" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_n_stocks'</span>: <span class="st">'mean'</span>,</span>
<span id="cb23-2136"><a href="#cb23-2136" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_hhi'</span>: <span class="st">'mean'</span>,</span>
<span id="cb23-2137"><a href="#cb23-2137" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_total_value'</span>: <span class="st">'mean'</span>,</span>
<span id="cb23-2138"><a href="#cb23-2138" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_foreign'</span>: <span class="st">'mean'</span>,</span>
<span id="cb23-2139"><a href="#cb23-2139" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_state'</span>: <span class="st">'mean'</span>,</span>
<span id="cb23-2140"><a href="#cb23-2140" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shareholder_name'</span>: <span class="st">'count'</span>,</span>
<span id="cb23-2141"><a href="#cb23-2141" aria-hidden="true" tabindex="-1"></a>    }).rename(columns<span class="op">=</span>{<span class="st">'shareholder_name'</span>: <span class="st">'n_investors'</span>})</span>
<span id="cb23-2142"><a href="#cb23-2142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2143"><a href="#cb23-2143" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Investor Clusters:"</span>)</span>
<span id="cb23-2144"><a href="#cb23-2144" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(cluster_profiles.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb23-2145"><a href="#cb23-2145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2146"><a href="#cb23-2146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> investor_features</span>
<span id="cb23-2147"><a href="#cb23-2147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2148"><a href="#cb23-2148" aria-hidden="true" tabindex="-1"></a><span class="co"># investor_classes = classify_investors_vietnam(ownership_classified, prices_q)</span></span>
<span id="cb23-2149"><a href="#cb23-2149" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2150"><a href="#cb23-2150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2151"><a href="#cb23-2151" aria-hidden="true" tabindex="-1"></a><span class="co">### Event Study: Ownership Disclosure Shocks {#sec-event-study}</span></span>
<span id="cb23-2152"><a href="#cb23-2152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2153"><a href="#cb23-2153" aria-hidden="true" tabindex="-1"></a>Vietnam<span class="st">'s threshold-based major shareholder disclosure creates natural events for studying the price impact of ownership changes.</span></span>
<span id="cb23-2154"><a href="#cb23-2154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2157"><a href="#cb23-2157" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-2158"><a href="#cb23-2158" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: event-study</span></span>
<span id="cb23-2159"><a href="#cb23-2159" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Event Study Framework for Ownership Disclosure Events"</span></span>
<span id="cb23-2160"><a href="#cb23-2160" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-2161"><a href="#cb23-2161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2162"><a href="#cb23-2162" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ownership_event_study(major_shareholders: pd.DataFrame,</span>
<span id="cb23-2163"><a href="#cb23-2163" aria-hidden="true" tabindex="-1"></a>                           prices: pd.DataFrame,</span>
<span id="cb23-2164"><a href="#cb23-2164" aria-hidden="true" tabindex="-1"></a>                           event_window: Tuple[<span class="bu">int</span>, <span class="bu">int</span>] <span class="op">=</span> (<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>),</span>
<span id="cb23-2165"><a href="#cb23-2165" aria-hidden="true" tabindex="-1"></a>                           estimation_window: <span class="bu">int</span> <span class="op">=</span> <span class="dv">120</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2166"><a href="#cb23-2166" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-2167"><a href="#cb23-2167" aria-hidden="true" tabindex="-1"></a><span class="st">    Event study of ownership disclosure announcements.</span></span>
<span id="cb23-2168"><a href="#cb23-2168" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2169"><a href="#cb23-2169" aria-hidden="true" tabindex="-1"></a><span class="st">    Vietnam requires major shareholders (≥5%) to disclose within 7 </span></span>
<span id="cb23-2170"><a href="#cb23-2170" aria-hidden="true" tabindex="-1"></a><span class="st">    business days of crossing ownership thresholds. These disclosures </span></span>
<span id="cb23-2171"><a href="#cb23-2171" aria-hidden="true" tabindex="-1"></a><span class="st">    can be informationally significant, especially:</span></span>
<span id="cb23-2172"><a href="#cb23-2172" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Foreign fund accumulation (signal of quality)</span></span>
<span id="cb23-2173"><a href="#cb23-2173" aria-hidden="true" tabindex="-1"></a><span class="st">    2. State divestiture (equitization signal)</span></span>
<span id="cb23-2174"><a href="#cb23-2174" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Insider purchases (management confidence signal)</span></span>
<span id="cb23-2175"><a href="#cb23-2175" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2176"><a href="#cb23-2176" aria-hidden="true" tabindex="-1"></a><span class="st">    Uses market model for expected returns:</span></span>
<span id="cb23-2177"><a href="#cb23-2177" aria-hidden="true" tabindex="-1"></a><span class="st">    E[R_i,t] = α_i + β_i × R_m,t</span></span>
<span id="cb23-2178"><a href="#cb23-2178" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2179"><a href="#cb23-2179" aria-hidden="true" tabindex="-1"></a><span class="st">    Parameters</span></span>
<span id="cb23-2180"><a href="#cb23-2180" aria-hidden="true" tabindex="-1"></a><span class="st">    ----------</span></span>
<span id="cb23-2181"><a href="#cb23-2181" aria-hidden="true" tabindex="-1"></a><span class="st">    major_shareholders : pd.DataFrame</span></span>
<span id="cb23-2182"><a href="#cb23-2182" aria-hidden="true" tabindex="-1"></a><span class="st">        Disclosure events from DataCore.vn</span></span>
<span id="cb23-2183"><a href="#cb23-2183" aria-hidden="true" tabindex="-1"></a><span class="st">    prices : pd.DataFrame</span></span>
<span id="cb23-2184"><a href="#cb23-2184" aria-hidden="true" tabindex="-1"></a><span class="st">        Daily stock prices</span></span>
<span id="cb23-2185"><a href="#cb23-2185" aria-hidden="true" tabindex="-1"></a><span class="st">    event_window : tuple</span></span>
<span id="cb23-2186"><a href="#cb23-2186" aria-hidden="true" tabindex="-1"></a><span class="st">        (pre_event_days, post_event_days)</span></span>
<span id="cb23-2187"><a href="#cb23-2187" aria-hidden="true" tabindex="-1"></a><span class="st">    estimation_window : int</span></span>
<span id="cb23-2188"><a href="#cb23-2188" aria-hidden="true" tabindex="-1"></a><span class="st">        Days before event window for market model estimation</span></span>
<span id="cb23-2189"><a href="#cb23-2189" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-2190"><a href="#cb23-2190" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> major_shareholders.copy()</span>
<span id="cb23-2191"><a href="#cb23-2191" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> events.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-2192"><a href="#cb23-2192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2193"><a href="#cb23-2193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Identify significant ownership changes</span></span>
<span id="cb23-2194"><a href="#cb23-2194" aria-hidden="true" tabindex="-1"></a>    events[<span class="st">'ownership_change'</span>] <span class="op">=</span> events.groupby(</span>
<span id="cb23-2195"><a href="#cb23-2195" aria-hidden="true" tabindex="-1"></a>        [<span class="st">'ticker'</span>, <span class="st">'shareholder_name'</span>]</span>
<span id="cb23-2196"><a href="#cb23-2196" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'ownership_pct'</span>].diff()</span>
<span id="cb23-2197"><a href="#cb23-2197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2198"><a href="#cb23-2198" aria-hidden="true" tabindex="-1"></a>    significant_events <span class="op">=</span> events[</span>
<span id="cb23-2199"><a href="#cb23-2199" aria-hidden="true" tabindex="-1"></a>        events[<span class="st">'ownership_change'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">0.01</span>  <span class="co"># &gt; 1 percentage point</span></span>
<span id="cb23-2200"><a href="#cb23-2200" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb23-2201"><a href="#cb23-2201" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2202"><a href="#cb23-2202" aria-hidden="true" tabindex="-1"></a>    significant_events[<span class="st">'event_type'</span>] <span class="op">=</span> np.where(</span>
<span id="cb23-2203"><a href="#cb23-2203" aria-hidden="true" tabindex="-1"></a>        significant_events[<span class="st">'ownership_change'</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">'accumulation'</span>, <span class="st">'divestiture'</span></span>
<span id="cb23-2204"><a href="#cb23-2204" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2205"><a href="#cb23-2205" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2206"><a href="#cb23-2206" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with daily prices</span></span>
<span id="cb23-2207"><a href="#cb23-2207" aria-hidden="true" tabindex="-1"></a>    prices_daily <span class="op">=</span> prices[[<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'ret'</span>]].copy()</span>
<span id="cb23-2208"><a href="#cb23-2208" aria-hidden="true" tabindex="-1"></a>    prices_daily <span class="op">=</span> prices_daily.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb23-2209"><a href="#cb23-2209" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2210"><a href="#cb23-2210" aria-hidden="true" tabindex="-1"></a>    <span class="co"># VN-Index as market return (ticker code depends on data provider)</span></span>
<span id="cb23-2211"><a href="#cb23-2211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'VNINDEX'</span> <span class="kw">in</span> prices_daily[<span class="st">'ticker'</span>].values:</span>
<span id="cb23-2212"><a href="#cb23-2212" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> prices_daily[prices_daily[<span class="st">'ticker'</span>] <span class="op">==</span> <span class="st">'VNINDEX'</span>][[<span class="st">'date'</span>, <span class="st">'ret'</span>]].copy()</span>
<span id="cb23-2213"><a href="#cb23-2213" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> market_ret.rename(columns<span class="op">=</span>{<span class="st">'ret'</span>: <span class="st">'mkt_ret'</span>})</span>
<span id="cb23-2214"><a href="#cb23-2214" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-2215"><a href="#cb23-2215" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use equal-weighted market return as proxy</span></span>
<span id="cb23-2216"><a href="#cb23-2216" aria-hidden="true" tabindex="-1"></a>        market_ret <span class="op">=</span> (prices_daily.groupby(<span class="st">'date'</span>)[<span class="st">'ret'</span>]</span>
<span id="cb23-2217"><a href="#cb23-2217" aria-hidden="true" tabindex="-1"></a>                                  .mean()</span>
<span id="cb23-2218"><a href="#cb23-2218" aria-hidden="true" tabindex="-1"></a>                                  .reset_index()</span>
<span id="cb23-2219"><a href="#cb23-2219" aria-hidden="true" tabindex="-1"></a>                                  .rename(columns<span class="op">=</span>{<span class="st">'ret'</span>: <span class="st">'mkt_ret'</span>}))</span>
<span id="cb23-2220"><a href="#cb23-2220" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2221"><a href="#cb23-2221" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each event, compute abnormal returns</span></span>
<span id="cb23-2222"><a href="#cb23-2222" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-2223"><a href="#cb23-2223" aria-hidden="true" tabindex="-1"></a>    pre, post <span class="op">=</span> event_window</span>
<span id="cb23-2224"><a href="#cb23-2224" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2225"><a href="#cb23-2225" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> significant_events.iterrows():</span>
<span id="cb23-2226"><a href="#cb23-2226" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> event[<span class="st">'ticker'</span>]</span>
<span id="cb23-2227"><a href="#cb23-2227" aria-hidden="true" tabindex="-1"></a>        event_date <span class="op">=</span> event[<span class="st">'date'</span>]</span>
<span id="cb23-2228"><a href="#cb23-2228" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2229"><a href="#cb23-2229" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get stock returns around the event</span></span>
<span id="cb23-2230"><a href="#cb23-2230" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> prices_daily[prices_daily[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb23-2231"><a href="#cb23-2231" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> stock_ret.merge(market_ret, on<span class="op">=</span><span class="st">'date'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-2232"><a href="#cb23-2232" aria-hidden="true" tabindex="-1"></a>        stock_ret <span class="op">=</span> stock_ret.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2233"><a href="#cb23-2233" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2234"><a href="#cb23-2234" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find event date index</span></span>
<span id="cb23-2235"><a href="#cb23-2235" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> stock_ret[stock_ret[<span class="st">'date'</span>] <span class="op">&gt;=</span> event_date].index</span>
<span id="cb23-2236"><a href="#cb23-2236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_idx) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-2237"><a href="#cb23-2237" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2238"><a href="#cb23-2238" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> event_idx[<span class="dv">0</span>]</span>
<span id="cb23-2239"><a href="#cb23-2239" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2240"><a href="#cb23-2240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimation window</span></span>
<span id="cb23-2241"><a href="#cb23-2241" aria-hidden="true" tabindex="-1"></a>        est_start <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, event_idx <span class="op">-</span> estimation_window <span class="op">+</span> pre)</span>
<span id="cb23-2242"><a href="#cb23-2242" aria-hidden="true" tabindex="-1"></a>        est_end <span class="op">=</span> event_idx <span class="op">+</span> pre</span>
<span id="cb23-2243"><a href="#cb23-2243" aria-hidden="true" tabindex="-1"></a>        est_data <span class="op">=</span> stock_ret.iloc[est_start:est_end].dropna(subset<span class="op">=</span>[<span class="st">'ret'</span>, <span class="st">'mkt_ret'</span>])</span>
<span id="cb23-2244"><a href="#cb23-2244" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2245"><a href="#cb23-2245" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(est_data) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb23-2246"><a href="#cb23-2246" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2247"><a href="#cb23-2247" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2248"><a href="#cb23-2248" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market model</span></span>
<span id="cb23-2249"><a href="#cb23-2249" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(est_data[<span class="st">'mkt_ret'</span>])</span>
<span id="cb23-2250"><a href="#cb23-2250" aria-hidden="true" tabindex="-1"></a>        y <span class="op">=</span> est_data[<span class="st">'ret'</span>]</span>
<span id="cb23-2251"><a href="#cb23-2251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb23-2252"><a href="#cb23-2252" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb23-2253"><a href="#cb23-2253" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb23-2254"><a href="#cb23-2254" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2255"><a href="#cb23-2255" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2256"><a href="#cb23-2256" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event window abnormal returns</span></span>
<span id="cb23-2257"><a href="#cb23-2257" aria-hidden="true" tabindex="-1"></a>        ew_start <span class="op">=</span> event_idx <span class="op">+</span> pre</span>
<span id="cb23-2258"><a href="#cb23-2258" aria-hidden="true" tabindex="-1"></a>        ew_end <span class="op">=</span> <span class="bu">min</span>(event_idx <span class="op">+</span> post <span class="op">+</span> <span class="dv">1</span>, <span class="bu">len</span>(stock_ret))</span>
<span id="cb23-2259"><a href="#cb23-2259" aria-hidden="true" tabindex="-1"></a>        event_data <span class="op">=</span> stock_ret.iloc[ew_start:ew_end].copy()</span>
<span id="cb23-2260"><a href="#cb23-2260" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2261"><a href="#cb23-2261" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_data) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-2262"><a href="#cb23-2262" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2263"><a href="#cb23-2263" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2264"><a href="#cb23-2264" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'expected_ret'</span>] <span class="op">=</span> (model.params[<span class="st">'const'</span>] <span class="op">+</span> </span>
<span id="cb23-2265"><a href="#cb23-2265" aria-hidden="true" tabindex="-1"></a>                                       model.params[<span class="st">'mkt_ret'</span>] <span class="op">*</span> event_data[<span class="st">'mkt_ret'</span>])</span>
<span id="cb23-2266"><a href="#cb23-2266" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'abnormal_ret'</span>] <span class="op">=</span> event_data[<span class="st">'ret'</span>] <span class="op">-</span> event_data[<span class="st">'expected_ret'</span>]</span>
<span id="cb23-2267"><a href="#cb23-2267" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'car'</span>] <span class="op">=</span> event_data[<span class="st">'abnormal_ret'</span>].cumsum()</span>
<span id="cb23-2268"><a href="#cb23-2268" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_day'</span>] <span class="op">=</span> <span class="bu">range</span>(pre, pre <span class="op">+</span> <span class="bu">len</span>(event_data))</span>
<span id="cb23-2269"><a href="#cb23-2269" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'ticker'</span>] <span class="op">=</span> ticker</span>
<span id="cb23-2270"><a href="#cb23-2270" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_date'</span>] <span class="op">=</span> event_date</span>
<span id="cb23-2271"><a href="#cb23-2271" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'event_type'</span>] <span class="op">=</span> event[<span class="st">'event_type'</span>]</span>
<span id="cb23-2272"><a href="#cb23-2272" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'ownership_change'</span>] <span class="op">=</span> event[<span class="st">'ownership_change'</span>]</span>
<span id="cb23-2273"><a href="#cb23-2273" aria-hidden="true" tabindex="-1"></a>        event_data[<span class="st">'shareholder_name'</span>] <span class="op">=</span> event[<span class="st">'shareholder_name'</span>]</span>
<span id="cb23-2274"><a href="#cb23-2274" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2275"><a href="#cb23-2275" aria-hidden="true" tabindex="-1"></a>        results.append(event_data)</span>
<span id="cb23-2276"><a href="#cb23-2276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2277"><a href="#cb23-2277" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb23-2278"><a href="#cb23-2278" aria-hidden="true" tabindex="-1"></a>        all_results <span class="op">=</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-2279"><a href="#cb23-2279" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2280"><a href="#cb23-2280" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Average CARs by event type</span></span>
<span id="cb23-2281"><a href="#cb23-2281" aria-hidden="true" tabindex="-1"></a>        avg_car <span class="op">=</span> (all_results.groupby([<span class="st">'event_type'</span>, <span class="st">'event_day'</span>])[<span class="st">'car'</span>]</span>
<span id="cb23-2282"><a href="#cb23-2282" aria-hidden="true" tabindex="-1"></a>                              .agg([<span class="st">'mean'</span>, <span class="st">'std'</span>, <span class="st">'count'</span>])</span>
<span id="cb23-2283"><a href="#cb23-2283" aria-hidden="true" tabindex="-1"></a>                              .reset_index())</span>
<span id="cb23-2284"><a href="#cb23-2284" aria-hidden="true" tabindex="-1"></a>        avg_car[<span class="st">'t_stat'</span>] <span class="op">=</span> avg_car[<span class="st">'mean'</span>] <span class="op">/</span> (avg_car[<span class="st">'std'</span>] <span class="op">/</span> np.sqrt(avg_car[<span class="st">'count'</span>]))</span>
<span id="cb23-2285"><a href="#cb23-2285" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2286"><a href="#cb23-2286" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Event Study Results:"</span>)</span>
<span id="cb23-2287"><a href="#cb23-2287" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  Total events: </span><span class="sc">{</span>significant_events[<span class="st">'event_type'</span>]<span class="sc">.</span>value_counts()<span class="sc">.</span>to_string()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-2288"><a href="#cb23-2288" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2289"><a href="#cb23-2289" aria-hidden="true" tabindex="-1"></a>        <span class="co"># CAR at event day 0, +5, +10, +20</span></span>
<span id="cb23-2290"><a href="#cb23-2290" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> et <span class="kw">in</span> [<span class="st">'accumulation'</span>, <span class="st">'divestiture'</span>]:</span>
<span id="cb23-2291"><a href="#cb23-2291" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  </span><span class="sc">{</span>et<span class="sc">.</span>title()<span class="sc">}</span><span class="ss"> Events:"</span>)</span>
<span id="cb23-2292"><a href="#cb23-2292" aria-hidden="true" tabindex="-1"></a>            subset <span class="op">=</span> avg_car[avg_car[<span class="st">'event_type'</span>] <span class="op">==</span> et]</span>
<span id="cb23-2293"><a href="#cb23-2293" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> day <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>]:</span>
<span id="cb23-2294"><a href="#cb23-2294" aria-hidden="true" tabindex="-1"></a>                row <span class="op">=</span> subset[subset[<span class="st">'event_day'</span>] <span class="op">==</span> day]</span>
<span id="cb23-2295"><a href="#cb23-2295" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="bu">len</span>(row) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-2296"><a href="#cb23-2296" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">print</span>(<span class="ss">f"    CAR(</span><span class="sc">{</span>day<span class="sc">:+d}</span><span class="ss">): </span><span class="sc">{</span>row<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'mean'</span>]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb23-2297"><a href="#cb23-2297" aria-hidden="true" tabindex="-1"></a>                          <span class="ss">f"(t=</span><span class="sc">{</span>row<span class="sc">.</span>iloc[<span class="dv">0</span>][<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb23-2298"><a href="#cb23-2298" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2299"><a href="#cb23-2299" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> all_results</span>
<span id="cb23-2300"><a href="#cb23-2300" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2301"><a href="#cb23-2301" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb23-2302"><a href="#cb23-2302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2303"><a href="#cb23-2303" aria-hidden="true" tabindex="-1"></a><span class="co"># event_results = ownership_event_study(dc.major_shareholders, dc.prices)</span></span>
<span id="cb23-2304"><a href="#cb23-2304" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2305"><a href="#cb23-2305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2306"><a href="#cb23-2306" aria-hidden="true" tabindex="-1"></a><span class="op">------------------------------------------------------------------------</span></span>
<span id="cb23-2307"><a href="#cb23-2307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2308"><a href="#cb23-2308" aria-hidden="true" tabindex="-1"></a><span class="co">## Empirical Applications {#sec-empirical-applications}</span></span>
<span id="cb23-2309"><a href="#cb23-2309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2310"><a href="#cb23-2310" aria-hidden="true" tabindex="-1"></a><span class="co">### Application 1: Foreign Ownership and Stock Returns in Vietnam</span></span>
<span id="cb23-2311"><a href="#cb23-2311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2312"><a href="#cb23-2312" aria-hidden="true" tabindex="-1"></a>Does foreign institutional ownership predict returns <span class="kw">in</span> Vietnam? <span class="op">@</span>huang2023factors find evidence consistent <span class="cf">with</span> the information advantage hypothesis.</span>
<span id="cb23-2313"><a href="#cb23-2313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2316"><a href="#cb23-2316" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-2317"><a href="#cb23-2317" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: foreign-io-returns</span></span>
<span id="cb23-2318"><a href="#cb23-2318" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Test Foreign Ownership-Return Predictability"</span></span>
<span id="cb23-2319"><a href="#cb23-2319" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-2320"><a href="#cb23-2320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2321"><a href="#cb23-2321" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test_foreign_io_returns(metrics: pd.DataFrame) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2322"><a href="#cb23-2322" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-2323"><a href="#cb23-2323" aria-hidden="true" tabindex="-1"></a><span class="st">    Test whether changes in foreign institutional ownership predict </span></span>
<span id="cb23-2324"><a href="#cb23-2324" aria-hidden="true" tabindex="-1"></a><span class="st">    future stock returns in Vietnam.</span></span>
<span id="cb23-2325"><a href="#cb23-2325" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2326"><a href="#cb23-2326" aria-hidden="true" tabindex="-1"></a><span class="st">    Methodology:</span></span>
<span id="cb23-2327"><a href="#cb23-2327" aria-hidden="true" tabindex="-1"></a><span class="st">    1. Sort stocks into quintiles by change in foreign IO</span></span>
<span id="cb23-2328"><a href="#cb23-2328" aria-hidden="true" tabindex="-1"></a><span class="st">    2. Compute equal-weighted and VN-Index-adjusted returns</span></span>
<span id="cb23-2329"><a href="#cb23-2329" aria-hidden="true" tabindex="-1"></a><span class="st">    3. Report portfolio returns and long-short spread</span></span>
<span id="cb23-2330"><a href="#cb23-2330" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2331"><a href="#cb23-2331" aria-hidden="true" tabindex="-1"></a><span class="st">    This adapts the Chen, Hong, and Stein (2002) breadth test </span></span>
<span id="cb23-2332"><a href="#cb23-2332" aria-hidden="true" tabindex="-1"></a><span class="st">    specifically for Vietnam's foreign ownership component.</span></span>
<span id="cb23-2333"><a href="#cb23-2333" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-2334"><a href="#cb23-2334" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb23-2335"><a href="#cb23-2335" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>])</span>
<span id="cb23-2336"><a href="#cb23-2336" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2337"><a href="#cb23-2337" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Change in foreign IO</span></span>
<span id="cb23-2338"><a href="#cb23-2338" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'delta_foreign'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'pct_foreign_total'</span>].diff()</span>
<span id="cb23-2339"><a href="#cb23-2339" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2340"><a href="#cb23-2340" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Forward quarterly return</span></span>
<span id="cb23-2341"><a href="#cb23-2341" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'fwd_ret'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[<span class="st">'ret'</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb23-2342"><a href="#cb23-2342" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2343"><a href="#cb23-2343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop missing</span></span>
<span id="cb23-2344"><a href="#cb23-2344" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'delta_foreign'</span>, <span class="st">'fwd_ret'</span>])</span>
<span id="cb23-2345"><a href="#cb23-2345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2346"><a href="#cb23-2346" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quintile portfolios each quarter</span></span>
<span id="cb23-2347"><a href="#cb23-2347" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'foreign_quintile'</span>] <span class="op">=</span> df.groupby(<span class="st">'quarter_end'</span>)[<span class="st">'delta_foreign'</span>].transform(</span>
<span id="cb23-2348"><a href="#cb23-2348" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>], duplicates<span class="op">=</span><span class="st">'drop'</span>)</span>
<span id="cb23-2349"><a href="#cb23-2349" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2350"><a href="#cb23-2350" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2351"><a href="#cb23-2351" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Portfolio returns</span></span>
<span id="cb23-2352"><a href="#cb23-2352" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> (df.groupby([<span class="st">'quarter_end'</span>, <span class="st">'foreign_quintile'</span>])[<span class="st">'fwd_ret'</span>]</span>
<span id="cb23-2353"><a href="#cb23-2353" aria-hidden="true" tabindex="-1"></a>                  .mean()</span>
<span id="cb23-2354"><a href="#cb23-2354" aria-hidden="true" tabindex="-1"></a>                  .reset_index())</span>
<span id="cb23-2355"><a href="#cb23-2355" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2356"><a href="#cb23-2356" aria-hidden="true" tabindex="-1"></a>    port_wide <span class="op">=</span> port_ret.pivot(index<span class="op">=</span><span class="st">'quarter_end'</span>, columns<span class="op">=</span><span class="st">'foreign_quintile'</span>, </span>
<span id="cb23-2357"><a href="#cb23-2357" aria-hidden="true" tabindex="-1"></a>                                values<span class="op">=</span><span class="st">'fwd_ret'</span>)</span>
<span id="cb23-2358"><a href="#cb23-2358" aria-hidden="true" tabindex="-1"></a>    port_wide[<span class="st">'LS'</span>] <span class="op">=</span> port_wide[<span class="dv">5</span>] <span class="op">-</span> port_wide[<span class="dv">1</span>]</span>
<span id="cb23-2359"><a href="#cb23-2359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2360"><a href="#cb23-2360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test significance</span></span>
<span id="cb23-2361"><a href="#cb23-2361" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb23-2362"><a href="#cb23-2362" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> q <span class="kw">in</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>, <span class="st">'LS'</span>]:</span>
<span id="cb23-2363"><a href="#cb23-2363" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> port_wide[q].dropna()</span>
<span id="cb23-2364"><a href="#cb23-2364" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> data.mean()</span>
<span id="cb23-2365"><a href="#cb23-2365" aria-hidden="true" tabindex="-1"></a>        t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (data.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(data)))</span>
<span id="cb23-2366"><a href="#cb23-2366" aria-hidden="true" tabindex="-1"></a>        results[q] <span class="op">=</span> {</span>
<span id="cb23-2367"><a href="#cb23-2367" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Mean Return (%)'</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb23-2368"><a href="#cb23-2368" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-statistic'</span>: t_stat,</span>
<span id="cb23-2369"><a href="#cb23-2369" aria-hidden="true" tabindex="-1"></a>            <span class="st">'N quarters'</span>: <span class="bu">len</span>(data),</span>
<span id="cb23-2370"><a href="#cb23-2370" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-2371"><a href="#cb23-2371" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2372"><a href="#cb23-2372" aria-hidden="true" tabindex="-1"></a>    results_df <span class="op">=</span> pd.DataFrame(results).T</span>
<span id="cb23-2373"><a href="#cb23-2373" aria-hidden="true" tabindex="-1"></a>    results_df.index.name <span class="op">=</span> <span class="st">'ΔForeign IO Quintile'</span></span>
<span id="cb23-2374"><a href="#cb23-2374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2375"><a href="#cb23-2375" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Foreign Ownership Change and Future Returns (Vietnam)"</span>)</span>
<span id="cb23-2376"><a href="#cb23-2376" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb23-2377"><a href="#cb23-2377" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(results_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb23-2378"><a href="#cb23-2378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2379"><a href="#cb23-2379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results_df</span>
<span id="cb23-2380"><a href="#cb23-2380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2381"><a href="#cb23-2381" aria-hidden="true" tabindex="-1"></a><span class="co"># foreign_return_results = test_foreign_io_returns(io_metrics)</span></span>
<span id="cb23-2382"><a href="#cb23-2382" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2383"><a href="#cb23-2383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2384"><a href="#cb23-2384" aria-hidden="true" tabindex="-1"></a><span class="co">### Application 2: State Divestiture and Value Creation</span></span>
<span id="cb23-2385"><a href="#cb23-2385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2388"><a href="#cb23-2388" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-2389"><a href="#cb23-2389" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: equitization-value</span></span>
<span id="cb23-2390"><a href="#cb23-2390" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Analyze Value Impact of State Ownership Reduction"</span></span>
<span id="cb23-2391"><a href="#cb23-2391" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-2392"><a href="#cb23-2392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2393"><a href="#cb23-2393" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> analyze_equitization_value(metrics: pd.DataFrame, </span>
<span id="cb23-2394"><a href="#cb23-2394" aria-hidden="true" tabindex="-1"></a>                                state_analysis: Dict) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2395"><a href="#cb23-2395" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-2396"><a href="#cb23-2396" aria-hidden="true" tabindex="-1"></a><span class="st">    Test whether reductions in state ownership are associated with </span></span>
<span id="cb23-2397"><a href="#cb23-2397" aria-hidden="true" tabindex="-1"></a><span class="st">    subsequent value creation (higher returns, improved governance).</span></span>
<span id="cb23-2398"><a href="#cb23-2398" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2399"><a href="#cb23-2399" aria-hidden="true" tabindex="-1"></a><span class="st">    Hypothesis: State divestiture reduces agency costs, improves </span></span>
<span id="cb23-2400"><a href="#cb23-2400" aria-hidden="true" tabindex="-1"></a><span class="st">    operational efficiency, and attracts institutional investors,</span></span>
<span id="cb23-2401"><a href="#cb23-2401" aria-hidden="true" tabindex="-1"></a><span class="st">    leading to positive abnormal returns.</span></span>
<span id="cb23-2402"><a href="#cb23-2402" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2403"><a href="#cb23-2403" aria-hidden="true" tabindex="-1"></a><span class="st">    Uses a difference-in-differences approach:</span></span>
<span id="cb23-2404"><a href="#cb23-2404" aria-hidden="true" tabindex="-1"></a><span class="st">    Treatment: Firms experiencing &gt;10pp drop in state ownership</span></span>
<span id="cb23-2405"><a href="#cb23-2405" aria-hidden="true" tabindex="-1"></a><span class="st">    Control: Matched firms with stable state ownership</span></span>
<span id="cb23-2406"><a href="#cb23-2406" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-2407"><a href="#cb23-2407" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> metrics.copy()</span>
<span id="cb23-2408"><a href="#cb23-2408" aria-hidden="true" tabindex="-1"></a>    events <span class="op">=</span> state_analysis[<span class="st">'equitization_events'</span>]</span>
<span id="cb23-2409"><a href="#cb23-2409" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2410"><a href="#cb23-2410" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(events) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-2411"><a href="#cb23-2411" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No equitization events detected."</span>)</span>
<span id="cb23-2412"><a href="#cb23-2412" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb23-2413"><a href="#cb23-2413" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2414"><a href="#cb23-2414" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get treated firms and their event quarters</span></span>
<span id="cb23-2415"><a href="#cb23-2415" aria-hidden="true" tabindex="-1"></a>    treated <span class="op">=</span> events[[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>]].drop_duplicates()</span>
<span id="cb23-2416"><a href="#cb23-2416" aria-hidden="true" tabindex="-1"></a>    treated[<span class="st">'treated'</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb23-2417"><a href="#cb23-2417" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2418"><a href="#cb23-2418" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge with metrics</span></span>
<span id="cb23-2419"><a href="#cb23-2419" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(treated, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'quarter_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-2420"><a href="#cb23-2420" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'treated'</span>] <span class="op">=</span> df[<span class="st">'treated'</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb23-2421"><a href="#cb23-2421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2422"><a href="#cb23-2422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pre/post comparison for treated firms</span></span>
<span id="cb23-2423"><a href="#cb23-2423" aria-hidden="true" tabindex="-1"></a>    treated_tickers <span class="op">=</span> treated[<span class="st">'ticker'</span>].unique()</span>
<span id="cb23-2424"><a href="#cb23-2424" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2425"><a href="#cb23-2425" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-2426"><a href="#cb23-2426" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker <span class="kw">in</span> treated_tickers:</span>
<span id="cb23-2427"><a href="#cb23-2427" aria-hidden="true" tabindex="-1"></a>        firm <span class="op">=</span> df[df[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].sort_values(<span class="st">'quarter_end'</span>)</span>
<span id="cb23-2428"><a href="#cb23-2428" aria-hidden="true" tabindex="-1"></a>        event_row <span class="op">=</span> firm[firm[<span class="st">'treated'</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb23-2429"><a href="#cb23-2429" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(event_row) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-2430"><a href="#cb23-2430" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2431"><a href="#cb23-2431" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2432"><a href="#cb23-2432" aria-hidden="true" tabindex="-1"></a>        event_q <span class="op">=</span> event_row.iloc[<span class="dv">0</span>][<span class="st">'quarter_end'</span>]</span>
<span id="cb23-2433"><a href="#cb23-2433" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2434"><a href="#cb23-2434" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pre-event (4 quarters before)</span></span>
<span id="cb23-2435"><a href="#cb23-2435" aria-hidden="true" tabindex="-1"></a>        pre <span class="op">=</span> firm[firm[<span class="st">'quarter_end'</span>] <span class="op">&lt;</span> event_q].tail(<span class="dv">4</span>)</span>
<span id="cb23-2436"><a href="#cb23-2436" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Post-event (4 quarters after)</span></span>
<span id="cb23-2437"><a href="#cb23-2437" aria-hidden="true" tabindex="-1"></a>        post <span class="op">=</span> firm[firm[<span class="st">'quarter_end'</span>] <span class="op">&gt;</span> event_q].head(<span class="dv">4</span>)</span>
<span id="cb23-2438"><a href="#cb23-2438" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2439"><a href="#cb23-2439" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(pre) <span class="op">&lt;</span> <span class="dv">2</span> <span class="kw">or</span> <span class="bu">len</span>(post) <span class="op">&lt;</span> <span class="dv">2</span>:</span>
<span id="cb23-2440"><a href="#cb23-2440" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-2441"><a href="#cb23-2441" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2442"><a href="#cb23-2442" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb23-2443"><a href="#cb23-2443" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb23-2444"><a href="#cb23-2444" aria-hidden="true" tabindex="-1"></a>            <span class="st">'event_quarter'</span>: event_q,</span>
<span id="cb23-2445"><a href="#cb23-2445" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state_pct_pre'</span>: pre[<span class="st">'pct_state'</span>].mean(),</span>
<span id="cb23-2446"><a href="#cb23-2446" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state_pct_post'</span>: post[<span class="st">'pct_state'</span>].mean(),</span>
<span id="cb23-2447"><a href="#cb23-2447" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_pct_pre'</span>: pre[<span class="st">'pct_foreign_total'</span>].mean(),</span>
<span id="cb23-2448"><a href="#cb23-2448" aria-hidden="true" tabindex="-1"></a>            <span class="st">'foreign_pct_post'</span>: post[<span class="st">'pct_foreign_total'</span>].mean(),</span>
<span id="cb23-2449"><a href="#cb23-2449" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_inst_pre'</span>: pre[<span class="st">'n_inst_owners'</span>].mean(),</span>
<span id="cb23-2450"><a href="#cb23-2450" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_inst_post'</span>: post[<span class="st">'n_inst_owners'</span>].mean(),</span>
<span id="cb23-2451"><a href="#cb23-2451" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ret_pre'</span>: pre[<span class="st">'ret'</span>].mean(),</span>
<span id="cb23-2452"><a href="#cb23-2452" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ret_post'</span>: post[<span class="st">'ret'</span>].mean(),</span>
<span id="cb23-2453"><a href="#cb23-2453" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-2454"><a href="#cb23-2454" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2455"><a href="#cb23-2455" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb23-2456"><a href="#cb23-2456" aria-hidden="true" tabindex="-1"></a>        results_df <span class="op">=</span> pd.DataFrame(results)</span>
<span id="cb23-2457"><a href="#cb23-2457" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2458"><a href="#cb23-2458" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Paired t-tests</span></span>
<span id="cb23-2459"><a href="#cb23-2459" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Equitization Value Analysis"</span>)</span>
<span id="cb23-2460"><a href="#cb23-2460" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb23-2461"><a href="#cb23-2461" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> metric <span class="kw">in</span> [<span class="st">'state_pct'</span>, <span class="st">'foreign_pct'</span>, <span class="st">'n_inst'</span>, <span class="st">'ret'</span>]:</span>
<span id="cb23-2462"><a href="#cb23-2462" aria-hidden="true" tabindex="-1"></a>            pre_col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_pre'</span></span>
<span id="cb23-2463"><a href="#cb23-2463" aria-hidden="true" tabindex="-1"></a>            post_col <span class="op">=</span> <span class="ss">f'</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">_post'</span></span>
<span id="cb23-2464"><a href="#cb23-2464" aria-hidden="true" tabindex="-1"></a>            diff <span class="op">=</span> results_df[post_col] <span class="op">-</span> results_df[pre_col]</span>
<span id="cb23-2465"><a href="#cb23-2465" aria-hidden="true" tabindex="-1"></a>            t_stat, p_val <span class="op">=</span> stats.ttest_1samp(diff.dropna(), <span class="dv">0</span>)</span>
<span id="cb23-2466"><a href="#cb23-2466" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  Δ</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>diff<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss"> (t=</span><span class="sc">{</span>t_stat<span class="sc">:.2f}</span><span class="ss">, p=</span><span class="sc">{</span>p_val<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb23-2467"><a href="#cb23-2467" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-2468"><a href="#cb23-2468" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results_df</span>
<span id="cb23-2469"><a href="#cb23-2469" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2470"><a href="#cb23-2470" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb23-2471"><a href="#cb23-2471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2472"><a href="#cb23-2472" aria-hidden="true" tabindex="-1"></a><span class="co"># equitization_results = analyze_equitization_value(io_metrics, state_analysis)</span></span>
<span id="cb23-2473"><a href="#cb23-2473" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2474"><a href="#cb23-2474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2475"><a href="#cb23-2475" aria-hidden="true" tabindex="-1"></a><span class="co">### Application 3: Institutional Herding in Vietnam</span></span>
<span id="cb23-2476"><a href="#cb23-2476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2479"><a href="#cb23-2479" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-2480"><a href="#cb23-2480" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: herding-vn</span></span>
<span id="cb23-2481"><a href="#cb23-2481" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute LSV Herding Measure for Vietnamese Market"</span></span>
<span id="cb23-2482"><a href="#cb23-2482" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-2483"><a href="#cb23-2483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2484"><a href="#cb23-2484" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_herding_vietnam(trades: pd.DataFrame,</span>
<span id="cb23-2485"><a href="#cb23-2485" aria-hidden="true" tabindex="-1"></a>                             owner_types: Optional[List[<span class="bu">str</span>]] <span class="op">=</span> <span class="va">None</span>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb23-2486"><a href="#cb23-2486" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""</span></span>
<span id="cb23-2487"><a href="#cb23-2487" aria-hidden="true" tabindex="-1"></a><span class="st">    Compute the Lakonishok, Shleifer, and Vishny (1992) herding measure</span></span>
<span id="cb23-2488"><a href="#cb23-2488" aria-hidden="true" tabindex="-1"></a><span class="st">    adapted for the Vietnamese market.</span></span>
<span id="cb23-2489"><a href="#cb23-2489" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2490"><a href="#cb23-2490" aria-hidden="true" tabindex="-1"></a><span class="st">    Can be computed separately for:</span></span>
<span id="cb23-2491"><a href="#cb23-2491" aria-hidden="true" tabindex="-1"></a><span class="st">    - All institutional investors</span></span>
<span id="cb23-2492"><a href="#cb23-2492" aria-hidden="true" tabindex="-1"></a><span class="st">    - Foreign institutions only</span></span>
<span id="cb23-2493"><a href="#cb23-2493" aria-hidden="true" tabindex="-1"></a><span class="st">    - Domestic institutions only</span></span>
<span id="cb23-2494"><a href="#cb23-2494" aria-hidden="true" tabindex="-1"></a><span class="st">    </span></span>
<span id="cb23-2495"><a href="#cb23-2495" aria-hidden="true" tabindex="-1"></a><span class="st">    The herding measure captures whether institutions systematically</span></span>
<span id="cb23-2496"><a href="#cb23-2496" aria-hidden="true" tabindex="-1"></a><span class="st">    trade in the same direction beyond what chance would predict.</span></span>
<span id="cb23-2497"><a href="#cb23-2497" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span></span>
<span id="cb23-2498"><a href="#cb23-2498" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> scipy.stats <span class="im">import</span> binom</span>
<span id="cb23-2499"><a href="#cb23-2499" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2500"><a href="#cb23-2500" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> trades.copy()</span>
<span id="cb23-2501"><a href="#cb23-2501" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2502"><a href="#cb23-2502" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> owner_types:</span>
<span id="cb23-2503"><a href="#cb23-2503" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> t[t[<span class="st">'owner_type'</span>].isin(owner_types)]</span>
<span id="cb23-2504"><a href="#cb23-2504" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2505"><a href="#cb23-2505" aria-hidden="true" tabindex="-1"></a>    t[<span class="st">'is_buy'</span>] <span class="op">=</span> (t[<span class="st">'trade'</span>] <span class="op">&gt;</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb23-2506"><a href="#cb23-2506" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2507"><a href="#cb23-2507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each stock-period</span></span>
<span id="cb23-2508"><a href="#cb23-2508" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> t.groupby([<span class="st">'ticker'</span>, <span class="st">'date'</span>]).agg(</span>
<span id="cb23-2509"><a href="#cb23-2509" aria-hidden="true" tabindex="-1"></a>        n_traders<span class="op">=</span>(<span class="st">'shareholder_name'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-2510"><a href="#cb23-2510" aria-hidden="true" tabindex="-1"></a>        n_buyers<span class="op">=</span>(<span class="st">'is_buy'</span>, <span class="st">'sum'</span>),</span>
<span id="cb23-2511"><a href="#cb23-2511" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-2512"><a href="#cb23-2512" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2513"><a href="#cb23-2513" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Minimum traders threshold</span></span>
<span id="cb23-2514"><a href="#cb23-2514" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> stock_trades[stock_trades[<span class="st">'n_traders'</span>] <span class="op">&gt;=</span> <span class="dv">3</span>]</span>
<span id="cb23-2515"><a href="#cb23-2515" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'p_buy'</span>] <span class="op">=</span> stock_trades[<span class="st">'n_buyers'</span>] <span class="op">/</span> stock_trades[<span class="st">'n_traders'</span>]</span>
<span id="cb23-2516"><a href="#cb23-2516" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2517"><a href="#cb23-2517" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected proportion per period</span></span>
<span id="cb23-2518"><a href="#cb23-2518" aria-hidden="true" tabindex="-1"></a>    E_p <span class="op">=</span> stock_trades.groupby(<span class="st">'date'</span>).<span class="bu">apply</span>(</span>
<span id="cb23-2519"><a href="#cb23-2519" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> g: g[<span class="st">'n_buyers'</span>].<span class="bu">sum</span>() <span class="op">/</span> g[<span class="st">'n_traders'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-2520"><a href="#cb23-2520" aria-hidden="true" tabindex="-1"></a>    ).reset_index(name<span class="op">=</span><span class="st">'E_p'</span>)</span>
<span id="cb23-2521"><a href="#cb23-2521" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2522"><a href="#cb23-2522" aria-hidden="true" tabindex="-1"></a>    stock_trades <span class="op">=</span> stock_trades.merge(E_p, on<span class="op">=</span><span class="st">'date'</span>)</span>
<span id="cb23-2523"><a href="#cb23-2523" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2524"><a href="#cb23-2524" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjustment factor</span></span>
<span id="cb23-2525"><a href="#cb23-2525" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> expected_abs_dev(n, p):</span>
<span id="cb23-2526"><a href="#cb23-2526" aria-hidden="true" tabindex="-1"></a>        k <span class="op">=</span> np.arange(<span class="dv">0</span>, n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb23-2527"><a href="#cb23-2527" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> binom.pmf(k, n, p)</span>
<span id="cb23-2528"><a href="#cb23-2528" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>(probs <span class="op">*</span> np.<span class="bu">abs</span>(k <span class="op">/</span> n <span class="op">-</span> p))</span>
<span id="cb23-2529"><a href="#cb23-2529" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2530"><a href="#cb23-2530" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'adj_factor'</span>] <span class="op">=</span> stock_trades.<span class="bu">apply</span>(</span>
<span id="cb23-2531"><a href="#cb23-2531" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: expected_abs_dev(<span class="bu">int</span>(r[<span class="st">'n_traders'</span>]), r[<span class="st">'E_p'</span>]), axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb23-2532"><a href="#cb23-2532" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2533"><a href="#cb23-2533" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2534"><a href="#cb23-2534" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'hm'</span>] <span class="op">=</span> (np.<span class="bu">abs</span>(stock_trades[<span class="st">'p_buy'</span>] <span class="op">-</span> stock_trades[<span class="st">'E_p'</span>]) <span class="op">-</span> </span>
<span id="cb23-2535"><a href="#cb23-2535" aria-hidden="true" tabindex="-1"></a>                           stock_trades[<span class="st">'adj_factor'</span>])</span>
<span id="cb23-2536"><a href="#cb23-2536" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2537"><a href="#cb23-2537" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'buy_herd'</span>] <span class="op">=</span> np.where(</span>
<span id="cb23-2538"><a href="#cb23-2538" aria-hidden="true" tabindex="-1"></a>        stock_trades[<span class="st">'p_buy'</span>] <span class="op">&gt;</span> stock_trades[<span class="st">'E_p'</span>], stock_trades[<span class="st">'hm'</span>], np.nan</span>
<span id="cb23-2539"><a href="#cb23-2539" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2540"><a href="#cb23-2540" aria-hidden="true" tabindex="-1"></a>    stock_trades[<span class="st">'sell_herd'</span>] <span class="op">=</span> np.where(</span>
<span id="cb23-2541"><a href="#cb23-2541" aria-hidden="true" tabindex="-1"></a>        stock_trades[<span class="st">'p_buy'</span>] <span class="op">&lt;</span> stock_trades[<span class="st">'E_p'</span>], stock_trades[<span class="st">'hm'</span>], np.nan</span>
<span id="cb23-2542"><a href="#cb23-2542" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-2543"><a href="#cb23-2543" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2544"><a href="#cb23-2544" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Time series of herding</span></span>
<span id="cb23-2545"><a href="#cb23-2545" aria-hidden="true" tabindex="-1"></a>    ts_herding <span class="op">=</span> stock_trades.groupby(<span class="st">'date'</span>).agg(</span>
<span id="cb23-2546"><a href="#cb23-2546" aria-hidden="true" tabindex="-1"></a>        mean_hm<span class="op">=</span>(<span class="st">'hm'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2547"><a href="#cb23-2547" aria-hidden="true" tabindex="-1"></a>        mean_buy_herd<span class="op">=</span>(<span class="st">'buy_herd'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2548"><a href="#cb23-2548" aria-hidden="true" tabindex="-1"></a>        mean_sell_herd<span class="op">=</span>(<span class="st">'sell_herd'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-2549"><a href="#cb23-2549" aria-hidden="true" tabindex="-1"></a>        pct_herding<span class="op">=</span>(<span class="st">'hm'</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean()),</span>
<span id="cb23-2550"><a href="#cb23-2550" aria-hidden="true" tabindex="-1"></a>        n_stocks<span class="op">=</span>(<span class="st">'ticker'</span>, <span class="st">'nunique'</span>),</span>
<span id="cb23-2551"><a href="#cb23-2551" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb23-2552"><a href="#cb23-2552" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2553"><a href="#cb23-2553" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Herding Analysis (</span><span class="sc">{</span>owner_types <span class="kw">or</span> <span class="st">'All Institutions'</span><span class="sc">}</span><span class="ss">):"</span>)</span>
<span id="cb23-2554"><a href="#cb23-2554" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean HM: </span><span class="sc">{</span>stock_trades[<span class="st">'hm'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-2555"><a href="#cb23-2555" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Buy Herding: </span><span class="sc">{</span>stock_trades[<span class="st">'buy_herd'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-2556"><a href="#cb23-2556" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  Mean Sell Herding: </span><span class="sc">{</span>stock_trades[<span class="st">'sell_herd'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-2557"><a href="#cb23-2557" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  % stocks with herding: </span><span class="sc">{</span>(stock_trades[<span class="st">'hm'</span>] <span class="op">&gt;</span> <span class="dv">0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-2558"><a href="#cb23-2558" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-2559"><a href="#cb23-2559" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> stock_trades, ts_herding</span>
<span id="cb23-2560"><a href="#cb23-2560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2561"><a href="#cb23-2561" aria-hidden="true" tabindex="-1"></a><span class="co"># herding_all, herding_ts = compute_herding_vietnam(trades)</span></span>
<span id="cb23-2562"><a href="#cb23-2562" aria-hidden="true" tabindex="-1"></a><span class="co"># herding_foreign, _ = compute_herding_vietnam(</span></span>
<span id="cb23-2563"><a href="#cb23-2563" aria-hidden="true" tabindex="-1"></a><span class="co">#     trades, owner_types=[OwnershipType.FOREIGN_INST]</span></span>
<span id="cb23-2564"><a href="#cb23-2564" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb23-2565"><a href="#cb23-2565" aria-hidden="true" tabindex="-1"></a>```</span>
<span id="cb23-2566"><a href="#cb23-2566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2567"><a href="#cb23-2567" aria-hidden="true" tabindex="-1"></a><span class="co">## Conclusion and Practical Recommendations {#sec-conclusion}</span></span>
<span id="cb23-2568"><a href="#cb23-2568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2569"><a href="#cb23-2569" aria-hidden="true" tabindex="-1"></a><span class="co">### Summary of Measures</span></span>
<span id="cb23-2570"><a href="#cb23-2570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2571"><a href="#cb23-2571" aria-hidden="true" tabindex="-1"></a><span class="at">@tbl</span><span class="op">-</span>summary<span class="op">-</span><span class="bu">all</span> summarizes <span class="bu">all</span> institutional ownership measures developed <span class="kw">in</span> this chapter <span class="cf">for</span> the Vietnamese market.</span>
<span id="cb23-2572"><a href="#cb23-2572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2573"><a href="#cb23-2573" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Measure <span class="op">|</span> Definition <span class="op">|</span> Key Adaptation <span class="cf">for</span> Vietnam <span class="op">|</span> Python Function <span class="op">|</span></span>
<span id="cb23-2574"><a href="#cb23-2574" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>:<span class="op">-----------------|</span>:<span class="op">-----------------|</span>:<span class="op">------------------|</span>:<span class="op">-----------------|</span></span>
<span id="cb23-2575"><a href="#cb23-2575" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> IO Ratio <span class="op">|</span> Inst. shares <span class="op">/</span> TSO <span class="op">|</span> Decomposed into state, foreign, domestic <span class="op">|</span> `compute_ownership_decomposition()` <span class="op">|</span></span>
<span id="cb23-2576"><a href="#cb23-2576" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> HHI Concentration <span class="op">|</span> $\<span class="bu">sum</span> w_j<span class="op">^</span><span class="dv">2</span>$ <span class="op">|</span> Separate HHI <span class="cf">for</span> total, non<span class="op">-</span>state, foreign <span class="op">|</span> `compute_io_metrics_vietnam()` <span class="op">|</span></span>
<span id="cb23-2577"><a href="#cb23-2577" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> ΔBreadth <span class="op">|</span> Lehavy<span class="op">-</span>Sloan adjusted <span class="op">|</span> Applied to irregular disclosure intervals <span class="op">|</span> `compute_io_metrics_vietnam()` <span class="op">|</span></span>
<span id="cb23-2578"><a href="#cb23-2578" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> FOL Utilization <span class="op">|</span> Foreign <span class="op">%</span> <span class="op">/</span> FOL limit <span class="op">|</span> Vietnam<span class="op">-</span>specific<span class="op">;</span> no US equivalent <span class="op">|</span> `FOLAnalyzer` <span class="op">|</span></span>
<span id="cb23-2579"><a href="#cb23-2579" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> FOL Premium <span class="op">|</span> Price impact of FOL proximity <span class="op">|</span> Cross<span class="op">-</span>sectional regression approach <span class="op">|</span> `FOLAnalyzer.estimate_fol_premium()` <span class="op">|</span></span>
<span id="cb23-2580"><a href="#cb23-2580" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Trades <span class="op">|</span> ΔShares (corp<span class="op">-</span>action adjusted) <span class="op">|</span> Critical: adjust <span class="cf">for</span> stock dividends <span class="op">|</span> `derive_trades_vectorized_vietnam()` <span class="op">|</span></span>
<span id="cb23-2581"><a href="#cb23-2581" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Fund Turnover <span class="op">|</span> <span class="bu">min</span>(B,S)<span class="op">/</span>avg(A) <span class="op">|</span> Semi<span class="op">-</span>annual frequency<span class="op">;</span> annualized <span class="op">|</span> `compute_fund_analytics()` <span class="op">|</span></span>
<span id="cb23-2582"><a href="#cb23-2582" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> SOE Status <span class="op">|</span> State ownership \<span class="op">&gt;</span> <span class="dv">50</span><span class="op">%</span> <span class="op">|</span> Tracks equitization program <span class="op">|</span> `analyze_state_ownership()` <span class="op">|</span></span>
<span id="cb23-2583"><a href="#cb23-2583" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> LSV Herding <span class="op">|</span> $<span class="op">|</span>p <span class="op">-</span> E[p]<span class="op">|</span> <span class="op">-</span> E[<span class="op">|</span>p <span class="op">-</span> E[p]<span class="op">|</span>]$ <span class="op">|</span> Separate foreign vs domestic herding <span class="op">|</span> `compute_herding_vietnam()` <span class="op">|</span></span>
<span id="cb23-2584"><a href="#cb23-2584" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Co<span class="op">-</span>Ownership Network <span class="op">|</span> Shared institutional holders <span class="op">|</span> Reveals conglomerate linkages <span class="op">|</span> `construct_stock_coownership_network()` <span class="op">|</span></span>
<span id="cb23-2585"><a href="#cb23-2585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2586"><a href="#cb23-2586" aria-hidden="true" tabindex="-1"></a>: Summary of All Ownership Measures <span class="cf">for</span> Vietnam {<span class="co">#tbl-summary-all}</span></span>
<span id="cb23-2587"><a href="#cb23-2587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2588"><a href="#cb23-2588" aria-hidden="true" tabindex="-1"></a><span class="co">### Data Quality Checklist for Vietnam</span></span>
<span id="cb23-2589"><a href="#cb23-2589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2590"><a href="#cb23-2590" aria-hidden="true" tabindex="-1"></a>::: {.callout<span class="op">-</span>tip title<span class="op">=</span><span class="st">"Vietnam Data Quality Checklist"</span>}</span>
<span id="cb23-2591"><a href="#cb23-2591" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span>  [ ] <span class="op">**</span>Corporate actions:<span class="op">**</span> Have you built <span class="kw">and</span> applied adjustment factors <span class="cf">for</span> ALL stock dividends, bonus shares, splits, <span class="kw">and</span> rights issues?</span>
<span id="cb23-2592"><a href="#cb23-2592" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span>  [ ] <span class="op">**</span>Shareholder classification:<span class="op">**</span> Have you verified the owner <span class="bu">type</span> classification (state vs foreign vs domestic institutional vs individual)?</span>
<span id="cb23-2593"><a href="#cb23-2593" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span>  [ ] <span class="op">**</span>FOL limits:<span class="op">**</span> Are sector<span class="op">-</span>specific FOL limits correctly assigned (<span class="dv">30</span><span class="op">%</span> <span class="cf">for</span> banks, <span class="dv">49</span><span class="op">%</span> standard, unlimited <span class="cf">for</span> some sectors)?</span>
<span id="cb23-2594"><a href="#cb23-2594" aria-hidden="true" tabindex="-1"></a><span class="fl">4.</span>  [ ] <span class="op">**</span>Disclosure dates:<span class="op">**</span> Are you using the actual disclosure date (<span class="kw">not</span> the record date <span class="kw">or</span> ex<span class="op">-</span>date) <span class="cf">for</span> ownership snapshots?</span>
<span id="cb23-2595"><a href="#cb23-2595" aria-hidden="true" tabindex="-1"></a><span class="fl">5.</span>  [ ] <span class="op">**</span>Treasury shares:<span class="op">**</span> Are treasury shares excluded <span class="im">from</span> ownership ratio denominators?</span>
<span id="cb23-2596"><a href="#cb23-2596" aria-hidden="true" tabindex="-1"></a><span class="fl">6.</span>  [ ] <span class="op">**</span>UPCOM coverage:<span class="op">**</span> Does your sample include <span class="kw">or</span> exclude UPCOM stocks (which have weaker disclosure requirements)?</span>
<span id="cb23-2597"><a href="#cb23-2597" aria-hidden="true" tabindex="-1"></a><span class="fl">7.</span>  [ ] <span class="op">**</span>Cross<span class="op">-</span>listings:<span class="op">**</span> Are you handling NVDR (Non<span class="op">-</span>Voting Depository Receipts) <span class="cf">if</span> applicable after market reforms?</span>
<span id="cb23-2598"><a href="#cb23-2598" aria-hidden="true" tabindex="-1"></a><span class="fl">8.</span>  [ ] <span class="op">**</span>Name consistency:<span class="op">**</span> Are shareholder names standardized across disclosure periods (Vietnamese names can have multiple romanization forms)?</span>
<span id="cb23-2599"><a href="#cb23-2599" aria-hidden="true" tabindex="-1"></a><span class="fl">9.</span>  [ ] <span class="op">**</span>Trade adjustment:<span class="op">**</span> When deriving trades between periods, have you adjusted previous shares <span class="cf">for</span> ALL intervening corporate actions?</span>
<span id="cb23-2600"><a href="#cb23-2600" aria-hidden="true" tabindex="-1"></a><span class="fl">10.</span> [ ] <span class="op">**</span>Fund mandate changes:<span class="op">**</span> For fund analytics, have you accounted <span class="cf">for</span> fund mergers, closures, <span class="kw">and</span> mandate changes that affect time<span class="op">-</span>series continuity?</span>
<span id="cb23-2601"><a href="#cb23-2601" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-2602"><a href="#cb23-2602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2603"><a href="#cb23-2603" aria-hidden="true" tabindex="-1"></a><span class="co">### Comparison with US Framework</span></span>
<span id="cb23-2604"><a href="#cb23-2604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2605"><a href="#cb23-2605" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> Dimension <span class="op">|</span> US (WRDS<span class="op">/</span><span class="dv">13</span><span class="er">F</span>) <span class="op">|</span> Vietnam (DataCore.vn) <span class="op">|</span></span>
<span id="cb23-2606"><a href="#cb23-2606" aria-hidden="true" tabindex="-1"></a><span class="op">|</span>:<span class="op">------------------|</span>:<span class="op">--------------------|</span>:<span class="op">-------------------------------|</span></span>
<span id="cb23-2607"><a href="#cb23-2607" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Disclosure<span class="op">**</span> <span class="op">|</span> Quarterly <span class="dv">13</span><span class="er">F</span> (mandatory) <span class="op">|</span> Annual reports <span class="op">+</span> event<span class="op">-</span>driven <span class="op">|</span></span>
<span id="cb23-2608"><a href="#cb23-2608" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Coverage<span class="op">**</span> <span class="op">|</span> Institutions \<span class="op">&gt;</span> \$<span class="dv">100</span><span class="er">M</span> AUM <span class="op">|</span> All shareholders <span class="kw">in</span> annual reports <span class="op">|</span></span>
<span id="cb23-2609"><a href="#cb23-2609" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Ownership observed<span class="op">**</span> <span class="op">|</span> Long positions only <span class="op">|</span> Complete decomposition <span class="op">|</span></span>
<span id="cb23-2610"><a href="#cb23-2610" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>IO can exceed <span class="dv">100</span><span class="op">%**</span> <span class="op">|</span> Yes (short selling) <span class="op">|</span> No (by construction) <span class="op">|</span></span>
<span id="cb23-2611"><a href="#cb23-2611" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Permanent ID<span class="op">**</span> <span class="op">|</span> CRSP PERMNO <span class="op">|</span> Ticker (<span class="cf">with</span> manual tracking of changes) <span class="op">|</span></span>
<span id="cb23-2612"><a href="#cb23-2612" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Adjustment factors<span class="op">**</span> <span class="op">|</span> CRSP cfacshr <span class="op">|</span> Must build <span class="im">from</span> corporate actions <span class="op">|</span></span>
<span id="cb23-2613"><a href="#cb23-2613" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Investor classification<span class="op">**</span> <span class="op">|</span> LSEG typecode <span class="op">/</span> Bushee <span class="op">|</span> State<span class="op">/</span>Foreign<span class="op">/</span>Domestic<span class="op">/</span>Individual <span class="op">|</span></span>
<span id="cb23-2614"><a href="#cb23-2614" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Short selling<span class="op">**</span> <span class="op">|</span> Not <span class="kw">in</span> <span class="dv">13</span><span class="er">F</span><span class="op">;</span> exists <span class="kw">in</span> market <span class="op">|</span> Very limited<span class="op">;</span> <span class="kw">not</span> a concern <span class="op">|</span></span>
<span id="cb23-2615"><a href="#cb23-2615" aria-hidden="true" tabindex="-1"></a><span class="op">|</span> <span class="op">**</span>Unique features<span class="op">**</span> <span class="op">|</span> — <span class="op">|</span> FOL, SOE ownership, stock dividend frequency <span class="op">|</span></span>
<span id="cb23-2616"><a href="#cb23-2616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-2617"><a href="#cb23-2617" aria-hidden="true" tabindex="-1"></a>: US vs Vietnam Institutional Ownership Framework Comparison {<span class="co">#tbl-us-vn-comparison}</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/50_institutional_ownership.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>