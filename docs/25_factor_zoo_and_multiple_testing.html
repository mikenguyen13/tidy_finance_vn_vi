<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>21&nbsp; Factor Zoo and Multiple Testing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./26_time_series_vs_cross_section.html" rel="next">
<link href="./24_fama_macbeth.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="21&nbsp; Factor Zoo and Multiple Testing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:title" content="21&nbsp; Factor Zoo and Multiple Testing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</a></li><li class="breadcrumb-item"><a href="./25_factor_zoo_and_multiple_testing.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L·ªùi n√≥i ƒë·∫ßu</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Truy c·∫≠p v√† qu·∫£n l√Ω d·ªØ li·ªáu t√†i ch√≠nh VN</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-factor-zoo-scale" id="toc-sec-factor-zoo-scale" class="nav-link active" data-scroll-target="#sec-factor-zoo-scale"><span class="header-section-number">21.1</span> The Scale of the Problem</a>
  <ul class="collapse">
  <li><a href="#how-many-factors-exist" id="toc-how-many-factors-exist" class="nav-link" data-scroll-target="#how-many-factors-exist"><span class="header-section-number">21.1.1</span> How Many Factors Exist?</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-zoo" id="toc-sec-factor-zoo-zoo" class="nav-link" data-scroll-target="#sec-factor-zoo-zoo"><span class="header-section-number">21.2</span> Building the Anomaly Zoo</a>
  <ul class="collapse">
  <li><a href="#signal-definitions" id="toc-signal-definitions" class="nav-link" data-scroll-target="#signal-definitions"><span class="header-section-number">21.2.1</span> Signal Definitions</a></li>
  <li><a href="#mass-factor-construction" id="toc-mass-factor-construction" class="nav-link" data-scroll-target="#mass-factor-construction"><span class="header-section-number">21.2.2</span> Mass Factor Construction</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-multiple-testing" id="toc-sec-factor-zoo-multiple-testing" class="nav-link" data-scroll-target="#sec-factor-zoo-multiple-testing"><span class="header-section-number">21.3</span> The Multiple Testing Problem</a>
  <ul class="collapse">
  <li><a href="#why-single-test-p-values-are-misleading" id="toc-why-single-test-p-values-are-misleading" class="nav-link" data-scroll-target="#why-single-test-p-values-are-misleading"><span class="header-section-number">21.3.1</span> Why Single-Test p-Values Are Misleading</a></li>
  <li><a href="#two-error-rate-concepts" id="toc-two-error-rate-concepts" class="nav-link" data-scroll-target="#two-error-rate-concepts"><span class="header-section-number">21.3.2</span> Two Error Rate Concepts</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-corrections" id="toc-sec-factor-zoo-corrections" class="nav-link" data-scroll-target="#sec-factor-zoo-corrections"><span class="header-section-number">21.4</span> Correction Methods</a>
  <ul class="collapse">
  <li><a href="#bonferroni-correction-fwer-control" id="toc-bonferroni-correction-fwer-control" class="nav-link" data-scroll-target="#bonferroni-correction-fwer-control"><span class="header-section-number">21.4.1</span> Bonferroni Correction (FWER Control)</a></li>
  <li><a href="#holm-step-down-procedure-fwer-control" id="toc-holm-step-down-procedure-fwer-control" class="nav-link" data-scroll-target="#holm-step-down-procedure-fwer-control"><span class="header-section-number">21.4.2</span> Holm Step-Down Procedure (FWER Control)</a></li>
  <li><a href="#benjamini-hochberg-procedure-fdr-control" id="toc-benjamini-hochberg-procedure-fdr-control" class="nav-link" data-scroll-target="#benjamini-hochberg-procedure-fdr-control"><span class="header-section-number">21.4.3</span> Benjamini-Hochberg Procedure (FDR Control)</a></li>
  <li><a href="#the-harvey-liu-zhu-threshold" id="toc-the-harvey-liu-zhu-threshold" class="nav-link" data-scroll-target="#the-harvey-liu-zhu-threshold"><span class="header-section-number">21.4.4</span> The Harvey-Liu-Zhu Threshold</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-comparison" id="toc-sec-factor-zoo-comparison" class="nav-link" data-scroll-target="#sec-factor-zoo-comparison"><span class="header-section-number">21.5</span> Comparison of Methods</a></li>
  <li><a href="#sec-factor-zoo-fdp" id="toc-sec-factor-zoo-fdp" class="nav-link" data-scroll-target="#sec-factor-zoo-fdp"><span class="header-section-number">21.6</span> Estimating the False Discovery Proportion</a>
  <ul class="collapse">
  <li><a href="#the-storey-approach" id="toc-the-storey-approach" class="nav-link" data-scroll-target="#the-storey-approach"><span class="header-section-number">21.6.1</span> The Storey Approach</a></li>
  <li><a href="#fdp-curve" id="toc-fdp-curve" class="nav-link" data-scroll-target="#fdp-curve"><span class="header-section-number">21.6.2</span> FDP Curve</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-bootstrap" id="toc-sec-factor-zoo-bootstrap" class="nav-link" data-scroll-target="#sec-factor-zoo-bootstrap"><span class="header-section-number">21.7</span> Bootstrap-Based Multiple Testing</a>
  <ul class="collapse">
  <li><a href="#the-white-reality-check" id="toc-the-white-reality-check" class="nav-link" data-scroll-target="#the-white-reality-check"><span class="header-section-number">21.7.1</span> The White Reality Check</a></li>
  <li><a href="#romano-wolf-step-down-bootstrap" id="toc-romano-wolf-step-down-bootstrap" class="nav-link" data-scroll-target="#romano-wolf-step-down-bootstrap"><span class="header-section-number">21.7.2</span> Romano-Wolf Step-Down Bootstrap</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-oos" id="toc-sec-factor-zoo-oos" class="nav-link" data-scroll-target="#sec-factor-zoo-oos"><span class="header-section-number">21.8</span> Out-of-Sample Validation</a>
  <ul class="collapse">
  <li><a href="#pre-publication-vs.-post-publication-decay" id="toc-pre-publication-vs.-post-publication-decay" class="nav-link" data-scroll-target="#pre-publication-vs.-post-publication-decay"><span class="header-section-number">21.8.1</span> Pre-Publication vs.&nbsp;Post-Publication Decay</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-survivors" id="toc-sec-factor-zoo-survivors" class="nav-link" data-scroll-target="#sec-factor-zoo-survivors"><span class="header-section-number">21.9</span> Which Factors Survive?</a>
  <ul class="collapse">
  <li><a href="#a-multi-hurdle-filter" id="toc-a-multi-hurdle-filter" class="nav-link" data-scroll-target="#a-multi-hurdle-filter"><span class="header-section-number">21.9.1</span> A Multi-Hurdle Filter</a></li>
  </ul></li>
  <li><a href="#sec-factor-zoo-implications" id="toc-sec-factor-zoo-implications" class="nav-link" data-scroll-target="#sec-factor-zoo-implications"><span class="header-section-number">21.10</span> Implications for Vietnamese Factor Research</a></li>
  <li><a href="#sec-factor-zoo-summary" id="toc-sec-factor-zoo-summary" class="nav-link" data-scroll-target="#sec-factor-zoo-summary"><span class="header-section-number">21.11</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/25_factor_zoo_and_multiple_testing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</a></li><li class="breadcrumb-item"><a href="./25_factor_zoo_and_multiple_testing.html"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we confront the multiple testing problem in empirical asset pricing. We replicate a broad set of published anomalies in the Vietnamese market, apply formal corrections for the number of tests conducted, estimate the proportion of false discoveries, and develop a framework for deciding which factors deserve credence.</p>
</div>
</div>
<p>By 2016, academic finance had documented over 300 variables that purportedly predict the cross-section of stock returns. <span class="citation" data-cites="cochrane2011presidential">Cochrane (<a href="references.html#ref-cochrane2011presidential" role="doc-biblioref">2011</a>)</span> memorably called this proliferation a ‚Äúzoo of factors.‚Äù <span class="citation" data-cites="harvey2016and">Harvey, Liu, and Zhu (<a href="references.html#ref-harvey2016and" role="doc-biblioref">2016</a>)</span> cataloged over 300 published factors and argued that the standard significance threshold of <span class="math inline">\(t &gt; 2.0\)</span> was far too low given the sheer number of hypotheses tested, either explicitly or implicitly, across decades of research. Their proposed threshold of <span class="math inline">\(t &gt; 3.0\)</span> (and in some cases <span class="math inline">\(t &gt; 3.78\)</span>) would eliminate the majority of published anomalies.</p>
<p>The problem is not merely academic. Every researcher who sorts stocks on a new variable and finds <span class="math inline">\(t &gt; 2\)</span> is implicitly testing a hypothesis that has already been tested hundreds of times with different variables. The probability that <em>at least one</em> of 300 independent tests produces <span class="math inline">\(t &gt; 2\)</span> by chance (even when no true effect exists) is essentially 1.0. This is the multiple testing problem, and failing to account for it means that a substantial fraction of the ‚Äúfactor zoo‚Äù consists of false discoveries.</p>
<p>For Vietnamese equity research, the problem is arguably worse. The cross-section is smaller (600-800 stocks vs.&nbsp;4,000+ in the U.S.), the time series is shorter (2008- vs.&nbsp;1963-), and the data are noisier (illiquidity, zero-trading days, accounting irregularities). All of these amplify the risk of both Type I errors (finding something that isn‚Äôt there) and Type II errors (missing something that is). This chapter provides the statistical tools to navigate this landscape rigorously.</p>
<section id="sec-factor-zoo-scale" class="level2" data-number="21.1">
<h2 data-number="21.1" class="anchored" data-anchor-id="sec-factor-zoo-scale"><span class="header-section-number">21.1</span> The Scale of the Problem</h2>
<section id="how-many-factors-exist" class="level3" data-number="21.1.1">
<h3 data-number="21.1.1" class="anchored" data-anchor-id="how-many-factors-exist"><span class="header-section-number">21.1.1</span> How Many Factors Exist?</h3>
<p><span class="citation" data-cites="harvey2016and">Harvey, Liu, and Zhu (<a href="references.html#ref-harvey2016and" role="doc-biblioref">2016</a>)</span> counted over 300 factors published in top journals through 2012. <span class="citation" data-cites="chen2022open">Chen and Zimmermann (<a href="references.html#ref-chen2022open" role="doc-biblioref">2022</a>)</span> constructed and made publicly available over 300 ‚Äúclearly significant‚Äù anomalies from the U.S. literature. <span class="citation" data-cites="hou2020replicating">Hou, Xue, and Zhang (<a href="references.html#ref-hou2020replicating" role="doc-biblioref">2020</a>)</span> attempted to replicate 452 anomalies and found that 64% (with VW returns) failed to achieve <span class="math inline">\(t &gt; 1.96\)</span> in their sample. <span class="citation" data-cites="jensen2023there">Jensen, Kelly, and Pedersen (<a href="references.html#ref-jensen2023there" role="doc-biblioref">2023</a>)</span> took a more optimistic view, finding that most factors replicate in direction if not always in magnitude.</p>
<p>The key insight is that the number of factors <em>tested</em> far exceeds the number <em>published</em>. For every published factor with <span class="math inline">\(t &gt; 2\)</span>, there may be dozens of unpublished tests with <span class="math inline">\(t &lt; 2\)</span> that never saw print, which is the classic file drawer problem. The true number of tests conducted collectively by the profession is unknowable, but certainly in the thousands.</p>
<div id="setup" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.multitest <span class="im">import</span> multipletests</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="data-load" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (survivorship-bias-free)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>, <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_zero_volume_days'</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-computed characteristic panel (from factor construction chapter)</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>characteristics <span class="op">=</span> client.get_characteristics_panel(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns for spanning tests</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>factors_ff <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>monthly[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(monthly[<span class="st">'month_end'</span>])</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Characteristics: </span><span class="sc">{</span>characteristics<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available signals: </span><span class="sc">{</span>[c <span class="cf">for</span> c <span class="kw">in</span> characteristics.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'month_end'</span>]]<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-zoo-zoo" class="level2" data-number="21.2">
<h2 data-number="21.2" class="anchored" data-anchor-id="sec-factor-zoo-zoo"><span class="header-section-number">21.2</span> Building the Anomaly Zoo</h2>
<section id="signal-definitions" class="level3" data-number="21.2.1">
<h3 data-number="21.2.1" class="anchored" data-anchor-id="signal-definitions"><span class="header-section-number">21.2.1</span> Signal Definitions</h3>
<p>We construct a comprehensive set of anomaly variables spanning the major categories from the literature. Each signal is lagged appropriately to avoid look-ahead bias (accounting signals use point-in-time alignment; price signals use the prior month‚Äôs value).</p>
<div id="signal-construction" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge returns with characteristics</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> monthly.merge(characteristics, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 1: VALUE (8 signals)</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Already in characteristics panel from PIT merge:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># bm, ep, cfp, sp, dp, ev_ebitda</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add earnings yield variants</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>value_signals <span class="op">=</span> [<span class="st">'bm'</span>, <span class="st">'ep'</span>, <span class="st">'cfp'</span>, <span class="st">'sp'</span>, <span class="st">'dp'</span>]</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 2: SIZE (3 signals)</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'market_cap'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(panel[<span class="st">'total_assets'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_revenue'</span>] <span class="op">=</span> np.log(panel[<span class="st">'revenue'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>size_signals <span class="op">=</span> [<span class="st">'log_mcap'</span>, <span class="st">'log_assets'</span>, <span class="st">'log_revenue'</span>]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 3: PROFITABILITY (8 signals)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># GP/A (Novy-Marx 2013), OP (FF 2015), ROE, ROA, etc.</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>prof_signals <span class="op">=</span> [<span class="st">'gp_at'</span>, <span class="st">'op'</span>, <span class="st">'roe'</span>, <span class="st">'roa'</span>, <span class="st">'profit_margin'</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'asset_turnover'</span>, <span class="st">'gross_margin'</span>, <span class="st">'oper_margin'</span>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 4: INVESTMENT / GROWTH (6 signals)</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>inv_signals <span class="op">=</span> [<span class="st">'asset_growth'</span>, <span class="st">'capex_at'</span>, <span class="st">'investment'</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sales_growth'</span>, <span class="st">'equity_issuance'</span>, <span class="st">'debt_issuance'</span>]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 5: MOMENTUM / REVERSAL (6 signals)</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute from returns</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag_start, lag_end, name <span class="kw">in</span> [</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">12</span>, <span class="st">'ret_12_2'</span>), (<span class="dv">2</span>, <span class="dv">6</span>, <span class="st">'ret_6_2'</span>), (<span class="dv">7</span>, <span class="dv">12</span>, <span class="st">'ret_12_7'</span>),</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'ret_1'</span>), (<span class="dv">1</span>, <span class="dv">3</span>, <span class="st">'ret_3_1'</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name <span class="kw">not</span> <span class="kw">in</span> panel.columns:</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>        panel[name] <span class="op">=</span> (</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>            panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.shift(lag_start).rolling(lag_end <span class="op">-</span> lag_start <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                       .<span class="bu">apply</span>(<span class="kw">lambda</span> r: (<span class="dv">1</span> <span class="op">+</span> r).prod() <span class="op">-</span> <span class="dv">1</span>, raw<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Earnings momentum (SUE) should already be in characteristics</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>mom_signals <span class="op">=</span> [<span class="st">'ret_12_2'</span>, <span class="st">'ret_6_2'</span>, <span class="st">'ret_12_7'</span>, <span class="st">'ret_1'</span>, <span class="st">'ret_3_1'</span>, <span class="st">'sue'</span>]</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 6: RISK (5 signals)</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>risk_signals <span class="op">=</span> [<span class="st">'beta'</span>, <span class="st">'ivol'</span>, <span class="st">'tvol'</span>, <span class="st">'max_ret'</span>, <span class="st">'skewness'</span>]</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 7: LIQUIDITY / TRADING (6 signals)</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>liq_signals <span class="op">=</span> [<span class="st">'amihud'</span>, <span class="st">'zero_return_pct'</span>, <span class="st">'log_turnover'</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>                <span class="st">'roll_spread'</span>, <span class="st">'cs_spread'</span>, <span class="st">'volume_cv'</span>]</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 8: QUALITY / FINANCIAL HEALTH (5 signals)</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>qual_signals <span class="op">=</span> [<span class="st">'leverage'</span>, <span class="st">'current_ratio'</span>, <span class="st">'accruals'</span>,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'earnings_variability'</span>, <span class="st">'piotroski_f'</span>]</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 9: DIVIDEND / PAYOUT (3 signals)</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>div_signals <span class="op">=</span> [<span class="st">'div_yield'</span>, <span class="st">'payout_ratio'</span>, <span class="st">'net_repurchase'</span>]</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>all_signals <span class="op">=</span> (value_signals <span class="op">+</span> size_signals <span class="op">+</span> prof_signals <span class="op">+</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>               inv_signals <span class="op">+</span> mom_signals <span class="op">+</span> risk_signals <span class="op">+</span></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>               liq_signals <span class="op">+</span> qual_signals <span class="op">+</span> div_signals)</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove signals with too little coverage</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>signal_coverage <span class="op">=</span> {}</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> all_signals:</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sig <span class="kw">in</span> panel.columns:</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>        cov <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        signal_coverage[sig] <span class="op">=</span> cov</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>signal_coverage <span class="op">=</span> pd.Series(signal_coverage).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>valid_signals <span class="op">=</span> signal_coverage[signal_coverage <span class="op">&gt;</span> <span class="fl">0.30</span>].index.tolist()</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total signals defined: </span><span class="sc">{</span><span class="bu">len</span>(all_signals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Signals with &gt;30% coverage: </span><span class="sc">{</span><span class="bu">len</span>(valid_signals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Signal categories:"</span>)</span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat_name, sigs <span class="kw">in</span> [</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Value'</span>, value_signals), (<span class="st">'Size'</span>, size_signals),</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Profitability'</span>, prof_signals), (<span class="st">'Investment'</span>, inv_signals),</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Momentum'</span>, mom_signals), (<span class="st">'Risk'</span>, risk_signals),</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Liquidity'</span>, liq_signals), (<span class="st">'Quality'</span>, qual_signals),</span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Dividend'</span>, div_signals)</span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    n_valid <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> s <span class="kw">in</span> sigs <span class="cf">if</span> s <span class="kw">in</span> valid_signals)</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>cat_name<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>n_valid<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(sigs)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="mass-factor-construction" class="level3" data-number="21.2.2">
<h3 data-number="21.2.2" class="anchored" data-anchor-id="mass-factor-construction"><span class="header-section-number">21.2.2</span> Mass Factor Construction</h3>
<p>We run the factor construction engine (from the previous chapter) across all valid signals to produce a ‚Äúzoo‚Äù of factor returns:</p>
<div id="mass-construction" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the factor engine from previous chapter</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># (In practice, this would be imported from a shared module)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_factor_simple(panel_df, signal_col, long_high<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                              n_groups<span class="op">=</span><span class="dv">5</span>, weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                              min_stocks<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Simplified factor construction: quintile sort on signal,</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    long-short = Q5 - Q1 (or reversed if long_high=False).</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a Series of monthly long-short returns.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> panel_df[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'market_cap'</span>, signal_col]].dropna().copy()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the signal by one month</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'signal_lag'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[signal_col].shift(<span class="dv">1</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'signal_lag'</span>, <span class="st">'monthly_return'</span>])</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month, group <span class="kw">in</span> df.groupby(<span class="st">'month_end'</span>):</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'quintile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'signal_lag'</span>].rank(method<span class="op">=</span><span class="st">'first'</span>),</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            n_groups, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weighting <span class="op">==</span> <span class="st">'value'</span>:</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            <span class="kw">def</span> wret(g):</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> np.average(g[<span class="st">'monthly_return'</span>],</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                                       weights<span class="op">=</span>g[<span class="st">'market_cap'</span>])</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> g[<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> group.groupby(<span class="st">'quintile'</span>).<span class="bu">apply</span>(wret)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> group.groupby(<span class="st">'quintile'</span>)[<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="kw">in</span> port_ret.index <span class="kw">and</span> (n_groups <span class="op">-</span> <span class="dv">1</span>) <span class="kw">in</span> port_ret.index:</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> long_high:</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>                ls <span class="op">=</span> port_ret[n_groups <span class="op">-</span> <span class="dv">1</span>] <span class="op">-</span> port_ret[<span class="dv">0</span>]</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>                ls <span class="op">=</span> port_ret[<span class="dv">0</span>] <span class="op">-</span> port_ret[n_groups <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            results.append({<span class="st">'month_end'</span>: month, <span class="st">'ls_return'</span>: ls})</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> results:</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).set_index(<span class="st">'month_end'</span>)[<span class="st">'ls_return'</span>]</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine expected sign for each signal</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co"># (positive = high signal predicts high returns)</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>signal_directions <span class="op">=</span> {</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value: high = higher returns</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bm'</span>: <span class="va">True</span>, <span class="st">'ep'</span>: <span class="va">True</span>, <span class="st">'cfp'</span>: <span class="va">True</span>, <span class="st">'sp'</span>: <span class="va">True</span>, <span class="st">'dp'</span>: <span class="va">True</span>,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Size: small = higher returns (low signal = high returns)</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_mcap'</span>: <span class="va">False</span>, <span class="st">'log_assets'</span>: <span class="va">False</span>, <span class="st">'log_revenue'</span>: <span class="va">False</span>,</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Profitability: high = higher returns</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gp_at'</span>: <span class="va">True</span>, <span class="st">'op'</span>: <span class="va">True</span>, <span class="st">'roe'</span>: <span class="va">True</span>, <span class="st">'roa'</span>: <span class="va">True</span>,</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">'profit_margin'</span>: <span class="va">True</span>, <span class="st">'asset_turnover'</span>: <span class="va">True</span>,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gross_margin'</span>: <span class="va">True</span>, <span class="st">'oper_margin'</span>: <span class="va">True</span>,</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Investment: low growth = higher returns</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="st">'asset_growth'</span>: <span class="va">False</span>, <span class="st">'capex_at'</span>: <span class="va">False</span>, <span class="st">'investment'</span>: <span class="va">False</span>,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sales_growth'</span>: <span class="va">False</span>, <span class="st">'equity_issuance'</span>: <span class="va">False</span>,</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">'debt_issuance'</span>: <span class="va">False</span>,</span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Momentum: high = higher returns (except reversal)</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret_12_2'</span>: <span class="va">True</span>, <span class="st">'ret_6_2'</span>: <span class="va">True</span>, <span class="st">'ret_12_7'</span>: <span class="va">True</span>,</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret_1'</span>: <span class="va">False</span>, <span class="st">'ret_3_1'</span>: <span class="va">False</span>, <span class="st">'sue'</span>: <span class="va">True</span>,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Risk: low risk = higher returns (anomaly direction)</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="st">'beta'</span>: <span class="va">False</span>, <span class="st">'ivol'</span>: <span class="va">False</span>, <span class="st">'tvol'</span>: <span class="va">False</span>,</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_ret'</span>: <span class="va">False</span>, <span class="st">'skewness'</span>: <span class="va">False</span>,</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Liquidity: illiquid = higher returns</span></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">'amihud'</span>: <span class="va">True</span>, <span class="st">'zero_return_pct'</span>: <span class="va">True</span>,</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_turnover'</span>: <span class="va">False</span>, <span class="st">'roll_spread'</span>: <span class="va">True</span>,</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs_spread'</span>: <span class="va">True</span>, <span class="st">'volume_cv'</span>: <span class="va">True</span>,</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quality: high quality = higher returns</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">'leverage'</span>: <span class="va">False</span>, <span class="st">'current_ratio'</span>: <span class="va">True</span>, <span class="st">'accruals'</span>: <span class="va">False</span>,</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">'earnings_variability'</span>: <span class="va">False</span>, <span class="st">'piotroski_f'</span>: <span class="va">True</span>,</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividend: high = higher returns</span></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">'div_yield'</span>: <span class="va">True</span>, <span class="st">'payout_ratio'</span>: <span class="va">True</span>, <span class="st">'net_repurchase'</span>: <span class="va">False</span>,</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct all factors</span></span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>zoo_results <span class="op">=</span> {}</span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> valid_signals:</span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    long_high <span class="op">=</span> signal_directions.get(sig, <span class="va">True</span>)</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> construct_factor_simple(</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        panel, sig, long_high<span class="op">=</span>long_high,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        n_groups<span class="op">=</span><span class="dv">5</span>, weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ls <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="bu">len</span>(ls) <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> ls.mean()</span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> ls.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(ls))</span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean_ret <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        zoo_results[sig] <span class="op">=</span> {</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_monthly'</span>: mean_ret,</span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ann_return'</span>: mean_ret <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ann_vol'</span>: ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>),</span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe'</span>: mean_ret <span class="op">/</span> ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ls.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t_stat'</span>: t,</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">'abs_t'</span>: <span class="bu">abs</span>(t),</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">'p_value'</span>: <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t), df<span class="op">=</span><span class="bu">len</span>(ls) <span class="op">-</span> <span class="dv">1</span>)),</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_months'</span>: <span class="bu">len</span>(ls),</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">'direction'</span>: <span class="st">'Long High'</span> <span class="cf">if</span> long_high <span class="cf">else</span> <span class="st">'Long Low'</span>,</span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>            <span class="st">'category'</span>: <span class="bu">next</span>(</span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>                (cat <span class="cf">for</span> cat, sigs <span class="kw">in</span> [</span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Value'</span>, value_signals), (<span class="st">'Size'</span>, size_signals),</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Profitability'</span>, prof_signals),</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Investment'</span>, inv_signals),</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Momentum'</span>, mom_signals), (<span class="st">'Risk'</span>, risk_signals),</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Liquidity'</span>, liq_signals),</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Quality'</span>, qual_signals),</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Dividend'</span>, div_signals)</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a>                ] <span class="cf">if</span> sig <span class="kw">in</span> sigs), <span class="st">'Other'</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a>            <span class="st">'returns'</span>: ls  <span class="co"># Store for later use</span></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a>zoo_df <span class="op">=</span> pd.DataFrame({k: {kk: vv <span class="cf">for</span> kk, vv <span class="kw">in</span> v.items() <span class="cf">if</span> kk <span class="op">!=</span> <span class="st">'returns'</span>}</span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> k, v <span class="kw">in</span> zoo_results.items()}).T</span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a>zoo_df <span class="op">=</span> zoo_df.sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors successfully constructed: </span><span class="sc">{</span><span class="bu">len</span>(zoo_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with |t| &gt; 2.0: </span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with |t| &gt; 3.0: </span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-t-stat-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-t-stat-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">6</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Histogram</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>t_vals <span class="op">=</span> zoo_df[<span class="st">'t_stat'</span>].values</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(t_vals, bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>             edgecolor<span class="op">=</span><span class="st">'white'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay normal distribution under null</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>x_range <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">200</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(x_range, stats.norm.pdf(x_range), <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'N(0,1) null'</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold lines</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'|t| = 1.96'</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=-</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'|t| = 3.0 (HLZ)'</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=-</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'t-statistic'</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: t-Statistic Distribution'</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Ranked bar chart</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>top_n <span class="op">=</span> <span class="bu">min</span>(<span class="dv">40</span>, <span class="bu">len</span>(zoo_df))</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> zoo_df.head(top_n).copy()</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>category_colors <span class="op">=</span> {</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'Size'</span>: <span class="st">'#1ABC9C'</span>, <span class="st">'Profitability'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Investment'</span>: <span class="st">'#E67E22'</span>, <span class="st">'Momentum'</span>: <span class="st">'#C0392B'</span>, <span class="st">'Risk'</span>: <span class="st">'#8E44AD'</span>,</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Liquidity'</span>: <span class="st">'#3498DB'</span>, <span class="st">'Quality'</span>: <span class="st">'#F1C40F'</span>, <span class="st">'Dividend'</span>: <span class="st">'#95A5A6'</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>bar_colors <span class="op">=</span> [category_colors.get(top.iloc[i][<span class="st">'category'</span>], <span class="st">'#BDC3C7'</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(top))]</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].barh(<span class="bu">range</span>(top_n), top[<span class="st">'abs_t'</span>].values,</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span>bar_colors, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(top_n))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels(top.index, fontsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'|t-statistic|'</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Anomalies Ranked by |t|'</span>)</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].invert_yaxis()</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend for categories</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [Patch(facecolor<span class="op">=</span>c, label<span class="op">=</span>cat)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> cat, c <span class="kw">in</span> category_colors.items()]</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(handles<span class="op">=</span>legend_elements, fontsize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>                loc<span class="op">=</span><span class="st">'lower right'</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-t-stat-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.1
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-zoo-multiple-testing" class="level2" data-number="21.3">
<h2 data-number="21.3" class="anchored" data-anchor-id="sec-factor-zoo-multiple-testing"><span class="header-section-number">21.3</span> The Multiple Testing Problem</h2>
<section id="why-single-test-p-values-are-misleading" class="level3" data-number="21.3.1">
<h3 data-number="21.3.1" class="anchored" data-anchor-id="why-single-test-p-values-are-misleading"><span class="header-section-number">21.3.1</span> Why Single-Test p-Values Are Misleading</h3>
<p>Suppose you test <span class="math inline">\(M\)</span> independent hypotheses, each at significance level <span class="math inline">\(\alpha = 0.05\)</span>. Under the global null (no true effects), the expected number of false rejections is <span class="math inline">\(M \times \alpha\)</span>. For <span class="math inline">\(M = 50\)</span> anomalies, you expect 2.5 ‚Äúsignificant‚Äù results by pure chance.</p>
<p>The probability of <em>at least one</em> false rejection is:</p>
<p><span id="eq-family-error"><span class="math display">\[
P(\text{at least one false discovery}) = 1 - (1 - \alpha)^M
\tag{21.1}\]</span></span></p>
<p>For <span class="math inline">\(M = 50\)</span> and <span class="math inline">\(\alpha = 0.05\)</span>, this is <span class="math inline">\(1 - 0.95^{50} = 0.923\)</span>. For <span class="math inline">\(M = 300\)</span>, it is essentially 1. The single-test p-value is useless for deciding which of many tested factors are genuine.</p>
</section>
<section id="two-error-rate-concepts" class="level3" data-number="21.3.2">
<h3 data-number="21.3.2" class="anchored" data-anchor-id="two-error-rate-concepts"><span class="header-section-number">21.3.2</span> Two Error Rate Concepts</h3>
<p>Multiple testing corrections control one of two error rates:</p>
<p><strong>Family-Wise Error Rate (FWER).</strong> The probability of making <em>at least one</em> Type I error across all tests. This is the most conservative criterion. If FWER = 0.05, you can be 95% confident that <em>every</em> rejected null is a true discovery. Methods: <span class="citation" data-cites="bonferroni1936teoria">Bonferroni (<a href="references.html#ref-bonferroni1936teoria" role="doc-biblioref">1936</a>)</span> correction, Holm step-down, <span class="citation" data-cites="romano2005exact">Romano and Wolf (<a href="references.html#ref-romano2005exact" role="doc-biblioref">2005</a>)</span>.</p>
<p><strong>False Discovery Rate (FDR).</strong> The expected <em>proportion</em> of rejected hypotheses that are false. This is less conservative. If FDR = 0.05, you expect that 5% of your discoveries are false, but the other 95% are real. Methods: <span class="citation" data-cites="benjamini1995controlling">Benjamini and Hochberg (<a href="references.html#ref-benjamini1995controlling" role="doc-biblioref">1995</a>)</span> (BH), <span class="citation" data-cites="storey2003positive">Storey (<a href="references.html#ref-storey2003positive" role="doc-biblioref">2003</a>)</span>.</p>
<p>In asset pricing, FDR control is generally more appropriate than FWER because we are not trying to guarantee zero false discoveries, we are trying to identify a set of factors where <em>most</em> are genuine. A researcher who controls FDR at 5% and discovers 10 factors expects approximately 0.5 of them to be false, which is acceptable for building a factor model.</p>
<div id="fig-error-rates" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-error-rates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>M_range <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">301</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>fwer_unadj <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">**</span> M_range</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>fwer_bonf <span class="op">=</span> np.minimum(<span class="dv">1</span>, M_range <span class="op">*</span> alpha)  <span class="co"># Not actual FWER, just threshold</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected false discoveries at alpha = 0.05</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>expected_false <span class="op">=</span> M_range <span class="op">*</span> alpha</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(M_range, fwer_unadj, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Unadjusted FWER'</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Œ± = 0.05 target'</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Number of Tests (M)'</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'P(‚â•1 False Discovery)'</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Family-Wise Error Rate'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(M_range, expected_false, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Number of Tests (M)'</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Expected False Discoveries'</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Expected False Discoveries at Œ± = 0.05'</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].text(<span class="dv">250</span>, <span class="fl">1.5</span>, <span class="st">'1 false discovery'</span>, color<span class="op">=</span><span class="st">'gray'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-error-rates-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.2
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-zoo-corrections" class="level2" data-number="21.4">
<h2 data-number="21.4" class="anchored" data-anchor-id="sec-factor-zoo-corrections"><span class="header-section-number">21.4</span> Correction Methods</h2>
<section id="bonferroni-correction-fwer-control" class="level3" data-number="21.4.1">
<h3 data-number="21.4.1" class="anchored" data-anchor-id="bonferroni-correction-fwer-control"><span class="header-section-number">21.4.1</span> Bonferroni Correction (FWER Control)</h3>
<p>The simplest and most conservative correction: reject hypothesis <span class="math inline">\(i\)</span> only if its p-value is below <span class="math inline">\(\alpha / M\)</span>, where <span class="math inline">\(M\)</span> is the total number of tests:</p>
<p><span id="eq-bonferroni"><span class="math display">\[
\text{Reject } H_{0,i} \text{ if } p_i &lt; \frac{\alpha}{M}
\tag{21.2}\]</span></span></p>
<p>This controls FWER at <span class="math inline">\(\alpha\)</span> regardless of the dependence structure among tests. The cost is severe loss of power: for <span class="math inline">\(M = 50\)</span> tests at <span class="math inline">\(\alpha = 0.05\)</span>, the per-test threshold becomes <span class="math inline">\(0.001\)</span>, requiring <span class="math inline">\(|t| &gt; 3.29\)</span>.</p>
<div id="bonferroni" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="bu">len</span>(zoo_df)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Bonferroni threshold</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>bonf_threshold <span class="op">=</span> alpha <span class="op">/</span> M</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>bonf_t_threshold <span class="op">=</span> stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> bonf_threshold <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bonf_reject'</span>] <span class="op">=</span> zoo_df[<span class="st">'p_value'</span>] <span class="op">&lt;</span> bonf_threshold</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of tests: </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Bonferroni p-value threshold: </span><span class="sc">{</span>bonf_threshold<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equivalent t-statistic threshold: </span><span class="sc">{</span>bonf_t_threshold<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rejections: </span><span class="sc">{</span>zoo_df[<span class="st">'bonf_reject'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Surviving anomalies:"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'bonf_reject'</span>]]</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'category'</span>]].to_string())</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  None survive Bonferroni correction"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="holm-step-down-procedure-fwer-control" class="level3" data-number="21.4.2">
<h3 data-number="21.4.2" class="anchored" data-anchor-id="holm-step-down-procedure-fwer-control"><span class="header-section-number">21.4.2</span> Holm Step-Down Procedure (FWER Control)</h3>
<p>The Holm procedure is uniformly more powerful than Bonferroni while still controlling FWER. It ranks p-values from smallest to largest and applies progressively less stringent thresholds:</p>
<ol type="1">
<li>Sort p-values: <span class="math inline">\(p_{(1)} \leq p_{(2)} \leq \ldots \leq p_{(M)}\)</span></li>
<li>For <span class="math inline">\(i = 1, 2, \ldots\)</span>, reject <span class="math inline">\(H_{0,(i)}\)</span> if <span class="math inline">\(p_{(i)} &lt; \alpha / (M - i + 1)\)</span></li>
<li>Stop at the first <span class="math inline">\(i\)</span> where <span class="math inline">\(H_{0,(i)}\)</span> is not rejected</li>
</ol>
<div id="holm" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>p_values <span class="op">=</span> zoo_df[<span class="st">'p_value'</span>].values</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>signal_names <span class="op">=</span> zoo_df.index.values</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using statsmodels implementation</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>reject_holm, pvals_corrected_holm, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.05</span>, method<span class="op">=</span><span class="st">'holm'</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'holm_reject'</span>] <span class="op">=</span> reject_holm</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'holm_p_corrected'</span>] <span class="op">=</span> pvals_corrected_holm</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holm rejections: </span><span class="sc">{</span>reject_holm<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>holm_survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'holm_reject'</span>]]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(holm_survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Surviving anomalies (Holm):"</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(holm_survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'holm_p_corrected'</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'category'</span>]].to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="benjamini-hochberg-procedure-fdr-control" class="level3" data-number="21.4.3">
<h3 data-number="21.4.3" class="anchored" data-anchor-id="benjamini-hochberg-procedure-fdr-control"><span class="header-section-number">21.4.3</span> Benjamini-Hochberg Procedure (FDR Control)</h3>
<p>The <span class="citation" data-cites="benjamini1995controlling">Benjamini and Hochberg (<a href="references.html#ref-benjamini1995controlling" role="doc-biblioref">1995</a>)</span> (BH) procedure controls the False Discovery Rate (i.e., the expected proportion of rejections that are false) at level <span class="math inline">\(q\)</span>:</p>
<ol type="1">
<li>Sort p-values: <span class="math inline">\(p_{(1)} \leq p_{(2)} \leq \ldots \leq p_{(M)}\)</span></li>
<li>Find the largest <span class="math inline">\(k\)</span> such that <span class="math inline">\(p_{(k)} \leq \frac{k}{M} q\)</span></li>
<li>Reject all <span class="math inline">\(H_{0,(i)}\)</span> for <span class="math inline">\(i = 1, \ldots, k\)</span></li>
</ol>
<p>The BH procedure is valid under independence or positive dependence (PRDS), a condition that is generally satisfied for financial factor tests where factors tend to be positively correlated under the null.</p>
<div id="bh-fdr" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># BH procedure at q = 0.05 (expect 5% false discoveries)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>reject_bh, pvals_corrected_bh, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.05</span>, method<span class="op">=</span><span class="st">'fdr_bh'</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh_reject'</span>] <span class="op">=</span> reject_bh</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh_p_corrected'</span>] <span class="op">=</span> pvals_corrected_bh</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Also at q = 0.10 (more liberal)</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>reject_bh10, _, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.10</span>, method<span class="op">=</span><span class="st">'fdr_bh'</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh10_reject'</span>] <span class="op">=</span> reject_bh10</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"BH rejections (q=0.05): </span><span class="sc">{</span>reject_bh<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"BH rejections (q=0.10): </span><span class="sc">{</span>reject_bh10<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>bh_survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'bh_reject'</span>]].sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(bh_survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Surviving anomalies (BH, q=0.05):"</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(bh_survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'bh_p_corrected'</span>,</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'category'</span>]].head(<span class="dv">20</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-bh-procedure" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bh-procedure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>sorted_pvals <span class="op">=</span> np.sort(p_values)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> np.arange(<span class="dv">1</span>, M <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>bh_line_05 <span class="op">=</span> k <span class="op">/</span> M <span class="op">*</span> <span class="fl">0.05</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>bh_line_10 <span class="op">=</span> k <span class="op">/</span> M <span class="op">*</span> <span class="fl">0.10</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ax.scatter(k, sorted_pvals, s<span class="op">=</span><span class="dv">15</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">'Sorted p-values'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ax.plot(k, bh_line_05, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'BH line (q=0.05)'</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>ax.plot(k, bh_line_10, color<span class="op">=</span><span class="st">'#E67E22'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'BH line (q=0.10)'</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight rejections</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>n_reject_05 <span class="op">=</span> reject_bh.<span class="bu">sum</span>()</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_reject_05 <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    ax.scatter(k[:n_reject_05], sorted_pvals[:n_reject_05],</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>               s<span class="op">=</span><span class="dv">40</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, zorder<span class="op">=</span><span class="dv">4</span>, label<span class="op">=</span><span class="ss">f'Rejected (q=0.05)'</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Rank (k)'</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'p-value'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Benjamini-Hochberg Procedure'</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.15</span>])</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([<span class="dv">0</span>, <span class="bu">min</span>(M, <span class="dv">60</span>)])</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-bh-procedure-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.3
</figcaption>
</figure>
</div>
</section>
<section id="the-harvey-liu-zhu-threshold" class="level3" data-number="21.4.4">
<h3 data-number="21.4.4" class="anchored" data-anchor-id="the-harvey-liu-zhu-threshold"><span class="header-section-number">21.4.4</span> The Harvey-Liu-Zhu Threshold</h3>
<p><span class="citation" data-cites="harvey2016and">Harvey, Liu, and Zhu (<a href="references.html#ref-harvey2016and" role="doc-biblioref">2016</a>)</span> take a different approach: rather than applying a formal multiple-testing correction to a specific set of tests, they estimate the hurdle t-statistic that accounts for the <em>cumulative</em> number of factors tested by the entire profession. Using a Bayesian framework calibrated to the 316 published factors, they derive:</p>
<ul>
<li>For a single new factor tested in isolation: <span class="math inline">\(|t| &gt; 2.0\)</span> (conventional)</li>
<li>Accounting for 100 prior tests: <span class="math inline">\(|t| &gt; 2.8\)</span></li>
<li>Accounting for 316 prior tests: <span class="math inline">\(|t| &gt; 3.0\)</span></li>
<li>Accounting for all conceivable tests: <span class="math inline">\(|t| &gt; 3.78\)</span></li>
</ul>
<p>The logic is that even if <em>your</em> study tests only one factor, the fact that hundreds of researchers have tested hundreds of signals before you means the prior probability that your specific signal is a true predictor is low.</p>
<div id="hlz-threshold" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>hlz_thresholds <span class="op">=</span> {</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Conventional (|t| &gt; 2.0)'</span>: <span class="fl">2.0</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ 100 tests (|t| &gt; 2.8)'</span>: <span class="fl">2.8</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ 316 tests (|t| &gt; 3.0)'</span>: <span class="fl">3.0</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ conservative (|t| &gt; 3.78)'</span>: <span class="fl">3.78</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Anomalies Surviving Different t-Thresholds:"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Threshold'</span><span class="sc">:&lt;35}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Surviving'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'</span><span class="sc">% o</span><span class="st">f Zoo'</span><span class="sc">:&gt;10}</span><span class="ss">"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">55</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, thresh <span class="kw">in</span> hlz_thresholds.items():</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    n_survive <span class="op">=</span> (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> thresh).<span class="bu">sum</span>()</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> n_survive <span class="op">/</span> <span class="bu">len</span>(zoo_df) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;35}</span><span class="ss"> </span><span class="sc">{</span>n_survive<span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span>pct<span class="sc">:&gt;10.1f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-zoo-comparison" class="level2" data-number="21.5">
<h2 data-number="21.5" class="anchored" data-anchor-id="sec-factor-zoo-comparison"><span class="header-section-number">21.5</span> Comparison of Methods</h2>
<div id="fig-correction-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-correction-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Unadjusted (|t| &gt; 2)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>).<span class="bu">sum</span>(),</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Bonferroni'</span>: zoo_df[<span class="st">'bonf_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Holm'</span>: zoo_df[<span class="st">'holm_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BH (q=0.05)'</span>: zoo_df[<span class="st">'bh_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BH (q=0.10)'</span>: zoo_df[<span class="st">'bh10_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ (|t| &gt; 3.0)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>).<span class="bu">sum</span>(),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ (|t| &gt; 3.78)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.78</span>).<span class="bu">sum</span>(),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> <span class="bu">list</span>(comparison.keys())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> <span class="bu">list</span>(comparison.values())</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#BDC3C7'</span>, <span class="st">'#C0392B'</span>, <span class="st">'#E74C3C'</span>, <span class="st">'#27AE60'</span>, <span class="st">'#2ECC71'</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>          <span class="st">'#2C5F8A'</span>, <span class="st">'#1A3C5A'</span>]</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> ax.barh(<span class="bu">range</span>(<span class="bu">len</span>(names)), counts, color<span class="op">=</span>colors,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>               alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(names)))</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(names)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Number of Surviving Anomalies'</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomalies Surviving Multiple Testing Corrections'</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, count) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(names, counts)):</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    ax.text(count <span class="op">+</span> <span class="fl">0.3</span>, i, <span class="bu">str</span>(count), va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-correction-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.4
</figcaption>
</figure>
</div>
<div id="fig-survival-by-category" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-survival-by-category-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cat_survival <span class="op">=</span> (</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    zoo_df.groupby(<span class="st">'category'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        n_total<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="st">'count'</span>),</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        n_survive_bh<span class="op">=</span>(<span class="st">'bh_reject'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        n_survive_hlz<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="fl">3.0</span>).<span class="bu">sum</span>()),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        mean_abs_t<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="st">'mean'</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'mean_abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>cat_survival[<span class="st">'survival_rate_bh'</span>] <span class="op">=</span> (</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    cat_survival[<span class="st">'n_survive_bh'</span>] <span class="op">/</span> cat_survival[<span class="st">'n_total'</span>]</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(cat_survival))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>ax.bar(x, cat_survival[<span class="st">'n_total'</span>], color<span class="op">=</span><span class="st">'#BDC3C7'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>       label<span class="op">=</span><span class="st">'Total tested'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>ax.bar(x, cat_survival[<span class="st">'n_survive_bh'</span>], color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>       label<span class="op">=</span><span class="st">'Survive BH (q=0.05)'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(cat_survival.index, rotation<span class="op">=</span><span class="dv">30</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Number of Anomalies'</span>)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomaly Survival by Category'</span>)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Add survival rate text</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (_, row) <span class="kw">in</span> <span class="bu">enumerate</span>(cat_survival.iterrows()):</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'n_total'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>        ax.text(i, row[<span class="st">'n_total'</span>] <span class="op">+</span> <span class="fl">0.2</span>,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'survival_rate_bh'</span>]<span class="sc">:.0%}</span><span class="ss">"</span>,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'#27AE60'</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-survival-by-category-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.5
</figcaption>
</figure>
</div>
</section>
<section id="sec-factor-zoo-fdp" class="level2" data-number="21.6">
<h2 data-number="21.6" class="anchored" data-anchor-id="sec-factor-zoo-fdp"><span class="header-section-number">21.6</span> Estimating the False Discovery Proportion</h2>
<section id="the-storey-approach" class="level3" data-number="21.6.1">
<h3 data-number="21.6.1" class="anchored" data-anchor-id="the-storey-approach"><span class="header-section-number">21.6.1</span> The Storey Approach</h3>
<p>Rather than controlling FDR at a pre-specified level, we can <em>estimate</em> the proportion of tested hypotheses that are truly null (<span class="math inline">\(\pi_0\)</span>) and the implied false discovery proportion (FDP) at any given threshold. <span class="citation" data-cites="storey2003positive">Storey (<a href="references.html#ref-storey2003positive" role="doc-biblioref">2003</a>)</span> proposes estimating <span class="math inline">\(\pi_0\)</span> from the distribution of p-values: under the null, p-values are uniformly distributed on <span class="math inline">\([0, 1]\)</span>, so the density of p-values in the ‚Äúflat‚Äù region (away from zero) reveals <span class="math inline">\(\pi_0\)</span>.</p>
<p><span id="eq-pi0"><span class="math display">\[
\hat{\pi}_0(\lambda) = \frac{\#\{p_i &gt; \lambda\}}{M(1 - \lambda)}
\tag{21.3}\]</span></span></p>
<p>for a tuning parameter <span class="math inline">\(\lambda\)</span>. The estimated false discovery proportion at threshold <span class="math inline">\(t^*\)</span> is then:</p>
<p><span id="eq-fdp"><span class="math display">\[
\widehat{\text{FDP}}(t^*) = \frac{\hat{\pi}_0 \cdot M \cdot P(|t| &gt; t^* | H_0)}{\#\{|t_i| &gt; t^*\}}
\tag{21.4}\]</span></span></p>
<div id="storey-pi0" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_pi0(p_values, lambdas<span class="op">=</span>np.arange(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="fl">0.05</span>)):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate pi_0 (proportion of true nulls) using Storey (2003).</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses bootstrap to select optimal lambda.</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(p_values)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    pi0_estimates <span class="op">=</span> []</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lam <span class="kw">in</span> lambdas:</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        n_above <span class="op">=</span> (p_values <span class="op">&gt;</span> lam).<span class="bu">sum</span>()</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        pi0 <span class="op">=</span> n_above <span class="op">/</span> (M <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> lam))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        pi0_estimates.append({<span class="st">'lambda'</span>: lam, <span class="st">'pi0'</span>: <span class="bu">min</span>(pi0, <span class="fl">1.0</span>)})</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    pi0_df <span class="op">=</span> pd.DataFrame(pi0_estimates)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the median of estimates for robustness</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (alternatives: bootstrap, spline smoothing)</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    pi0_hat <span class="op">=</span> pi0_df[<span class="st">'pi0'</span>].median()</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pi0_hat, pi0_df</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>pi0_hat, pi0_df <span class="op">=</span> estimate_pi0(zoo_df[<span class="st">'p_value'</span>].values)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Estimated œÄ‚ÇÄ (proportion of true nulls): </span><span class="sc">{</span>pi0_hat<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Implied proportion of true factors: </span><span class="sc">{</span><span class="dv">1</span> <span class="op">-</span> pi0_hat<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Estimated number of true factors: </span><span class="sc">{</span>(<span class="dv">1</span> <span class="op">-</span> pi0_hat) <span class="op">*</span> <span class="bu">len</span>(zoo_df)<span class="sc">:.0f}</span><span class="ss"> "</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"out of </span><span class="sc">{</span><span class="bu">len</span>(zoo_df)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-pvalue-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="15">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pvalue-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: p-value histogram</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(zoo_df[<span class="st">'p_value'</span>], bins<span class="op">=</span><span class="dv">20</span>, density<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span>pi0_hat, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'œÄ‚ÇÄ = </span><span class="sc">{</span>pi0_hat<span class="sc">:.2f}</span><span class="ss"> (null density)'</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">':'</span>,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Uniform (all null)'</span>)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'p-value'</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: p-Value Distribution'</span>)</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: pi_0 estimates across lambda</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(pi0_df[<span class="st">'lambda'</span>], pi0_df[<span class="st">'pi0'</span>],</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(y<span class="op">=</span>pi0_hat, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'Median œÄ‚ÇÄ = </span><span class="sc">{</span>pi0_hat<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Œª'</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'œÄ‚ÇÄ(Œª)'</span>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: œÄ‚ÇÄ Estimates by Œª'</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim([<span class="dv">0</span>, <span class="fl">1.05</span>])</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-pvalue-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.6
</figcaption>
</figure>
</div>
</section>
<section id="fdp-curve" class="level3" data-number="21.6.2">
<h3 data-number="21.6.2" class="anchored" data-anchor-id="fdp-curve"><span class="header-section-number">21.6.2</span> FDP Curve</h3>
<p>Using <span class="math inline">\(\hat{\pi}_0\)</span>, we compute the estimated FDP at every possible t-threshold:</p>
<div id="fig-fdp-curve" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="16">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-fdp-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>t_thresholds <span class="op">=</span> np.arange(<span class="fl">1.0</span>, <span class="fl">5.01</span>, <span class="fl">0.1</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>fdp_curve <span class="op">=</span> []</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t_thresh <span class="kw">in</span> t_thresholds:</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    n_rejected <span class="op">=</span> (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> t_thresh).<span class="bu">sum</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_rejected <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        fdp_curve.append({<span class="st">'t_threshold'</span>: t_thresh, <span class="st">'n_rejected'</span>: <span class="dv">0</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'fdp'</span>: <span class="dv">0</span>})</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected false discoveries under null</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    p_null_reject <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.norm.cdf(t_thresh))</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    expected_false <span class="op">=</span> pi0_hat <span class="op">*</span> <span class="bu">len</span>(zoo_df) <span class="op">*</span> p_null_reject</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    fdp <span class="op">=</span> <span class="bu">min</span>(expected_false <span class="op">/</span> n_rejected, <span class="fl">1.0</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    fdp_curve.append({<span class="st">'t_threshold'</span>: t_thresh, <span class="st">'n_rejected'</span>: n_rejected,</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'fdp'</span>: fdp})</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>fdp_df <span class="op">=</span> pd.DataFrame(fdp_curve)</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: FDP curve</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(fdp_df[<span class="st">'t_threshold'</span>], fdp_df[<span class="st">'fdp'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'5</span><span class="sc">% F</span><span class="st">DP'</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'10</span><span class="sc">% F</span><span class="st">DP'</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">2.0</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'|t| = 2.0'</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'|t| = 3.0'</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'|t| Threshold'</span>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Estimated FDP (%)'</span>)</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: False Discovery Proportion'</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylim([<span class="op">-</span><span class="dv">2</span>, <span class="dv">80</span>])</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of rejections</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(fdp_df[<span class="st">'t_threshold'</span>], fdp_df[<span class="st">'n_rejected'</span>],</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'|t| Threshold'</span>)</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Discoveries'</span>)</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Discoveries vs Threshold'</span>)</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-fdp-curve-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.7
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-zoo-bootstrap" class="level2" data-number="21.7">
<h2 data-number="21.7" class="anchored" data-anchor-id="sec-factor-zoo-bootstrap"><span class="header-section-number">21.7</span> Bootstrap-Based Multiple Testing</h2>
<section id="the-white-reality-check" class="level3" data-number="21.7.1">
<h3 data-number="21.7.1" class="anchored" data-anchor-id="the-white-reality-check"><span class="header-section-number">21.7.1</span> The White Reality Check</h3>
<p>Analytical corrections assume known distributions. When return distributions are non-normal (heavy tails, skewness, serial correlation), as they are in Vietnam, bootstrap methods provide more reliable inference.</p>
<p><span class="citation" data-cites="white2000reality">White (<a href="references.html#ref-white2000reality" role="doc-biblioref">2000</a>)</span> proposes a bootstrap reality check that accounts for data snooping across multiple strategies. The null hypothesis is that the best strategy has zero expected return. The procedure:</p>
<ol type="1">
<li>Generate <span class="math inline">\(B\)</span> bootstrap samples of the time series (block bootstrap to preserve serial dependence).</li>
<li>For each bootstrap sample, compute the t-statistic for every factor.</li>
<li>The p-value for factor <span class="math inline">\(i\)</span> is the proportion of bootstrap samples in which the maximum t-statistic across all factors exceeds the observed t-statistic of factor <span class="math inline">\(i\)</span>.</li>
</ol>
<div id="bootstrap-rc" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> white_reality_check(factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                          block_size<span class="op">=</span><span class="dv">6</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    White (2000) Reality Check for data snooping.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    factor_returns_dict : dict</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">        {factor_name: pd.Series of monthly returns}</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">    n_bootstrap : int</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of bootstrap replications</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    block_size : int</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Block length for circular block bootstrap</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with original t-stats and bootstrap p-values</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align all factor returns to common dates</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    all_names <span class="op">=</span> <span class="bu">list</span>(factor_returns_dict.keys())</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="va">None</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> all_names:</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> <span class="bu">set</span>(factor_returns_dict[name].index)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        common_dates <span class="op">=</span> dates <span class="cf">if</span> common_dates <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_dates <span class="op">&amp;</span> dates</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="bu">sorted</span>(common_dates)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common_dates)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build return matrix (T x M)</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(all_names)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    return_matrix <span class="op">=</span> np.column_stack([</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        factor_returns_dict[name].reindex(common_dates).values</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> all_names</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Observed t-statistics</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> np.nanmean(return_matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    ses <span class="op">=</span> np.nanstd(return_matrix, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    t_obs <span class="op">=</span> means <span class="op">/</span> np.where(ses <span class="op">&gt;</span> <span class="dv">0</span>, ses, np.nan)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Block bootstrap</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    n_blocks <span class="op">=</span> <span class="bu">int</span>(np.ceil(T <span class="op">/</span> block_size))</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    max_t_bootstrap <span class="op">=</span> np.zeros(n_bootstrap)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Circular block bootstrap</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        block_starts <span class="op">=</span> rng.integers(<span class="dv">0</span>, T, size<span class="op">=</span>n_blocks)</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        indices <span class="op">=</span> np.concatenate([</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>            np.arange(start, start <span class="op">+</span> block_size) <span class="op">%</span> T</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> start <span class="kw">in</span> block_starts</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        ])[:T]</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>        boot_returns <span class="op">=</span> return_matrix[indices, :]</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Center under null (subtract original mean)</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        boot_centered <span class="op">=</span> boot_returns <span class="op">-</span> means[np.newaxis, :]</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute t-stats under null</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>        boot_means <span class="op">=</span> np.nanmean(boot_centered, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>        boot_ses <span class="op">=</span> np.nanstd(boot_centered, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>        boot_t <span class="op">=</span> boot_means <span class="op">/</span> np.where(boot_ses <span class="op">&gt;</span> <span class="dv">0</span>, boot_ses, np.nan)</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>        max_t_bootstrap[b] <span class="op">=</span> np.nanmax(np.<span class="bu">abs</span>(boot_t))</span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap p-values (one-sided: is obs_t extreme relative to max?)</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    boot_pvals <span class="op">=</span> np.array([</span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>        np.mean(max_t_bootstrap <span class="op">&gt;=</span> <span class="bu">abs</span>(t)) <span class="cf">if</span> np.isfinite(t) <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> t_obs</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor'</span>: all_names,</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat_obs'</span>: t_obs,</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'boot_pval'</span>: boot_pvals</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a>    }).set_index(<span class="st">'factor'</span>)</span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, max_t_bootstrap</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect factor return series</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>factor_returns_dict <span class="op">=</span> {</span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    name: zoo_results[name][<span class="st">'returns'</span>]</span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> zoo_results</span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'returns'</span> <span class="kw">in</span> zoo_results[name]</span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a>boot_results, max_t_dist <span class="op">=</span> white_reality_check(</span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>    factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>, block_size<span class="op">=</span><span class="dv">6</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>boot_results <span class="op">=</span> boot_results.sort_values(<span class="st">'t_stat_obs'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"White Reality Check Results (top 20):"</span>)</span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(boot_results.head(<span class="dv">20</span>).<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Factors surviving (boot p &lt; 0.05): "</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>(boot_results[<span class="st">'boot_pval'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-bootstrap-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-bootstrap-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>ax.hist(max_t_dist, bins<span class="op">=</span><span class="dv">40</span>, density<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'#BDC3C7'</span>,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, label<span class="op">=</span><span class="st">'Bootstrap null</span><span class="ch">\n</span><span class="st">(max |t| across all factors)'</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>p95 <span class="op">=</span> np.percentile(max_t_dist, <span class="dv">95</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>ax.axvline(x<span class="op">=</span>p95, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="ss">f'95th percentile = </span><span class="sc">{</span>p95<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed top factor t-statistics</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>top_5 <span class="op">=</span> boot_results.head(<span class="dv">5</span>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top_5.iterrows()):</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="bu">abs</span>(row[<span class="st">'t_stat_obs'</span>]),</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span>plt.cm.Set1(i), linewidth<span class="op">=</span><span class="fl">1.5</span>, linestyle<span class="op">=</span><span class="st">':'</span>,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: |t| = </span><span class="sc">{</span><span class="bu">abs</span>(row[<span class="st">"t_stat_obs"</span>])<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Maximum |t-statistic|'</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"White's Reality Check: Bootstrap Null Distribution"</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-bootstrap-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.8
</figcaption>
</figure>
</div>
</section>
<section id="romano-wolf-step-down-bootstrap" class="level3" data-number="21.7.2">
<h3 data-number="21.7.2" class="anchored" data-anchor-id="romano-wolf-step-down-bootstrap"><span class="header-section-number">21.7.2</span> Romano-Wolf Step-Down Bootstrap</h3>
<p>The <span class="citation" data-cites="romano2005exact">Romano and Wolf (<a href="references.html#ref-romano2005exact" role="doc-biblioref">2005</a>)</span> step-down procedure improves on the White Reality Check by iteratively removing rejected hypotheses and re-testing the remaining ones, gaining power at each step:</p>
<div id="romano-wolf" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> romano_wolf_stepdown(factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                           block_size<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span><span class="fl">0.05</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Romano-Wolf (2005) step-down procedure for FWER control.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    More powerful than single-step methods because rejected</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    hypotheses are removed before re-testing.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    all_names <span class="op">=</span> <span class="bu">list</span>(factor_returns_dict.keys())</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> all_names:</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> <span class="bu">set</span>(factor_returns_dict[name].index)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        common_dates <span class="op">=</span> dates <span class="cf">if</span> common_dates <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_dates <span class="op">&amp;</span> dates</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="bu">sorted</span>(common_dates)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common_dates)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(all_names)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    return_matrix <span class="op">=</span> np.column_stack([</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        factor_returns_dict[name].reindex(common_dates).values</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> all_names</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> np.nanmean(return_matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    ses <span class="op">=</span> np.nanstd(return_matrix, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    t_obs <span class="op">=</span> np.<span class="bu">abs</span>(means <span class="op">/</span> np.where(ses <span class="op">&gt;</span> <span class="dv">0</span>, ses, np.nan))</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by observed t-stat (descending)</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> np.argsort(<span class="op">-</span>t_obs)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    t_sorted <span class="op">=</span> t_obs[order]</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    names_sorted <span class="op">=</span> [all_names[i] <span class="cf">for</span> i <span class="kw">in</span> order]</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step-down procedure</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    rejected <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="bu">set</span>(<span class="bu">range</span>(M))</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(M):</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> remaining:</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        remaining_idx <span class="op">=</span> <span class="bu">sorted</span>(remaining)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bootstrap max t-stat among remaining</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        n_blocks <span class="op">=</span> <span class="bu">int</span>(np.ceil(T <span class="op">/</span> block_size))</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>        max_t_boot <span class="op">=</span> np.zeros(n_bootstrap)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>            block_starts <span class="op">=</span> rng.integers(<span class="dv">0</span>, T, size<span class="op">=</span>n_blocks)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>            indices <span class="op">=</span> np.concatenate([</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>                np.arange(start, start <span class="op">+</span> block_size) <span class="op">%</span> T</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> start <span class="kw">in</span> block_starts</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>            ])[:T]</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>            boot_returns <span class="op">=</span> return_matrix[indices][:, remaining_idx]</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>            boot_centered <span class="op">=</span> boot_returns <span class="op">-</span> means[remaining_idx]</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            boot_means <span class="op">=</span> np.nanmean(boot_centered, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>            boot_ses <span class="op">=</span> np.nanstd(boot_centered, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>            boot_t <span class="op">=</span> np.<span class="bu">abs</span>(boot_means <span class="op">/</span> np.where(boot_ses <span class="op">&gt;</span> <span class="dv">0</span>, boot_ses, np.nan))</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>            max_t_boot[b] <span class="op">=</span> np.nanmax(boot_t)</span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Critical value</span></span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>        cv <span class="op">=</span> np.percentile(max_t_boot, (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Test the most significant remaining factor</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the factor with highest t among remaining</span></span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>        best_remaining <span class="op">=</span> <span class="bu">max</span>(remaining, key<span class="op">=</span><span class="kw">lambda</span> j: t_obs[j])</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t_obs[best_remaining] <span class="op">&gt;</span> cv:</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>            rejected.add(best_remaining)</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>            remaining.remove(best_remaining)</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span>  <span class="co"># Cannot reject any more</span></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor'</span>: all_names,</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat'</span>: t_obs,</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rejected'</span>: [i <span class="kw">in</span> rejected <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(M)]</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'t_stat'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a>rw_results <span class="op">=</span> romano_wolf_stepdown(</span>
<span id="cb19-85"><a href="#cb19-85" aria-hidden="true" tabindex="-1"></a>    factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">500</span>, block_size<span class="op">=</span><span class="dv">6</span></span>
<span id="cb19-86"><a href="#cb19-86" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-87"><a href="#cb19-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-88"><a href="#cb19-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Romano-Wolf rejections: </span><span class="sc">{</span>rw_results[<span class="st">'rejected'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="bu">len</span>(rw_results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-89"><a href="#cb19-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rejected factors:"</span>)</span>
<span id="cb19-90"><a href="#cb19-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rw_results[rw_results[<span class="st">'rejected'</span>]][[<span class="st">'factor'</span>, <span class="st">'t_stat'</span>]].to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-zoo-oos" class="level2" data-number="21.8">
<h2 data-number="21.8" class="anchored" data-anchor-id="sec-factor-zoo-oos"><span class="header-section-number">21.8</span> Out-of-Sample Validation</h2>
<section id="pre-publication-vs.-post-publication-decay" class="level3" data-number="21.8.1">
<h3 data-number="21.8.1" class="anchored" data-anchor-id="pre-publication-vs.-post-publication-decay"><span class="header-section-number">21.8.1</span> Pre-Publication vs.&nbsp;Post-Publication Decay</h3>
<p><span class="citation" data-cites="mclean2016does">McLean and Pontiff (<a href="references.html#ref-mclean2016does" role="doc-biblioref">2016</a>)</span> find that anomaly returns decline by 32% after publication in the U.S. market, suggesting that roughly one-third of the premium was due to mispricing that was corrected by informed trading. For Vietnam, we use a time-series split as a proxy for out-of-sample testing:</p>
<div id="oos-split" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Split at midpoint of available data</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>all_dates <span class="op">=</span> <span class="bu">sorted</span>(panel[<span class="st">'month_end'</span>].unique())</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>mid_date <span class="op">=</span> all_dates[<span class="bu">len</span>(all_dates) <span class="op">//</span> <span class="dv">2</span>]</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>oos_comparison <span class="op">=</span> []</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> zoo_results:</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> zoo_results[name][<span class="st">'returns'</span>]</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    in_sample <span class="op">=</span> ls[ls.index <span class="op">&lt;=</span> mid_date]</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    out_sample <span class="op">=</span> ls[ls.index <span class="op">&gt;</span> mid_date]</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(in_sample) <span class="op">&lt;</span> <span class="dv">36</span> <span class="kw">or</span> <span class="bu">len</span>(out_sample) <span class="op">&lt;</span> <span class="dv">36</span>:</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    is_mean <span class="op">=</span> in_sample.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    is_t <span class="op">=</span> in_sample.mean() <span class="op">/</span> (in_sample.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(in_sample)))</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    oos_mean <span class="op">=</span> out_sample.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    oos_t <span class="op">=</span> out_sample.mean() <span class="op">/</span> (out_sample.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(out_sample)))</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    oos_comparison.append({</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'signal'</span>: name,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_return'</span>: is_mean,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_t'</span>: is_t,</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'oos_return'</span>: oos_mean,</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'oos_t'</span>: oos_t,</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'decay_pct'</span>: (<span class="dv">1</span> <span class="op">-</span> oos_mean <span class="op">/</span> is_mean) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> is_mean <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan,</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'same_sign'</span>: np.sign(is_mean) <span class="op">==</span> np.sign(oos_mean),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'category'</span>: zoo_results[name].get(<span class="st">'category'</span>, <span class="st">'Other'</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>oos_df <span class="op">=</span> pd.DataFrame(oos_comparison)</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Split date: </span><span class="sc">{</span>mid_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with same sign IS and OOS: "</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>oos_df[<span class="st">'same_sign'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average OOS decay: </span><span class="sc">{</span>oos_df[<span class="st">'decay_pct'</span>]<span class="sc">.</span>median()<span class="sc">:.1f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-is-oos" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-is-oos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Scatter</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>category_colors <span class="op">=</span> {</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'Size'</span>: <span class="st">'#1ABC9C'</span>, <span class="st">'Profitability'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Investment'</span>: <span class="st">'#E67E22'</span>, <span class="st">'Momentum'</span>: <span class="st">'#C0392B'</span>, <span class="st">'Risk'</span>: <span class="st">'#8E44AD'</span>,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Liquidity'</span>: <span class="st">'#3498DB'</span>, <span class="st">'Quality'</span>: <span class="st">'#F1C40F'</span>, <span class="st">'Dividend'</span>: <span class="st">'#95A5A6'</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> oos_df[<span class="st">'category'</span>].unique():</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> oos_df[oos_df[<span class="st">'category'</span>] <span class="op">==</span> cat]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].scatter(subset[<span class="st">'is_return'</span>] <span class="op">*</span> <span class="dv">100</span>, subset[<span class="st">'oos_return'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>category_colors.get(cat, <span class="st">'#BDC3C7'</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>                     s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span>cat, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>lim <span class="op">=</span> <span class="bu">max</span>(<span class="bu">abs</span>(oos_df[<span class="st">'is_return'</span>].<span class="bu">max</span>()), <span class="bu">abs</span>(oos_df[<span class="st">'oos_return'</span>].<span class="bu">max</span>())) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="op">-</span>lim, lim], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="dv">0</span>, <span class="dv">0</span>], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="dv">0</span>, <span class="dv">0</span>], [<span class="op">-</span>lim, lim], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'In-Sample Return (% ann.)'</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Out-of-Sample Return (% ann.)'</span>)</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: IS vs OOS Factor Returns'</span>)</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">7</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Decay by category</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>cat_decay <span class="op">=</span> (</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>    oos_df.groupby(<span class="st">'category'</span>)</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        median_decay<span class="op">=</span>(<span class="st">'decay_pct'</span>, <span class="st">'median'</span>),</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        pct_same_sign<span class="op">=</span>(<span class="st">'same_sign'</span>, <span class="st">'mean'</span>),</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        n<span class="op">=</span>(<span class="st">'signal'</span>, <span class="st">'count'</span>)</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'median_decay'</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>colors_bar <span class="op">=</span> [category_colors.get(cat, <span class="st">'#BDC3C7'</span>) <span class="cf">for</span> cat <span class="kw">in</span> cat_decay.index]</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].barh(<span class="bu">range</span>(<span class="bu">len</span>(cat_decay)), cat_decay[<span class="st">'median_decay'</span>],</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span>colors_bar, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(cat_decay)))</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels(cat_decay.index)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Median OOS Decay (%)'</span>)</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: OOS Decay by Category'</span>)</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-is-oos-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.9
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-zoo-survivors" class="level2" data-number="21.9">
<h2 data-number="21.9" class="anchored" data-anchor-id="sec-factor-zoo-survivors"><span class="header-section-number">21.9</span> Which Factors Survive?</h2>
<section id="a-multi-hurdle-filter" class="level3" data-number="21.9.1">
<h3 data-number="21.9.1" class="anchored" data-anchor-id="a-multi-hurdle-filter"><span class="header-section-number">21.9.1</span> A Multi-Hurdle Filter</h3>
<p>We now combine all the evidence, including multiple testing corrections, out-of-sample performance, and economic plausibility, to identify the factors that deserve credence in the Vietnamese market.</p>
<div id="multi-hurdle" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all test results</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>final <span class="op">=</span> zoo_df.copy()</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add OOS results</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>oos_lookup <span class="op">=</span> oos_df.set_index(<span class="st">'signal'</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'oos_return'</span>, <span class="st">'oos_t'</span>, <span class="st">'same_sign'</span>]:</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    final[col] <span class="op">=</span> final.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: oos_lookup.loc[x, col]</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                                  <span class="cf">if</span> x <span class="kw">in</span> oos_lookup.index <span class="cf">else</span> np.nan)</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bootstrap results</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>boot_lookup <span class="op">=</span> boot_results</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'boot_pval'</span>] <span class="op">=</span> final.index.<span class="bu">map</span>(</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: boot_lookup.loc[x, <span class="st">'boot_pval'</span>]</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> boot_lookup.index <span class="cf">else</span> np.nan</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-hurdle criteria</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_t2'</span>] <span class="op">=</span> final[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_t3'</span>] <span class="op">=</span> final[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_bh'</span>] <span class="op">=</span> final[<span class="st">'bh_reject'</span>]</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_boot'</span>] <span class="op">=</span> final[<span class="st">'boot_pval'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_oos_sign'</span>] <span class="op">=</span> final[<span class="st">'same_sign'</span>] <span class="op">==</span> <span class="va">True</span></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_oos_t'</span>] <span class="op">=</span> final[<span class="st">'oos_t'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.5</span>  <span class="co"># Relaxed OOS threshold</span></span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Count hurdles passed</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>hurdle_cols <span class="op">=</span> [<span class="st">'pass_t2'</span>, <span class="st">'pass_t3'</span>, <span class="st">'pass_bh'</span>, <span class="st">'pass_boot'</span>,</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'pass_oos_sign'</span>, <span class="st">'pass_oos_t'</span>]</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'n_hurdles'</span>] <span class="op">=</span> final[hurdle_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a><span class="co"># "Robust" = passes at least 5 of 6 hurdles</span></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'robust'</span>] <span class="op">=</span> final[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>robust_factors <span class="op">=</span> final[final[<span class="st">'robust'</span>]].sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Multi-Hurdle Filter Results:"</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass |t| &gt; 2.0:        </span><span class="sc">{</span>final[<span class="st">'pass_t2'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass |t| &gt; 3.0:        </span><span class="sc">{</span>final[<span class="st">'pass_t3'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass BH (q=0.05):      </span><span class="sc">{</span>final[<span class="st">'pass_bh'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass bootstrap:        </span><span class="sc">{</span>final[<span class="st">'pass_boot'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass OOS sign:         </span><span class="sc">{</span>final[<span class="st">'pass_oos_sign'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass OOS |t| &gt; 1.5:    </span><span class="sc">{</span>final[<span class="st">'pass_oos_t'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  ROBUST (‚â•5/6 hurdles): </span><span class="sc">{</span>final[<span class="st">'robust'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(robust_factors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Robust Factors:"</span>)</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>    display_cols <span class="op">=</span> [<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'bh_p_corrected'</span>,</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'oos_return'</span>, <span class="st">'oos_t'</span>, <span class="st">'n_hurdles'</span>, <span class="st">'category'</span>]</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>    available_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> display_cols <span class="cf">if</span> c <span class="kw">in</span> robust_factors.columns]</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(robust_factors[available_cols].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-hurdle-heatmap" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="23">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-hurdle-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>top25 <span class="op">=</span> final.sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">25</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>hurdle_matrix <span class="op">=</span> top25[hurdle_cols].astype(<span class="bu">float</span>).values</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>sns.heatmap(hurdle_matrix, ax<span class="op">=</span>ax,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span>[<span class="st">'|t|&gt;2'</span>, <span class="st">'|t|&gt;3'</span>, <span class="st">'BH'</span>, <span class="st">'Boot'</span>, <span class="st">'OOS sign'</span>, <span class="st">'OOS |t|'</span>],</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>            yticklabels<span class="op">=</span>top25.index,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span>[<span class="st">'#E74C3C'</span>, <span class="st">'#27AE60'</span>],</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            cbar<span class="op">=</span><span class="va">False</span>, linewidths<span class="op">=</span><span class="fl">0.5</span>, linecolor<span class="op">=</span><span class="st">'white'</span>,</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span>np.where(hurdle_matrix <span class="op">==</span> <span class="dv">1</span>, <span class="st">'‚úì'</span>, <span class="st">'‚úó'</span>),</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hurdle count column</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (_, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top25.iterrows()):</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="bu">len</span>(hurdle_cols) <span class="op">+</span> <span class="fl">0.3</span>, i <span class="op">+</span> <span class="fl">0.5</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(row[<span class="st">'n_hurdles'</span>])<span class="sc">}</span><span class="ss">/6"</span>,</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>            fontweight<span class="op">=</span><span class="st">'bold'</span> <span class="cf">if</span> row[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span> <span class="cf">else</span> <span class="st">'normal'</span>,</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#27AE60'</span> <span class="cf">if</span> row[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span> <span class="cf">else</span> <span class="st">'#C0392B'</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Multi-Hurdle Test Results (Top 25 Anomalies)'</span>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-hurdle-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;21.10
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-zoo-implications" class="level2" data-number="21.10">
<h2 data-number="21.10" class="anchored" data-anchor-id="sec-factor-zoo-implications"><span class="header-section-number">21.10</span> Implications for Vietnamese Factor Research</h2>
<p>The analysis in this chapter yields several practical implications:</p>
<p><strong>The conventional threshold is insufficient.</strong> With <span class="math inline">\(M \approx 50\)</span> anomalies tested simultaneously, requiring only <span class="math inline">\(|t| &gt; 2.0\)</span> virtually guarantees false discoveries. Vietnamese researchers should adopt a minimum threshold of <span class="math inline">\(|t| &gt; 3.0\)</span> for individual factors, consistent with <span class="citation" data-cites="harvey2016and">Harvey, Liu, and Zhu (<a href="references.html#ref-harvey2016and" role="doc-biblioref">2016</a>)</span>, and should report BH-adjusted p-values for any study testing multiple signals.</p>
<p><strong>The small cross-section amplifies noise.</strong> With 600-800 stocks, quintile portfolios contain only 120-160 stocks each. This creates noisier portfolio returns and wider confidence intervals than in U.S. studies with 4,000+ stocks. Strategies that appear significant in the U.S. at <span class="math inline">\(|t| = 2.5\)</span> may have <span class="math inline">\(|t| &lt; 1.5\)</span> in Vietnam simply due to the smaller sample. This is not evidence that the factor doesn‚Äôt exist in Vietnam, it is evidence that the Vietnamese data lack power to detect it.</p>
<p><strong>Out-of-sample validation is essential.</strong> The time-series split reveals substantial decay for many anomalies, consistent with <span class="citation" data-cites="mclean2016does">McLean and Pontiff (<a href="references.html#ref-mclean2016does" role="doc-biblioref">2016</a>)</span>. Factors that survive both in-sample and out-of-sample with consistent sign and magnitude are rare and valuable.</p>
<p><strong>Category matters.</strong> Momentum and profitability signals tend to have the highest replication rates across markets <span class="citation" data-cites="fama2012size jacobs2020anomalies">(<a href="references.html#ref-fama2012size" role="doc-biblioref">Fama and French 2012</a>; <a href="references.html#ref-jacobs2020anomalies" role="doc-biblioref">Jacobs and M√ºller 2020</a>)</span>. Value and investment signals are more country-specific <span class="citation" data-cites="griffin2002fama">(<a href="references.html#ref-griffin2002fama" role="doc-biblioref">Griffin 2002</a>)</span>. Liquidity signals are likely to be strongest in emerging markets like Vietnam, where trading frictions are largest.</p>
<p><strong>Report the full battery.</strong> Any study that presents a new factor for the Vietnamese market should report: (i) the raw t-statistic, (ii) the BH-adjusted p-value given the number of tests in the study, (iii) out-of-sample performance in a held-out period, and (iv) sensitivity to construction choices (from the previous chapter). This reporting standard would dramatically improve the credibility of Vietnamese factor research.</p>
</section>
<section id="sec-factor-zoo-summary" class="level2" data-number="21.11">
<h2 data-number="21.11" class="anchored" data-anchor-id="sec-factor-zoo-summary"><span class="header-section-number">21.11</span> Summary</h2>
<div id="tbl-summary" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;21.1: Summary of multiple testing methods and their properties.
</figcaption>
<div aria-describedby="tbl-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Controls</th>
<th>Threshold (approx.)</th>
<th>Surviving</th>
<th>Philosophy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Unadjusted</td>
<td>Single test</td>
<td>|t| &gt; 2.0</td>
<td>Many</td>
<td>No correction</td>
</tr>
<tr class="even">
<td>Bonferroni</td>
<td>FWER</td>
<td>|t| &gt; 3.3‚Äì4.0</td>
<td>Few</td>
<td>Zero false positives</td>
</tr>
<tr class="odd">
<td>Holm</td>
<td>FWER</td>
<td>Stepwise</td>
<td>Few</td>
<td>Slightly less conservative</td>
</tr>
<tr class="even">
<td>BH</td>
<td>FDR at q</td>
<td>Adaptive</td>
<td>Moderate</td>
<td>Tolerates some false positives</td>
</tr>
<tr class="odd">
<td>HLZ</td>
<td>Profession-wide</td>
<td>|t| &gt; 3.0‚Äì3.78</td>
<td>Moderate</td>
<td>Prior over all tested factors</td>
</tr>
<tr class="even">
<td>White/RW Bootstrap</td>
<td>FWER (data-driven)</td>
<td>Bootstrap CV</td>
<td>Few</td>
<td>Accounts for non-normality</td>
</tr>
<tr class="odd">
<td>Storey FDP</td>
<td>FDP estimate</td>
<td>Continuous</td>
<td>Diagnostic</td>
<td>Estimates true null proportion</td>
</tr>
<tr class="even">
<td>Multi-hurdle</td>
<td>Combined</td>
<td>Multiple tests</td>
<td>Most robust</td>
<td>Requires convergent evidence</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The factor zoo is not a uniquely American phenomenon. The temptation to test many signals and report the best-performing ones exists in every market. In Vietnam, where the data are shorter, noisier, and the academic community is growing rapidly, the risk of false discovery is high. The tools developed in this chapter, including BH adjustment, bootstrap reality checks, Storey‚Äôs <span class="math inline">\(\pi_0\)</span> estimation, out-of-sample splits, and the multi-hurdle filter, provide a principled framework for separating genuine factors from statistical noise.</p>
<p>The honest conclusion is likely to be humbling: of the dozens of anomalies documented in developed markets, only a handful survive rigorous multiple testing in Vietnamese data. Those survivors (probably concentrated in momentum, profitability, and liquidity) form the foundation for credible asset pricing research in this market.</p>
<!-- ## Exercises {#sec-factor-zoo-exercises}

1.  **Bayesian approach.** Implement the @harvey2021lucky Bayesian framework for distinguishing lucky factors from genuine ones. Assign a prior probability $\pi$ that any given factor is a true predictor, and compute the posterior probability of being genuine given its t-statistic and the number of tests. How does varying $\pi$ affect which factors survive?

2.  **Dependence-adjusted BH.** The standard BH procedure assumes independent (or PRDS) test statistics. Estimate the correlation structure of factor returns and implement the Benjamini-Yekutieli (BY) procedure, which controls FDR under arbitrary dependence. How many fewer factors survive compared to BH?

3.  **Publication bias simulation.** Simulate a researcher who tests 100 random signals on Vietnamese data, publishes only those with $|t| > 2$, and reports the average published t-statistic. Repeat 1,000 times. What is the distribution of the "published" t-statistic? How does it compare to the true effect size (which is zero by construction)?

4.  **Replication across exchanges.** Test whether factors that are significant on HOSE also replicate on HNX. If the same factor is significant on both exchanges independently, the probability of a false discovery is substantially lower (because the two samples are partially independent).

5.  **Transaction cost hurdle.** For each factor that survives the multi-hurdle filter, compute the minimum round-trip trading cost that would eliminate the net-of-cost premium. Factors whose breakeven costs are below realistic Vietnamese transaction costs are not implementable, regardless of their statistical significance.

6.  **Machine learning feature importance.** Use a random forest or gradient-boosted tree model to predict next-month returns from all available signals simultaneously. Extract feature importance measures. Compare the machine learning ranking of signals to the univariate t-statistic ranking. Do they agree?

7.  **International replication.** Select the top 10 factors from the Vietnamese zoo. Test whether the same factors are significant in Thailand (SET), Indonesia (IDX), or the Philippines (PSE) using equivalent data. Factors that replicate across multiple ASEAN markets are less likely to be country-specific data artifacts.

8.  **Rolling FDP monitoring.** Implement a rolling-window version of the Storey $\pi_0$ estimator. Compute $\hat{\pi}_0$ for each 60-month window. Does the proportion of true factors change over time? An increasing $\pi_0$ (more true nulls) might indicate that anomalies are being arbitraged away as the Vietnamese market matures. -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-benjamini1995controlling" class="csl-entry" role="listitem">
Benjamini, Yoav, and Yosef Hochberg. 1995. <span>‚ÄúControlling the False Discovery Rate: A Practical and Powerful Approach to Multiple Testing.‚Äù</span> <em>Journal of the Royal Statistical Society: Series B (Methodological)</em> 57 (1): 289‚Äì300.
</div>
<div id="ref-bonferroni1936teoria" class="csl-entry" role="listitem">
Bonferroni, Carlo. 1936. <span>‚ÄúTeoria Statistica Delle Classi e Calcolo Delle Probabilita.‚Äù</span> <em>Pubblicazioni Del R Istituto Superiore Di Scienze Economiche e Commericiali Di Firenze</em> 8: 3‚Äì62.
</div>
<div id="ref-chen2022open" class="csl-entry" role="listitem">
Chen, Andrew, and Tom Zimmermann. 2022. <span>‚ÄúOpen Source Cross-Sectional Asset Pricing.‚Äù</span> <em>&gt; Critical Finance Review</em> 11 (02): 207‚Äì64.
</div>
<div id="ref-cochrane2011presidential" class="csl-entry" role="listitem">
Cochrane, John H. 2011. <span>‚ÄúPresidential Address: Discount Rates.‚Äù</span> <em>The Journal of Finance</em> 66 (4): 1047‚Äì1108.
</div>
<div id="ref-fama2012size" class="csl-entry" role="listitem">
Fama, Eugene F, and Kenneth R French. 2012. <span>‚ÄúSize, Value, and Momentum in International Stock Returns.‚Äù</span> <em>Journal of Financial Economics</em> 105 (3): 457‚Äì72.
</div>
<div id="ref-griffin2002fama" class="csl-entry" role="listitem">
Griffin, John M. 2002. <span>‚ÄúAre the Fama and French Factors Global or Country Specific?‚Äù</span> <em>The Review of Financial Studies</em> 15 (3): 783‚Äì803.
</div>
<div id="ref-harvey2016and" class="csl-entry" role="listitem">
Harvey, Campbell R, Yan Liu, and Heqing Zhu. 2016. <span>‚Äú‚Ä¶ and the Cross-Section of Expected Returns.‚Äù</span> <em>The Review of Financial Studies</em> 29 (1): 5‚Äì68.
</div>
<div id="ref-hou2020replicating" class="csl-entry" role="listitem">
Hou, Kewei, Chen Xue, and Lu Zhang. 2020. <span>‚ÄúReplicating Anomalies.‚Äù</span> <em>The Review of Financial Studies</em> 33 (5): 2019‚Äì2133.
</div>
<div id="ref-jacobs2020anomalies" class="csl-entry" role="listitem">
Jacobs, Heiko, and Sebastian M√ºller. 2020. <span>‚ÄúAnomalies Across the Globe: Once Public, No Longer Existent?‚Äù</span> <em>Journal of Financial Economics</em> 135 (1): 213‚Äì30.
</div>
<div id="ref-jensen2023there" class="csl-entry" role="listitem">
Jensen, Theis Ingerslev, Bryan Kelly, and Lasse Heje Pedersen. 2023. <span>‚ÄúIs There a Replication Crisis in Finance?‚Äù</span> <em>The Journal of Finance</em> 78 (5): 2465‚Äì2518.
</div>
<div id="ref-mclean2016does" class="csl-entry" role="listitem">
McLean, R David, and Jeffrey Pontiff. 2016. <span>‚ÄúDoes Academic Research Destroy Stock Return Predictability?‚Äù</span> <em>The Journal of Finance</em> 71 (1): 5‚Äì32.
</div>
<div id="ref-romano2005exact" class="csl-entry" role="listitem">
Romano, Joseph P, and Michael Wolf. 2005. <span>‚ÄúExact and Approximate Stepdown Methods for Multiple Hypothesis Testing.‚Äù</span> <em>Journal of the American Statistical Association</em> 100 (469): 94‚Äì108.
</div>
<div id="ref-storey2003positive" class="csl-entry" role="listitem">
Storey, John D. 2003. <span>‚ÄúThe Positive False Discovery Rate: A Bayesian Interpretation and the q-Value.‚Äù</span> <em>The Annals of Statistics</em> 31 (6): 2013‚Äì35.
</div>
<div id="ref-white2000reality" class="csl-entry" role="listitem">
White, Halbert. 2000. <span>‚ÄúA Reality Check for Data Snooping.‚Äù</span> <em>Econometrica</em> 68 (5): 1097‚Äì1126.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LG91D0C6RB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LG91D0C6RB');
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./24_fama_macbeth.html" class="pagination-link" aria-label="Fama-MacBeth Regressions">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./26_time_series_vs_cross_section.html" class="pagination-link" aria-label="Time-Series vs. Cross-Sectional Factor Tests">
        <span class="nav-page-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Factor Zoo and Multiple Testing</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>In this chapter, we confront the multiple testing problem in empirical asset pricing. We replicate a broad set of published anomalies in the Vietnamese market, apply formal corrections for the number of tests conducted, estimate the proportion of false discoveries, and develop a framework for deciding which factors deserve credence.</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>By 2016, academic finance had documented over 300 variables that purportedly predict the cross-section of stock returns. @cochrane2011presidential memorably called this proliferation a "zoo of factors." @harvey2016and cataloged over 300 published factors and argued that the standard significance threshold of $t &gt; 2.0$ was far too low given the sheer number of hypotheses tested, either explicitly or implicitly, across decades of research. Their proposed threshold of $t &gt; 3.0$ (and in some cases $t &gt; 3.78$) would eliminate the majority of published anomalies.</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>The problem is not merely academic. Every researcher who sorts stocks on a new variable and finds $t &gt; 2$ is implicitly testing a hypothesis that has already been tested hundreds of times with different variables. The probability that *at least one* of 300 independent tests produces $t &gt; 2$ by chance (even when no true effect exists) is essentially 1.0. This is the multiple testing problem, and failing to account for it means that a substantial fraction of the "factor zoo" consists of false discoveries.</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>For Vietnamese equity research, the problem is arguably worse. The cross-section is smaller (600-800 stocks vs. 4,000+ in the U.S.), the time series is shorter (2008- vs. 1963-), and the data are noisier (illiquidity, zero-trading days, accounting irregularities). All of these amplify the risk of both Type I errors (finding something that isn't there) and Type II errors (missing something that is). This chapter provides the statistical tools to navigate this landscape rigorously.</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Scale of the Problem {#sec-factor-zoo-scale}</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### How Many Factors Exist?</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>@harvey2016and counted over 300 factors published in top journals through 2012. @chen2022open constructed and made publicly available over 300 "clearly significant" anomalies from the U.S. literature. @hou2020replicating attempted to replicate 452 anomalies and found that 64% (with VW returns) failed to achieve $t &gt; 1.96$ in their sample. @jensen2023there took a more optimistic view, finding that most factors replicate in direction if not always in magnitude.</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>The key insight is that the number of factors *tested* far exceeds the number *published*. For every published factor with $t &gt; 2$, there may be dozens of unpublished tests with $t &lt; 2$ that never saw print, which is the classic file drawer problem. The true number of tests conducted collectively by the profession is unknowable, but certainly in the thousands.</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure environment"</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.stats.multitest <span class="im">import</span> multipletests</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-load</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load returns and characteristics panel"</span></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (survivorship-bias-free)</span></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>, <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span>,</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_zero_volume_days'</span></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre-computed characteristic panel (from factor construction chapter)</span></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a>characteristics <span class="op">=</span> client.get_characteristics_panel(</span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Factor returns for spanning tests</span></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>factors_ff <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'rmw'</span>, <span class="st">'cma'</span>, <span class="st">'wml'</span>]</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a>monthly[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(monthly[<span class="st">'month_end'</span>])</span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Characteristics: </span><span class="sc">{</span>characteristics<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available signals: </span><span class="sc">{</span>[c <span class="cf">for</span> c <span class="kw">in</span> characteristics.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'ticker'</span>, <span class="st">'month_end'</span>]]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="fu">## Building the Anomaly Zoo {#sec-factor-zoo-zoo}</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="fu">### Signal Definitions</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>We construct a comprehensive set of anomaly variables spanning the major categories from the literature. Each signal is lagged appropriately to avoid look-ahead bias (accounting signals use point-in-time alignment; price signals use the prior month's value).</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: signal-construction</span></span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Construct the full set of anomaly signals"</span></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge returns with characteristics</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> monthly.merge(characteristics, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 1: VALUE (8 signals)</span></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Already in characteristics panel from PIT merge:</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a><span class="co"># bm, ep, cfp, sp, dp, ev_ebitda</span></span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Add earnings yield variants</span></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>value_signals <span class="op">=</span> [<span class="st">'bm'</span>, <span class="st">'ep'</span>, <span class="st">'cfp'</span>, <span class="st">'sp'</span>, <span class="st">'dp'</span>]</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 2: SIZE (3 signals)</span></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'market_cap'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(panel[<span class="st">'total_assets'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_revenue'</span>] <span class="op">=</span> np.log(panel[<span class="st">'revenue'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>size_signals <span class="op">=</span> [<span class="st">'log_mcap'</span>, <span class="st">'log_assets'</span>, <span class="st">'log_revenue'</span>]</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 3: PROFITABILITY (8 signals)</span></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="co"># GP/A (Novy-Marx 2013), OP (FF 2015), ROE, ROA, etc.</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>prof_signals <span class="op">=</span> [<span class="st">'gp_at'</span>, <span class="st">'op'</span>, <span class="st">'roe'</span>, <span class="st">'roa'</span>, <span class="st">'profit_margin'</span>,</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'asset_turnover'</span>, <span class="st">'gross_margin'</span>, <span class="st">'oper_margin'</span>]</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 4: INVESTMENT / GROWTH (6 signals)</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>inv_signals <span class="op">=</span> [<span class="st">'asset_growth'</span>, <span class="st">'capex_at'</span>, <span class="st">'investment'</span>,</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>                <span class="st">'sales_growth'</span>, <span class="st">'equity_issuance'</span>, <span class="st">'debt_issuance'</span>]</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 5: MOMENTUM / REVERSAL (6 signals)</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute from returns</span></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag_start, lag_end, name <span class="kw">in</span> [</span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">12</span>, <span class="st">'ret_12_2'</span>), (<span class="dv">2</span>, <span class="dv">6</span>, <span class="st">'ret_6_2'</span>), (<span class="dv">7</span>, <span class="dv">12</span>, <span class="st">'ret_12_7'</span>),</span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">1</span>, <span class="st">'ret_1'</span>), (<span class="dv">1</span>, <span class="dv">3</span>, <span class="st">'ret_3_1'</span>)</span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> name <span class="kw">not</span> <span class="kw">in</span> panel.columns:</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a>        panel[name] <span class="op">=</span> (</span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>            panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.shift(lag_start).rolling(lag_end <span class="op">-</span> lag_start <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>                       .<span class="bu">apply</span>(<span class="kw">lambda</span> r: (<span class="dv">1</span> <span class="op">+</span> r).prod() <span class="op">-</span> <span class="dv">1</span>, raw<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a><span class="co"># Earnings momentum (SUE) should already be in characteristics</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>mom_signals <span class="op">=</span> [<span class="st">'ret_12_2'</span>, <span class="st">'ret_6_2'</span>, <span class="st">'ret_12_7'</span>, <span class="st">'ret_1'</span>, <span class="st">'ret_3_1'</span>, <span class="st">'sue'</span>]</span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 6: RISK (5 signals)</span></span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>risk_signals <span class="op">=</span> [<span class="st">'beta'</span>, <span class="st">'ivol'</span>, <span class="st">'tvol'</span>, <span class="st">'max_ret'</span>, <span class="st">'skewness'</span>]</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 7: LIQUIDITY / TRADING (6 signals)</span></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>liq_signals <span class="op">=</span> [<span class="st">'amihud'</span>, <span class="st">'zero_return_pct'</span>, <span class="st">'log_turnover'</span>,</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a>                <span class="st">'roll_spread'</span>, <span class="st">'cs_spread'</span>, <span class="st">'volume_cv'</span>]</span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 8: QUALITY / FINANCIAL HEALTH (5 signals)</span></span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a>qual_signals <span class="op">=</span> [<span class="st">'leverage'</span>, <span class="st">'current_ratio'</span>, <span class="st">'accruals'</span>,</span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'earnings_variability'</span>, <span class="st">'piotroski_f'</span>]</span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a><span class="co"># Category 9: DIVIDEND / PAYOUT (3 signals)</span></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a>div_signals <span class="op">=</span> [<span class="st">'div_yield'</span>, <span class="st">'payout_ratio'</span>, <span class="st">'net_repurchase'</span>]</span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all</span></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>all_signals <span class="op">=</span> (value_signals <span class="op">+</span> size_signals <span class="op">+</span> prof_signals <span class="op">+</span></span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>               inv_signals <span class="op">+</span> mom_signals <span class="op">+</span> risk_signals <span class="op">+</span></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>               liq_signals <span class="op">+</span> qual_signals <span class="op">+</span> div_signals)</span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove signals with too little coverage</span></span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a>signal_coverage <span class="op">=</span> {}</span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> all_signals:</span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> sig <span class="kw">in</span> panel.columns:</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a>        cov <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a>        signal_coverage[sig] <span class="op">=</span> cov</span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a>signal_coverage <span class="op">=</span> pd.Series(signal_coverage).sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>valid_signals <span class="op">=</span> signal_coverage[signal_coverage <span class="op">&gt;</span> <span class="fl">0.30</span>].index.tolist()</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total signals defined: </span><span class="sc">{</span><span class="bu">len</span>(all_signals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Signals with &gt;30% coverage: </span><span class="sc">{</span><span class="bu">len</span>(valid_signals)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Signal categories:"</span>)</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat_name, sigs <span class="kw">in</span> [</span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Value'</span>, value_signals), (<span class="st">'Size'</span>, size_signals),</span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Profitability'</span>, prof_signals), (<span class="st">'Investment'</span>, inv_signals),</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Momentum'</span>, mom_signals), (<span class="st">'Risk'</span>, risk_signals),</span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Liquidity'</span>, liq_signals), (<span class="st">'Quality'</span>, qual_signals),</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Dividend'</span>, div_signals)</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>    n_valid <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> s <span class="kw">in</span> sigs <span class="cf">if</span> s <span class="kw">in</span> valid_signals)</span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>cat_name<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>n_valid<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span><span class="bu">len</span>(sigs)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a><span class="fu">### Mass Factor Construction</span></span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a>We run the factor construction engine (from the previous chapter) across all valid signals to produce a "zoo" of factor returns:</span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: mass-construction</span></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Construct long-short portfolios for every valid signal"</span></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the factor engine from previous chapter</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="co"># (In practice, this would be imported from a shared module)</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_factor_simple(panel_df, signal_col, long_high<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>                              n_groups<span class="op">=</span><span class="dv">5</span>, weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>                              min_stocks<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a><span class="co">    Simplified factor construction: quintile sort on signal,</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a><span class="co">    long-short = Q5 - Q1 (or reversed if long_high=False).</span></span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a Series of monthly long-short returns.</span></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> panel_df[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>,</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>                    <span class="st">'market_cap'</span>, signal_col]].dropna().copy()</span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the signal by one month</span></span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'signal_lag'</span>] <span class="op">=</span> df.groupby(<span class="st">'ticker'</span>)[signal_col].shift(<span class="dv">1</span>)</span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">'signal_lag'</span>, <span class="st">'monthly_return'</span>])</span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month, group <span class="kw">in</span> df.groupby(<span class="st">'month_end'</span>):</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> min_stocks:</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'quintile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>            group[<span class="st">'signal_lag'</span>].rank(method<span class="op">=</span><span class="st">'first'</span>),</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a>            n_groups, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span></span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weighting <span class="op">==</span> <span class="st">'value'</span>:</span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>            <span class="kw">def</span> wret(g):</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> np.average(g[<span class="st">'monthly_return'</span>],</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a>                                       weights<span class="op">=</span>g[<span class="st">'market_cap'</span>])</span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> g[<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> group.groupby(<span class="st">'quintile'</span>).<span class="bu">apply</span>(wret)</span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a>            port_ret <span class="op">=</span> group.groupby(<span class="st">'quintile'</span>)[<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="dv">0</span> <span class="kw">in</span> port_ret.index <span class="kw">and</span> (n_groups <span class="op">-</span> <span class="dv">1</span>) <span class="kw">in</span> port_ret.index:</span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> long_high:</span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>                ls <span class="op">=</span> port_ret[n_groups <span class="op">-</span> <span class="dv">1</span>] <span class="op">-</span> port_ret[<span class="dv">0</span>]</span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>                ls <span class="op">=</span> port_ret[<span class="dv">0</span>] <span class="op">-</span> port_ret[n_groups <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>            results.append({<span class="st">'month_end'</span>: month, <span class="st">'ls_return'</span>: ls})</span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> results:</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results).set_index(<span class="st">'month_end'</span>)[<span class="st">'ls_return'</span>]</span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine expected sign for each signal</span></span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a><span class="co"># (positive = high signal predicts high returns)</span></span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>signal_directions <span class="op">=</span> {</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Value: high = higher returns</span></span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bm'</span>: <span class="va">True</span>, <span class="st">'ep'</span>: <span class="va">True</span>, <span class="st">'cfp'</span>: <span class="va">True</span>, <span class="st">'sp'</span>: <span class="va">True</span>, <span class="st">'dp'</span>: <span class="va">True</span>,</span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Size: small = higher returns (low signal = high returns)</span></span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_mcap'</span>: <span class="va">False</span>, <span class="st">'log_assets'</span>: <span class="va">False</span>, <span class="st">'log_revenue'</span>: <span class="va">False</span>,</span>
<span id="cb24-272"><a href="#cb24-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Profitability: high = higher returns</span></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gp_at'</span>: <span class="va">True</span>, <span class="st">'op'</span>: <span class="va">True</span>, <span class="st">'roe'</span>: <span class="va">True</span>, <span class="st">'roa'</span>: <span class="va">True</span>,</span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a>    <span class="st">'profit_margin'</span>: <span class="va">True</span>, <span class="st">'asset_turnover'</span>: <span class="va">True</span>,</span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a>    <span class="st">'gross_margin'</span>: <span class="va">True</span>, <span class="st">'oper_margin'</span>: <span class="va">True</span>,</span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Investment: low growth = higher returns</span></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>    <span class="st">'asset_growth'</span>: <span class="va">False</span>, <span class="st">'capex_at'</span>: <span class="va">False</span>, <span class="st">'investment'</span>: <span class="va">False</span>,</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a>    <span class="st">'sales_growth'</span>: <span class="va">False</span>, <span class="st">'equity_issuance'</span>: <span class="va">False</span>,</span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a>    <span class="st">'debt_issuance'</span>: <span class="va">False</span>,</span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Momentum: high = higher returns (except reversal)</span></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret_12_2'</span>: <span class="va">True</span>, <span class="st">'ret_6_2'</span>: <span class="va">True</span>, <span class="st">'ret_12_7'</span>: <span class="va">True</span>,</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ret_1'</span>: <span class="va">False</span>, <span class="st">'ret_3_1'</span>: <span class="va">False</span>, <span class="st">'sue'</span>: <span class="va">True</span>,</span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Risk: low risk = higher returns (anomaly direction)</span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a>    <span class="st">'beta'</span>: <span class="va">False</span>, <span class="st">'ivol'</span>: <span class="va">False</span>, <span class="st">'tvol'</span>: <span class="va">False</span>,</span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a>    <span class="st">'max_ret'</span>: <span class="va">False</span>, <span class="st">'skewness'</span>: <span class="va">False</span>,</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Liquidity: illiquid = higher returns</span></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>    <span class="st">'amihud'</span>: <span class="va">True</span>, <span class="st">'zero_return_pct'</span>: <span class="va">True</span>,</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a>    <span class="st">'log_turnover'</span>: <span class="va">False</span>, <span class="st">'roll_spread'</span>: <span class="va">True</span>,</span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>    <span class="st">'cs_spread'</span>: <span class="va">True</span>, <span class="st">'volume_cv'</span>: <span class="va">True</span>,</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quality: high quality = higher returns</span></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a>    <span class="st">'leverage'</span>: <span class="va">False</span>, <span class="st">'current_ratio'</span>: <span class="va">True</span>, <span class="st">'accruals'</span>: <span class="va">False</span>,</span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a>    <span class="st">'earnings_variability'</span>: <span class="va">False</span>, <span class="st">'piotroski_f'</span>: <span class="va">True</span>,</span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Dividend: high = higher returns</span></span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>    <span class="st">'div_yield'</span>: <span class="va">True</span>, <span class="st">'payout_ratio'</span>: <span class="va">True</span>, <span class="st">'net_repurchase'</span>: <span class="va">False</span>,</span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct all factors</span></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a>zoo_results <span class="op">=</span> {}</span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> valid_signals:</span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a>    long_high <span class="op">=</span> signal_directions.get(sig, <span class="va">True</span>)</span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> construct_factor_simple(</span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a>        panel, sig, long_high<span class="op">=</span>long_high,</span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a>        n_groups<span class="op">=</span><span class="dv">5</span>, weighting<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ls <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="bu">len</span>(ls) <span class="op">&gt;=</span> <span class="dv">60</span>:</span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> ls.mean()</span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> ls.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(ls))</span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a>        t <span class="op">=</span> mean_ret <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>        zoo_results[sig] <span class="op">=</span> {</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>            <span class="st">'mean_monthly'</span>: mean_ret,</span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ann_return'</span>: mean_ret <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ann_vol'</span>: ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>),</span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>            <span class="st">'sharpe'</span>: mean_ret <span class="op">/</span> ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ls.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t_stat'</span>: t,</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a>            <span class="st">'abs_t'</span>: <span class="bu">abs</span>(t),</span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a>            <span class="st">'p_value'</span>: <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t), df<span class="op">=</span><span class="bu">len</span>(ls) <span class="op">-</span> <span class="dv">1</span>)),</span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_months'</span>: <span class="bu">len</span>(ls),</span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a>            <span class="st">'direction'</span>: <span class="st">'Long High'</span> <span class="cf">if</span> long_high <span class="cf">else</span> <span class="st">'Long Low'</span>,</span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a>            <span class="st">'category'</span>: <span class="bu">next</span>(</span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>                (cat <span class="cf">for</span> cat, sigs <span class="kw">in</span> [</span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Value'</span>, value_signals), (<span class="st">'Size'</span>, size_signals),</span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Profitability'</span>, prof_signals),</span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Investment'</span>, inv_signals),</span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Momentum'</span>, mom_signals), (<span class="st">'Risk'</span>, risk_signals),</span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Liquidity'</span>, liq_signals),</span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Quality'</span>, qual_signals),</span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>                    (<span class="st">'Dividend'</span>, div_signals)</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a>                ] <span class="cf">if</span> sig <span class="kw">in</span> sigs), <span class="st">'Other'</span></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>            <span class="st">'returns'</span>: ls  <span class="co"># Store for later use</span></span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>zoo_df <span class="op">=</span> pd.DataFrame({k: {kk: vv <span class="cf">for</span> kk, vv <span class="kw">in</span> v.items() <span class="cf">if</span> kk <span class="op">!=</span> <span class="st">'returns'</span>}</span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a>                         <span class="cf">for</span> k, v <span class="kw">in</span> zoo_results.items()}).T</span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>zoo_df <span class="op">=</span> zoo_df.sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors successfully constructed: </span><span class="sc">{</span><span class="bu">len</span>(zoo_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with |t| &gt; 2.0: </span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with |t| &gt; 3.0: </span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>(zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>)<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">)"</span>)</span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-t-stat-distribution</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of t-statistics across all tested anomalies in the Vietnamese market. Panel A shows the histogram with conventional (|t| &gt; 1.96) and Harvey-Liu-Zhu (|t| &gt; 3.0) thresholds. Panel B ranks anomalies by absolute t-statistic with color-coding by category. A substantial fraction of anomalies with |t| &gt; 2 may be false discoveries given the number of simultaneous tests."</span></span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize the distribution of t-statistics across all anomalies"</span></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">6</span>))</span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Histogram</span></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>t_vals <span class="op">=</span> zoo_df[<span class="st">'t_stat'</span>].values</span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(t_vals, bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a>             edgecolor<span class="op">=</span><span class="st">'white'</span>, density<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Overlay normal distribution under null</span></span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a>x_range <span class="op">=</span> np.linspace(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dv">200</span>)</span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(x_range, stats.norm.pdf(x_range), <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'N(0,1) null'</span>)</span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a><span class="co"># Threshold lines</span></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'|t| = 1.96'</span>)</span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=-</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>,</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'|t| = 3.0 (HLZ)'</span>)</span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=-</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'t-statistic'</span>)</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: t-Statistic Distribution'</span>)</span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Ranked bar chart</span></span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a>top_n <span class="op">=</span> <span class="bu">min</span>(<span class="dv">40</span>, <span class="bu">len</span>(zoo_df))</span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a>top <span class="op">=</span> zoo_df.head(top_n).copy()</span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a>category_colors <span class="op">=</span> {</span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'Size'</span>: <span class="st">'#1ABC9C'</span>, <span class="st">'Profitability'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Investment'</span>: <span class="st">'#E67E22'</span>, <span class="st">'Momentum'</span>: <span class="st">'#C0392B'</span>, <span class="st">'Risk'</span>: <span class="st">'#8E44AD'</span>,</span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Liquidity'</span>: <span class="st">'#3498DB'</span>, <span class="st">'Quality'</span>: <span class="st">'#F1C40F'</span>, <span class="st">'Dividend'</span>: <span class="st">'#95A5A6'</span></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>bar_colors <span class="op">=</span> [category_colors.get(top.iloc[i][<span class="st">'category'</span>], <span class="st">'#BDC3C7'</span>)</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>              <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(top))]</span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].barh(<span class="bu">range</span>(top_n), top[<span class="st">'abs_t'</span>].values,</span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span>bar_colors, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(top_n))</span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels(top.index, fontsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="fl">1.96</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'|t-statistic|'</span>)</span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Anomalies Ranked by |t|'</span>)</span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].invert_yaxis()</span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a><span class="co"># Legend for categories</span></span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Patch</span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>legend_elements <span class="op">=</span> [Patch(facecolor<span class="op">=</span>c, label<span class="op">=</span>cat)</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> cat, c <span class="kw">in</span> category_colors.items()]</span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(handles<span class="op">=</span>legend_elements, fontsize<span class="op">=</span><span class="dv">7</span>,</span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>                loc<span class="op">=</span><span class="st">'lower right'</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Multiple Testing Problem {#sec-factor-zoo-multiple-testing}</span></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Single-Test p-Values Are Misleading</span></span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a>Suppose you test $M$ independent hypotheses, each at significance level $\alpha = 0.05$. Under the global null (no true effects), the expected number of false rejections is $M \times \alpha$. For $M = 50$ anomalies, you expect 2.5 "significant" results by pure chance.</span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a>The probability of *at least one* false rejection is:</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a>P(\text{at least one false discovery}) = 1 - (1 - \alpha)^M</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a>$$ {#eq-family-error}</span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a>For $M = 50$ and $\alpha = 0.05$, this is $1 - 0.95^{50} = 0.923$. For $M = 300$, it is essentially 1. The single-test p-value is useless for deciding which of many tested factors are genuine.</span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="fu">### Two Error Rate Concepts</span></span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a>Multiple testing corrections control one of two error rates:</span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>**Family-Wise Error Rate (FWER).** The probability of making *at least one* Type I error across all tests. This is the most conservative criterion. If FWER = 0.05, you can be 95% confident that *every* rejected null is a true discovery. Methods: @bonferroni1936teoria correction, Holm step-down, @romano2005exact.</span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a>**False Discovery Rate (FDR).** The expected *proportion* of rejected hypotheses that are false. This is less conservative. If FDR = 0.05, you expect that 5% of your discoveries are false, but the other 95% are real. Methods: @benjamini1995controlling (BH), @storey2003positive.</span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a>In asset pricing, FDR control is generally more appropriate than FWER because we are not trying to guarantee zero false discoveries, we are trying to identify a set of factors where *most* are genuine. A researcher who controls FDR at 5% and discovers 10 factors expects approximately 0.5 of them to be false, which is acceptable for building a factor model.</span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-error-rates</span></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Illustration of FWER and FDR concepts. As the number of tests grows, the probability of at least one false discovery (FWER) approaches 1 rapidly unless the per-test threshold is adjusted. The FDR‚Äîthe expected proportion of false discoveries among rejections‚Äîis a less stringent but more practical criterion for factor selection."</span></span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize how error rates scale with number of tests"</span></span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>M_range <span class="op">=</span> np.arange(<span class="dv">1</span>, <span class="dv">301</span>)</span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>fwer_unadj <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">**</span> M_range</span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>fwer_bonf <span class="op">=</span> np.minimum(<span class="dv">1</span>, M_range <span class="op">*</span> alpha)  <span class="co"># Not actual FWER, just threshold</span></span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected false discoveries at alpha = 0.05</span></span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>expected_false <span class="op">=</span> M_range <span class="op">*</span> alpha</span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(M_range, fwer_unadj, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a>             label<span class="op">=</span><span class="st">'Unadjusted FWER'</span>)</span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="fl">0.05</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Œ± = 0.05 target'</span>)</span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Number of Tests (M)'</span>)</span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'P(‚â•1 False Discovery)'</span>)</span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Family-Wise Error Rate'</span>)</span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(M_range, expected_false, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Number of Tests (M)'</span>)</span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Expected False Discoveries'</span>)</span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Expected False Discoveries at Œ± = 0.05'</span>)</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].text(<span class="dv">250</span>, <span class="fl">1.5</span>, <span class="st">'1 false discovery'</span>, color<span class="op">=</span><span class="st">'gray'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a><span class="fu">## Correction Methods {#sec-factor-zoo-corrections}</span></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bonferroni Correction (FWER Control)</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a>The simplest and most conservative correction: reject hypothesis $i$ only if its p-value is below $\alpha / M$, where $M$ is the total number of tests:</span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>\text{Reject } H_{0,i} \text{ if } p_i &lt; \frac{\alpha}{M}</span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>$$ {#eq-bonferroni}</span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a>This controls FWER at $\alpha$ regardless of the dependence structure among tests. The cost is severe loss of power: for $M = 50$ tests at $\alpha = 0.05$, the per-test threshold becomes $0.001$, requiring $|t| &gt; 3.29$.</span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bonferroni</span></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Apply Bonferroni correction to the anomaly zoo"</span></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> <span class="bu">len</span>(zoo_df)</span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a><span class="co"># Bonferroni threshold</span></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a>bonf_threshold <span class="op">=</span> alpha <span class="op">/</span> M</span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a>bonf_t_threshold <span class="op">=</span> stats.norm.ppf(<span class="dv">1</span> <span class="op">-</span> bonf_threshold <span class="op">/</span> <span class="dv">2</span>)</span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bonf_reject'</span>] <span class="op">=</span> zoo_df[<span class="st">'p_value'</span>] <span class="op">&lt;</span> bonf_threshold</span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of tests: </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Bonferroni p-value threshold: </span><span class="sc">{</span>bonf_threshold<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equivalent t-statistic threshold: </span><span class="sc">{</span>bonf_t_threshold<span class="sc">:.2f}</span><span class="ss">"</span>)</span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rejections: </span><span class="sc">{</span>zoo_df[<span class="st">'bonf_reject'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Surviving anomalies:"</span>)</span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'bonf_reject'</span>]]</span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'category'</span>]].to_string())</span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  None survive Bonferroni correction"</span>)</span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="fu">### Holm Step-Down Procedure (FWER Control)</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a>The Holm procedure is uniformly more powerful than Bonferroni while still controlling FWER. It ranks p-values from smallest to largest and applies progressively less stringent thresholds:</span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Sort p-values: $p_{(1)} \leq p_{(2)} \leq \ldots \leq p_{(M)}$</span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>For $i = 1, 2, \ldots$, reject $H_{0,(i)}$ if $p_{(i)} &lt; \alpha / (M - i + 1)$</span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Stop at the first $i$ where $H_{0,(i)}$ is not rejected</span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: holm</span></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Apply the Holm step-down procedure"</span></span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>p_values <span class="op">=</span> zoo_df[<span class="st">'p_value'</span>].values</span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>signal_names <span class="op">=</span> zoo_df.index.values</span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a><span class="co"># Using statsmodels implementation</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>reject_holm, pvals_corrected_holm, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.05</span>, method<span class="op">=</span><span class="st">'holm'</span></span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'holm_reject'</span>] <span class="op">=</span> reject_holm</span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'holm_p_corrected'</span>] <span class="op">=</span> pvals_corrected_holm</span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holm rejections: </span><span class="sc">{</span>reject_holm<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a>holm_survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'holm_reject'</span>]]</span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(holm_survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Surviving anomalies (Holm):"</span>)</span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(holm_survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'holm_p_corrected'</span>,</span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'category'</span>]].to_string())</span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a><span class="fu">### Benjamini-Hochberg Procedure (FDR Control)</span></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a>The @benjamini1995controlling (BH) procedure controls the False Discovery Rate (i.e., the expected proportion of rejections that are false) at level $q$:</span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Sort p-values: $p_{(1)} \leq p_{(2)} \leq \ldots \leq p_{(M)}$</span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>Find the largest $k$ such that $p_{(k)} \leq \frac{k}{M} q$</span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>Reject all $H_{0,(i)}$ for $i = 1, \ldots, k$</span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a>The BH procedure is valid under independence or positive dependence (PRDS), a condition that is generally satisfied for financial factor tests where factors tend to be positively correlated under the null.</span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bh-fdr</span></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Apply the Benjamini-Hochberg FDR procedure"</span></span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a><span class="co"># BH procedure at q = 0.05 (expect 5% false discoveries)</span></span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a>reject_bh, pvals_corrected_bh, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.05</span>, method<span class="op">=</span><span class="st">'fdr_bh'</span></span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh_reject'</span>] <span class="op">=</span> reject_bh</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh_p_corrected'</span>] <span class="op">=</span> pvals_corrected_bh</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a><span class="co"># Also at q = 0.10 (more liberal)</span></span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>reject_bh10, _, _, _ <span class="op">=</span> multipletests(</span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>    p_values, alpha<span class="op">=</span><span class="fl">0.10</span>, method<span class="op">=</span><span class="st">'fdr_bh'</span></span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a>zoo_df[<span class="st">'bh10_reject'</span>] <span class="op">=</span> reject_bh10</span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"BH rejections (q=0.05): </span><span class="sc">{</span>reject_bh<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"BH rejections (q=0.10): </span><span class="sc">{</span>reject_bh10<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span>M<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a>bh_survivors <span class="op">=</span> zoo_df[zoo_df[<span class="st">'bh_reject'</span>]].sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(bh_survivors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Surviving anomalies (BH, q=0.05):"</span>)</span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(bh_survivors[[<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'bh_p_corrected'</span>,</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a>                          <span class="st">'category'</span>]].head(<span class="dv">20</span>).to_string())</span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-bh-procedure</span></span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Visual representation of the Benjamini-Hochberg procedure. Sorted p-values are compared to the BH threshold line (slope = q/M). All p-values below the line up to the largest crossing point are rejected. The procedure is less conservative than Bonferroni because later thresholds are progressively more lenient."</span></span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot the BH procedure graphically"</span></span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a>sorted_pvals <span class="op">=</span> np.sort(p_values)</span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a>k <span class="op">=</span> np.arange(<span class="dv">1</span>, M <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a>bh_line_05 <span class="op">=</span> k <span class="op">/</span> M <span class="op">*</span> <span class="fl">0.05</span></span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a>bh_line_10 <span class="op">=</span> k <span class="op">/</span> M <span class="op">*</span> <span class="fl">0.10</span></span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a>ax.scatter(k, sorted_pvals, s<span class="op">=</span><span class="dv">15</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="st">'Sorted p-values'</span>, zorder<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a>ax.plot(k, bh_line_05, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">'BH line (q=0.05)'</span>)</span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a>ax.plot(k, bh_line_10, color<span class="op">=</span><span class="st">'#E67E22'</span>, linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a>        linestyle<span class="op">=</span><span class="st">'--'</span>, label<span class="op">=</span><span class="st">'BH line (q=0.10)'</span>)</span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight rejections</span></span>
<span id="cb24-605"><a href="#cb24-605" aria-hidden="true" tabindex="-1"></a>n_reject_05 <span class="op">=</span> reject_bh.<span class="bu">sum</span>()</span>
<span id="cb24-606"><a href="#cb24-606" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> n_reject_05 <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a>    ax.scatter(k[:n_reject_05], sorted_pvals[:n_reject_05],</span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a>               s<span class="op">=</span><span class="dv">40</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>, zorder<span class="op">=</span><span class="dv">4</span>, label<span class="op">=</span><span class="ss">f'Rejected (q=0.05)'</span>)</span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Rank (k)'</span>)</span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'p-value'</span>)</span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Benjamini-Hochberg Procedure'</span>)</span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="op">-</span><span class="fl">0.01</span>, <span class="fl">0.15</span>])</span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a>ax.set_xlim([<span class="dv">0</span>, <span class="bu">min</span>(M, <span class="dv">60</span>)])</span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Harvey-Liu-Zhu Threshold</span></span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a>@harvey2016and take a different approach: rather than applying a formal multiple-testing correction to a specific set of tests, they estimate the hurdle t-statistic that accounts for the *cumulative* number of factors tested by the entire profession. Using a Bayesian framework calibrated to the 316 published factors, they derive:</span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>For a single new factor tested in isolation: $|t| &gt; 2.0$ (conventional)</span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Accounting for 100 prior tests: $|t| &gt; 2.8$</span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Accounting for 316 prior tests: $|t| &gt; 3.0$</span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Accounting for all conceivable tests: $|t| &gt; 3.78$</span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a>The logic is that even if *your* study tests only one factor, the fact that hundreds of researchers have tested hundreds of signals before you means the prior probability that your specific signal is a true predictor is low.</span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: hlz-threshold</span></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Apply the Harvey-Liu-Zhu t-statistic thresholds"</span></span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a>hlz_thresholds <span class="op">=</span> {</span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Conventional (|t| &gt; 2.0)'</span>: <span class="fl">2.0</span>,</span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ 100 tests (|t| &gt; 2.8)'</span>: <span class="fl">2.8</span>,</span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ 316 tests (|t| &gt; 3.0)'</span>: <span class="fl">3.0</span>,</span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ conservative (|t| &gt; 3.78)'</span>: <span class="fl">3.78</span></span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Anomalies Surviving Different t-Thresholds:"</span>)</span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Threshold'</span><span class="sc">:&lt;35}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Surviving'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'</span><span class="sc">% o</span><span class="st">f Zoo'</span><span class="sc">:&gt;10}</span><span class="ss">"</span>)</span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">55</span>)</span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, thresh <span class="kw">in</span> hlz_thresholds.items():</span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a>    n_survive <span class="op">=</span> (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> thresh).<span class="bu">sum</span>()</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> n_survive <span class="op">/</span> <span class="bu">len</span>(zoo_df) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;35}</span><span class="ss"> </span><span class="sc">{</span>n_survive<span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span>pct<span class="sc">:&gt;10.1f}</span><span class="ss">%"</span>)</span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison of Methods {#sec-factor-zoo-comparison}</span></span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-correction-comparison</span></span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of anomalies surviving each multiple testing correction. Bonferroni and Holm (FWER control) are the most conservative, while BH (FDR control) retains more discoveries. The HLZ threshold of |t| &gt; 3.0 falls between the two. The gap between BH and Bonferroni represents anomalies that are likely real (low FDR) but cannot be guaranteed individually (FWER not controlled)."</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare all correction methods side by side"</span></span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> {</span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Unadjusted (|t| &gt; 2)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span>).<span class="bu">sum</span>(),</span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Bonferroni'</span>: zoo_df[<span class="st">'bonf_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Holm'</span>: zoo_df[<span class="st">'holm_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BH (q=0.05)'</span>: zoo_df[<span class="st">'bh_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BH (q=0.10)'</span>: zoo_df[<span class="st">'bh10_reject'</span>].<span class="bu">sum</span>(),</span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ (|t| &gt; 3.0)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span>).<span class="bu">sum</span>(),</span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HLZ (|t| &gt; 3.78)'</span>: (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.78</span>).<span class="bu">sum</span>(),</span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a>names <span class="op">=</span> <span class="bu">list</span>(comparison.keys())</span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> <span class="bu">list</span>(comparison.values())</span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">'#BDC3C7'</span>, <span class="st">'#C0392B'</span>, <span class="st">'#E74C3C'</span>, <span class="st">'#27AE60'</span>, <span class="st">'#2ECC71'</span>,</span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a>          <span class="st">'#2C5F8A'</span>, <span class="st">'#1A3C5A'</span>]</span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> ax.barh(<span class="bu">range</span>(<span class="bu">len</span>(names)), counts, color<span class="op">=</span>colors,</span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a>               alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(names)))</span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(names)</span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Number of Surviving Anomalies'</span>)</span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomalies Surviving Multiple Testing Corrections'</span>)</span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, count) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(names, counts)):</span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a>    ax.text(count <span class="op">+</span> <span class="fl">0.3</span>, i, <span class="bu">str</span>(count), va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a>ax.invert_yaxis()</span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-survival-by-category</span></span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Anomaly survival rates by category under the BH procedure (q=0.05). Categories with high survival rates (e.g., momentum, profitability) contain more robust signals. Categories with low survival rates may contain predominantly spurious associations. The total height of each bar shows the number of anomalies tested in that category."</span></span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot survival rates by anomaly category"</span></span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a>cat_survival <span class="op">=</span> (</span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a>    zoo_df.groupby(<span class="st">'category'</span>)</span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a>        n_total<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="st">'count'</span>),</span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a>        n_survive_bh<span class="op">=</span>(<span class="st">'bh_reject'</span>, <span class="st">'sum'</span>),</span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>        n_survive_hlz<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="fl">3.0</span>).<span class="bu">sum</span>()),</span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a>        mean_abs_t<span class="op">=</span>(<span class="st">'abs_t'</span>, <span class="st">'mean'</span>)</span>
<span id="cb24-710"><a href="#cb24-710" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-711"><a href="#cb24-711" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'mean_abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a>cat_survival[<span class="st">'survival_rate_bh'</span>] <span class="op">=</span> (</span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a>    cat_survival[<span class="st">'n_survive_bh'</span>] <span class="op">/</span> cat_survival[<span class="st">'n_total'</span>]</span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(cat_survival))</span>
<span id="cb24-720"><a href="#cb24-720" aria-hidden="true" tabindex="-1"></a>ax.bar(x, cat_survival[<span class="st">'n_total'</span>], color<span class="op">=</span><span class="st">'#BDC3C7'</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb24-721"><a href="#cb24-721" aria-hidden="true" tabindex="-1"></a>       label<span class="op">=</span><span class="st">'Total tested'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a>ax.bar(x, cat_survival[<span class="st">'n_survive_bh'</span>], color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>,</span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a>       label<span class="op">=</span><span class="st">'Survive BH (q=0.05)'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(cat_survival.index, rotation<span class="op">=</span><span class="dv">30</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Number of Anomalies'</span>)</span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomaly Survival by Category'</span>)</span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a><span class="co"># Add survival rate text</span></span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (_, row) <span class="kw">in</span> <span class="bu">enumerate</span>(cat_survival.iterrows()):</span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> row[<span class="st">'n_total'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a>        ax.text(i, row[<span class="st">'n_total'</span>] <span class="op">+</span> <span class="fl">0.2</span>,</span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a>                <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'survival_rate_bh'</span>]<span class="sc">:.0%}</span><span class="ss">"</span>,</span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a>                ha<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'#27AE60'</span>)</span>
<span id="cb24-737"><a href="#cb24-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-738"><a href="#cb24-738" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-739"><a href="#cb24-739" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-740"><a href="#cb24-740" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-741"><a href="#cb24-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-742"><a href="#cb24-742" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimating the False Discovery Proportion {#sec-factor-zoo-fdp}</span></span>
<span id="cb24-743"><a href="#cb24-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-744"><a href="#cb24-744" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Storey Approach</span></span>
<span id="cb24-745"><a href="#cb24-745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-746"><a href="#cb24-746" aria-hidden="true" tabindex="-1"></a>Rather than controlling FDR at a pre-specified level, we can *estimate* the proportion of tested hypotheses that are truly null ($\pi_0$) and the implied false discovery proportion (FDP) at any given threshold. @storey2003positive proposes estimating $\pi_0$ from the distribution of p-values: under the null, p-values are uniformly distributed on $<span class="co">[</span><span class="ot">0, 1</span><span class="co">]</span>$, so the density of p-values in the "flat" region (away from zero) reveals $\pi_0$.</span>
<span id="cb24-747"><a href="#cb24-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-748"><a href="#cb24-748" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-749"><a href="#cb24-749" aria-hidden="true" tabindex="-1"></a>\hat{\pi}_0(\lambda) = \frac{<span class="sc">\#\{</span>p_i &gt; \lambda<span class="sc">\}</span>}{M(1 - \lambda)}</span>
<span id="cb24-750"><a href="#cb24-750" aria-hidden="true" tabindex="-1"></a>$$ {#eq-pi0}</span>
<span id="cb24-751"><a href="#cb24-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-752"><a href="#cb24-752" aria-hidden="true" tabindex="-1"></a>for a tuning parameter $\lambda$. The estimated false discovery proportion at threshold $t^*$ is then:</span>
<span id="cb24-753"><a href="#cb24-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-754"><a href="#cb24-754" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-755"><a href="#cb24-755" aria-hidden="true" tabindex="-1"></a>\widehat{\text{FDP}}(t^*) = \frac{\hat{\pi}_0 \cdot M \cdot P(|t| &gt; t^* | H_0)}{\#\{|t_i| &gt; t^*<span class="sc">\}</span>}</span>
<span id="cb24-756"><a href="#cb24-756" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fdp}</span>
<span id="cb24-757"><a href="#cb24-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-760"><a href="#cb24-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-761"><a href="#cb24-761" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: storey-pi0</span></span>
<span id="cb24-762"><a href="#cb24-762" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-763"><a href="#cb24-763" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Estimate the proportion of true nulls using Storey's method"</span></span>
<span id="cb24-764"><a href="#cb24-764" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_pi0(p_values, lambdas<span class="op">=</span>np.arange(<span class="fl">0.05</span>, <span class="fl">0.95</span>, <span class="fl">0.05</span>)):</span>
<span id="cb24-765"><a href="#cb24-765" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-766"><a href="#cb24-766" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate pi_0 (proportion of true nulls) using Storey (2003).</span></span>
<span id="cb24-767"><a href="#cb24-767" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses bootstrap to select optimal lambda.</span></span>
<span id="cb24-768"><a href="#cb24-768" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-769"><a href="#cb24-769" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(p_values)</span>
<span id="cb24-770"><a href="#cb24-770" aria-hidden="true" tabindex="-1"></a>    pi0_estimates <span class="op">=</span> []</span>
<span id="cb24-771"><a href="#cb24-771" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-772"><a href="#cb24-772" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> lam <span class="kw">in</span> lambdas:</span>
<span id="cb24-773"><a href="#cb24-773" aria-hidden="true" tabindex="-1"></a>        n_above <span class="op">=</span> (p_values <span class="op">&gt;</span> lam).<span class="bu">sum</span>()</span>
<span id="cb24-774"><a href="#cb24-774" aria-hidden="true" tabindex="-1"></a>        pi0 <span class="op">=</span> n_above <span class="op">/</span> (M <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> lam))</span>
<span id="cb24-775"><a href="#cb24-775" aria-hidden="true" tabindex="-1"></a>        pi0_estimates.append({<span class="st">'lambda'</span>: lam, <span class="st">'pi0'</span>: <span class="bu">min</span>(pi0, <span class="fl">1.0</span>)})</span>
<span id="cb24-776"><a href="#cb24-776" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-777"><a href="#cb24-777" aria-hidden="true" tabindex="-1"></a>    pi0_df <span class="op">=</span> pd.DataFrame(pi0_estimates)</span>
<span id="cb24-778"><a href="#cb24-778" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-779"><a href="#cb24-779" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use the median of estimates for robustness</span></span>
<span id="cb24-780"><a href="#cb24-780" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (alternatives: bootstrap, spline smoothing)</span></span>
<span id="cb24-781"><a href="#cb24-781" aria-hidden="true" tabindex="-1"></a>    pi0_hat <span class="op">=</span> pi0_df[<span class="st">'pi0'</span>].median()</span>
<span id="cb24-782"><a href="#cb24-782" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-783"><a href="#cb24-783" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pi0_hat, pi0_df</span>
<span id="cb24-784"><a href="#cb24-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-785"><a href="#cb24-785" aria-hidden="true" tabindex="-1"></a>pi0_hat, pi0_df <span class="op">=</span> estimate_pi0(zoo_df[<span class="st">'p_value'</span>].values)</span>
<span id="cb24-786"><a href="#cb24-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-787"><a href="#cb24-787" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Estimated œÄ‚ÇÄ (proportion of true nulls): </span><span class="sc">{</span>pi0_hat<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-788"><a href="#cb24-788" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Implied proportion of true factors: </span><span class="sc">{</span><span class="dv">1</span> <span class="op">-</span> pi0_hat<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-789"><a href="#cb24-789" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Estimated number of true factors: </span><span class="sc">{</span>(<span class="dv">1</span> <span class="op">-</span> pi0_hat) <span class="op">*</span> <span class="bu">len</span>(zoo_df)<span class="sc">:.0f}</span><span class="ss"> "</span></span>
<span id="cb24-790"><a href="#cb24-790" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"out of </span><span class="sc">{</span><span class="bu">len</span>(zoo_df)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-791"><a href="#cb24-791" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-792"><a href="#cb24-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-795"><a href="#cb24-795" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-796"><a href="#cb24-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pvalue-distribution</span></span>
<span id="cb24-797"><a href="#cb24-797" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-798"><a href="#cb24-798" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of p-values across the anomaly zoo. Panel A shows the histogram with the estimated null proportion (œÄ‚ÇÄ = horizontal line). The excess density near zero represents true discoveries. Panel B shows the estimated œÄ‚ÇÄ as a function of the tuning parameter Œª. The relatively flat region at higher Œª values provides the most stable estimate."</span></span>
<span id="cb24-799"><a href="#cb24-799" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot p-value distribution and pi_0 estimation"</span></span>
<span id="cb24-800"><a href="#cb24-800" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb24-801"><a href="#cb24-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-802"><a href="#cb24-802" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: p-value histogram</span></span>
<span id="cb24-803"><a href="#cb24-803" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(zoo_df[<span class="st">'p_value'</span>], bins<span class="op">=</span><span class="dv">20</span>, density<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-804"><a href="#cb24-804" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-805"><a href="#cb24-805" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span>pi0_hat, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb24-806"><a href="#cb24-806" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="ss">f'œÄ‚ÇÄ = </span><span class="sc">{</span>pi0_hat<span class="sc">:.2f}</span><span class="ss"> (null density)'</span>)</span>
<span id="cb24-807"><a href="#cb24-807" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, linestyle<span class="op">=</span><span class="st">':'</span>,</span>
<span id="cb24-808"><a href="#cb24-808" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'Uniform (all null)'</span>)</span>
<span id="cb24-809"><a href="#cb24-809" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'p-value'</span>)</span>
<span id="cb24-810"><a href="#cb24-810" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb24-811"><a href="#cb24-811" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: p-Value Distribution'</span>)</span>
<span id="cb24-812"><a href="#cb24-812" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb24-813"><a href="#cb24-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-814"><a href="#cb24-814" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: pi_0 estimates across lambda</span></span>
<span id="cb24-815"><a href="#cb24-815" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(pi0_df[<span class="st">'lambda'</span>], pi0_df[<span class="st">'pi0'</span>],</span>
<span id="cb24-816"><a href="#cb24-816" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, marker<span class="op">=</span><span class="st">'o'</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb24-817"><a href="#cb24-817" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(y<span class="op">=</span>pi0_hat, color<span class="op">=</span><span class="st">'#C0392B'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb24-818"><a href="#cb24-818" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'Median œÄ‚ÇÄ = </span><span class="sc">{</span>pi0_hat<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb24-819"><a href="#cb24-819" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Œª'</span>)</span>
<span id="cb24-820"><a href="#cb24-820" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'œÄ‚ÇÄ(Œª)'</span>)</span>
<span id="cb24-821"><a href="#cb24-821" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: œÄ‚ÇÄ Estimates by Œª'</span>)</span>
<span id="cb24-822"><a href="#cb24-822" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb24-823"><a href="#cb24-823" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim([<span class="dv">0</span>, <span class="fl">1.05</span>])</span>
<span id="cb24-824"><a href="#cb24-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-825"><a href="#cb24-825" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-826"><a href="#cb24-826" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-827"><a href="#cb24-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-828"><a href="#cb24-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-829"><a href="#cb24-829" aria-hidden="true" tabindex="-1"></a><span class="fu">### FDP Curve</span></span>
<span id="cb24-830"><a href="#cb24-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-831"><a href="#cb24-831" aria-hidden="true" tabindex="-1"></a>Using $\hat{\pi}_0$, we compute the estimated FDP at every possible t-threshold:</span>
<span id="cb24-832"><a href="#cb24-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-835"><a href="#cb24-835" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-836"><a href="#cb24-836" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-fdp-curve</span></span>
<span id="cb24-837"><a href="#cb24-837" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-838"><a href="#cb24-838" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Estimated false discovery proportion as a function of the t-statistic threshold. At the conventional |t| &gt; 2.0, a substantial fraction of discoveries may be false. The FDP drops below 5% around |t| &gt; 3.0, roughly consistent with the Harvey-Liu-Zhu recommendation."</span></span>
<span id="cb24-839"><a href="#cb24-839" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute and plot the FDP curve"</span></span>
<span id="cb24-840"><a href="#cb24-840" aria-hidden="true" tabindex="-1"></a>t_thresholds <span class="op">=</span> np.arange(<span class="fl">1.0</span>, <span class="fl">5.01</span>, <span class="fl">0.1</span>)</span>
<span id="cb24-841"><a href="#cb24-841" aria-hidden="true" tabindex="-1"></a>fdp_curve <span class="op">=</span> []</span>
<span id="cb24-842"><a href="#cb24-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-843"><a href="#cb24-843" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t_thresh <span class="kw">in</span> t_thresholds:</span>
<span id="cb24-844"><a href="#cb24-844" aria-hidden="true" tabindex="-1"></a>    n_rejected <span class="op">=</span> (zoo_df[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> t_thresh).<span class="bu">sum</span>()</span>
<span id="cb24-845"><a href="#cb24-845" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_rejected <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-846"><a href="#cb24-846" aria-hidden="true" tabindex="-1"></a>        fdp_curve.append({<span class="st">'t_threshold'</span>: t_thresh, <span class="st">'n_rejected'</span>: <span class="dv">0</span>,</span>
<span id="cb24-847"><a href="#cb24-847" aria-hidden="true" tabindex="-1"></a>                           <span class="st">'fdp'</span>: <span class="dv">0</span>})</span>
<span id="cb24-848"><a href="#cb24-848" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb24-849"><a href="#cb24-849" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-850"><a href="#cb24-850" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected false discoveries under null</span></span>
<span id="cb24-851"><a href="#cb24-851" aria-hidden="true" tabindex="-1"></a>    p_null_reject <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.norm.cdf(t_thresh))</span>
<span id="cb24-852"><a href="#cb24-852" aria-hidden="true" tabindex="-1"></a>    expected_false <span class="op">=</span> pi0_hat <span class="op">*</span> <span class="bu">len</span>(zoo_df) <span class="op">*</span> p_null_reject</span>
<span id="cb24-853"><a href="#cb24-853" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-854"><a href="#cb24-854" aria-hidden="true" tabindex="-1"></a>    fdp <span class="op">=</span> <span class="bu">min</span>(expected_false <span class="op">/</span> n_rejected, <span class="fl">1.0</span>)</span>
<span id="cb24-855"><a href="#cb24-855" aria-hidden="true" tabindex="-1"></a>    fdp_curve.append({<span class="st">'t_threshold'</span>: t_thresh, <span class="st">'n_rejected'</span>: n_rejected,</span>
<span id="cb24-856"><a href="#cb24-856" aria-hidden="true" tabindex="-1"></a>                       <span class="st">'fdp'</span>: fdp})</span>
<span id="cb24-857"><a href="#cb24-857" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-858"><a href="#cb24-858" aria-hidden="true" tabindex="-1"></a>fdp_df <span class="op">=</span> pd.DataFrame(fdp_curve)</span>
<span id="cb24-859"><a href="#cb24-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-860"><a href="#cb24-860" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb24-861"><a href="#cb24-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-862"><a href="#cb24-862" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: FDP curve</span></span>
<span id="cb24-863"><a href="#cb24-863" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(fdp_df[<span class="st">'t_threshold'</span>], fdp_df[<span class="st">'fdp'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb24-864"><a href="#cb24-864" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-865"><a href="#cb24-865" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">5</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb24-866"><a href="#cb24-866" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'5</span><span class="sc">% F</span><span class="st">DP'</span>)</span>
<span id="cb24-867"><a href="#cb24-867" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">':'</span>, linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb24-868"><a href="#cb24-868" aria-hidden="true" tabindex="-1"></a>                label<span class="op">=</span><span class="st">'10</span><span class="sc">% F</span><span class="st">DP'</span>)</span>
<span id="cb24-869"><a href="#cb24-869" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">2.0</span>, color<span class="op">=</span><span class="st">'#E67E22'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb24-870"><a href="#cb24-870" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'|t| = 2.0'</span>)</span>
<span id="cb24-871"><a href="#cb24-871" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(x<span class="op">=</span><span class="fl">3.0</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb24-872"><a href="#cb24-872" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">1</span>, label<span class="op">=</span><span class="st">'|t| = 3.0'</span>)</span>
<span id="cb24-873"><a href="#cb24-873" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'|t| Threshold'</span>)</span>
<span id="cb24-874"><a href="#cb24-874" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Estimated FDP (%)'</span>)</span>
<span id="cb24-875"><a href="#cb24-875" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: False Discovery Proportion'</span>)</span>
<span id="cb24-876"><a href="#cb24-876" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb24-877"><a href="#cb24-877" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylim([<span class="op">-</span><span class="dv">2</span>, <span class="dv">80</span>])</span>
<span id="cb24-878"><a href="#cb24-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-879"><a href="#cb24-879" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of rejections</span></span>
<span id="cb24-880"><a href="#cb24-880" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(fdp_df[<span class="st">'t_threshold'</span>], fdp_df[<span class="st">'n_rejected'</span>],</span>
<span id="cb24-881"><a href="#cb24-881" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-882"><a href="#cb24-882" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'|t| Threshold'</span>)</span>
<span id="cb24-883"><a href="#cb24-883" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Discoveries'</span>)</span>
<span id="cb24-884"><a href="#cb24-884" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Discoveries vs Threshold'</span>)</span>
<span id="cb24-885"><a href="#cb24-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-886"><a href="#cb24-886" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-887"><a href="#cb24-887" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-888"><a href="#cb24-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-889"><a href="#cb24-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-890"><a href="#cb24-890" aria-hidden="true" tabindex="-1"></a><span class="fu">## Bootstrap-Based Multiple Testing {#sec-factor-zoo-bootstrap}</span></span>
<span id="cb24-891"><a href="#cb24-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-892"><a href="#cb24-892" aria-hidden="true" tabindex="-1"></a><span class="fu">### The White Reality Check</span></span>
<span id="cb24-893"><a href="#cb24-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-894"><a href="#cb24-894" aria-hidden="true" tabindex="-1"></a>Analytical corrections assume known distributions. When return distributions are non-normal (heavy tails, skewness, serial correlation), as they are in Vietnam, bootstrap methods provide more reliable inference.</span>
<span id="cb24-895"><a href="#cb24-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-896"><a href="#cb24-896" aria-hidden="true" tabindex="-1"></a>@white2000reality proposes a bootstrap reality check that accounts for data snooping across multiple strategies. The null hypothesis is that the best strategy has zero expected return. The procedure:</span>
<span id="cb24-897"><a href="#cb24-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-898"><a href="#cb24-898" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>Generate $B$ bootstrap samples of the time series (block bootstrap to preserve serial dependence).</span>
<span id="cb24-899"><a href="#cb24-899" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>For each bootstrap sample, compute the t-statistic for every factor.</span>
<span id="cb24-900"><a href="#cb24-900" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>The p-value for factor $i$ is the proportion of bootstrap samples in which the maximum t-statistic across all factors exceeds the observed t-statistic of factor $i$.</span>
<span id="cb24-901"><a href="#cb24-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-904"><a href="#cb24-904" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-905"><a href="#cb24-905" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bootstrap-rc</span></span>
<span id="cb24-906"><a href="#cb24-906" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-907"><a href="#cb24-907" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement White's Reality Check via block bootstrap"</span></span>
<span id="cb24-908"><a href="#cb24-908" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> white_reality_check(factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb24-909"><a href="#cb24-909" aria-hidden="true" tabindex="-1"></a>                          block_size<span class="op">=</span><span class="dv">6</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb24-910"><a href="#cb24-910" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-911"><a href="#cb24-911" aria-hidden="true" tabindex="-1"></a><span class="co">    White (2000) Reality Check for data snooping.</span></span>
<span id="cb24-912"><a href="#cb24-912" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-913"><a href="#cb24-913" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-914"><a href="#cb24-914" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-915"><a href="#cb24-915" aria-hidden="true" tabindex="-1"></a><span class="co">    factor_returns_dict : dict</span></span>
<span id="cb24-916"><a href="#cb24-916" aria-hidden="true" tabindex="-1"></a><span class="co">        {factor_name: pd.Series of monthly returns}</span></span>
<span id="cb24-917"><a href="#cb24-917" aria-hidden="true" tabindex="-1"></a><span class="co">    n_bootstrap : int</span></span>
<span id="cb24-918"><a href="#cb24-918" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of bootstrap replications</span></span>
<span id="cb24-919"><a href="#cb24-919" aria-hidden="true" tabindex="-1"></a><span class="co">    block_size : int</span></span>
<span id="cb24-920"><a href="#cb24-920" aria-hidden="true" tabindex="-1"></a><span class="co">        Block length for circular block bootstrap</span></span>
<span id="cb24-921"><a href="#cb24-921" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb24-922"><a href="#cb24-922" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-923"><a href="#cb24-923" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-924"><a href="#cb24-924" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with original t-stats and bootstrap p-values</span></span>
<span id="cb24-925"><a href="#cb24-925" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-926"><a href="#cb24-926" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb24-927"><a href="#cb24-927" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-928"><a href="#cb24-928" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Align all factor returns to common dates</span></span>
<span id="cb24-929"><a href="#cb24-929" aria-hidden="true" tabindex="-1"></a>    all_names <span class="op">=</span> <span class="bu">list</span>(factor_returns_dict.keys())</span>
<span id="cb24-930"><a href="#cb24-930" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-931"><a href="#cb24-931" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> all_names:</span>
<span id="cb24-932"><a href="#cb24-932" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> <span class="bu">set</span>(factor_returns_dict[name].index)</span>
<span id="cb24-933"><a href="#cb24-933" aria-hidden="true" tabindex="-1"></a>        common_dates <span class="op">=</span> dates <span class="cf">if</span> common_dates <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_dates <span class="op">&amp;</span> dates</span>
<span id="cb24-934"><a href="#cb24-934" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="bu">sorted</span>(common_dates)</span>
<span id="cb24-935"><a href="#cb24-935" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common_dates)</span>
<span id="cb24-936"><a href="#cb24-936" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-937"><a href="#cb24-937" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build return matrix (T x M)</span></span>
<span id="cb24-938"><a href="#cb24-938" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(all_names)</span>
<span id="cb24-939"><a href="#cb24-939" aria-hidden="true" tabindex="-1"></a>    return_matrix <span class="op">=</span> np.column_stack([</span>
<span id="cb24-940"><a href="#cb24-940" aria-hidden="true" tabindex="-1"></a>        factor_returns_dict[name].reindex(common_dates).values</span>
<span id="cb24-941"><a href="#cb24-941" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> all_names</span>
<span id="cb24-942"><a href="#cb24-942" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb24-943"><a href="#cb24-943" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-944"><a href="#cb24-944" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Observed t-statistics</span></span>
<span id="cb24-945"><a href="#cb24-945" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> np.nanmean(return_matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-946"><a href="#cb24-946" aria-hidden="true" tabindex="-1"></a>    ses <span class="op">=</span> np.nanstd(return_matrix, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb24-947"><a href="#cb24-947" aria-hidden="true" tabindex="-1"></a>    t_obs <span class="op">=</span> means <span class="op">/</span> np.where(ses <span class="op">&gt;</span> <span class="dv">0</span>, ses, np.nan)</span>
<span id="cb24-948"><a href="#cb24-948" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-949"><a href="#cb24-949" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Block bootstrap</span></span>
<span id="cb24-950"><a href="#cb24-950" aria-hidden="true" tabindex="-1"></a>    n_blocks <span class="op">=</span> <span class="bu">int</span>(np.ceil(T <span class="op">/</span> block_size))</span>
<span id="cb24-951"><a href="#cb24-951" aria-hidden="true" tabindex="-1"></a>    max_t_bootstrap <span class="op">=</span> np.zeros(n_bootstrap)</span>
<span id="cb24-952"><a href="#cb24-952" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-953"><a href="#cb24-953" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb24-954"><a href="#cb24-954" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Circular block bootstrap</span></span>
<span id="cb24-955"><a href="#cb24-955" aria-hidden="true" tabindex="-1"></a>        block_starts <span class="op">=</span> rng.integers(<span class="dv">0</span>, T, size<span class="op">=</span>n_blocks)</span>
<span id="cb24-956"><a href="#cb24-956" aria-hidden="true" tabindex="-1"></a>        indices <span class="op">=</span> np.concatenate([</span>
<span id="cb24-957"><a href="#cb24-957" aria-hidden="true" tabindex="-1"></a>            np.arange(start, start <span class="op">+</span> block_size) <span class="op">%</span> T</span>
<span id="cb24-958"><a href="#cb24-958" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> start <span class="kw">in</span> block_starts</span>
<span id="cb24-959"><a href="#cb24-959" aria-hidden="true" tabindex="-1"></a>        ])[:T]</span>
<span id="cb24-960"><a href="#cb24-960" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-961"><a href="#cb24-961" aria-hidden="true" tabindex="-1"></a>        boot_returns <span class="op">=</span> return_matrix[indices, :]</span>
<span id="cb24-962"><a href="#cb24-962" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-963"><a href="#cb24-963" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Center under null (subtract original mean)</span></span>
<span id="cb24-964"><a href="#cb24-964" aria-hidden="true" tabindex="-1"></a>        boot_centered <span class="op">=</span> boot_returns <span class="op">-</span> means[np.newaxis, :]</span>
<span id="cb24-965"><a href="#cb24-965" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-966"><a href="#cb24-966" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute t-stats under null</span></span>
<span id="cb24-967"><a href="#cb24-967" aria-hidden="true" tabindex="-1"></a>        boot_means <span class="op">=</span> np.nanmean(boot_centered, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-968"><a href="#cb24-968" aria-hidden="true" tabindex="-1"></a>        boot_ses <span class="op">=</span> np.nanstd(boot_centered, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb24-969"><a href="#cb24-969" aria-hidden="true" tabindex="-1"></a>        boot_t <span class="op">=</span> boot_means <span class="op">/</span> np.where(boot_ses <span class="op">&gt;</span> <span class="dv">0</span>, boot_ses, np.nan)</span>
<span id="cb24-970"><a href="#cb24-970" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-971"><a href="#cb24-971" aria-hidden="true" tabindex="-1"></a>        max_t_bootstrap[b] <span class="op">=</span> np.nanmax(np.<span class="bu">abs</span>(boot_t))</span>
<span id="cb24-972"><a href="#cb24-972" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-973"><a href="#cb24-973" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bootstrap p-values (one-sided: is obs_t extreme relative to max?)</span></span>
<span id="cb24-974"><a href="#cb24-974" aria-hidden="true" tabindex="-1"></a>    boot_pvals <span class="op">=</span> np.array([</span>
<span id="cb24-975"><a href="#cb24-975" aria-hidden="true" tabindex="-1"></a>        np.mean(max_t_bootstrap <span class="op">&gt;=</span> <span class="bu">abs</span>(t)) <span class="cf">if</span> np.isfinite(t) <span class="cf">else</span> <span class="fl">1.0</span></span>
<span id="cb24-976"><a href="#cb24-976" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> t <span class="kw">in</span> t_obs</span>
<span id="cb24-977"><a href="#cb24-977" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb24-978"><a href="#cb24-978" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-979"><a href="#cb24-979" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb24-980"><a href="#cb24-980" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor'</span>: all_names,</span>
<span id="cb24-981"><a href="#cb24-981" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat_obs'</span>: t_obs,</span>
<span id="cb24-982"><a href="#cb24-982" aria-hidden="true" tabindex="-1"></a>        <span class="st">'boot_pval'</span>: boot_pvals</span>
<span id="cb24-983"><a href="#cb24-983" aria-hidden="true" tabindex="-1"></a>    }).set_index(<span class="st">'factor'</span>)</span>
<span id="cb24-984"><a href="#cb24-984" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-985"><a href="#cb24-985" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results, max_t_bootstrap</span>
<span id="cb24-986"><a href="#cb24-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-987"><a href="#cb24-987" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect factor return series</span></span>
<span id="cb24-988"><a href="#cb24-988" aria-hidden="true" tabindex="-1"></a>factor_returns_dict <span class="op">=</span> {</span>
<span id="cb24-989"><a href="#cb24-989" aria-hidden="true" tabindex="-1"></a>    name: zoo_results[name][<span class="st">'returns'</span>]</span>
<span id="cb24-990"><a href="#cb24-990" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> zoo_results</span>
<span id="cb24-991"><a href="#cb24-991" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'returns'</span> <span class="kw">in</span> zoo_results[name]</span>
<span id="cb24-992"><a href="#cb24-992" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-993"><a href="#cb24-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-994"><a href="#cb24-994" aria-hidden="true" tabindex="-1"></a>boot_results, max_t_dist <span class="op">=</span> white_reality_check(</span>
<span id="cb24-995"><a href="#cb24-995" aria-hidden="true" tabindex="-1"></a>    factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>, block_size<span class="op">=</span><span class="dv">6</span></span>
<span id="cb24-996"><a href="#cb24-996" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-997"><a href="#cb24-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-998"><a href="#cb24-998" aria-hidden="true" tabindex="-1"></a>boot_results <span class="op">=</span> boot_results.sort_values(<span class="st">'t_stat_obs'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-999"><a href="#cb24-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1000"><a href="#cb24-1000" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"White Reality Check Results (top 20):"</span>)</span>
<span id="cb24-1001"><a href="#cb24-1001" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(boot_results.head(<span class="dv">20</span>).<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb24-1002"><a href="#cb24-1002" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Factors surviving (boot p &lt; 0.05): "</span></span>
<span id="cb24-1003"><a href="#cb24-1003" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>(boot_results[<span class="st">'boot_pval'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1004"><a href="#cb24-1004" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1005"><a href="#cb24-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1008"><a href="#cb24-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1009"><a href="#cb24-1009" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-bootstrap-distribution</span></span>
<span id="cb24-1010"><a href="#cb24-1010" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1011"><a href="#cb24-1011" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Bootstrap distribution of the maximum t-statistic across all factors under the null hypothesis of no true effects. The vertical lines mark the observed t-statistics of the top anomalies. Only anomalies whose observed t exceeds the 95th percentile of this distribution survive the data-snooping correction."</span></span>
<span id="cb24-1012"><a href="#cb24-1012" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot the bootstrap null distribution"</span></span>
<span id="cb24-1013"><a href="#cb24-1013" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb24-1014"><a href="#cb24-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1015"><a href="#cb24-1015" aria-hidden="true" tabindex="-1"></a>ax.hist(max_t_dist, bins<span class="op">=</span><span class="dv">40</span>, density<span class="op">=</span><span class="va">True</span>, color<span class="op">=</span><span class="st">'#BDC3C7'</span>,</span>
<span id="cb24-1016"><a href="#cb24-1016" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, label<span class="op">=</span><span class="st">'Bootstrap null</span><span class="ch">\n</span><span class="st">(max |t| across all factors)'</span>)</span>
<span id="cb24-1017"><a href="#cb24-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1018"><a href="#cb24-1018" aria-hidden="true" tabindex="-1"></a><span class="co"># 95th percentile</span></span>
<span id="cb24-1019"><a href="#cb24-1019" aria-hidden="true" tabindex="-1"></a>p95 <span class="op">=</span> np.percentile(max_t_dist, <span class="dv">95</span>)</span>
<span id="cb24-1020"><a href="#cb24-1020" aria-hidden="true" tabindex="-1"></a>ax.axvline(x<span class="op">=</span>p95, color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb24-1021"><a href="#cb24-1021" aria-hidden="true" tabindex="-1"></a>           label<span class="op">=</span><span class="ss">f'95th percentile = </span><span class="sc">{</span>p95<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb24-1022"><a href="#cb24-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1023"><a href="#cb24-1023" aria-hidden="true" tabindex="-1"></a><span class="co"># Observed top factor t-statistics</span></span>
<span id="cb24-1024"><a href="#cb24-1024" aria-hidden="true" tabindex="-1"></a>top_5 <span class="op">=</span> boot_results.head(<span class="dv">5</span>)</span>
<span id="cb24-1025"><a href="#cb24-1025" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (name, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top_5.iterrows()):</span>
<span id="cb24-1026"><a href="#cb24-1026" aria-hidden="true" tabindex="-1"></a>    ax.axvline(x<span class="op">=</span><span class="bu">abs</span>(row[<span class="st">'t_stat_obs'</span>]),</span>
<span id="cb24-1027"><a href="#cb24-1027" aria-hidden="true" tabindex="-1"></a>               color<span class="op">=</span>plt.cm.Set1(i), linewidth<span class="op">=</span><span class="fl">1.5</span>, linestyle<span class="op">=</span><span class="st">':'</span>,</span>
<span id="cb24-1028"><a href="#cb24-1028" aria-hidden="true" tabindex="-1"></a>               label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: |t| = </span><span class="sc">{</span><span class="bu">abs</span>(row[<span class="st">"t_stat_obs"</span>])<span class="sc">:.2f}</span><span class="ss">'</span>)</span>
<span id="cb24-1029"><a href="#cb24-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1030"><a href="#cb24-1030" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Maximum |t-statistic|'</span>)</span>
<span id="cb24-1031"><a href="#cb24-1031" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb24-1032"><a href="#cb24-1032" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"White's Reality Check: Bootstrap Null Distribution"</span>)</span>
<span id="cb24-1033"><a href="#cb24-1033" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">8</span>, loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb24-1034"><a href="#cb24-1034" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-1035"><a href="#cb24-1035" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-1036"><a href="#cb24-1036" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1037"><a href="#cb24-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1038"><a href="#cb24-1038" aria-hidden="true" tabindex="-1"></a><span class="fu">### Romano-Wolf Step-Down Bootstrap</span></span>
<span id="cb24-1039"><a href="#cb24-1039" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1040"><a href="#cb24-1040" aria-hidden="true" tabindex="-1"></a>The @romano2005exact step-down procedure improves on the White Reality Check by iteratively removing rejected hypotheses and re-testing the remaining ones, gaining power at each step:</span>
<span id="cb24-1041"><a href="#cb24-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1044"><a href="#cb24-1044" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1045"><a href="#cb24-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: romano-wolf</span></span>
<span id="cb24-1046"><a href="#cb24-1046" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1047"><a href="#cb24-1047" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement the Romano-Wolf step-down bootstrap procedure"</span></span>
<span id="cb24-1048"><a href="#cb24-1048" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> romano_wolf_stepdown(factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">1000</span>,</span>
<span id="cb24-1049"><a href="#cb24-1049" aria-hidden="true" tabindex="-1"></a>                           block_size<span class="op">=</span><span class="dv">6</span>, alpha<span class="op">=</span><span class="fl">0.05</span>, seed<span class="op">=</span><span class="dv">42</span>):</span>
<span id="cb24-1050"><a href="#cb24-1050" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-1051"><a href="#cb24-1051" aria-hidden="true" tabindex="-1"></a><span class="co">    Romano-Wolf (2005) step-down procedure for FWER control.</span></span>
<span id="cb24-1052"><a href="#cb24-1052" aria-hidden="true" tabindex="-1"></a><span class="co">    More powerful than single-step methods because rejected</span></span>
<span id="cb24-1053"><a href="#cb24-1053" aria-hidden="true" tabindex="-1"></a><span class="co">    hypotheses are removed before re-testing.</span></span>
<span id="cb24-1054"><a href="#cb24-1054" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1055"><a href="#cb24-1055" aria-hidden="true" tabindex="-1"></a>    rng <span class="op">=</span> np.random.default_rng(seed)</span>
<span id="cb24-1056"><a href="#cb24-1056" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1057"><a href="#cb24-1057" aria-hidden="true" tabindex="-1"></a>    all_names <span class="op">=</span> <span class="bu">list</span>(factor_returns_dict.keys())</span>
<span id="cb24-1058"><a href="#cb24-1058" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="va">None</span></span>
<span id="cb24-1059"><a href="#cb24-1059" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name <span class="kw">in</span> all_names:</span>
<span id="cb24-1060"><a href="#cb24-1060" aria-hidden="true" tabindex="-1"></a>        dates <span class="op">=</span> <span class="bu">set</span>(factor_returns_dict[name].index)</span>
<span id="cb24-1061"><a href="#cb24-1061" aria-hidden="true" tabindex="-1"></a>        common_dates <span class="op">=</span> dates <span class="cf">if</span> common_dates <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> common_dates <span class="op">&amp;</span> dates</span>
<span id="cb24-1062"><a href="#cb24-1062" aria-hidden="true" tabindex="-1"></a>    common_dates <span class="op">=</span> <span class="bu">sorted</span>(common_dates)</span>
<span id="cb24-1063"><a href="#cb24-1063" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> <span class="bu">len</span>(common_dates)</span>
<span id="cb24-1064"><a href="#cb24-1064" aria-hidden="true" tabindex="-1"></a>    M <span class="op">=</span> <span class="bu">len</span>(all_names)</span>
<span id="cb24-1065"><a href="#cb24-1065" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1066"><a href="#cb24-1066" aria-hidden="true" tabindex="-1"></a>    return_matrix <span class="op">=</span> np.column_stack([</span>
<span id="cb24-1067"><a href="#cb24-1067" aria-hidden="true" tabindex="-1"></a>        factor_returns_dict[name].reindex(common_dates).values</span>
<span id="cb24-1068"><a href="#cb24-1068" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name <span class="kw">in</span> all_names</span>
<span id="cb24-1069"><a href="#cb24-1069" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb24-1070"><a href="#cb24-1070" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1071"><a href="#cb24-1071" aria-hidden="true" tabindex="-1"></a>    means <span class="op">=</span> np.nanmean(return_matrix, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-1072"><a href="#cb24-1072" aria-hidden="true" tabindex="-1"></a>    ses <span class="op">=</span> np.nanstd(return_matrix, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb24-1073"><a href="#cb24-1073" aria-hidden="true" tabindex="-1"></a>    t_obs <span class="op">=</span> np.<span class="bu">abs</span>(means <span class="op">/</span> np.where(ses <span class="op">&gt;</span> <span class="dv">0</span>, ses, np.nan))</span>
<span id="cb24-1074"><a href="#cb24-1074" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1075"><a href="#cb24-1075" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by observed t-stat (descending)</span></span>
<span id="cb24-1076"><a href="#cb24-1076" aria-hidden="true" tabindex="-1"></a>    order <span class="op">=</span> np.argsort(<span class="op">-</span>t_obs)</span>
<span id="cb24-1077"><a href="#cb24-1077" aria-hidden="true" tabindex="-1"></a>    t_sorted <span class="op">=</span> t_obs[order]</span>
<span id="cb24-1078"><a href="#cb24-1078" aria-hidden="true" tabindex="-1"></a>    names_sorted <span class="op">=</span> [all_names[i] <span class="cf">for</span> i <span class="kw">in</span> order]</span>
<span id="cb24-1079"><a href="#cb24-1079" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1080"><a href="#cb24-1080" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step-down procedure</span></span>
<span id="cb24-1081"><a href="#cb24-1081" aria-hidden="true" tabindex="-1"></a>    rejected <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb24-1082"><a href="#cb24-1082" aria-hidden="true" tabindex="-1"></a>    remaining <span class="op">=</span> <span class="bu">set</span>(<span class="bu">range</span>(M))</span>
<span id="cb24-1083"><a href="#cb24-1083" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1084"><a href="#cb24-1084" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> step <span class="kw">in</span> <span class="bu">range</span>(M):</span>
<span id="cb24-1085"><a href="#cb24-1085" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> remaining:</span>
<span id="cb24-1086"><a href="#cb24-1086" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb24-1087"><a href="#cb24-1087" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1088"><a href="#cb24-1088" aria-hidden="true" tabindex="-1"></a>        remaining_idx <span class="op">=</span> <span class="bu">sorted</span>(remaining)</span>
<span id="cb24-1089"><a href="#cb24-1089" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1090"><a href="#cb24-1090" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bootstrap max t-stat among remaining</span></span>
<span id="cb24-1091"><a href="#cb24-1091" aria-hidden="true" tabindex="-1"></a>        n_blocks <span class="op">=</span> <span class="bu">int</span>(np.ceil(T <span class="op">/</span> block_size))</span>
<span id="cb24-1092"><a href="#cb24-1092" aria-hidden="true" tabindex="-1"></a>        max_t_boot <span class="op">=</span> np.zeros(n_bootstrap)</span>
<span id="cb24-1093"><a href="#cb24-1093" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1094"><a href="#cb24-1094" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> b <span class="kw">in</span> <span class="bu">range</span>(n_bootstrap):</span>
<span id="cb24-1095"><a href="#cb24-1095" aria-hidden="true" tabindex="-1"></a>            block_starts <span class="op">=</span> rng.integers(<span class="dv">0</span>, T, size<span class="op">=</span>n_blocks)</span>
<span id="cb24-1096"><a href="#cb24-1096" aria-hidden="true" tabindex="-1"></a>            indices <span class="op">=</span> np.concatenate([</span>
<span id="cb24-1097"><a href="#cb24-1097" aria-hidden="true" tabindex="-1"></a>                np.arange(start, start <span class="op">+</span> block_size) <span class="op">%</span> T</span>
<span id="cb24-1098"><a href="#cb24-1098" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> start <span class="kw">in</span> block_starts</span>
<span id="cb24-1099"><a href="#cb24-1099" aria-hidden="true" tabindex="-1"></a>            ])[:T]</span>
<span id="cb24-1100"><a href="#cb24-1100" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-1101"><a href="#cb24-1101" aria-hidden="true" tabindex="-1"></a>            boot_returns <span class="op">=</span> return_matrix[indices][:, remaining_idx]</span>
<span id="cb24-1102"><a href="#cb24-1102" aria-hidden="true" tabindex="-1"></a>            boot_centered <span class="op">=</span> boot_returns <span class="op">-</span> means[remaining_idx]</span>
<span id="cb24-1103"><a href="#cb24-1103" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-1104"><a href="#cb24-1104" aria-hidden="true" tabindex="-1"></a>            boot_means <span class="op">=</span> np.nanmean(boot_centered, axis<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-1105"><a href="#cb24-1105" aria-hidden="true" tabindex="-1"></a>            boot_ses <span class="op">=</span> np.nanstd(boot_centered, axis<span class="op">=</span><span class="dv">0</span>) <span class="op">/</span> np.sqrt(T)</span>
<span id="cb24-1106"><a href="#cb24-1106" aria-hidden="true" tabindex="-1"></a>            boot_t <span class="op">=</span> np.<span class="bu">abs</span>(boot_means <span class="op">/</span> np.where(boot_ses <span class="op">&gt;</span> <span class="dv">0</span>, boot_ses, np.nan))</span>
<span id="cb24-1107"><a href="#cb24-1107" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb24-1108"><a href="#cb24-1108" aria-hidden="true" tabindex="-1"></a>            max_t_boot[b] <span class="op">=</span> np.nanmax(boot_t)</span>
<span id="cb24-1109"><a href="#cb24-1109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1110"><a href="#cb24-1110" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Critical value</span></span>
<span id="cb24-1111"><a href="#cb24-1111" aria-hidden="true" tabindex="-1"></a>        cv <span class="op">=</span> np.percentile(max_t_boot, (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> <span class="dv">100</span>)</span>
<span id="cb24-1112"><a href="#cb24-1112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1113"><a href="#cb24-1113" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Test the most significant remaining factor</span></span>
<span id="cb24-1114"><a href="#cb24-1114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the factor with highest t among remaining</span></span>
<span id="cb24-1115"><a href="#cb24-1115" aria-hidden="true" tabindex="-1"></a>        best_remaining <span class="op">=</span> <span class="bu">max</span>(remaining, key<span class="op">=</span><span class="kw">lambda</span> j: t_obs[j])</span>
<span id="cb24-1116"><a href="#cb24-1116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb24-1117"><a href="#cb24-1117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> t_obs[best_remaining] <span class="op">&gt;</span> cv:</span>
<span id="cb24-1118"><a href="#cb24-1118" aria-hidden="true" tabindex="-1"></a>            rejected.add(best_remaining)</span>
<span id="cb24-1119"><a href="#cb24-1119" aria-hidden="true" tabindex="-1"></a>            remaining.remove(best_remaining)</span>
<span id="cb24-1120"><a href="#cb24-1120" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb24-1121"><a href="#cb24-1121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span>  <span class="co"># Cannot reject any more</span></span>
<span id="cb24-1122"><a href="#cb24-1122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1123"><a href="#cb24-1123" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb24-1124"><a href="#cb24-1124" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor'</span>: all_names,</span>
<span id="cb24-1125"><a href="#cb24-1125" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat'</span>: t_obs,</span>
<span id="cb24-1126"><a href="#cb24-1126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'rejected'</span>: [i <span class="kw">in</span> rejected <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(M)]</span>
<span id="cb24-1127"><a href="#cb24-1127" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'t_stat'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-1128"><a href="#cb24-1128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1129"><a href="#cb24-1129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb24-1130"><a href="#cb24-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1131"><a href="#cb24-1131" aria-hidden="true" tabindex="-1"></a>rw_results <span class="op">=</span> romano_wolf_stepdown(</span>
<span id="cb24-1132"><a href="#cb24-1132" aria-hidden="true" tabindex="-1"></a>    factor_returns_dict, n_bootstrap<span class="op">=</span><span class="dv">500</span>, block_size<span class="op">=</span><span class="dv">6</span></span>
<span id="cb24-1133"><a href="#cb24-1133" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1134"><a href="#cb24-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1135"><a href="#cb24-1135" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Romano-Wolf rejections: </span><span class="sc">{</span>rw_results[<span class="st">'rejected'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> / </span><span class="sc">{</span><span class="bu">len</span>(rw_results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1136"><a href="#cb24-1136" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rejected factors:"</span>)</span>
<span id="cb24-1137"><a href="#cb24-1137" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(rw_results[rw_results[<span class="st">'rejected'</span>]][[<span class="st">'factor'</span>, <span class="st">'t_stat'</span>]].to_string())</span>
<span id="cb24-1138"><a href="#cb24-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1139"><a href="#cb24-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1140"><a href="#cb24-1140" aria-hidden="true" tabindex="-1"></a><span class="fu">## Out-of-Sample Validation {#sec-factor-zoo-oos}</span></span>
<span id="cb24-1141"><a href="#cb24-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1142"><a href="#cb24-1142" aria-hidden="true" tabindex="-1"></a><span class="fu">### Pre-Publication vs. Post-Publication Decay</span></span>
<span id="cb24-1143"><a href="#cb24-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1144"><a href="#cb24-1144" aria-hidden="true" tabindex="-1"></a>@mclean2016does find that anomaly returns decline by 32% after publication in the U.S. market, suggesting that roughly one-third of the premium was due to mispricing that was corrected by informed trading. For Vietnam, we use a time-series split as a proxy for out-of-sample testing:</span>
<span id="cb24-1145"><a href="#cb24-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1148"><a href="#cb24-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1149"><a href="#cb24-1149" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: oos-split</span></span>
<span id="cb24-1150"><a href="#cb24-1150" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1151"><a href="#cb24-1151" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare factor premia in-sample vs out-of-sample"</span></span>
<span id="cb24-1152"><a href="#cb24-1152" aria-hidden="true" tabindex="-1"></a><span class="co"># Split at midpoint of available data</span></span>
<span id="cb24-1153"><a href="#cb24-1153" aria-hidden="true" tabindex="-1"></a>all_dates <span class="op">=</span> <span class="bu">sorted</span>(panel[<span class="st">'month_end'</span>].unique())</span>
<span id="cb24-1154"><a href="#cb24-1154" aria-hidden="true" tabindex="-1"></a>mid_date <span class="op">=</span> all_dates[<span class="bu">len</span>(all_dates) <span class="op">//</span> <span class="dv">2</span>]</span>
<span id="cb24-1155"><a href="#cb24-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1156"><a href="#cb24-1156" aria-hidden="true" tabindex="-1"></a>oos_comparison <span class="op">=</span> []</span>
<span id="cb24-1157"><a href="#cb24-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1158"><a href="#cb24-1158" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> zoo_results:</span>
<span id="cb24-1159"><a href="#cb24-1159" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> zoo_results[name][<span class="st">'returns'</span>]</span>
<span id="cb24-1160"><a href="#cb24-1160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1161"><a href="#cb24-1161" aria-hidden="true" tabindex="-1"></a>    in_sample <span class="op">=</span> ls[ls.index <span class="op">&lt;=</span> mid_date]</span>
<span id="cb24-1162"><a href="#cb24-1162" aria-hidden="true" tabindex="-1"></a>    out_sample <span class="op">=</span> ls[ls.index <span class="op">&gt;</span> mid_date]</span>
<span id="cb24-1163"><a href="#cb24-1163" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1164"><a href="#cb24-1164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(in_sample) <span class="op">&lt;</span> <span class="dv">36</span> <span class="kw">or</span> <span class="bu">len</span>(out_sample) <span class="op">&lt;</span> <span class="dv">36</span>:</span>
<span id="cb24-1165"><a href="#cb24-1165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb24-1166"><a href="#cb24-1166" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1167"><a href="#cb24-1167" aria-hidden="true" tabindex="-1"></a>    is_mean <span class="op">=</span> in_sample.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb24-1168"><a href="#cb24-1168" aria-hidden="true" tabindex="-1"></a>    is_t <span class="op">=</span> in_sample.mean() <span class="op">/</span> (in_sample.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(in_sample)))</span>
<span id="cb24-1169"><a href="#cb24-1169" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1170"><a href="#cb24-1170" aria-hidden="true" tabindex="-1"></a>    oos_mean <span class="op">=</span> out_sample.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb24-1171"><a href="#cb24-1171" aria-hidden="true" tabindex="-1"></a>    oos_t <span class="op">=</span> out_sample.mean() <span class="op">/</span> (out_sample.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(out_sample)))</span>
<span id="cb24-1172"><a href="#cb24-1172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb24-1173"><a href="#cb24-1173" aria-hidden="true" tabindex="-1"></a>    oos_comparison.append({</span>
<span id="cb24-1174"><a href="#cb24-1174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'signal'</span>: name,</span>
<span id="cb24-1175"><a href="#cb24-1175" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_return'</span>: is_mean,</span>
<span id="cb24-1176"><a href="#cb24-1176" aria-hidden="true" tabindex="-1"></a>        <span class="st">'is_t'</span>: is_t,</span>
<span id="cb24-1177"><a href="#cb24-1177" aria-hidden="true" tabindex="-1"></a>        <span class="st">'oos_return'</span>: oos_mean,</span>
<span id="cb24-1178"><a href="#cb24-1178" aria-hidden="true" tabindex="-1"></a>        <span class="st">'oos_t'</span>: oos_t,</span>
<span id="cb24-1179"><a href="#cb24-1179" aria-hidden="true" tabindex="-1"></a>        <span class="st">'decay_pct'</span>: (<span class="dv">1</span> <span class="op">-</span> oos_mean <span class="op">/</span> is_mean) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> is_mean <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan,</span>
<span id="cb24-1180"><a href="#cb24-1180" aria-hidden="true" tabindex="-1"></a>        <span class="st">'same_sign'</span>: np.sign(is_mean) <span class="op">==</span> np.sign(oos_mean),</span>
<span id="cb24-1181"><a href="#cb24-1181" aria-hidden="true" tabindex="-1"></a>        <span class="st">'category'</span>: zoo_results[name].get(<span class="st">'category'</span>, <span class="st">'Other'</span>)</span>
<span id="cb24-1182"><a href="#cb24-1182" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-1183"><a href="#cb24-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1184"><a href="#cb24-1184" aria-hidden="true" tabindex="-1"></a>oos_df <span class="op">=</span> pd.DataFrame(oos_comparison)</span>
<span id="cb24-1185"><a href="#cb24-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1186"><a href="#cb24-1186" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Split date: </span><span class="sc">{</span>mid_date<span class="sc">.</span>strftime(<span class="st">'%Y-%m'</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1187"><a href="#cb24-1187" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factors with same sign IS and OOS: "</span></span>
<span id="cb24-1188"><a href="#cb24-1188" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>oos_df[<span class="st">'same_sign'</span>]<span class="sc">.</span>mean()<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb24-1189"><a href="#cb24-1189" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Average OOS decay: </span><span class="sc">{</span>oos_df[<span class="st">'decay_pct'</span>]<span class="sc">.</span>median()<span class="sc">:.1f}</span><span class="ss">%"</span>)</span>
<span id="cb24-1190"><a href="#cb24-1190" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1191"><a href="#cb24-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1194"><a href="#cb24-1194" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1195"><a href="#cb24-1195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-is-oos</span></span>
<span id="cb24-1196"><a href="#cb24-1196" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1197"><a href="#cb24-1197" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "In-sample vs out-of-sample factor returns. Panel A is a scatter plot where each point is an anomaly; points above the 45-degree line strengthened out-of-sample, while points below weakened. Panel B shows the average decay rate by category. Factors that replicate out-of-sample with similar magnitude are most credible. A general decay pattern consistent with McLean-Pontiff (2016) is evidence of past mispricing being corrected."</span></span>
<span id="cb24-1198"><a href="#cb24-1198" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Scatter in-sample vs out-of-sample returns"</span></span>
<span id="cb24-1199"><a href="#cb24-1199" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb24-1200"><a href="#cb24-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1201"><a href="#cb24-1201" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Scatter</span></span>
<span id="cb24-1202"><a href="#cb24-1202" aria-hidden="true" tabindex="-1"></a>category_colors <span class="op">=</span> {</span>
<span id="cb24-1203"><a href="#cb24-1203" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Value'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'Size'</span>: <span class="st">'#1ABC9C'</span>, <span class="st">'Profitability'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb24-1204"><a href="#cb24-1204" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Investment'</span>: <span class="st">'#E67E22'</span>, <span class="st">'Momentum'</span>: <span class="st">'#C0392B'</span>, <span class="st">'Risk'</span>: <span class="st">'#8E44AD'</span>,</span>
<span id="cb24-1205"><a href="#cb24-1205" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Liquidity'</span>: <span class="st">'#3498DB'</span>, <span class="st">'Quality'</span>: <span class="st">'#F1C40F'</span>, <span class="st">'Dividend'</span>: <span class="st">'#95A5A6'</span></span>
<span id="cb24-1206"><a href="#cb24-1206" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-1207"><a href="#cb24-1207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1208"><a href="#cb24-1208" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cat <span class="kw">in</span> oos_df[<span class="st">'category'</span>].unique():</span>
<span id="cb24-1209"><a href="#cb24-1209" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> oos_df[oos_df[<span class="st">'category'</span>] <span class="op">==</span> cat]</span>
<span id="cb24-1210"><a href="#cb24-1210" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].scatter(subset[<span class="st">'is_return'</span>] <span class="op">*</span> <span class="dv">100</span>, subset[<span class="st">'oos_return'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb24-1211"><a href="#cb24-1211" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>category_colors.get(cat, <span class="st">'#BDC3C7'</span>),</span>
<span id="cb24-1212"><a href="#cb24-1212" aria-hidden="true" tabindex="-1"></a>                     s<span class="op">=</span><span class="dv">50</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, label<span class="op">=</span>cat, edgecolors<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-1213"><a href="#cb24-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1214"><a href="#cb24-1214" aria-hidden="true" tabindex="-1"></a>lim <span class="op">=</span> <span class="bu">max</span>(<span class="bu">abs</span>(oos_df[<span class="st">'is_return'</span>].<span class="bu">max</span>()), <span class="bu">abs</span>(oos_df[<span class="st">'oos_return'</span>].<span class="bu">max</span>())) <span class="op">*</span> <span class="dv">100</span> <span class="op">+</span> <span class="dv">2</span></span>
<span id="cb24-1215"><a href="#cb24-1215" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="op">-</span>lim, lim], <span class="st">'k--'</span>, linewidth<span class="op">=</span><span class="dv">1</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb24-1216"><a href="#cb24-1216" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="op">-</span>lim, lim], [<span class="dv">0</span>, <span class="dv">0</span>], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb24-1217"><a href="#cb24-1217" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot([<span class="dv">0</span>, <span class="dv">0</span>], [<span class="op">-</span>lim, lim], color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb24-1218"><a href="#cb24-1218" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'In-Sample Return (% ann.)'</span>)</span>
<span id="cb24-1219"><a href="#cb24-1219" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Out-of-Sample Return (% ann.)'</span>)</span>
<span id="cb24-1220"><a href="#cb24-1220" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: IS vs OOS Factor Returns'</span>)</span>
<span id="cb24-1221"><a href="#cb24-1221" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(fontsize<span class="op">=</span><span class="dv">7</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-1222"><a href="#cb24-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1223"><a href="#cb24-1223" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Decay by category</span></span>
<span id="cb24-1224"><a href="#cb24-1224" aria-hidden="true" tabindex="-1"></a>cat_decay <span class="op">=</span> (</span>
<span id="cb24-1225"><a href="#cb24-1225" aria-hidden="true" tabindex="-1"></a>    oos_df.groupby(<span class="st">'category'</span>)</span>
<span id="cb24-1226"><a href="#cb24-1226" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb24-1227"><a href="#cb24-1227" aria-hidden="true" tabindex="-1"></a>        median_decay<span class="op">=</span>(<span class="st">'decay_pct'</span>, <span class="st">'median'</span>),</span>
<span id="cb24-1228"><a href="#cb24-1228" aria-hidden="true" tabindex="-1"></a>        pct_same_sign<span class="op">=</span>(<span class="st">'same_sign'</span>, <span class="st">'mean'</span>),</span>
<span id="cb24-1229"><a href="#cb24-1229" aria-hidden="true" tabindex="-1"></a>        n<span class="op">=</span>(<span class="st">'signal'</span>, <span class="st">'count'</span>)</span>
<span id="cb24-1230"><a href="#cb24-1230" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-1231"><a href="#cb24-1231" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'median_decay'</span>)</span>
<span id="cb24-1232"><a href="#cb24-1232" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1233"><a href="#cb24-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1234"><a href="#cb24-1234" aria-hidden="true" tabindex="-1"></a>colors_bar <span class="op">=</span> [category_colors.get(cat, <span class="st">'#BDC3C7'</span>) <span class="cf">for</span> cat <span class="kw">in</span> cat_decay.index]</span>
<span id="cb24-1235"><a href="#cb24-1235" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].barh(<span class="bu">range</span>(<span class="bu">len</span>(cat_decay)), cat_decay[<span class="st">'median_decay'</span>],</span>
<span id="cb24-1236"><a href="#cb24-1236" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span>colors_bar, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb24-1237"><a href="#cb24-1237" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(cat_decay)))</span>
<span id="cb24-1238"><a href="#cb24-1238" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_yticklabels(cat_decay.index)</span>
<span id="cb24-1239"><a href="#cb24-1239" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Median OOS Decay (%)'</span>)</span>
<span id="cb24-1240"><a href="#cb24-1240" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: OOS Decay by Category'</span>)</span>
<span id="cb24-1241"><a href="#cb24-1241" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(x<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb24-1242"><a href="#cb24-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1243"><a href="#cb24-1243" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-1244"><a href="#cb24-1244" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-1245"><a href="#cb24-1245" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1246"><a href="#cb24-1246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1247"><a href="#cb24-1247" aria-hidden="true" tabindex="-1"></a><span class="fu">## Which Factors Survive? {#sec-factor-zoo-survivors}</span></span>
<span id="cb24-1248"><a href="#cb24-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1249"><a href="#cb24-1249" aria-hidden="true" tabindex="-1"></a><span class="fu">### A Multi-Hurdle Filter</span></span>
<span id="cb24-1250"><a href="#cb24-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1251"><a href="#cb24-1251" aria-hidden="true" tabindex="-1"></a>We now combine all the evidence, including multiple testing corrections, out-of-sample performance, and economic plausibility, to identify the factors that deserve credence in the Vietnamese market.</span>
<span id="cb24-1252"><a href="#cb24-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1255"><a href="#cb24-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1256"><a href="#cb24-1256" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multi-hurdle</span></span>
<span id="cb24-1257"><a href="#cb24-1257" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1258"><a href="#cb24-1258" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Apply a multi-hurdle filter to identify robust factors"</span></span>
<span id="cb24-1259"><a href="#cb24-1259" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all test results</span></span>
<span id="cb24-1260"><a href="#cb24-1260" aria-hidden="true" tabindex="-1"></a>final <span class="op">=</span> zoo_df.copy()</span>
<span id="cb24-1261"><a href="#cb24-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1262"><a href="#cb24-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Add OOS results</span></span>
<span id="cb24-1263"><a href="#cb24-1263" aria-hidden="true" tabindex="-1"></a>oos_lookup <span class="op">=</span> oos_df.set_index(<span class="st">'signal'</span>)</span>
<span id="cb24-1264"><a href="#cb24-1264" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'oos_return'</span>, <span class="st">'oos_t'</span>, <span class="st">'same_sign'</span>]:</span>
<span id="cb24-1265"><a href="#cb24-1265" aria-hidden="true" tabindex="-1"></a>    final[col] <span class="op">=</span> final.index.<span class="bu">map</span>(<span class="kw">lambda</span> x: oos_lookup.loc[x, col]</span>
<span id="cb24-1266"><a href="#cb24-1266" aria-hidden="true" tabindex="-1"></a>                                  <span class="cf">if</span> x <span class="kw">in</span> oos_lookup.index <span class="cf">else</span> np.nan)</span>
<span id="cb24-1267"><a href="#cb24-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1268"><a href="#cb24-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># Add bootstrap results</span></span>
<span id="cb24-1269"><a href="#cb24-1269" aria-hidden="true" tabindex="-1"></a>boot_lookup <span class="op">=</span> boot_results</span>
<span id="cb24-1270"><a href="#cb24-1270" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'boot_pval'</span>] <span class="op">=</span> final.index.<span class="bu">map</span>(</span>
<span id="cb24-1271"><a href="#cb24-1271" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: boot_lookup.loc[x, <span class="st">'boot_pval'</span>]</span>
<span id="cb24-1272"><a href="#cb24-1272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="kw">in</span> boot_lookup.index <span class="cf">else</span> np.nan</span>
<span id="cb24-1273"><a href="#cb24-1273" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1274"><a href="#cb24-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1275"><a href="#cb24-1275" aria-hidden="true" tabindex="-1"></a><span class="co"># Multi-hurdle criteria</span></span>
<span id="cb24-1276"><a href="#cb24-1276" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_t2'</span>] <span class="op">=</span> final[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">2.0</span></span>
<span id="cb24-1277"><a href="#cb24-1277" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_t3'</span>] <span class="op">=</span> final[<span class="st">'abs_t'</span>] <span class="op">&gt;</span> <span class="fl">3.0</span></span>
<span id="cb24-1278"><a href="#cb24-1278" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_bh'</span>] <span class="op">=</span> final[<span class="st">'bh_reject'</span>]</span>
<span id="cb24-1279"><a href="#cb24-1279" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_boot'</span>] <span class="op">=</span> final[<span class="st">'boot_pval'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span></span>
<span id="cb24-1280"><a href="#cb24-1280" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_oos_sign'</span>] <span class="op">=</span> final[<span class="st">'same_sign'</span>] <span class="op">==</span> <span class="va">True</span></span>
<span id="cb24-1281"><a href="#cb24-1281" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'pass_oos_t'</span>] <span class="op">=</span> final[<span class="st">'oos_t'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.5</span>  <span class="co"># Relaxed OOS threshold</span></span>
<span id="cb24-1282"><a href="#cb24-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1283"><a href="#cb24-1283" aria-hidden="true" tabindex="-1"></a><span class="co"># Count hurdles passed</span></span>
<span id="cb24-1284"><a href="#cb24-1284" aria-hidden="true" tabindex="-1"></a>hurdle_cols <span class="op">=</span> [<span class="st">'pass_t2'</span>, <span class="st">'pass_t3'</span>, <span class="st">'pass_bh'</span>, <span class="st">'pass_boot'</span>,</span>
<span id="cb24-1285"><a href="#cb24-1285" aria-hidden="true" tabindex="-1"></a>                <span class="st">'pass_oos_sign'</span>, <span class="st">'pass_oos_t'</span>]</span>
<span id="cb24-1286"><a href="#cb24-1286" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'n_hurdles'</span>] <span class="op">=</span> final[hurdle_cols].<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-1287"><a href="#cb24-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1288"><a href="#cb24-1288" aria-hidden="true" tabindex="-1"></a><span class="co"># "Robust" = passes at least 5 of 6 hurdles</span></span>
<span id="cb24-1289"><a href="#cb24-1289" aria-hidden="true" tabindex="-1"></a>final[<span class="st">'robust'</span>] <span class="op">=</span> final[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span></span>
<span id="cb24-1290"><a href="#cb24-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1291"><a href="#cb24-1291" aria-hidden="true" tabindex="-1"></a>robust_factors <span class="op">=</span> final[final[<span class="st">'robust'</span>]].sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-1292"><a href="#cb24-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1293"><a href="#cb24-1293" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Multi-Hurdle Filter Results:"</span>)</span>
<span id="cb24-1294"><a href="#cb24-1294" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass |t| &gt; 2.0:        </span><span class="sc">{</span>final[<span class="st">'pass_t2'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1295"><a href="#cb24-1295" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass |t| &gt; 3.0:        </span><span class="sc">{</span>final[<span class="st">'pass_t3'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1296"><a href="#cb24-1296" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass BH (q=0.05):      </span><span class="sc">{</span>final[<span class="st">'pass_bh'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1297"><a href="#cb24-1297" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass bootstrap:        </span><span class="sc">{</span>final[<span class="st">'pass_boot'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1298"><a href="#cb24-1298" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass OOS sign:         </span><span class="sc">{</span>final[<span class="st">'pass_oos_sign'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1299"><a href="#cb24-1299" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Pass OOS |t| &gt; 1.5:    </span><span class="sc">{</span>final[<span class="st">'pass_oos_t'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1300"><a href="#cb24-1300" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  ROBUST (‚â•5/6 hurdles): </span><span class="sc">{</span>final[<span class="st">'robust'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-1301"><a href="#cb24-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1302"><a href="#cb24-1302" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(robust_factors) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-1303"><a href="#cb24-1303" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Robust Factors:"</span>)</span>
<span id="cb24-1304"><a href="#cb24-1304" aria-hidden="true" tabindex="-1"></a>    display_cols <span class="op">=</span> [<span class="st">'ann_return'</span>, <span class="st">'t_stat'</span>, <span class="st">'bh_p_corrected'</span>,</span>
<span id="cb24-1305"><a href="#cb24-1305" aria-hidden="true" tabindex="-1"></a>                     <span class="st">'oos_return'</span>, <span class="st">'oos_t'</span>, <span class="st">'n_hurdles'</span>, <span class="st">'category'</span>]</span>
<span id="cb24-1306"><a href="#cb24-1306" aria-hidden="true" tabindex="-1"></a>    available_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> display_cols <span class="cf">if</span> c <span class="kw">in</span> robust_factors.columns]</span>
<span id="cb24-1307"><a href="#cb24-1307" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(robust_factors[available_cols].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb24-1308"><a href="#cb24-1308" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1309"><a href="#cb24-1309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1312"><a href="#cb24-1312" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1313"><a href="#cb24-1313" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hurdle-heatmap</span></span>
<span id="cb24-1314"><a href="#cb24-1314" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1315"><a href="#cb24-1315" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Multi-hurdle test results for the top 25 anomalies ranked by in-sample t-statistic. Each column represents a statistical hurdle; green cells indicate passage, red cells indicate failure. Only anomalies that survive multiple independent tests deserve serious consideration. The rightmost column tallies hurdles passed."</span></span>
<span id="cb24-1316"><a href="#cb24-1316" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Heatmap of multi-hurdle results"</span></span>
<span id="cb24-1317"><a href="#cb24-1317" aria-hidden="true" tabindex="-1"></a>top25 <span class="op">=</span> final.sort_values(<span class="st">'abs_t'</span>, ascending<span class="op">=</span><span class="va">False</span>).head(<span class="dv">25</span>)</span>
<span id="cb24-1318"><a href="#cb24-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1319"><a href="#cb24-1319" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb24-1320"><a href="#cb24-1320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1321"><a href="#cb24-1321" aria-hidden="true" tabindex="-1"></a>hurdle_matrix <span class="op">=</span> top25[hurdle_cols].astype(<span class="bu">float</span>).values</span>
<span id="cb24-1322"><a href="#cb24-1322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1323"><a href="#cb24-1323" aria-hidden="true" tabindex="-1"></a>sns.heatmap(hurdle_matrix, ax<span class="op">=</span>ax,</span>
<span id="cb24-1324"><a href="#cb24-1324" aria-hidden="true" tabindex="-1"></a>            xticklabels<span class="op">=</span>[<span class="st">'|t|&gt;2'</span>, <span class="st">'|t|&gt;3'</span>, <span class="st">'BH'</span>, <span class="st">'Boot'</span>, <span class="st">'OOS sign'</span>, <span class="st">'OOS |t|'</span>],</span>
<span id="cb24-1325"><a href="#cb24-1325" aria-hidden="true" tabindex="-1"></a>            yticklabels<span class="op">=</span>top25.index,</span>
<span id="cb24-1326"><a href="#cb24-1326" aria-hidden="true" tabindex="-1"></a>            cmap<span class="op">=</span>[<span class="st">'#E74C3C'</span>, <span class="st">'#27AE60'</span>],</span>
<span id="cb24-1327"><a href="#cb24-1327" aria-hidden="true" tabindex="-1"></a>            cbar<span class="op">=</span><span class="va">False</span>, linewidths<span class="op">=</span><span class="fl">0.5</span>, linecolor<span class="op">=</span><span class="st">'white'</span>,</span>
<span id="cb24-1328"><a href="#cb24-1328" aria-hidden="true" tabindex="-1"></a>            annot<span class="op">=</span>np.where(hurdle_matrix <span class="op">==</span> <span class="dv">1</span>, <span class="st">'‚úì'</span>, <span class="st">'‚úó'</span>),</span>
<span id="cb24-1329"><a href="#cb24-1329" aria-hidden="true" tabindex="-1"></a>            fmt<span class="op">=</span><span class="st">''</span>)</span>
<span id="cb24-1330"><a href="#cb24-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1331"><a href="#cb24-1331" aria-hidden="true" tabindex="-1"></a><span class="co"># Add hurdle count column</span></span>
<span id="cb24-1332"><a href="#cb24-1332" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (_, row) <span class="kw">in</span> <span class="bu">enumerate</span>(top25.iterrows()):</span>
<span id="cb24-1333"><a href="#cb24-1333" aria-hidden="true" tabindex="-1"></a>    ax.text(<span class="bu">len</span>(hurdle_cols) <span class="op">+</span> <span class="fl">0.3</span>, i <span class="op">+</span> <span class="fl">0.5</span>,</span>
<span id="cb24-1334"><a href="#cb24-1334" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(row[<span class="st">'n_hurdles'</span>])<span class="sc">}</span><span class="ss">/6"</span>,</span>
<span id="cb24-1335"><a href="#cb24-1335" aria-hidden="true" tabindex="-1"></a>            va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">9</span>,</span>
<span id="cb24-1336"><a href="#cb24-1336" aria-hidden="true" tabindex="-1"></a>            fontweight<span class="op">=</span><span class="st">'bold'</span> <span class="cf">if</span> row[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span> <span class="cf">else</span> <span class="st">'normal'</span>,</span>
<span id="cb24-1337"><a href="#cb24-1337" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#27AE60'</span> <span class="cf">if</span> row[<span class="st">'n_hurdles'</span>] <span class="op">&gt;=</span> <span class="dv">5</span> <span class="cf">else</span> <span class="st">'#C0392B'</span>)</span>
<span id="cb24-1338"><a href="#cb24-1338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1339"><a href="#cb24-1339" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Multi-Hurdle Test Results (Top 25 Anomalies)'</span>)</span>
<span id="cb24-1340"><a href="#cb24-1340" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb24-1341"><a href="#cb24-1341" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb24-1342"><a href="#cb24-1342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1343"><a href="#cb24-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1344"><a href="#cb24-1344" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implications for Vietnamese Factor Research {#sec-factor-zoo-implications}</span></span>
<span id="cb24-1345"><a href="#cb24-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1346"><a href="#cb24-1346" aria-hidden="true" tabindex="-1"></a>The analysis in this chapter yields several practical implications:</span>
<span id="cb24-1347"><a href="#cb24-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1348"><a href="#cb24-1348" aria-hidden="true" tabindex="-1"></a>**The conventional threshold is insufficient.** With $M \approx 50$ anomalies tested simultaneously, requiring only $|t| &gt; 2.0$ virtually guarantees false discoveries. Vietnamese researchers should adopt a minimum threshold of $|t| &gt; 3.0$ for individual factors, consistent with @harvey2016and, and should report BH-adjusted p-values for any study testing multiple signals.</span>
<span id="cb24-1349"><a href="#cb24-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1350"><a href="#cb24-1350" aria-hidden="true" tabindex="-1"></a>**The small cross-section amplifies noise.** With 600-800 stocks, quintile portfolios contain only 120-160 stocks each. This creates noisier portfolio returns and wider confidence intervals than in U.S. studies with 4,000+ stocks. Strategies that appear significant in the U.S. at $|t| = 2.5$ may have $|t| &lt; 1.5$ in Vietnam simply due to the smaller sample. This is not evidence that the factor doesn't exist in Vietnam, it is evidence that the Vietnamese data lack power to detect it.</span>
<span id="cb24-1351"><a href="#cb24-1351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1352"><a href="#cb24-1352" aria-hidden="true" tabindex="-1"></a>**Out-of-sample validation is essential.** The time-series split reveals substantial decay for many anomalies, consistent with @mclean2016does. Factors that survive both in-sample and out-of-sample with consistent sign and magnitude are rare and valuable.</span>
<span id="cb24-1353"><a href="#cb24-1353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1354"><a href="#cb24-1354" aria-hidden="true" tabindex="-1"></a>**Category matters.** Momentum and profitability signals tend to have the highest replication rates across markets <span class="co">[</span><span class="ot">@fama2012size; @jacobs2020anomalies</span><span class="co">]</span>. Value and investment signals are more country-specific <span class="co">[</span><span class="ot">@griffin2002fama</span><span class="co">]</span>. Liquidity signals are likely to be strongest in emerging markets like Vietnam, where trading frictions are largest.</span>
<span id="cb24-1355"><a href="#cb24-1355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1356"><a href="#cb24-1356" aria-hidden="true" tabindex="-1"></a>**Report the full battery.** Any study that presents a new factor for the Vietnamese market should report: (i) the raw t-statistic, (ii) the BH-adjusted p-value given the number of tests in the study, (iii) out-of-sample performance in a held-out period, and (iv) sensitivity to construction choices (from the previous chapter). This reporting standard would dramatically improve the credibility of Vietnamese factor research.</span>
<span id="cb24-1357"><a href="#cb24-1357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1358"><a href="#cb24-1358" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary {#sec-factor-zoo-summary}</span></span>
<span id="cb24-1359"><a href="#cb24-1359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1360"><a href="#cb24-1360" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Method <span class="pp">|</span> Controls <span class="pp">|</span> Threshold (approx.) <span class="pp">|</span> Surviving <span class="pp">|</span> Philosophy <span class="pp">|</span></span>
<span id="cb24-1361"><a href="#cb24-1361" aria-hidden="true" tabindex="-1"></a><span class="pp">|---------------|---------------|---------------|---------------|---------------|</span></span>
<span id="cb24-1362"><a href="#cb24-1362" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Unadjusted <span class="pp">|</span> Single test <span class="pp">|</span> <span class="sc">\|</span>t<span class="sc">\|</span> <span class="sc">\&gt;</span> 2.0 <span class="pp">|</span> Many <span class="pp">|</span> No correction <span class="pp">|</span></span>
<span id="cb24-1363"><a href="#cb24-1363" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Bonferroni <span class="pp">|</span> FWER <span class="pp">|</span> <span class="sc">\|</span>t<span class="sc">\|</span> <span class="sc">\&gt;</span> 3.3--4.0 <span class="pp">|</span> Few <span class="pp">|</span> Zero false positives <span class="pp">|</span></span>
<span id="cb24-1364"><a href="#cb24-1364" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Holm <span class="pp">|</span> FWER <span class="pp">|</span> Stepwise <span class="pp">|</span> Few <span class="pp">|</span> Slightly less conservative <span class="pp">|</span></span>
<span id="cb24-1365"><a href="#cb24-1365" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> BH <span class="pp">|</span> FDR at q <span class="pp">|</span> Adaptive <span class="pp">|</span> Moderate <span class="pp">|</span> Tolerates some false positives <span class="pp">|</span></span>
<span id="cb24-1366"><a href="#cb24-1366" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> HLZ <span class="pp">|</span> Profession-wide <span class="pp">|</span> <span class="sc">\|</span>t<span class="sc">\|</span> <span class="sc">\&gt;</span> 3.0--3.78 <span class="pp">|</span> Moderate <span class="pp">|</span> Prior over all tested factors <span class="pp">|</span></span>
<span id="cb24-1367"><a href="#cb24-1367" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> White/RW Bootstrap <span class="pp">|</span> FWER (data-driven) <span class="pp">|</span> Bootstrap CV <span class="pp">|</span> Few <span class="pp">|</span> Accounts for non-normality <span class="pp">|</span></span>
<span id="cb24-1368"><a href="#cb24-1368" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Storey FDP <span class="pp">|</span> FDP estimate <span class="pp">|</span> Continuous <span class="pp">|</span> Diagnostic <span class="pp">|</span> Estimates true null proportion <span class="pp">|</span></span>
<span id="cb24-1369"><a href="#cb24-1369" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Multi-hurdle <span class="pp">|</span> Combined <span class="pp">|</span> Multiple tests <span class="pp">|</span> Most robust <span class="pp">|</span> Requires convergent evidence <span class="pp">|</span></span>
<span id="cb24-1370"><a href="#cb24-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1371"><a href="#cb24-1371" aria-hidden="true" tabindex="-1"></a>: Summary of multiple testing methods and their properties. {#tbl-summary}</span>
<span id="cb24-1372"><a href="#cb24-1372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1373"><a href="#cb24-1373" aria-hidden="true" tabindex="-1"></a>The factor zoo is not a uniquely American phenomenon. The temptation to test many signals and report the best-performing ones exists in every market. In Vietnam, where the data are shorter, noisier, and the academic community is growing rapidly, the risk of false discovery is high. The tools developed in this chapter, including BH adjustment, bootstrap reality checks, Storey's $\pi_0$ estimation, out-of-sample splits, and the multi-hurdle filter, provide a principled framework for separating genuine factors from statistical noise.</span>
<span id="cb24-1374"><a href="#cb24-1374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1375"><a href="#cb24-1375" aria-hidden="true" tabindex="-1"></a>The honest conclusion is likely to be humbling: of the dozens of anomalies documented in developed markets, only a handful survive rigorous multiple testing in Vietnamese data. Those survivors (probably concentrated in momentum, profitability, and liquidity) form the foundation for credible asset pricing research in this market.</span>
<span id="cb24-1376"><a href="#cb24-1376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1377"><a href="#cb24-1377" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises {#sec-factor-zoo-exercises}</span></span>
<span id="cb24-1378"><a href="#cb24-1378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1379"><a href="#cb24-1379" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Bayesian approach.** Implement the @harvey2021lucky Bayesian framework for distinguishing lucky factors from genuine ones. Assign a prior probability $\pi$ that any given factor is a true predictor, and compute the posterior probability of being genuine given its t-statistic and the number of tests. How does varying $\pi$ affect which factors survive?</span></span>
<span id="cb24-1380"><a href="#cb24-1380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1381"><a href="#cb24-1381" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Dependence-adjusted BH.** The standard BH procedure assumes independent (or PRDS) test statistics. Estimate the correlation structure of factor returns and implement the Benjamini-Yekutieli (BY) procedure, which controls FDR under arbitrary dependence. How many fewer factors survive compared to BH?</span></span>
<span id="cb24-1382"><a href="#cb24-1382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1383"><a href="#cb24-1383" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Publication bias simulation.** Simulate a researcher who tests 100 random signals on Vietnamese data, publishes only those with $|t| &gt; 2$, and reports the average published t-statistic. Repeat 1,000 times. What is the distribution of the "published" t-statistic? How does it compare to the true effect size (which is zero by construction)?</span></span>
<span id="cb24-1384"><a href="#cb24-1384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1385"><a href="#cb24-1385" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Replication across exchanges.** Test whether factors that are significant on HOSE also replicate on HNX. If the same factor is significant on both exchanges independently, the probability of a false discovery is substantially lower (because the two samples are partially independent).</span></span>
<span id="cb24-1386"><a href="#cb24-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1387"><a href="#cb24-1387" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Transaction cost hurdle.** For each factor that survives the multi-hurdle filter, compute the minimum round-trip trading cost that would eliminate the net-of-cost premium. Factors whose breakeven costs are below realistic Vietnamese transaction costs are not implementable, regardless of their statistical significance.</span></span>
<span id="cb24-1388"><a href="#cb24-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1389"><a href="#cb24-1389" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Machine learning feature importance.** Use a random forest or gradient-boosted tree model to predict next-month returns from all available signals simultaneously. Extract feature importance measures. Compare the machine learning ranking of signals to the univariate t-statistic ranking. Do they agree?</span></span>
<span id="cb24-1390"><a href="#cb24-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1391"><a href="#cb24-1391" aria-hidden="true" tabindex="-1"></a><span class="co">7.  **International replication.** Select the top 10 factors from the Vietnamese zoo. Test whether the same factors are significant in Thailand (SET), Indonesia (IDX), or the Philippines (PSE) using equivalent data. Factors that replicate across multiple ASEAN markets are less likely to be country-specific data artifacts.</span></span>
<span id="cb24-1392"><a href="#cb24-1392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1393"><a href="#cb24-1393" aria-hidden="true" tabindex="-1"></a><span class="co">8.  **Rolling FDP monitoring.** Implement a rolling-window version of the Storey $\pi_0$ estimator. Compute $\hat{\pi}_0$ for each 60-month window. Does the proportion of true factors change over time? An increasing $\pi_0$ (more true nulls) might indicate that anomalies are being arbitraged away as the Vietnamese market matures. --&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/25_factor_zoo_and_multiple_testing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>