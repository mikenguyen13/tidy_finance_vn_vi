<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>8&nbsp; Beta Estimation – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03_capm.html" rel="next">
<link href="./09_univariate_portfolio_sort.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="8&nbsp; Beta Estimation – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/mikenguyen13/tidy_finance_vn/08_beta_estimation_files/figure-html/fig-beta-coverage-output-1.png">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta property="og:image:alt" content="Line chart showing the percentage of stocks with beta estimates available each month.">
<meta property="og:image:height" content="960">
<meta property="og:image:width" content="1344">
<meta name="twitter:title" content="8&nbsp; Beta Estimation – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://github.com/mikenguyen13/tidy_finance_vn/08_beta_estimation_files/figure-html/fig-beta-coverage-output-1.png">
<meta name="twitter:image:alt" content="Line chart showing the percentage of stocks with beta estimates available each month.">
<meta name="twitter:image-height" content="960">
<meta name="twitter:image-width" content="1344">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02_modern_portfolio_theory.html">Portfolio Construction, Risk, and Empirical Mechanics</a></li><li class="breadcrumb-item"><a href="./08_beta_estimation.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_beta_estimation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Data, Research Design, and Frontiers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#theoretical-foundation" id="toc-theoretical-foundation" class="nav-link active" data-scroll-target="#theoretical-foundation"><span class="header-section-number">8.1</span> Theoretical Foundation</a>
  <ul class="collapse">
  <li><a href="#the-capital-asset-pricing-model" id="toc-the-capital-asset-pricing-model" class="nav-link" data-scroll-target="#the-capital-asset-pricing-model"><span class="header-section-number">8.1.1</span> The Capital Asset Pricing Model</a></li>
  <li><a href="#empirical-implementation" id="toc-empirical-implementation" class="nav-link" data-scroll-target="#empirical-implementation"><span class="header-section-number">8.1.2</span> Empirical Implementation</a></li>
  </ul></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment"><span class="header-section-number">8.2</span> Setting Up the Environment</a></li>
  <li><a href="#loading-and-preparing-data" id="toc-loading-and-preparing-data" class="nav-link" data-scroll-target="#loading-and-preparing-data"><span class="header-section-number">8.3</span> Loading and Preparing Data</a>
  <ul class="collapse">
  <li><a href="#stock-returns-data" id="toc-stock-returns-data" class="nav-link" data-scroll-target="#stock-returns-data"><span class="header-section-number">8.3.1</span> Stock Returns Data</a></li>
  <li><a href="#company-information" id="toc-company-information" class="nav-link" data-scroll-target="#company-information"><span class="header-section-number">8.3.2</span> Company Information</a></li>
  <li><a href="#market-excess-returns" id="toc-market-excess-returns" class="nav-link" data-scroll-target="#market-excess-returns"><span class="header-section-number">8.3.3</span> Market Excess Returns</a></li>
  <li><a href="#merging-datasets" id="toc-merging-datasets" class="nav-link" data-scroll-target="#merging-datasets"><span class="header-section-number">8.3.4</span> Merging Datasets</a></li>
  <li><a href="#handling-outliers" id="toc-handling-outliers" class="nav-link" data-scroll-target="#handling-outliers"><span class="header-section-number">8.3.5</span> Handling Outliers</a></li>
  </ul></li>
  <li><a href="#estimating-beta-for-individual-stocks" id="toc-estimating-beta-for-individual-stocks" class="nav-link" data-scroll-target="#estimating-beta-for-individual-stocks"><span class="header-section-number">8.4</span> Estimating Beta for Individual Stocks</a>
  <ul class="collapse">
  <li><a href="#single-stock-example" id="toc-single-stock-example" class="nav-link" data-scroll-target="#single-stock-example"><span class="header-section-number">8.4.1</span> Single Stock Example</a></li>
  <li><a href="#capm-estimation-function" id="toc-capm-estimation-function" class="nav-link" data-scroll-target="#capm-estimation-function"><span class="header-section-number">8.4.2</span> CAPM Estimation Function</a></li>
  </ul></li>
  <li><a href="#rolling-window-estimation" id="toc-rolling-window-estimation" class="nav-link" data-scroll-target="#rolling-window-estimation"><span class="header-section-number">8.5</span> Rolling-Window Estimation</a>
  <ul class="collapse">
  <li><a href="#motivation-for-rolling-windows" id="toc-motivation-for-rolling-windows" class="nav-link" data-scroll-target="#motivation-for-rolling-windows"><span class="header-section-number">8.5.1</span> Motivation for Rolling Windows</a></li>
  <li><a href="#rolling-window-implementation" id="toc-rolling-window-implementation" class="nav-link" data-scroll-target="#rolling-window-implementation"><span class="header-section-number">8.5.2</span> Rolling Window Implementation</a></li>
  <li><a href="#example-rolling-betas-for-selected-stocks" id="toc-example-rolling-betas-for-selected-stocks" class="nav-link" data-scroll-target="#example-rolling-betas-for-selected-stocks"><span class="header-section-number">8.5.3</span> Example: Rolling Betas for Selected Stocks</a></li>
  <li><a href="#visualizing-rolling-betas" id="toc-visualizing-rolling-betas" class="nav-link" data-scroll-target="#visualizing-rolling-betas"><span class="header-section-number">8.5.4</span> Visualizing Rolling Betas</a></li>
  </ul></li>
  <li><a href="#parallelized-estimation-for-the-full-market" id="toc-parallelized-estimation-for-the-full-market" class="nav-link" data-scroll-target="#parallelized-estimation-for-the-full-market"><span class="header-section-number">8.6</span> Parallelized Estimation for the Full Market</a>
  <ul class="collapse">
  <li><a href="#the-computational-challenge" id="toc-the-computational-challenge" class="nav-link" data-scroll-target="#the-computational-challenge"><span class="header-section-number">8.6.1</span> The Computational Challenge</a></li>
  <li><a href="#setting-up-parallel-processing" id="toc-setting-up-parallel-processing" class="nav-link" data-scroll-target="#setting-up-parallel-processing"><span class="header-section-number">8.6.2</span> Setting Up Parallel Processing</a></li>
  <li><a href="#parallel-beta-estimation" id="toc-parallel-beta-estimation" class="nav-link" data-scroll-target="#parallel-beta-estimation"><span class="header-section-number">8.6.3</span> Parallel Beta Estimation</a></li>
  <li><a href="#storing-results" id="toc-storing-results" class="nav-link" data-scroll-target="#storing-results"><span class="header-section-number">8.6.4</span> Storing Results</a></li>
  </ul></li>
  <li><a href="#beta-estimation-using-daily-returns" id="toc-beta-estimation-using-daily-returns" class="nav-link" data-scroll-target="#beta-estimation-using-daily-returns"><span class="header-section-number">8.7</span> Beta Estimation Using Daily Returns</a>
  <ul class="collapse">
  <li><a href="#batch-processing-for-daily-data" id="toc-batch-processing-for-daily-data" class="nav-link" data-scroll-target="#batch-processing-for-daily-data"><span class="header-section-number">8.7.1</span> Batch Processing for Daily Data</a></li>
  </ul></li>
  <li><a href="#analyzing-beta-estimates" id="toc-analyzing-beta-estimates" class="nav-link" data-scroll-target="#analyzing-beta-estimates"><span class="header-section-number">8.8</span> Analyzing Beta Estimates</a>
  <ul class="collapse">
  <li><a href="#extracting-beta-estimates" id="toc-extracting-beta-estimates" class="nav-link" data-scroll-target="#extracting-beta-estimates"><span class="header-section-number">8.8.1</span> Extracting Beta Estimates</a></li>
  <li><a href="#summary-statistics" id="toc-summary-statistics" class="nav-link" data-scroll-target="#summary-statistics"><span class="header-section-number">8.8.2</span> Summary Statistics</a></li>
  <li><a href="#beta-distribution-across-industries" id="toc-beta-distribution-across-industries" class="nav-link" data-scroll-target="#beta-distribution-across-industries"><span class="header-section-number">8.8.3</span> Beta Distribution Across Industries</a></li>
  <li><a href="#time-variation-in-cross-sectional-beta-distribution" id="toc-time-variation-in-cross-sectional-beta-distribution" class="nav-link" data-scroll-target="#time-variation-in-cross-sectional-beta-distribution"><span class="header-section-number">8.8.4</span> Time Variation in Cross-Sectional Beta Distribution</a></li>
  <li><a href="#coverage-analysis" id="toc-coverage-analysis" class="nav-link" data-scroll-target="#coverage-analysis"><span class="header-section-number">8.8.5</span> Coverage Analysis</a></li>
  </ul></li>
  <li><a href="#comparing-monthly-and-daily-beta-estimates" id="toc-comparing-monthly-and-daily-beta-estimates" class="nav-link" data-scroll-target="#comparing-monthly-and-daily-beta-estimates"><span class="header-section-number">8.9</span> Comparing Monthly and Daily Beta Estimates</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">8.10</span> Key Takeaways</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/08_beta_estimation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./02_modern_portfolio_theory.html">Portfolio Construction, Risk, and Empirical Mechanics</a></li><li class="breadcrumb-item"><a href="./08_beta_estimation.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Beta Estimation</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter introduces one of the most fundamental concepts in financial economics: the exposure of an individual stock to systematic market risk. According to the Capital Asset Pricing Model (CAPM) developed by <span class="citation" data-cites="Sharpe1964">Sharpe (<a href="references.html#ref-Sharpe1964" role="doc-biblioref">1964</a>)</span>, <span class="citation" data-cites="Lintner1965">Lintner (<a href="references.html#ref-Lintner1965" role="doc-biblioref">1965</a>)</span>, and <span class="citation" data-cites="Mossin1966">Mossin (<a href="references.html#ref-Mossin1966" role="doc-biblioref">1966</a>)</span>, cross-sectional variation in expected asset returns should be determined by the covariance between an asset’s excess return and the excess return on the market portfolio. The regression coefficient that captures this relationship (commonly known as market beta) serves as the cornerstone of modern portfolio theory and remains widely used in practice for cost of capital estimation, performance attribution, and risk management.</p>
<p>In this chapter, we develop a complete framework for estimating market betas for Vietnamese stocks. We begin with a conceptual overview of the CAPM and its empirical implementation. We then demonstrate beta estimation using ordinary least squares regression, first for individual stocks and then scaled to the entire market using rolling-window estimation. To handle the computational demands of estimating betas for hundreds of stocks across many time periods, we introduce parallelization techniques that dramatically reduce processing time. Finally, we compare beta estimates derived from monthly versus daily returns and examine how betas vary across industries and over time in the Vietnamese market.</p>
<p>The chapter leverages several important computational concepts that extend beyond beta estimation itself. Rolling-window estimation is a technique applicable to any time-varying parameter, while parallelization provides a general solution for computationally intensive tasks that can be divided into independent subtasks.</p>
<section id="theoretical-foundation" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="theoretical-foundation"><span class="header-section-number">8.1</span> Theoretical Foundation</h2>
<section id="the-capital-asset-pricing-model" class="level3" data-number="8.1.1">
<h3 data-number="8.1.1" class="anchored" data-anchor-id="the-capital-asset-pricing-model"><span class="header-section-number">8.1.1</span> The Capital Asset Pricing Model</h3>
<p>The CAPM provides a theoretical framework linking expected returns to systematic risk. Under the model’s assumptions—including mean-variance optimizing investors, homogeneous expectations, and frictionless markets—the expected excess return on any asset <span class="math inline">\(i\)</span> is proportional to its covariance with the market portfolio:</p>
<p><span class="math display">\[
E[r_i - r_f] = \beta_i \cdot E[r_m - r_f]
\]</span></p>
<p>where <span class="math inline">\(r_i\)</span> is the return on asset <span class="math inline">\(i\)</span>, <span class="math inline">\(r_f\)</span> is the risk-free rate, <span class="math inline">\(r_m\)</span> is the return on the market portfolio, and <span class="math inline">\(\beta_i\)</span> is defined as:</p>
<p><span class="math display">\[
\beta_i = \frac{\text{Cov}(r_i, r_m)}{\text{Var}(r_m)}
\]</span></p>
<p>The market beta <span class="math inline">\(\beta_i\)</span> measures the sensitivity of asset <span class="math inline">\(i\)</span>’s returns to market movements. A beta greater than one indicates the asset amplifies market movements, while a beta less than one indicates dampened sensitivity. A beta of zero would imply no systematic risk exposure, leaving only idiosyncratic risk that can be diversified away.</p>
</section>
<section id="empirical-implementation" class="level3" data-number="8.1.2">
<h3 data-number="8.1.2" class="anchored" data-anchor-id="empirical-implementation"><span class="header-section-number">8.1.2</span> Empirical Implementation</h3>
<p>In practice, we estimate beta by regressing excess stock returns on excess market returns:</p>
<p><span id="eq-capm-regression"><span class="math display">\[
r_{i,t} - r_{f,t} = \alpha_i + \beta_i(r_{m,t} - r_{f,t}) + \varepsilon_{i,t}
\tag{8.1}\]</span></span></p>
<p>where <span class="math inline">\(\alpha_i\)</span> represents abnormal return (Jensen’s alpha), <span class="math inline">\(\beta_i\)</span> is the market beta we seek to estimate, and <span class="math inline">\(\varepsilon_{i,t}\)</span> is the idiosyncratic error term. Under the CAPM, <span class="math inline">\(\alpha_i\)</span> should equal zero for all assets—any non-zero alpha represents a deviation from the model’s predictions.</p>
<p>Several practical considerations affect beta estimation:</p>
<ol type="1">
<li><p><strong>Estimation Window</strong>: Longer windows provide more observations and thus more precise estimates, but may include outdated information if betas change over time. Common choices range from 36 to 60 months for monthly data.</p></li>
<li><p><strong>Return Frequency</strong>: Monthly returns reduce noise but provide fewer observations. Daily returns offer more data points but may introduce microstructure effects and non-synchronous trading biases.</p></li>
<li><p><strong>Market Proxy</strong>: The theoretical market portfolio includes all assets, but in practice we use a broad equity index. For Vietnam, we use the value-weighted market return constructed from our stock universe.</p></li>
<li><p><strong>Minimum Observations</strong>: Requiring a minimum number of observations (e.g., 48 out of 60 months) helps avoid unreliable estimates from sparse data.</p></li>
</ol>
</section>
</section>
<section id="setting-up-the-environment" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="setting-up-the-environment"><span class="header-section-number">8.2</span> Setting Up the Environment</h2>
<p>We begin by loading the necessary Python packages. The core packages handle data manipulation, statistical modeling, and database operations. We also import parallelization tools that will be essential when scaling our estimation to the full market.</p>
<div id="b604d6ab" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats.mstats <span class="im">import</span> winsorize</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed, cpu_count</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We connect to our SQLite database containing the processed Vietnamese financial data from previous chapters.</p>
<div id="2e692dac" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="loading-and-preparing-data" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="loading-and-preparing-data"><span class="header-section-number">8.3</span> Loading and Preparing Data</h2>
<section id="stock-returns-data" class="level3" data-number="8.3.1">
<h3 data-number="8.3.1" class="anchored" data-anchor-id="stock-returns-data"><span class="header-section-number">8.3.1</span> Stock Returns Data</h3>
<p>We load the monthly stock returns data prepared in the Datacore chapter. The data includes excess returns (returns minus the risk-free rate) for all Vietnamese listed stocks.</p>
<div id="6dec0062" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess </span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add year for merging with fundamentals</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"year"</span>] <span class="op">=</span> prices_monthly[<span class="st">"date"</span>].dt.year</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> monthly observations"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Covering </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss"> unique stocks"</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 209,495 monthly observations
Covering 1,837 unique stocks
Date range: 2010-01 to 2025-05</code></pre>
</div>
</div>
<div id="3c8db2eb" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_daily</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="company-information" class="level3" data-number="8.3.2">
<h3 data-number="8.3.2" class="anchored" data-anchor-id="company-information"><span class="header-section-number">8.3.2</span> Company Information</h3>
<p>We load company information to enable industry-level analysis of beta estimates.</p>
<div id="ad2bcc25" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, datadate, icb_name_vi </span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM comp_vn</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"datadate"</span>}</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year for merging</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>comp_vn[<span class="st">"year"</span>] <span class="op">=</span> comp_vn[<span class="st">"datadate"</span>].dt.year</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Company data: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss"> firms"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Company data: 1,502 firms</code></pre>
</div>
</div>
</section>
<section id="market-excess-returns" class="level3" data-number="8.3.3">
<h3 data-number="8.3.3" class="anchored" data-anchor-id="market-excess-returns"><span class="header-section-number">8.3.3</span> Market Excess Returns</h3>
<p>For the market portfolio proxy, we use the value-weighted market excess return. If you have constructed Fama-French factors in a previous chapter, load them here. Otherwise, we can construct a simple market return from our stock data.</p>
<div id="fae5d2ee" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 1: Load pre-computed market factor</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess FROM factors_ff3_monthly"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 2: Construct market return from stock data (if factors not available)</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># This computes the value-weighted average return across all stocks</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_return(prices_df):</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted market return from individual stock returns.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_df : pd.DataFrame</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock returns with mktcap_lag for weighting</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly market excess returns</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    market_return <span class="op">=</span> (prices_df</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"mkt_excess"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_return</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="merging-datasets" class="level3" data-number="8.3.4">
<h3 data-number="8.3.4" class="anchored" data-anchor-id="merging-datasets"><span class="header-section-number">8.3.4</span> Merging Datasets</h3>
<p>We combine the stock returns with market returns and company information to create our estimation dataset.</p>
<div id="dbd9891e" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge stock returns with market returns</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    factors_ff3_monthly, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with company information for industry classification</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"icb_name_vi"</span>]], </span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing data</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>])</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final estimation sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final estimation sample: 169,983 observations</code></pre>
</div>
</div>
</section>
<section id="handling-outliers" class="level3" data-number="8.3.5">
<h3 data-number="8.3.5" class="anchored" data-anchor-id="handling-outliers"><span class="header-section-number">8.3.5</span> Handling Outliers</h3>
<p>Extreme returns can unduly influence regression estimates. We apply winsorization to limit the impact of outliers while preserving the general distribution of returns. Winsorization at the 1% level replaces values below the 1st percentile with the 1st percentile value, and values above the 99th percentile with the 99th percentile value.</p>
<div id="5828fe36" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> winsorize_returns(df, columns, limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply winsorization to return columns to limit outlier influence.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame containing return columns</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    columns : list</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Column names to winsorize</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    limits : tuple</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Lower and upper percentile limits for winsorization</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with winsorized columns</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columns:</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> winsorize(df[col], limits<span class="op">=</span>limits)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> winsorize_returns(</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    prices_monthly, </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>],</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Return distributions after winsorization:"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Return distributions after winsorization:
        ret_excess   mkt_excess
count  169983.0000  169983.0000
mean        0.0011      -0.0102
std         0.1548       0.0579
min        -0.4078      -0.1794
25%        -0.0700      -0.0384
50%        -0.0033      -0.0084
75%         0.0531       0.0219
max         0.6117       0.1221</code></pre>
</div>
</div>
</section>
</section>
<section id="estimating-beta-for-individual-stocks" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="estimating-beta-for-individual-stocks"><span class="header-section-number">8.4</span> Estimating Beta for Individual Stocks</h2>
<section id="single-stock-example" class="level3" data-number="8.4.1">
<h3 data-number="8.4.1" class="anchored" data-anchor-id="single-stock-example"><span class="header-section-number">8.4.1</span> Single Stock Example</h3>
<p>Before scaling to the full market, we demonstrate beta estimation for a single well-known Vietnamese stock. We use Vingroup (VIC), one of the largest conglomerates in Vietnam with significant exposure to real estate, retail, and automotive sectors.</p>
<div id="484778d9" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for Vingroup</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>vic_data <span class="op">=</span> prices_monthly.query(<span class="st">"symbol == 'VIC'"</span>).copy()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"VIC observations: </span><span class="sc">{</span><span class="bu">len</span>(vic_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>vic_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>vic_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>VIC observations: 150
Date range: 2011-07 to 2023-12</code></pre>
</div>
</div>
<p>We estimate the CAPM regression using ordinary least squares via the <code>statsmodels</code> package. The formula interface provides a convenient way to specify regression models.</p>
<div id="ccd89e98" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate CAPM for Vingroup</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>model_vic <span class="op">=</span> smf.ols(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    formula<span class="op">=</span><span class="st">"ret_excess ~ mkt_excess"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>vic_data</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>).fit()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display regression results</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_vic.summary())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:             ret_excess   R-squared:                       0.153
Model:                            OLS   Adj. R-squared:                  0.147
Method:                 Least Squares   F-statistic:                     26.67
Date:                Wed, 04 Feb 2026   Prob (F-statistic):           7.66e-07
Time:                        10:19:28   Log-Likelihood:                 131.96
No. Observations:                 150   AIC:                            -259.9
Df Residuals:                     148   BIC:                            -253.9
Df Model:                           1                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -0.0075      0.008     -0.895      0.372      -0.024       0.009
mkt_excess     0.7503      0.145      5.164      0.000       0.463       1.037
==============================================================================
Omnibus:                       39.111   Durbin-Watson:                   2.039
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              107.620
Skew:                          -1.015   Prob(JB):                     4.27e-24
Kurtosis:                       6.619   Cond. No.                         17.6
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</code></pre>
</div>
</div>
<p>The regression output provides several important pieces of information:</p>
<ul>
<li><strong>Beta (mkt_excess coefficient)</strong>: The estimated market sensitivity. A beta above 1 indicates VIC amplifies market movements.</li>
<li><strong>Alpha (Intercept)</strong>: The abnormal return not explained by market exposure. Under CAPM, this should be zero.</li>
<li><strong>R-squared</strong>: The proportion of return variation explained by market movements.</li>
<li><strong>t-statistics</strong>: Test whether coefficients differ significantly from zero.</li>
</ul>
<div id="4fa71df5" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract key estimates</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> model_vic.summary2().tables[<span class="dv">1</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Key estimates for Vingroup (VIC):"</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Beta:  </span><span class="sc">{</span>coefficients<span class="sc">.</span>loc[<span class="st">'mkt_excess'</span>, <span class="st">'Coef.'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Alpha: </span><span class="sc">{</span>coefficients<span class="sc">.</span>loc[<span class="st">'Intercept'</span>, <span class="st">'Coef.'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  R²:    </span><span class="sc">{</span>model_vic<span class="sc">.</span>rsquared<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Key estimates for Vingroup (VIC):
  Beta:  0.750
  Alpha: -0.0075
  R²:    0.153</code></pre>
</div>
</div>
</section>
<section id="capm-estimation-function" class="level3" data-number="8.4.2">
<h3 data-number="8.4.2" class="anchored" data-anchor-id="capm-estimation-function"><span class="header-section-number">8.4.2</span> CAPM Estimation Function</h3>
<p>We create a reusable function that estimates the CAPM and returns results in a standardized format. The function includes a minimum observations requirement to avoid unreliable estimates from sparse data.</p>
<div id="e17c5bf2" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_capm(data, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate CAPM regression and return coefficients.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function regresses excess stock returns on excess market returns</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    and extracts the coefficient estimates along with t-statistics.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'ret_excess' and 'mkt_excess' columns</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum number of observations required for estimation</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with coefficient estimates and t-statistics,</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">        or empty DataFrame if insufficient observations</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;</span> min_obs:</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate OLS regression</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> smf.ols(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>            formula<span class="op">=</span><span class="st">"ret_excess ~ mkt_excess"</span>, </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>data</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        ).fit()</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract coefficient table</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        coef_table <span class="op">=</span> model.summary2().tables[<span class="dv">1</span>]</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Format results</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"coefficient"</span>: [<span class="st">"alpha"</span>, <span class="st">"beta"</span>],</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span>: [</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"Intercept"</span>, <span class="st">"Coef."</span>],</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"mkt_excess"</span>, <span class="st">"Coef."</span>]</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">"t_statistic"</span>: [</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"Intercept"</span>, <span class="st">"t"</span>],</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"mkt_excess"</span>, <span class="st">"t"</span>]</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r_squared"</span>: model.rsquared</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return empty DataFrame if estimation fails</span></span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="rolling-window-estimation" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="rolling-window-estimation"><span class="header-section-number">8.5</span> Rolling-Window Estimation</h2>
<section id="motivation-for-rolling-windows" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="motivation-for-rolling-windows"><span class="header-section-number">8.5.1</span> Motivation for Rolling Windows</h3>
<p>Stock betas are not constant over time. A company’s business mix, leverage, and operating environment evolve, causing its systematic risk exposure to change. To capture this time variation, we use rolling-window estimation: at each point in time, we estimate beta using only data from a fixed lookback period (e.g., the past 60 months).</p>
<p>Rolling-window estimation involves a trade-off:</p>
<ul>
<li><strong>Longer windows</strong> provide more observations and thus more precise estimates, but may include stale information.</li>
<li><strong>Shorter windows</strong> are more responsive to changes but produce noisier estimates.</li>
</ul>
<p>A common choice in academic research is 60 months (5 years) of monthly data, requiring at least 48 valid observations for estimation.</p>
</section>
<section id="rolling-window-implementation" class="level3" data-number="8.5.2">
<h3 data-number="8.5.2" class="anchored" data-anchor-id="rolling-window-implementation"><span class="header-section-number">8.5.2</span> Rolling Window Implementation</h3>
<p>The following function implements rolling-window CAPM estimation. For each month in the sample, it looks back over the specified window and estimates beta using all available data within that window.</p>
<div id="cb5a7477" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_capm_estimation(data, look_back<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform rolling-window CAPM estimation.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function slides a window across time, estimating the CAPM</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    regression at each point using the most recent 'look_back' months</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    of data.</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'date', 'ret_excess', and 'mkt_excess' columns</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back : int</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of months in the estimation window</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum observations required within each window</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Time series of coefficient estimates with dates</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted by date</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get unique dates</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> data[<span class="st">"date"</span>].drop_duplicates().sort_values()</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Container for results</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Slide window across dates</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(look_back <span class="op">-</span> <span class="dv">1</span>, <span class="bu">len</span>(dates)):</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define window boundaries</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        end_date <span class="op">=</span> dates.iloc[i]</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        start_date <span class="op">=</span> end_date <span class="op">-</span> relativedelta(months<span class="op">=</span>look_back <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract data within window</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> data.query(<span class="st">"date &gt;= @start_date and date &lt;= @end_date"</span>)</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate CAPM for this window</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        window_results <span class="op">=</span> estimate_capm(window_data, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> window_results.empty:</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>            window_results[<span class="st">"date"</span>] <span class="op">=</span> end_date</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>            results.append(window_results)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all results</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="example-rolling-betas-for-selected-stocks" class="level3" data-number="8.5.3">
<h3 data-number="8.5.3" class="anchored" data-anchor-id="example-rolling-betas-for-selected-stocks"><span class="header-section-number">8.5.3</span> Example: Rolling Betas for Selected Stocks</h3>
<p>We demonstrate rolling-window estimation for several well-known Vietnamese stocks spanning different industries.</p>
<div id="dbafab81" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define example stocks</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: [<span class="st">"FPT"</span>, <span class="st">"VNM"</span>, <span class="st">"VIC"</span>, <span class="st">"HPG"</span>, <span class="st">"VCB"</span>],</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"company"</span>: [</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"FPT Corporation"</span>,      <span class="co"># Technology</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vinamilk"</span>,             <span class="co"># Consumer goods</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vingroup"</span>,             <span class="co"># Real estate/conglomerate</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Hoa Phat Group"</span>,       <span class="co"># Steel/materials</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vietcombank"</span>           <span class="co"># Banking</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Check data availability for each example</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>data_availability <span class="op">=</span> (prices_monthly</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol in @examples['symbol']"</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        n_obs<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"count"</span>),</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        first_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        last_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Data availability for example stocks:"</span>)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data_availability)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data availability for example stocks:
  symbol  n_obs first_date  last_date
0    FPT    150 2011-07-31 2023-12-31
1    HPG    150 2011-07-31 2023-12-31
2    VCB    150 2011-07-31 2023-12-31
3    VIC    150 2011-07-31 2023-12-31
4    VNM    150 2011-07-31 2023-12-31</code></pre>
</div>
</div>
<div id="a7c126ff" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate rolling betas for example stocks</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>example_data <span class="op">=</span> prices_monthly.query(<span class="st">"symbol in @examples['symbol']"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>capm_examples <span class="op">=</span> (example_data</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: roll_capm_estimation(x), include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    .drop(columns<span class="op">=</span><span class="st">"level_1"</span>, errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to beta estimates only</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>beta_examples <span class="op">=</span> (capm_examples</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    .merge(examples, on<span class="op">=</span><span class="st">"symbol"</span>)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rolling beta estimates: </span><span class="sc">{</span><span class="bu">len</span>(beta_examples)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rolling beta estimates: 455 observations</code></pre>
</div>
</div>
</section>
<section id="visualizing-rolling-betas" class="level3" data-number="8.5.4">
<h3 data-number="8.5.4" class="anchored" data-anchor-id="visualizing-rolling-betas"><span class="header-section-number">8.5.4</span> Visualizing Rolling Betas</h3>
<p><a href="#fig-rolling-betas" class="quarto-xref">Figure&nbsp;<span>8.1</span></a> displays the time series of beta estimates for our example stocks. The figure reveals how systematic risk exposure evolves differently across industries.</p>
<div id="cell-fig-rolling-betas" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>rolling_beta_figure <span class="op">=</span> (</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>        beta_examples,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"estimate"</span>, color<span class="op">=</span><span class="st">"company"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling Beta Estimates (60-Month Window)"</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>rolling_beta_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-rolling-betas" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing time series of beta estimates for five Vietnamese stocks from different industries." data-fig-align="center">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rolling-betas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08_beta_estimation_files/figure-html/fig-rolling-betas-output-1.png" class="quarto-figure quarto-figure-center figure-img" alt="Line chart showing time series of beta estimates for five Vietnamese stocks from different industries." width="672" height="480">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-rolling-betas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.1: Monthly rolling beta estimates for selected Vietnamese stocks using a 60-month estimation window. Different industries exhibit distinct patterns of market sensitivity over time.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Several patterns emerge from the figure:</p>
<ol type="1">
<li><p><strong>Industry differences</strong>: Technology and banking stocks may exhibit different beta patterns than real estate or consumer goods companies.</p></li>
<li><p><strong>Time variation</strong>: Betas are not constant. They respond to changes in business conditions, leverage, and market regimes.</p></li>
<li><p><strong>Crisis periods</strong>: Market stress periods (e.g., 2008 financial crisis, 2020 COVID-19) often see beta estimates change as correlations across stocks increase.</p></li>
</ol>
</section>
</section>
<section id="parallelized-estimation-for-the-full-market" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="parallelized-estimation-for-the-full-market"><span class="header-section-number">8.6</span> Parallelized Estimation for the Full Market</h2>
<section id="the-computational-challenge" class="level3" data-number="8.6.1">
<h3 data-number="8.6.1" class="anchored" data-anchor-id="the-computational-challenge"><span class="header-section-number">8.6.1</span> The Computational Challenge</h3>
<p>Estimating rolling betas for all stocks in our database is computationally intensive. With hundreds of stocks, each requiring rolling estimation across many time periods, sequential processing would take considerable time. Fortunately, beta estimation for different stocks is independent (i.e., the estimate for stock A does not depend on the estimate for stock B). This independence makes the problem ideal for parallelization.</p>
</section>
<section id="setting-up-parallel-processing" class="level3" data-number="8.6.2">
<h3 data-number="8.6.2" class="anchored" data-anchor-id="setting-up-parallel-processing"><span class="header-section-number">8.6.2</span> Setting Up Parallel Processing</h3>
<p>We use the <code>joblib</code> library to distribute computation across multiple CPU cores. The <code>Parallel</code> class manages worker processes, while <code>delayed</code> wraps function calls for deferred execution.</p>
<div id="39cec92a" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine available cores (reserve one for system operations)</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>n_cores <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available cores for parallel processing: </span><span class="sc">{</span>n_cores<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Available cores for parallel processing: 3</code></pre>
</div>
</div>
</section>
<section id="parallel-beta-estimation" class="level3" data-number="8.6.3">
<h3 data-number="8.6.3" class="anchored" data-anchor-id="parallel-beta-estimation"><span class="header-section-number">8.6.3</span> Parallel Beta Estimation</h3>
<p>The following code estimates rolling betas for all stocks in parallel. Each stock is processed independently by a separate worker.</p>
<div id="3f43fea5" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_all_betas_parallel(data, n_cores, look_back<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate rolling betas for all stocks using parallel processing.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Full dataset with all stocks</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">    n_cores : int</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of CPU cores to use</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back : int</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Months in estimation window</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum observations required</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Beta estimates for all stocks and dates</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by stock</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    grouped <span class="op">=</span> data.groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define worker function</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_stock(name, group):</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> roll_capm_estimation(group, look_back<span class="op">=</span>look_back, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result.empty:</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">"symbol"</span>] <span class="op">=</span> name</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute in parallel</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_cores, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>        delayed(process_stock)(name, group) </span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, group <span class="kw">in</span> grouped</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine results</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> results <span class="cf">if</span> <span class="kw">not</span> r.empty]</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="1015a664" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate betas for all stocks</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Estimating rolling betas for all stocks..."</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>capm_monthly <span class="op">=</span> estimate_all_betas_parallel(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    prices_monthly, </span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    n_cores<span class="op">=</span>n_cores,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    look_back<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    min_obs<span class="op">=</span><span class="dv">48</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed: </span><span class="sc">{</span><span class="bu">len</span>(capm_monthly)<span class="sc">:,}</span><span class="ss"> coefficient estimates"</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>capm_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="storing-results" class="level3" data-number="8.6.4">
<h3 data-number="8.6.4" class="anchored" data-anchor-id="storing-results"><span class="header-section-number">8.6.4</span> Storing Results</h3>
<p>We save the CAPM estimates to our database for use in subsequent chapters.</p>
<div id="1cf396d7" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>capm_monthly.to_sql(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"capm_monthly"</span>,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM estimates saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For subsequent analysis, we load the pre-computed estimates:</p>
<div id="9dd1c9d3" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>capm_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM capm_monthly"</span>,</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(capm_monthly)<span class="sc">:,}</span><span class="ss"> CAPM estimates"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 161,580 CAPM estimates</code></pre>
</div>
</div>
</section>
</section>
<section id="beta-estimation-using-daily-returns" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="beta-estimation-using-daily-returns"><span class="header-section-number">8.7</span> Beta Estimation Using Daily Returns</h2>
<p>While monthly returns are standard in academic research, some applications benefit from higher-frequency data:</p>
<ul>
<li><strong>Shorter estimation windows</strong>: Daily data allows meaningful estimation over shorter periods (e.g., 3 months rather than 5 years).</li>
<li><strong>More responsive estimates</strong>: Daily betas capture changes more quickly.</li>
<li><strong>Event studies</strong>: High-frequency betas are useful for analyzing market reactions to specific events.</li>
</ul>
<p>However, daily data introduces additional challenges:</p>
<ul>
<li><strong>Microstructure noise</strong>: Bid-ask bounce and other trading frictions add noise to returns.</li>
<li><strong>Non-synchronous trading</strong>: Less liquid stocks may not trade every day, biasing beta estimates downward.</li>
<li><strong>Computational burden</strong>: Daily data is roughly 21 times larger than monthly data.</li>
</ul>
<section id="batch-processing-for-daily-data" class="level3" data-number="8.7.1">
<h3 data-number="8.7.1" class="anchored" data-anchor-id="batch-processing-for-daily-data"><span class="header-section-number">8.7.1</span> Batch Processing for Daily Data</h3>
<p>Given the size of daily data, we process stocks in batches to manage memory constraints. This approach loads and processes a subset of stocks, saves results, and proceeds to the next batch.</p>
<div id="93d0d5e5" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_return_daily(tidy_finance):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily value-weighted market excess return from stock data.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load daily prices with market cap for weighting</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    prices_daily_full <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT p.symbol, p.date, p.ret_excess, m.mktcap_lag</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM prices_daily p</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="st">            LEFT JOIN prices_monthly m ON p.symbol = m.symbol </span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="st">                AND strftime('%Y-%m', p.date) = strftime('%Y-%m', m.date)</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute value-weighted market return each day</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    mkt_daily <span class="op">=</span> (prices_daily_full</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        .dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"mkt_excess"</span>)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mkt_daily</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_capm_estimation_daily(data, look_back_days<span class="op">=</span><span class="dv">1260</span>, min_obs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform rolling-window CAPM estimation using daily data.</span></span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'date', 'ret_excess', and 'mkt_excess' columns</span></span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back_days : int</span></span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of trading days in the estimation window</span></span>
<span id="cb33-38"><a href="#cb33-38" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb33-39"><a href="#cb33-39" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum daily observations required within each window</span></span>
<span id="cb33-40"><a href="#cb33-40" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb33-41"><a href="#cb33-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb33-42"><a href="#cb33-42" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb33-43"><a href="#cb33-43" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb33-44"><a href="#cb33-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Time series of coefficient estimates with dates</span></span>
<span id="cb33-45"><a href="#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-46"><a href="#cb33-46" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb33-47"><a href="#cb33-47" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> data[<span class="st">"date"</span>].drop_duplicates().sort_values().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-48"><a href="#cb33-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-49"><a href="#cb33-49" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb33-50"><a href="#cb33-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-51"><a href="#cb33-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(look_back_days <span class="op">-</span> <span class="dv">1</span>, <span class="bu">len</span>(dates)):</span>
<span id="cb33-52"><a href="#cb33-52" aria-hidden="true" tabindex="-1"></a>        end_date <span class="op">=</span> dates.iloc[i]</span>
<span id="cb33-53"><a href="#cb33-53" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i <span class="op">-</span> look_back_days <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb33-54"><a href="#cb33-54" aria-hidden="true" tabindex="-1"></a>        start_date <span class="op">=</span> dates.iloc[start_idx]</span>
<span id="cb33-55"><a href="#cb33-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-56"><a href="#cb33-56" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> data.query(<span class="st">"date &gt;= @start_date and date &lt;= @end_date"</span>)</span>
<span id="cb33-57"><a href="#cb33-57" aria-hidden="true" tabindex="-1"></a>        window_results <span class="op">=</span> estimate_capm(window_data, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb33-58"><a href="#cb33-58" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-59"><a href="#cb33-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> window_results.empty:</span>
<span id="cb33-60"><a href="#cb33-60" aria-hidden="true" tabindex="-1"></a>            window_results[<span class="st">"date"</span>] <span class="op">=</span> end_date</span>
<span id="cb33-61"><a href="#cb33-61" aria-hidden="true" tabindex="-1"></a>            results.append(window_results)</span>
<span id="cb33-62"><a href="#cb33-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-63"><a href="#cb33-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb33-64"><a href="#cb33-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-65"><a href="#cb33-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-66"><a href="#cb33-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb33-67"><a href="#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="#cb33-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-69"><a href="#cb33-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_daily_betas_batch(symbols, tidy_finance, n_cores, batch_size<span class="op">=</span><span class="dv">500</span>, </span>
<span id="cb33-70"><a href="#cb33-70" aria-hidden="true" tabindex="-1"></a>                                look_back_days<span class="op">=</span><span class="dv">1260</span>, min_obs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb33-71"><a href="#cb33-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-72"><a href="#cb33-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate rolling betas from daily data using batch processing.</span></span>
<span id="cb33-73"><a href="#cb33-73" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-74"><a href="#cb33-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First, compute or load market return</span></span>
<span id="cb33-75"><a href="#cb33-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Computing daily market excess returns..."</span>)</span>
<span id="cb33-76"><a href="#cb33-76" aria-hidden="true" tabindex="-1"></a>    mkt_daily <span class="op">=</span> compute_market_return_daily(tidy_finance)</span>
<span id="cb33-77"><a href="#cb33-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Market returns: </span><span class="sc">{</span><span class="bu">len</span>(mkt_daily)<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb33-78"><a href="#cb33-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-79"><a href="#cb33-79" aria-hidden="true" tabindex="-1"></a>    n_batches <span class="op">=</span> <span class="bu">int</span>(np.ceil(<span class="bu">len</span>(symbols) <span class="op">/</span> batch_size))</span>
<span id="cb33-80"><a href="#cb33-80" aria-hidden="true" tabindex="-1"></a>    all_results <span class="op">=</span> []</span>
<span id="cb33-81"><a href="#cb33-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-82"><a href="#cb33-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_batches):</span>
<span id="cb33-83"><a href="#cb33-83" aria-hidden="true" tabindex="-1"></a>        batch_start <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb33-84"><a href="#cb33-84" aria-hidden="true" tabindex="-1"></a>        batch_end <span class="op">=</span> <span class="bu">min</span>((j <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> batch_size, <span class="bu">len</span>(symbols))</span>
<span id="cb33-85"><a href="#cb33-85" aria-hidden="true" tabindex="-1"></a>        batch_symbols <span class="op">=</span> symbols[batch_start:batch_end]</span>
<span id="cb33-86"><a href="#cb33-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-87"><a href="#cb33-87" aria-hidden="true" tabindex="-1"></a>        symbol_list <span class="op">=</span> <span class="st">", "</span>.join(<span class="ss">f"'</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">'"</span> <span class="cf">for</span> s <span class="kw">in</span> batch_symbols)</span>
<span id="cb33-88"><a href="#cb33-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-89"><a href="#cb33-89" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb33-90"><a href="#cb33-90" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT symbol, date, ret_excess</span></span>
<span id="cb33-91"><a href="#cb33-91" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM prices_daily</span></span>
<span id="cb33-92"><a href="#cb33-92" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE symbol IN (</span><span class="sc">{</span>symbol_list<span class="sc">}</span><span class="ss">)</span></span>
<span id="cb33-93"><a href="#cb33-93" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb33-94"><a href="#cb33-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-95"><a href="#cb33-95" aria-hidden="true" tabindex="-1"></a>        prices_daily_batch <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb33-96"><a href="#cb33-96" aria-hidden="true" tabindex="-1"></a>            sql<span class="op">=</span>query,</span>
<span id="cb33-97"><a href="#cb33-97" aria-hidden="true" tabindex="-1"></a>            con<span class="op">=</span>tidy_finance,</span>
<span id="cb33-98"><a href="#cb33-98" aria-hidden="true" tabindex="-1"></a>            parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb33-99"><a href="#cb33-99" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-100"><a href="#cb33-100" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-101"><a href="#cb33-101" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge with market excess return</span></span>
<span id="cb33-102"><a href="#cb33-102" aria-hidden="true" tabindex="-1"></a>        prices_daily_batch <span class="op">=</span> prices_daily_batch.merge(</span>
<span id="cb33-103"><a href="#cb33-103" aria-hidden="true" tabindex="-1"></a>            mkt_daily, </span>
<span id="cb33-104"><a href="#cb33-104" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb33-105"><a href="#cb33-105" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb33-106"><a href="#cb33-106" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-107"><a href="#cb33-107" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-108"><a href="#cb33-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group by symbol and estimate betas</span></span>
<span id="cb33-109"><a href="#cb33-109" aria-hidden="true" tabindex="-1"></a>        grouped <span class="op">=</span> prices_daily_batch.groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb33-110"><a href="#cb33-110" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-111"><a href="#cb33-111" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parallel estimation</span></span>
<span id="cb33-112"><a href="#cb33-112" aria-hidden="true" tabindex="-1"></a>        batch_results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_cores)(</span>
<span id="cb33-113"><a href="#cb33-113" aria-hidden="true" tabindex="-1"></a>            delayed(<span class="kw">lambda</span> name, group: </span>
<span id="cb33-114"><a href="#cb33-114" aria-hidden="true" tabindex="-1"></a>                roll_capm_estimation_daily(group, look_back_days<span class="op">=</span>look_back_days, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb33-115"><a href="#cb33-115" aria-hidden="true" tabindex="-1"></a>                .assign(symbol<span class="op">=</span>name)</span>
<span id="cb33-116"><a href="#cb33-116" aria-hidden="true" tabindex="-1"></a>            )(name, group)</span>
<span id="cb33-117"><a href="#cb33-117" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name, group <span class="kw">in</span> grouped</span>
<span id="cb33-118"><a href="#cb33-118" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb33-119"><a href="#cb33-119" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-120"><a href="#cb33-120" aria-hidden="true" tabindex="-1"></a>        batch_results <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> batch_results <span class="cf">if</span> r <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="kw">not</span> r.empty]</span>
<span id="cb33-121"><a href="#cb33-121" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-122"><a href="#cb33-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> batch_results:</span>
<span id="cb33-123"><a href="#cb33-123" aria-hidden="true" tabindex="-1"></a>            all_results.append(pd.concat(batch_results, ignore_index<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb33-124"><a href="#cb33-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-125"><a href="#cb33-125" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Batch </span><span class="sc">{</span>j<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_batches<span class="sc">}</span><span class="ss"> complete"</span>)</span>
<span id="cb33-126"><a href="#cb33-126" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-127"><a href="#cb33-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_results:</span>
<span id="cb33-128"><a href="#cb33-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(all_results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb33-129"><a href="#cb33-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb33-130"><a href="#cb33-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6a09686c" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>symbols <span class="op">=</span> prices_monthly[<span class="st">"symbol"</span>].unique().tolist()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>capm_daily <span class="op">=</span> estimate_daily_betas_batch(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    symbols<span class="op">=</span>symbols,</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    tidy_finance<span class="op">=</span>tidy_finance,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    n_cores<span class="op">=</span>n_cores,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    look_back_days<span class="op">=</span><span class="dv">1260</span>,  <span class="co"># ~5 years of trading days</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    min_obs<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily beta estimates: </span><span class="sc">{</span><span class="bu">len</span>(capm_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="bafd585b" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>capm_daily.to_sql(</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"capm_daily"</span>,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM estimates saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For subsequent analysis, we load the pre-computed estimates:</p>
<div id="21713135" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>capm_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM capm_daily"</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(capm_daily)<span class="sc">:,}</span><span class="ss"> CAPM estimates"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loaded 3,394,490 CAPM estimates</code></pre>
</div>
</div>
</section>
</section>
<section id="analyzing-beta-estimates" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="analyzing-beta-estimates"><span class="header-section-number">8.8</span> Analyzing Beta Estimates</h2>
<section id="extracting-beta-estimates" class="level3" data-number="8.8.1">
<h3 data-number="8.8.1" class="anchored" data-anchor-id="extracting-beta-estimates"><span class="header-section-number">8.8.1</span> Extracting Beta Estimates</h3>
<p>We extract the beta coefficient estimates from our CAPM results for analysis.</p>
<div id="4c1844af" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract monthly betas</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>beta_monthly <span class="op">=</span> (capm_monthly</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"estimate"</span>: <span class="st">"beta"</span>})</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"beta"</span>]]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    .assign(frequency<span class="op">=</span><span class="st">"monthly"</span>)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to database</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>beta_monthly.to_sql(</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"beta_monthly"</span>,</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly betas: </span><span class="sc">{</span><span class="bu">len</span>(beta_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>beta_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Monthly betas: 80,790 observations
Unique stocks: 1,383</code></pre>
</div>
</div>
<div id="a3381455" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pre-computed betas</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>beta_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM beta_monthly"</span>,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="summary-statistics" class="level3" data-number="8.8.2">
<h3 data-number="8.8.2" class="anchored" data-anchor-id="summary-statistics"><span class="header-section-number">8.8.2</span> Summary Statistics</h3>
<p>We examine the distribution of beta estimates to verify their reasonableness.</p>
<div id="2d9a0259" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Beta Summary Statistics:"</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(beta_monthly[<span class="st">"beta"</span>].describe().<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional diagnostics</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Stocks with negative average beta: </span><span class="sc">{</span>(beta_monthly.groupby(<span class="st">'symbol'</span>)[<span class="st">'beta'</span>].mean() <span class="op">&lt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks with beta &gt; 2: </span><span class="sc">{</span>(beta_monthly.groupby(<span class="st">'symbol'</span>)[<span class="st">'beta'</span>].mean() <span class="op">&gt;</span> <span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Beta Summary Statistics:
count    80790.000
mean         0.501
std          0.539
min         -1.345
25%          0.130
50%          0.447
75%          0.832
max          2.678
Name: beta, dtype: float64

Stocks with negative average beta: 177
Stocks with beta &gt; 2: 5</code></pre>
</div>
</div>
</section>
<section id="beta-distribution-across-industries" class="level3" data-number="8.8.3">
<h3 data-number="8.8.3" class="anchored" data-anchor-id="beta-distribution-across-industries"><span class="header-section-number">8.8.3</span> Beta Distribution Across Industries</h3>
<p>Different industries have different exposures to systematic market risk based on their business models, operating leverage, and financial leverage. <a href="#fig-beta-by-industry" class="quarto-xref">Figure&nbsp;<span>8.2</span></a> shows the distribution of firm-level average betas across Vietnamese industries.</p>
<div id="4dd162f0" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge betas with industry information</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>beta_with_industry <span class="op">=</span> (beta_monthly</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        prices_monthly[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"icb_name_vi"</span>]].drop_duplicates(),</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>],</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"icb_name_vi"</span>])</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute firm-level average beta by industry</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>beta_by_industry <span class="op">=</span> (beta_with_industry</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"icb_name_vi"</span>, <span class="st">"symbol"</span>])[<span class="st">"beta"</span>]</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Order industries by median beta</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>industry_order <span class="op">=</span> (beta_by_industry</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"icb_name_vi"</span>)[<span class="st">"beta"</span>]</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>    .median()</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>    .sort_values()</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>    .index.tolist()</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Select top 10 industries by number of firms for clearer visualization</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>top_industries <span class="op">=</span> (beta_by_industry</span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"icb_name_vi"</span>)</span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">10</span>)</span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>    .index.tolist()</span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>beta_by_industry_filtered <span class="op">=</span> beta_by_industry.query(<span class="st">"icb_name_vi in @top_industries"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-beta-by-industry" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>beta_industry_figure <span class="op">=</span> (</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>        beta_by_industry_filtered,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"icb_name_vi"</span>, y<span class="op">=</span><span class="st">"beta"</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_boxplot(fill<span class="op">=</span><span class="st">"steelblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> coord_flip()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Beta Distribution by Industry"</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>beta_industry_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-beta-by-industry" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Box plots showing beta distributions by industry, ordered by median beta.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-beta-by-industry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08_beta_estimation_files/figure-html/fig-beta-by-industry-output-1.png" alt="Box plots showing beta distributions by industry, ordered by median beta." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-beta-by-industry-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.2: Distribution of firm-level average betas across Vietnamese industries. Box plots show the median, interquartile range, and outliers for each industry.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="time-variation-in-cross-sectional-beta-distribution" class="level3" data-number="8.8.4">
<h3 data-number="8.8.4" class="anchored" data-anchor-id="time-variation-in-cross-sectional-beta-distribution"><span class="header-section-number">8.8.4</span> Time Variation in Cross-Sectional Beta Distribution</h3>
<p>Betas vary not only across stocks but also over time. <a href="#fig-beta-quantiles" class="quarto-xref">Figure&nbsp;<span>8.3</span></a> shows how the cross-sectional distribution of betas has evolved in the Vietnamese market.</p>
<div id="cell-fig-beta-quantiles" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute monthly quantiles</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>beta_quantiles <span class="op">=</span> (beta_monthly</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"beta"</span>]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    .quantile(q<span class="op">=</span>np.arange(<span class="fl">0.1</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"level_1"</span>: <span class="st">"quantile"</span>})</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    .assign(quantile<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"quantile"</span>] <span class="op">*</span> <span class="dv">100</span>).astype(<span class="bu">int</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"%"</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>beta_quantiles_figure <span class="op">=</span> (</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>        beta_quantiles,</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta"</span>, color<span class="op">=</span><span class="st">"quantile"</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Quantile"</span>,</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Distribution of Betas Over Time"</span></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>beta_quantiles_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-beta-quantiles" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing time series of beta deciles, illustrating how the distribution of betas has changed over time.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-beta-quantiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08_beta_estimation_files/figure-html/fig-beta-quantiles-output-1.png" alt="Line chart showing time series of beta deciles, illustrating how the distribution of betas has changed over time." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-beta-quantiles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.3: Monthly quantiles of beta estimates over time. Each line represents a decile of the cross-sectional beta distribution.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The figure reveals several interesting patterns:</p>
<ol type="1">
<li><p><strong>Level shifts</strong>: The entire distribution of betas can shift over time, reflecting changes in market-wide correlation.</p></li>
<li><p><strong>Dispersion changes</strong>: During market stress, the spread between high and low beta stocks may change as correlations move.</p></li>
<li><p><strong>Trends</strong>: Some periods show trending behavior in betas, possibly reflecting structural changes in the economy.</p></li>
</ol>
</section>
<section id="coverage-analysis" class="level3" data-number="8.8.5">
<h3 data-number="8.8.5" class="anchored" data-anchor-id="coverage-analysis"><span class="header-section-number">8.8.5</span> Coverage Analysis</h3>
<p>We verify that our estimation procedure produces reasonable coverage across the sample. <a href="#fig-beta-coverage" class="quarto-xref">Figure&nbsp;<span>8.4</span></a> shows the fraction of stocks with available beta estimates over time.</p>
<div id="cell-fig-beta-coverage" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Count stocks with and without betas</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>coverage <span class="op">=</span> (prices_monthly</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    .nunique()</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"total_stocks"</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        beta_monthly.groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>].nunique().reset_index(name<span class="op">=</span><span class="st">"with_beta"</span>),</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    .assign(coverage<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"with_beta"</span>] <span class="op">/</span> x[<span class="st">"total_stocks"</span>])</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>coverage_figure <span class="op">=</span> (</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    ggplot(coverage, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"coverage"</span>))</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"steelblue"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Share with Beta Estimate"</span>,</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Beta Estimation Coverage Over Time"</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format(), limits<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>coverage_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-beta-coverage" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing the percentage of stocks with beta estimates available each month.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-beta-coverage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08_beta_estimation_files/figure-html/fig-beta-coverage-output-1.png" alt="Line chart showing the percentage of stocks with beta estimates available each month." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-beta-coverage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.4: Share of stocks with available beta estimates over time. Coverage increases as more stocks accumulate sufficient return history.
</figcaption>
</figure>
</div>
</div>
</div>
<p>Coverage is lower in early years because stocks need sufficient return history (at least 48 months) before their betas can be estimated. As the market matures and stocks accumulate longer histories, coverage approaches 100%.</p>
</section>
</section>
<section id="comparing-monthly-and-daily-beta-estimates" class="level2" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="comparing-monthly-and-daily-beta-estimates"><span class="header-section-number">8.9</span> Comparing Monthly and Daily Beta Estimates</h2>
<p>When both monthly and daily beta estimates are available, we can compare them to understand how estimation frequency affects results.</p>
<div id="95ea3860" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine monthly and daily estimates</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>beta_daily <span class="op">=</span> (capm_daily</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"estimate"</span>: <span class="st">"beta"</span>})</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"beta"</span>]]</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    .assign(frequency<span class="op">=</span><span class="st">"daily"</span>)</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>beta_combined <span class="op">=</span> pd.concat([beta_monthly, beta_daily], ignore_index<span class="op">=</span><span class="va">True</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-beta-comparison" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to example stocks</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>beta_comparison <span class="op">=</span> (beta_combined</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    .merge(examples, on<span class="op">=</span><span class="st">"symbol"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol in ['VIC', 'FPT']"</span>)  <span class="co"># Select two for clarity</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>comparison_figure <span class="op">=</span> (</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        beta_comparison,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta"</span>, color<span class="op">=</span><span class="st">"frequency"</span>, linetype<span class="op">=</span><span class="st">"frequency"</span>)</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> facet_wrap(<span class="st">"~company"</span>, ncol<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Data Frequency"</span>,</span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>        linetype<span class="op">=</span><span class="st">"Data Frequency"</span>,</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Monthly vs Daily Beta Estimates"</span></span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>comparison_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-beta-comparison" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart comparing monthly and daily beta estimates over time for example stocks.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-beta-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="08_beta_estimation_files/figure-html/fig-beta-comparison-output-1.png" alt="Line chart comparing monthly and daily beta estimates over time for example stocks." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-beta-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8.5: Comparison of beta estimates using monthly versus daily returns for selected stocks. Daily estimates are smoother due to more observations per estimation window.
</figcaption>
</figure>
</div>
</div>
</div>
<p>The comparison reveals that daily-based estimates are generally smoother due to the larger number of observations in each window. However, the level and trend of estimates are similar across frequencies, providing validation that both approaches capture the same underlying systematic risk exposure.</p>
<div id="31f7ea57" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation between monthly and daily estimates</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>correlation_data <span class="op">=</span> (beta_combined</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    .pivot_table(index<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], columns<span class="op">=</span><span class="st">"frequency"</span>, values<span class="op">=</span><span class="st">"beta"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correlation between monthly and daily betas: </span><span class="sc">{</span>correlation_data<span class="sc">.</span>corr()<span class="sc">.</span>iloc[<span class="dv">0</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Correlation between monthly and daily betas: 0.745</code></pre>
</div>
</div>
<div id="tbl-imperfect-cor" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-imperfect-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;8.1: Theoretical Reasons for Imperfect Correlation
</figcaption>
<div aria-describedby="tbl-imperfect-cor-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Factor</th>
<th>Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Non-synchronous trading</td>
<td>Daily betas can be biased downward for illiquid stocks</td>
</tr>
<tr class="even">
<td>Microstructure noise</td>
<td>Bid-ask bounce adds noise to daily estimates</td>
</tr>
<tr class="odd">
<td>Different effective windows</td>
<td>Same calendar period but ~20x more observations for daily</td>
</tr>
<tr class="even">
<td>Mean reversion speed</td>
<td>Daily captures faster-moving risk dynamics</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p><a href="#tbl-imperfect-cor" class="quarto-xref">Table&nbsp;<span>8.1</span></a> shows several reasons why we might observe imperfect correlation.</p>
</section>
<section id="key-takeaways" class="level2" data-number="8.10">
<h2 data-number="8.10" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">8.10</span> Key Takeaways</h2>
<ol type="1">
<li><p><strong>CAPM beta</strong> measures a stock’s sensitivity to systematic market risk and is fundamental to modern portfolio theory, cost of capital estimation, and risk management.</p></li>
<li><p><strong>Rolling-window estimation</strong> captures time variation in betas, which reflects changes in companies’ business models, leverage, and market conditions.</p></li>
<li><p><strong>Parallelization</strong> dramatically reduces computation time for large-scale estimation tasks by distributing work across multiple CPU cores.</p></li>
<li><p><strong>Estimation choices matter</strong>: Window length, return frequency, and minimum observation requirements all affect beta estimates. Researchers should choose parameters appropriate for their specific application.</p></li>
<li><p><strong>Industry patterns</strong>: Vietnamese stocks show systematic differences in market sensitivity across industries, with cyclical sectors exhibiting higher betas than defensive sectors.</p></li>
<li><p><strong>Time variation</strong>: The cross-sectional distribution of betas in Vietnam has evolved over time, with notable shifts during market stress periods.</p></li>
<li><p><strong>Frequency comparison</strong>: Monthly and daily beta estimates are positively correlated but not identical. Daily estimates are smoother while monthly estimates may better capture lower-frequency variation.</p></li>
<li><p><strong>Data quality checks</strong>: Coverage analysis and summary statistics help identify potential issues in estimation procedures before using results in downstream analyses.</p></li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Lintner1965" class="csl-entry" role="listitem">
Lintner, John. 1965. <span>“<span class="nocase">Security prices, risk, and maximal gains from diversification</span>.”</span> <em><span>The Journal of Finance</span></em> 20 (4): 587–615. <a href="https://doi.org/10.1111/j.1540-6261.1965.tb02930.x">https://doi.org/10.1111/j.1540-6261.1965.tb02930.x</a>.
</div>
<div id="ref-Mossin1966" class="csl-entry" role="listitem">
Mossin, Jan. 1966. <span>“<span class="nocase">Equilibrium in a capital asset market</span>.”</span> <em><span>Econometrica</span></em> 34 (4): 768–83. <a href="https://doi.org/10.2307/1910098">https://doi.org/10.2307/1910098</a>.
</div>
<div id="ref-Sharpe1964" class="csl-entry" role="listitem">
Sharpe, William F. 1964. <span>“<span class="nocase">Capital asset prices: A theory of market equilibrium under conditions of risk </span>.”</span> <em><span>The Journal of Finance</span></em> 19 (3): 425–42. <a href="https://doi.org/10.1111/j.1540-6261.1964.tb02865.x">https://doi.org/10.1111/j.1540-6261.1964.tb02865.x</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./09_univariate_portfolio_sort.html" class="pagination-link" aria-label="Univariate Portfolio Sorts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03_capm.html" class="pagination-link" aria-label="The Capital Asset Pricing Model">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Beta Estimation</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>This chapter introduces one of the most fundamental concepts in financial economics: the exposure of an individual stock to systematic market risk. According to the Capital Asset Pricing Model (CAPM) developed by @Sharpe1964, @Lintner1965, and @Mossin1966, cross-sectional variation in expected asset returns should be determined by the covariance between an asset's excess return and the excess return on the market portfolio. The regression coefficient that captures this relationship (commonly known as market beta) serves as the cornerstone of modern portfolio theory and remains widely used in practice for cost of capital estimation, performance attribution, and risk management.</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>In this chapter, we develop a complete framework for estimating market betas for Vietnamese stocks. We begin with a conceptual overview of the CAPM and its empirical implementation. We then demonstrate beta estimation using ordinary least squares regression, first for individual stocks and then scaled to the entire market using rolling-window estimation. To handle the computational demands of estimating betas for hundreds of stocks across many time periods, we introduce parallelization techniques that dramatically reduce processing time. Finally, we compare beta estimates derived from monthly versus daily returns and examine how betas vary across industries and over time in the Vietnamese market.</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>The chapter leverages several important computational concepts that extend beyond beta estimation itself. Rolling-window estimation is a technique applicable to any time-varying parameter, while parallelization provides a general solution for computationally intensive tasks that can be divided into independent subtasks.</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="fu">## Theoretical Foundation</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Capital Asset Pricing Model</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a>The CAPM provides a theoretical framework linking expected returns to systematic risk. Under the model's assumptions—including mean-variance optimizing investors, homogeneous expectations, and frictionless markets—the expected excess return on any asset $i$ is proportional to its covariance with the market portfolio:</span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">r_i - r_f</span><span class="co">]</span> = \beta_i \cdot E<span class="co">[</span><span class="ot">r_m - r_f</span><span class="co">]</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>where $r_i$ is the return on asset $i$, $r_f$ is the risk-free rate, $r_m$ is the return on the market portfolio, and $\beta_i$ is defined as:</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a>\beta_i = \frac{\text{Cov}(r_i, r_m)}{\text{Var}(r_m)}</span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>The market beta $\beta_i$ measures the sensitivity of asset $i$'s returns to market movements. A beta greater than one indicates the asset amplifies market movements, while a beta less than one indicates dampened sensitivity. A beta of zero would imply no systematic risk exposure, leaving only idiosyncratic risk that can be diversified away.</span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="fu">### Empirical Implementation</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>In practice, we estimate beta by regressing excess stock returns on excess market returns:</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a>r_{i,t} - r_{f,t} = \alpha_i + \beta_i(r_{m,t} - r_{f,t}) + \varepsilon_{i,t}</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a>$$ {#eq-capm-regression}</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>where $\alpha_i$ represents abnormal return (Jensen's alpha), $\beta_i$ is the market beta we seek to estimate, and $\varepsilon_{i,t}$ is the idiosyncratic error term. Under the CAPM, $\alpha_i$ should equal zero for all assets—any non-zero alpha represents a deviation from the model's predictions.</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>Several practical considerations affect beta estimation:</span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Estimation Window**: Longer windows provide more observations and thus more precise estimates, but may include outdated information if betas change over time. Common choices range from 36 to 60 months for monthly data.</span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Return Frequency**: Monthly returns reduce noise but provide fewer observations. Daily returns offer more data points but may introduce microstructure effects and non-synchronous trading biases.</span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Market Proxy**: The theoretical market portfolio includes all assets, but in practice we use a broad equity index. For Vietnam, we use the value-weighted market return constructed from our stock universe.</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Minimum Observations**: Requiring a minimum number of observations (e.g., 48 out of 60 months) helps avoid unreliable estimates from sparse data.</span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up the Environment</span></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a>We begin by loading the necessary Python packages. The core packages handle data manipulation, statistical modeling, and database operations. We also import parallelization tools that will be essential when scaling our estimation to the full market.</span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats.mstats <span class="im">import</span> winsorize</span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb51-72"><a href="#cb51-72" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb51-73"><a href="#cb51-73" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed, cpu_count</span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a>We connect to our SQLite database containing the processed Vietnamese financial data from previous chapters.</span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading and Preparing Data</span></span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stock Returns Data</span></span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a>We load the monthly stock returns data prepared in the Datacore chapter. The data includes excess returns (returns minus the risk-free rate) for all Vietnamese listed stocks.</span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess </span></span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a><span class="co"># Add year for merging with fundamentals</span></span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>prices_monthly[<span class="st">"year"</span>] <span class="op">=</span> prices_monthly[<span class="st">"date"</span>].dt.year</span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> monthly observations"</span>)</span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Covering </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss"> unique stocks"</span>)</span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret_excess </span></span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_daily</span></span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a><span class="fu">### Company Information</span></span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a>We load company information to enable industry-level analysis of beta estimates.</span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, datadate, icb_name_vi </span></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM comp_vn</span></span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb51-136"><a href="#cb51-136" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-137"><a href="#cb51-137" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"datadate"</span>}</span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract year for merging</span></span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a>comp_vn[<span class="st">"year"</span>] <span class="op">=</span> comp_vn[<span class="st">"datadate"</span>].dt.year</span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Company data: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss"> firms"</span>)</span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a><span class="fu">### Market Excess Returns</span></span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a>For the market portfolio proxy, we use the value-weighted market excess return. If you have constructed Fama-French factors in a previous chapter, load them here. Otherwise, we can construct a simple market return from our stock data.</span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 1: Load pre-computed market factor</span></span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess FROM factors_ff3_monthly"</span>,</span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-159"><a href="#cb51-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-160"><a href="#cb51-160" aria-hidden="true" tabindex="-1"></a><span class="co"># Option 2: Construct market return from stock data (if factors not available)</span></span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a><span class="co"># This computes the value-weighted average return across all stocks</span></span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_return(prices_df):</span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute value-weighted market return from individual stock returns.</span></span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-167"><a href="#cb51-167" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-168"><a href="#cb51-168" aria-hidden="true" tabindex="-1"></a><span class="co">    prices_df : pd.DataFrame</span></span>
<span id="cb51-169"><a href="#cb51-169" aria-hidden="true" tabindex="-1"></a><span class="co">        Stock returns with mktcap_lag for weighting</span></span>
<span id="cb51-170"><a href="#cb51-170" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-171"><a href="#cb51-171" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-172"><a href="#cb51-172" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-173"><a href="#cb51-173" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-174"><a href="#cb51-174" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly market excess returns</span></span>
<span id="cb51-175"><a href="#cb51-175" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-176"><a href="#cb51-176" aria-hidden="true" tabindex="-1"></a>    market_return <span class="op">=</span> (prices_df</span>
<span id="cb51-177"><a href="#cb51-177" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb51-178"><a href="#cb51-178" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb51-179"><a href="#cb51-179" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"mkt_excess"</span>)</span>
<span id="cb51-180"><a href="#cb51-180" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-181"><a href="#cb51-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> market_return</span>
<span id="cb51-182"><a href="#cb51-182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-183"><a href="#cb51-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-184"><a href="#cb51-184" aria-hidden="true" tabindex="-1"></a><span class="fu">### Merging Datasets</span></span>
<span id="cb51-185"><a href="#cb51-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-186"><a href="#cb51-186" aria-hidden="true" tabindex="-1"></a>We combine the stock returns with market returns and company information to create our estimation dataset.</span>
<span id="cb51-187"><a href="#cb51-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-190"><a href="#cb51-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-191"><a href="#cb51-191" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge stock returns with market returns</span></span>
<span id="cb51-192"><a href="#cb51-192" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb51-193"><a href="#cb51-193" aria-hidden="true" tabindex="-1"></a>    factors_ff3_monthly, </span>
<span id="cb51-194"><a href="#cb51-194" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb51-195"><a href="#cb51-195" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb51-196"><a href="#cb51-196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-197"><a href="#cb51-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-198"><a href="#cb51-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with company information for industry classification</span></span>
<span id="cb51-199"><a href="#cb51-199" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.merge(</span>
<span id="cb51-200"><a href="#cb51-200" aria-hidden="true" tabindex="-1"></a>    comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"icb_name_vi"</span>]], </span>
<span id="cb51-201"><a href="#cb51-201" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], </span>
<span id="cb51-202"><a href="#cb51-202" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb51-203"><a href="#cb51-203" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-204"><a href="#cb51-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-205"><a href="#cb51-205" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing data</span></span>
<span id="cb51-206"><a href="#cb51-206" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>])</span>
<span id="cb51-207"><a href="#cb51-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-208"><a href="#cb51-208" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final estimation sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb51-209"><a href="#cb51-209" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-210"><a href="#cb51-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-211"><a href="#cb51-211" aria-hidden="true" tabindex="-1"></a><span class="fu">### Handling Outliers</span></span>
<span id="cb51-212"><a href="#cb51-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-213"><a href="#cb51-213" aria-hidden="true" tabindex="-1"></a>Extreme returns can unduly influence regression estimates. We apply winsorization to limit the impact of outliers while preserving the general distribution of returns. Winsorization at the 1% level replaces values below the 1st percentile with the 1st percentile value, and values above the 99th percentile with the 99th percentile value.</span>
<span id="cb51-214"><a href="#cb51-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-217"><a href="#cb51-217" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-218"><a href="#cb51-218" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> winsorize_returns(df, columns, limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)):</span>
<span id="cb51-219"><a href="#cb51-219" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-220"><a href="#cb51-220" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply winsorization to return columns to limit outlier influence.</span></span>
<span id="cb51-221"><a href="#cb51-221" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-222"><a href="#cb51-222" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-223"><a href="#cb51-223" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-224"><a href="#cb51-224" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-225"><a href="#cb51-225" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame containing return columns</span></span>
<span id="cb51-226"><a href="#cb51-226" aria-hidden="true" tabindex="-1"></a><span class="co">    columns : list</span></span>
<span id="cb51-227"><a href="#cb51-227" aria-hidden="true" tabindex="-1"></a><span class="co">        Column names to winsorize</span></span>
<span id="cb51-228"><a href="#cb51-228" aria-hidden="true" tabindex="-1"></a><span class="co">    limits : tuple</span></span>
<span id="cb51-229"><a href="#cb51-229" aria-hidden="true" tabindex="-1"></a><span class="co">        Lower and upper percentile limits for winsorization</span></span>
<span id="cb51-230"><a href="#cb51-230" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-231"><a href="#cb51-231" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-232"><a href="#cb51-232" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-233"><a href="#cb51-233" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-234"><a href="#cb51-234" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with winsorized columns</span></span>
<span id="cb51-235"><a href="#cb51-235" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-236"><a href="#cb51-236" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-237"><a href="#cb51-237" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> columns:</span>
<span id="cb51-238"><a href="#cb51-238" aria-hidden="true" tabindex="-1"></a>        df[col] <span class="op">=</span> winsorize(df[col], limits<span class="op">=</span>limits)</span>
<span id="cb51-239"><a href="#cb51-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-240"><a href="#cb51-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-241"><a href="#cb51-241" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> winsorize_returns(</span>
<span id="cb51-242"><a href="#cb51-242" aria-hidden="true" tabindex="-1"></a>    prices_monthly, </span>
<span id="cb51-243"><a href="#cb51-243" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>],</span>
<span id="cb51-244"><a href="#cb51-244" aria-hidden="true" tabindex="-1"></a>    limits<span class="op">=</span>(<span class="fl">0.01</span>, <span class="fl">0.01</span>)</span>
<span id="cb51-245"><a href="#cb51-245" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-246"><a href="#cb51-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-247"><a href="#cb51-247" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Return distributions after winsorization:"</span>)</span>
<span id="cb51-248"><a href="#cb51-248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[[<span class="st">"ret_excess"</span>, <span class="st">"mkt_excess"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb51-249"><a href="#cb51-249" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-250"><a href="#cb51-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-251"><a href="#cb51-251" aria-hidden="true" tabindex="-1"></a><span class="fu">## Estimating Beta for Individual Stocks</span></span>
<span id="cb51-252"><a href="#cb51-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-253"><a href="#cb51-253" aria-hidden="true" tabindex="-1"></a><span class="fu">### Single Stock Example</span></span>
<span id="cb51-254"><a href="#cb51-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-255"><a href="#cb51-255" aria-hidden="true" tabindex="-1"></a>Before scaling to the full market, we demonstrate beta estimation for a single well-known Vietnamese stock. We use Vingroup (VIC), one of the largest conglomerates in Vietnam with significant exposure to real estate, retail, and automotive sectors.</span>
<span id="cb51-256"><a href="#cb51-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-259"><a href="#cb51-259" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-260"><a href="#cb51-260" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for Vingroup</span></span>
<span id="cb51-261"><a href="#cb51-261" aria-hidden="true" tabindex="-1"></a>vic_data <span class="op">=</span> prices_monthly.query(<span class="st">"symbol == 'VIC'"</span>).copy()</span>
<span id="cb51-262"><a href="#cb51-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-263"><a href="#cb51-263" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"VIC observations: </span><span class="sc">{</span><span class="bu">len</span>(vic_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-264"><a href="#cb51-264" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>vic_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>vic_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-265"><a href="#cb51-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-266"><a href="#cb51-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-267"><a href="#cb51-267" aria-hidden="true" tabindex="-1"></a>We estimate the CAPM regression using ordinary least squares via the <span class="in">`statsmodels`</span> package. The formula interface provides a convenient way to specify regression models.</span>
<span id="cb51-268"><a href="#cb51-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-271"><a href="#cb51-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-272"><a href="#cb51-272" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate CAPM for Vingroup</span></span>
<span id="cb51-273"><a href="#cb51-273" aria-hidden="true" tabindex="-1"></a>model_vic <span class="op">=</span> smf.ols(</span>
<span id="cb51-274"><a href="#cb51-274" aria-hidden="true" tabindex="-1"></a>    formula<span class="op">=</span><span class="st">"ret_excess ~ mkt_excess"</span>,</span>
<span id="cb51-275"><a href="#cb51-275" aria-hidden="true" tabindex="-1"></a>    data<span class="op">=</span>vic_data</span>
<span id="cb51-276"><a href="#cb51-276" aria-hidden="true" tabindex="-1"></a>).fit()</span>
<span id="cb51-277"><a href="#cb51-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-278"><a href="#cb51-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Display regression results</span></span>
<span id="cb51-279"><a href="#cb51-279" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(model_vic.summary())</span>
<span id="cb51-280"><a href="#cb51-280" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-281"><a href="#cb51-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-282"><a href="#cb51-282" aria-hidden="true" tabindex="-1"></a>The regression output provides several important pieces of information:</span>
<span id="cb51-283"><a href="#cb51-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-284"><a href="#cb51-284" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Beta (mkt_excess coefficient)**: The estimated market sensitivity. A beta above 1 indicates VIC amplifies market movements.</span>
<span id="cb51-285"><a href="#cb51-285" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Alpha (Intercept)**: The abnormal return not explained by market exposure. Under CAPM, this should be zero.</span>
<span id="cb51-286"><a href="#cb51-286" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**R-squared**: The proportion of return variation explained by market movements.</span>
<span id="cb51-287"><a href="#cb51-287" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**t-statistics**: Test whether coefficients differ significantly from zero.</span>
<span id="cb51-288"><a href="#cb51-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-291"><a href="#cb51-291" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-292"><a href="#cb51-292" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract key estimates</span></span>
<span id="cb51-293"><a href="#cb51-293" aria-hidden="true" tabindex="-1"></a>coefficients <span class="op">=</span> model_vic.summary2().tables[<span class="dv">1</span>]</span>
<span id="cb51-294"><a href="#cb51-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-295"><a href="#cb51-295" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Key estimates for Vingroup (VIC):"</span>)</span>
<span id="cb51-296"><a href="#cb51-296" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Beta:  </span><span class="sc">{</span>coefficients<span class="sc">.</span>loc[<span class="st">'mkt_excess'</span>, <span class="st">'Coef.'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb51-297"><a href="#cb51-297" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Alpha: </span><span class="sc">{</span>coefficients<span class="sc">.</span>loc[<span class="st">'Intercept'</span>, <span class="st">'Coef.'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb51-298"><a href="#cb51-298" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  R²:    </span><span class="sc">{</span>model_vic<span class="sc">.</span>rsquared<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb51-299"><a href="#cb51-299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-300"><a href="#cb51-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-301"><a href="#cb51-301" aria-hidden="true" tabindex="-1"></a><span class="fu">### CAPM Estimation Function</span></span>
<span id="cb51-302"><a href="#cb51-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-303"><a href="#cb51-303" aria-hidden="true" tabindex="-1"></a>We create a reusable function that estimates the CAPM and returns results in a standardized format. The function includes a minimum observations requirement to avoid unreliable estimates from sparse data.</span>
<span id="cb51-304"><a href="#cb51-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-307"><a href="#cb51-307" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-308"><a href="#cb51-308" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_capm(data, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb51-309"><a href="#cb51-309" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-310"><a href="#cb51-310" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate CAPM regression and return coefficients.</span></span>
<span id="cb51-311"><a href="#cb51-311" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-312"><a href="#cb51-312" aria-hidden="true" tabindex="-1"></a><span class="co">    This function regresses excess stock returns on excess market returns</span></span>
<span id="cb51-313"><a href="#cb51-313" aria-hidden="true" tabindex="-1"></a><span class="co">    and extracts the coefficient estimates along with t-statistics.</span></span>
<span id="cb51-314"><a href="#cb51-314" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-315"><a href="#cb51-315" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-316"><a href="#cb51-316" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-317"><a href="#cb51-317" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb51-318"><a href="#cb51-318" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'ret_excess' and 'mkt_excess' columns</span></span>
<span id="cb51-319"><a href="#cb51-319" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb51-320"><a href="#cb51-320" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum number of observations required for estimation</span></span>
<span id="cb51-321"><a href="#cb51-321" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-322"><a href="#cb51-322" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-323"><a href="#cb51-323" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-324"><a href="#cb51-324" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-325"><a href="#cb51-325" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with coefficient estimates and t-statistics,</span></span>
<span id="cb51-326"><a href="#cb51-326" aria-hidden="true" tabindex="-1"></a><span class="co">        or empty DataFrame if insufficient observations</span></span>
<span id="cb51-327"><a href="#cb51-327" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-328"><a href="#cb51-328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(data) <span class="op">&lt;</span> min_obs:</span>
<span id="cb51-329"><a href="#cb51-329" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-330"><a href="#cb51-330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-331"><a href="#cb51-331" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb51-332"><a href="#cb51-332" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate OLS regression</span></span>
<span id="cb51-333"><a href="#cb51-333" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> smf.ols(</span>
<span id="cb51-334"><a href="#cb51-334" aria-hidden="true" tabindex="-1"></a>            formula<span class="op">=</span><span class="st">"ret_excess ~ mkt_excess"</span>, </span>
<span id="cb51-335"><a href="#cb51-335" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>data</span>
<span id="cb51-336"><a href="#cb51-336" aria-hidden="true" tabindex="-1"></a>        ).fit()</span>
<span id="cb51-337"><a href="#cb51-337" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-338"><a href="#cb51-338" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract coefficient table</span></span>
<span id="cb51-339"><a href="#cb51-339" aria-hidden="true" tabindex="-1"></a>        coef_table <span class="op">=</span> model.summary2().tables[<span class="dv">1</span>]</span>
<span id="cb51-340"><a href="#cb51-340" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-341"><a href="#cb51-341" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Format results</span></span>
<span id="cb51-342"><a href="#cb51-342" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb51-343"><a href="#cb51-343" aria-hidden="true" tabindex="-1"></a>            <span class="st">"coefficient"</span>: [<span class="st">"alpha"</span>, <span class="st">"beta"</span>],</span>
<span id="cb51-344"><a href="#cb51-344" aria-hidden="true" tabindex="-1"></a>            <span class="st">"estimate"</span>: [</span>
<span id="cb51-345"><a href="#cb51-345" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"Intercept"</span>, <span class="st">"Coef."</span>],</span>
<span id="cb51-346"><a href="#cb51-346" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"mkt_excess"</span>, <span class="st">"Coef."</span>]</span>
<span id="cb51-347"><a href="#cb51-347" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb51-348"><a href="#cb51-348" aria-hidden="true" tabindex="-1"></a>            <span class="st">"t_statistic"</span>: [</span>
<span id="cb51-349"><a href="#cb51-349" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"Intercept"</span>, <span class="st">"t"</span>],</span>
<span id="cb51-350"><a href="#cb51-350" aria-hidden="true" tabindex="-1"></a>                coef_table.loc[<span class="st">"mkt_excess"</span>, <span class="st">"t"</span>]</span>
<span id="cb51-351"><a href="#cb51-351" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb51-352"><a href="#cb51-352" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r_squared"</span>: model.rsquared</span>
<span id="cb51-353"><a href="#cb51-353" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb51-354"><a href="#cb51-354" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-355"><a href="#cb51-355" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb51-356"><a href="#cb51-356" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-357"><a href="#cb51-357" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb51-358"><a href="#cb51-358" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Return empty DataFrame if estimation fails</span></span>
<span id="cb51-359"><a href="#cb51-359" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-360"><a href="#cb51-360" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-361"><a href="#cb51-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-362"><a href="#cb51-362" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rolling-Window Estimation</span></span>
<span id="cb51-363"><a href="#cb51-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-364"><a href="#cb51-364" aria-hidden="true" tabindex="-1"></a><span class="fu">### Motivation for Rolling Windows</span></span>
<span id="cb51-365"><a href="#cb51-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-366"><a href="#cb51-366" aria-hidden="true" tabindex="-1"></a>Stock betas are not constant over time. A company's business mix, leverage, and operating environment evolve, causing its systematic risk exposure to change. To capture this time variation, we use rolling-window estimation: at each point in time, we estimate beta using only data from a fixed lookback period (e.g., the past 60 months).</span>
<span id="cb51-367"><a href="#cb51-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-368"><a href="#cb51-368" aria-hidden="true" tabindex="-1"></a>Rolling-window estimation involves a trade-off:</span>
<span id="cb51-369"><a href="#cb51-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-370"><a href="#cb51-370" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Longer windows** provide more observations and thus more precise estimates, but may include stale information.</span>
<span id="cb51-371"><a href="#cb51-371" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Shorter windows** are more responsive to changes but produce noisier estimates.</span>
<span id="cb51-372"><a href="#cb51-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-373"><a href="#cb51-373" aria-hidden="true" tabindex="-1"></a>A common choice in academic research is 60 months (5 years) of monthly data, requiring at least 48 valid observations for estimation.</span>
<span id="cb51-374"><a href="#cb51-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-375"><a href="#cb51-375" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rolling Window Implementation</span></span>
<span id="cb51-376"><a href="#cb51-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-377"><a href="#cb51-377" aria-hidden="true" tabindex="-1"></a>The following function implements rolling-window CAPM estimation. For each month in the sample, it looks back over the specified window and estimates beta using all available data within that window.</span>
<span id="cb51-378"><a href="#cb51-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-381"><a href="#cb51-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-382"><a href="#cb51-382" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_capm_estimation(data, look_back<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb51-383"><a href="#cb51-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-384"><a href="#cb51-384" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform rolling-window CAPM estimation.</span></span>
<span id="cb51-385"><a href="#cb51-385" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-386"><a href="#cb51-386" aria-hidden="true" tabindex="-1"></a><span class="co">    This function slides a window across time, estimating the CAPM</span></span>
<span id="cb51-387"><a href="#cb51-387" aria-hidden="true" tabindex="-1"></a><span class="co">    regression at each point using the most recent 'look_back' months</span></span>
<span id="cb51-388"><a href="#cb51-388" aria-hidden="true" tabindex="-1"></a><span class="co">    of data.</span></span>
<span id="cb51-389"><a href="#cb51-389" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-390"><a href="#cb51-390" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-391"><a href="#cb51-391" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-392"><a href="#cb51-392" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb51-393"><a href="#cb51-393" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'date', 'ret_excess', and 'mkt_excess' columns</span></span>
<span id="cb51-394"><a href="#cb51-394" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back : int</span></span>
<span id="cb51-395"><a href="#cb51-395" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of months in the estimation window</span></span>
<span id="cb51-396"><a href="#cb51-396" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb51-397"><a href="#cb51-397" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum observations required within each window</span></span>
<span id="cb51-398"><a href="#cb51-398" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-399"><a href="#cb51-399" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-400"><a href="#cb51-400" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-401"><a href="#cb51-401" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-402"><a href="#cb51-402" aria-hidden="true" tabindex="-1"></a><span class="co">        Time series of coefficient estimates with dates</span></span>
<span id="cb51-403"><a href="#cb51-403" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-404"><a href="#cb51-404" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted by date</span></span>
<span id="cb51-405"><a href="#cb51-405" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb51-406"><a href="#cb51-406" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-407"><a href="#cb51-407" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get unique dates</span></span>
<span id="cb51-408"><a href="#cb51-408" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> data[<span class="st">"date"</span>].drop_duplicates().sort_values()</span>
<span id="cb51-409"><a href="#cb51-409" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-410"><a href="#cb51-410" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Container for results</span></span>
<span id="cb51-411"><a href="#cb51-411" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb51-412"><a href="#cb51-412" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-413"><a href="#cb51-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Slide window across dates</span></span>
<span id="cb51-414"><a href="#cb51-414" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(look_back <span class="op">-</span> <span class="dv">1</span>, <span class="bu">len</span>(dates)):</span>
<span id="cb51-415"><a href="#cb51-415" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define window boundaries</span></span>
<span id="cb51-416"><a href="#cb51-416" aria-hidden="true" tabindex="-1"></a>        end_date <span class="op">=</span> dates.iloc[i]</span>
<span id="cb51-417"><a href="#cb51-417" aria-hidden="true" tabindex="-1"></a>        start_date <span class="op">=</span> end_date <span class="op">-</span> relativedelta(months<span class="op">=</span>look_back <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb51-418"><a href="#cb51-418" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-419"><a href="#cb51-419" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract data within window</span></span>
<span id="cb51-420"><a href="#cb51-420" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> data.query(<span class="st">"date &gt;= @start_date and date &lt;= @end_date"</span>)</span>
<span id="cb51-421"><a href="#cb51-421" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-422"><a href="#cb51-422" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimate CAPM for this window</span></span>
<span id="cb51-423"><a href="#cb51-423" aria-hidden="true" tabindex="-1"></a>        window_results <span class="op">=</span> estimate_capm(window_data, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb51-424"><a href="#cb51-424" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-425"><a href="#cb51-425" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> window_results.empty:</span>
<span id="cb51-426"><a href="#cb51-426" aria-hidden="true" tabindex="-1"></a>            window_results[<span class="st">"date"</span>] <span class="op">=</span> end_date</span>
<span id="cb51-427"><a href="#cb51-427" aria-hidden="true" tabindex="-1"></a>            results.append(window_results)</span>
<span id="cb51-428"><a href="#cb51-428" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-429"><a href="#cb51-429" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all results</span></span>
<span id="cb51-430"><a href="#cb51-430" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb51-431"><a href="#cb51-431" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-432"><a href="#cb51-432" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb51-433"><a href="#cb51-433" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-434"><a href="#cb51-434" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-435"><a href="#cb51-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-436"><a href="#cb51-436" aria-hidden="true" tabindex="-1"></a><span class="fu">### Example: Rolling Betas for Selected Stocks</span></span>
<span id="cb51-437"><a href="#cb51-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-438"><a href="#cb51-438" aria-hidden="true" tabindex="-1"></a>We demonstrate rolling-window estimation for several well-known Vietnamese stocks spanning different industries.</span>
<span id="cb51-439"><a href="#cb51-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-442"><a href="#cb51-442" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-443"><a href="#cb51-443" aria-hidden="true" tabindex="-1"></a><span class="co"># Define example stocks</span></span>
<span id="cb51-444"><a href="#cb51-444" aria-hidden="true" tabindex="-1"></a>examples <span class="op">=</span> pd.DataFrame({</span>
<span id="cb51-445"><a href="#cb51-445" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>: [<span class="st">"FPT"</span>, <span class="st">"VNM"</span>, <span class="st">"VIC"</span>, <span class="st">"HPG"</span>, <span class="st">"VCB"</span>],</span>
<span id="cb51-446"><a href="#cb51-446" aria-hidden="true" tabindex="-1"></a>    <span class="st">"company"</span>: [</span>
<span id="cb51-447"><a href="#cb51-447" aria-hidden="true" tabindex="-1"></a>        <span class="st">"FPT Corporation"</span>,      <span class="co"># Technology</span></span>
<span id="cb51-448"><a href="#cb51-448" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vinamilk"</span>,             <span class="co"># Consumer goods</span></span>
<span id="cb51-449"><a href="#cb51-449" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vingroup"</span>,             <span class="co"># Real estate/conglomerate</span></span>
<span id="cb51-450"><a href="#cb51-450" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Hoa Phat Group"</span>,       <span class="co"># Steel/materials</span></span>
<span id="cb51-451"><a href="#cb51-451" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Vietcombank"</span>           <span class="co"># Banking</span></span>
<span id="cb51-452"><a href="#cb51-452" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb51-453"><a href="#cb51-453" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb51-454"><a href="#cb51-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-455"><a href="#cb51-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Check data availability for each example</span></span>
<span id="cb51-456"><a href="#cb51-456" aria-hidden="true" tabindex="-1"></a>data_availability <span class="op">=</span> (prices_monthly</span>
<span id="cb51-457"><a href="#cb51-457" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol in @examples['symbol']"</span>)</span>
<span id="cb51-458"><a href="#cb51-458" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb51-459"><a href="#cb51-459" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb51-460"><a href="#cb51-460" aria-hidden="true" tabindex="-1"></a>        n_obs<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"count"</span>),</span>
<span id="cb51-461"><a href="#cb51-461" aria-hidden="true" tabindex="-1"></a>        first_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"min"</span>),</span>
<span id="cb51-462"><a href="#cb51-462" aria-hidden="true" tabindex="-1"></a>        last_date<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"max"</span>)</span>
<span id="cb51-463"><a href="#cb51-463" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-464"><a href="#cb51-464" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-465"><a href="#cb51-465" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-466"><a href="#cb51-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-467"><a href="#cb51-467" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Data availability for example stocks:"</span>)</span>
<span id="cb51-468"><a href="#cb51-468" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(data_availability)</span>
<span id="cb51-469"><a href="#cb51-469" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-470"><a href="#cb51-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-473"><a href="#cb51-473" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-474"><a href="#cb51-474" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate rolling betas for example stocks</span></span>
<span id="cb51-475"><a href="#cb51-475" aria-hidden="true" tabindex="-1"></a>example_data <span class="op">=</span> prices_monthly.query(<span class="st">"symbol in @examples['symbol']"</span>)</span>
<span id="cb51-476"><a href="#cb51-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-477"><a href="#cb51-477" aria-hidden="true" tabindex="-1"></a>capm_examples <span class="op">=</span> (example_data</span>
<span id="cb51-478"><a href="#cb51-478" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-479"><a href="#cb51-479" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: roll_capm_estimation(x), include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb51-480"><a href="#cb51-480" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-481"><a href="#cb51-481" aria-hidden="true" tabindex="-1"></a>    .drop(columns<span class="op">=</span><span class="st">"level_1"</span>, errors<span class="op">=</span><span class="st">"ignore"</span>)</span>
<span id="cb51-482"><a href="#cb51-482" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-483"><a href="#cb51-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-484"><a href="#cb51-484" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to beta estimates only</span></span>
<span id="cb51-485"><a href="#cb51-485" aria-hidden="true" tabindex="-1"></a>beta_examples <span class="op">=</span> (capm_examples</span>
<span id="cb51-486"><a href="#cb51-486" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb51-487"><a href="#cb51-487" aria-hidden="true" tabindex="-1"></a>    .merge(examples, on<span class="op">=</span><span class="st">"symbol"</span>)</span>
<span id="cb51-488"><a href="#cb51-488" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-489"><a href="#cb51-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-490"><a href="#cb51-490" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rolling beta estimates: </span><span class="sc">{</span><span class="bu">len</span>(beta_examples)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb51-491"><a href="#cb51-491" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-492"><a href="#cb51-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-493"><a href="#cb51-493" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing Rolling Betas</span></span>
<span id="cb51-494"><a href="#cb51-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-495"><a href="#cb51-495" aria-hidden="true" tabindex="-1"></a>@fig-rolling-betas displays the time series of beta estimates for our example stocks. The figure reveals how systematic risk exposure evolves differently across industries.</span>
<span id="cb51-496"><a href="#cb51-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-499"><a href="#cb51-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-500"><a href="#cb51-500" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rolling-betas</span></span>
<span id="cb51-501"><a href="#cb51-501" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: "90%"</span></span>
<span id="cb51-502"><a href="#cb51-502" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-align: "center"</span></span>
<span id="cb51-503"><a href="#cb51-503" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Monthly rolling beta estimates for selected Vietnamese stocks using a 60-month estimation window. Different industries exhibit distinct patterns of market sensitivity over time."</span></span>
<span id="cb51-504"><a href="#cb51-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing time series of beta estimates for five Vietnamese stocks from different industries."</span></span>
<span id="cb51-505"><a href="#cb51-505" aria-hidden="true" tabindex="-1"></a>rolling_beta_figure <span class="op">=</span> (</span>
<span id="cb51-506"><a href="#cb51-506" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb51-507"><a href="#cb51-507" aria-hidden="true" tabindex="-1"></a>        beta_examples,</span>
<span id="cb51-508"><a href="#cb51-508" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"estimate"</span>, color<span class="op">=</span><span class="st">"company"</span>)</span>
<span id="cb51-509"><a href="#cb51-509" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-510"><a href="#cb51-510" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb51-511"><a href="#cb51-511" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb51-512"><a href="#cb51-512" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-513"><a href="#cb51-513" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-514"><a href="#cb51-514" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb51-515"><a href="#cb51-515" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-516"><a href="#cb51-516" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Rolling Beta Estimates (60-Month Window)"</span></span>
<span id="cb51-517"><a href="#cb51-517" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-518"><a href="#cb51-518" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-519"><a href="#cb51-519" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-520"><a href="#cb51-520" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb51-521"><a href="#cb51-521" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-522"><a href="#cb51-522" aria-hidden="true" tabindex="-1"></a>rolling_beta_figure.show()</span>
<span id="cb51-523"><a href="#cb51-523" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-524"><a href="#cb51-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-525"><a href="#cb51-525" aria-hidden="true" tabindex="-1"></a>Several patterns emerge from the figure:</span>
<span id="cb51-526"><a href="#cb51-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-527"><a href="#cb51-527" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Industry differences**: Technology and banking stocks may exhibit different beta patterns than real estate or consumer goods companies.</span>
<span id="cb51-528"><a href="#cb51-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-529"><a href="#cb51-529" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Time variation**: Betas are not constant. They respond to changes in business conditions, leverage, and market regimes.</span>
<span id="cb51-530"><a href="#cb51-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-531"><a href="#cb51-531" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Crisis periods**: Market stress periods (e.g., 2008 financial crisis, 2020 COVID-19) often see beta estimates change as correlations across stocks increase.</span>
<span id="cb51-532"><a href="#cb51-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-533"><a href="#cb51-533" aria-hidden="true" tabindex="-1"></a><span class="fu">## Parallelized Estimation for the Full Market</span></span>
<span id="cb51-534"><a href="#cb51-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-535"><a href="#cb51-535" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Computational Challenge</span></span>
<span id="cb51-536"><a href="#cb51-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-537"><a href="#cb51-537" aria-hidden="true" tabindex="-1"></a>Estimating rolling betas for all stocks in our database is computationally intensive. With hundreds of stocks, each requiring rolling estimation across many time periods, sequential processing would take considerable time. Fortunately, beta estimation for different stocks is independent (i.e., the estimate for stock A does not depend on the estimate for stock B). This independence makes the problem ideal for parallelization.</span>
<span id="cb51-538"><a href="#cb51-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-539"><a href="#cb51-539" aria-hidden="true" tabindex="-1"></a><span class="fu">### Setting Up Parallel Processing</span></span>
<span id="cb51-540"><a href="#cb51-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-541"><a href="#cb51-541" aria-hidden="true" tabindex="-1"></a>We use the <span class="in">`joblib`</span> library to distribute computation across multiple CPU cores. The <span class="in">`Parallel`</span> class manages worker processes, while <span class="in">`delayed`</span> wraps function calls for deferred execution.</span>
<span id="cb51-542"><a href="#cb51-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-545"><a href="#cb51-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-546"><a href="#cb51-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine available cores (reserve one for system operations)</span></span>
<span id="cb51-547"><a href="#cb51-547" aria-hidden="true" tabindex="-1"></a>n_cores <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb51-548"><a href="#cb51-548" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Available cores for parallel processing: </span><span class="sc">{</span>n_cores<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-549"><a href="#cb51-549" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-550"><a href="#cb51-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-551"><a href="#cb51-551" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parallel Beta Estimation</span></span>
<span id="cb51-552"><a href="#cb51-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-553"><a href="#cb51-553" aria-hidden="true" tabindex="-1"></a>The following code estimates rolling betas for all stocks in parallel. Each stock is processed independently by a separate worker.</span>
<span id="cb51-554"><a href="#cb51-554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-557"><a href="#cb51-557" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-558"><a href="#cb51-558" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_all_betas_parallel(data, n_cores, look_back<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">48</span>):</span>
<span id="cb51-559"><a href="#cb51-559" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-560"><a href="#cb51-560" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate rolling betas for all stocks using parallel processing.</span></span>
<span id="cb51-561"><a href="#cb51-561" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-562"><a href="#cb51-562" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-563"><a href="#cb51-563" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-564"><a href="#cb51-564" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb51-565"><a href="#cb51-565" aria-hidden="true" tabindex="-1"></a><span class="co">        Full dataset with all stocks</span></span>
<span id="cb51-566"><a href="#cb51-566" aria-hidden="true" tabindex="-1"></a><span class="co">    n_cores : int</span></span>
<span id="cb51-567"><a href="#cb51-567" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of CPU cores to use</span></span>
<span id="cb51-568"><a href="#cb51-568" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back : int</span></span>
<span id="cb51-569"><a href="#cb51-569" aria-hidden="true" tabindex="-1"></a><span class="co">        Months in estimation window</span></span>
<span id="cb51-570"><a href="#cb51-570" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb51-571"><a href="#cb51-571" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum observations required</span></span>
<span id="cb51-572"><a href="#cb51-572" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-573"><a href="#cb51-573" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-574"><a href="#cb51-574" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-575"><a href="#cb51-575" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-576"><a href="#cb51-576" aria-hidden="true" tabindex="-1"></a><span class="co">        Beta estimates for all stocks and dates</span></span>
<span id="cb51-577"><a href="#cb51-577" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-578"><a href="#cb51-578" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group data by stock</span></span>
<span id="cb51-579"><a href="#cb51-579" aria-hidden="true" tabindex="-1"></a>    grouped <span class="op">=</span> data.groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb51-580"><a href="#cb51-580" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-581"><a href="#cb51-581" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define worker function</span></span>
<span id="cb51-582"><a href="#cb51-582" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> process_stock(name, group):</span>
<span id="cb51-583"><a href="#cb51-583" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> roll_capm_estimation(group, look_back<span class="op">=</span>look_back, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb51-584"><a href="#cb51-584" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> result.empty:</span>
<span id="cb51-585"><a href="#cb51-585" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">"symbol"</span>] <span class="op">=</span> name</span>
<span id="cb51-586"><a href="#cb51-586" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> result</span>
<span id="cb51-587"><a href="#cb51-587" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-588"><a href="#cb51-588" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Execute in parallel</span></span>
<span id="cb51-589"><a href="#cb51-589" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_cores, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb51-590"><a href="#cb51-590" aria-hidden="true" tabindex="-1"></a>        delayed(process_stock)(name, group) </span>
<span id="cb51-591"><a href="#cb51-591" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> name, group <span class="kw">in</span> grouped</span>
<span id="cb51-592"><a href="#cb51-592" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-593"><a href="#cb51-593" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-594"><a href="#cb51-594" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine results</span></span>
<span id="cb51-595"><a href="#cb51-595" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> results <span class="cf">if</span> <span class="kw">not</span> r.empty]</span>
<span id="cb51-596"><a href="#cb51-596" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb51-597"><a href="#cb51-597" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-598"><a href="#cb51-598" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb51-599"><a href="#cb51-599" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-600"><a href="#cb51-600" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-601"><a href="#cb51-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-604"><a href="#cb51-604" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-605"><a href="#cb51-605" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-606"><a href="#cb51-606" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate betas for all stocks</span></span>
<span id="cb51-607"><a href="#cb51-607" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Estimating rolling betas for all stocks..."</span>)</span>
<span id="cb51-608"><a href="#cb51-608" aria-hidden="true" tabindex="-1"></a>capm_monthly <span class="op">=</span> estimate_all_betas_parallel(</span>
<span id="cb51-609"><a href="#cb51-609" aria-hidden="true" tabindex="-1"></a>    prices_monthly, </span>
<span id="cb51-610"><a href="#cb51-610" aria-hidden="true" tabindex="-1"></a>    n_cores<span class="op">=</span>n_cores,</span>
<span id="cb51-611"><a href="#cb51-611" aria-hidden="true" tabindex="-1"></a>    look_back<span class="op">=</span><span class="dv">60</span>,</span>
<span id="cb51-612"><a href="#cb51-612" aria-hidden="true" tabindex="-1"></a>    min_obs<span class="op">=</span><span class="dv">48</span></span>
<span id="cb51-613"><a href="#cb51-613" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-614"><a href="#cb51-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-615"><a href="#cb51-615" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed: </span><span class="sc">{</span><span class="bu">len</span>(capm_monthly)<span class="sc">:,}</span><span class="ss"> coefficient estimates"</span>)</span>
<span id="cb51-616"><a href="#cb51-616" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>capm_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-617"><a href="#cb51-617" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-618"><a href="#cb51-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-619"><a href="#cb51-619" aria-hidden="true" tabindex="-1"></a><span class="fu">### Storing Results</span></span>
<span id="cb51-620"><a href="#cb51-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-621"><a href="#cb51-621" aria-hidden="true" tabindex="-1"></a>We save the CAPM estimates to our database for use in subsequent chapters.</span>
<span id="cb51-622"><a href="#cb51-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-625"><a href="#cb51-625" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-626"><a href="#cb51-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-627"><a href="#cb51-627" aria-hidden="true" tabindex="-1"></a>capm_monthly.to_sql(</span>
<span id="cb51-628"><a href="#cb51-628" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"capm_monthly"</span>,</span>
<span id="cb51-629"><a href="#cb51-629" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-630"><a href="#cb51-630" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-631"><a href="#cb51-631" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-632"><a href="#cb51-632" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-633"><a href="#cb51-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-634"><a href="#cb51-634" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM estimates saved to database."</span>)</span>
<span id="cb51-635"><a href="#cb51-635" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-636"><a href="#cb51-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-637"><a href="#cb51-637" aria-hidden="true" tabindex="-1"></a>For subsequent analysis, we load the pre-computed estimates:</span>
<span id="cb51-638"><a href="#cb51-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-641"><a href="#cb51-641" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-642"><a href="#cb51-642" aria-hidden="true" tabindex="-1"></a>capm_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-643"><a href="#cb51-643" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM capm_monthly"</span>,</span>
<span id="cb51-644"><a href="#cb51-644" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-645"><a href="#cb51-645" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-646"><a href="#cb51-646" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-647"><a href="#cb51-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-648"><a href="#cb51-648" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(capm_monthly)<span class="sc">:,}</span><span class="ss"> CAPM estimates"</span>)</span>
<span id="cb51-649"><a href="#cb51-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-650"><a href="#cb51-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-651"><a href="#cb51-651" aria-hidden="true" tabindex="-1"></a><span class="fu">## Beta Estimation Using Daily Returns</span></span>
<span id="cb51-652"><a href="#cb51-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-653"><a href="#cb51-653" aria-hidden="true" tabindex="-1"></a>While monthly returns are standard in academic research, some applications benefit from higher-frequency data:</span>
<span id="cb51-654"><a href="#cb51-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-655"><a href="#cb51-655" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Shorter estimation windows**: Daily data allows meaningful estimation over shorter periods (e.g., 3 months rather than 5 years).</span>
<span id="cb51-656"><a href="#cb51-656" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**More responsive estimates**: Daily betas capture changes more quickly.</span>
<span id="cb51-657"><a href="#cb51-657" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Event studies**: High-frequency betas are useful for analyzing market reactions to specific events.</span>
<span id="cb51-658"><a href="#cb51-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-659"><a href="#cb51-659" aria-hidden="true" tabindex="-1"></a>However, daily data introduces additional challenges:</span>
<span id="cb51-660"><a href="#cb51-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-661"><a href="#cb51-661" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Microstructure noise**: Bid-ask bounce and other trading frictions add noise to returns.</span>
<span id="cb51-662"><a href="#cb51-662" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Non-synchronous trading**: Less liquid stocks may not trade every day, biasing beta estimates downward.</span>
<span id="cb51-663"><a href="#cb51-663" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Computational burden**: Daily data is roughly 21 times larger than monthly data.</span>
<span id="cb51-664"><a href="#cb51-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-665"><a href="#cb51-665" aria-hidden="true" tabindex="-1"></a><span class="fu">### Batch Processing for Daily Data</span></span>
<span id="cb51-666"><a href="#cb51-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-667"><a href="#cb51-667" aria-hidden="true" tabindex="-1"></a>Given the size of daily data, we process stocks in batches to manage memory constraints. This approach loads and processes a subset of stocks, saves results, and proceeds to the next batch.</span>
<span id="cb51-668"><a href="#cb51-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-671"><a href="#cb51-671" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-672"><a href="#cb51-672" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_market_return_daily(tidy_finance):</span>
<span id="cb51-673"><a href="#cb51-673" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-674"><a href="#cb51-674" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute daily value-weighted market excess return from stock data.</span></span>
<span id="cb51-675"><a href="#cb51-675" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-676"><a href="#cb51-676" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Load daily prices with market cap for weighting</span></span>
<span id="cb51-677"><a href="#cb51-677" aria-hidden="true" tabindex="-1"></a>    prices_daily_full <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-678"><a href="#cb51-678" aria-hidden="true" tabindex="-1"></a>        sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb51-679"><a href="#cb51-679" aria-hidden="true" tabindex="-1"></a><span class="st">            SELECT p.symbol, p.date, p.ret_excess, m.mktcap_lag</span></span>
<span id="cb51-680"><a href="#cb51-680" aria-hidden="true" tabindex="-1"></a><span class="st">            FROM prices_daily p</span></span>
<span id="cb51-681"><a href="#cb51-681" aria-hidden="true" tabindex="-1"></a><span class="st">            LEFT JOIN prices_monthly m ON p.symbol = m.symbol </span></span>
<span id="cb51-682"><a href="#cb51-682" aria-hidden="true" tabindex="-1"></a><span class="st">                AND strftime('%Y-%m', p.date) = strftime('%Y-%m', m.date)</span></span>
<span id="cb51-683"><a href="#cb51-683" aria-hidden="true" tabindex="-1"></a><span class="st">        """</span>,</span>
<span id="cb51-684"><a href="#cb51-684" aria-hidden="true" tabindex="-1"></a>        con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-685"><a href="#cb51-685" aria-hidden="true" tabindex="-1"></a>        parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-686"><a href="#cb51-686" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-687"><a href="#cb51-687" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-688"><a href="#cb51-688" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute value-weighted market return each day</span></span>
<span id="cb51-689"><a href="#cb51-689" aria-hidden="true" tabindex="-1"></a>    mkt_daily <span class="op">=</span> (prices_daily_full</span>
<span id="cb51-690"><a href="#cb51-690" aria-hidden="true" tabindex="-1"></a>        .dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb51-691"><a href="#cb51-691" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"date"</span>)</span>
<span id="cb51-692"><a href="#cb51-692" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> x: np.average(x[<span class="st">"ret_excess"</span>], weights<span class="op">=</span>x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb51-693"><a href="#cb51-693" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"mkt_excess"</span>)</span>
<span id="cb51-694"><a href="#cb51-694" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-695"><a href="#cb51-695" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-696"><a href="#cb51-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mkt_daily</span>
<span id="cb51-697"><a href="#cb51-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-698"><a href="#cb51-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-699"><a href="#cb51-699" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_capm_estimation_daily(data, look_back_days<span class="op">=</span><span class="dv">1260</span>, min_obs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb51-700"><a href="#cb51-700" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-701"><a href="#cb51-701" aria-hidden="true" tabindex="-1"></a><span class="co">    Perform rolling-window CAPM estimation using daily data.</span></span>
<span id="cb51-702"><a href="#cb51-702" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-703"><a href="#cb51-703" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-704"><a href="#cb51-704" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-705"><a href="#cb51-705" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb51-706"><a href="#cb51-706" aria-hidden="true" tabindex="-1"></a><span class="co">        DataFrame with 'date', 'ret_excess', and 'mkt_excess' columns</span></span>
<span id="cb51-707"><a href="#cb51-707" aria-hidden="true" tabindex="-1"></a><span class="co">    look_back_days : int</span></span>
<span id="cb51-708"><a href="#cb51-708" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of trading days in the estimation window</span></span>
<span id="cb51-709"><a href="#cb51-709" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : int</span></span>
<span id="cb51-710"><a href="#cb51-710" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum daily observations required within each window</span></span>
<span id="cb51-711"><a href="#cb51-711" aria-hidden="true" tabindex="-1"></a><span class="co">        </span></span>
<span id="cb51-712"><a href="#cb51-712" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-713"><a href="#cb51-713" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-714"><a href="#cb51-714" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-715"><a href="#cb51-715" aria-hidden="true" tabindex="-1"></a><span class="co">        Time series of coefficient estimates with dates</span></span>
<span id="cb51-716"><a href="#cb51-716" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-717"><a href="#cb51-717" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data.sort_values(<span class="st">"date"</span>).copy()</span>
<span id="cb51-718"><a href="#cb51-718" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> data[<span class="st">"date"</span>].drop_duplicates().sort_values().reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-719"><a href="#cb51-719" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-720"><a href="#cb51-720" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb51-721"><a href="#cb51-721" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-722"><a href="#cb51-722" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(look_back_days <span class="op">-</span> <span class="dv">1</span>, <span class="bu">len</span>(dates)):</span>
<span id="cb51-723"><a href="#cb51-723" aria-hidden="true" tabindex="-1"></a>        end_date <span class="op">=</span> dates.iloc[i]</span>
<span id="cb51-724"><a href="#cb51-724" aria-hidden="true" tabindex="-1"></a>        start_idx <span class="op">=</span> <span class="bu">max</span>(<span class="dv">0</span>, i <span class="op">-</span> look_back_days <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb51-725"><a href="#cb51-725" aria-hidden="true" tabindex="-1"></a>        start_date <span class="op">=</span> dates.iloc[start_idx]</span>
<span id="cb51-726"><a href="#cb51-726" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-727"><a href="#cb51-727" aria-hidden="true" tabindex="-1"></a>        window_data <span class="op">=</span> data.query(<span class="st">"date &gt;= @start_date and date &lt;= @end_date"</span>)</span>
<span id="cb51-728"><a href="#cb51-728" aria-hidden="true" tabindex="-1"></a>        window_results <span class="op">=</span> estimate_capm(window_data, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb51-729"><a href="#cb51-729" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-730"><a href="#cb51-730" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> window_results.empty:</span>
<span id="cb51-731"><a href="#cb51-731" aria-hidden="true" tabindex="-1"></a>            window_results[<span class="st">"date"</span>] <span class="op">=</span> end_date</span>
<span id="cb51-732"><a href="#cb51-732" aria-hidden="true" tabindex="-1"></a>            results.append(window_results)</span>
<span id="cb51-733"><a href="#cb51-733" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-734"><a href="#cb51-734" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb51-735"><a href="#cb51-735" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-736"><a href="#cb51-736" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb51-737"><a href="#cb51-737" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-738"><a href="#cb51-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-739"><a href="#cb51-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-740"><a href="#cb51-740" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_daily_betas_batch(symbols, tidy_finance, n_cores, batch_size<span class="op">=</span><span class="dv">500</span>, </span>
<span id="cb51-741"><a href="#cb51-741" aria-hidden="true" tabindex="-1"></a>                                look_back_days<span class="op">=</span><span class="dv">1260</span>, min_obs<span class="op">=</span><span class="dv">1000</span>):</span>
<span id="cb51-742"><a href="#cb51-742" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-743"><a href="#cb51-743" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate rolling betas from daily data using batch processing.</span></span>
<span id="cb51-744"><a href="#cb51-744" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-745"><a href="#cb51-745" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First, compute or load market return</span></span>
<span id="cb51-746"><a href="#cb51-746" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Computing daily market excess returns..."</span>)</span>
<span id="cb51-747"><a href="#cb51-747" aria-hidden="true" tabindex="-1"></a>    mkt_daily <span class="op">=</span> compute_market_return_daily(tidy_finance)</span>
<span id="cb51-748"><a href="#cb51-748" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Market returns: </span><span class="sc">{</span><span class="bu">len</span>(mkt_daily)<span class="sc">}</span><span class="ss"> days"</span>)</span>
<span id="cb51-749"><a href="#cb51-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-750"><a href="#cb51-750" aria-hidden="true" tabindex="-1"></a>    n_batches <span class="op">=</span> <span class="bu">int</span>(np.ceil(<span class="bu">len</span>(symbols) <span class="op">/</span> batch_size))</span>
<span id="cb51-751"><a href="#cb51-751" aria-hidden="true" tabindex="-1"></a>    all_results <span class="op">=</span> []</span>
<span id="cb51-752"><a href="#cb51-752" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-753"><a href="#cb51-753" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(n_batches):</span>
<span id="cb51-754"><a href="#cb51-754" aria-hidden="true" tabindex="-1"></a>        batch_start <span class="op">=</span> j <span class="op">*</span> batch_size</span>
<span id="cb51-755"><a href="#cb51-755" aria-hidden="true" tabindex="-1"></a>        batch_end <span class="op">=</span> <span class="bu">min</span>((j <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> batch_size, <span class="bu">len</span>(symbols))</span>
<span id="cb51-756"><a href="#cb51-756" aria-hidden="true" tabindex="-1"></a>        batch_symbols <span class="op">=</span> symbols[batch_start:batch_end]</span>
<span id="cb51-757"><a href="#cb51-757" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-758"><a href="#cb51-758" aria-hidden="true" tabindex="-1"></a>        symbol_list <span class="op">=</span> <span class="st">", "</span>.join(<span class="ss">f"'</span><span class="sc">{</span>s<span class="sc">}</span><span class="ss">'"</span> <span class="cf">for</span> s <span class="kw">in</span> batch_symbols)</span>
<span id="cb51-759"><a href="#cb51-759" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-760"><a href="#cb51-760" aria-hidden="true" tabindex="-1"></a>        query <span class="op">=</span> <span class="ss">f"""</span></span>
<span id="cb51-761"><a href="#cb51-761" aria-hidden="true" tabindex="-1"></a><span class="ss">            SELECT symbol, date, ret_excess</span></span>
<span id="cb51-762"><a href="#cb51-762" aria-hidden="true" tabindex="-1"></a><span class="ss">            FROM prices_daily</span></span>
<span id="cb51-763"><a href="#cb51-763" aria-hidden="true" tabindex="-1"></a><span class="ss">            WHERE symbol IN (</span><span class="sc">{</span>symbol_list<span class="sc">}</span><span class="ss">)</span></span>
<span id="cb51-764"><a href="#cb51-764" aria-hidden="true" tabindex="-1"></a><span class="ss">        """</span></span>
<span id="cb51-765"><a href="#cb51-765" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-766"><a href="#cb51-766" aria-hidden="true" tabindex="-1"></a>        prices_daily_batch <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-767"><a href="#cb51-767" aria-hidden="true" tabindex="-1"></a>            sql<span class="op">=</span>query,</span>
<span id="cb51-768"><a href="#cb51-768" aria-hidden="true" tabindex="-1"></a>            con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-769"><a href="#cb51-769" aria-hidden="true" tabindex="-1"></a>            parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-770"><a href="#cb51-770" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-771"><a href="#cb51-771" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-772"><a href="#cb51-772" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Merge with market excess return</span></span>
<span id="cb51-773"><a href="#cb51-773" aria-hidden="true" tabindex="-1"></a>        prices_daily_batch <span class="op">=</span> prices_daily_batch.merge(</span>
<span id="cb51-774"><a href="#cb51-774" aria-hidden="true" tabindex="-1"></a>            mkt_daily, </span>
<span id="cb51-775"><a href="#cb51-775" aria-hidden="true" tabindex="-1"></a>            on<span class="op">=</span><span class="st">"date"</span>, </span>
<span id="cb51-776"><a href="#cb51-776" aria-hidden="true" tabindex="-1"></a>            how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb51-777"><a href="#cb51-777" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-778"><a href="#cb51-778" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-779"><a href="#cb51-779" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Group by symbol and estimate betas</span></span>
<span id="cb51-780"><a href="#cb51-780" aria-hidden="true" tabindex="-1"></a>        grouped <span class="op">=</span> prices_daily_batch.groupby(<span class="st">"symbol"</span>, group_keys<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb51-781"><a href="#cb51-781" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-782"><a href="#cb51-782" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Parallel estimation</span></span>
<span id="cb51-783"><a href="#cb51-783" aria-hidden="true" tabindex="-1"></a>        batch_results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_cores)(</span>
<span id="cb51-784"><a href="#cb51-784" aria-hidden="true" tabindex="-1"></a>            delayed(<span class="kw">lambda</span> name, group: </span>
<span id="cb51-785"><a href="#cb51-785" aria-hidden="true" tabindex="-1"></a>                roll_capm_estimation_daily(group, look_back_days<span class="op">=</span>look_back_days, min_obs<span class="op">=</span>min_obs)</span>
<span id="cb51-786"><a href="#cb51-786" aria-hidden="true" tabindex="-1"></a>                .assign(symbol<span class="op">=</span>name)</span>
<span id="cb51-787"><a href="#cb51-787" aria-hidden="true" tabindex="-1"></a>            )(name, group)</span>
<span id="cb51-788"><a href="#cb51-788" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> name, group <span class="kw">in</span> grouped</span>
<span id="cb51-789"><a href="#cb51-789" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-790"><a href="#cb51-790" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-791"><a href="#cb51-791" aria-hidden="true" tabindex="-1"></a>        batch_results <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> batch_results <span class="cf">if</span> r <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="kw">not</span> r.empty]</span>
<span id="cb51-792"><a href="#cb51-792" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-793"><a href="#cb51-793" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> batch_results:</span>
<span id="cb51-794"><a href="#cb51-794" aria-hidden="true" tabindex="-1"></a>            all_results.append(pd.concat(batch_results, ignore_index<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb51-795"><a href="#cb51-795" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-796"><a href="#cb51-796" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Batch </span><span class="sc">{</span>j<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>n_batches<span class="sc">}</span><span class="ss"> complete"</span>)</span>
<span id="cb51-797"><a href="#cb51-797" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-798"><a href="#cb51-798" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> all_results:</span>
<span id="cb51-799"><a href="#cb51-799" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.concat(all_results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-800"><a href="#cb51-800" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb51-801"><a href="#cb51-801" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb51-802"><a href="#cb51-802" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-803"><a href="#cb51-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-806"><a href="#cb51-806" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-807"><a href="#cb51-807" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-808"><a href="#cb51-808" aria-hidden="true" tabindex="-1"></a>symbols <span class="op">=</span> prices_monthly[<span class="st">"symbol"</span>].unique().tolist()</span>
<span id="cb51-809"><a href="#cb51-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-810"><a href="#cb51-810" aria-hidden="true" tabindex="-1"></a>capm_daily <span class="op">=</span> estimate_daily_betas_batch(</span>
<span id="cb51-811"><a href="#cb51-811" aria-hidden="true" tabindex="-1"></a>    symbols<span class="op">=</span>symbols,</span>
<span id="cb51-812"><a href="#cb51-812" aria-hidden="true" tabindex="-1"></a>    tidy_finance<span class="op">=</span>tidy_finance,</span>
<span id="cb51-813"><a href="#cb51-813" aria-hidden="true" tabindex="-1"></a>    n_cores<span class="op">=</span>n_cores,</span>
<span id="cb51-814"><a href="#cb51-814" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span><span class="dv">500</span>,</span>
<span id="cb51-815"><a href="#cb51-815" aria-hidden="true" tabindex="-1"></a>    look_back_days<span class="op">=</span><span class="dv">1260</span>,  <span class="co"># ~5 years of trading days</span></span>
<span id="cb51-816"><a href="#cb51-816" aria-hidden="true" tabindex="-1"></a>    min_obs<span class="op">=</span><span class="dv">1000</span></span>
<span id="cb51-817"><a href="#cb51-817" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-818"><a href="#cb51-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-819"><a href="#cb51-819" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily beta estimates: </span><span class="sc">{</span><span class="bu">len</span>(capm_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-820"><a href="#cb51-820" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-821"><a href="#cb51-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-824"><a href="#cb51-824" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-825"><a href="#cb51-825" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-826"><a href="#cb51-826" aria-hidden="true" tabindex="-1"></a>capm_daily.to_sql(</span>
<span id="cb51-827"><a href="#cb51-827" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"capm_daily"</span>,</span>
<span id="cb51-828"><a href="#cb51-828" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-829"><a href="#cb51-829" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-830"><a href="#cb51-830" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-831"><a href="#cb51-831" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-832"><a href="#cb51-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-833"><a href="#cb51-833" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM estimates saved to database."</span>)</span>
<span id="cb51-834"><a href="#cb51-834" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-835"><a href="#cb51-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-836"><a href="#cb51-836" aria-hidden="true" tabindex="-1"></a>For subsequent analysis, we load the pre-computed estimates:</span>
<span id="cb51-837"><a href="#cb51-837" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-840"><a href="#cb51-840" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-841"><a href="#cb51-841" aria-hidden="true" tabindex="-1"></a>capm_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-842"><a href="#cb51-842" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM capm_daily"</span>,</span>
<span id="cb51-843"><a href="#cb51-843" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-844"><a href="#cb51-844" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-845"><a href="#cb51-845" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-846"><a href="#cb51-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-847"><a href="#cb51-847" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Loaded </span><span class="sc">{</span><span class="bu">len</span>(capm_daily)<span class="sc">:,}</span><span class="ss"> CAPM estimates"</span>)</span>
<span id="cb51-848"><a href="#cb51-848" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-849"><a href="#cb51-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-850"><a href="#cb51-850" aria-hidden="true" tabindex="-1"></a><span class="fu">## Analyzing Beta Estimates</span></span>
<span id="cb51-851"><a href="#cb51-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-852"><a href="#cb51-852" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extracting Beta Estimates</span></span>
<span id="cb51-853"><a href="#cb51-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-854"><a href="#cb51-854" aria-hidden="true" tabindex="-1"></a>We extract the beta coefficient estimates from our CAPM results for analysis.</span>
<span id="cb51-855"><a href="#cb51-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-858"><a href="#cb51-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-859"><a href="#cb51-859" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract monthly betas</span></span>
<span id="cb51-860"><a href="#cb51-860" aria-hidden="true" tabindex="-1"></a>beta_monthly <span class="op">=</span> (capm_monthly</span>
<span id="cb51-861"><a href="#cb51-861" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb51-862"><a href="#cb51-862" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"estimate"</span>: <span class="st">"beta"</span>})</span>
<span id="cb51-863"><a href="#cb51-863" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"beta"</span>]]</span>
<span id="cb51-864"><a href="#cb51-864" aria-hidden="true" tabindex="-1"></a>    .assign(frequency<span class="op">=</span><span class="st">"monthly"</span>)</span>
<span id="cb51-865"><a href="#cb51-865" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-866"><a href="#cb51-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-867"><a href="#cb51-867" aria-hidden="true" tabindex="-1"></a><span class="co"># Save to database</span></span>
<span id="cb51-868"><a href="#cb51-868" aria-hidden="true" tabindex="-1"></a>beta_monthly.to_sql(</span>
<span id="cb51-869"><a href="#cb51-869" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"beta_monthly"</span>,</span>
<span id="cb51-870"><a href="#cb51-870" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-871"><a href="#cb51-871" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-872"><a href="#cb51-872" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-873"><a href="#cb51-873" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-874"><a href="#cb51-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-875"><a href="#cb51-875" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly betas: </span><span class="sc">{</span><span class="bu">len</span>(beta_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb51-876"><a href="#cb51-876" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>beta_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-877"><a href="#cb51-877" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-878"><a href="#cb51-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-881"><a href="#cb51-881" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-882"><a href="#cb51-882" aria-hidden="true" tabindex="-1"></a><span class="co"># Load pre-computed betas</span></span>
<span id="cb51-883"><a href="#cb51-883" aria-hidden="true" tabindex="-1"></a>beta_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb51-884"><a href="#cb51-884" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT * FROM beta_monthly"</span>,</span>
<span id="cb51-885"><a href="#cb51-885" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-886"><a href="#cb51-886" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb51-887"><a href="#cb51-887" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-888"><a href="#cb51-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-889"><a href="#cb51-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-890"><a href="#cb51-890" aria-hidden="true" tabindex="-1"></a><span class="fu">### Summary Statistics</span></span>
<span id="cb51-891"><a href="#cb51-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-892"><a href="#cb51-892" aria-hidden="true" tabindex="-1"></a>We examine the distribution of beta estimates to verify their reasonableness.</span>
<span id="cb51-893"><a href="#cb51-893" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-896"><a href="#cb51-896" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-897"><a href="#cb51-897" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Beta Summary Statistics:"</span>)</span>
<span id="cb51-898"><a href="#cb51-898" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(beta_monthly[<span class="st">"beta"</span>].describe().<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb51-899"><a href="#cb51-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-900"><a href="#cb51-900" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional diagnostics</span></span>
<span id="cb51-901"><a href="#cb51-901" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Stocks with negative average beta: </span><span class="sc">{</span>(beta_monthly.groupby(<span class="st">'symbol'</span>)[<span class="st">'beta'</span>].mean() <span class="op">&lt;</span> <span class="dv">0</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-902"><a href="#cb51-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks with beta &gt; 2: </span><span class="sc">{</span>(beta_monthly.groupby(<span class="st">'symbol'</span>)[<span class="st">'beta'</span>].mean() <span class="op">&gt;</span> <span class="dv">2</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-903"><a href="#cb51-903" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-904"><a href="#cb51-904" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-905"><a href="#cb51-905" aria-hidden="true" tabindex="-1"></a><span class="fu">### Beta Distribution Across Industries</span></span>
<span id="cb51-906"><a href="#cb51-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-907"><a href="#cb51-907" aria-hidden="true" tabindex="-1"></a>Different industries have different exposures to systematic market risk based on their business models, operating leverage, and financial leverage. @fig-beta-by-industry shows the distribution of firm-level average betas across Vietnamese industries.</span>
<span id="cb51-908"><a href="#cb51-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-911"><a href="#cb51-911" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-912"><a href="#cb51-912" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge betas with industry information</span></span>
<span id="cb51-913"><a href="#cb51-913" aria-hidden="true" tabindex="-1"></a>beta_with_industry <span class="op">=</span> (beta_monthly</span>
<span id="cb51-914"><a href="#cb51-914" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb51-915"><a href="#cb51-915" aria-hidden="true" tabindex="-1"></a>        prices_monthly[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"icb_name_vi"</span>]].drop_duplicates(),</span>
<span id="cb51-916"><a href="#cb51-916" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>],</span>
<span id="cb51-917"><a href="#cb51-917" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb51-918"><a href="#cb51-918" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-919"><a href="#cb51-919" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"icb_name_vi"</span>])</span>
<span id="cb51-920"><a href="#cb51-920" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-921"><a href="#cb51-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-922"><a href="#cb51-922" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute firm-level average beta by industry</span></span>
<span id="cb51-923"><a href="#cb51-923" aria-hidden="true" tabindex="-1"></a>beta_by_industry <span class="op">=</span> (beta_with_industry</span>
<span id="cb51-924"><a href="#cb51-924" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"icb_name_vi"</span>, <span class="st">"symbol"</span>])[<span class="st">"beta"</span>]</span>
<span id="cb51-925"><a href="#cb51-925" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb51-926"><a href="#cb51-926" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-927"><a href="#cb51-927" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-928"><a href="#cb51-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-929"><a href="#cb51-929" aria-hidden="true" tabindex="-1"></a><span class="co"># Order industries by median beta</span></span>
<span id="cb51-930"><a href="#cb51-930" aria-hidden="true" tabindex="-1"></a>industry_order <span class="op">=</span> (beta_by_industry</span>
<span id="cb51-931"><a href="#cb51-931" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"icb_name_vi"</span>)[<span class="st">"beta"</span>]</span>
<span id="cb51-932"><a href="#cb51-932" aria-hidden="true" tabindex="-1"></a>    .median()</span>
<span id="cb51-933"><a href="#cb51-933" aria-hidden="true" tabindex="-1"></a>    .sort_values()</span>
<span id="cb51-934"><a href="#cb51-934" aria-hidden="true" tabindex="-1"></a>    .index.tolist()</span>
<span id="cb51-935"><a href="#cb51-935" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-936"><a href="#cb51-936" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-937"><a href="#cb51-937" aria-hidden="true" tabindex="-1"></a><span class="co"># Select top 10 industries by number of firms for clearer visualization</span></span>
<span id="cb51-938"><a href="#cb51-938" aria-hidden="true" tabindex="-1"></a>top_industries <span class="op">=</span> (beta_by_industry</span>
<span id="cb51-939"><a href="#cb51-939" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"icb_name_vi"</span>)</span>
<span id="cb51-940"><a href="#cb51-940" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb51-941"><a href="#cb51-941" aria-hidden="true" tabindex="-1"></a>    .nlargest(<span class="dv">10</span>)</span>
<span id="cb51-942"><a href="#cb51-942" aria-hidden="true" tabindex="-1"></a>    .index.tolist()</span>
<span id="cb51-943"><a href="#cb51-943" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-944"><a href="#cb51-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-945"><a href="#cb51-945" aria-hidden="true" tabindex="-1"></a>beta_by_industry_filtered <span class="op">=</span> beta_by_industry.query(<span class="st">"icb_name_vi in @top_industries"</span>)</span>
<span id="cb51-946"><a href="#cb51-946" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-947"><a href="#cb51-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-950"><a href="#cb51-950" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-951"><a href="#cb51-951" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-beta-by-industry</span></span>
<span id="cb51-952"><a href="#cb51-952" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of firm-level average betas across Vietnamese industries. Box plots show the median, interquartile range, and outliers for each industry."</span></span>
<span id="cb51-953"><a href="#cb51-953" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Box plots showing beta distributions by industry, ordered by median beta."</span></span>
<span id="cb51-954"><a href="#cb51-954" aria-hidden="true" tabindex="-1"></a>beta_industry_figure <span class="op">=</span> (</span>
<span id="cb51-955"><a href="#cb51-955" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb51-956"><a href="#cb51-956" aria-hidden="true" tabindex="-1"></a>        beta_by_industry_filtered,</span>
<span id="cb51-957"><a href="#cb51-957" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"icb_name_vi"</span>, y<span class="op">=</span><span class="st">"beta"</span>)</span>
<span id="cb51-958"><a href="#cb51-958" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-959"><a href="#cb51-959" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_boxplot(fill<span class="op">=</span><span class="st">"steelblue"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb51-960"><a href="#cb51-960" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb51-961"><a href="#cb51-961" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> coord_flip()</span>
<span id="cb51-962"><a href="#cb51-962" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-963"><a href="#cb51-963" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-964"><a href="#cb51-964" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb51-965"><a href="#cb51-965" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Beta Distribution by Industry"</span></span>
<span id="cb51-966"><a href="#cb51-966" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-967"><a href="#cb51-967" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-968"><a href="#cb51-968" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-969"><a href="#cb51-969" aria-hidden="true" tabindex="-1"></a>beta_industry_figure.show()</span>
<span id="cb51-970"><a href="#cb51-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-971"><a href="#cb51-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-972"><a href="#cb51-972" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Variation in Cross-Sectional Beta Distribution</span></span>
<span id="cb51-973"><a href="#cb51-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-974"><a href="#cb51-974" aria-hidden="true" tabindex="-1"></a>Betas vary not only across stocks but also over time. @fig-beta-quantiles shows how the cross-sectional distribution of betas has evolved in the Vietnamese market.</span>
<span id="cb51-975"><a href="#cb51-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-978"><a href="#cb51-978" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-979"><a href="#cb51-979" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-beta-quantiles</span></span>
<span id="cb51-980"><a href="#cb51-980" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Monthly quantiles of beta estimates over time. Each line represents a decile of the cross-sectional beta distribution."</span></span>
<span id="cb51-981"><a href="#cb51-981" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing time series of beta deciles, illustrating how the distribution of betas has changed over time."</span></span>
<span id="cb51-982"><a href="#cb51-982" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute monthly quantiles</span></span>
<span id="cb51-983"><a href="#cb51-983" aria-hidden="true" tabindex="-1"></a>beta_quantiles <span class="op">=</span> (beta_monthly</span>
<span id="cb51-984"><a href="#cb51-984" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"beta"</span>]</span>
<span id="cb51-985"><a href="#cb51-985" aria-hidden="true" tabindex="-1"></a>    .quantile(q<span class="op">=</span>np.arange(<span class="fl">0.1</span>, <span class="fl">1.0</span>, <span class="fl">0.1</span>))</span>
<span id="cb51-986"><a href="#cb51-986" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-987"><a href="#cb51-987" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"level_1"</span>: <span class="st">"quantile"</span>})</span>
<span id="cb51-988"><a href="#cb51-988" aria-hidden="true" tabindex="-1"></a>    .assign(quantile<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"quantile"</span>] <span class="op">*</span> <span class="dv">100</span>).astype(<span class="bu">int</span>).astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"%"</span>)</span>
<span id="cb51-989"><a href="#cb51-989" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-990"><a href="#cb51-990" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-991"><a href="#cb51-991" aria-hidden="true" tabindex="-1"></a>beta_quantiles_figure <span class="op">=</span> (</span>
<span id="cb51-992"><a href="#cb51-992" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb51-993"><a href="#cb51-993" aria-hidden="true" tabindex="-1"></a>        beta_quantiles,</span>
<span id="cb51-994"><a href="#cb51-994" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta"</span>, color<span class="op">=</span><span class="st">"quantile"</span>)</span>
<span id="cb51-995"><a href="#cb51-995" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-996"><a href="#cb51-996" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb51-997"><a href="#cb51-997" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_hline(yintercept<span class="op">=</span><span class="dv">1</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb51-998"><a href="#cb51-998" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-999"><a href="#cb51-999" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-1000"><a href="#cb51-1000" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb51-1001"><a href="#cb51-1001" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Quantile"</span>,</span>
<span id="cb51-1002"><a href="#cb51-1002" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Distribution of Betas Over Time"</span></span>
<span id="cb51-1003"><a href="#cb51-1003" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1004"><a href="#cb51-1004" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-1005"><a href="#cb51-1005" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1006"><a href="#cb51-1006" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1007"><a href="#cb51-1007" aria-hidden="true" tabindex="-1"></a>beta_quantiles_figure.show()</span>
<span id="cb51-1008"><a href="#cb51-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1009"><a href="#cb51-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1010"><a href="#cb51-1010" aria-hidden="true" tabindex="-1"></a>The figure reveals several interesting patterns:</span>
<span id="cb51-1011"><a href="#cb51-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1012"><a href="#cb51-1012" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Level shifts**: The entire distribution of betas can shift over time, reflecting changes in market-wide correlation.</span>
<span id="cb51-1013"><a href="#cb51-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1014"><a href="#cb51-1014" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Dispersion changes**: During market stress, the spread between high and low beta stocks may change as correlations move.</span>
<span id="cb51-1015"><a href="#cb51-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1016"><a href="#cb51-1016" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Trends**: Some periods show trending behavior in betas, possibly reflecting structural changes in the economy.</span>
<span id="cb51-1017"><a href="#cb51-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1018"><a href="#cb51-1018" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coverage Analysis</span></span>
<span id="cb51-1019"><a href="#cb51-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1020"><a href="#cb51-1020" aria-hidden="true" tabindex="-1"></a>We verify that our estimation procedure produces reasonable coverage across the sample. @fig-beta-coverage shows the fraction of stocks with available beta estimates over time.</span>
<span id="cb51-1021"><a href="#cb51-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1024"><a href="#cb51-1024" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1025"><a href="#cb51-1025" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-beta-coverage</span></span>
<span id="cb51-1026"><a href="#cb51-1026" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Share of stocks with available beta estimates over time. Coverage increases as more stocks accumulate sufficient return history."</span></span>
<span id="cb51-1027"><a href="#cb51-1027" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing the percentage of stocks with beta estimates available each month."</span></span>
<span id="cb51-1028"><a href="#cb51-1028" aria-hidden="true" tabindex="-1"></a><span class="co"># Count stocks with and without betas</span></span>
<span id="cb51-1029"><a href="#cb51-1029" aria-hidden="true" tabindex="-1"></a>coverage <span class="op">=</span> (prices_monthly</span>
<span id="cb51-1030"><a href="#cb51-1030" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb51-1031"><a href="#cb51-1031" aria-hidden="true" tabindex="-1"></a>    .nunique()</span>
<span id="cb51-1032"><a href="#cb51-1032" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">"total_stocks"</span>)</span>
<span id="cb51-1033"><a href="#cb51-1033" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb51-1034"><a href="#cb51-1034" aria-hidden="true" tabindex="-1"></a>        beta_monthly.groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>].nunique().reset_index(name<span class="op">=</span><span class="st">"with_beta"</span>),</span>
<span id="cb51-1035"><a href="#cb51-1035" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb51-1036"><a href="#cb51-1036" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb51-1037"><a href="#cb51-1037" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1038"><a href="#cb51-1038" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="dv">0</span>)</span>
<span id="cb51-1039"><a href="#cb51-1039" aria-hidden="true" tabindex="-1"></a>    .assign(coverage<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"with_beta"</span>] <span class="op">/</span> x[<span class="st">"total_stocks"</span>])</span>
<span id="cb51-1040"><a href="#cb51-1040" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1041"><a href="#cb51-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1042"><a href="#cb51-1042" aria-hidden="true" tabindex="-1"></a>coverage_figure <span class="op">=</span> (</span>
<span id="cb51-1043"><a href="#cb51-1043" aria-hidden="true" tabindex="-1"></a>    ggplot(coverage, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"coverage"</span>))</span>
<span id="cb51-1044"><a href="#cb51-1044" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"steelblue"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-1045"><a href="#cb51-1045" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1046"><a href="#cb51-1046" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-1047"><a href="#cb51-1047" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Share with Beta Estimate"</span>,</span>
<span id="cb51-1048"><a href="#cb51-1048" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Beta Estimation Coverage Over Time"</span></span>
<span id="cb51-1049"><a href="#cb51-1049" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1050"><a href="#cb51-1050" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format(), limits<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb51-1051"><a href="#cb51-1051" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-1052"><a href="#cb51-1052" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1053"><a href="#cb51-1053" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1054"><a href="#cb51-1054" aria-hidden="true" tabindex="-1"></a>coverage_figure.show()</span>
<span id="cb51-1055"><a href="#cb51-1055" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1056"><a href="#cb51-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1057"><a href="#cb51-1057" aria-hidden="true" tabindex="-1"></a>Coverage is lower in early years because stocks need sufficient return history (at least 48 months) before their betas can be estimated. As the market matures and stocks accumulate longer histories, coverage approaches 100%.</span>
<span id="cb51-1058"><a href="#cb51-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1059"><a href="#cb51-1059" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparing Monthly and Daily Beta Estimates</span></span>
<span id="cb51-1060"><a href="#cb51-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1061"><a href="#cb51-1061" aria-hidden="true" tabindex="-1"></a>When both monthly and daily beta estimates are available, we can compare them to understand how estimation frequency affects results.</span>
<span id="cb51-1062"><a href="#cb51-1062" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1065"><a href="#cb51-1065" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1066"><a href="#cb51-1066" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine monthly and daily estimates</span></span>
<span id="cb51-1067"><a href="#cb51-1067" aria-hidden="true" tabindex="-1"></a>beta_daily <span class="op">=</span> (capm_daily</span>
<span id="cb51-1068"><a href="#cb51-1068" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"coefficient == 'beta'"</span>)</span>
<span id="cb51-1069"><a href="#cb51-1069" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"estimate"</span>: <span class="st">"beta"</span>})</span>
<span id="cb51-1070"><a href="#cb51-1070" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"beta"</span>]]</span>
<span id="cb51-1071"><a href="#cb51-1071" aria-hidden="true" tabindex="-1"></a>    .assign(frequency<span class="op">=</span><span class="st">"daily"</span>)</span>
<span id="cb51-1072"><a href="#cb51-1072" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1073"><a href="#cb51-1073" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1074"><a href="#cb51-1074" aria-hidden="true" tabindex="-1"></a>beta_combined <span class="op">=</span> pd.concat([beta_monthly, beta_daily], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-1075"><a href="#cb51-1075" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1076"><a href="#cb51-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1079"><a href="#cb51-1079" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1080"><a href="#cb51-1080" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-beta-comparison</span></span>
<span id="cb51-1081"><a href="#cb51-1081" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Comparison of beta estimates using monthly versus daily returns for selected stocks. Daily estimates are smoother due to more observations per estimation window."</span></span>
<span id="cb51-1082"><a href="#cb51-1082" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart comparing monthly and daily beta estimates over time for example stocks."</span></span>
<span id="cb51-1083"><a href="#cb51-1083" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter to example stocks</span></span>
<span id="cb51-1084"><a href="#cb51-1084" aria-hidden="true" tabindex="-1"></a>beta_comparison <span class="op">=</span> (beta_combined</span>
<span id="cb51-1085"><a href="#cb51-1085" aria-hidden="true" tabindex="-1"></a>    .merge(examples, on<span class="op">=</span><span class="st">"symbol"</span>)</span>
<span id="cb51-1086"><a href="#cb51-1086" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"symbol in ['VIC', 'FPT']"</span>)  <span class="co"># Select two for clarity</span></span>
<span id="cb51-1087"><a href="#cb51-1087" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1088"><a href="#cb51-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1089"><a href="#cb51-1089" aria-hidden="true" tabindex="-1"></a>comparison_figure <span class="op">=</span> (</span>
<span id="cb51-1090"><a href="#cb51-1090" aria-hidden="true" tabindex="-1"></a>    ggplot(</span>
<span id="cb51-1091"><a href="#cb51-1091" aria-hidden="true" tabindex="-1"></a>        beta_comparison,</span>
<span id="cb51-1092"><a href="#cb51-1092" aria-hidden="true" tabindex="-1"></a>        aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta"</span>, color<span class="op">=</span><span class="st">"frequency"</span>, linetype<span class="op">=</span><span class="st">"frequency"</span>)</span>
<span id="cb51-1093"><a href="#cb51-1093" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1094"><a href="#cb51-1094" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb51-1095"><a href="#cb51-1095" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> facet_wrap(<span class="st">"~company"</span>, ncol<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-1096"><a href="#cb51-1096" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1097"><a href="#cb51-1097" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-1098"><a href="#cb51-1098" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Beta"</span>,</span>
<span id="cb51-1099"><a href="#cb51-1099" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Data Frequency"</span>,</span>
<span id="cb51-1100"><a href="#cb51-1100" aria-hidden="true" tabindex="-1"></a>        linetype<span class="op">=</span><span class="st">"Data Frequency"</span>,</span>
<span id="cb51-1101"><a href="#cb51-1101" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Monthly vs Daily Beta Estimates"</span></span>
<span id="cb51-1102"><a href="#cb51-1102" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1103"><a href="#cb51-1103" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-1104"><a href="#cb51-1104" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1105"><a href="#cb51-1105" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme(legend_position<span class="op">=</span><span class="st">"bottom"</span>)</span>
<span id="cb51-1106"><a href="#cb51-1106" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1107"><a href="#cb51-1107" aria-hidden="true" tabindex="-1"></a>comparison_figure.show()</span>
<span id="cb51-1108"><a href="#cb51-1108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1109"><a href="#cb51-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1110"><a href="#cb51-1110" aria-hidden="true" tabindex="-1"></a>The comparison reveals that daily-based estimates are generally smoother due to the larger number of observations in each window. However, the level and trend of estimates are similar across frequencies, providing validation that both approaches capture the same underlying systematic risk exposure.</span>
<span id="cb51-1111"><a href="#cb51-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1114"><a href="#cb51-1114" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1115"><a href="#cb51-1115" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation between monthly and daily estimates</span></span>
<span id="cb51-1116"><a href="#cb51-1116" aria-hidden="true" tabindex="-1"></a>correlation_data <span class="op">=</span> (beta_combined</span>
<span id="cb51-1117"><a href="#cb51-1117" aria-hidden="true" tabindex="-1"></a>    .pivot_table(index<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], columns<span class="op">=</span><span class="st">"frequency"</span>, values<span class="op">=</span><span class="st">"beta"</span>)</span>
<span id="cb51-1118"><a href="#cb51-1118" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb51-1119"><a href="#cb51-1119" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1120"><a href="#cb51-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1121"><a href="#cb51-1121" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Correlation between monthly and daily betas: </span><span class="sc">{</span>correlation_data<span class="sc">.</span>corr()<span class="sc">.</span>iloc[<span class="dv">0</span>,<span class="dv">1</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb51-1122"><a href="#cb51-1122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1123"><a href="#cb51-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1124"><a href="#cb51-1124" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Factor <span class="pp">|</span> Effect <span class="pp">|</span></span>
<span id="cb51-1125"><a href="#cb51-1125" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------------------------|------------------------------------|</span></span>
<span id="cb51-1126"><a href="#cb51-1126" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Non-synchronous trading <span class="pp">|</span> Daily betas can be biased downward for illiquid stocks <span class="pp">|</span></span>
<span id="cb51-1127"><a href="#cb51-1127" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Microstructure noise <span class="pp">|</span> Bid-ask bounce adds noise to daily estimates <span class="pp">|</span></span>
<span id="cb51-1128"><a href="#cb51-1128" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Different effective windows <span class="pp">|</span> Same calendar period but \~20x more observations for daily <span class="pp">|</span></span>
<span id="cb51-1129"><a href="#cb51-1129" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Mean reversion speed <span class="pp">|</span> Daily captures faster-moving risk dynamics <span class="pp">|</span></span>
<span id="cb51-1130"><a href="#cb51-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1131"><a href="#cb51-1131" aria-hidden="true" tabindex="-1"></a>: Theoretical Reasons for Imperfect Correlation {#tbl-imperfect-cor}</span>
<span id="cb51-1132"><a href="#cb51-1132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1133"><a href="#cb51-1133" aria-hidden="true" tabindex="-1"></a>@tbl-imperfect-cor shows several reasons why we might observe imperfect correlation.</span>
<span id="cb51-1134"><a href="#cb51-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1135"><a href="#cb51-1135" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways</span></span>
<span id="cb51-1136"><a href="#cb51-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1137"><a href="#cb51-1137" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**CAPM beta** measures a stock's sensitivity to systematic market risk and is fundamental to modern portfolio theory, cost of capital estimation, and risk management.</span>
<span id="cb51-1138"><a href="#cb51-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1139"><a href="#cb51-1139" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Rolling-window estimation** captures time variation in betas, which reflects changes in companies' business models, leverage, and market conditions.</span>
<span id="cb51-1140"><a href="#cb51-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1141"><a href="#cb51-1141" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Parallelization** dramatically reduces computation time for large-scale estimation tasks by distributing work across multiple CPU cores.</span>
<span id="cb51-1142"><a href="#cb51-1142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1143"><a href="#cb51-1143" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Estimation choices matter**: Window length, return frequency, and minimum observation requirements all affect beta estimates. Researchers should choose parameters appropriate for their specific application.</span>
<span id="cb51-1144"><a href="#cb51-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1145"><a href="#cb51-1145" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Industry patterns**: Vietnamese stocks show systematic differences in market sensitivity across industries, with cyclical sectors exhibiting higher betas than defensive sectors.</span>
<span id="cb51-1146"><a href="#cb51-1146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1147"><a href="#cb51-1147" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**Time variation**: The cross-sectional distribution of betas in Vietnam has evolved over time, with notable shifts during market stress periods.</span>
<span id="cb51-1148"><a href="#cb51-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1149"><a href="#cb51-1149" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**Frequency comparison**: Monthly and daily beta estimates are positively correlated but not identical. Daily estimates are smoother while monthly estimates may better capture lower-frequency variation.</span>
<span id="cb51-1150"><a href="#cb51-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1151"><a href="#cb51-1151" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**Data quality checks**: Coverage analysis and summary statistics help identify potential issues in estimation procedures before using results in downstream analyses.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/08_beta_estimation.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>