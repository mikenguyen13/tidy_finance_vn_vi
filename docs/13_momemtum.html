<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Momentum Strategies – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./14_fama_macbeth.html" rel="next">
<link href="./12_fama_french.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="12&nbsp; Momentum Strategies – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/mikenguyen13/tidy_finance_vn/13_momemtum_files/figure-html/fig-stock-count-output-1.png">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta property="og:image:alt" content="A line chart showing the number of stocks with available monthly returns over time, generally increasing from a small number in the early 2000s to several hundred in recent years.">
<meta property="og:image:height" content="960">
<meta property="og:image:width" content="1920">
<meta name="twitter:title" content="12&nbsp; Momentum Strategies – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://github.com/mikenguyen13/tidy_finance_vn/13_momemtum_files/figure-html/fig-stock-count-output-1.png">
<meta name="twitter:image:alt" content="A line chart showing the number of stocks with available monthly returns over time, generally increasing from a small number in the early 2000s to several hundred in recent years.">
<meta name="twitter:image-height" content="960">
<meta name="twitter:image-width" content="1920">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./13_momemtum.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_momemtum.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./18_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./19_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#theoretical-background" id="toc-theoretical-background" class="nav-link active" data-scroll-target="#theoretical-background"><span class="header-section-number">12.1</span> Theoretical Background</a>
  <ul class="collapse">
  <li><a href="#the-momentum-effect" id="toc-the-momentum-effect" class="nav-link" data-scroll-target="#the-momentum-effect"><span class="header-section-number">12.1.1</span> The Momentum Effect</a></li>
  <li><a href="#overlapping-portfolios-and-calendar-time-returns" id="toc-overlapping-portfolios-and-calendar-time-returns" class="nav-link" data-scroll-target="#overlapping-portfolios-and-calendar-time-returns"><span class="header-section-number">12.1.2</span> Overlapping Portfolios and Calendar-Time Returns</a></li>
  <li><a href="#theoretical-explanations" id="toc-theoretical-explanations" class="nav-link" data-scroll-target="#theoretical-explanations"><span class="header-section-number">12.1.3</span> Theoretical Explanations</a></li>
  <li><a href="#momentum-in-emerging-markets" id="toc-momentum-in-emerging-markets" class="nav-link" data-scroll-target="#momentum-in-emerging-markets"><span class="header-section-number">12.1.4</span> Momentum in Emerging Markets</a></li>
  </ul></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment"><span class="header-section-number">12.2</span> Setting Up the Environment</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation"><span class="header-section-number">12.3</span> Data Preparation</a>
  <ul class="collapse">
  <li><a href="#loading-monthly-stock-returns" id="toc-loading-monthly-stock-returns" class="nav-link" data-scroll-target="#loading-monthly-stock-returns"><span class="header-section-number">12.3.1</span> Loading Monthly Stock Returns</a></li>
  <li><a href="#inspecting-the-data" id="toc-inspecting-the-data" class="nav-link" data-scroll-target="#inspecting-the-data"><span class="header-section-number">12.3.2</span> Inspecting the Data</a></li>
  <li><a href="#loading-factor-data" id="toc-loading-factor-data" class="nav-link" data-scroll-target="#loading-factor-data"><span class="header-section-number">12.3.3</span> Loading Factor Data</a></li>
  <li><a href="#data-quality-filters" id="toc-data-quality-filters" class="nav-link" data-scroll-target="#data-quality-filters"><span class="header-section-number">12.3.4</span> Data Quality Filters</a></li>
  </ul></li>
  <li><a href="#momentum-portfolio-construction" id="toc-momentum-portfolio-construction" class="nav-link" data-scroll-target="#momentum-portfolio-construction"><span class="header-section-number">12.4</span> Momentum Portfolio Construction</a>
  <ul class="collapse">
  <li><a href="#computing-formation-period-returns" id="toc-computing-formation-period-returns" class="nav-link" data-scroll-target="#computing-formation-period-returns"><span class="header-section-number">12.4.1</span> Computing Formation Period Returns</a></li>
  <li><a href="#assigning-momentum-decile-portfolios" id="toc-assigning-momentum-decile-portfolios" class="nav-link" data-scroll-target="#assigning-momentum-decile-portfolios"><span class="header-section-number">12.4.2</span> Assigning Momentum Decile Portfolios</a></li>
  <li><a href="#defining-holding-period-dates" id="toc-defining-holding-period-dates" class="nav-link" data-scroll-target="#defining-holding-period-dates"><span class="header-section-number">12.4.3</span> Defining Holding Period Dates</a></li>
  <li><a href="#computing-portfolio-holding-period-returns" id="toc-computing-portfolio-holding-period-returns" class="nav-link" data-scroll-target="#computing-portfolio-holding-period-returns"><span class="header-section-number">12.4.4</span> Computing Portfolio Holding Period Returns</a></li>
  <li><a href="#computing-equally-weighted-portfolio-returns" id="toc-computing-equally-weighted-portfolio-returns" class="nav-link" data-scroll-target="#computing-equally-weighted-portfolio-returns"><span class="header-section-number">12.4.5</span> Computing Equally Weighted Portfolio Returns</a></li>
  </ul></li>
  <li><a href="#baseline-results-j6-k6-strategy" id="toc-baseline-results-j6-k6-strategy" class="nav-link" data-scroll-target="#baseline-results-j6-k6-strategy"><span class="header-section-number">12.5</span> Baseline Results: J=6, K=6 Strategy</a>
  <ul class="collapse">
  <li><a href="#summary-statistics-by-momentum-decile" id="toc-summary-statistics-by-momentum-decile" class="nav-link" data-scroll-target="#summary-statistics-by-momentum-decile"><span class="header-section-number">12.5.1</span> Summary Statistics by Momentum Decile</a></li>
  <li><a href="#the-long-short-momentum-portfolio" id="toc-the-long-short-momentum-portfolio" class="nav-link" data-scroll-target="#the-long-short-momentum-portfolio"><span class="header-section-number">12.5.2</span> The Long-Short Momentum Portfolio</a></li>
  <li><a href="#cumulative-returns" id="toc-cumulative-returns" class="nav-link" data-scroll-target="#cumulative-returns"><span class="header-section-number">12.5.3</span> Cumulative Returns</a></li>
  <li><a href="#monthly-return-distribution" id="toc-monthly-return-distribution" class="nav-link" data-scroll-target="#monthly-return-distribution"><span class="header-section-number">12.5.4</span> Monthly Return Distribution</a></li>
  </ul></li>
  <li><a href="#extending-to-multiple-formation-and-holding-periods" id="toc-extending-to-multiple-formation-and-holding-periods" class="nav-link" data-scroll-target="#extending-to-multiple-formation-and-holding-periods"><span class="header-section-number">12.6</span> Extending to Multiple Formation and Holding Periods</a>
  <ul class="collapse">
  <li><a href="#the-j-k-grid" id="toc-the-j-k-grid" class="nav-link" data-scroll-target="#the-j-k-grid"><span class="header-section-number">12.6.1</span> The J × K Grid</a></li>
  <li><a href="#running-the-full-grid" id="toc-running-the-full-grid" class="nav-link" data-scroll-target="#running-the-full-grid"><span class="header-section-number">12.6.2</span> Running the Full Grid</a></li>
  <li><a href="#winners-portfolio-returns" id="toc-winners-portfolio-returns" class="nav-link" data-scroll-target="#winners-portfolio-returns"><span class="header-section-number">12.6.3</span> Winners Portfolio Returns</a></li>
  <li><a href="#losers-portfolio-returns" id="toc-losers-portfolio-returns" class="nav-link" data-scroll-target="#losers-portfolio-returns"><span class="header-section-number">12.6.4</span> Losers Portfolio Returns</a></li>
  <li><a href="#long-short-momentum-returns" id="toc-long-short-momentum-returns" class="nav-link" data-scroll-target="#long-short-momentum-returns"><span class="header-section-number">12.6.5</span> Long-Short Momentum Returns</a></li>
  <li><a href="#visualizing-the-momentum-premium-across-specifications" id="toc-visualizing-the-momentum-premium-across-specifications" class="nav-link" data-scroll-target="#visualizing-the-momentum-premium-across-specifications"><span class="header-section-number">12.6.6</span> Visualizing the Momentum Premium Across Specifications</a></li>
  </ul></li>
  <li><a href="#risk-adjusted-performance" id="toc-risk-adjusted-performance" class="nav-link" data-scroll-target="#risk-adjusted-performance"><span class="header-section-number">12.7</span> Risk-Adjusted Performance</a>
  <ul class="collapse">
  <li><a href="#capm-alpha" id="toc-capm-alpha" class="nav-link" data-scroll-target="#capm-alpha"><span class="header-section-number">12.7.1</span> CAPM Alpha</a></li>
  <li><a href="#fama-french-three-factor-alpha" id="toc-fama-french-three-factor-alpha" class="nav-link" data-scroll-target="#fama-french-three-factor-alpha"><span class="header-section-number">12.7.2</span> Fama-French Three-Factor Alpha</a></li>
  <li><a href="#interpretation-of-risk-exposures" id="toc-interpretation-of-risk-exposures" class="nav-link" data-scroll-target="#interpretation-of-risk-exposures"><span class="header-section-number">12.7.3</span> Interpretation of Risk Exposures</a></li>
  </ul></li>
  <li><a href="#momentum-and-market-states" id="toc-momentum-and-market-states" class="nav-link" data-scroll-target="#momentum-and-market-states"><span class="header-section-number">12.8</span> Momentum and Market States</a>
  <ul class="collapse">
  <li><a href="#conditional-performance" id="toc-conditional-performance" class="nav-link" data-scroll-target="#conditional-performance"><span class="header-section-number">12.8.1</span> Conditional Performance</a></li>
  </ul></li>
  <li><a href="#momentum-crashes" id="toc-momentum-crashes" class="nav-link" data-scroll-target="#momentum-crashes"><span class="header-section-number">12.9</span> Momentum Crashes</a>
  <ul class="collapse">
  <li><a href="#understanding-momentum-drawdowns" id="toc-understanding-momentum-drawdowns" class="nav-link" data-scroll-target="#understanding-momentum-drawdowns"><span class="header-section-number">12.9.1</span> Understanding Momentum Drawdowns</a></li>
  <li><a href="#maximum-drawdown-analysis" id="toc-maximum-drawdown-analysis" class="nav-link" data-scroll-target="#maximum-drawdown-analysis"><span class="header-section-number">12.9.2</span> Maximum Drawdown Analysis</a></li>
  </ul></li>
  <li><a href="#value-weighted-momentum-portfolios" id="toc-value-weighted-momentum-portfolios" class="nav-link" data-scroll-target="#value-weighted-momentum-portfolios"><span class="header-section-number">12.10</span> Value-Weighted Momentum Portfolios</a></li>
  <li><a href="#daily-momentum-analysis" id="toc-daily-momentum-analysis" class="nav-link" data-scroll-target="#daily-momentum-analysis"><span class="header-section-number">12.11</span> Daily Momentum Analysis</a>
  <ul class="collapse">
  <li><a href="#loading-daily-data" id="toc-loading-daily-data" class="nav-link" data-scroll-target="#loading-daily-data"><span class="header-section-number">12.11.1</span> Loading Daily Data</a></li>
  <li><a href="#daily-returns-of-monthly-momentum-portfolios" id="toc-daily-returns-of-monthly-momentum-portfolios" class="nav-link" data-scroll-target="#daily-returns-of-monthly-momentum-portfolios"><span class="header-section-number">12.11.2</span> Daily Returns of Monthly Momentum Portfolios</a></li>
  <li><a href="#daily-cumulative-returns" id="toc-daily-cumulative-returns" class="nav-link" data-scroll-target="#daily-cumulative-returns"><span class="header-section-number">12.11.3</span> Daily Cumulative Returns</a></li>
  <li><a href="#annualized-risk-metrics-from-daily-data" id="toc-annualized-risk-metrics-from-daily-data" class="nav-link" data-scroll-target="#annualized-risk-metrics-from-daily-data"><span class="header-section-number">12.11.4</span> Annualized Risk Metrics from Daily Data</a></li>
  <li><a href="#realized-volatility-of-momentum-returns" id="toc-realized-volatility-of-momentum-returns" class="nav-link" data-scroll-target="#realized-volatility-of-momentum-returns"><span class="header-section-number">12.11.5</span> Realized Volatility of Momentum Returns</a></li>
  </ul></li>
  <li><a href="#saving-results-to-the-database" id="toc-saving-results-to-the-database" class="nav-link" data-scroll-target="#saving-results-to-the-database"><span class="header-section-number">12.12</span> Saving Results to the Database</a></li>
  <li><a href="#practical-considerations" id="toc-practical-considerations" class="nav-link" data-scroll-target="#practical-considerations"><span class="header-section-number">12.13</span> Practical Considerations</a>
  <ul class="collapse">
  <li><a href="#transaction-costs" id="toc-transaction-costs" class="nav-link" data-scroll-target="#transaction-costs"><span class="header-section-number">12.13.1</span> Transaction Costs</a></li>
  <li><a href="#implementation-lag" id="toc-implementation-lag" class="nav-link" data-scroll-target="#implementation-lag"><span class="header-section-number">12.13.2</span> Implementation Lag</a></li>
  <li><a href="#survivorship-bias" id="toc-survivorship-bias" class="nav-link" data-scroll-target="#survivorship-bias"><span class="header-section-number">12.13.3</span> Survivorship Bias</a></li>
  <li><a href="#small-sample-considerations" id="toc-small-sample-considerations" class="nav-link" data-scroll-target="#small-sample-considerations"><span class="header-section-number">12.13.4</span> Small Sample Considerations</a></li>
  </ul></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">12.14</span> Key Takeaways</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/13_momemtum.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Momentum is one of the most robust and pervasive anomalies in financial economics. Stocks that have performed well over the past three to twelve months tend to continue performing well over the subsequent three to twelve months, and stocks that have performed poorly tend to continue underperforming. This pattern, first documented by <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>, has been replicated across virtually every equity market, asset class, and time period examined, earning it a central place in the canon of empirical asset pricing.</p>
<p>In this chapter, we provide an implementation of momentum strategies following the methodology of <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>. We construct momentum portfolios based on past cumulative returns, evaluate their performance across different formation and holding period combinations, and examine whether the momentum premium exists in the Vietnamese equity market..</p>
<section id="theoretical-background" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="theoretical-background"><span class="header-section-number">12.1</span> Theoretical Background</h2>
<section id="the-momentum-effect" class="level3" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="the-momentum-effect"><span class="header-section-number">12.1.1</span> The Momentum Effect</h3>
<p>The momentum effect refers to the tendency of assets with high recent returns to continue generating high returns, and assets with low recent returns to continue generating low returns. More formally, if we define the cumulative return of stock <span class="math inline">\(i\)</span> over the past <span class="math inline">\(J\)</span> months as</p>
<p><span id="eq-cumret"><span class="math display">\[
R_{i,t-J:t-1} = \prod_{s=t-J}^{t-1} (1 + r_{i,s}) - 1
\tag{12.1}\]</span></span></p>
<p>then momentum predicts a positive cross-sectional relationship between <span class="math inline">\(R_{i,t-J:t-1}\)</span> and future returns <span class="math inline">\(r_{i,t}\)</span>. That is, stocks in the top decile of past returns (winners) should outperform stocks in the bottom decile (losers) in subsequent months.</p>
<p>The <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> framework parameterizes momentum strategies by two key dimensions:</p>
<ol type="1">
<li><strong>Formation period</strong> (<span class="math inline">\(J\)</span>): The number of months over which past returns are computed to rank stocks. Typical values range from 3 to 12 months.</li>
<li><strong>Holding period</strong> (<span class="math inline">\(K\)</span>): The number of months for which the momentum portfolios are held after formation. Typical values also range from 3 to 12 months.</li>
</ol>
<p>A strategy is therefore characterized by the pair <span class="math inline">\((J, K)\)</span>. For example, a <span class="math inline">\((6, 6)\)</span> strategy ranks stocks based on their cumulative returns over the past 6 months and holds the resulting portfolios for 6 months.</p>
</section>
<section id="overlapping-portfolios-and-calendar-time-returns" class="level3" data-number="12.1.2">
<h3 data-number="12.1.2" class="anchored" data-anchor-id="overlapping-portfolios-and-calendar-time-returns"><span class="header-section-number">12.1.2</span> Overlapping Portfolios and Calendar-Time Returns</h3>
<p>A critical implementation detail in <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> is the use of overlapping portfolios. In each month <span class="math inline">\(t\)</span>, a new set of portfolios is formed based on the most recent <span class="math inline">\(J\)</span>-month returns. However, portfolios formed in months <span class="math inline">\(t-1\)</span>, <span class="math inline">\(t-2\)</span>, <span class="math inline">\(\ldots\)</span>, <span class="math inline">\(t-K+1\)</span> are still within their holding periods and therefore remain active. The return of the momentum strategy in month <span class="math inline">\(t\)</span> is thus the equally weighted average across all <span class="math inline">\(K\)</span> active cohorts:</p>
<p><span id="eq-overlapping"><span class="math display">\[
r_{p,t} = \frac{1}{K} \sum_{k=0}^{K-1} r_{p,t}^{(t-k)}
\tag{12.2}\]</span></span></p>
<p>where <span class="math inline">\(r_{p,t}^{(t-k)}\)</span> denotes the return in month <span class="math inline">\(t\)</span> of the portfolio formed in month <span class="math inline">\(t-k\)</span>. This overlapping portfolio approach serves two purposes. First, it reduces the impact of any single formation date on the strategy’s performance. Second, it produces a monthly return series that can be analyzed using standard time-series methods, even when the holding period <span class="math inline">\(K\)</span> exceeds one month.</p>
</section>
<section id="theoretical-explanations" class="level3" data-number="12.1.3">
<h3 data-number="12.1.3" class="anchored" data-anchor-id="theoretical-explanations"><span class="header-section-number">12.1.3</span> Theoretical Explanations</h3>
<p>The academic literature offers two broad classes of explanations for the momentum effect.</p>
<ol type="1">
<li><strong>Behavioral explanations</strong> attribute momentum to systematic cognitive biases among investors. <span class="citation" data-cites="daniel1998investor">Daniel, Hirshleifer, and Subrahmanyam (<a href="references.html#ref-daniel1998investor" role="doc-biblioref">1998</a>)</span> propose a model based on investor overconfidence and biased self-attribution: investors overweight private signals and attribute confirming outcomes to their own skill, leading to initial underreaction followed by delayed overreaction. <span class="citation" data-cites="hong1999unified">Hong and Stein (<a href="references.html#ref-hong1999unified" role="doc-biblioref">1999</a>)</span> develop a model in which information diffuses gradually across heterogeneous investors, generating underreaction to firm-specific news. <span class="citation" data-cites="barberis1998model">Barberis, Shleifer, and Vishny (<a href="references.html#ref-barberis1998model" role="doc-biblioref">1998</a>)</span> formalize a model combining conservatism bias (slow updating of beliefs in response to new evidence) and representativeness heuristic (extrapolation of recent trends).</li>
<li><strong>Risk-based explanations</strong> argue that momentum profits represent compensation for systematic risk that varies over time. <span class="citation" data-cites="johnson2002rational">Johnson (<a href="references.html#ref-johnson2002rational" role="doc-biblioref">2002</a>)</span> show that momentum can arise in a rational framework if expected returns are stochastic and time-varying. <span class="citation" data-cites="grundy2001understanding">Grundy and Martin (<a href="references.html#ref-grundy2001understanding" role="doc-biblioref">2001</a>)</span> document that momentum portfolios have substantial time-varying factor exposures, suggesting that at least part of the momentum premium reflects dynamic risk. However, standard risk models such as the Fama-French three-factor model have generally struggled to explain momentum returns, which motivated the development of explicit momentum factors such as the Winners-Minus-Losers (WML) factor in <span class="citation" data-cites="carhart1997persistence">Carhart (<a href="references.html#ref-carhart1997persistence" role="doc-biblioref">1997</a>)</span>.</li>
</ol>
</section>
<section id="momentum-in-emerging-markets" class="level3" data-number="12.1.4">
<h3 data-number="12.1.4" class="anchored" data-anchor-id="momentum-in-emerging-markets"><span class="header-section-number">12.1.4</span> Momentum in Emerging Markets</h3>
<p>The behavior of momentum in emerging markets differs substantially from developed markets, and understanding these differences is essential for interpreting our Vietnamese market results.</p>
<p><span class="citation" data-cites="rouwenhorst1998international">Rouwenhorst (<a href="references.html#ref-rouwenhorst1998international" role="doc-biblioref">1998</a>)</span> provides early evidence that momentum profits exist in European markets. <span class="citation" data-cites="chan2000profitability">Chan, Hameed, and Tong (<a href="references.html#ref-chan2000profitability" role="doc-biblioref">2000</a>)</span> extend the analysis to international equity markets and find that momentum profits are present in most developed markets but are weaker or absent in several Asian markets. <span class="citation" data-cites="chui2010individualism">Chui, Titman, and Wei (<a href="references.html#ref-chui2010individualism" role="doc-biblioref">2010</a>)</span> offer a cultural explanation, documenting that momentum profits are positively related to a country’s degree of individualism as measured by <span class="citation" data-cites="hofstede2001culture">Hofstede (<a href="references.html#ref-hofstede2001culture" role="doc-biblioref">2001</a>)</span>. Countries with collectivist cultures, including many in East and Southeast Asia, tend to exhibit weaker momentum effects.</p>
<p>Several market microstructure features common in emerging markets may attenuate momentum:</p>
<ul>
<li><strong>Trading band limits</strong> constrain daily price movements, potentially slowing the adjustment process that generates momentum. Vietnam’s HOSE imposes a <span class="math inline">\(\pm 7\%\)</span> daily limit, while HNX allows <span class="math inline">\(\pm 10\%\)</span>.</li>
<li><strong>Lower liquidity and higher transaction costs</strong> can erode momentum profits, as documented by <span class="citation" data-cites="lesmond2004illusory">Lesmond, Schill, and Zhou (<a href="references.html#ref-lesmond2004illusory" role="doc-biblioref">2004</a>)</span>.</li>
<li><strong>Foreign ownership limits</strong> segment the investor base, potentially altering the information diffusion dynamics that underlie momentum.</li>
<li><strong>Shorter market history</strong> limits the statistical power available to detect the effect.</li>
</ul>
<p>These considerations motivate our careful empirical analysis of whether, and to what extent, momentum manifests in Vietnamese equities.</p>
</section>
</section>
<section id="setting-up-the-environment" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="setting-up-the-environment"><span class="header-section-number">12.2</span> Setting Up the Environment</h2>
<p>We begin by loading the necessary Python packages. The core packages include <code>pandas</code> for data manipulation, <code>numpy</code> for numerical operations, and <code>sqlite3</code> for database connectivity. We also import <code>plotnine</code> for creating publication-quality figures and <code>scipy</code> for statistical tests.</p>
<div id="cc988f36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> comma_format, percent_format</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We connect to our SQLite database, which stores the cleaned datasets prepared in <a href="accessing-and-managing-financial-data.qmd">Accessing and Managing Financial Data</a> and <a href="datacore-data.qmd">DataCore Data</a>.</p>
<div id="0d48e849" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="data-preparation" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="data-preparation"><span class="header-section-number">12.3</span> Data Preparation</h2>
<section id="loading-monthly-stock-returns" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="loading-monthly-stock-returns"><span class="header-section-number">12.3.1</span> Loading Monthly Stock Returns</h3>
<p>We load the monthly stock price data from our database. The <code>prices_monthly</code> table contains adjusted returns, market capitalizations, and other variables for all stocks listed on HOSE and HNX.</p>
<div id="0ae4e650" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># can add "exchange" variable</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret, ret_excess, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total monthly observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total monthly observations: 165,499
Unique stocks: 1,457
Date range: 2010-02-28 to 2023-12-31</code></pre>
</div>
</div>
</section>
<section id="inspecting-the-data" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="inspecting-the-data"><span class="header-section-number">12.3.2</span> Inspecting the Data</h3>
<p>Before proceeding with portfolio construction, we examine the key variables in our dataset. <a href="#tbl-data-summary" class="quarto-xref">Table&nbsp;<span>12.1</span></a> presents the summary statistics for the main variables used in momentum portfolio construction.</p>
<div class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="op">=</span> (prices_monthly</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"ret"</span>, <span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    .describe()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    .T</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>summary_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-data-summary" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="4">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-data-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.1: Summary statistics for monthly stock return data. The table reports the count, mean, standard deviation, minimum, 25th percentile, median, 75th percentile, and maximum for monthly returns (ret), excess returns (ret_excess), and market capitalization (mktcap, in billion VND).
</figcaption>
<div aria-describedby="tbl-data-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">count</th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">std</th>
<th data-quarto-table-cell-role="th">min</th>
<th data-quarto-table-cell-role="th">25%</th>
<th data-quarto-table-cell-role="th">50%</th>
<th data-quarto-table-cell-role="th">75%</th>
<th data-quarto-table-cell-role="th">max</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">ret</th>
<td>165499.0</td>
<td>0.0042</td>
<td>0.1862</td>
<td>-0.9900</td>
<td>-0.0703</td>
<td>0.0000</td>
<td>0.0553</td>
<td>12.7500</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">ret_excess</th>
<td>165499.0</td>
<td>0.0008</td>
<td>0.1862</td>
<td>-0.9933</td>
<td>-0.0736</td>
<td>-0.0033</td>
<td>0.0519</td>
<td>12.7467</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">mktcap</th>
<td>165499.0</td>
<td>2183.1646</td>
<td>13983.9977</td>
<td>0.3536</td>
<td>60.3728</td>
<td>180.6224</td>
<td>660.0000</td>
<td>463886.6454</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<p>We also examine the cross-sectional distribution of stocks over time, which is important for understanding whether we have sufficient breadth for decile portfolio construction.</p>
<div id="cell-fig-stock-count" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>stock_counts <span class="op">=</span> (prices_monthly</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    .nunique()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"symbol"</span>: <span class="st">"n_stocks"</span>})</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>plot_stock_counts <span class="op">=</span> (</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ggplot(stock_counts, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"n_stocks"</span>)) <span class="op">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#1f77b4"</span>) <span class="op">+</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Number of stocks"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Breadth Over Time"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>plot_stock_counts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="5">
<div id="fig-stock-count" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart showing the number of stocks with available monthly returns over time, generally increasing from a small number in the early 2000s to several hundred in recent years.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stock-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-stock-count-output-1.png" alt="A line chart showing the number of stocks with available monthly returns over time, generally increasing from a small number in the early 2000s to several hundred in recent years." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stock-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.1: Number of stocks with available return data over time. The figure shows the monthly cross-section of stocks available for momentum portfolio construction. A minimum number of stocks is needed to form meaningful decile portfolios.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="loading-factor-data" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="loading-factor-data"><span class="header-section-number">12.3.3</span> Loading Factor Data</h3>
<p>We also load the Fama-French factor returns for risk-adjusted performance evaluation. These factors were constructed in <a href="fama-french-factors.qmd">Fama-French Factors</a>.</p>
<div id="3f5f26ad" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess, smb, hml, risk_free FROM factors_ff3_monthly"</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factor observations: </span><span class="sc">{</span><span class="bu">len</span>(factors_ff3_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>factors_ff3_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>factors_ff3_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Factor observations: 150
Date range: 2011-07-31 to 2023-12-31</code></pre>
</div>
</div>
</section>
<section id="data-quality-filters" class="level3" data-number="12.3.4">
<h3 data-number="12.3.4" class="anchored" data-anchor-id="data-quality-filters"><span class="header-section-number">12.3.4</span> Data Quality Filters</h3>
<p>Momentum strategies require continuous return histories for the formation period. We apply several filters to ensure data quality:</p>
<ol type="1">
<li><strong>Minimum price filter</strong>: We exclude penny stocks with prices below 1,000 VND, which are subject to extreme microstructure noise.</li>
<li><strong>Return availability</strong>: We require non-missing returns for the entire formation period.</li>
<li><strong>Market capitalization</strong>: We require positive lagged market capitalization for portfolio weighting.</li>
</ol>
<div id="1d6d3d7d" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for stocks with positive market cap and non-missing returns</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>prices_clean <span class="op">=</span> (prices_monthly</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mktcap"</span>])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"mktcap &gt; 0"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations after filtering: </span><span class="sc">{</span><span class="bu">len</span>(prices_clean)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks after filtering: </span><span class="sc">{</span>prices_clean[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observations after filtering: 165,499
Stocks after filtering: 1,457</code></pre>
</div>
</div>
</section>
</section>
<section id="momentum-portfolio-construction" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="momentum-portfolio-construction"><span class="header-section-number">12.4</span> Momentum Portfolio Construction</h2>
<section id="computing-formation-period-returns" class="level3" data-number="12.4.1">
<h3 data-number="12.4.1" class="anchored" data-anchor-id="computing-formation-period-returns"><span class="header-section-number">12.4.1</span> Computing Formation Period Returns</h3>
<p>The first step in constructing momentum portfolios is to compute cumulative returns over the formation period. For a formation period of <span class="math inline">\(J\)</span> months, we compute the cumulative return for each stock <span class="math inline">\(i\)</span> at the end of month <span class="math inline">\(t\)</span> as specified in <a href="#eq-cumret" class="quarto-xref">Equation&nbsp;<span>12.1</span></a>.</p>
<p>We implement this using a rolling product of gross returns. A key detail is that we require non-missing returns for all <span class="math inline">\(J\)</span> months in the formation window. If any monthly return is missing, the cumulative return is set to missing, and the stock is excluded from portfolio formation in that month.</p>
<div id="8403799f" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_formation_returns(data, J):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute J-month cumulative returns for momentum portfolio formation.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel data with columns 'symbol', 'date', 'ret'.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period length in months (typically 3-12).</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Original data augmented with 'cum_return' column.</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute rolling J-month cumulative return</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using gross returns: (1+r1)*(1+r2)*...*(1+rJ) - 1</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>])</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let us apply this function for our baseline case with <span class="math inline">\(J = 6\)</span> months:</p>
<div id="b3f801aa" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>J <span class="op">=</span> <span class="dv">6</span>  <span class="co"># Formation period: 6 months</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>prices_with_cumret <span class="op">=</span> compute_formation_returns(prices_clean, J)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations with valid </span><span class="sc">{</span>J<span class="sc">}</span><span class="ss">-month cumulative returns: "</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>prices_with_cumret[<span class="st">'cum_return'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Cumulative return distribution:"</span>)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_with_cumret[<span class="st">"cum_return"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observations with valid 6-month cumulative returns: 158,227

Cumulative return distribution:
count    158227.0000
mean          0.0171
std           0.5053
min          -0.9999
25%          -0.2196
50%          -0.0400
75%           0.1404
max          35.7136
Name: cum_return, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="assigning-momentum-decile-portfolios" class="level3" data-number="12.4.2">
<h3 data-number="12.4.2" class="anchored" data-anchor-id="assigning-momentum-decile-portfolios"><span class="header-section-number">12.4.2</span> Assigning Momentum Decile Portfolios</h3>
<p>Each month, we sort all stocks with valid cumulative returns into decile portfolios based on their past <span class="math inline">\(J\)</span>-month performance. Portfolio 1 contains the bottom decile (losers) and portfolio 10 contains the top decile (winners).</p>
<div id="628ef240" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_momentum_portfolios(data, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign stocks to momentum portfolios based on formation-period returns.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    For each cross-section (month), stocks are sorted into </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios quantile groups according to their cumulative return.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolio 1 = lowest past returns (Losers)</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolio n_portfolios = highest past returns (Winners)</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    This implementation uses `groupby().transform()` rather than </span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    `groupby().apply()` to preserve the original DataFrame structure </span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    and avoid index mutation issues.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel data containing at minimum:</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'symbol' : stock identifier</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'date' : formation month</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'cum_return' : cumulative return over formation window</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int, optional</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios to form (default = 10 for deciles).</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">        Original data augmented with:</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'momr' : integer momentum rank (1 to n_portfolios)</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop observations without formation-period returns</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These cannot be ranked into portfolios</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>]).copy()</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_qcut(x):</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="co">        Assign quantile portfolio labels within a single cross-section.</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co">        Uses pd.qcut to create approximately equal-sized portfolios.</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">        If too few unique return values exist (which can happen in </span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co">        small markets or illiquid samples), fall back to rank-based </span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">        binning to ensure portfolios are still formed.</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Standard quantile sorting</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.qcut(</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span>n_portfolios,</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span>  <span class="co"># prevents crash if quantile edges duplicate</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fallback: rank then evenly cut into bins</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.cut(</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>                bins<span class="op">=</span>n_portfolios,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-sectional portfolio assignment:</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each month, compute portfolio ranks based on cum_return.</span></span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transform ensures:</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - original row order preserved</span></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - no index mutation</span></span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - no loss of 'date' column</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> (</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>]</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>          .transform(safe_qcut)</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>          .astype(<span class="bu">int</span>)</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="4753cee8" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>portfolios <span class="op">=</span> assign_momentum_portfolios(prices_with_cumret)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks assigned to portfolios: </span><span class="sc">{</span><span class="bu">len</span>(portfolios)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Portfolio distribution (should be approximately equal):"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios.groupby(<span class="st">"momr"</span>)[<span class="st">"symbol"</span>].count().to_frame(<span class="st">"count"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stocks assigned to portfolios: 158,227

Portfolio distribution (should be approximately equal):
      count
momr       
1     15894
2     15815
3     16021
4     15759
5     15738
6     16568
7     15288
8     15582
9     15697
10    15865</code></pre>
</div>
</div>
</section>
<section id="defining-holding-period-dates" class="level3" data-number="12.4.3">
<h3 data-number="12.4.3" class="anchored" data-anchor-id="defining-holding-period-dates"><span class="header-section-number">12.4.3</span> Defining Holding Period Dates</h3>
<p>After forming portfolios at the end of month <span class="math inline">\(t\)</span>, we hold them from the beginning of month <span class="math inline">\(t+1\)</span> through the end of month <span class="math inline">\(t+K\)</span>. This one-month gap between the formation period and the start of the holding period is standard in the literature and avoids the well-documented short-term reversal effect at the one-month horizon <span class="citation" data-cites="jegadeesh1990evidence">(<a href="references.html#ref-jegadeesh1990evidence" role="doc-biblioref">Jegadeesh 1990</a>)</span>.</p>
<div id="7125926d" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">6</span>  <span class="co"># Holding period: 6 months</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates <span class="op">=</span> portfolios.copy()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates <span class="op">=</span> portfolios_with_dates.rename(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>}</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Define holding period start and end dates</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates[<span class="st">"hdate1"</span>] <span class="op">=</span> (</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    portfolios_with_dates[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates[<span class="st">"hdate2"</span>] <span class="op">=</span> (</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    portfolios_with_dates[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_with_dates[</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"cum_return"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>].head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   symbol  form_date  cum_return  momr     hdate1     hdate2
5     A32 2019-04-30   -0.061599     4 2019-05-01 2019-10-31
6     A32 2019-05-31   -0.213675     2 2019-06-01 2019-11-30
7     A32 2019-06-30   -0.308720     2 2019-07-01 2019-12-31
8     A32 2019-07-31   -0.249936     2 2019-08-01 2020-01-31
9     A32 2019-08-31    0.061986     8 2019-09-01 2020-02-29
10    A32 2019-09-30    0.030751     8 2019-10-01 2020-03-31
11    A32 2019-10-31    0.030751     8 2019-11-01 2020-04-30
12    A32 2019-11-30    0.032486     8 2019-12-01 2020-05-31
13    A32 2019-12-31    0.180073     9 2020-01-01 2020-06-30
14    A32 2020-01-31    0.412322    10 2020-02-01 2020-07-31</code></pre>
</div>
</div>
</section>
<section id="computing-portfolio-holding-period-returns" class="level3" data-number="12.4.4">
<h3 data-number="12.4.4" class="anchored" data-anchor-id="computing-portfolio-holding-period-returns"><span class="header-section-number">12.4.4</span> Computing Portfolio Holding Period Returns</h3>
<p>We now compute the returns of each portfolio during its holding period. For each stock-formation date combination, we merge in the actual returns realized during the holding window. This produces a panel of stock returns indexed by formation date, holding date, and momentum portfolio rank.</p>
<div id="18f5d66d" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge: for each portfolio assignment, get all returns during holding period</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> portfolios_with_dates.merge(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    prices_clean[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only returns within the holding period</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> portfolio_returns.query(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hdate &gt;= hdate1 and hdate &lt;= hdate2"</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Portfolio-holding period observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolio_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Portfolio-holding period observations: 918,072</code></pre>
</div>
</div>
</section>
<section id="computing-equally-weighted-portfolio-returns" class="level3" data-number="12.4.5">
<h3 data-number="12.4.5" class="anchored" data-anchor-id="computing-equally-weighted-portfolio-returns"><span class="header-section-number">12.4.5</span> Computing Equally Weighted Portfolio Returns</h3>
<p>The <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> methodology uses equally weighted portfolios. For each holding month, each momentum decile has <span class="math inline">\(K\)</span> active cohorts (one formed in each of the past <span class="math inline">\(K\)</span> months). We first compute the equally weighted return within each cohort, then average across cohorts to get the final monthly portfolio return.</p>
<div id="e4cf4b64" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Average return within each cohort (form_date × momr × hdate)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>cohort_returns <span class="op">=</span> (portfolio_returns</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    .agg(cohort_ret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Average across cohorts for each momentum portfolio × month</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>ewret <span class="op">=</span> (cohort_returns</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        ewret_std<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"std"</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        n_cohorts<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"count"</span>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly portfolio return observations: </span><span class="sc">{</span><span class="bu">len</span>(ewret)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>ewret[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>ewret[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Monthly portfolio return observations: 1,610
Date range: 2010-08-31 to 2023-12-31</code></pre>
</div>
</div>
<p>We should verify that we have the expected number of active cohorts per month. Once the strategy has been running for at least <span class="math inline">\(K\)</span> months, each momentum decile should have exactly <span class="math inline">\(K\)</span> active cohorts.</p>
<div id="cell-fig-cohort-count" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>cohort_check <span class="op">=</span> (ewret</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"n_cohorts"</span>]</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"n_cohorts"</span>: <span class="st">"avg_cohorts"</span>})</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>plot_cohorts <span class="op">=</span> (</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    ggplot(cohort_check, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"avg_cohorts"</span>)) <span class="op">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#1f77b4"</span>) <span class="op">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span>K, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>) <span class="op">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Average number of cohorts"</span>,</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="ss">f"Active Cohorts per Portfolio (K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>plot_cohorts</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<div id="fig-cohort-count" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart showing the number of active cohorts per momentum portfolio over time, ramping up from 1 to K during the initial months and then remaining stable at K.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cohort-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-cohort-count-output-1.png" alt="A line chart showing the number of active cohorts per momentum portfolio over time, ramping up from 1 to K during the initial months and then remaining stable at K." width="960" height="384" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cohort-count-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.2: Number of active cohorts per momentum portfolio over time. After an initial ramp-up period of K months, each portfolio should have exactly K active cohorts contributing to its monthly return.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="baseline-results-j6-k6-strategy" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="baseline-results-j6-k6-strategy"><span class="header-section-number">12.5</span> Baseline Results: J=6, K=6 Strategy</h2>
<section id="summary-statistics-by-momentum-decile" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="summary-statistics-by-momentum-decile"><span class="header-section-number">12.5.1</span> Summary Statistics by Momentum Decile</h3>
<p>We now examine the average monthly returns for each momentum decile portfolio. <a href="#tbl-momentum-deciles" class="quarto-xref">Table&nbsp;<span>12.2</span></a> presents the mean, <span class="math inline">\(t\)</span>-statistic, and <span class="math inline">\(p\)</span>-value for each of the ten portfolios.</p>
<div class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_stats(group):</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute mean, t-stat, and p-value for a return series."""</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> group.mean()</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    std_ret <span class="op">=</span> group.std()</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N"</span>: n,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mean (%)"</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Std (%)"</span>: std_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t-stat"</span>: t_stat,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p-value"</span>: p_val</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>momentum_stats <span class="op">=</span> (ewret</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"momr"</span>)[<span class="st">"ewret"</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_portfolio_stats)</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    .unstack()</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>momentum_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-momentum-deciles" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="16">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-momentum-deciles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.2: Average monthly returns of momentum decile portfolios for the J=6, K=6 strategy. Portfolio 1 contains past losers and portfolio 10 contains past winners. The table reports the number of months, mean monthly return, t-statistic, and p-value for each decile.
</figcaption>
<div aria-describedby="tbl-momentum-deciles-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="16">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">N</th>
<th data-quarto-table-cell-role="th">Mean (%)</th>
<th data-quarto-table-cell-role="th">Std (%)</th>
<th data-quarto-table-cell-role="th">t-stat</th>
<th data-quarto-table-cell-role="th">p-value</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">momr</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1</th>
<td>161.0</td>
<td>1.4190</td>
<td>6.5319</td>
<td>2.7565</td>
<td>0.0065</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">2</th>
<td>161.0</td>
<td>0.6602</td>
<td>5.9895</td>
<td>1.3985</td>
<td>0.1639</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">3</th>
<td>161.0</td>
<td>0.3658</td>
<td>5.5080</td>
<td>0.8427</td>
<td>0.4007</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">4</th>
<td>161.0</td>
<td>0.1623</td>
<td>5.0085</td>
<td>0.4112</td>
<td>0.6815</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">5</th>
<td>161.0</td>
<td>0.0111</td>
<td>4.7561</td>
<td>0.0297</td>
<td>0.9763</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">6</th>
<td>161.0</td>
<td>0.0408</td>
<td>4.6864</td>
<td>0.1104</td>
<td>0.9122</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">7</th>
<td>161.0</td>
<td>-0.0674</td>
<td>4.8881</td>
<td>-0.1749</td>
<td>0.8614</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">8</th>
<td>161.0</td>
<td>-0.2066</td>
<td>4.9208</td>
<td>-0.5329</td>
<td>0.5949</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">9</th>
<td>161.0</td>
<td>-0.2228</td>
<td>5.3013</td>
<td>-0.5332</td>
<td>0.5946</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>161.0</td>
<td>-0.6812</td>
<td>5.7131</td>
<td>-1.5130</td>
<td>0.1323</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="the-long-short-momentum-portfolio" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="the-long-short-momentum-portfolio"><span class="header-section-number">12.5.2</span> The Long-Short Momentum Portfolio</h3>
<p>The key test of the momentum effect is whether the spread between winners and losers—the long-short momentum portfolio—generates statistically significant positive returns. We construct this spread portfolio by going long the top decile (portfolio 10) and short the bottom decile (portfolio 1).</p>
<div id="76f1a769" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to wide format</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ewret_wide <span class="op">=</span> ewret.pivot(</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>ewret_wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute long-short return</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"winners"</span>] <span class="op">=</span> ewret_wide[<span class="st">"port10"</span>]</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"losers"</span>] <span class="op">=</span> ewret_wide[<span class="st">"port1"</span>]</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"long_short"</span>] <span class="op">=</span> ewret_wide[<span class="st">"winners"</span>] <span class="op">-</span> ewret_wide[<span class="st">"losers"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ls_stats <span class="op">=</span> pd.DataFrame()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    series <span class="op">=</span> ewret_wide[col].dropna()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    mean_val <span class="op">=</span> series.mean()</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    std_val <span class="op">=</span> series.std()</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    t_val <span class="op">=</span> mean_val <span class="op">/</span> (std_val <span class="op">/</span> np.sqrt(n))</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_val), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    ls_stats[col] <span class="op">=</span> [n, mean_val <span class="op">*</span> <span class="dv">100</span>, std_val <span class="op">*</span> <span class="dv">100</span>, t_val, p_val]</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>ls_stats.index <span class="op">=</span> [<span class="st">"N"</span>, <span class="st">"Mean (%)"</span>, <span class="st">"Std (%)"</span>, <span class="st">"t-stat"</span>, <span class="st">"p-value"</span>]</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>ls_stats.columns <span class="op">=</span> [<span class="st">"Winners"</span>, <span class="st">"Losers"</span>, <span class="st">"Long-Short"</span>]</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>ls_stats <span class="op">=</span> ls_stats.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>ls_stats</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-long-short" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.3: Performance of the momentum long-short strategy (J=6, K=6). Winners is the top decile, Losers is the bottom decile, and Long-Short is Winners minus Losers. The table reports the number of months, mean monthly return, t-statistic, and p-value.
</figcaption>
<div aria-describedby="tbl-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="18">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Winners</th>
<th data-quarto-table-cell-role="th">Losers</th>
<th data-quarto-table-cell-role="th">Long-Short</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">N</th>
<td>161.0000</td>
<td>161.0000</td>
<td>161.0000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Mean (%)</th>
<td>-0.6812</td>
<td>1.4190</td>
<td>-2.1002</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">Std (%)</th>
<td>5.7131</td>
<td>6.5319</td>
<td>4.8969</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">t-stat</th>
<td>-1.5130</td>
<td>2.7565</td>
<td>-5.4420</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">p-value</th>
<td>0.1323</td>
<td>0.0065</td>
<td>0.0000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="cumulative-returns" class="level3" data-number="12.5.3">
<h3 data-number="12.5.3" class="anchored" data-anchor-id="cumulative-returns"><span class="header-section-number">12.5.3</span> Cumulative Returns</h3>
<p>The time-series evolution of cumulative returns provides visual evidence of the momentum strategy’s performance. <a href="#fig-cumret-winners-losers" class="quarto-xref">Figure&nbsp;<span>12.3</span></a> shows the cumulative returns of the winner and loser portfolios, while <a href="#fig-cumret-long-short" class="quarto-xref">Figure&nbsp;<span>12.4</span></a> shows the cumulative return of the long-short momentum strategy.</p>
<div id="73e6a4ef" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cumulative returns</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ewret_wide <span class="op">=</span> ewret_wide.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    ewret_wide[<span class="ss">f"cumret_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ewret_wide[col]).cumprod() <span class="op">-</span> <span class="dv">1</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-cumret-winners-losers" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cumret_plot_data <span class="op">=</span> (ewret_wide</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"cumret_winners"</span>, <span class="st">"cumret_losers"</span>]]</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    .melt(id_vars<span class="op">=</span><span class="st">"date"</span>, var_name<span class="op">=</span><span class="st">"portfolio"</span>, value_name<span class="op">=</span><span class="st">"cumret"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>cumret_plot_data[<span class="st">"portfolio"</span>] <span class="op">=</span> cumret_plot_data[<span class="st">"portfolio"</span>].<span class="bu">map</span>({</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cumret_winners"</span>: <span class="st">"Winners (P10)"</span>,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cumret_losers"</span>: <span class="st">"Losers (P1)"</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>plot_cumret <span class="op">=</span> (</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    ggplot(cumret_plot_data, </span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret"</span>, color<span class="op">=</span><span class="st">"portfolio"</span>)) <span class="op">+</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    scale_color_manual(values<span class="op">=</span>[<span class="st">"#d62728"</span>, <span class="st">"#1f77b4"</span>]) <span class="op">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Portfolio"</span>,</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cumulative Returns: Winners vs. Losers"</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"bottom"</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>plot_cumret</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<div id="fig-cumret-winners-losers" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart showing cumulative returns of the winner and loser momentum portfolios over time. The winner portfolio generally accumulates higher returns than the loser portfolio, though both exhibit substantial variation.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumret-winners-losers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-cumret-winners-losers-output-1.png" alt="A line chart showing cumulative returns of the winner and loser momentum portfolios over time. The winner portfolio generally accumulates higher returns than the loser portfolio, though both exhibit substantial variation." width="960" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cumret-winners-losers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.3: Cumulative returns of momentum winner and loser portfolios. The winner portfolio (blue) contains stocks in the top decile of past 6-month returns, and the loser portfolio (red) contains stocks in the bottom decile. The spread between the two lines reflects the cumulative momentum premium.
</figcaption>
</figure>
</div>
</div>
</div>
<div id="cell-fig-cumret-long-short" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>plot_ls <span class="op">=</span> (</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret_long_short"</span>)) <span class="op">+</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"#2ca02c"</span>) <span class="op">+</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cumulative Return: Long-Short Momentum Strategy"</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>plot_ls</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div id="fig-cumret-long-short" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart showing the cumulative return of the long-short momentum strategy over time, exhibiting periods of accumulation interspersed with sharp drawdowns.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumret-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-cumret-long-short-output-1.png" alt="A line chart showing the cumulative return of the long-short momentum strategy over time, exhibiting periods of accumulation interspersed with sharp drawdowns." width="960" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cumret-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.4: Cumulative return of the momentum long-short strategy (Winners minus Losers). Upward-sloping periods indicate momentum profits; sharp drawdowns often coincide with market reversals or crisis episodes.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="monthly-return-distribution" class="level3" data-number="12.5.4">
<h3 data-number="12.5.4" class="anchored" data-anchor-id="monthly-return-distribution"><span class="header-section-number">12.5.4</span> Monthly Return Distribution</h3>
<p>Beyond the mean, the full distribution of monthly long-short returns provides insight into the risk profile of the momentum strategy. <a href="#fig-return-distribution" class="quarto-xref">Figure&nbsp;<span>12.5</span></a> shows the histogram of monthly returns.</p>
<div id="cell-fig-return-distribution" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>mean_ls <span class="op">=</span> ewret_wide[<span class="st">"long_short"</span>].mean()</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>plot_dist <span class="op">=</span> (</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"long_short"</span>)) <span class="op">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#1f77b4"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    geom_vline(xintercept<span class="op">=</span>mean_ls, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>) <span class="op">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    scale_x_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly long-short return"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Monthly Momentum Returns"</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>plot_dist</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<div id="fig-return-distribution" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A histogram of monthly long-short momentum returns, approximately centered near zero or slightly positive, with tails extending in both directions.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-return-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-return-distribution-output-1.png" alt="A histogram of monthly long-short momentum returns, approximately centered near zero or slightly positive, with tails extending in both directions." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-return-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.5: Distribution of monthly long-short momentum returns. The histogram shows the frequency distribution of monthly Winners-minus-Losers returns. The vertical dashed line indicates the mean monthly return.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="extending-to-multiple-formation-and-holding-periods" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="extending-to-multiple-formation-and-holding-periods"><span class="header-section-number">12.6</span> Extending to Multiple Formation and Holding Periods</h2>
<section id="the-j-k-grid" class="level3" data-number="12.6.1">
<h3 data-number="12.6.1" class="anchored" data-anchor-id="the-j-k-grid"><span class="header-section-number">12.6.1</span> The J × K Grid</h3>
<p><span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> evaluate momentum strategies across a comprehensive grid of formation periods <span class="math inline">\(J \in \{3, 6, 9, 12\}\)</span> and holding periods <span class="math inline">\(K \in \{3, 6, 9, 12\}\)</span>. This produces 16 different strategy specifications, allowing us to assess the robustness of the momentum effect across different horizons.</p>
<p>We now implement a function that computes the full momentum strategy for any given <span class="math inline">\((J, K)\)</span> pair, wrapping the steps developed above into a single reusable pipeline.</p>
<div id="588a9401" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> momentum_strategy(data, J, K, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Implement the full Jegadeesh-Titman momentum strategy.</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel of stock returns with columns: symbol, date, ret.</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period in months.</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">    K : int</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Holding period in months.</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios (default: 10 for deciles).</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns for each momentum portfolio and the long-short spread.</span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Compute formation period cumulative returns</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>]).dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>])</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Assign to momentum portfolios using transform</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>            q<span class="op">=</span>n_portfolios,</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>            duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="st">'Int64'</span>)</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If any NaNs in momr, fill with rank-based assignment</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> df[<span class="st">"momr"</span>].isna()</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">"momr"</span>] <span class="op">=</span> df.loc[mask].groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="bu">min</span>(n_portfolios, <span class="bu">len</span>(x.unique())),</span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="st">'Int64'</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Define holding period dates</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>})</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate1"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate2"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Merge with holding period returns</span></span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> df[[<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]].merge(</span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>        data[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use boolean indexing</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&gt;=</span> port_ret[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&lt;=</span> port_ret[<span class="st">"hdate2"</span>])</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Compute equally weighted returns (two-stage averaging)</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a>    cohort_ret <span class="op">=</span> (port_ret</span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a>        .agg(cohort_ret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>    monthly_ret <span class="op">=</span> (cohort_ret</span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>        .agg(ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Compute long-short spread</span></span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> monthly_ret.pivot(</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle variable number of portfolios</span></span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(wide.columns) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>    wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_cols <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"winners"</span>] <span class="op">=</span> wide[<span class="ss">f"port</span><span class="sc">{</span>n_cols<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"losers"</span>] <span class="op">=</span> wide[<span class="st">"port1"</span>]</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"long_short"</span>] <span class="op">=</span> wide[<span class="st">"winners"</span>] <span class="op">-</span> wide[<span class="st">"losers"</span>]</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_ret, wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="running-the-full-grid" class="level3" data-number="12.6.2">
<h3 data-number="12.6.2" class="anchored" data-anchor-id="running-the-full-grid"><span class="header-section-number">12.6.2</span> Running the Full Grid</h3>
<p>We now run the momentum strategy for all 16 <span class="math inline">\((J, K)\)</span> combinations. This is computationally intensive, so we store the key summary statistics for each specification.</p>
<section id="sequential-calculation" class="level4" data-number="12.6.2.1">
<h4 data-number="12.6.2.1" class="anchored" data-anchor-id="sequential-calculation"><span class="header-section-number">12.6.2.1</span> Sequential Calculation</h4>
<div id="momemtum-calculation-squential" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>J_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>K_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>results_grid <span class="op">=</span> []</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> J_val, K_val <span class="kw">in</span> product(J_values, K_values):</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Computing J=</span><span class="sc">{</span>J_val<span class="sc">}</span><span class="ss">, K=</span><span class="sc">{</span>K_val<span class="sc">}</span><span class="ss">..."</span>, end<span class="op">=</span><span class="st">" "</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>        _, wide_result <span class="op">=</span> momentum_strategy(prices_clean, J_val, K_val)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> portfolio_name <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>            series <span class="op">=</span> wide_result[portfolio_name].dropna()</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>            mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>            std_ret <span class="op">=</span> series.std()</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>            t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>            p_val <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) </span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan)</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>            results_grid.append({</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"J"</span>: J_val,</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"K"</span>: K_val,</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"portfolio"</span>: portfolio_name,</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_months"</span>: n,</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"mean_ret"</span>: mean_ret,</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"std_ret"</span>: std_ret,</span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"t_stat"</span>: t_stat,</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"p_value"</span>: p_val</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Done."</span>)</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(results_grid)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="parallel-calculation" class="level4" data-number="12.6.2.2">
<h4 data-number="12.6.2.2" class="anchored" data-anchor-id="parallel-calculation"><span class="header-section-number">12.6.2.2</span> Parallel Calculation</h4>
<div id="2ecf2e86" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_single_strategy(data, J, K):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute statistics for a single (J, K) strategy.</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a list of result dicts, one per portfolio.</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>        _, wide_result <span class="op">=</span> momentum_strategy(data, J, K)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> portfolio_name <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>            series <span class="op">=</span> wide_result[portfolio_name].dropna()</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>            mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>            std_ret <span class="op">=</span> series.std()</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>            t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>            p_val <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) </span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>            results.append({</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"J"</span>: J,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"K"</span>: K,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"portfolio"</span>: portfolio_name,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_months"</span>: n,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"mean_ret"</span>: mean_ret,</span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"std_ret"</span>: std_ret,</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"t_stat"</span>: t_stat,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"p_value"</span>: p_val</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error in J=</span><span class="sc">{</span>J<span class="sc">}</span><span class="ss">, K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="9ba734a0" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>J_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>K_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create list of (J, K) pairs</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> <span class="bu">list</span>(product(J_values, K_values))</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Running </span><span class="sc">{</span><span class="bu">len</span>(params)<span class="sc">}</span><span class="ss"> momentum strategies in parallel with 4 cores..."</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel execution with 4 workers</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>results_list <span class="op">=</span> Parallel(n_jobs<span class="op">=</span><span class="dv">4</span>, verbose<span class="op">=</span><span class="dv">10</span>)(</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    delayed(compute_single_strategy)(prices_clean, J, K)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> J, K <span class="kw">in</span> params</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten results</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>results_grid <span class="op">=</span> [item <span class="cf">for</span> sublist <span class="kw">in</span> results_list <span class="cf">for</span> item <span class="kw">in</span> sublist]</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(results_grid)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed in </span><span class="sc">{</span>elapsed<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Running 16 momentum strategies in parallel with 4 cores...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Parallel(n_jobs=4)]: Using backend LokyBackend with 4 concurrent workers.
[Parallel(n_jobs=4)]: Done   5 tasks      | elapsed:    8.9s
[Parallel(n_jobs=4)]: Done  11 out of  16 | elapsed:   14.6s remaining:    6.6s
[Parallel(n_jobs=4)]: Done  13 out of  16 | elapsed:   19.4s remaining:    4.5s</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Completed in 20.20 seconds</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>[Parallel(n_jobs=4)]: Done  16 out of  16 | elapsed:   20.1s finished</code></pre>
</div>
</div>
<div id="3e8bdbc4" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Results Summary by Formation Period:"</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_df.groupby(<span class="st">"J"</span>).agg({</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_ret"</span>: <span class="st">"mean"</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std_ret"</span>: <span class="st">"mean"</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t_stat"</span>: [<span class="st">"mean"</span>, <span class="kw">lambda</span> x: (x.<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.96</span>).<span class="bu">sum</span>()],</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_months"</span>: <span class="st">"first"</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>}).<span class="bu">round</span>(<span class="dv">6</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Results Summary by Formation Period:
    mean_ret   std_ret    t_stat            n_months
        mean      mean      mean &lt;lambda_0&gt;    first
J                                                   
6  -0.004661  0.055672 -1.517507          9      161
9  -0.003265  0.056520 -1.071904          9      158
12 -0.002759  0.058194 -0.931273          9      155</code></pre>
</div>
</div>
</section>
</section>
<section id="winners-portfolio-returns" class="level3" data-number="12.6.3">
<h3 data-number="12.6.3" class="anchored" data-anchor-id="winners-portfolio-returns"><span class="header-section-number">12.6.3</span> Winners Portfolio Returns</h3>
<p><a href="#tbl-winners-grid" class="quarto-xref">Table&nbsp;<span>12.4</span></a> presents the average monthly returns of the winner portfolio (portfolio 10) across all <span class="math inline">\((J, K)\)</span> combinations.</p>
<div class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>winners_grid <span class="op">=</span> (results_df</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'winners'"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>winners_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> winners_grid.columns]</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>winners_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> winners_grid.index]</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>winners_grid</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-winners-grid" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="28">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-winners-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.4: Average monthly returns (%) of the winner portfolio across formation periods (J) and holding periods (K). t-statistics are reported in parentheses.
</figcaption>
<div aria-describedby="tbl-winners-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="27">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">K=3</th>
<th data-quarto-table-cell-role="th">K=6</th>
<th data-quarto-table-cell-role="th">K=9</th>
<th data-quarto-table-cell-role="th">K=12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=6</th>
<td>-1.18\n(-2.65)</td>
<td>-0.68\n(-1.51)</td>
<td>-0.55\n(-1.23)</td>
<td>-0.39\n(-0.87)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">J=9</th>
<td>-1.00\n(-2.36)</td>
<td>-0.51\n(-1.22)</td>
<td>-0.28\n(-0.68)</td>
<td>-0.16\n(-0.39)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=12</th>
<td>-0.88\n(-2.09)</td>
<td>-0.39\n(-0.91)</td>
<td>-0.24\n(-0.56)</td>
<td>-0.14\n(-0.34)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="losers-portfolio-returns" class="level3" data-number="12.6.4">
<h3 data-number="12.6.4" class="anchored" data-anchor-id="losers-portfolio-returns"><span class="header-section-number">12.6.4</span> Losers Portfolio Returns</h3>
<p><a href="#tbl-losers-grid" class="quarto-xref">Table&nbsp;<span>12.5</span></a> presents the corresponding results for the loser portfolio.</p>
<div class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>losers_grid <span class="op">=</span> (results_df</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'losers'"</span>)</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>losers_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> losers_grid.columns]</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>losers_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> losers_grid.index]</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>losers_grid</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-losers-grid" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="29">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-losers-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.5: Average monthly returns (%) of the loser portfolio across formation periods (J) and holding periods (K). t-statistics are reported in parentheses.
</figcaption>
<div aria-describedby="tbl-losers-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">K=3</th>
<th data-quarto-table-cell-role="th">K=6</th>
<th data-quarto-table-cell-role="th">K=9</th>
<th data-quarto-table-cell-role="th">K=12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=6</th>
<td>1.87\n(3.49)</td>
<td>1.42\n(2.76)</td>
<td>1.10\n(2.19)</td>
<td>0.99\n(1.99)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">J=9</th>
<td>1.94\n(3.51)</td>
<td>1.38\n(2.56)</td>
<td>1.21\n(2.31)</td>
<td>1.15\n(2.22)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=12</th>
<td>1.57\n(2.71)</td>
<td>1.29\n(2.28)</td>
<td>1.19\n(2.13)</td>
<td>1.15\n(2.09)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="long-short-momentum-returns" class="level3" data-number="12.6.5">
<h3 data-number="12.6.5" class="anchored" data-anchor-id="long-short-momentum-returns"><span class="header-section-number">12.6.5</span> Long-Short Momentum Returns</h3>
<p><a href="#tbl-ls-grid" class="quarto-xref">Table&nbsp;<span>12.6</span></a> presents the most important results: the average monthly returns of the long-short momentum portfolio across all specifications.</p>
<div class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ls_grid <span class="op">=</span> (results_df</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'long_short'"</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>ls_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> ls_grid.columns]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>ls_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> ls_grid.index]</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>ls_grid</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-ls-grid" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="30">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ls-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.6: Average monthly returns (%) of the momentum long-short portfolio (Winners minus Losers) across formation periods (J) and holding periods (K). t-statistics are reported in parentheses. This table replicates the format of Table 1 in Jegadeesh and Titman (1993).
</figcaption>
<div aria-describedby="tbl-ls-grid-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="29">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">K=3</th>
<th data-quarto-table-cell-role="th">K=6</th>
<th data-quarto-table-cell-role="th">K=9</th>
<th data-quarto-table-cell-role="th">K=12</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=6</th>
<td>-3.04\n(-7.38)</td>
<td>-2.10\n(-5.44)</td>
<td>-1.65\n(-4.94)</td>
<td>-1.37\n(-4.61)</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">J=9</th>
<td>-2.94\n(-6.41)</td>
<td>-1.89\n(-4.55)</td>
<td>-1.49\n(-3.98)</td>
<td>-1.31\n(-3.87)</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">J=12</th>
<td>-2.45\n(-5.42)</td>
<td>-1.68\n(-3.92)</td>
<td>-1.43\n(-3.60)</td>
<td>-1.30\n(-3.55)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="visualizing-the-momentum-premium-across-specifications" class="level3" data-number="12.6.6">
<h3 data-number="12.6.6" class="anchored" data-anchor-id="visualizing-the-momentum-premium-across-specifications"><span class="header-section-number">12.6.6</span> Visualizing the Momentum Premium Across Specifications</h3>
<p><a href="#fig-momentum-heatmap" class="quarto-xref">Figure&nbsp;<span>12.6</span></a> provides a visual summary of the long-short momentum premium across all <span class="math inline">\((J, K)\)</span> combinations.</p>
<div id="cell-fig-momentum-heatmap" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ls_heatmap_data <span class="op">=</span> (results_df</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'long_short'"</span>)</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        mean_pct<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"mean_ret"</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        significant<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"p_value"</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>,</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="kw">lambda</span> x: x.<span class="bu">apply</span>(</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> row: <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'mean_ret'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}{</span><span class="st">'*'</span> <span class="cf">if</span> row[<span class="st">'p_value'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="cf">else</span> <span class="st">''</span><span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>plot_heatmap <span class="op">=</span> (</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    ggplot(ls_heatmap_data, </span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"K.astype(str)"</span>, y<span class="op">=</span><span class="st">"J.astype(str)"</span>, fill<span class="op">=</span><span class="st">"mean_pct"</span>)) <span class="op">+</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>    geom_tile(color<span class="op">=</span><span class="st">"white"</span>, size<span class="op">=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label<span class="op">=</span><span class="st">"label"</span>), size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"white"</span>) <span class="op">+</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>    scale_fill_gradient2(</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>        low<span class="op">=</span><span class="st">"#d62728"</span>, mid<span class="op">=</span><span class="st">"#f7f7f7"</span>, high<span class="op">=</span><span class="st">"#1f77b4"</span>, midpoint<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"Monthly</span><span class="ch">\n</span><span class="st">Return (%)"</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Holding Period (K months)"</span>,</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Formation Period (J months)"</span>,</span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Premium Across J×K Specifications"</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a>plot_heatmap</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div id="fig-momentum-heatmap" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A heatmap with formation period J on the y-axis and holding period K on the x-axis, with cell colors indicating the magnitude of the momentum premium.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-momentum-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-momentum-heatmap-output-1.png" alt="A heatmap with formation period J on the y-axis and holding period K on the x-axis, with cell colors indicating the magnitude of the momentum premium." width="768" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-momentum-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.6: Heatmap of average monthly long-short momentum returns (%) across formation periods (J) and holding periods (K). Darker shades indicate higher momentum profits. Asterisks denote statistical significance at the 5% level.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="risk-adjusted-performance" class="level2" data-number="12.7">
<h2 data-number="12.7" class="anchored" data-anchor-id="risk-adjusted-performance"><span class="header-section-number">12.7</span> Risk-Adjusted Performance</h2>
<section id="capm-alpha" class="level3" data-number="12.7.1">
<h3 data-number="12.7.1" class="anchored" data-anchor-id="capm-alpha"><span class="header-section-number">12.7.1</span> CAPM Alpha</h3>
<p>A natural question is whether the momentum premium is explained by exposure to the market factor. We estimate the CAPM alpha of the long-short momentum portfolio by regressing its returns on the market excess return:</p>
<p><span id="eq-capm-alpha"><span class="math display">\[
r_{\text{WML},t} = \alpha + \beta \cdot r_{\text{MKT},t} + \epsilon_t
\tag{12.3}\]</span></span></p>
<div id="bc178970" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge momentum returns with factor data (baseline J=6, K=6)</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>ewret_factors <span class="op">=</span> (ewret_wide</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]]</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    .merge(factors_ff3_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPM regression for long-short portfolio</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.formula.api <span class="im">import</span> ols <span class="im">as</span> ols_formula</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>X_capm <span class="op">=</span> sm.add_constant(ewret_factors[<span class="st">"mkt_excess"</span>])</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>y_ls <span class="op">=</span> ewret_factors[<span class="st">"long_short"</span>]</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>capm_model <span class="op">=</span> sm.OLS(y_ls, X_capm).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM Regression: Long-Short Momentum Returns"</span>)</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha (monthly):  </span><span class="sc">{</span>capm_model<span class="sc">.</span>params[<span class="st">'const'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.4f}</span><span class="ss">% "</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(t=</span><span class="sc">{</span>capm_model<span class="sc">.</span>tvalues[<span class="st">'const'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Market Beta:      </span><span class="sc">{</span>capm_model<span class="sc">.</span>params[<span class="st">'mkt_excess'</span>]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(t=</span><span class="sc">{</span>capm_model<span class="sc">.</span>tvalues[<span class="st">'mkt_excess'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R-squared:        </span><span class="sc">{</span>capm_model<span class="sc">.</span>rsquared<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"N observations:   </span><span class="sc">{</span>capm_model<span class="sc">.</span>nobs<span class="sc">:.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>CAPM Regression: Long-Short Momentum Returns
============================================================
Alpha (monthly):  -2.2703% (t=-5.05)
Market Beta:      -0.1779 (t=-1.75)
R-squared:        0.0470
N observations:   150</code></pre>
</div>
</div>
</section>
<section id="fama-french-three-factor-alpha" class="level3" data-number="12.7.2">
<h3 data-number="12.7.2" class="anchored" data-anchor-id="fama-french-three-factor-alpha"><span class="header-section-number">12.7.2</span> Fama-French Three-Factor Alpha</h3>
<p>We extend the risk adjustment to the Fama-French three-factor model, which includes the size (SMB) and value (HML) factors in addition to the market factor:</p>
<p><span id="eq-ff3-alpha"><span class="math display">\[
r_{\text{WML},t} = \alpha + \beta_1 \cdot r_{\text{MKT},t} + \beta_2 \cdot \text{SMB}_t + \beta_3 \cdot \text{HML}_t + \epsilon_t
\tag{12.4}\]</span></span></p>
<div class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>X_ff3 <span class="op">=</span> sm.add_constant(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    ewret_factors[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>y_ls <span class="op">=</span> ewret_factors[<span class="st">"long_short"</span>]</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>ff3_model <span class="op">=</span> sm.OLS(y_ls, X_ff3).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results as a clean table</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>ff3_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: ff3_model.params,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: ff3_model.bse,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: ff3_model.tvalues,</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: ff3_model.pvalues</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>}).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>ff3_results.index <span class="op">=</span> [<span class="st">"Alpha"</span>, <span class="st">"MKT"</span>, <span class="st">"SMB"</span>, <span class="st">"HML"</span>]</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>ff3_results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-ff3-regression" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="33">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ff3-regression-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.7: Fama-French three-factor regression for the momentum long-short portfolio. The dependent variable is the monthly return of the Winners-minus-Losers portfolio. Alpha is the intercept, representing the risk-adjusted abnormal return. HAC standard errors with 6 lags are used.
</figcaption>
<div aria-describedby="tbl-ff3-regression-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Coefficient</th>
<th data-quarto-table-cell-role="th">Std Error</th>
<th data-quarto-table-cell-role="th">t-stat</th>
<th data-quarto-table-cell-role="th">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">Alpha</th>
<td>-0.0234</td>
<td>0.0041</td>
<td>-5.7189</td>
<td>0.0000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">MKT</th>
<td>-0.1269</td>
<td>0.1558</td>
<td>-0.8145</td>
<td>0.4154</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">SMB</th>
<td>0.1123</td>
<td>0.1882</td>
<td>0.5969</td>
<td>0.5506</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">HML</th>
<td>0.0716</td>
<td>0.1414</td>
<td>0.5065</td>
<td>0.6125</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div id="518c6c35" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">R-squared: </span><span class="sc">{</span>ff3_model<span class="sc">.</span>rsquared<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Adjusted R-squared: </span><span class="sc">{</span>ff3_model<span class="sc">.</span>rsquared_adj<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha (annualized): </span><span class="sc">{</span>ff3_model<span class="sc">.</span>params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>
R-squared: 0.0553
Adjusted R-squared: 0.0359
Alpha (annualized): -28.02%</code></pre>
</div>
</div>
</section>
<section id="interpretation-of-risk-exposures" class="level3" data-number="12.7.3">
<h3 data-number="12.7.3" class="anchored" data-anchor-id="interpretation-of-risk-exposures"><span class="header-section-number">12.7.3</span> Interpretation of Risk Exposures</h3>
<p>The factor loadings from the three-factor regression reveal the risk characteristics of the momentum strategy in the Vietnamese market. Several patterns are commonly observed:</p>
<ol type="1">
<li><p><strong>Market beta</strong>: Momentum portfolios typically have moderate market exposure. In the U.S., <span class="citation" data-cites="grundy2001understanding">Grundy and Martin (<a href="references.html#ref-grundy2001understanding" role="doc-biblioref">2001</a>)</span> document that the market beta of the long-short portfolio is close to zero on average but highly time-varying, spiking during market reversals.</p></li>
<li><p><strong>Size exposure (SMB)</strong>: Momentum strategies often load positively on the size factor, reflecting the tendency for smaller stocks to exhibit stronger momentum patterns.</p></li>
<li><p><strong>Value exposure (HML)</strong>: The long-short momentum portfolio typically loads negatively on HML, indicating that winners tend to be growth stocks while losers tend to be value stocks. This creates a natural tension between momentum and value strategies.</p></li>
</ol>
</section>
</section>
<section id="momentum-and-market-states" class="level2" data-number="12.8">
<h2 data-number="12.8" class="anchored" data-anchor-id="momentum-and-market-states"><span class="header-section-number">12.8</span> Momentum and Market States</h2>
<section id="conditional-performance" class="level3" data-number="12.8.1">
<h3 data-number="12.8.1" class="anchored" data-anchor-id="conditional-performance"><span class="header-section-number">12.8.1</span> Conditional Performance</h3>
<p>An important finding in the momentum literature is that momentum profits vary with market conditions. <span class="citation" data-cites="cooper2004market">Cooper, Gutierrez Jr, and Hameed (<a href="references.html#ref-cooper2004market" role="doc-biblioref">2004</a>)</span> document that momentum strategies perform well following market gains (UP markets) but experience severe losses following market declines (DOWN markets). This asymmetry is particularly relevant for emerging markets, which experience more extreme market states.</p>
<p>We define market states based on the cumulative market return over the prior 12 months:</p>
<p><span id="eq-market-state"><span class="math display">\[
\text{Market State}_t = \begin{cases} \text{UP} &amp; \text{if } \prod_{s=t-12}^{t-1}(1 + r_{m,s}) - 1 &gt; 0 \\ \text{DOWN} &amp; \text{otherwise} \end{cases}
\tag{12.5}\]</span></span></p>
<div id="b790fe9d" class="cell" data-execution_count="35">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute 12-month lagged market return</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> factors_ff3_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]].copy()</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> market_returns.sort_values(<span class="st">"date"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>market_returns[<span class="st">"mkt_cum_12m"</span>] <span class="op">=</span> (</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="op">+</span> market_returns[<span class="st">"mkt_excess"</span>])</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>    .rolling(window<span class="op">=</span><span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>market_returns[<span class="st">"market_state"</span>] <span class="op">=</span> np.where(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    market_returns[<span class="st">"mkt_cum_12m"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"UP"</span>, <span class="st">"DOWN"</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with momentum returns</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>ewret_states <span class="op">=</span> ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].merge(</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"market_state"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>).dropna()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-execution_count="36">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>state_stats <span class="op">=</span> []</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> [<span class="st">"UP"</span>, <span class="st">"DOWN"</span>]:</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> ewret_states.query(<span class="ss">f"market_state == '</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">'"</span>)[<span class="st">"long_short"</span>]</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(subset)</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> subset.mean()</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>    std_ret <span class="op">=</span> subset.std()</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    state_stats.append({</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Market State"</span>: state,</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N Months"</span>: n,</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mean (%)"</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Std (%)"</span>: std_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t-stat"</span>: t_stat,</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p-value"</span>: p_val</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>state_stats_df <span class="op">=</span> pd.DataFrame(state_stats).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a>state_stats_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-market-states" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="36">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-market-states-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.8: Momentum long-short returns conditional on market states. UP markets are defined as periods where the cumulative market return over the prior 12 months is positive; DOWN markets are periods with negative prior 12-month returns.
</figcaption>
<div aria-describedby="tbl-market-states-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Market State</th>
<th data-quarto-table-cell-role="th">N Months</th>
<th data-quarto-table-cell-role="th">Mean (%)</th>
<th data-quarto-table-cell-role="th">Std (%)</th>
<th data-quarto-table-cell-role="th">t-stat</th>
<th data-quarto-table-cell-role="th">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>UP</td>
<td>39</td>
<td>-1.1972</td>
<td>4.5814</td>
<td>-1.6320</td>
<td>0.1109</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>DOWN</td>
<td>111</td>
<td>-2.4050</td>
<td>4.8669</td>
<td>-5.2063</td>
<td>0.0000</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div id="cell-fig-momentum-states" class="cell" data-execution_count="37">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>plot_states <span class="op">=</span> (</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_states, aes(x<span class="op">=</span><span class="st">"market_state"</span>, y<span class="op">=</span><span class="st">"long_short"</span>, </span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>                              fill<span class="op">=</span><span class="st">"market_state"</span>)) <span class="op">+</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>    geom_boxplot(alpha<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    scale_fill_manual(values<span class="op">=</span>{<span class="st">"UP"</span>: <span class="st">"#1f77b4"</span>, <span class="st">"DOWN"</span>: <span class="st">"#d62728"</span>}) <span class="op">+</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Market State (Prior 12-Month Return)"</span>,</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Monthly Long-Short Return"</span>,</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Returns by Market State"</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>),</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"none"</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>plot_states</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div id="fig-momentum-states" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Side-by-side box plots comparing the distribution of momentum returns in UP versus DOWN market states.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-momentum-states-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-momentum-states-output-1.png" alt="Side-by-side box plots comparing the distribution of momentum returns in UP versus DOWN market states." width="768" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-momentum-states-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.7: Distribution of monthly momentum returns by market state. The box plots show the distribution of long-short momentum returns separately for UP and DOWN market states, defined by the sign of the prior 12-month cumulative market return.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="momentum-crashes" class="level2" data-number="12.9">
<h2 data-number="12.9" class="anchored" data-anchor-id="momentum-crashes"><span class="header-section-number">12.9</span> Momentum Crashes</h2>
<section id="understanding-momentum-drawdowns" class="level3" data-number="12.9.1">
<h3 data-number="12.9.1" class="anchored" data-anchor-id="understanding-momentum-drawdowns"><span class="header-section-number">12.9.1</span> Understanding Momentum Drawdowns</h3>
<p>One of the most important risk characteristics of momentum strategies is their susceptibility to sudden, severe losses—known as momentum crashes. <span class="citation" data-cites="daniel2016momentum">Daniel and Moskowitz (<a href="references.html#ref-daniel2016momentum" role="doc-biblioref">2016</a>)</span> document that momentum strategies experience infrequent but extreme losses, typically during market rebounds following bear markets. These crashes occur because the loser portfolio, which has been short, is heavily loaded with high-beta stocks that surge when markets reverse.</p>
<p>We identify the worst drawdowns of the momentum strategy and examine their market context.</p>
<div class="cell" data-execution_count="38">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>worst_months <span class="op">=</span> (ewret_wide</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"long_short"</span>, <span class="st">"winners"</span>, <span class="st">"losers"</span>]]</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    .merge(factors_ff3_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"long_short"</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">10</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>        long_short_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"long_short"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>        winners_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"winners"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>        losers_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"losers"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>        mkt_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"mkt_excess"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"long_short_pct"</span>, <span class="st">"winners_pct"</span>, <span class="st">"losers_pct"</span>, <span class="st">"mkt_pct"</span>]]</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: <span class="st">"Date"</span>,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_short_pct"</span>: <span class="st">"L/S (%)"</span>,</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"winners_pct"</span>: <span class="st">"Winners (%)"</span>,</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"losers_pct"</span>: <span class="st">"Losers (%)"</span>,</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mkt_pct"</span>: <span class="st">"Market (%)"</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>worst_months</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-worst-months" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="38">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-worst-months-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.9: Ten worst months for the momentum long-short strategy. The table reports the date, long-short return, winner return, loser return, and concurrent market return for the ten months with the largest momentum losses.
</figcaption>
<div aria-describedby="tbl-worst-months-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="37">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">L/S (%)</th>
<th data-quarto-table-cell-role="th">Winners (%)</th>
<th data-quarto-table-cell-role="th">Losers (%)</th>
<th data-quarto-table-cell-role="th">Market (%)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">153</th>
<td>2023-05-31</td>
<td>-16.39</td>
<td>-2.69</td>
<td>13.70</td>
<td>2.78</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">39</th>
<td>2013-11-30</td>
<td>-14.26</td>
<td>4.24</td>
<td>18.50</td>
<td>2.57</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">20</th>
<td>2012-04-30</td>
<td>-13.68</td>
<td>1.51</td>
<td>15.19</td>
<td>4.88</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">78</th>
<td>2017-02-28</td>
<td>-13.56</td>
<td>2.10</td>
<td>15.67</td>
<td>1.49</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">107</th>
<td>2019-07-31</td>
<td>-13.15</td>
<td>-2.46</td>
<td>10.69</td>
<td>1.61</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">140</th>
<td>2022-04-30</td>
<td>-11.71</td>
<td>-17.57</td>
<td>-5.87</td>
<td>-11.19</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">149</th>
<td>2023-01-31</td>
<td>-11.53</td>
<td>1.37</td>
<td>12.90</td>
<td>6.96</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">28</th>
<td>2012-12-31</td>
<td>-11.52</td>
<td>4.03</td>
<td>15.54</td>
<td>-1.61</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>2010-08-31</td>
<td>-11.31</td>
<td>-25.03</td>
<td>-13.72</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">10</th>
<td>2011-06-30</td>
<td>-10.44</td>
<td>-3.15</td>
<td>7.29</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="maximum-drawdown-analysis" class="level3" data-number="12.9.2">
<h3 data-number="12.9.2" class="anchored" data-anchor-id="maximum-drawdown-analysis"><span class="header-section-number">12.9.2</span> Maximum Drawdown Analysis</h3>
<p>The maximum drawdown provides a measure of the worst peak-to-trough decline experienced by the strategy. This metric is particularly relevant for practitioners evaluating the risk of momentum strategies.</p>
<div id="836f4d0b" class="cell" data-execution_count="39">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute running maximum and drawdown</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"cum_wealth"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ewret_wide[<span class="st">"long_short"</span>]).cumprod()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"running_max"</span>] <span class="op">=</span> ewret_wide[<span class="st">"cum_wealth"</span>].cummax()</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"drawdown"</span>] <span class="op">=</span> (</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    ewret_wide[<span class="st">"cum_wealth"</span>] <span class="op">/</span> ewret_wide[<span class="st">"running_max"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>max_dd <span class="op">=</span> ewret_wide[<span class="st">"drawdown"</span>].<span class="bu">min</span>()</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>max_dd_date <span class="op">=</span> ewret_wide.loc[ewret_wide[<span class="st">"drawdown"</span>].idxmin(), <span class="st">"date"</span>]</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Maximum drawdown: </span><span class="sc">{</span>max_dd<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date of maximum drawdown: </span><span class="sc">{</span>max_dd_date<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Maximum drawdown: -97.08%
Date of maximum drawdown: 2023-10-31</code></pre>
</div>
</div>
<div id="cell-fig-drawdown" class="cell" data-execution_count="40">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>plot_dd <span class="op">=</span> (</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"drawdown"</span>)) <span class="op">+</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    geom_area(fill<span class="op">=</span><span class="st">"#d62728"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#d62728"</span>, size<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Drawdown"</span>,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Strategy Drawdown"</span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>plot_dd</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div id="fig-drawdown" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A time series chart showing the drawdown of the momentum strategy, with several deep troughs corresponding to momentum crash episodes.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-drawdown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-drawdown-output-1.png" alt="A time series chart showing the drawdown of the momentum strategy, with several deep troughs corresponding to momentum crash episodes." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-drawdown-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.8: Drawdown of the momentum long-short strategy over time. The chart shows the percentage decline from the previous peak in cumulative wealth. Deeper drawdowns represent more severe momentum crashes.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="value-weighted-momentum-portfolios" class="level2" data-number="12.10">
<h2 data-number="12.10" class="anchored" data-anchor-id="value-weighted-momentum-portfolios"><span class="header-section-number">12.10</span> Value-Weighted Momentum Portfolios</h2>
<p>The baseline <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> implementation uses equally weighted portfolios. However, equally weighted returns can be dominated by small, illiquid stocks that may be difficult to trade in practice. Value-weighted portfolios, where each stock’s contribution is proportional to its market capitalization, provide a more investable benchmark and are more representative of the returns that large investors could actually achieve.</p>
<div id="b12140dc" class="cell" data-execution_count="41">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> momentum_strategy_vw(data, J, K, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Value-weighted momentum strategy implementation.</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Same as the equally-weighted version but uses lagged market </span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">    capitalization as weights when computing portfolio returns.</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel with columns: symbol, date, ret, mktcap_lag.</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period in months.</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="co">    K : int</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Holding period in months.</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios.</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly value-weighted portfolio returns.</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Formation period returns</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>]).dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>])</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Portfolio assignment using transform (fast)</span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>            q<span class="op">=</span>n_portfolios,</span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>            duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="st">'Int64'</span>)</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NaNs with rank-based assignment</span></span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> df[<span class="st">"momr"</span>].isna()</span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">"momr"</span>] <span class="op">=</span> df.loc[mask].groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb57-50"><a href="#cb57-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb57-51"><a href="#cb57-51" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb57-52"><a href="#cb57-52" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="bu">min</span>(n_portfolios, <span class="bu">len</span>(x.unique())),</span>
<span id="cb57-53"><a href="#cb57-53" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb57-54"><a href="#cb57-54" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb57-55"><a href="#cb57-55" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb57-56"><a href="#cb57-56" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="st">'Int64'</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb57-57"><a href="#cb57-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-58"><a href="#cb57-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Holding period</span></span>
<span id="cb57-59"><a href="#cb57-59" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>})</span>
<span id="cb57-60"><a href="#cb57-60" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate1"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb57-61"><a href="#cb57-61" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate2"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb57-62"><a href="#cb57-62" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-63"><a href="#cb57-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Merge with holding period returns AND weights</span></span>
<span id="cb57-64"><a href="#cb57-64" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> df[</span>
<span id="cb57-65"><a href="#cb57-65" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb57-66"><a href="#cb57-66" aria-hidden="true" tabindex="-1"></a>    ].merge(</span>
<span id="cb57-67"><a href="#cb57-67" aria-hidden="true" tabindex="-1"></a>        data[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>, <span class="st">"mktcap_lag"</span>]].rename(</span>
<span id="cb57-68"><a href="#cb57-68" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb57-69"><a href="#cb57-69" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb57-70"><a href="#cb57-70" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb57-71"><a href="#cb57-71" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb57-72"><a href="#cb57-72" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-73"><a href="#cb57-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-74"><a href="#cb57-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use boolean indexing instead of query (faster)</span></span>
<span id="cb57-75"><a href="#cb57-75" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[</span>
<span id="cb57-76"><a href="#cb57-76" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&gt;=</span> port_ret[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb57-77"><a href="#cb57-77" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&lt;=</span> port_ret[<span class="st">"hdate2"</span>])</span>
<span id="cb57-78"><a href="#cb57-78" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb57-79"><a href="#cb57-79" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret.dropna(subset<span class="op">=</span>[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb57-80"><a href="#cb57-80" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[port_ret[<span class="st">"mktcap_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb57-81"><a href="#cb57-81" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-82"><a href="#cb57-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Value-weighted returns within each cohort</span></span>
<span id="cb57-83"><a href="#cb57-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vw_mean(group):</span>
<span id="cb57-84"><a href="#cb57-84" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">"mktcap_lag"</span>]</span>
<span id="cb57-85"><a href="#cb57-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weights.<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb57-86"><a href="#cb57-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb57-87"><a href="#cb57-87" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.average(group[<span class="st">"hret"</span>], weights<span class="op">=</span>weights)</span>
<span id="cb57-88"><a href="#cb57-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-89"><a href="#cb57-89" aria-hidden="true" tabindex="-1"></a>    cohort_ret <span class="op">=</span> (port_ret</span>
<span id="cb57-90"><a href="#cb57-90" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb57-91"><a href="#cb57-91" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(vw_mean, include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb57-92"><a href="#cb57-92" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"cohort_ret"</span>)</span>
<span id="cb57-93"><a href="#cb57-93" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-94"><a href="#cb57-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-95"><a href="#cb57-95" aria-hidden="true" tabindex="-1"></a>    monthly_ret <span class="op">=</span> (cohort_ret</span>
<span id="cb57-96"><a href="#cb57-96" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb57-97"><a href="#cb57-97" aria-hidden="true" tabindex="-1"></a>        .agg(vwret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb57-98"><a href="#cb57-98" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb57-99"><a href="#cb57-99" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb57-100"><a href="#cb57-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb57-101"><a href="#cb57-101" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-102"><a href="#cb57-102" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Long-short</span></span>
<span id="cb57-103"><a href="#cb57-103" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> monthly_ret.pivot(</span>
<span id="cb57-104"><a href="#cb57-104" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"vwret"</span></span>
<span id="cb57-105"><a href="#cb57-105" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb57-106"><a href="#cb57-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-107"><a href="#cb57-107" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle variable number of portfolios</span></span>
<span id="cb57-108"><a href="#cb57-108" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(wide.columns) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb57-109"><a href="#cb57-109" aria-hidden="true" tabindex="-1"></a>    wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_cols <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb57-110"><a href="#cb57-110" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"winners"</span>] <span class="op">=</span> wide[<span class="ss">f"port</span><span class="sc">{</span>n_cols<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb57-111"><a href="#cb57-111" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"losers"</span>] <span class="op">=</span> wide[<span class="st">"port1"</span>]</span>
<span id="cb57-112"><a href="#cb57-112" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"long_short"</span>] <span class="op">=</span> wide[<span class="st">"winners"</span>] <span class="op">-</span> wide[<span class="st">"losers"</span>]</span>
<span id="cb57-113"><a href="#cb57-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-114"><a href="#cb57-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_ret, wide</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="c629974a" class="cell" data-execution_count="42">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run value-weighted J=6, K=6 strategy</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>_, vw_results <span class="op">=</span> momentum_strategy_vw(prices_clean, J<span class="op">=</span><span class="dv">6</span>, K<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Value-Weighted Momentum Strategy (J=6, K=6)"</span>)</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio Statistics:"</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vw_results[[<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Value-Weighted Momentum Strategy (J=6, K=6)
==================================================

Portfolio Statistics:
        winners    losers  long_short
count  161.0000  161.0000    161.0000
mean    -0.0129    0.0006     -0.0135
std      0.0763    0.0713      0.0653
min     -0.2519   -0.2178     -0.3813
25%     -0.0540   -0.0397     -0.0465
50%     -0.0067    0.0010     -0.0126
75%      0.0354    0.0443      0.0173
max      0.1765    0.2498      0.2498</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> []</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> scheme, df <span class="kw">in</span> [(<span class="st">"EW"</span>, ewret_wide), (<span class="st">"VW"</span>, vw_results)]:</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> df[col].dropna()</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        std_ret <span class="op">=</span> series.std()</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n))</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>        comparison.append({</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Weighting"</span>: scheme,</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Portfolio"</span>: col.replace(<span class="st">"_"</span>, <span class="st">" "</span>).title(),</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Mean (%)"</span>: <span class="bu">round</span>(mean_ret <span class="op">*</span> <span class="dv">100</span>, <span class="dv">4</span>),</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Std (%)"</span>: <span class="bu">round</span>(std_ret <span class="op">*</span> <span class="dv">100</span>, <span class="dv">4</span>),</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"t-stat"</span>: <span class="bu">round</span>(t_stat, <span class="dv">2</span>),</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"p-value"</span>: <span class="bu">round</span>(p_val, <span class="dv">4</span>)</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(comparison)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-ew-vs-vw" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="43">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.10: Comparison of equally weighted (EW) and value-weighted (VW) momentum strategies for J=6, K=6. The table reports mean monthly returns, t-statistics, and p-values for winners, losers, and long-short portfolios under both weighting schemes.
</figcaption>
<div aria-describedby="tbl-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="42">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Weighting</th>
<th data-quarto-table-cell-role="th">Portfolio</th>
<th data-quarto-table-cell-role="th">Mean (%)</th>
<th data-quarto-table-cell-role="th">Std (%)</th>
<th data-quarto-table-cell-role="th">t-stat</th>
<th data-quarto-table-cell-role="th">p-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>EW</td>
<td>Winners</td>
<td>-0.6812</td>
<td>5.7131</td>
<td>-1.51</td>
<td>0.1323</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>EW</td>
<td>Losers</td>
<td>1.4190</td>
<td>6.5319</td>
<td>2.76</td>
<td>0.0065</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>EW</td>
<td>Long Short</td>
<td>-2.1002</td>
<td>4.8969</td>
<td>-5.44</td>
<td>0.0000</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>VW</td>
<td>Winners</td>
<td>-1.2943</td>
<td>7.6274</td>
<td>-2.15</td>
<td>0.0328</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>VW</td>
<td>Losers</td>
<td>0.0589</td>
<td>7.1275</td>
<td>0.10</td>
<td>0.9166</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>VW</td>
<td>Long Short</td>
<td>-1.3533</td>
<td>6.5312</td>
<td>-2.63</td>
<td>0.0094</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
<div id="cell-fig-ew-vs-vw" class="cell" data-execution_count="44">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>vw_results <span class="op">=</span> vw_results.sort_values(<span class="st">"date"</span>)</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>vw_results[<span class="st">"cumret_ls_vw"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> vw_results[<span class="st">"long_short"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>ew_data <span class="op">=</span> (ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]]</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"cumret"</span>})</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>    .assign(scheme<span class="op">=</span><span class="st">"Equally Weighted"</span>)</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>ew_data[<span class="st">"cumret"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ew_data[<span class="st">"cumret"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>vw_data <span class="op">=</span> (vw_results[[<span class="st">"date"</span>, <span class="st">"cumret_ls_vw"</span>]]</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"cumret_ls_vw"</span>: <span class="st">"cumret"</span>})</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>    .assign(scheme<span class="op">=</span><span class="st">"Value Weighted"</span>)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>ew_vs_vw <span class="op">=</span> pd.concat([ew_data, vw_data], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>plot_ew_vw <span class="op">=</span> (</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>    ggplot(ew_vs_vw, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret"</span>, color<span class="op">=</span><span class="st">"scheme"</span>)) <span class="op">+</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a>    scale_color_manual(values<span class="op">=</span>[<span class="st">"#1f77b4"</span>, <span class="st">"#ff7f0e"</span>]) <span class="op">+</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Weighting Scheme"</span>,</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"EW vs. VW Momentum Long-Short Strategy"</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"bottom"</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>plot_ew_vw</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<div id="fig-ew-vs-vw" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart comparing the cumulative returns of EW and VW momentum long-short strategies over time.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-ew-vs-vw-output-1.png" alt="A line chart comparing the cumulative returns of EW and VW momentum long-short strategies over time." width="960" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.9: Cumulative returns of equally weighted (EW) versus value-weighted (VW) long-short momentum strategies. Differences between the two lines reflect the impact of firm size on momentum profitability.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="daily-momentum-analysis" class="level2" data-number="12.11">
<h2 data-number="12.11" class="anchored" data-anchor-id="daily-momentum-analysis"><span class="header-section-number">12.11</span> Daily Momentum Analysis</h2>
<p>While momentum strategies are typically evaluated at the monthly frequency following <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>, analyzing daily return patterns provides additional insights into the dynamics of momentum profits. Daily data allows us to examine how momentum profits accrue within the holding period, measure intra-month volatility of the strategy, and compute more precise risk measures.</p>
<section id="loading-daily-data" class="level3" data-number="12.11.1">
<h3 data-number="12.11.1" class="anchored" data-anchor-id="loading-daily-data"><span class="header-section-number">12.11.1</span> Loading Daily Data</h3>
<div id="7daf309e" class="cell" data-execution_count="45">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span>(<span class="st">"SELECT symbol, date, ret, ret_excess, mktcap_lag "</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>         <span class="st">"FROM prices_daily"</span>),</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_daily[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily observations: 3,462,157
Unique stocks: 1,459
Date range: 2010-01-05 to 2023-12-29</code></pre>
</div>
</div>
</section>
<section id="daily-returns-of-monthly-momentum-portfolios" class="level3" data-number="12.11.2">
<h3 data-number="12.11.2" class="anchored" data-anchor-id="daily-returns-of-monthly-momentum-portfolios"><span class="header-section-number">12.11.2</span> Daily Returns of Monthly Momentum Portfolios</h3>
<p>Rather than forming momentum portfolios at the daily frequency (which would require daily rebalancing and is impractical), we use the monthly portfolio assignments and track their daily returns. This gives us the daily return series of the monthly momentum strategy.</p>
<div id="e62d3271" class="cell" data-execution_count="46">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># # # Use the monthly portfolio assignments from the J=6 baseline</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>monthly_assignments <span class="op">=</span> portfolios_with_dates[</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with daily returns</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>daily_mom_returns <span class="op">=</span> monthly_assignments.merge(</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>    prices_daily[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"dret"</span>, <span class="st">"date"</span>: <span class="st">"ddate"</span>}</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Use boolean indexing instead of query</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>daily_mom_returns <span class="op">=</span> daily_mom_returns[</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>    (daily_mom_returns[<span class="st">"ddate"</span>] <span class="op">&gt;=</span> daily_mom_returns[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>    (daily_mom_returns[<span class="st">"ddate"</span>] <span class="op">&lt;=</span> daily_mom_returns[<span class="st">"hdate2"</span>])</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily portfolio return observations: </span><span class="sc">{</span><span class="bu">len</span>(daily_mom_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily portfolio return observations: 19,112,536</code></pre>
</div>
</div>
<div id="4364c55b" class="cell" data-execution_count="47">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily equally weighted portfolio returns</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 1: Average within each cohort</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>daily_cohort_ret <span class="op">=</span> (daily_mom_returns</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"ddate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    .agg(cohort_ret<span class="op">=</span>(<span class="st">"dret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 2: Average across cohorts</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>daily_ewret <span class="op">=</span> (daily_cohort_ret</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"ddate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    .agg(ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"ddate"</span>: <span class="st">"date"</span>})</span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily long-short returns</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_ewret.pivot(</span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>daily_wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"winners"</span>] <span class="op">=</span> daily_wide[<span class="st">"port10"</span>]</span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"losers"</span>] <span class="op">=</span> daily_wide[<span class="st">"port1"</span>]</span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"long_short"</span>] <span class="op">=</span> daily_wide[<span class="st">"winners"</span>] <span class="op">-</span> daily_wide[<span class="st">"losers"</span>]</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily long-short return observations: </span><span class="sc">{</span><span class="bu">len</span>(daily_wide)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily long-short return observations: 3,352</code></pre>
</div>
</div>
</section>
<section id="daily-cumulative-returns" class="level3" data-number="12.11.3">
<h3 data-number="12.11.3" class="anchored" data-anchor-id="daily-cumulative-returns"><span class="header-section-number">12.11.3</span> Daily Cumulative Returns</h3>
<div id="cell-fig-daily-cumret" class="cell" data-execution_count="48">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_wide.sort_values(<span class="st">"date"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"cumret_ls"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> daily_wide[<span class="st">"long_short"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>plot_daily_cumret <span class="op">=</span> (</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    ggplot(daily_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret_ls"</span>)) <span class="op">+</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"#2ca02c"</span>) <span class="op">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Daily Cumulative Return: Momentum Long-Short Strategy"</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>plot_daily_cumret</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<div id="fig-daily-cumret" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A line chart showing the cumulative daily returns of the momentum long-short strategy, with finer granularity than the monthly version.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-daily-cumret-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-daily-cumret-output-1.png" alt="A line chart showing the cumulative daily returns of the momentum long-short strategy, with finer granularity than the monthly version." width="960" height="576" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-daily-cumret-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.10: Cumulative daily returns of the momentum long-short strategy. This figure shows the same strategy as the monthly analysis but tracked at daily frequency, revealing intra-month dynamics and the precise timing of momentum gains and losses.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="annualized-risk-metrics-from-daily-data" class="level3" data-number="12.11.4">
<h3 data-number="12.11.4" class="anchored" data-anchor-id="annualized-risk-metrics-from-daily-data"><span class="header-section-number">12.11.4</span> Annualized Risk Metrics from Daily Data</h3>
<p>Daily data enables more precise estimation of risk metrics through higher-frequency sampling.</p>
<div class="cell" data-execution_count="49">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>daily_ls <span class="op">=</span> daily_wide[<span class="st">"long_short"</span>].dropna()</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Annualized metrics</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>ann_mean <span class="op">=</span> daily_ls.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>ann_vol <span class="op">=</span> daily_ls.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>sharpe <span class="op">=</span> ann_mean <span class="op">/</span> ann_vol <span class="cf">if</span> ann_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawdown</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>daily_wealth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> daily_ls).cumprod()</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>daily_running_max <span class="op">=</span> daily_wealth.cummax()</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>daily_dd <span class="op">=</span> (daily_wealth <span class="op">/</span> daily_running_max <span class="op">-</span> <span class="dv">1</span>).<span class="bu">min</span>()</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Higher moments</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>skew <span class="op">=</span> daily_ls.skew()</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>kurt <span class="op">=</span> daily_ls.kurtosis()</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a><span class="co"># VaR and CVaR</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>var_95 <span class="op">=</span> daily_ls.quantile(<span class="fl">0.05</span>)</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>cvar_95 <span class="op">=</span> daily_ls[daily_ls <span class="op">&lt;=</span> var_95].mean()</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a>risk_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Metric"</span>: [</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Annualized Mean Return"</span>,</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Annualized Volatility"</span>, </span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Sharpe Ratio"</span>,</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Maximum Drawdown"</span>,</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Skewness"</span>,</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Excess Kurtosis"</span>,</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Daily VaR (5%)"</span>,</span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Daily CVaR (5%)"</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>: [</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>ann_mean<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>ann_vol<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>sharpe<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>daily_dd<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>skew<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>kurt<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>var_95<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>cvar_95<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>risk_metrics</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="tbl-daily-risk" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="49">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-daily-risk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.11: Annualized risk metrics for the momentum long-short strategy computed from daily returns. Volatility is annualized using the square root of 252 rule. The Sharpe ratio, maximum drawdown, skewness, and kurtosis provide a comprehensive risk profile.
</figcaption>
<div aria-describedby="tbl-daily-risk-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="cell-output cell-output-display" data-execution_count="48">
<div>


<table class="dataframe do-not-create-environment cell caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Metric</th>
<th data-quarto-table-cell-role="th">Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>Annualized Mean Return</td>
<td>-26.90%</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>Annualized Volatility</td>
<td>15.01%</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>Sharpe Ratio</td>
<td>-1.79</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>Maximum Drawdown</td>
<td>-97.62%</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>Skewness</td>
<td>-11.23</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>Excess Kurtosis</td>
<td>378.11</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>Daily VaR (5%)</td>
<td>-1.33%</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>Daily CVaR (5%)</td>
<td>-2.10%</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</figure>
</div>
</div>
</section>
<section id="realized-volatility-of-momentum-returns" class="level3" data-number="12.11.5">
<h3 data-number="12.11.5" class="anchored" data-anchor-id="realized-volatility-of-momentum-returns"><span class="header-section-number">12.11.5</span> Realized Volatility of Momentum Returns</h3>
<p>Using daily returns, we can compute the monthly realized volatility of the momentum strategy and examine how it varies over time.</p>
<div id="cell-fig-realized-vol" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"year_month"</span>] <span class="op">=</span> daily_wide[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>realized_vol <span class="op">=</span> (daily_wide</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)[<span class="st">"long_short"</span>]</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"realized_vol"</span>})</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>realized_vol[<span class="st">"date"</span>] <span class="op">=</span> realized_vol[<span class="st">"year_month"</span>].dt.to_timestamp()</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>realized_vol[<span class="st">"realized_vol_ann"</span>] <span class="op">=</span> realized_vol[<span class="st">"realized_vol"</span>] <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a>plot_rvol <span class="op">=</span> (</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    ggplot(realized_vol, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"realized_vol_ann"</span>)) <span class="op">+</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#d62728"</span>, size<span class="op">=</span><span class="fl">0.8</span>) <span class="op">+</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Annualized Realized Volatility"</span>,</span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Realized Volatility of Momentum Strategy"</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>plot_rvol</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div id="fig-realized-vol" class="quarto-float quarto-figure quarto-figure-center anchored" alt="A time series chart of monthly realized volatility, showing spikes during periods of market stress.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-realized-vol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="13_momemtum_files/figure-html/fig-realized-vol-output-1.png" alt="A time series chart of monthly realized volatility, showing spikes during periods of market stress." width="960" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-realized-vol-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.11: Monthly realized volatility of the momentum long-short strategy, computed from daily returns within each month. Higher values indicate periods of greater uncertainty in momentum profits, often coinciding with market stress.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="saving-results-to-the-database" class="level2" data-number="12.12">
<h2 data-number="12.12" class="anchored" data-anchor-id="saving-results-to-the-database"><span class="header-section-number">12.12</span> Saving Results to the Database</h2>
<p>We save the momentum portfolio returns to our database for use in subsequent chapters, including factor model construction and portfolio optimization.</p>
<div id="c6fd892b" class="cell" data-execution_count="51">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Save monthly equally weighted momentum portfolio returns</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>ewret_to_save <span class="op">=</span> ewret[[<span class="st">"date"</span>, <span class="st">"momr"</span>, <span class="st">"ewret"</span>]].copy()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>ewret_to_save.to_sql(</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_portfolios_monthly"</span>,</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(ewret_to_save)<span class="sc">:,}</span><span class="ss"> monthly momentum portfolio observations."</span>)</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the long-short return series</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a>momentum_factor <span class="op">=</span> ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].dropna().copy()</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a>momentum_factor <span class="op">=</span> momentum_factor.rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"wml"</span>})</span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a>momentum_factor.to_sql(</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_factor_monthly"</span>,</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(momentum_factor)<span class="sc">:,}</span><span class="ss"> monthly WML factor observations."</span>)</span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the daily long-short return series</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor <span class="op">=</span> daily_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].dropna().copy()</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor <span class="op">=</span> daily_momentum_factor.rename(</span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"wml"</span>}</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor.to_sql(</span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_factor_daily"</span>,</span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(daily_momentum_factor)<span class="sc">:,}</span><span class="ss"> daily WML factor observations."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved 1,610 monthly momentum portfolio observations.
Saved 161 monthly WML factor observations.
Saved 3,352 daily WML factor observations.</code></pre>
</div>
</div>
</section>
<section id="practical-considerations" class="level2" data-number="12.13">
<h2 data-number="12.13" class="anchored" data-anchor-id="practical-considerations"><span class="header-section-number">12.13</span> Practical Considerations</h2>
<section id="transaction-costs" class="level3" data-number="12.13.1">
<h3 data-number="12.13.1" class="anchored" data-anchor-id="transaction-costs"><span class="header-section-number">12.13.1</span> Transaction Costs</h3>
<p>Momentum strategies involve substantial portfolio turnover, as stocks enter and exit the extreme decile portfolios each month. <span class="citation" data-cites="korajczyk2004momentum">Korajczyk and Sadka (<a href="references.html#ref-korajczyk2004momentum" role="doc-biblioref">2004</a>)</span> examine whether momentum profits survive transaction costs and find that profitability declines significantly for large institutional investors, though smaller portfolios can still capture meaningful returns.</p>
<p>In the Vietnamese market, transaction costs include:</p>
<ul>
<li><strong>Brokerage commissions</strong>: Typically 0.15%–0.25% of transaction value for institutional investors.</li>
<li><strong>Exchange fees</strong>: Approximately 0.03% per trade.</li>
<li><strong>Market impact</strong>: Particularly relevant for smaller, less liquid stocks that dominate the extreme momentum portfolios. Vietnam’s lower liquidity compared to developed markets may amplify this cost.</li>
<li><strong>Trading band limits</strong>: The <span class="math inline">\(\pm 7\%\)</span> daily price limit on HOSE can prevent immediate execution of trades, introducing tracking error relative to the theoretical portfolio.</li>
</ul>
</section>
<section id="implementation-lag" class="level3" data-number="12.13.2">
<h3 data-number="12.13.2" class="anchored" data-anchor-id="implementation-lag"><span class="header-section-number">12.13.2</span> Implementation Lag</h3>
<p>Our baseline implementation assumes that portfolios can be formed and rebalanced instantaneously at the end of each month. In practice, there is a lag between observing the formation period returns and executing the portfolio trades. The one-month gap between the formation period and the start of the holding period (<span class="citation" data-cites="jegadeesh1990evidence">Jegadeesh (<a href="references.html#ref-jegadeesh1990evidence" role="doc-biblioref">1990</a>)</span>) partially addresses this concern, but practitioners should consider additional implementation delays.</p>
</section>
<section id="survivorship-bias" class="level3" data-number="12.13.3">
<h3 data-number="12.13.3" class="anchored" data-anchor-id="survivorship-bias"><span class="header-section-number">12.13.3</span> Survivorship Bias</h3>
<p>Our dataset from DataCore includes both active and delisted stocks, which mitigates survivorship bias. However, the treatment of delisted stocks can affect momentum results. Stocks that are delisted during the holding period may generate extreme returns (both positive for acquisitions and negative for failures). We retain delisted returns as reported in the database, which is consistent with the treatment in <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>.</p>
</section>
<section id="small-sample-considerations" class="level3" data-number="12.13.4">
<h3 data-number="12.13.4" class="anchored" data-anchor-id="small-sample-considerations"><span class="header-section-number">12.13.4</span> Small Sample Considerations</h3>
<p>The Vietnamese stock market has a relatively short history compared to the U.S. market studied in <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>. Our sample spans approximately two decades, compared to the nearly three decades in the original study. This shorter sample period implies wider confidence intervals and greater sensitivity to specific episodes (such as the 2007–2009 financial crisis, which had a severe impact on Vietnamese equities). Results should be interpreted with this caveat in mind.</p>
</section>
</section>
<section id="key-takeaways" class="level2" data-number="12.14">
<h2 data-number="12.14" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">12.14</span> Key Takeaways</h2>
<p>This chapter has provided an implementation and analysis of momentum strategies in the Vietnamese equity market, following the methodology of <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span>. The main findings and methodological contributions are:</p>
<ol type="1">
<li><p><strong>Methodology</strong>: We implemented the full <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> overlapping portfolio methodology, including the two-stage averaging procedure (within-cohort, then across-cohort) that handles the <span class="math inline">\(K\)</span> active portfolios in each month.</p></li>
<li><p><strong>Baseline results</strong>: The <span class="math inline">\(J=6\)</span>, <span class="math inline">\(K=6\)</span> strategy provides a natural benchmark. The spread between winner and loser portfolios reveals whether cross-sectional momentum exists in Vietnamese equities.</p></li>
<li><p><strong>Robustness across horizons</strong>: By computing the full <span class="math inline">\(J \times K\)</span> grid with <span class="math inline">\(J, K \in \{3, 6, 9, 12\}\)</span>, we assessed whether the momentum premium is robust to the choice of formation and holding periods, following the approach in <span class="citation" data-cites="jegadeesh1993returns">Jegadeesh and Titman (<a href="references.html#ref-jegadeesh1993returns" role="doc-biblioref">1993</a>)</span> Table 1.</p></li>
<li><p><strong>Risk adjustment</strong>: CAPM and Fama-French three-factor alphas measure whether the momentum premium is explained by standard risk factors, building on the analysis in <span class="citation" data-cites="fama1996multifactor">Fama and French (<a href="references.html#ref-fama1996multifactor" role="doc-biblioref">1996</a>)</span> who show that their three-factor model fails to explain momentum.</p></li>
<li><p><strong>Market state dependence</strong>: Following <span class="citation" data-cites="cooper2004market">Cooper, Gutierrez Jr, and Hameed (<a href="references.html#ref-cooper2004market" role="doc-biblioref">2004</a>)</span>, we examined whether momentum profits vary with market conditions, which is particularly relevant in emerging markets with pronounced boom-bust cycles.</p></li>
<li><p><strong>Value weighting</strong>: The comparison of equally weighted and value-weighted strategies addresses practical implementability and isolates the role of firm size in driving momentum profits.</p></li>
<li><p><strong>Daily analysis</strong>: By tracking momentum portfolios at the daily frequency, we computed precise risk metrics including realized volatility, maximum drawdown, VaR, and CVaR, providing a complete risk profile of the strategy.</p></li>
<li><p><strong>Emerging market context</strong>: Throughout the analysis, we have highlighted features specific to the Vietnamese market—trading band limits, foreign ownership restrictions, shorter sample history, and higher transaction costs—that affect the interpretation and practical viability of momentum strategies.</p></li>
</ol>
<!-- ## Exercises

1.  **Skip-month momentum**: Modify the implementation to skip one month between the formation and holding periods (i.e., form portfolios based on months $t-J-1$ through $t-2$ rather than $t-J$ through $t-1$). Does this improve momentum profits by avoiding short-term reversal? Compare with the results in @jegadeesh1993returns.

2.  **Quintile portfolios**: Repeat the analysis using quintile (5-group) portfolios instead of deciles. How do the results change? In the Vietnamese market with fewer stocks, quintiles may produce more stable portfolios.

3.  **Exchange-specific momentum**: Separately analyze momentum on HOSE and HNX. Do the two exchanges exhibit different momentum patterns, potentially due to differences in liquidity, firm size, and investor composition?

4.  **Industry momentum**: Following @moskowitz1999industries, decompose stock-level momentum into an industry component and a stock-specific component. Assign each stock the equally weighted return of its industry group as the industry momentum signal. Is momentum in Vietnam primarily driven by industry rotation or stock selection?

5.  **Momentum and volume**: @lee2000price document an interaction between momentum and trading volume. Construct double-sorted portfolios based on past returns and past trading volume. Do high-volume winners outperform low-volume winners?

6.  **Seasonal patterns**: Examine whether momentum profits exhibit seasonal patterns. In the U.S., @jegadeesh1993returns document that January returns of momentum portfolios are particularly unusual. Does a similar pattern exist in the Vietnamese market, potentially around the Lunar New Year (Tết)?

7.  **Carhart four-factor model**: Using the WML factor saved to the database in this chapter, estimate the @carhart1997persistence four-factor model for the momentum portfolios. This adds the momentum factor to the Fama-French three-factor model: $r_{i,t} - r_{f,t} = \alpha_i + \beta_{1,i} \text{MKT}_t + \beta_{2,i} \text{SMB}_t + \beta_{3,i} \text{HML}_t + \beta_{4,i} \text{WML}_t + \epsilon_{i,t}$. -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-barberis1998model" class="csl-entry" role="listitem">
Barberis, Nicholas, Andrei Shleifer, and Robert Vishny. 1998. <span>“A Model of Investor Sentiment.”</span> <em>Journal of Financial Economics</em> 49 (3): 307–43.
</div>
<div id="ref-carhart1997persistence" class="csl-entry" role="listitem">
Carhart, Mark M. 1997. <span>“On Persistence in Mutual Fund Performance.”</span> <em>The Journal of Finance</em> 52 (1): 57–82.
</div>
<div id="ref-chan2000profitability" class="csl-entry" role="listitem">
Chan, Kalok, Allaudeen Hameed, and Wilson Tong. 2000. <span>“Profitability of Momentum Strategies in the International Equity Markets.”</span> <em>Journal of Financial and Quantitative Analysis</em>, 153–72.
</div>
<div id="ref-chui2010individualism" class="csl-entry" role="listitem">
Chui, Andy CW, Sheridan Titman, and KC John Wei. 2010. <span>“Individualism and Momentum Around the World.”</span> <em>The Journal of Finance</em> 65 (1): 361–92.
</div>
<div id="ref-cooper2004market" class="csl-entry" role="listitem">
Cooper, Michael J, Roberto C Gutierrez Jr, and Allaudeen Hameed. 2004. <span>“Market States and Momentum.”</span> <em>The Journal of Finance</em> 59 (3): 1345–65.
</div>
<div id="ref-daniel1998investor" class="csl-entry" role="listitem">
Daniel, Kent, David Hirshleifer, and Avanidhar Subrahmanyam. 1998. <span>“Investor Psychology and Security Market Under-and Overreactions.”</span> <em>The Journal of Finance</em> 53 (6): 1839–85.
</div>
<div id="ref-daniel2016momentum" class="csl-entry" role="listitem">
Daniel, Kent, and Tobias J Moskowitz. 2016. <span>“Momentum Crashes.”</span> <em>Journal of Financial Economics</em> 122 (2): 221–47.
</div>
<div id="ref-fama1996multifactor" class="csl-entry" role="listitem">
Fama, Eugene F, and Kenneth R French. 1996. <span>“Multifactor Explanations of Asset Pricing Anomalies.”</span> <em>The Journal of Finance</em> 51 (1): 55–84.
</div>
<div id="ref-grundy2001understanding" class="csl-entry" role="listitem">
Grundy, Bruce D, and J Spencer Martin Martin. 2001. <span>“Understanding the Nature of the Risks and the Source of the Rewards to Momentum Investing.”</span> <em>The Review of Financial Studies</em> 14 (1): 29–78.
</div>
<div id="ref-hofstede2001culture" class="csl-entry" role="listitem">
Hofstede, Geert. 2001. <span>“Culture’s Consequences: Comparing Values, Behaviors, Institutions and Organizations Across Nations.”</span> <em>International Educational and Professional</em>.
</div>
<div id="ref-hong1999unified" class="csl-entry" role="listitem">
Hong, Harrison, and Jeremy C Stein. 1999. <span>“A Unified Theory of Underreaction, Momentum Trading, and Overreaction in Asset Markets.”</span> <em>The Journal of Finance</em> 54 (6): 2143–84.
</div>
<div id="ref-jegadeesh1990evidence" class="csl-entry" role="listitem">
Jegadeesh, Narasimhan. 1990. <span>“Evidence of Predictable Behavior of Security Returns.”</span> <em>The Journal of Finance</em> 45 (3): 881–98.
</div>
<div id="ref-jegadeesh1993returns" class="csl-entry" role="listitem">
Jegadeesh, Narasimhan, and Sheridan Titman. 1993. <span>“Returns to Buying Winners and Selling Losers: Implications for Stock Market Efficiency.”</span> <em>The Journal of Finance</em> 48 (1): 65–91.
</div>
<div id="ref-johnson2002rational" class="csl-entry" role="listitem">
Johnson, Timothy C. 2002. <span>“Rational Momentum Effects.”</span> <em>The Journal of Finance</em> 57 (2): 585–608.
</div>
<div id="ref-korajczyk2004momentum" class="csl-entry" role="listitem">
Korajczyk, Robert A, and Ronnie Sadka. 2004. <span>“Are Momentum Profits Robust to Trading Costs?”</span> <em>The Journal of Finance</em> 59 (3): 1039–82.
</div>
<div id="ref-lesmond2004illusory" class="csl-entry" role="listitem">
Lesmond, David A, Michael J Schill, and Chunsheng Zhou. 2004. <span>“The Illusory Nature of Momentum Profits.”</span> <em>Journal of Financial Economics</em> 71 (2): 349–80.
</div>
<div id="ref-rouwenhorst1998international" class="csl-entry" role="listitem">
Rouwenhorst, K Geert. 1998. <span>“International Momentum Strategies.”</span> <em>The Journal of Finance</em> 53 (1): 267–84.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./12_fama_french.html" class="pagination-link" aria-label="Fama-French Factors">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./14_fama_macbeth.html" class="pagination-link" aria-label="Fama-MacBeth Regressions">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Momentum Strategies</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>Momentum is one of the most robust and pervasive anomalies in financial economics. Stocks that have performed well over the past three to twelve months tend to continue performing well over the subsequent three to twelve months, and stocks that have performed poorly tend to continue underperforming. This pattern, first documented by @jegadeesh1993returns, has been replicated across virtually every equity market, asset class, and time period examined, earning it a central place in the canon of empirical asset pricing.</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>In this chapter, we provide an implementation of momentum strategies following the methodology of @jegadeesh1993returns. We construct momentum portfolios based on past cumulative returns, evaluate their performance across different formation and holding period combinations, and examine whether the momentum premium exists in the Vietnamese equity market..</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="fu">## Theoretical Background</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Momentum Effect</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>The momentum effect refers to the tendency of assets with high recent returns to continue generating high returns, and assets with low recent returns to continue generating low returns. More formally, if we define the cumulative return of stock $i$ over the past $J$ months as</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>R_{i,t-J:t-1} = \prod_{s=t-J}^{t-1} (1 + r_{i,s}) - 1</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cumret}</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>then momentum predicts a positive cross-sectional relationship between $R_{i,t-J:t-1}$ and future returns $r_{i,t}$. That is, stocks in the top decile of past returns (winners) should outperform stocks in the bottom decile (losers) in subsequent months.</span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>The @jegadeesh1993returns framework parameterizes momentum strategies by two key dimensions:</span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Formation period** ($J$): The number of months over which past returns are computed to rank stocks. Typical values range from 3 to 12 months.</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Holding period** ($K$): The number of months for which the momentum portfolios are held after formation. Typical values also range from 3 to 12 months.</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>A strategy is therefore characterized by the pair $(J, K)$. For example, a $(6, 6)$ strategy ranks stocks based on their cumulative returns over the past 6 months and holds the resulting portfolios for 6 months.</span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a><span class="fu">### Overlapping Portfolios and Calendar-Time Returns</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>A critical implementation detail in @jegadeesh1993returns is the use of overlapping portfolios. In each month $t$, a new set of portfolios is formed based on the most recent $J$-month returns. However, portfolios formed in months $t-1$, $t-2$, $\ldots$, $t-K+1$ are still within their holding periods and therefore remain active. The return of the momentum strategy in month $t$ is thus the equally weighted average across all $K$ active cohorts:</span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>r_{p,t} = \frac{1}{K} \sum_{k=0}^{K-1} r_{p,t}^{(t-k)}</span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>$$ {#eq-overlapping}</span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>where $r_{p,t}^{(t-k)}$ denotes the return in month $t$ of the portfolio formed in month $t-k$. This overlapping portfolio approach serves two purposes. First, it reduces the impact of any single formation date on the strategy's performance. Second, it produces a monthly return series that can be analyzed using standard time-series methods, even when the holding period $K$ exceeds one month.</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a><span class="fu">### Theoretical Explanations</span></span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>The academic literature offers two broad classes of explanations for the momentum effect.</span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Behavioral explanations** attribute momentum to systematic cognitive biases among investors. @daniel1998investor propose a model based on investor overconfidence and biased self-attribution: investors overweight private signals and attribute confirming outcomes to their own skill, leading to initial underreaction followed by delayed overreaction. @hong1999unified develop a model in which information diffuses gradually across heterogeneous investors, generating underreaction to firm-specific news. @barberis1998model formalize a model combining conservatism bias (slow updating of beliefs in response to new evidence) and representativeness heuristic (extrapolation of recent trends).</span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Risk-based explanations** argue that momentum profits represent compensation for systematic risk that varies over time. @johnson2002rational show that momentum can arise in a rational framework if expected returns are stochastic and time-varying. @grundy2001understanding document that momentum portfolios have substantial time-varying factor exposures, suggesting that at least part of the momentum premium reflects dynamic risk. However, standard risk models such as the Fama-French three-factor model have generally struggled to explain momentum returns, which motivated the development of explicit momentum factors such as the Winners-Minus-Losers (WML) factor in @carhart1997persistence.</span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a><span class="fu">### Momentum in Emerging Markets</span></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>The behavior of momentum in emerging markets differs substantially from developed markets, and understanding these differences is essential for interpreting our Vietnamese market results.</span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>@rouwenhorst1998international provides early evidence that momentum profits exist in European markets. @chan2000profitability extend the analysis to international equity markets and find that momentum profits are present in most developed markets but are weaker or absent in several Asian markets. @chui2010individualism offer a cultural explanation, documenting that momentum profits are positively related to a country's degree of individualism as measured by @hofstede2001culture. Countries with collectivist cultures, including many in East and Southeast Asia, tend to exhibit weaker momentum effects.</span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-49"><a href="#cb73-49" aria-hidden="true" tabindex="-1"></a>Several market microstructure features common in emerging markets may attenuate momentum:</span>
<span id="cb73-50"><a href="#cb73-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-51"><a href="#cb73-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Trading band limits** constrain daily price movements, potentially slowing the adjustment process that generates momentum. Vietnam's HOSE imposes a $\pm 7\%$ daily limit, while HNX allows $\pm 10\%$.</span>
<span id="cb73-52"><a href="#cb73-52" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Lower liquidity and higher transaction costs** can erode momentum profits, as documented by @lesmond2004illusory.</span>
<span id="cb73-53"><a href="#cb73-53" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Foreign ownership limits** segment the investor base, potentially altering the information diffusion dynamics that underlie momentum.</span>
<span id="cb73-54"><a href="#cb73-54" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Shorter market history** limits the statistical power available to detect the effect.</span>
<span id="cb73-55"><a href="#cb73-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-56"><a href="#cb73-56" aria-hidden="true" tabindex="-1"></a>These considerations motivate our careful empirical analysis of whether, and to what extent, momentum manifests in Vietnamese equities.</span>
<span id="cb73-57"><a href="#cb73-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-58"><a href="#cb73-58" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up the Environment</span></span>
<span id="cb73-59"><a href="#cb73-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-60"><a href="#cb73-60" aria-hidden="true" tabindex="-1"></a>We begin by loading the necessary Python packages. The core packages include <span class="in">`pandas`</span> for data manipulation, <span class="in">`numpy`</span> for numerical operations, and <span class="in">`sqlite3`</span> for database connectivity. We also import <span class="in">`plotnine`</span> for creating publication-quality figures and <span class="in">`scipy`</span> for statistical tests.</span>
<span id="cb73-61"><a href="#cb73-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-64"><a href="#cb73-64" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-65"><a href="#cb73-65" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-66"><a href="#cb73-66" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb73-67"><a href="#cb73-67" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb73-68"><a href="#cb73-68" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb73-69"><a href="#cb73-69" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb73-70"><a href="#cb73-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-71"><a href="#cb73-71" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb73-72"><a href="#cb73-72" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> comma_format, percent_format</span>
<span id="cb73-73"><a href="#cb73-73" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb73-74"><a href="#cb73-74" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-75"><a href="#cb73-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-76"><a href="#cb73-76" aria-hidden="true" tabindex="-1"></a>We connect to our SQLite database, which stores the cleaned datasets prepared in <span class="co">[</span><span class="ot">Accessing and Managing Financial Data</span><span class="co">](accessing-and-managing-financial-data.qmd)</span> and <span class="co">[</span><span class="ot">DataCore Data</span><span class="co">](datacore-data.qmd)</span>.</span>
<span id="cb73-77"><a href="#cb73-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-80"><a href="#cb73-80" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-81"><a href="#cb73-81" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(</span>
<span id="cb73-82"><a href="#cb73-82" aria-hidden="true" tabindex="-1"></a>    database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span></span>
<span id="cb73-83"><a href="#cb73-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-84"><a href="#cb73-84" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-85"><a href="#cb73-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-86"><a href="#cb73-86" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Preparation</span></span>
<span id="cb73-87"><a href="#cb73-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-88"><a href="#cb73-88" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Monthly Stock Returns</span></span>
<span id="cb73-89"><a href="#cb73-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-90"><a href="#cb73-90" aria-hidden="true" tabindex="-1"></a>We load the monthly stock price data from our database. The <span class="in">`prices_monthly`</span> table contains adjusted returns, market capitalizations, and other variables for all stocks listed on HOSE and HNX.</span>
<span id="cb73-91"><a href="#cb73-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-94"><a href="#cb73-94" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-95"><a href="#cb73-95" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-96"><a href="#cb73-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># can add "exchange" variable</span></span>
<span id="cb73-97"><a href="#cb73-97" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"""</span></span>
<span id="cb73-98"><a href="#cb73-98" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT symbol, date, ret, ret_excess, mktcap, mktcap_lag, risk_free</span></span>
<span id="cb73-99"><a href="#cb73-99" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM prices_monthly</span></span>
<span id="cb73-100"><a href="#cb73-100" aria-hidden="true" tabindex="-1"></a><span class="st">    """</span>,</span>
<span id="cb73-101"><a href="#cb73-101" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-102"><a href="#cb73-102" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb73-103"><a href="#cb73-103" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb73-104"><a href="#cb73-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-105"><a href="#cb73-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total monthly observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-106"><a href="#cb73-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_monthly[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-107"><a href="#cb73-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb73-108"><a href="#cb73-108" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>prices_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-109"><a href="#cb73-109" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-110"><a href="#cb73-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-111"><a href="#cb73-111" aria-hidden="true" tabindex="-1"></a><span class="fu">### Inspecting the Data</span></span>
<span id="cb73-112"><a href="#cb73-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-113"><a href="#cb73-113" aria-hidden="true" tabindex="-1"></a>Before proceeding with portfolio construction, we examine the key variables in our dataset. @tbl-data-summary presents the summary statistics for the main variables used in momentum portfolio construction.</span>
<span id="cb73-114"><a href="#cb73-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-117"><a href="#cb73-117" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-118"><a href="#cb73-118" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-data-summary</span></span>
<span id="cb73-119"><a href="#cb73-119" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Summary statistics for monthly stock return data. The table reports the count, mean, standard deviation, minimum, 25th percentile, median, 75th percentile, and maximum for monthly returns (ret), excess returns (ret_excess), and market capitalization (mktcap, in billion VND)."</span></span>
<span id="cb73-120"><a href="#cb73-120" aria-hidden="true" tabindex="-1"></a>summary_stats <span class="op">=</span> (prices_monthly</span>
<span id="cb73-121"><a href="#cb73-121" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"ret"</span>, <span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>]]</span>
<span id="cb73-122"><a href="#cb73-122" aria-hidden="true" tabindex="-1"></a>    .describe()</span>
<span id="cb73-123"><a href="#cb73-123" aria-hidden="true" tabindex="-1"></a>    .T</span>
<span id="cb73-124"><a href="#cb73-124" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb73-125"><a href="#cb73-125" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-126"><a href="#cb73-126" aria-hidden="true" tabindex="-1"></a>summary_stats</span>
<span id="cb73-127"><a href="#cb73-127" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-128"><a href="#cb73-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-129"><a href="#cb73-129" aria-hidden="true" tabindex="-1"></a>We also examine the cross-sectional distribution of stocks over time, which is important for understanding whether we have sufficient breadth for decile portfolio construction.</span>
<span id="cb73-130"><a href="#cb73-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-133"><a href="#cb73-133" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-134"><a href="#cb73-134" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-stock-count</span></span>
<span id="cb73-135"><a href="#cb73-135" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of stocks with available return data over time. The figure shows the monthly cross-section of stocks available for momentum portfolio construction. A minimum number of stocks is needed to form meaningful decile portfolios."</span></span>
<span id="cb73-136"><a href="#cb73-136" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart showing the number of stocks with available monthly returns over time, generally increasing from a small number in the early 2000s to several hundred in recent years."</span></span>
<span id="cb73-137"><a href="#cb73-137" aria-hidden="true" tabindex="-1"></a>stock_counts <span class="op">=</span> (prices_monthly</span>
<span id="cb73-138"><a href="#cb73-138" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"symbol"</span>]</span>
<span id="cb73-139"><a href="#cb73-139" aria-hidden="true" tabindex="-1"></a>    .nunique()</span>
<span id="cb73-140"><a href="#cb73-140" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-141"><a href="#cb73-141" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"symbol"</span>: <span class="st">"n_stocks"</span>})</span>
<span id="cb73-142"><a href="#cb73-142" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-143"><a href="#cb73-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-144"><a href="#cb73-144" aria-hidden="true" tabindex="-1"></a>plot_stock_counts <span class="op">=</span> (</span>
<span id="cb73-145"><a href="#cb73-145" aria-hidden="true" tabindex="-1"></a>    ggplot(stock_counts, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"n_stocks"</span>)) <span class="op">+</span></span>
<span id="cb73-146"><a href="#cb73-146" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#1f77b4"</span>) <span class="op">+</span></span>
<span id="cb73-147"><a href="#cb73-147" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-148"><a href="#cb73-148" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Number of stocks"</span>,</span>
<span id="cb73-149"><a href="#cb73-149" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cross-Sectional Breadth Over Time"</span></span>
<span id="cb73-150"><a href="#cb73-150" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-151"><a href="#cb73-151" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-152"><a href="#cb73-152" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb73-153"><a href="#cb73-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-154"><a href="#cb73-154" aria-hidden="true" tabindex="-1"></a>plot_stock_counts</span>
<span id="cb73-155"><a href="#cb73-155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-156"><a href="#cb73-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-157"><a href="#cb73-157" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Factor Data</span></span>
<span id="cb73-158"><a href="#cb73-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-159"><a href="#cb73-159" aria-hidden="true" tabindex="-1"></a>We also load the Fama-French factor returns for risk-adjusted performance evaluation. These factors were constructed in <span class="co">[</span><span class="ot">Fama-French Factors</span><span class="co">](fama-french-factors.qmd)</span>.</span>
<span id="cb73-160"><a href="#cb73-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-163"><a href="#cb73-163" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-164"><a href="#cb73-164" aria-hidden="true" tabindex="-1"></a>factors_ff3_monthly <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-165"><a href="#cb73-165" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span><span class="st">"SELECT date, mkt_excess, smb, hml, risk_free FROM factors_ff3_monthly"</span>,</span>
<span id="cb73-166"><a href="#cb73-166" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-167"><a href="#cb73-167" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb73-168"><a href="#cb73-168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-169"><a href="#cb73-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-170"><a href="#cb73-170" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Factor observations: </span><span class="sc">{</span><span class="bu">len</span>(factors_ff3_monthly)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-171"><a href="#cb73-171" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>factors_ff3_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb73-172"><a href="#cb73-172" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>factors_ff3_monthly[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-173"><a href="#cb73-173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-174"><a href="#cb73-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-175"><a href="#cb73-175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Quality Filters</span></span>
<span id="cb73-176"><a href="#cb73-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-177"><a href="#cb73-177" aria-hidden="true" tabindex="-1"></a>Momentum strategies require continuous return histories for the formation period. We apply several filters to ensure data quality:</span>
<span id="cb73-178"><a href="#cb73-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-179"><a href="#cb73-179" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Minimum price filter**: We exclude penny stocks with prices below 1,000 VND, which are subject to extreme microstructure noise.</span>
<span id="cb73-180"><a href="#cb73-180" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Return availability**: We require non-missing returns for the entire formation period.</span>
<span id="cb73-181"><a href="#cb73-181" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Market capitalization**: We require positive lagged market capitalization for portfolio weighting.</span>
<span id="cb73-182"><a href="#cb73-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-185"><a href="#cb73-185" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-186"><a href="#cb73-186" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter for stocks with positive market cap and non-missing returns</span></span>
<span id="cb73-187"><a href="#cb73-187" aria-hidden="true" tabindex="-1"></a>prices_clean <span class="op">=</span> (prices_monthly</span>
<span id="cb73-188"><a href="#cb73-188" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mktcap"</span>])</span>
<span id="cb73-189"><a href="#cb73-189" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"mktcap &gt; 0"</span>)</span>
<span id="cb73-190"><a href="#cb73-190" aria-hidden="true" tabindex="-1"></a>    .sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb73-191"><a href="#cb73-191" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-192"><a href="#cb73-192" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-193"><a href="#cb73-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-194"><a href="#cb73-194" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations after filtering: </span><span class="sc">{</span><span class="bu">len</span>(prices_clean)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-195"><a href="#cb73-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks after filtering: </span><span class="sc">{</span>prices_clean[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-196"><a href="#cb73-196" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-197"><a href="#cb73-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-198"><a href="#cb73-198" aria-hidden="true" tabindex="-1"></a><span class="fu">## Momentum Portfolio Construction</span></span>
<span id="cb73-199"><a href="#cb73-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-200"><a href="#cb73-200" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Formation Period Returns</span></span>
<span id="cb73-201"><a href="#cb73-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-202"><a href="#cb73-202" aria-hidden="true" tabindex="-1"></a>The first step in constructing momentum portfolios is to compute cumulative returns over the formation period. For a formation period of $J$ months, we compute the cumulative return for each stock $i$ at the end of month $t$ as specified in @eq-cumret.</span>
<span id="cb73-203"><a href="#cb73-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-204"><a href="#cb73-204" aria-hidden="true" tabindex="-1"></a>We implement this using a rolling product of gross returns. A key detail is that we require non-missing returns for all $J$ months in the formation window. If any monthly return is missing, the cumulative return is set to missing, and the stock is excluded from portfolio formation in that month.</span>
<span id="cb73-205"><a href="#cb73-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-208"><a href="#cb73-208" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-209"><a href="#cb73-209" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_formation_returns(data, J):</span>
<span id="cb73-210"><a href="#cb73-210" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-211"><a href="#cb73-211" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute J-month cumulative returns for momentum portfolio formation.</span></span>
<span id="cb73-212"><a href="#cb73-212" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-213"><a href="#cb73-213" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-214"><a href="#cb73-214" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-215"><a href="#cb73-215" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb73-216"><a href="#cb73-216" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel data with columns 'symbol', 'date', 'ret'.</span></span>
<span id="cb73-217"><a href="#cb73-217" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb73-218"><a href="#cb73-218" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period length in months (typically 3-12).</span></span>
<span id="cb73-219"><a href="#cb73-219" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-220"><a href="#cb73-220" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-221"><a href="#cb73-221" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-222"><a href="#cb73-222" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-223"><a href="#cb73-223" aria-hidden="true" tabindex="-1"></a><span class="co">        Original data augmented with 'cum_return' column.</span></span>
<span id="cb73-224"><a href="#cb73-224" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-225"><a href="#cb73-225" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb73-226"><a href="#cb73-226" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-227"><a href="#cb73-227" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute rolling J-month cumulative return</span></span>
<span id="cb73-228"><a href="#cb73-228" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Using gross returns: (1+r1)*(1+r2)*...*(1+rJ) - 1</span></span>
<span id="cb73-229"><a href="#cb73-229" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb73-230"><a href="#cb73-230" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-231"><a href="#cb73-231" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb73-232"><a href="#cb73-232" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb73-233"><a href="#cb73-233" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb73-234"><a href="#cb73-234" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-235"><a href="#cb73-235" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-236"><a href="#cb73-236" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-237"><a href="#cb73-237" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-238"><a href="#cb73-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-239"><a href="#cb73-239" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>])</span>
<span id="cb73-240"><a href="#cb73-240" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-241"><a href="#cb73-241" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb73-242"><a href="#cb73-242" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-243"><a href="#cb73-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-244"><a href="#cb73-244" aria-hidden="true" tabindex="-1"></a>Let us apply this function for our baseline case with $J = 6$ months:</span>
<span id="cb73-245"><a href="#cb73-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-248"><a href="#cb73-248" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-249"><a href="#cb73-249" aria-hidden="true" tabindex="-1"></a>J <span class="op">=</span> <span class="dv">6</span>  <span class="co"># Formation period: 6 months</span></span>
<span id="cb73-250"><a href="#cb73-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-251"><a href="#cb73-251" aria-hidden="true" tabindex="-1"></a>prices_with_cumret <span class="op">=</span> compute_formation_returns(prices_clean, J)</span>
<span id="cb73-252"><a href="#cb73-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-253"><a href="#cb73-253" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the result</span></span>
<span id="cb73-254"><a href="#cb73-254" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations with valid </span><span class="sc">{</span>J<span class="sc">}</span><span class="ss">-month cumulative returns: "</span></span>
<span id="cb73-255"><a href="#cb73-255" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>prices_with_cumret[<span class="st">'cum_return'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-256"><a href="#cb73-256" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Cumulative return distribution:"</span>)</span>
<span id="cb73-257"><a href="#cb73-257" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_with_cumret[<span class="st">"cum_return"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-258"><a href="#cb73-258" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-259"><a href="#cb73-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-260"><a href="#cb73-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### Assigning Momentum Decile Portfolios</span></span>
<span id="cb73-261"><a href="#cb73-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-262"><a href="#cb73-262" aria-hidden="true" tabindex="-1"></a>Each month, we sort all stocks with valid cumulative returns into decile portfolios based on their past $J$-month performance. Portfolio 1 contains the bottom decile (losers) and portfolio 10 contains the top decile (winners).</span>
<span id="cb73-263"><a href="#cb73-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-266"><a href="#cb73-266" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-267"><a href="#cb73-267" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> assign_momentum_portfolios(data, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb73-268"><a href="#cb73-268" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-269"><a href="#cb73-269" aria-hidden="true" tabindex="-1"></a><span class="co">    Assign stocks to momentum portfolios based on formation-period returns.</span></span>
<span id="cb73-270"><a href="#cb73-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-271"><a href="#cb73-271" aria-hidden="true" tabindex="-1"></a><span class="co">    For each cross-section (month), stocks are sorted into </span></span>
<span id="cb73-272"><a href="#cb73-272" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios quantile groups according to their cumulative return.</span></span>
<span id="cb73-273"><a href="#cb73-273" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-274"><a href="#cb73-274" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolio 1 = lowest past returns (Losers)</span></span>
<span id="cb73-275"><a href="#cb73-275" aria-hidden="true" tabindex="-1"></a><span class="co">    Portfolio n_portfolios = highest past returns (Winners)</span></span>
<span id="cb73-276"><a href="#cb73-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-277"><a href="#cb73-277" aria-hidden="true" tabindex="-1"></a><span class="co">    This implementation uses `groupby().transform()` rather than </span></span>
<span id="cb73-278"><a href="#cb73-278" aria-hidden="true" tabindex="-1"></a><span class="co">    `groupby().apply()` to preserve the original DataFrame structure </span></span>
<span id="cb73-279"><a href="#cb73-279" aria-hidden="true" tabindex="-1"></a><span class="co">    and avoid index mutation issues.</span></span>
<span id="cb73-280"><a href="#cb73-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-281"><a href="#cb73-281" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-282"><a href="#cb73-282" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-283"><a href="#cb73-283" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb73-284"><a href="#cb73-284" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel data containing at minimum:</span></span>
<span id="cb73-285"><a href="#cb73-285" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'symbol' : stock identifier</span></span>
<span id="cb73-286"><a href="#cb73-286" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'date' : formation month</span></span>
<span id="cb73-287"><a href="#cb73-287" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'cum_return' : cumulative return over formation window</span></span>
<span id="cb73-288"><a href="#cb73-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-289"><a href="#cb73-289" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int, optional</span></span>
<span id="cb73-290"><a href="#cb73-290" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios to form (default = 10 for deciles).</span></span>
<span id="cb73-291"><a href="#cb73-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-292"><a href="#cb73-292" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-293"><a href="#cb73-293" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-294"><a href="#cb73-294" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-295"><a href="#cb73-295" aria-hidden="true" tabindex="-1"></a><span class="co">        Original data augmented with:</span></span>
<span id="cb73-296"><a href="#cb73-296" aria-hidden="true" tabindex="-1"></a><span class="co">        - 'momr' : integer momentum rank (1 to n_portfolios)</span></span>
<span id="cb73-297"><a href="#cb73-297" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-298"><a href="#cb73-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-299"><a href="#cb73-299" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop observations without formation-period returns</span></span>
<span id="cb73-300"><a href="#cb73-300" aria-hidden="true" tabindex="-1"></a>    <span class="co"># These cannot be ranked into portfolios</span></span>
<span id="cb73-301"><a href="#cb73-301" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>]).copy()</span>
<span id="cb73-302"><a href="#cb73-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-303"><a href="#cb73-303" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> safe_qcut(x):</span>
<span id="cb73-304"><a href="#cb73-304" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb73-305"><a href="#cb73-305" aria-hidden="true" tabindex="-1"></a><span class="co">        Assign quantile portfolio labels within a single cross-section.</span></span>
<span id="cb73-306"><a href="#cb73-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-307"><a href="#cb73-307" aria-hidden="true" tabindex="-1"></a><span class="co">        Uses pd.qcut to create approximately equal-sized portfolios.</span></span>
<span id="cb73-308"><a href="#cb73-308" aria-hidden="true" tabindex="-1"></a><span class="co">        If too few unique return values exist (which can happen in </span></span>
<span id="cb73-309"><a href="#cb73-309" aria-hidden="true" tabindex="-1"></a><span class="co">        small markets or illiquid samples), fall back to rank-based </span></span>
<span id="cb73-310"><a href="#cb73-310" aria-hidden="true" tabindex="-1"></a><span class="co">        binning to ensure portfolios are still formed.</span></span>
<span id="cb73-311"><a href="#cb73-311" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb73-312"><a href="#cb73-312" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb73-313"><a href="#cb73-313" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Standard quantile sorting</span></span>
<span id="cb73-314"><a href="#cb73-314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.qcut(</span>
<span id="cb73-315"><a href="#cb73-315" aria-hidden="true" tabindex="-1"></a>                x,</span>
<span id="cb73-316"><a href="#cb73-316" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span>n_portfolios,</span>
<span id="cb73-317"><a href="#cb73-317" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb73-318"><a href="#cb73-318" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span>  <span class="co"># prevents crash if quantile edges duplicate</span></span>
<span id="cb73-319"><a href="#cb73-319" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-320"><a href="#cb73-320" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb73-321"><a href="#cb73-321" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Fallback: rank then evenly cut into bins</span></span>
<span id="cb73-322"><a href="#cb73-322" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.cut(</span>
<span id="cb73-323"><a href="#cb73-323" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb73-324"><a href="#cb73-324" aria-hidden="true" tabindex="-1"></a>                bins<span class="op">=</span>n_portfolios,</span>
<span id="cb73-325"><a href="#cb73-325" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb73-326"><a href="#cb73-326" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-327"><a href="#cb73-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-328"><a href="#cb73-328" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cross-sectional portfolio assignment:</span></span>
<span id="cb73-329"><a href="#cb73-329" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each month, compute portfolio ranks based on cum_return.</span></span>
<span id="cb73-330"><a href="#cb73-330" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transform ensures:</span></span>
<span id="cb73-331"><a href="#cb73-331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - original row order preserved</span></span>
<span id="cb73-332"><a href="#cb73-332" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - no index mutation</span></span>
<span id="cb73-333"><a href="#cb73-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># - no loss of 'date' column</span></span>
<span id="cb73-334"><a href="#cb73-334" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> (</span>
<span id="cb73-335"><a href="#cb73-335" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>]</span>
<span id="cb73-336"><a href="#cb73-336" aria-hidden="true" tabindex="-1"></a>          .transform(safe_qcut)</span>
<span id="cb73-337"><a href="#cb73-337" aria-hidden="true" tabindex="-1"></a>          .astype(<span class="bu">int</span>)</span>
<span id="cb73-338"><a href="#cb73-338" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-339"><a href="#cb73-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-340"><a href="#cb73-340" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb73-341"><a href="#cb73-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-342"><a href="#cb73-342" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-343"><a href="#cb73-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-346"><a href="#cb73-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-347"><a href="#cb73-347" aria-hidden="true" tabindex="-1"></a>portfolios <span class="op">=</span> assign_momentum_portfolios(prices_with_cumret)</span>
<span id="cb73-348"><a href="#cb73-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-349"><a href="#cb73-349" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stocks assigned to portfolios: </span><span class="sc">{</span><span class="bu">len</span>(portfolios)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-350"><a href="#cb73-350" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Portfolio distribution (should be approximately equal):"</span>)</span>
<span id="cb73-351"><a href="#cb73-351" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios.groupby(<span class="st">"momr"</span>)[<span class="st">"symbol"</span>].count().to_frame(<span class="st">"count"</span>))</span>
<span id="cb73-352"><a href="#cb73-352" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-353"><a href="#cb73-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-354"><a href="#cb73-354" aria-hidden="true" tabindex="-1"></a><span class="fu">### Defining Holding Period Dates</span></span>
<span id="cb73-355"><a href="#cb73-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-356"><a href="#cb73-356" aria-hidden="true" tabindex="-1"></a>After forming portfolios at the end of month $t$, we hold them from the beginning of month $t+1$ through the end of month $t+K$. This one-month gap between the formation period and the start of the holding period is standard in the literature and avoids the well-documented short-term reversal effect at the one-month horizon <span class="co">[</span><span class="ot">@jegadeesh1990evidence</span><span class="co">]</span>.</span>
<span id="cb73-357"><a href="#cb73-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-360"><a href="#cb73-360" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-361"><a href="#cb73-361" aria-hidden="true" tabindex="-1"></a>K <span class="op">=</span> <span class="dv">6</span>  <span class="co"># Holding period: 6 months</span></span>
<span id="cb73-362"><a href="#cb73-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-363"><a href="#cb73-363" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates <span class="op">=</span> portfolios.copy()</span>
<span id="cb73-364"><a href="#cb73-364" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates <span class="op">=</span> portfolios_with_dates.rename(</span>
<span id="cb73-365"><a href="#cb73-365" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>}</span>
<span id="cb73-366"><a href="#cb73-366" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-367"><a href="#cb73-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-368"><a href="#cb73-368" aria-hidden="true" tabindex="-1"></a><span class="co"># Define holding period start and end dates</span></span>
<span id="cb73-369"><a href="#cb73-369" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates[<span class="st">"hdate1"</span>] <span class="op">=</span> (</span>
<span id="cb73-370"><a href="#cb73-370" aria-hidden="true" tabindex="-1"></a>    portfolios_with_dates[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb73-371"><a href="#cb73-371" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-372"><a href="#cb73-372" aria-hidden="true" tabindex="-1"></a>portfolios_with_dates[<span class="st">"hdate2"</span>] <span class="op">=</span> (</span>
<span id="cb73-373"><a href="#cb73-373" aria-hidden="true" tabindex="-1"></a>    portfolios_with_dates[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb73-374"><a href="#cb73-374" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-375"><a href="#cb73-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-376"><a href="#cb73-376" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolios_with_dates[</span>
<span id="cb73-377"><a href="#cb73-377" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"cum_return"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb73-378"><a href="#cb73-378" aria-hidden="true" tabindex="-1"></a>].head(<span class="dv">10</span>))</span>
<span id="cb73-379"><a href="#cb73-379" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-380"><a href="#cb73-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-381"><a href="#cb73-381" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Portfolio Holding Period Returns</span></span>
<span id="cb73-382"><a href="#cb73-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-383"><a href="#cb73-383" aria-hidden="true" tabindex="-1"></a>We now compute the returns of each portfolio during its holding period. For each stock-formation date combination, we merge in the actual returns realized during the holding window. This produces a panel of stock returns indexed by formation date, holding date, and momentum portfolio rank.</span>
<span id="cb73-384"><a href="#cb73-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-387"><a href="#cb73-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-388"><a href="#cb73-388" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge: for each portfolio assignment, get all returns during holding period</span></span>
<span id="cb73-389"><a href="#cb73-389" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> portfolios_with_dates.merge(</span>
<span id="cb73-390"><a href="#cb73-390" aria-hidden="true" tabindex="-1"></a>    prices_clean[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb73-391"><a href="#cb73-391" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb73-392"><a href="#cb73-392" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-393"><a href="#cb73-393" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb73-394"><a href="#cb73-394" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-395"><a href="#cb73-395" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-396"><a href="#cb73-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-397"><a href="#cb73-397" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only returns within the holding period</span></span>
<span id="cb73-398"><a href="#cb73-398" aria-hidden="true" tabindex="-1"></a>portfolio_returns <span class="op">=</span> portfolio_returns.query(</span>
<span id="cb73-399"><a href="#cb73-399" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hdate &gt;= hdate1 and hdate &lt;= hdate2"</span></span>
<span id="cb73-400"><a href="#cb73-400" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-401"><a href="#cb73-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-402"><a href="#cb73-402" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Portfolio-holding period observations: </span><span class="sc">{</span><span class="bu">len</span>(portfolio_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-403"><a href="#cb73-403" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-404"><a href="#cb73-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-405"><a href="#cb73-405" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Equally Weighted Portfolio Returns</span></span>
<span id="cb73-406"><a href="#cb73-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-407"><a href="#cb73-407" aria-hidden="true" tabindex="-1"></a>The @jegadeesh1993returns methodology uses equally weighted portfolios. For each holding month, each momentum decile has $K$ active cohorts (one formed in each of the past $K$ months). We first compute the equally weighted return within each cohort, then average across cohorts to get the final monthly portfolio return.</span>
<span id="cb73-408"><a href="#cb73-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-411"><a href="#cb73-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-412"><a href="#cb73-412" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Average return within each cohort (form_date × momr × hdate)</span></span>
<span id="cb73-413"><a href="#cb73-413" aria-hidden="true" tabindex="-1"></a>cohort_returns <span class="op">=</span> (portfolio_returns</span>
<span id="cb73-414"><a href="#cb73-414" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb73-415"><a href="#cb73-415" aria-hidden="true" tabindex="-1"></a>    .agg(cohort_ret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-416"><a href="#cb73-416" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-417"><a href="#cb73-417" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-418"><a href="#cb73-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-419"><a href="#cb73-419" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Average across cohorts for each momentum portfolio × month</span></span>
<span id="cb73-420"><a href="#cb73-420" aria-hidden="true" tabindex="-1"></a>ewret <span class="op">=</span> (cohort_returns</span>
<span id="cb73-421"><a href="#cb73-421" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb73-422"><a href="#cb73-422" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb73-423"><a href="#cb73-423" aria-hidden="true" tabindex="-1"></a>        ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>),</span>
<span id="cb73-424"><a href="#cb73-424" aria-hidden="true" tabindex="-1"></a>        ewret_std<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"std"</span>),</span>
<span id="cb73-425"><a href="#cb73-425" aria-hidden="true" tabindex="-1"></a>        n_cohorts<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"count"</span>)</span>
<span id="cb73-426"><a href="#cb73-426" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-427"><a href="#cb73-427" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-428"><a href="#cb73-428" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb73-429"><a href="#cb73-429" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-430"><a href="#cb73-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-431"><a href="#cb73-431" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly portfolio return observations: </span><span class="sc">{</span><span class="bu">len</span>(ewret)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-432"><a href="#cb73-432" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>ewret[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>ewret[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-433"><a href="#cb73-433" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-434"><a href="#cb73-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-435"><a href="#cb73-435" aria-hidden="true" tabindex="-1"></a>We should verify that we have the expected number of active cohorts per month. Once the strategy has been running for at least $K$ months, each momentum decile should have exactly $K$ active cohorts.</span>
<span id="cb73-436"><a href="#cb73-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-439"><a href="#cb73-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-440"><a href="#cb73-440" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cohort-count</span></span>
<span id="cb73-441"><a href="#cb73-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of active cohorts per momentum portfolio over time. After an initial ramp-up period of K months, each portfolio should have exactly K active cohorts contributing to its monthly return."</span></span>
<span id="cb73-442"><a href="#cb73-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart showing the number of active cohorts per momentum portfolio over time, ramping up from 1 to K during the initial months and then remaining stable at K."</span></span>
<span id="cb73-443"><a href="#cb73-443" aria-hidden="true" tabindex="-1"></a>cohort_check <span class="op">=</span> (ewret</span>
<span id="cb73-444"><a href="#cb73-444" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)[<span class="st">"n_cohorts"</span>]</span>
<span id="cb73-445"><a href="#cb73-445" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb73-446"><a href="#cb73-446" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-447"><a href="#cb73-447" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"n_cohorts"</span>: <span class="st">"avg_cohorts"</span>})</span>
<span id="cb73-448"><a href="#cb73-448" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-449"><a href="#cb73-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-450"><a href="#cb73-450" aria-hidden="true" tabindex="-1"></a>plot_cohorts <span class="op">=</span> (</span>
<span id="cb73-451"><a href="#cb73-451" aria-hidden="true" tabindex="-1"></a>    ggplot(cohort_check, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"avg_cohorts"</span>)) <span class="op">+</span></span>
<span id="cb73-452"><a href="#cb73-452" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#1f77b4"</span>) <span class="op">+</span></span>
<span id="cb73-453"><a href="#cb73-453" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span>K, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>) <span class="op">+</span></span>
<span id="cb73-454"><a href="#cb73-454" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-455"><a href="#cb73-455" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Average number of cohorts"</span>,</span>
<span id="cb73-456"><a href="#cb73-456" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="ss">f"Active Cohorts per Portfolio (K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">)"</span></span>
<span id="cb73-457"><a href="#cb73-457" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-458"><a href="#cb73-458" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-459"><a href="#cb73-459" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb73-460"><a href="#cb73-460" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-461"><a href="#cb73-461" aria-hidden="true" tabindex="-1"></a>plot_cohorts</span>
<span id="cb73-462"><a href="#cb73-462" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-463"><a href="#cb73-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-464"><a href="#cb73-464" aria-hidden="true" tabindex="-1"></a><span class="fu">## Baseline Results: J=6, K=6 Strategy</span></span>
<span id="cb73-465"><a href="#cb73-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-466"><a href="#cb73-466" aria-hidden="true" tabindex="-1"></a><span class="fu">### Summary Statistics by Momentum Decile</span></span>
<span id="cb73-467"><a href="#cb73-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-468"><a href="#cb73-468" aria-hidden="true" tabindex="-1"></a>We now examine the average monthly returns for each momentum decile portfolio. @tbl-momentum-deciles presents the mean, $t$-statistic, and $p$-value for each of the ten portfolios.</span>
<span id="cb73-469"><a href="#cb73-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-472"><a href="#cb73-472" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-473"><a href="#cb73-473" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-momentum-deciles</span></span>
<span id="cb73-474"><a href="#cb73-474" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Average monthly returns of momentum decile portfolios for the J=6, K=6 strategy. Portfolio 1 contains past losers and portfolio 10 contains past winners. The table reports the number of months, mean monthly return, t-statistic, and p-value for each decile."</span></span>
<span id="cb73-475"><a href="#cb73-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-476"><a href="#cb73-476" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_stats(group):</span>
<span id="cb73-477"><a href="#cb73-477" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute mean, t-stat, and p-value for a return series."""</span></span>
<span id="cb73-478"><a href="#cb73-478" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(group)</span>
<span id="cb73-479"><a href="#cb73-479" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> group.mean()</span>
<span id="cb73-480"><a href="#cb73-480" aria-hidden="true" tabindex="-1"></a>    std_ret <span class="op">=</span> group.std()</span>
<span id="cb73-481"><a href="#cb73-481" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb73-482"><a href="#cb73-482" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan</span>
<span id="cb73-483"><a href="#cb73-483" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series({</span>
<span id="cb73-484"><a href="#cb73-484" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N"</span>: n,</span>
<span id="cb73-485"><a href="#cb73-485" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mean (%)"</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb73-486"><a href="#cb73-486" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Std (%)"</span>: std_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb73-487"><a href="#cb73-487" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t-stat"</span>: t_stat,</span>
<span id="cb73-488"><a href="#cb73-488" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p-value"</span>: p_val</span>
<span id="cb73-489"><a href="#cb73-489" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb73-490"><a href="#cb73-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-491"><a href="#cb73-491" aria-hidden="true" tabindex="-1"></a>momentum_stats <span class="op">=</span> (ewret</span>
<span id="cb73-492"><a href="#cb73-492" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"momr"</span>)[<span class="st">"ewret"</span>]</span>
<span id="cb73-493"><a href="#cb73-493" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(compute_portfolio_stats)</span>
<span id="cb73-494"><a href="#cb73-494" aria-hidden="true" tabindex="-1"></a>    .unstack()</span>
<span id="cb73-495"><a href="#cb73-495" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb73-496"><a href="#cb73-496" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-497"><a href="#cb73-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-498"><a href="#cb73-498" aria-hidden="true" tabindex="-1"></a>momentum_stats</span>
<span id="cb73-499"><a href="#cb73-499" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-500"><a href="#cb73-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-501"><a href="#cb73-501" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Long-Short Momentum Portfolio</span></span>
<span id="cb73-502"><a href="#cb73-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-503"><a href="#cb73-503" aria-hidden="true" tabindex="-1"></a>The key test of the momentum effect is whether the spread between winners and losers—the long-short momentum portfolio—generates statistically significant positive returns. We construct this spread portfolio by going long the top decile (portfolio 10) and short the bottom decile (portfolio 1).</span>
<span id="cb73-504"><a href="#cb73-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-507"><a href="#cb73-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-508"><a href="#cb73-508" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot to wide format</span></span>
<span id="cb73-509"><a href="#cb73-509" aria-hidden="true" tabindex="-1"></a>ewret_wide <span class="op">=</span> ewret.pivot(</span>
<span id="cb73-510"><a href="#cb73-510" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb73-511"><a href="#cb73-511" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb73-512"><a href="#cb73-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-513"><a href="#cb73-513" aria-hidden="true" tabindex="-1"></a>ewret_wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb73-514"><a href="#cb73-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-515"><a href="#cb73-515" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute long-short return</span></span>
<span id="cb73-516"><a href="#cb73-516" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"winners"</span>] <span class="op">=</span> ewret_wide[<span class="st">"port10"</span>]</span>
<span id="cb73-517"><a href="#cb73-517" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"losers"</span>] <span class="op">=</span> ewret_wide[<span class="st">"port1"</span>]</span>
<span id="cb73-518"><a href="#cb73-518" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"long_short"</span>] <span class="op">=</span> ewret_wide[<span class="st">"winners"</span>] <span class="op">-</span> ewret_wide[<span class="st">"losers"</span>]</span>
<span id="cb73-519"><a href="#cb73-519" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-520"><a href="#cb73-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-523"><a href="#cb73-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-524"><a href="#cb73-524" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-long-short</span></span>
<span id="cb73-525"><a href="#cb73-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Performance of the momentum long-short strategy (J=6, K=6). Winners is the top decile, Losers is the bottom decile, and Long-Short is Winners minus Losers. The table reports the number of months, mean monthly return, t-statistic, and p-value."</span></span>
<span id="cb73-526"><a href="#cb73-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-527"><a href="#cb73-527" aria-hidden="true" tabindex="-1"></a>ls_stats <span class="op">=</span> pd.DataFrame()</span>
<span id="cb73-528"><a href="#cb73-528" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb73-529"><a href="#cb73-529" aria-hidden="true" tabindex="-1"></a>    series <span class="op">=</span> ewret_wide[col].dropna()</span>
<span id="cb73-530"><a href="#cb73-530" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb73-531"><a href="#cb73-531" aria-hidden="true" tabindex="-1"></a>    mean_val <span class="op">=</span> series.mean()</span>
<span id="cb73-532"><a href="#cb73-532" aria-hidden="true" tabindex="-1"></a>    std_val <span class="op">=</span> series.std()</span>
<span id="cb73-533"><a href="#cb73-533" aria-hidden="true" tabindex="-1"></a>    t_val <span class="op">=</span> mean_val <span class="op">/</span> (std_val <span class="op">/</span> np.sqrt(n))</span>
<span id="cb73-534"><a href="#cb73-534" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_val), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb73-535"><a href="#cb73-535" aria-hidden="true" tabindex="-1"></a>    ls_stats[col] <span class="op">=</span> [n, mean_val <span class="op">*</span> <span class="dv">100</span>, std_val <span class="op">*</span> <span class="dv">100</span>, t_val, p_val]</span>
<span id="cb73-536"><a href="#cb73-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-537"><a href="#cb73-537" aria-hidden="true" tabindex="-1"></a>ls_stats.index <span class="op">=</span> [<span class="st">"N"</span>, <span class="st">"Mean (%)"</span>, <span class="st">"Std (%)"</span>, <span class="st">"t-stat"</span>, <span class="st">"p-value"</span>]</span>
<span id="cb73-538"><a href="#cb73-538" aria-hidden="true" tabindex="-1"></a>ls_stats.columns <span class="op">=</span> [<span class="st">"Winners"</span>, <span class="st">"Losers"</span>, <span class="st">"Long-Short"</span>]</span>
<span id="cb73-539"><a href="#cb73-539" aria-hidden="true" tabindex="-1"></a>ls_stats <span class="op">=</span> ls_stats.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb73-540"><a href="#cb73-540" aria-hidden="true" tabindex="-1"></a>ls_stats</span>
<span id="cb73-541"><a href="#cb73-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-542"><a href="#cb73-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-543"><a href="#cb73-543" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cumulative Returns</span></span>
<span id="cb73-544"><a href="#cb73-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-545"><a href="#cb73-545" aria-hidden="true" tabindex="-1"></a>The time-series evolution of cumulative returns provides visual evidence of the momentum strategy's performance. @fig-cumret-winners-losers shows the cumulative returns of the winner and loser portfolios, while @fig-cumret-long-short shows the cumulative return of the long-short momentum strategy.</span>
<span id="cb73-546"><a href="#cb73-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-549"><a href="#cb73-549" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-550"><a href="#cb73-550" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cumulative returns</span></span>
<span id="cb73-551"><a href="#cb73-551" aria-hidden="true" tabindex="-1"></a>ewret_wide <span class="op">=</span> ewret_wide.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-552"><a href="#cb73-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-553"><a href="#cb73-553" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb73-554"><a href="#cb73-554" aria-hidden="true" tabindex="-1"></a>    ewret_wide[<span class="ss">f"cumret_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ewret_wide[col]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-555"><a href="#cb73-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-556"><a href="#cb73-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-559"><a href="#cb73-559" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-560"><a href="#cb73-560" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumret-winners-losers</span></span>
<span id="cb73-561"><a href="#cb73-561" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of momentum winner and loser portfolios. The winner portfolio (blue) contains stocks in the top decile of past 6-month returns, and the loser portfolio (red) contains stocks in the bottom decile. The spread between the two lines reflects the cumulative momentum premium."</span></span>
<span id="cb73-562"><a href="#cb73-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart showing cumulative returns of the winner and loser momentum portfolios over time. The winner portfolio generally accumulates higher returns than the loser portfolio, though both exhibit substantial variation."</span></span>
<span id="cb73-563"><a href="#cb73-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-564"><a href="#cb73-564" aria-hidden="true" tabindex="-1"></a>cumret_plot_data <span class="op">=</span> (ewret_wide</span>
<span id="cb73-565"><a href="#cb73-565" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"cumret_winners"</span>, <span class="st">"cumret_losers"</span>]]</span>
<span id="cb73-566"><a href="#cb73-566" aria-hidden="true" tabindex="-1"></a>    .melt(id_vars<span class="op">=</span><span class="st">"date"</span>, var_name<span class="op">=</span><span class="st">"portfolio"</span>, value_name<span class="op">=</span><span class="st">"cumret"</span>)</span>
<span id="cb73-567"><a href="#cb73-567" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-568"><a href="#cb73-568" aria-hidden="true" tabindex="-1"></a>cumret_plot_data[<span class="st">"portfolio"</span>] <span class="op">=</span> cumret_plot_data[<span class="st">"portfolio"</span>].<span class="bu">map</span>({</span>
<span id="cb73-569"><a href="#cb73-569" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cumret_winners"</span>: <span class="st">"Winners (P10)"</span>,</span>
<span id="cb73-570"><a href="#cb73-570" aria-hidden="true" tabindex="-1"></a>    <span class="st">"cumret_losers"</span>: <span class="st">"Losers (P1)"</span></span>
<span id="cb73-571"><a href="#cb73-571" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb73-572"><a href="#cb73-572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-573"><a href="#cb73-573" aria-hidden="true" tabindex="-1"></a>plot_cumret <span class="op">=</span> (</span>
<span id="cb73-574"><a href="#cb73-574" aria-hidden="true" tabindex="-1"></a>    ggplot(cumret_plot_data, </span>
<span id="cb73-575"><a href="#cb73-575" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret"</span>, color<span class="op">=</span><span class="st">"portfolio"</span>)) <span class="op">+</span></span>
<span id="cb73-576"><a href="#cb73-576" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb73-577"><a href="#cb73-577" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-578"><a href="#cb73-578" aria-hidden="true" tabindex="-1"></a>    scale_color_manual(values<span class="op">=</span>[<span class="st">"#d62728"</span>, <span class="st">"#1f77b4"</span>]) <span class="op">+</span></span>
<span id="cb73-579"><a href="#cb73-579" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-580"><a href="#cb73-580" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb73-581"><a href="#cb73-581" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Portfolio"</span>,</span>
<span id="cb73-582"><a href="#cb73-582" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cumulative Returns: Winners vs. Losers"</span></span>
<span id="cb73-583"><a href="#cb73-583" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-584"><a href="#cb73-584" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-585"><a href="#cb73-585" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb73-586"><a href="#cb73-586" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb73-587"><a href="#cb73-587" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"bottom"</span></span>
<span id="cb73-588"><a href="#cb73-588" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-589"><a href="#cb73-589" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-590"><a href="#cb73-590" aria-hidden="true" tabindex="-1"></a>plot_cumret</span>
<span id="cb73-591"><a href="#cb73-591" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-592"><a href="#cb73-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-595"><a href="#cb73-595" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-596"><a href="#cb73-596" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumret-long-short</span></span>
<span id="cb73-597"><a href="#cb73-597" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative return of the momentum long-short strategy (Winners minus Losers). Upward-sloping periods indicate momentum profits; sharp drawdowns often coincide with market reversals or crisis episodes."</span></span>
<span id="cb73-598"><a href="#cb73-598" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart showing the cumulative return of the long-short momentum strategy over time, exhibiting periods of accumulation interspersed with sharp drawdowns."</span></span>
<span id="cb73-599"><a href="#cb73-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-600"><a href="#cb73-600" aria-hidden="true" tabindex="-1"></a>plot_ls <span class="op">=</span> (</span>
<span id="cb73-601"><a href="#cb73-601" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret_long_short"</span>)) <span class="op">+</span></span>
<span id="cb73-602"><a href="#cb73-602" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">"#2ca02c"</span>) <span class="op">+</span></span>
<span id="cb73-603"><a href="#cb73-603" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb73-604"><a href="#cb73-604" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-605"><a href="#cb73-605" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-606"><a href="#cb73-606" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb73-607"><a href="#cb73-607" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Cumulative Return: Long-Short Momentum Strategy"</span></span>
<span id="cb73-608"><a href="#cb73-608" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-609"><a href="#cb73-609" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-610"><a href="#cb73-610" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb73-611"><a href="#cb73-611" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-612"><a href="#cb73-612" aria-hidden="true" tabindex="-1"></a>plot_ls</span>
<span id="cb73-613"><a href="#cb73-613" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-614"><a href="#cb73-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-615"><a href="#cb73-615" aria-hidden="true" tabindex="-1"></a><span class="fu">### Monthly Return Distribution</span></span>
<span id="cb73-616"><a href="#cb73-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-617"><a href="#cb73-617" aria-hidden="true" tabindex="-1"></a>Beyond the mean, the full distribution of monthly long-short returns provides insight into the risk profile of the momentum strategy. @fig-return-distribution shows the histogram of monthly returns.</span>
<span id="cb73-618"><a href="#cb73-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-621"><a href="#cb73-621" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-622"><a href="#cb73-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-return-distribution</span></span>
<span id="cb73-623"><a href="#cb73-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of monthly long-short momentum returns. The histogram shows the frequency distribution of monthly Winners-minus-Losers returns. The vertical dashed line indicates the mean monthly return."</span></span>
<span id="cb73-624"><a href="#cb73-624" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A histogram of monthly long-short momentum returns, approximately centered near zero or slightly positive, with tails extending in both directions."</span></span>
<span id="cb73-625"><a href="#cb73-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-626"><a href="#cb73-626" aria-hidden="true" tabindex="-1"></a>mean_ls <span class="op">=</span> ewret_wide[<span class="st">"long_short"</span>].mean()</span>
<span id="cb73-627"><a href="#cb73-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-628"><a href="#cb73-628" aria-hidden="true" tabindex="-1"></a>plot_dist <span class="op">=</span> (</span>
<span id="cb73-629"><a href="#cb73-629" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"long_short"</span>)) <span class="op">+</span></span>
<span id="cb73-630"><a href="#cb73-630" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">50</span>, fill<span class="op">=</span><span class="st">"#1f77b4"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb73-631"><a href="#cb73-631" aria-hidden="true" tabindex="-1"></a>    geom_vline(xintercept<span class="op">=</span>mean_ls, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"red"</span>) <span class="op">+</span></span>
<span id="cb73-632"><a href="#cb73-632" aria-hidden="true" tabindex="-1"></a>    scale_x_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-633"><a href="#cb73-633" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-634"><a href="#cb73-634" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly long-short return"</span>,</span>
<span id="cb73-635"><a href="#cb73-635" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb73-636"><a href="#cb73-636" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Monthly Momentum Returns"</span></span>
<span id="cb73-637"><a href="#cb73-637" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-638"><a href="#cb73-638" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-639"><a href="#cb73-639" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb73-640"><a href="#cb73-640" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-641"><a href="#cb73-641" aria-hidden="true" tabindex="-1"></a>plot_dist</span>
<span id="cb73-642"><a href="#cb73-642" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-643"><a href="#cb73-643" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-644"><a href="#cb73-644" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extending to Multiple Formation and Holding Periods</span></span>
<span id="cb73-645"><a href="#cb73-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-646"><a href="#cb73-646" aria-hidden="true" tabindex="-1"></a><span class="fu">### The J × K Grid</span></span>
<span id="cb73-647"><a href="#cb73-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-648"><a href="#cb73-648" aria-hidden="true" tabindex="-1"></a>@jegadeesh1993returns evaluate momentum strategies across a comprehensive grid of formation periods $J \in <span class="sc">\{</span>3, 6, 9, 12<span class="sc">\}</span>$ and holding periods $K \in <span class="sc">\{</span>3, 6, 9, 12<span class="sc">\}</span>$. This produces 16 different strategy specifications, allowing us to assess the robustness of the momentum effect across different horizons.</span>
<span id="cb73-649"><a href="#cb73-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-650"><a href="#cb73-650" aria-hidden="true" tabindex="-1"></a>We now implement a function that computes the full momentum strategy for any given $(J, K)$ pair, wrapping the steps developed above into a single reusable pipeline.</span>
<span id="cb73-651"><a href="#cb73-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-652"><a href="#cb73-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-655"><a href="#cb73-655" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-656"><a href="#cb73-656" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb73-657"><a href="#cb73-657" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb73-658"><a href="#cb73-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-659"><a href="#cb73-659" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> momentum_strategy(data, J, K, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb73-660"><a href="#cb73-660" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-661"><a href="#cb73-661" aria-hidden="true" tabindex="-1"></a><span class="co">    Implement the full Jegadeesh-Titman momentum strategy.</span></span>
<span id="cb73-662"><a href="#cb73-662" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-663"><a href="#cb73-663" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-664"><a href="#cb73-664" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-665"><a href="#cb73-665" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb73-666"><a href="#cb73-666" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel of stock returns with columns: symbol, date, ret.</span></span>
<span id="cb73-667"><a href="#cb73-667" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb73-668"><a href="#cb73-668" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period in months.</span></span>
<span id="cb73-669"><a href="#cb73-669" aria-hidden="true" tabindex="-1"></a><span class="co">    K : int</span></span>
<span id="cb73-670"><a href="#cb73-670" aria-hidden="true" tabindex="-1"></a><span class="co">        Holding period in months.</span></span>
<span id="cb73-671"><a href="#cb73-671" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int</span></span>
<span id="cb73-672"><a href="#cb73-672" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios (default: 10 for deciles).</span></span>
<span id="cb73-673"><a href="#cb73-673" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-674"><a href="#cb73-674" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-675"><a href="#cb73-675" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-676"><a href="#cb73-676" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-677"><a href="#cb73-677" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly returns for each momentum portfolio and the long-short spread.</span></span>
<span id="cb73-678"><a href="#cb73-678" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-679"><a href="#cb73-679" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Compute formation period cumulative returns</span></span>
<span id="cb73-680"><a href="#cb73-680" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb73-681"><a href="#cb73-681" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb73-682"><a href="#cb73-682" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb73-683"><a href="#cb73-683" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb73-684"><a href="#cb73-684" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb73-685"><a href="#cb73-685" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-686"><a href="#cb73-686" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-687"><a href="#cb73-687" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-688"><a href="#cb73-688" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-689"><a href="#cb73-689" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>]).dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>])</span>
<span id="cb73-690"><a href="#cb73-690" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-691"><a href="#cb73-691" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Assign to momentum portfolios using transform</span></span>
<span id="cb73-692"><a href="#cb73-692" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb73-693"><a href="#cb73-693" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb73-694"><a href="#cb73-694" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb73-695"><a href="#cb73-695" aria-hidden="true" tabindex="-1"></a>            q<span class="op">=</span>n_portfolios,</span>
<span id="cb73-696"><a href="#cb73-696" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb73-697"><a href="#cb73-697" aria-hidden="true" tabindex="-1"></a>            duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb73-698"><a href="#cb73-698" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-699"><a href="#cb73-699" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="st">'Int64'</span>)</span>
<span id="cb73-700"><a href="#cb73-700" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-701"><a href="#cb73-701" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If any NaNs in momr, fill with rank-based assignment</span></span>
<span id="cb73-702"><a href="#cb73-702" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> df[<span class="st">"momr"</span>].isna()</span>
<span id="cb73-703"><a href="#cb73-703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb73-704"><a href="#cb73-704" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">"momr"</span>] <span class="op">=</span> df.loc[mask].groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb73-705"><a href="#cb73-705" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb73-706"><a href="#cb73-706" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb73-707"><a href="#cb73-707" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="bu">min</span>(n_portfolios, <span class="bu">len</span>(x.unique())),</span>
<span id="cb73-708"><a href="#cb73-708" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb73-709"><a href="#cb73-709" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb73-710"><a href="#cb73-710" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-711"><a href="#cb73-711" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="st">'Int64'</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb73-712"><a href="#cb73-712" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-713"><a href="#cb73-713" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Define holding period dates</span></span>
<span id="cb73-714"><a href="#cb73-714" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>})</span>
<span id="cb73-715"><a href="#cb73-715" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate1"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb73-716"><a href="#cb73-716" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate2"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb73-717"><a href="#cb73-717" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-718"><a href="#cb73-718" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Merge with holding period returns</span></span>
<span id="cb73-719"><a href="#cb73-719" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> df[[<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]].merge(</span>
<span id="cb73-720"><a href="#cb73-720" aria-hidden="true" tabindex="-1"></a>        data[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb73-721"><a href="#cb73-721" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb73-722"><a href="#cb73-722" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb73-723"><a href="#cb73-723" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb73-724"><a href="#cb73-724" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-725"><a href="#cb73-725" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-726"><a href="#cb73-726" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-727"><a href="#cb73-727" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use boolean indexing</span></span>
<span id="cb73-728"><a href="#cb73-728" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[</span>
<span id="cb73-729"><a href="#cb73-729" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&gt;=</span> port_ret[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb73-730"><a href="#cb73-730" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&lt;=</span> port_ret[<span class="st">"hdate2"</span>])</span>
<span id="cb73-731"><a href="#cb73-731" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb73-732"><a href="#cb73-732" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-733"><a href="#cb73-733" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Compute equally weighted returns (two-stage averaging)</span></span>
<span id="cb73-734"><a href="#cb73-734" aria-hidden="true" tabindex="-1"></a>    cohort_ret <span class="op">=</span> (port_ret</span>
<span id="cb73-735"><a href="#cb73-735" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb73-736"><a href="#cb73-736" aria-hidden="true" tabindex="-1"></a>        .agg(cohort_ret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-737"><a href="#cb73-737" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-738"><a href="#cb73-738" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-739"><a href="#cb73-739" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-740"><a href="#cb73-740" aria-hidden="true" tabindex="-1"></a>    monthly_ret <span class="op">=</span> (cohort_ret</span>
<span id="cb73-741"><a href="#cb73-741" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb73-742"><a href="#cb73-742" aria-hidden="true" tabindex="-1"></a>        .agg(ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-743"><a href="#cb73-743" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-744"><a href="#cb73-744" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb73-745"><a href="#cb73-745" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-746"><a href="#cb73-746" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-747"><a href="#cb73-747" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Compute long-short spread</span></span>
<span id="cb73-748"><a href="#cb73-748" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> monthly_ret.pivot(</span>
<span id="cb73-749"><a href="#cb73-749" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb73-750"><a href="#cb73-750" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb73-751"><a href="#cb73-751" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-752"><a href="#cb73-752" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle variable number of portfolios</span></span>
<span id="cb73-753"><a href="#cb73-753" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(wide.columns) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-754"><a href="#cb73-754" aria-hidden="true" tabindex="-1"></a>    wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_cols <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb73-755"><a href="#cb73-755" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"winners"</span>] <span class="op">=</span> wide[<span class="ss">f"port</span><span class="sc">{</span>n_cols<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb73-756"><a href="#cb73-756" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"losers"</span>] <span class="op">=</span> wide[<span class="st">"port1"</span>]</span>
<span id="cb73-757"><a href="#cb73-757" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"long_short"</span>] <span class="op">=</span> wide[<span class="st">"winners"</span>] <span class="op">-</span> wide[<span class="st">"losers"</span>]</span>
<span id="cb73-758"><a href="#cb73-758" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-759"><a href="#cb73-759" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_ret, wide</span>
<span id="cb73-760"><a href="#cb73-760" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-761"><a href="#cb73-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-762"><a href="#cb73-762" aria-hidden="true" tabindex="-1"></a><span class="fu">### Running the Full Grid</span></span>
<span id="cb73-763"><a href="#cb73-763" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-764"><a href="#cb73-764" aria-hidden="true" tabindex="-1"></a>We now run the momentum strategy for all 16 $(J, K)$ combinations. This is computationally intensive, so we store the key summary statistics for each specification.</span>
<span id="cb73-765"><a href="#cb73-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-766"><a href="#cb73-766" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Sequential Calculation</span></span>
<span id="cb73-767"><a href="#cb73-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-770"><a href="#cb73-770" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-771"><a href="#cb73-771" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb73-772"><a href="#cb73-772" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: momemtum-calculation-squential</span></span>
<span id="cb73-773"><a href="#cb73-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-774"><a href="#cb73-774" aria-hidden="true" tabindex="-1"></a>J_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb73-775"><a href="#cb73-775" aria-hidden="true" tabindex="-1"></a>K_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb73-776"><a href="#cb73-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-777"><a href="#cb73-777" aria-hidden="true" tabindex="-1"></a>results_grid <span class="op">=</span> []</span>
<span id="cb73-778"><a href="#cb73-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-779"><a href="#cb73-779" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> J_val, K_val <span class="kw">in</span> product(J_values, K_values):</span>
<span id="cb73-780"><a href="#cb73-780" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Computing J=</span><span class="sc">{</span>J_val<span class="sc">}</span><span class="ss">, K=</span><span class="sc">{</span>K_val<span class="sc">}</span><span class="ss">..."</span>, end<span class="op">=</span><span class="st">" "</span>)</span>
<span id="cb73-781"><a href="#cb73-781" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-782"><a href="#cb73-782" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb73-783"><a href="#cb73-783" aria-hidden="true" tabindex="-1"></a>        _, wide_result <span class="op">=</span> momentum_strategy(prices_clean, J_val, K_val)</span>
<span id="cb73-784"><a href="#cb73-784" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-785"><a href="#cb73-785" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> portfolio_name <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb73-786"><a href="#cb73-786" aria-hidden="true" tabindex="-1"></a>            series <span class="op">=</span> wide_result[portfolio_name].dropna()</span>
<span id="cb73-787"><a href="#cb73-787" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb73-788"><a href="#cb73-788" aria-hidden="true" tabindex="-1"></a>            mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb73-789"><a href="#cb73-789" aria-hidden="true" tabindex="-1"></a>            std_ret <span class="op">=</span> series.std()</span>
<span id="cb73-790"><a href="#cb73-790" aria-hidden="true" tabindex="-1"></a>            t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb73-791"><a href="#cb73-791" aria-hidden="true" tabindex="-1"></a>            p_val <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) </span>
<span id="cb73-792"><a href="#cb73-792" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan)</span>
<span id="cb73-793"><a href="#cb73-793" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb73-794"><a href="#cb73-794" aria-hidden="true" tabindex="-1"></a>            results_grid.append({</span>
<span id="cb73-795"><a href="#cb73-795" aria-hidden="true" tabindex="-1"></a>                <span class="st">"J"</span>: J_val,</span>
<span id="cb73-796"><a href="#cb73-796" aria-hidden="true" tabindex="-1"></a>                <span class="st">"K"</span>: K_val,</span>
<span id="cb73-797"><a href="#cb73-797" aria-hidden="true" tabindex="-1"></a>                <span class="st">"portfolio"</span>: portfolio_name,</span>
<span id="cb73-798"><a href="#cb73-798" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_months"</span>: n,</span>
<span id="cb73-799"><a href="#cb73-799" aria-hidden="true" tabindex="-1"></a>                <span class="st">"mean_ret"</span>: mean_ret,</span>
<span id="cb73-800"><a href="#cb73-800" aria-hidden="true" tabindex="-1"></a>                <span class="st">"std_ret"</span>: std_ret,</span>
<span id="cb73-801"><a href="#cb73-801" aria-hidden="true" tabindex="-1"></a>                <span class="st">"t_stat"</span>: t_stat,</span>
<span id="cb73-802"><a href="#cb73-802" aria-hidden="true" tabindex="-1"></a>                <span class="st">"p_value"</span>: p_val</span>
<span id="cb73-803"><a href="#cb73-803" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb73-804"><a href="#cb73-804" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-805"><a href="#cb73-805" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Done."</span>)</span>
<span id="cb73-806"><a href="#cb73-806" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb73-807"><a href="#cb73-807" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-808"><a href="#cb73-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-809"><a href="#cb73-809" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(results_grid)</span>
<span id="cb73-810"><a href="#cb73-810" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-811"><a href="#cb73-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-812"><a href="#cb73-812" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Parallel Calculation</span></span>
<span id="cb73-813"><a href="#cb73-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-816"><a href="#cb73-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-817"><a href="#cb73-817" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_single_strategy(data, J, K):</span>
<span id="cb73-818"><a href="#cb73-818" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-819"><a href="#cb73-819" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute statistics for a single (J, K) strategy.</span></span>
<span id="cb73-820"><a href="#cb73-820" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a list of result dicts, one per portfolio.</span></span>
<span id="cb73-821"><a href="#cb73-821" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-822"><a href="#cb73-822" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb73-823"><a href="#cb73-823" aria-hidden="true" tabindex="-1"></a>        _, wide_result <span class="op">=</span> momentum_strategy(data, J, K)</span>
<span id="cb73-824"><a href="#cb73-824" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-825"><a href="#cb73-825" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb73-826"><a href="#cb73-826" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> portfolio_name <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb73-827"><a href="#cb73-827" aria-hidden="true" tabindex="-1"></a>            series <span class="op">=</span> wide_result[portfolio_name].dropna()</span>
<span id="cb73-828"><a href="#cb73-828" aria-hidden="true" tabindex="-1"></a>            n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb73-829"><a href="#cb73-829" aria-hidden="true" tabindex="-1"></a>            mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb73-830"><a href="#cb73-830" aria-hidden="true" tabindex="-1"></a>            std_ret <span class="op">=</span> series.std()</span>
<span id="cb73-831"><a href="#cb73-831" aria-hidden="true" tabindex="-1"></a>            t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb73-832"><a href="#cb73-832" aria-hidden="true" tabindex="-1"></a>            p_val <span class="op">=</span> (<span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) </span>
<span id="cb73-833"><a href="#cb73-833" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan)</span>
<span id="cb73-834"><a href="#cb73-834" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb73-835"><a href="#cb73-835" aria-hidden="true" tabindex="-1"></a>            results.append({</span>
<span id="cb73-836"><a href="#cb73-836" aria-hidden="true" tabindex="-1"></a>                <span class="st">"J"</span>: J,</span>
<span id="cb73-837"><a href="#cb73-837" aria-hidden="true" tabindex="-1"></a>                <span class="st">"K"</span>: K,</span>
<span id="cb73-838"><a href="#cb73-838" aria-hidden="true" tabindex="-1"></a>                <span class="st">"portfolio"</span>: portfolio_name,</span>
<span id="cb73-839"><a href="#cb73-839" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_months"</span>: n,</span>
<span id="cb73-840"><a href="#cb73-840" aria-hidden="true" tabindex="-1"></a>                <span class="st">"mean_ret"</span>: mean_ret,</span>
<span id="cb73-841"><a href="#cb73-841" aria-hidden="true" tabindex="-1"></a>                <span class="st">"std_ret"</span>: std_ret,</span>
<span id="cb73-842"><a href="#cb73-842" aria-hidden="true" tabindex="-1"></a>                <span class="st">"t_stat"</span>: t_stat,</span>
<span id="cb73-843"><a href="#cb73-843" aria-hidden="true" tabindex="-1"></a>                <span class="st">"p_value"</span>: p_val</span>
<span id="cb73-844"><a href="#cb73-844" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb73-845"><a href="#cb73-845" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb73-846"><a href="#cb73-846" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb73-847"><a href="#cb73-847" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Error in J=</span><span class="sc">{</span>J<span class="sc">}</span><span class="ss">, K=</span><span class="sc">{</span>K<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-848"><a href="#cb73-848" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb73-849"><a href="#cb73-849" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-850"><a href="#cb73-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-853"><a href="#cb73-853" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-854"><a href="#cb73-854" aria-hidden="true" tabindex="-1"></a>J_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb73-855"><a href="#cb73-855" aria-hidden="true" tabindex="-1"></a>K_values <span class="op">=</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>, <span class="dv">12</span>]</span>
<span id="cb73-856"><a href="#cb73-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-857"><a href="#cb73-857" aria-hidden="true" tabindex="-1"></a><span class="co"># Create list of (J, K) pairs</span></span>
<span id="cb73-858"><a href="#cb73-858" aria-hidden="true" tabindex="-1"></a>params <span class="op">=</span> <span class="bu">list</span>(product(J_values, K_values))</span>
<span id="cb73-859"><a href="#cb73-859" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-860"><a href="#cb73-860" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Running </span><span class="sc">{</span><span class="bu">len</span>(params)<span class="sc">}</span><span class="ss"> momentum strategies in parallel with 4 cores..."</span>)</span>
<span id="cb73-861"><a href="#cb73-861" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> time.time()</span>
<span id="cb73-862"><a href="#cb73-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-863"><a href="#cb73-863" aria-hidden="true" tabindex="-1"></a><span class="co"># Parallel execution with 4 workers</span></span>
<span id="cb73-864"><a href="#cb73-864" aria-hidden="true" tabindex="-1"></a>results_list <span class="op">=</span> Parallel(n_jobs<span class="op">=</span><span class="dv">4</span>, verbose<span class="op">=</span><span class="dv">10</span>)(</span>
<span id="cb73-865"><a href="#cb73-865" aria-hidden="true" tabindex="-1"></a>    delayed(compute_single_strategy)(prices_clean, J, K)</span>
<span id="cb73-866"><a href="#cb73-866" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> J, K <span class="kw">in</span> params</span>
<span id="cb73-867"><a href="#cb73-867" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-868"><a href="#cb73-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-869"><a href="#cb73-869" aria-hidden="true" tabindex="-1"></a><span class="co"># Flatten results</span></span>
<span id="cb73-870"><a href="#cb73-870" aria-hidden="true" tabindex="-1"></a>results_grid <span class="op">=</span> [item <span class="cf">for</span> sublist <span class="kw">in</span> results_list <span class="cf">for</span> item <span class="kw">in</span> sublist]</span>
<span id="cb73-871"><a href="#cb73-871" aria-hidden="true" tabindex="-1"></a>results_df <span class="op">=</span> pd.DataFrame(results_grid)</span>
<span id="cb73-872"><a href="#cb73-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-873"><a href="#cb73-873" aria-hidden="true" tabindex="-1"></a>elapsed <span class="op">=</span> time.time() <span class="op">-</span> start_time</span>
<span id="cb73-874"><a href="#cb73-874" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Completed in </span><span class="sc">{</span>elapsed<span class="sc">:.2f}</span><span class="ss"> seconds"</span>)</span>
<span id="cb73-875"><a href="#cb73-875" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-876"><a href="#cb73-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-879"><a href="#cb73-879" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-880"><a href="#cb73-880" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb73-881"><a href="#cb73-881" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Results Summary by Formation Period:"</span>)</span>
<span id="cb73-882"><a href="#cb73-882" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_df.groupby(<span class="st">"J"</span>).agg({</span>
<span id="cb73-883"><a href="#cb73-883" aria-hidden="true" tabindex="-1"></a>    <span class="st">"mean_ret"</span>: <span class="st">"mean"</span>,</span>
<span id="cb73-884"><a href="#cb73-884" aria-hidden="true" tabindex="-1"></a>    <span class="st">"std_ret"</span>: <span class="st">"mean"</span>,</span>
<span id="cb73-885"><a href="#cb73-885" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t_stat"</span>: [<span class="st">"mean"</span>, <span class="kw">lambda</span> x: (x.<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.96</span>).<span class="bu">sum</span>()],</span>
<span id="cb73-886"><a href="#cb73-886" aria-hidden="true" tabindex="-1"></a>    <span class="st">"n_months"</span>: <span class="st">"first"</span></span>
<span id="cb73-887"><a href="#cb73-887" aria-hidden="true" tabindex="-1"></a>}).<span class="bu">round</span>(<span class="dv">6</span>))</span>
<span id="cb73-888"><a href="#cb73-888" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-889"><a href="#cb73-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-890"><a href="#cb73-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-891"><a href="#cb73-891" aria-hidden="true" tabindex="-1"></a><span class="fu">### Winners Portfolio Returns</span></span>
<span id="cb73-892"><a href="#cb73-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-893"><a href="#cb73-893" aria-hidden="true" tabindex="-1"></a>@tbl-winners-grid presents the average monthly returns of the winner portfolio (portfolio 10) across all $(J, K)$ combinations.</span>
<span id="cb73-894"><a href="#cb73-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-897"><a href="#cb73-897" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-898"><a href="#cb73-898" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-winners-grid</span></span>
<span id="cb73-899"><a href="#cb73-899" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Average monthly returns (%) of the winner portfolio across formation periods (J) and holding periods (K). t-statistics are reported in parentheses."</span></span>
<span id="cb73-900"><a href="#cb73-900" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-901"><a href="#cb73-901" aria-hidden="true" tabindex="-1"></a>winners_grid <span class="op">=</span> (results_df</span>
<span id="cb73-902"><a href="#cb73-902" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'winners'"</span>)</span>
<span id="cb73-903"><a href="#cb73-903" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-904"><a href="#cb73-904" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb73-905"><a href="#cb73-905" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb73-906"><a href="#cb73-906" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb73-907"><a href="#cb73-907" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-908"><a href="#cb73-908" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-909"><a href="#cb73-909" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb73-910"><a href="#cb73-910" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-911"><a href="#cb73-911" aria-hidden="true" tabindex="-1"></a>winners_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> winners_grid.columns]</span>
<span id="cb73-912"><a href="#cb73-912" aria-hidden="true" tabindex="-1"></a>winners_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> winners_grid.index]</span>
<span id="cb73-913"><a href="#cb73-913" aria-hidden="true" tabindex="-1"></a>winners_grid</span>
<span id="cb73-914"><a href="#cb73-914" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-915"><a href="#cb73-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-916"><a href="#cb73-916" aria-hidden="true" tabindex="-1"></a><span class="fu">### Losers Portfolio Returns</span></span>
<span id="cb73-917"><a href="#cb73-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-918"><a href="#cb73-918" aria-hidden="true" tabindex="-1"></a>@tbl-losers-grid presents the corresponding results for the loser portfolio.</span>
<span id="cb73-919"><a href="#cb73-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-922"><a href="#cb73-922" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-923"><a href="#cb73-923" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-losers-grid</span></span>
<span id="cb73-924"><a href="#cb73-924" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Average monthly returns (%) of the loser portfolio across formation periods (J) and holding periods (K). t-statistics are reported in parentheses."</span></span>
<span id="cb73-925"><a href="#cb73-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-926"><a href="#cb73-926" aria-hidden="true" tabindex="-1"></a>losers_grid <span class="op">=</span> (results_df</span>
<span id="cb73-927"><a href="#cb73-927" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'losers'"</span>)</span>
<span id="cb73-928"><a href="#cb73-928" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-929"><a href="#cb73-929" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb73-930"><a href="#cb73-930" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb73-931"><a href="#cb73-931" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb73-932"><a href="#cb73-932" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-933"><a href="#cb73-933" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-934"><a href="#cb73-934" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb73-935"><a href="#cb73-935" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-936"><a href="#cb73-936" aria-hidden="true" tabindex="-1"></a>losers_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> losers_grid.columns]</span>
<span id="cb73-937"><a href="#cb73-937" aria-hidden="true" tabindex="-1"></a>losers_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> losers_grid.index]</span>
<span id="cb73-938"><a href="#cb73-938" aria-hidden="true" tabindex="-1"></a>losers_grid</span>
<span id="cb73-939"><a href="#cb73-939" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-940"><a href="#cb73-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-941"><a href="#cb73-941" aria-hidden="true" tabindex="-1"></a><span class="fu">### Long-Short Momentum Returns</span></span>
<span id="cb73-942"><a href="#cb73-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-943"><a href="#cb73-943" aria-hidden="true" tabindex="-1"></a>@tbl-ls-grid presents the most important results: the average monthly returns of the long-short momentum portfolio across all specifications.</span>
<span id="cb73-944"><a href="#cb73-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-947"><a href="#cb73-947" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-948"><a href="#cb73-948" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ls-grid</span></span>
<span id="cb73-949"><a href="#cb73-949" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Average monthly returns (%) of the momentum long-short portfolio (Winners minus Losers) across formation periods (J) and holding periods (K). t-statistics are reported in parentheses. This table replicates the format of Table 1 in Jegadeesh and Titman (1993)."</span></span>
<span id="cb73-950"><a href="#cb73-950" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-951"><a href="#cb73-951" aria-hidden="true" tabindex="-1"></a>ls_grid <span class="op">=</span> (results_df</span>
<span id="cb73-952"><a href="#cb73-952" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'long_short'"</span>)</span>
<span id="cb73-953"><a href="#cb73-953" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-954"><a href="#cb73-954" aria-hidden="true" tabindex="-1"></a>        display<span class="op">=</span><span class="kw">lambda</span> x: (</span>
<span id="cb73-955"><a href="#cb73-955" aria-hidden="true" tabindex="-1"></a>            x[<span class="st">"mean_ret"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> </span>
<span id="cb73-956"><a href="#cb73-956" aria-hidden="true" tabindex="-1"></a>            <span class="st">"</span><span class="ch">\n</span><span class="st">("</span> <span class="op">+</span> x[<span class="st">"t_stat"</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> v: <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">"</span>) <span class="op">+</span> <span class="st">")"</span></span>
<span id="cb73-957"><a href="#cb73-957" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-958"><a href="#cb73-958" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-959"><a href="#cb73-959" aria-hidden="true" tabindex="-1"></a>    .pivot(index<span class="op">=</span><span class="st">"J"</span>, columns<span class="op">=</span><span class="st">"K"</span>, values<span class="op">=</span><span class="st">"display"</span>)</span>
<span id="cb73-960"><a href="#cb73-960" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-961"><a href="#cb73-961" aria-hidden="true" tabindex="-1"></a>ls_grid.columns <span class="op">=</span> [<span class="ss">f"K=</span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> k <span class="kw">in</span> ls_grid.columns]</span>
<span id="cb73-962"><a href="#cb73-962" aria-hidden="true" tabindex="-1"></a>ls_grid.index <span class="op">=</span> [<span class="ss">f"J=</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> j <span class="kw">in</span> ls_grid.index]</span>
<span id="cb73-963"><a href="#cb73-963" aria-hidden="true" tabindex="-1"></a>ls_grid</span>
<span id="cb73-964"><a href="#cb73-964" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-965"><a href="#cb73-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-966"><a href="#cb73-966" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualizing the Momentum Premium Across Specifications</span></span>
<span id="cb73-967"><a href="#cb73-967" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-968"><a href="#cb73-968" aria-hidden="true" tabindex="-1"></a>@fig-momentum-heatmap provides a visual summary of the long-short momentum premium across all $(J, K)$ combinations.</span>
<span id="cb73-969"><a href="#cb73-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-972"><a href="#cb73-972" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-973"><a href="#cb73-973" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-momentum-heatmap</span></span>
<span id="cb73-974"><a href="#cb73-974" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Heatmap of average monthly long-short momentum returns (%) across formation periods (J) and holding periods (K). Darker shades indicate higher momentum profits. Asterisks denote statistical significance at the 5% level."</span></span>
<span id="cb73-975"><a href="#cb73-975" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A heatmap with formation period J on the y-axis and holding period K on the x-axis, with cell colors indicating the magnitude of the momentum premium."</span></span>
<span id="cb73-976"><a href="#cb73-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-977"><a href="#cb73-977" aria-hidden="true" tabindex="-1"></a>ls_heatmap_data <span class="op">=</span> (results_df</span>
<span id="cb73-978"><a href="#cb73-978" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"portfolio == 'long_short'"</span>)</span>
<span id="cb73-979"><a href="#cb73-979" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-980"><a href="#cb73-980" aria-hidden="true" tabindex="-1"></a>        mean_pct<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"mean_ret"</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb73-981"><a href="#cb73-981" aria-hidden="true" tabindex="-1"></a>        significant<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"p_value"</span>] <span class="op">&lt;</span> <span class="fl">0.05</span>,</span>
<span id="cb73-982"><a href="#cb73-982" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="kw">lambda</span> x: x.<span class="bu">apply</span>(</span>
<span id="cb73-983"><a href="#cb73-983" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> row: <span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'mean_ret'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}{</span><span class="st">'*'</span> <span class="cf">if</span> row[<span class="st">'p_value'</span>] <span class="op">&lt;</span> <span class="fl">0.05</span> <span class="cf">else</span> <span class="st">''</span><span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb73-984"><a href="#cb73-984" aria-hidden="true" tabindex="-1"></a>            axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb73-985"><a href="#cb73-985" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-986"><a href="#cb73-986" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-987"><a href="#cb73-987" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-988"><a href="#cb73-988" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-989"><a href="#cb73-989" aria-hidden="true" tabindex="-1"></a>plot_heatmap <span class="op">=</span> (</span>
<span id="cb73-990"><a href="#cb73-990" aria-hidden="true" tabindex="-1"></a>    ggplot(ls_heatmap_data, </span>
<span id="cb73-991"><a href="#cb73-991" aria-hidden="true" tabindex="-1"></a>           aes(x<span class="op">=</span><span class="st">"K.astype(str)"</span>, y<span class="op">=</span><span class="st">"J.astype(str)"</span>, fill<span class="op">=</span><span class="st">"mean_pct"</span>)) <span class="op">+</span></span>
<span id="cb73-992"><a href="#cb73-992" aria-hidden="true" tabindex="-1"></a>    geom_tile(color<span class="op">=</span><span class="st">"white"</span>, size<span class="op">=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb73-993"><a href="#cb73-993" aria-hidden="true" tabindex="-1"></a>    geom_text(aes(label<span class="op">=</span><span class="st">"label"</span>), size<span class="op">=</span><span class="dv">10</span>, color<span class="op">=</span><span class="st">"white"</span>) <span class="op">+</span></span>
<span id="cb73-994"><a href="#cb73-994" aria-hidden="true" tabindex="-1"></a>    scale_fill_gradient2(</span>
<span id="cb73-995"><a href="#cb73-995" aria-hidden="true" tabindex="-1"></a>        low<span class="op">=</span><span class="st">"#d62728"</span>, mid<span class="op">=</span><span class="st">"#f7f7f7"</span>, high<span class="op">=</span><span class="st">"#1f77b4"</span>, midpoint<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb73-996"><a href="#cb73-996" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"Monthly</span><span class="ch">\n</span><span class="st">Return (%)"</span></span>
<span id="cb73-997"><a href="#cb73-997" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-998"><a href="#cb73-998" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-999"><a href="#cb73-999" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Holding Period (K months)"</span>,</span>
<span id="cb73-1000"><a href="#cb73-1000" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Formation Period (J months)"</span>,</span>
<span id="cb73-1001"><a href="#cb73-1001" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Premium Across J×K Specifications"</span></span>
<span id="cb73-1002"><a href="#cb73-1002" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1003"><a href="#cb73-1003" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1004"><a href="#cb73-1004" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb73-1005"><a href="#cb73-1005" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1006"><a href="#cb73-1006" aria-hidden="true" tabindex="-1"></a>plot_heatmap</span>
<span id="cb73-1007"><a href="#cb73-1007" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1008"><a href="#cb73-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1009"><a href="#cb73-1009" aria-hidden="true" tabindex="-1"></a><span class="fu">## Risk-Adjusted Performance</span></span>
<span id="cb73-1010"><a href="#cb73-1010" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1011"><a href="#cb73-1011" aria-hidden="true" tabindex="-1"></a><span class="fu">### CAPM Alpha</span></span>
<span id="cb73-1012"><a href="#cb73-1012" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1013"><a href="#cb73-1013" aria-hidden="true" tabindex="-1"></a>A natural question is whether the momentum premium is explained by exposure to the market factor. We estimate the CAPM alpha of the long-short momentum portfolio by regressing its returns on the market excess return:</span>
<span id="cb73-1014"><a href="#cb73-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1015"><a href="#cb73-1015" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-1016"><a href="#cb73-1016" aria-hidden="true" tabindex="-1"></a>r_{\text{WML},t} = \alpha + \beta \cdot r_{\text{MKT},t} + \epsilon_t</span>
<span id="cb73-1017"><a href="#cb73-1017" aria-hidden="true" tabindex="-1"></a>$$ {#eq-capm-alpha}</span>
<span id="cb73-1018"><a href="#cb73-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1021"><a href="#cb73-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1022"><a href="#cb73-1022" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge momentum returns with factor data (baseline J=6, K=6)</span></span>
<span id="cb73-1023"><a href="#cb73-1023" aria-hidden="true" tabindex="-1"></a>ewret_factors <span class="op">=</span> (ewret_wide</span>
<span id="cb73-1024"><a href="#cb73-1024" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]]</span>
<span id="cb73-1025"><a href="#cb73-1025" aria-hidden="true" tabindex="-1"></a>    .merge(factors_ff3_monthly, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb73-1026"><a href="#cb73-1026" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1027"><a href="#cb73-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1028"><a href="#cb73-1028" aria-hidden="true" tabindex="-1"></a><span class="co"># CAPM regression for long-short portfolio</span></span>
<span id="cb73-1029"><a href="#cb73-1029" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.formula.api <span class="im">import</span> ols <span class="im">as</span> ols_formula</span>
<span id="cb73-1030"><a href="#cb73-1030" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb73-1031"><a href="#cb73-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1032"><a href="#cb73-1032" aria-hidden="true" tabindex="-1"></a>X_capm <span class="op">=</span> sm.add_constant(ewret_factors[<span class="st">"mkt_excess"</span>])</span>
<span id="cb73-1033"><a href="#cb73-1033" aria-hidden="true" tabindex="-1"></a>y_ls <span class="op">=</span> ewret_factors[<span class="st">"long_short"</span>]</span>
<span id="cb73-1034"><a href="#cb73-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1035"><a href="#cb73-1035" aria-hidden="true" tabindex="-1"></a>capm_model <span class="op">=</span> sm.OLS(y_ls, X_capm).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb73-1036"><a href="#cb73-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1037"><a href="#cb73-1037" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CAPM Regression: Long-Short Momentum Returns"</span>)</span>
<span id="cb73-1038"><a href="#cb73-1038" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb73-1039"><a href="#cb73-1039" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha (monthly):  </span><span class="sc">{</span>capm_model<span class="sc">.</span>params[<span class="st">'const'</span>]<span class="op">*</span><span class="dv">100</span><span class="sc">:.4f}</span><span class="ss">% "</span></span>
<span id="cb73-1040"><a href="#cb73-1040" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(t=</span><span class="sc">{</span>capm_model<span class="sc">.</span>tvalues[<span class="st">'const'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb73-1041"><a href="#cb73-1041" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Market Beta:      </span><span class="sc">{</span>capm_model<span class="sc">.</span>params[<span class="st">'mkt_excess'</span>]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb73-1042"><a href="#cb73-1042" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(t=</span><span class="sc">{</span>capm_model<span class="sc">.</span>tvalues[<span class="st">'mkt_excess'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>)</span>
<span id="cb73-1043"><a href="#cb73-1043" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R-squared:        </span><span class="sc">{</span>capm_model<span class="sc">.</span>rsquared<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-1044"><a href="#cb73-1044" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"N observations:   </span><span class="sc">{</span>capm_model<span class="sc">.</span>nobs<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb73-1045"><a href="#cb73-1045" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1046"><a href="#cb73-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1047"><a href="#cb73-1047" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fama-French Three-Factor Alpha</span></span>
<span id="cb73-1048"><a href="#cb73-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1049"><a href="#cb73-1049" aria-hidden="true" tabindex="-1"></a>We extend the risk adjustment to the Fama-French three-factor model, which includes the size (SMB) and value (HML) factors in addition to the market factor:</span>
<span id="cb73-1050"><a href="#cb73-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1051"><a href="#cb73-1051" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-1052"><a href="#cb73-1052" aria-hidden="true" tabindex="-1"></a>r_{\text{WML},t} = \alpha + \beta_1 \cdot r_{\text{MKT},t} + \beta_2 \cdot \text{SMB}_t + \beta_3 \cdot \text{HML}_t + \epsilon_t</span>
<span id="cb73-1053"><a href="#cb73-1053" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ff3-alpha}</span>
<span id="cb73-1054"><a href="#cb73-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1057"><a href="#cb73-1057" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1058"><a href="#cb73-1058" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ff3-regression</span></span>
<span id="cb73-1059"><a href="#cb73-1059" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Fama-French three-factor regression for the momentum long-short portfolio. The dependent variable is the monthly return of the Winners-minus-Losers portfolio. Alpha is the intercept, representing the risk-adjusted abnormal return. HAC standard errors with 6 lags are used."</span></span>
<span id="cb73-1060"><a href="#cb73-1060" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1061"><a href="#cb73-1061" aria-hidden="true" tabindex="-1"></a>X_ff3 <span class="op">=</span> sm.add_constant(</span>
<span id="cb73-1062"><a href="#cb73-1062" aria-hidden="true" tabindex="-1"></a>    ewret_factors[[<span class="st">"mkt_excess"</span>, <span class="st">"smb"</span>, <span class="st">"hml"</span>]]</span>
<span id="cb73-1063"><a href="#cb73-1063" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1064"><a href="#cb73-1064" aria-hidden="true" tabindex="-1"></a>y_ls <span class="op">=</span> ewret_factors[<span class="st">"long_short"</span>]</span>
<span id="cb73-1065"><a href="#cb73-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1066"><a href="#cb73-1066" aria-hidden="true" tabindex="-1"></a>ff3_model <span class="op">=</span> sm.OLS(y_ls, X_ff3).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb73-1067"><a href="#cb73-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1068"><a href="#cb73-1068" aria-hidden="true" tabindex="-1"></a><span class="co"># Display results as a clean table</span></span>
<span id="cb73-1069"><a href="#cb73-1069" aria-hidden="true" tabindex="-1"></a>ff3_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb73-1070"><a href="#cb73-1070" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: ff3_model.params,</span>
<span id="cb73-1071"><a href="#cb73-1071" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: ff3_model.bse,</span>
<span id="cb73-1072"><a href="#cb73-1072" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: ff3_model.tvalues,</span>
<span id="cb73-1073"><a href="#cb73-1073" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: ff3_model.pvalues</span>
<span id="cb73-1074"><a href="#cb73-1074" aria-hidden="true" tabindex="-1"></a>}).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb73-1075"><a href="#cb73-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1076"><a href="#cb73-1076" aria-hidden="true" tabindex="-1"></a>ff3_results.index <span class="op">=</span> [<span class="st">"Alpha"</span>, <span class="st">"MKT"</span>, <span class="st">"SMB"</span>, <span class="st">"HML"</span>]</span>
<span id="cb73-1077"><a href="#cb73-1077" aria-hidden="true" tabindex="-1"></a>ff3_results</span>
<span id="cb73-1078"><a href="#cb73-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1079"><a href="#cb73-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1082"><a href="#cb73-1082" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1083"><a href="#cb73-1083" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">R-squared: </span><span class="sc">{</span>ff3_model<span class="sc">.</span>rsquared<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-1084"><a href="#cb73-1084" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Adjusted R-squared: </span><span class="sc">{</span>ff3_model<span class="sc">.</span>rsquared_adj<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb73-1085"><a href="#cb73-1085" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha (annualized): </span><span class="sc">{</span>ff3_model<span class="sc">.</span>params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb73-1086"><a href="#cb73-1086" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1087"><a href="#cb73-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1088"><a href="#cb73-1088" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation of Risk Exposures</span></span>
<span id="cb73-1089"><a href="#cb73-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1090"><a href="#cb73-1090" aria-hidden="true" tabindex="-1"></a>The factor loadings from the three-factor regression reveal the risk characteristics of the momentum strategy in the Vietnamese market. Several patterns are commonly observed:</span>
<span id="cb73-1091"><a href="#cb73-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1092"><a href="#cb73-1092" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Market beta**: Momentum portfolios typically have moderate market exposure. In the U.S., @grundy2001understanding document that the market beta of the long-short portfolio is close to zero on average but highly time-varying, spiking during market reversals.</span>
<span id="cb73-1093"><a href="#cb73-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1094"><a href="#cb73-1094" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Size exposure (SMB)**: Momentum strategies often load positively on the size factor, reflecting the tendency for smaller stocks to exhibit stronger momentum patterns.</span>
<span id="cb73-1095"><a href="#cb73-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1096"><a href="#cb73-1096" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Value exposure (HML)**: The long-short momentum portfolio typically loads negatively on HML, indicating that winners tend to be growth stocks while losers tend to be value stocks. This creates a natural tension between momentum and value strategies.</span>
<span id="cb73-1097"><a href="#cb73-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1098"><a href="#cb73-1098" aria-hidden="true" tabindex="-1"></a><span class="fu">## Momentum and Market States</span></span>
<span id="cb73-1099"><a href="#cb73-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1100"><a href="#cb73-1100" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conditional Performance</span></span>
<span id="cb73-1101"><a href="#cb73-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1102"><a href="#cb73-1102" aria-hidden="true" tabindex="-1"></a>An important finding in the momentum literature is that momentum profits vary with market conditions. @cooper2004market document that momentum strategies perform well following market gains (UP markets) but experience severe losses following market declines (DOWN markets). This asymmetry is particularly relevant for emerging markets, which experience more extreme market states.</span>
<span id="cb73-1103"><a href="#cb73-1103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1104"><a href="#cb73-1104" aria-hidden="true" tabindex="-1"></a>We define market states based on the cumulative market return over the prior 12 months:</span>
<span id="cb73-1105"><a href="#cb73-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1106"><a href="#cb73-1106" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb73-1107"><a href="#cb73-1107" aria-hidden="true" tabindex="-1"></a>\text{Market State}_t = \begin{cases} \text{UP} &amp; \text{if } \prod_{s=t-12}^{t-1}(1 + r_{m,s}) - 1 &gt; 0 <span class="sc">\\</span> \text{DOWN} &amp; \text{otherwise} \end{cases}</span>
<span id="cb73-1108"><a href="#cb73-1108" aria-hidden="true" tabindex="-1"></a>$$ {#eq-market-state}</span>
<span id="cb73-1109"><a href="#cb73-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1112"><a href="#cb73-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1113"><a href="#cb73-1113" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute 12-month lagged market return</span></span>
<span id="cb73-1114"><a href="#cb73-1114" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> factors_ff3_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]].copy()</span>
<span id="cb73-1115"><a href="#cb73-1115" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> market_returns.sort_values(<span class="st">"date"</span>)</span>
<span id="cb73-1116"><a href="#cb73-1116" aria-hidden="true" tabindex="-1"></a>market_returns[<span class="st">"mkt_cum_12m"</span>] <span class="op">=</span> (</span>
<span id="cb73-1117"><a href="#cb73-1117" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="op">+</span> market_returns[<span class="st">"mkt_excess"</span>])</span>
<span id="cb73-1118"><a href="#cb73-1118" aria-hidden="true" tabindex="-1"></a>    .rolling(window<span class="op">=</span><span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb73-1119"><a href="#cb73-1119" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1120"><a href="#cb73-1120" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1121"><a href="#cb73-1121" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1122"><a href="#cb73-1122" aria-hidden="true" tabindex="-1"></a>market_returns[<span class="st">"market_state"</span>] <span class="op">=</span> np.where(</span>
<span id="cb73-1123"><a href="#cb73-1123" aria-hidden="true" tabindex="-1"></a>    market_returns[<span class="st">"mkt_cum_12m"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="st">"UP"</span>, <span class="st">"DOWN"</span></span>
<span id="cb73-1124"><a href="#cb73-1124" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1125"><a href="#cb73-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1126"><a href="#cb73-1126" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with momentum returns</span></span>
<span id="cb73-1127"><a href="#cb73-1127" aria-hidden="true" tabindex="-1"></a>ewret_states <span class="op">=</span> ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].merge(</span>
<span id="cb73-1128"><a href="#cb73-1128" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"market_state"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-1129"><a href="#cb73-1129" aria-hidden="true" tabindex="-1"></a>).dropna()</span>
<span id="cb73-1130"><a href="#cb73-1130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1131"><a href="#cb73-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1134"><a href="#cb73-1134" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1135"><a href="#cb73-1135" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-market-states</span></span>
<span id="cb73-1136"><a href="#cb73-1136" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Momentum long-short returns conditional on market states. UP markets are defined as periods where the cumulative market return over the prior 12 months is positive; DOWN markets are periods with negative prior 12-month returns."</span></span>
<span id="cb73-1137"><a href="#cb73-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1138"><a href="#cb73-1138" aria-hidden="true" tabindex="-1"></a>state_stats <span class="op">=</span> []</span>
<span id="cb73-1139"><a href="#cb73-1139" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> state <span class="kw">in</span> [<span class="st">"UP"</span>, <span class="st">"DOWN"</span>]:</span>
<span id="cb73-1140"><a href="#cb73-1140" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> ewret_states.query(<span class="ss">f"market_state == '</span><span class="sc">{</span>state<span class="sc">}</span><span class="ss">'"</span>)[<span class="st">"long_short"</span>]</span>
<span id="cb73-1141"><a href="#cb73-1141" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(subset)</span>
<span id="cb73-1142"><a href="#cb73-1142" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> subset.mean()</span>
<span id="cb73-1143"><a href="#cb73-1143" aria-hidden="true" tabindex="-1"></a>    std_ret <span class="op">=</span> subset.std()</span>
<span id="cb73-1144"><a href="#cb73-1144" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n)) <span class="cf">if</span> std_ret <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb73-1145"><a href="#cb73-1145" aria-hidden="true" tabindex="-1"></a>    p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>)) <span class="cf">if</span> <span class="kw">not</span> np.isnan(t_stat) <span class="cf">else</span> np.nan</span>
<span id="cb73-1146"><a href="#cb73-1146" aria-hidden="true" tabindex="-1"></a>    state_stats.append({</span>
<span id="cb73-1147"><a href="#cb73-1147" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Market State"</span>: state,</span>
<span id="cb73-1148"><a href="#cb73-1148" aria-hidden="true" tabindex="-1"></a>        <span class="st">"N Months"</span>: n,</span>
<span id="cb73-1149"><a href="#cb73-1149" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Mean (%)"</span>: mean_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb73-1150"><a href="#cb73-1150" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Std (%)"</span>: std_ret <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb73-1151"><a href="#cb73-1151" aria-hidden="true" tabindex="-1"></a>        <span class="st">"t-stat"</span>: t_stat,</span>
<span id="cb73-1152"><a href="#cb73-1152" aria-hidden="true" tabindex="-1"></a>        <span class="st">"p-value"</span>: p_val</span>
<span id="cb73-1153"><a href="#cb73-1153" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb73-1154"><a href="#cb73-1154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1155"><a href="#cb73-1155" aria-hidden="true" tabindex="-1"></a>state_stats_df <span class="op">=</span> pd.DataFrame(state_stats).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb73-1156"><a href="#cb73-1156" aria-hidden="true" tabindex="-1"></a>state_stats_df</span>
<span id="cb73-1157"><a href="#cb73-1157" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1158"><a href="#cb73-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1161"><a href="#cb73-1161" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1162"><a href="#cb73-1162" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-momentum-states</span></span>
<span id="cb73-1163"><a href="#cb73-1163" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of monthly momentum returns by market state. The box plots show the distribution of long-short momentum returns separately for UP and DOWN market states, defined by the sign of the prior 12-month cumulative market return."</span></span>
<span id="cb73-1164"><a href="#cb73-1164" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Side-by-side box plots comparing the distribution of momentum returns in UP versus DOWN market states."</span></span>
<span id="cb73-1165"><a href="#cb73-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1166"><a href="#cb73-1166" aria-hidden="true" tabindex="-1"></a>plot_states <span class="op">=</span> (</span>
<span id="cb73-1167"><a href="#cb73-1167" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_states, aes(x<span class="op">=</span><span class="st">"market_state"</span>, y<span class="op">=</span><span class="st">"long_short"</span>, </span>
<span id="cb73-1168"><a href="#cb73-1168" aria-hidden="true" tabindex="-1"></a>                              fill<span class="op">=</span><span class="st">"market_state"</span>)) <span class="op">+</span></span>
<span id="cb73-1169"><a href="#cb73-1169" aria-hidden="true" tabindex="-1"></a>    geom_boxplot(alpha<span class="op">=</span><span class="fl">0.7</span>) <span class="op">+</span></span>
<span id="cb73-1170"><a href="#cb73-1170" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb73-1171"><a href="#cb73-1171" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-1172"><a href="#cb73-1172" aria-hidden="true" tabindex="-1"></a>    scale_fill_manual(values<span class="op">=</span>{<span class="st">"UP"</span>: <span class="st">"#1f77b4"</span>, <span class="st">"DOWN"</span>: <span class="st">"#d62728"</span>}) <span class="op">+</span></span>
<span id="cb73-1173"><a href="#cb73-1173" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-1174"><a href="#cb73-1174" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Market State (Prior 12-Month Return)"</span>,</span>
<span id="cb73-1175"><a href="#cb73-1175" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Monthly Long-Short Return"</span>,</span>
<span id="cb73-1176"><a href="#cb73-1176" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Returns by Market State"</span></span>
<span id="cb73-1177"><a href="#cb73-1177" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1178"><a href="#cb73-1178" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1179"><a href="#cb73-1179" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb73-1180"><a href="#cb73-1180" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>),</span>
<span id="cb73-1181"><a href="#cb73-1181" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"none"</span></span>
<span id="cb73-1182"><a href="#cb73-1182" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1183"><a href="#cb73-1183" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1184"><a href="#cb73-1184" aria-hidden="true" tabindex="-1"></a>plot_states</span>
<span id="cb73-1185"><a href="#cb73-1185" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1186"><a href="#cb73-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1187"><a href="#cb73-1187" aria-hidden="true" tabindex="-1"></a><span class="fu">## Momentum Crashes</span></span>
<span id="cb73-1188"><a href="#cb73-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1189"><a href="#cb73-1189" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Momentum Drawdowns</span></span>
<span id="cb73-1190"><a href="#cb73-1190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1191"><a href="#cb73-1191" aria-hidden="true" tabindex="-1"></a>One of the most important risk characteristics of momentum strategies is their susceptibility to sudden, severe losses—known as momentum crashes. @daniel2016momentum document that momentum strategies experience infrequent but extreme losses, typically during market rebounds following bear markets. These crashes occur because the loser portfolio, which has been short, is heavily loaded with high-beta stocks that surge when markets reverse.</span>
<span id="cb73-1192"><a href="#cb73-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1193"><a href="#cb73-1193" aria-hidden="true" tabindex="-1"></a>We identify the worst drawdowns of the momentum strategy and examine their market context.</span>
<span id="cb73-1194"><a href="#cb73-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1197"><a href="#cb73-1197" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1198"><a href="#cb73-1198" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-worst-months</span></span>
<span id="cb73-1199"><a href="#cb73-1199" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Ten worst months for the momentum long-short strategy. The table reports the date, long-short return, winner return, loser return, and concurrent market return for the ten months with the largest momentum losses."</span></span>
<span id="cb73-1200"><a href="#cb73-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1201"><a href="#cb73-1201" aria-hidden="true" tabindex="-1"></a>worst_months <span class="op">=</span> (ewret_wide</span>
<span id="cb73-1202"><a href="#cb73-1202" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"long_short"</span>, <span class="st">"winners"</span>, <span class="st">"losers"</span>]]</span>
<span id="cb73-1203"><a href="#cb73-1203" aria-hidden="true" tabindex="-1"></a>    .merge(factors_ff3_monthly[[<span class="st">"date"</span>, <span class="st">"mkt_excess"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb73-1204"><a href="#cb73-1204" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"long_short"</span>)</span>
<span id="cb73-1205"><a href="#cb73-1205" aria-hidden="true" tabindex="-1"></a>    .head(<span class="dv">10</span>)</span>
<span id="cb73-1206"><a href="#cb73-1206" aria-hidden="true" tabindex="-1"></a>    .assign(</span>
<span id="cb73-1207"><a href="#cb73-1207" aria-hidden="true" tabindex="-1"></a>        long_short_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"long_short"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb73-1208"><a href="#cb73-1208" aria-hidden="true" tabindex="-1"></a>        winners_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"winners"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb73-1209"><a href="#cb73-1209" aria-hidden="true" tabindex="-1"></a>        losers_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"losers"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>),</span>
<span id="cb73-1210"><a href="#cb73-1210" aria-hidden="true" tabindex="-1"></a>        mkt_pct<span class="op">=</span><span class="kw">lambda</span> x: (x[<span class="st">"mkt_excess"</span>] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb73-1211"><a href="#cb73-1211" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1212"><a href="#cb73-1212" aria-hidden="true" tabindex="-1"></a>    [[<span class="st">"date"</span>, <span class="st">"long_short_pct"</span>, <span class="st">"winners_pct"</span>, <span class="st">"losers_pct"</span>, <span class="st">"mkt_pct"</span>]]</span>
<span id="cb73-1213"><a href="#cb73-1213" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{</span>
<span id="cb73-1214"><a href="#cb73-1214" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: <span class="st">"Date"</span>,</span>
<span id="cb73-1215"><a href="#cb73-1215" aria-hidden="true" tabindex="-1"></a>        <span class="st">"long_short_pct"</span>: <span class="st">"L/S (%)"</span>,</span>
<span id="cb73-1216"><a href="#cb73-1216" aria-hidden="true" tabindex="-1"></a>        <span class="st">"winners_pct"</span>: <span class="st">"Winners (%)"</span>,</span>
<span id="cb73-1217"><a href="#cb73-1217" aria-hidden="true" tabindex="-1"></a>        <span class="st">"losers_pct"</span>: <span class="st">"Losers (%)"</span>,</span>
<span id="cb73-1218"><a href="#cb73-1218" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mkt_pct"</span>: <span class="st">"Market (%)"</span></span>
<span id="cb73-1219"><a href="#cb73-1219" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb73-1220"><a href="#cb73-1220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1221"><a href="#cb73-1221" aria-hidden="true" tabindex="-1"></a>worst_months</span>
<span id="cb73-1222"><a href="#cb73-1222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1223"><a href="#cb73-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1224"><a href="#cb73-1224" aria-hidden="true" tabindex="-1"></a><span class="fu">### Maximum Drawdown Analysis</span></span>
<span id="cb73-1225"><a href="#cb73-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1226"><a href="#cb73-1226" aria-hidden="true" tabindex="-1"></a>The maximum drawdown provides a measure of the worst peak-to-trough decline experienced by the strategy. This metric is particularly relevant for practitioners evaluating the risk of momentum strategies.</span>
<span id="cb73-1227"><a href="#cb73-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1230"><a href="#cb73-1230" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1231"><a href="#cb73-1231" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute running maximum and drawdown</span></span>
<span id="cb73-1232"><a href="#cb73-1232" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"cum_wealth"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ewret_wide[<span class="st">"long_short"</span>]).cumprod()</span>
<span id="cb73-1233"><a href="#cb73-1233" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"running_max"</span>] <span class="op">=</span> ewret_wide[<span class="st">"cum_wealth"</span>].cummax()</span>
<span id="cb73-1234"><a href="#cb73-1234" aria-hidden="true" tabindex="-1"></a>ewret_wide[<span class="st">"drawdown"</span>] <span class="op">=</span> (</span>
<span id="cb73-1235"><a href="#cb73-1235" aria-hidden="true" tabindex="-1"></a>    ewret_wide[<span class="st">"cum_wealth"</span>] <span class="op">/</span> ewret_wide[<span class="st">"running_max"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1236"><a href="#cb73-1236" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1237"><a href="#cb73-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1238"><a href="#cb73-1238" aria-hidden="true" tabindex="-1"></a>max_dd <span class="op">=</span> ewret_wide[<span class="st">"drawdown"</span>].<span class="bu">min</span>()</span>
<span id="cb73-1239"><a href="#cb73-1239" aria-hidden="true" tabindex="-1"></a>max_dd_date <span class="op">=</span> ewret_wide.loc[ewret_wide[<span class="st">"drawdown"</span>].idxmin(), <span class="st">"date"</span>]</span>
<span id="cb73-1240"><a href="#cb73-1240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1241"><a href="#cb73-1241" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Maximum drawdown: </span><span class="sc">{</span>max_dd<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb73-1242"><a href="#cb73-1242" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date of maximum drawdown: </span><span class="sc">{</span>max_dd_date<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-1243"><a href="#cb73-1243" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1244"><a href="#cb73-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1247"><a href="#cb73-1247" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1248"><a href="#cb73-1248" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-drawdown</span></span>
<span id="cb73-1249"><a href="#cb73-1249" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Drawdown of the momentum long-short strategy over time. The chart shows the percentage decline from the previous peak in cumulative wealth. Deeper drawdowns represent more severe momentum crashes."</span></span>
<span id="cb73-1250"><a href="#cb73-1250" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A time series chart showing the drawdown of the momentum strategy, with several deep troughs corresponding to momentum crash episodes."</span></span>
<span id="cb73-1251"><a href="#cb73-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1252"><a href="#cb73-1252" aria-hidden="true" tabindex="-1"></a>plot_dd <span class="op">=</span> (</span>
<span id="cb73-1253"><a href="#cb73-1253" aria-hidden="true" tabindex="-1"></a>    ggplot(ewret_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"drawdown"</span>)) <span class="op">+</span></span>
<span id="cb73-1254"><a href="#cb73-1254" aria-hidden="true" tabindex="-1"></a>    geom_area(fill<span class="op">=</span><span class="st">"#d62728"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb73-1255"><a href="#cb73-1255" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#d62728"</span>, size<span class="op">=</span><span class="fl">0.5</span>) <span class="op">+</span></span>
<span id="cb73-1256"><a href="#cb73-1256" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-1257"><a href="#cb73-1257" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-1258"><a href="#cb73-1258" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Drawdown"</span>,</span>
<span id="cb73-1259"><a href="#cb73-1259" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Momentum Strategy Drawdown"</span></span>
<span id="cb73-1260"><a href="#cb73-1260" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1261"><a href="#cb73-1261" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1262"><a href="#cb73-1262" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb73-1263"><a href="#cb73-1263" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1264"><a href="#cb73-1264" aria-hidden="true" tabindex="-1"></a>plot_dd</span>
<span id="cb73-1265"><a href="#cb73-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1266"><a href="#cb73-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1267"><a href="#cb73-1267" aria-hidden="true" tabindex="-1"></a><span class="fu">## Value-Weighted Momentum Portfolios</span></span>
<span id="cb73-1268"><a href="#cb73-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1269"><a href="#cb73-1269" aria-hidden="true" tabindex="-1"></a>The baseline @jegadeesh1993returns implementation uses equally weighted portfolios. However, equally weighted returns can be dominated by small, illiquid stocks that may be difficult to trade in practice. Value-weighted portfolios, where each stock's contribution is proportional to its market capitalization, provide a more investable benchmark and are more representative of the returns that large investors could actually achieve.</span>
<span id="cb73-1270"><a href="#cb73-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1273"><a href="#cb73-1273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1274"><a href="#cb73-1274" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> momentum_strategy_vw(data, J, K, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb73-1275"><a href="#cb73-1275" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb73-1276"><a href="#cb73-1276" aria-hidden="true" tabindex="-1"></a><span class="co">    Value-weighted momentum strategy implementation.</span></span>
<span id="cb73-1277"><a href="#cb73-1277" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-1278"><a href="#cb73-1278" aria-hidden="true" tabindex="-1"></a><span class="co">    Same as the equally-weighted version but uses lagged market </span></span>
<span id="cb73-1279"><a href="#cb73-1279" aria-hidden="true" tabindex="-1"></a><span class="co">    capitalization as weights when computing portfolio returns.</span></span>
<span id="cb73-1280"><a href="#cb73-1280" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-1281"><a href="#cb73-1281" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb73-1282"><a href="#cb73-1282" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb73-1283"><a href="#cb73-1283" aria-hidden="true" tabindex="-1"></a><span class="co">    data : pd.DataFrame</span></span>
<span id="cb73-1284"><a href="#cb73-1284" aria-hidden="true" tabindex="-1"></a><span class="co">        Panel with columns: symbol, date, ret, mktcap_lag.</span></span>
<span id="cb73-1285"><a href="#cb73-1285" aria-hidden="true" tabindex="-1"></a><span class="co">    J : int</span></span>
<span id="cb73-1286"><a href="#cb73-1286" aria-hidden="true" tabindex="-1"></a><span class="co">        Formation period in months.</span></span>
<span id="cb73-1287"><a href="#cb73-1287" aria-hidden="true" tabindex="-1"></a><span class="co">    K : int</span></span>
<span id="cb73-1288"><a href="#cb73-1288" aria-hidden="true" tabindex="-1"></a><span class="co">        Holding period in months.</span></span>
<span id="cb73-1289"><a href="#cb73-1289" aria-hidden="true" tabindex="-1"></a><span class="co">    n_portfolios : int</span></span>
<span id="cb73-1290"><a href="#cb73-1290" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of portfolios.</span></span>
<span id="cb73-1291"><a href="#cb73-1291" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb73-1292"><a href="#cb73-1292" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb73-1293"><a href="#cb73-1293" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb73-1294"><a href="#cb73-1294" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb73-1295"><a href="#cb73-1295" aria-hidden="true" tabindex="-1"></a><span class="co">        Monthly value-weighted portfolio returns.</span></span>
<span id="cb73-1296"><a href="#cb73-1296" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb73-1297"><a href="#cb73-1297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Formation period returns</span></span>
<span id="cb73-1298"><a href="#cb73-1298" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).copy()</span>
<span id="cb73-1299"><a href="#cb73-1299" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_ret"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">+</span> df[<span class="st">"ret"</span>]</span>
<span id="cb73-1300"><a href="#cb73-1300" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cum_return"</span>] <span class="op">=</span> (</span>
<span id="cb73-1301"><a href="#cb73-1301" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"symbol"</span>)[<span class="st">"gross_ret"</span>]</span>
<span id="cb73-1302"><a href="#cb73-1302" aria-hidden="true" tabindex="-1"></a>        .rolling(window<span class="op">=</span>J, min_periods<span class="op">=</span>J)</span>
<span id="cb73-1303"><a href="#cb73-1303" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(np.prod, raw<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1304"><a href="#cb73-1304" aria-hidden="true" tabindex="-1"></a>        .reset_index(level<span class="op">=</span><span class="dv">0</span>, drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1305"><a href="#cb73-1305" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1306"><a href="#cb73-1306" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1307"><a href="#cb73-1307" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop(columns<span class="op">=</span>[<span class="st">"gross_ret"</span>]).dropna(subset<span class="op">=</span>[<span class="st">"cum_return"</span>])</span>
<span id="cb73-1308"><a href="#cb73-1308" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1309"><a href="#cb73-1309" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Portfolio assignment using transform (fast)</span></span>
<span id="cb73-1310"><a href="#cb73-1310" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"momr"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>, observed<span class="op">=</span><span class="va">True</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb73-1311"><a href="#cb73-1311" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb73-1312"><a href="#cb73-1312" aria-hidden="true" tabindex="-1"></a>            x,</span>
<span id="cb73-1313"><a href="#cb73-1313" aria-hidden="true" tabindex="-1"></a>            q<span class="op">=</span>n_portfolios,</span>
<span id="cb73-1314"><a href="#cb73-1314" aria-hidden="true" tabindex="-1"></a>            labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb73-1315"><a href="#cb73-1315" aria-hidden="true" tabindex="-1"></a>            duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb73-1316"><a href="#cb73-1316" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb73-1317"><a href="#cb73-1317" aria-hidden="true" tabindex="-1"></a>    ).astype(<span class="st">'Int64'</span>)</span>
<span id="cb73-1318"><a href="#cb73-1318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1319"><a href="#cb73-1319" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill NaNs with rank-based assignment</span></span>
<span id="cb73-1320"><a href="#cb73-1320" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> df[<span class="st">"momr"</span>].isna()</span>
<span id="cb73-1321"><a href="#cb73-1321" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb73-1322"><a href="#cb73-1322" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">"momr"</span>] <span class="op">=</span> df.loc[mask].groupby(<span class="st">"date"</span>)[<span class="st">"cum_return"</span>].transform(</span>
<span id="cb73-1323"><a href="#cb73-1323" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: pd.qcut(</span>
<span id="cb73-1324"><a href="#cb73-1324" aria-hidden="true" tabindex="-1"></a>                x.rank(method<span class="op">=</span><span class="st">"first"</span>),</span>
<span id="cb73-1325"><a href="#cb73-1325" aria-hidden="true" tabindex="-1"></a>                q<span class="op">=</span><span class="bu">min</span>(n_portfolios, <span class="bu">len</span>(x.unique())),</span>
<span id="cb73-1326"><a href="#cb73-1326" aria-hidden="true" tabindex="-1"></a>                labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb73-1327"><a href="#cb73-1327" aria-hidden="true" tabindex="-1"></a>                duplicates<span class="op">=</span><span class="st">"drop"</span></span>
<span id="cb73-1328"><a href="#cb73-1328" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb73-1329"><a href="#cb73-1329" aria-hidden="true" tabindex="-1"></a>        ).astype(<span class="st">'Int64'</span>) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb73-1330"><a href="#cb73-1330" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1331"><a href="#cb73-1331" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Holding period</span></span>
<span id="cb73-1332"><a href="#cb73-1332" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{<span class="st">"date"</span>: <span class="st">"form_date"</span>})</span>
<span id="cb73-1333"><a href="#cb73-1333" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate1"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthBegin(<span class="dv">1</span>)</span>
<span id="cb73-1334"><a href="#cb73-1334" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"hdate2"</span>] <span class="op">=</span> df[<span class="st">"form_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(K)</span>
<span id="cb73-1335"><a href="#cb73-1335" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1336"><a href="#cb73-1336" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 4: Merge with holding period returns AND weights</span></span>
<span id="cb73-1337"><a href="#cb73-1337" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> df[</span>
<span id="cb73-1338"><a href="#cb73-1338" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb73-1339"><a href="#cb73-1339" aria-hidden="true" tabindex="-1"></a>    ].merge(</span>
<span id="cb73-1340"><a href="#cb73-1340" aria-hidden="true" tabindex="-1"></a>        data[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>, <span class="st">"mktcap_lag"</span>]].rename(</span>
<span id="cb73-1341"><a href="#cb73-1341" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"hret"</span>, <span class="st">"date"</span>: <span class="st">"hdate"</span>}</span>
<span id="cb73-1342"><a href="#cb73-1342" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb73-1343"><a href="#cb73-1343" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb73-1344"><a href="#cb73-1344" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-1345"><a href="#cb73-1345" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1346"><a href="#cb73-1346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1347"><a href="#cb73-1347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use boolean indexing instead of query (faster)</span></span>
<span id="cb73-1348"><a href="#cb73-1348" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[</span>
<span id="cb73-1349"><a href="#cb73-1349" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&gt;=</span> port_ret[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb73-1350"><a href="#cb73-1350" aria-hidden="true" tabindex="-1"></a>        (port_ret[<span class="st">"hdate"</span>] <span class="op">&lt;=</span> port_ret[<span class="st">"hdate2"</span>])</span>
<span id="cb73-1351"><a href="#cb73-1351" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb73-1352"><a href="#cb73-1352" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret.dropna(subset<span class="op">=</span>[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb73-1353"><a href="#cb73-1353" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> port_ret[port_ret[<span class="st">"mktcap_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb73-1354"><a href="#cb73-1354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1355"><a href="#cb73-1355" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 5: Value-weighted returns within each cohort</span></span>
<span id="cb73-1356"><a href="#cb73-1356" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vw_mean(group):</span>
<span id="cb73-1357"><a href="#cb73-1357" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">"mktcap_lag"</span>]</span>
<span id="cb73-1358"><a href="#cb73-1358" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weights.<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb73-1359"><a href="#cb73-1359" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> np.nan</span>
<span id="cb73-1360"><a href="#cb73-1360" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.average(group[<span class="st">"hret"</span>], weights<span class="op">=</span>weights)</span>
<span id="cb73-1361"><a href="#cb73-1361" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1362"><a href="#cb73-1362" aria-hidden="true" tabindex="-1"></a>    cohort_ret <span class="op">=</span> (port_ret</span>
<span id="cb73-1363"><a href="#cb73-1363" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb73-1364"><a href="#cb73-1364" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(vw_mean, include_groups<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb73-1365"><a href="#cb73-1365" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">"cohort_ret"</span>)</span>
<span id="cb73-1366"><a href="#cb73-1366" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1367"><a href="#cb73-1367" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1368"><a href="#cb73-1368" aria-hidden="true" tabindex="-1"></a>    monthly_ret <span class="op">=</span> (cohort_ret</span>
<span id="cb73-1369"><a href="#cb73-1369" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"hdate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb73-1370"><a href="#cb73-1370" aria-hidden="true" tabindex="-1"></a>        .agg(vwret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-1371"><a href="#cb73-1371" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb73-1372"><a href="#cb73-1372" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"hdate"</span>: <span class="st">"date"</span>})</span>
<span id="cb73-1373"><a href="#cb73-1373" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1374"><a href="#cb73-1374" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1375"><a href="#cb73-1375" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 6: Long-short</span></span>
<span id="cb73-1376"><a href="#cb73-1376" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> monthly_ret.pivot(</span>
<span id="cb73-1377"><a href="#cb73-1377" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"vwret"</span></span>
<span id="cb73-1378"><a href="#cb73-1378" aria-hidden="true" tabindex="-1"></a>    ).reset_index()</span>
<span id="cb73-1379"><a href="#cb73-1379" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1380"><a href="#cb73-1380" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle variable number of portfolios</span></span>
<span id="cb73-1381"><a href="#cb73-1381" aria-hidden="true" tabindex="-1"></a>    n_cols <span class="op">=</span> <span class="bu">len</span>(wide.columns) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1382"><a href="#cb73-1382" aria-hidden="true" tabindex="-1"></a>    wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_cols <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb73-1383"><a href="#cb73-1383" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"winners"</span>] <span class="op">=</span> wide[<span class="ss">f"port</span><span class="sc">{</span>n_cols<span class="sc">}</span><span class="ss">"</span>]</span>
<span id="cb73-1384"><a href="#cb73-1384" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"losers"</span>] <span class="op">=</span> wide[<span class="st">"port1"</span>]</span>
<span id="cb73-1385"><a href="#cb73-1385" aria-hidden="true" tabindex="-1"></a>    wide[<span class="st">"long_short"</span>] <span class="op">=</span> wide[<span class="st">"winners"</span>] <span class="op">-</span> wide[<span class="st">"losers"</span>]</span>
<span id="cb73-1386"><a href="#cb73-1386" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-1387"><a href="#cb73-1387" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly_ret, wide</span>
<span id="cb73-1388"><a href="#cb73-1388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1389"><a href="#cb73-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1392"><a href="#cb73-1392" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1393"><a href="#cb73-1393" aria-hidden="true" tabindex="-1"></a><span class="co"># Run value-weighted J=6, K=6 strategy</span></span>
<span id="cb73-1394"><a href="#cb73-1394" aria-hidden="true" tabindex="-1"></a>_, vw_results <span class="op">=</span> momentum_strategy_vw(prices_clean, J<span class="op">=</span><span class="dv">6</span>, K<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb73-1395"><a href="#cb73-1395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1396"><a href="#cb73-1396" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Value-Weighted Momentum Strategy (J=6, K=6)"</span>)</span>
<span id="cb73-1397"><a href="#cb73-1397" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">50</span>)</span>
<span id="cb73-1398"><a href="#cb73-1398" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio Statistics:"</span>)</span>
<span id="cb73-1399"><a href="#cb73-1399" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(vw_results[[<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb73-1400"><a href="#cb73-1400" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1401"><a href="#cb73-1401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1402"><a href="#cb73-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1403"><a href="#cb73-1403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1406"><a href="#cb73-1406" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1407"><a href="#cb73-1407" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ew-vs-vw</span></span>
<span id="cb73-1408"><a href="#cb73-1408" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Comparison of equally weighted (EW) and value-weighted (VW) momentum strategies for J=6, K=6. The table reports mean monthly returns, t-statistics, and p-values for winners, losers, and long-short portfolios under both weighting schemes."</span></span>
<span id="cb73-1409"><a href="#cb73-1409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1410"><a href="#cb73-1410" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> []</span>
<span id="cb73-1411"><a href="#cb73-1411" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> scheme, df <span class="kw">in</span> [(<span class="st">"EW"</span>, ewret_wide), (<span class="st">"VW"</span>, vw_results)]:</span>
<span id="cb73-1412"><a href="#cb73-1412" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"winners"</span>, <span class="st">"losers"</span>, <span class="st">"long_short"</span>]:</span>
<span id="cb73-1413"><a href="#cb73-1413" aria-hidden="true" tabindex="-1"></a>        series <span class="op">=</span> df[col].dropna()</span>
<span id="cb73-1414"><a href="#cb73-1414" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="bu">len</span>(series)</span>
<span id="cb73-1415"><a href="#cb73-1415" aria-hidden="true" tabindex="-1"></a>        mean_ret <span class="op">=</span> series.mean()</span>
<span id="cb73-1416"><a href="#cb73-1416" aria-hidden="true" tabindex="-1"></a>        std_ret <span class="op">=</span> series.std()</span>
<span id="cb73-1417"><a href="#cb73-1417" aria-hidden="true" tabindex="-1"></a>        t_stat <span class="op">=</span> mean_ret <span class="op">/</span> (std_ret <span class="op">/</span> np.sqrt(n))</span>
<span id="cb73-1418"><a href="#cb73-1418" aria-hidden="true" tabindex="-1"></a>        p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df<span class="op">=</span>n<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb73-1419"><a href="#cb73-1419" aria-hidden="true" tabindex="-1"></a>        comparison.append({</span>
<span id="cb73-1420"><a href="#cb73-1420" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Weighting"</span>: scheme,</span>
<span id="cb73-1421"><a href="#cb73-1421" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Portfolio"</span>: col.replace(<span class="st">"_"</span>, <span class="st">" "</span>).title(),</span>
<span id="cb73-1422"><a href="#cb73-1422" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Mean (%)"</span>: <span class="bu">round</span>(mean_ret <span class="op">*</span> <span class="dv">100</span>, <span class="dv">4</span>),</span>
<span id="cb73-1423"><a href="#cb73-1423" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Std (%)"</span>: <span class="bu">round</span>(std_ret <span class="op">*</span> <span class="dv">100</span>, <span class="dv">4</span>),</span>
<span id="cb73-1424"><a href="#cb73-1424" aria-hidden="true" tabindex="-1"></a>            <span class="st">"t-stat"</span>: <span class="bu">round</span>(t_stat, <span class="dv">2</span>),</span>
<span id="cb73-1425"><a href="#cb73-1425" aria-hidden="true" tabindex="-1"></a>            <span class="st">"p-value"</span>: <span class="bu">round</span>(p_val, <span class="dv">4</span>)</span>
<span id="cb73-1426"><a href="#cb73-1426" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb73-1427"><a href="#cb73-1427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1428"><a href="#cb73-1428" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(comparison)</span>
<span id="cb73-1429"><a href="#cb73-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1430"><a href="#cb73-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1433"><a href="#cb73-1433" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1434"><a href="#cb73-1434" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ew-vs-vw</span></span>
<span id="cb73-1435"><a href="#cb73-1435" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of equally weighted (EW) versus value-weighted (VW) long-short momentum strategies. Differences between the two lines reflect the impact of firm size on momentum profitability."</span></span>
<span id="cb73-1436"><a href="#cb73-1436" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart comparing the cumulative returns of EW and VW momentum long-short strategies over time."</span></span>
<span id="cb73-1437"><a href="#cb73-1437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1438"><a href="#cb73-1438" aria-hidden="true" tabindex="-1"></a>vw_results <span class="op">=</span> vw_results.sort_values(<span class="st">"date"</span>)</span>
<span id="cb73-1439"><a href="#cb73-1439" aria-hidden="true" tabindex="-1"></a>vw_results[<span class="st">"cumret_ls_vw"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> vw_results[<span class="st">"long_short"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1440"><a href="#cb73-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1441"><a href="#cb73-1441" aria-hidden="true" tabindex="-1"></a>ew_data <span class="op">=</span> (ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]]</span>
<span id="cb73-1442"><a href="#cb73-1442" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"cumret"</span>})</span>
<span id="cb73-1443"><a href="#cb73-1443" aria-hidden="true" tabindex="-1"></a>    .assign(scheme<span class="op">=</span><span class="st">"Equally Weighted"</span>)</span>
<span id="cb73-1444"><a href="#cb73-1444" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1445"><a href="#cb73-1445" aria-hidden="true" tabindex="-1"></a>ew_data[<span class="st">"cumret"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ew_data[<span class="st">"cumret"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1446"><a href="#cb73-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1447"><a href="#cb73-1447" aria-hidden="true" tabindex="-1"></a>vw_data <span class="op">=</span> (vw_results[[<span class="st">"date"</span>, <span class="st">"cumret_ls_vw"</span>]]</span>
<span id="cb73-1448"><a href="#cb73-1448" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"cumret_ls_vw"</span>: <span class="st">"cumret"</span>})</span>
<span id="cb73-1449"><a href="#cb73-1449" aria-hidden="true" tabindex="-1"></a>    .assign(scheme<span class="op">=</span><span class="st">"Value Weighted"</span>)</span>
<span id="cb73-1450"><a href="#cb73-1450" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1451"><a href="#cb73-1451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1452"><a href="#cb73-1452" aria-hidden="true" tabindex="-1"></a>ew_vs_vw <span class="op">=</span> pd.concat([ew_data, vw_data], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb73-1453"><a href="#cb73-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1454"><a href="#cb73-1454" aria-hidden="true" tabindex="-1"></a>plot_ew_vw <span class="op">=</span> (</span>
<span id="cb73-1455"><a href="#cb73-1455" aria-hidden="true" tabindex="-1"></a>    ggplot(ew_vs_vw, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret"</span>, color<span class="op">=</span><span class="st">"scheme"</span>)) <span class="op">+</span></span>
<span id="cb73-1456"><a href="#cb73-1456" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb73-1457"><a href="#cb73-1457" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-1458"><a href="#cb73-1458" aria-hidden="true" tabindex="-1"></a>    scale_color_manual(values<span class="op">=</span>[<span class="st">"#1f77b4"</span>, <span class="st">"#ff7f0e"</span>]) <span class="op">+</span></span>
<span id="cb73-1459"><a href="#cb73-1459" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-1460"><a href="#cb73-1460" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb73-1461"><a href="#cb73-1461" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Weighting Scheme"</span>,</span>
<span id="cb73-1462"><a href="#cb73-1462" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"EW vs. VW Momentum Long-Short Strategy"</span></span>
<span id="cb73-1463"><a href="#cb73-1463" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1464"><a href="#cb73-1464" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1465"><a href="#cb73-1465" aria-hidden="true" tabindex="-1"></a>    theme(</span>
<span id="cb73-1466"><a href="#cb73-1466" aria-hidden="true" tabindex="-1"></a>        figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb73-1467"><a href="#cb73-1467" aria-hidden="true" tabindex="-1"></a>        legend_position<span class="op">=</span><span class="st">"bottom"</span></span>
<span id="cb73-1468"><a href="#cb73-1468" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb73-1469"><a href="#cb73-1469" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1470"><a href="#cb73-1470" aria-hidden="true" tabindex="-1"></a>plot_ew_vw</span>
<span id="cb73-1471"><a href="#cb73-1471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1472"><a href="#cb73-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1473"><a href="#cb73-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1474"><a href="#cb73-1474" aria-hidden="true" tabindex="-1"></a><span class="fu">## Daily Momentum Analysis</span></span>
<span id="cb73-1475"><a href="#cb73-1475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1476"><a href="#cb73-1476" aria-hidden="true" tabindex="-1"></a>While momentum strategies are typically evaluated at the monthly frequency following @jegadeesh1993returns, analyzing daily return patterns provides additional insights into the dynamics of momentum profits. Daily data allows us to examine how momentum profits accrue within the holding period, measure intra-month volatility of the strategy, and compute more precise risk measures.</span>
<span id="cb73-1477"><a href="#cb73-1477" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1478"><a href="#cb73-1478" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Daily Data</span></span>
<span id="cb73-1479"><a href="#cb73-1479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1482"><a href="#cb73-1482" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1483"><a href="#cb73-1483" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> pd.read_sql_query(</span>
<span id="cb73-1484"><a href="#cb73-1484" aria-hidden="true" tabindex="-1"></a>    sql<span class="op">=</span>(<span class="st">"SELECT symbol, date, ret, ret_excess, mktcap_lag "</span></span>
<span id="cb73-1485"><a href="#cb73-1485" aria-hidden="true" tabindex="-1"></a>         <span class="st">"FROM prices_daily"</span>),</span>
<span id="cb73-1486"><a href="#cb73-1486" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1487"><a href="#cb73-1487" aria-hidden="true" tabindex="-1"></a>    parse_dates<span class="op">=</span>{<span class="st">"date"</span>}</span>
<span id="cb73-1488"><a href="#cb73-1488" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1489"><a href="#cb73-1489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1490"><a href="#cb73-1490" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1491"><a href="#cb73-1491" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>prices_daily[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1492"><a href="#cb73-1492" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb73-1493"><a href="#cb73-1493" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"to </span><span class="sc">{</span>prices_daily[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">.</span>date()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb73-1494"><a href="#cb73-1494" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1495"><a href="#cb73-1495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1496"><a href="#cb73-1496" aria-hidden="true" tabindex="-1"></a><span class="fu">### Daily Returns of Monthly Momentum Portfolios</span></span>
<span id="cb73-1497"><a href="#cb73-1497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1498"><a href="#cb73-1498" aria-hidden="true" tabindex="-1"></a>Rather than forming momentum portfolios at the daily frequency (which would require daily rebalancing and is impractical), we use the monthly portfolio assignments and track their daily returns. This gives us the daily return series of the monthly momentum strategy.</span>
<span id="cb73-1499"><a href="#cb73-1499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1502"><a href="#cb73-1502" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1503"><a href="#cb73-1503" aria-hidden="true" tabindex="-1"></a><span class="co"># # # Use the monthly portfolio assignments from the J=6 baseline</span></span>
<span id="cb73-1504"><a href="#cb73-1504" aria-hidden="true" tabindex="-1"></a>monthly_assignments <span class="op">=</span> portfolios_with_dates[</span>
<span id="cb73-1505"><a href="#cb73-1505" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"symbol"</span>, <span class="st">"form_date"</span>, <span class="st">"momr"</span>, <span class="st">"hdate1"</span>, <span class="st">"hdate2"</span>]</span>
<span id="cb73-1506"><a href="#cb73-1506" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb73-1507"><a href="#cb73-1507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1508"><a href="#cb73-1508" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with daily returns</span></span>
<span id="cb73-1509"><a href="#cb73-1509" aria-hidden="true" tabindex="-1"></a>daily_mom_returns <span class="op">=</span> monthly_assignments.merge(</span>
<span id="cb73-1510"><a href="#cb73-1510" aria-hidden="true" tabindex="-1"></a>    prices_daily[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>]].rename(</span>
<span id="cb73-1511"><a href="#cb73-1511" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">"ret"</span>: <span class="st">"dret"</span>, <span class="st">"date"</span>: <span class="st">"ddate"</span>}</span>
<span id="cb73-1512"><a href="#cb73-1512" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb73-1513"><a href="#cb73-1513" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"symbol"</span>,</span>
<span id="cb73-1514"><a href="#cb73-1514" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb73-1515"><a href="#cb73-1515" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1516"><a href="#cb73-1516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1517"><a href="#cb73-1517" aria-hidden="true" tabindex="-1"></a><span class="co"># Use boolean indexing instead of query</span></span>
<span id="cb73-1518"><a href="#cb73-1518" aria-hidden="true" tabindex="-1"></a>daily_mom_returns <span class="op">=</span> daily_mom_returns[</span>
<span id="cb73-1519"><a href="#cb73-1519" aria-hidden="true" tabindex="-1"></a>    (daily_mom_returns[<span class="st">"ddate"</span>] <span class="op">&gt;=</span> daily_mom_returns[<span class="st">"hdate1"</span>]) <span class="op">&amp;</span> </span>
<span id="cb73-1520"><a href="#cb73-1520" aria-hidden="true" tabindex="-1"></a>    (daily_mom_returns[<span class="st">"ddate"</span>] <span class="op">&lt;=</span> daily_mom_returns[<span class="st">"hdate2"</span>])</span>
<span id="cb73-1521"><a href="#cb73-1521" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb73-1522"><a href="#cb73-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1523"><a href="#cb73-1523" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily portfolio return observations: </span><span class="sc">{</span><span class="bu">len</span>(daily_mom_returns)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1524"><a href="#cb73-1524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1525"><a href="#cb73-1525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1528"><a href="#cb73-1528" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1529"><a href="#cb73-1529" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily equally weighted portfolio returns</span></span>
<span id="cb73-1530"><a href="#cb73-1530" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 1: Average within each cohort</span></span>
<span id="cb73-1531"><a href="#cb73-1531" aria-hidden="true" tabindex="-1"></a>daily_cohort_ret <span class="op">=</span> (daily_mom_returns</span>
<span id="cb73-1532"><a href="#cb73-1532" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"ddate"</span>, <span class="st">"momr"</span>, <span class="st">"form_date"</span>])</span>
<span id="cb73-1533"><a href="#cb73-1533" aria-hidden="true" tabindex="-1"></a>    .agg(cohort_ret<span class="op">=</span>(<span class="st">"dret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-1534"><a href="#cb73-1534" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-1535"><a href="#cb73-1535" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1536"><a href="#cb73-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1537"><a href="#cb73-1537" aria-hidden="true" tabindex="-1"></a><span class="co"># Stage 2: Average across cohorts</span></span>
<span id="cb73-1538"><a href="#cb73-1538" aria-hidden="true" tabindex="-1"></a>daily_ewret <span class="op">=</span> (daily_cohort_ret</span>
<span id="cb73-1539"><a href="#cb73-1539" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"ddate"</span>, <span class="st">"momr"</span>])</span>
<span id="cb73-1540"><a href="#cb73-1540" aria-hidden="true" tabindex="-1"></a>    .agg(ewret<span class="op">=</span>(<span class="st">"cohort_ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb73-1541"><a href="#cb73-1541" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-1542"><a href="#cb73-1542" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"ddate"</span>: <span class="st">"date"</span>})</span>
<span id="cb73-1543"><a href="#cb73-1543" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1544"><a href="#cb73-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1545"><a href="#cb73-1545" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute daily long-short returns</span></span>
<span id="cb73-1546"><a href="#cb73-1546" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_ewret.pivot(</span>
<span id="cb73-1547"><a href="#cb73-1547" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"momr"</span>, values<span class="op">=</span><span class="st">"ewret"</span></span>
<span id="cb73-1548"><a href="#cb73-1548" aria-hidden="true" tabindex="-1"></a>).reset_index()</span>
<span id="cb73-1549"><a href="#cb73-1549" aria-hidden="true" tabindex="-1"></a>daily_wide.columns <span class="op">=</span> [<span class="st">"date"</span>] <span class="op">+</span> [<span class="ss">f"port</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb73-1550"><a href="#cb73-1550" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"winners"</span>] <span class="op">=</span> daily_wide[<span class="st">"port10"</span>]</span>
<span id="cb73-1551"><a href="#cb73-1551" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"losers"</span>] <span class="op">=</span> daily_wide[<span class="st">"port1"</span>]</span>
<span id="cb73-1552"><a href="#cb73-1552" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"long_short"</span>] <span class="op">=</span> daily_wide[<span class="st">"winners"</span>] <span class="op">-</span> daily_wide[<span class="st">"losers"</span>]</span>
<span id="cb73-1553"><a href="#cb73-1553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1554"><a href="#cb73-1554" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily long-short return observations: </span><span class="sc">{</span><span class="bu">len</span>(daily_wide)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb73-1555"><a href="#cb73-1555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1556"><a href="#cb73-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1557"><a href="#cb73-1557" aria-hidden="true" tabindex="-1"></a><span class="fu">### Daily Cumulative Returns</span></span>
<span id="cb73-1558"><a href="#cb73-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1561"><a href="#cb73-1561" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1562"><a href="#cb73-1562" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-daily-cumret</span></span>
<span id="cb73-1563"><a href="#cb73-1563" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative daily returns of the momentum long-short strategy. This figure shows the same strategy as the monthly analysis but tracked at daily frequency, revealing intra-month dynamics and the precise timing of momentum gains and losses."</span></span>
<span id="cb73-1564"><a href="#cb73-1564" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A line chart showing the cumulative daily returns of the momentum long-short strategy, with finer granularity than the monthly version."</span></span>
<span id="cb73-1565"><a href="#cb73-1565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1566"><a href="#cb73-1566" aria-hidden="true" tabindex="-1"></a>daily_wide <span class="op">=</span> daily_wide.sort_values(<span class="st">"date"</span>)</span>
<span id="cb73-1567"><a href="#cb73-1567" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"cumret_ls"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> daily_wide[<span class="st">"long_short"</span>]).cumprod() <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb73-1568"><a href="#cb73-1568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1569"><a href="#cb73-1569" aria-hidden="true" tabindex="-1"></a>plot_daily_cumret <span class="op">=</span> (</span>
<span id="cb73-1570"><a href="#cb73-1570" aria-hidden="true" tabindex="-1"></a>    ggplot(daily_wide, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"cumret_ls"</span>)) <span class="op">+</span></span>
<span id="cb73-1571"><a href="#cb73-1571" aria-hidden="true" tabindex="-1"></a>    geom_line(size<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">"#2ca02c"</span>) <span class="op">+</span></span>
<span id="cb73-1572"><a href="#cb73-1572" aria-hidden="true" tabindex="-1"></a>    geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>) <span class="op">+</span></span>
<span id="cb73-1573"><a href="#cb73-1573" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-1574"><a href="#cb73-1574" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-1575"><a href="#cb73-1575" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Cumulative return"</span>,</span>
<span id="cb73-1576"><a href="#cb73-1576" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Daily Cumulative Return: Momentum Long-Short Strategy"</span></span>
<span id="cb73-1577"><a href="#cb73-1577" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1578"><a href="#cb73-1578" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1579"><a href="#cb73-1579" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb73-1580"><a href="#cb73-1580" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1581"><a href="#cb73-1581" aria-hidden="true" tabindex="-1"></a>plot_daily_cumret</span>
<span id="cb73-1582"><a href="#cb73-1582" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1583"><a href="#cb73-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1584"><a href="#cb73-1584" aria-hidden="true" tabindex="-1"></a><span class="fu">### Annualized Risk Metrics from Daily Data</span></span>
<span id="cb73-1585"><a href="#cb73-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1586"><a href="#cb73-1586" aria-hidden="true" tabindex="-1"></a>Daily data enables more precise estimation of risk metrics through higher-frequency sampling.</span>
<span id="cb73-1587"><a href="#cb73-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1590"><a href="#cb73-1590" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1591"><a href="#cb73-1591" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-daily-risk</span></span>
<span id="cb73-1592"><a href="#cb73-1592" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Annualized risk metrics for the momentum long-short strategy computed from daily returns. Volatility is annualized using the square root of 252 rule. The Sharpe ratio, maximum drawdown, skewness, and kurtosis provide a comprehensive risk profile."</span></span>
<span id="cb73-1593"><a href="#cb73-1593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1594"><a href="#cb73-1594" aria-hidden="true" tabindex="-1"></a>daily_ls <span class="op">=</span> daily_wide[<span class="st">"long_short"</span>].dropna()</span>
<span id="cb73-1595"><a href="#cb73-1595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1596"><a href="#cb73-1596" aria-hidden="true" tabindex="-1"></a><span class="co"># Annualized metrics</span></span>
<span id="cb73-1597"><a href="#cb73-1597" aria-hidden="true" tabindex="-1"></a>ann_mean <span class="op">=</span> daily_ls.mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb73-1598"><a href="#cb73-1598" aria-hidden="true" tabindex="-1"></a>ann_vol <span class="op">=</span> daily_ls.std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb73-1599"><a href="#cb73-1599" aria-hidden="true" tabindex="-1"></a>sharpe <span class="op">=</span> ann_mean <span class="op">/</span> ann_vol <span class="cf">if</span> ann_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb73-1600"><a href="#cb73-1600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1601"><a href="#cb73-1601" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawdown</span></span>
<span id="cb73-1602"><a href="#cb73-1602" aria-hidden="true" tabindex="-1"></a>daily_wealth <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> daily_ls).cumprod()</span>
<span id="cb73-1603"><a href="#cb73-1603" aria-hidden="true" tabindex="-1"></a>daily_running_max <span class="op">=</span> daily_wealth.cummax()</span>
<span id="cb73-1604"><a href="#cb73-1604" aria-hidden="true" tabindex="-1"></a>daily_dd <span class="op">=</span> (daily_wealth <span class="op">/</span> daily_running_max <span class="op">-</span> <span class="dv">1</span>).<span class="bu">min</span>()</span>
<span id="cb73-1605"><a href="#cb73-1605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1606"><a href="#cb73-1606" aria-hidden="true" tabindex="-1"></a><span class="co"># Higher moments</span></span>
<span id="cb73-1607"><a href="#cb73-1607" aria-hidden="true" tabindex="-1"></a>skew <span class="op">=</span> daily_ls.skew()</span>
<span id="cb73-1608"><a href="#cb73-1608" aria-hidden="true" tabindex="-1"></a>kurt <span class="op">=</span> daily_ls.kurtosis()</span>
<span id="cb73-1609"><a href="#cb73-1609" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1610"><a href="#cb73-1610" aria-hidden="true" tabindex="-1"></a><span class="co"># VaR and CVaR</span></span>
<span id="cb73-1611"><a href="#cb73-1611" aria-hidden="true" tabindex="-1"></a>var_95 <span class="op">=</span> daily_ls.quantile(<span class="fl">0.05</span>)</span>
<span id="cb73-1612"><a href="#cb73-1612" aria-hidden="true" tabindex="-1"></a>cvar_95 <span class="op">=</span> daily_ls[daily_ls <span class="op">&lt;=</span> var_95].mean()</span>
<span id="cb73-1613"><a href="#cb73-1613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1614"><a href="#cb73-1614" aria-hidden="true" tabindex="-1"></a>risk_metrics <span class="op">=</span> pd.DataFrame({</span>
<span id="cb73-1615"><a href="#cb73-1615" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Metric"</span>: [</span>
<span id="cb73-1616"><a href="#cb73-1616" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Annualized Mean Return"</span>,</span>
<span id="cb73-1617"><a href="#cb73-1617" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Annualized Volatility"</span>, </span>
<span id="cb73-1618"><a href="#cb73-1618" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Sharpe Ratio"</span>,</span>
<span id="cb73-1619"><a href="#cb73-1619" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Maximum Drawdown"</span>,</span>
<span id="cb73-1620"><a href="#cb73-1620" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Skewness"</span>,</span>
<span id="cb73-1621"><a href="#cb73-1621" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Excess Kurtosis"</span>,</span>
<span id="cb73-1622"><a href="#cb73-1622" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Daily VaR (5%)"</span>,</span>
<span id="cb73-1623"><a href="#cb73-1623" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Daily CVaR (5%)"</span></span>
<span id="cb73-1624"><a href="#cb73-1624" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb73-1625"><a href="#cb73-1625" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Value"</span>: [</span>
<span id="cb73-1626"><a href="#cb73-1626" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>ann_mean<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb73-1627"><a href="#cb73-1627" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>ann_vol<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb73-1628"><a href="#cb73-1628" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>sharpe<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb73-1629"><a href="#cb73-1629" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>daily_dd<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb73-1630"><a href="#cb73-1630" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>skew<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb73-1631"><a href="#cb73-1631" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>kurt<span class="sc">:.2f}</span><span class="ss">"</span>,</span>
<span id="cb73-1632"><a href="#cb73-1632" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>var_95<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>,</span>
<span id="cb73-1633"><a href="#cb73-1633" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"</span><span class="sc">{</span>cvar_95<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span></span>
<span id="cb73-1634"><a href="#cb73-1634" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb73-1635"><a href="#cb73-1635" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb73-1636"><a href="#cb73-1636" aria-hidden="true" tabindex="-1"></a>risk_metrics</span>
<span id="cb73-1637"><a href="#cb73-1637" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1638"><a href="#cb73-1638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1639"><a href="#cb73-1639" aria-hidden="true" tabindex="-1"></a><span class="fu">### Realized Volatility of Momentum Returns</span></span>
<span id="cb73-1640"><a href="#cb73-1640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1641"><a href="#cb73-1641" aria-hidden="true" tabindex="-1"></a>Using daily returns, we can compute the monthly realized volatility of the momentum strategy and examine how it varies over time.</span>
<span id="cb73-1642"><a href="#cb73-1642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1645"><a href="#cb73-1645" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1646"><a href="#cb73-1646" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-realized-vol</span></span>
<span id="cb73-1647"><a href="#cb73-1647" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Monthly realized volatility of the momentum long-short strategy, computed from daily returns within each month. Higher values indicate periods of greater uncertainty in momentum profits, often coinciding with market stress."</span></span>
<span id="cb73-1648"><a href="#cb73-1648" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A time series chart of monthly realized volatility, showing spikes during periods of market stress."</span></span>
<span id="cb73-1649"><a href="#cb73-1649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1650"><a href="#cb73-1650" aria-hidden="true" tabindex="-1"></a>daily_wide[<span class="st">"year_month"</span>] <span class="op">=</span> daily_wide[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb73-1651"><a href="#cb73-1651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1652"><a href="#cb73-1652" aria-hidden="true" tabindex="-1"></a>realized_vol <span class="op">=</span> (daily_wide</span>
<span id="cb73-1653"><a href="#cb73-1653" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year_month"</span>)[<span class="st">"long_short"</span>]</span>
<span id="cb73-1654"><a href="#cb73-1654" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb73-1655"><a href="#cb73-1655" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb73-1656"><a href="#cb73-1656" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"realized_vol"</span>})</span>
<span id="cb73-1657"><a href="#cb73-1657" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1658"><a href="#cb73-1658" aria-hidden="true" tabindex="-1"></a>realized_vol[<span class="st">"date"</span>] <span class="op">=</span> realized_vol[<span class="st">"year_month"</span>].dt.to_timestamp()</span>
<span id="cb73-1659"><a href="#cb73-1659" aria-hidden="true" tabindex="-1"></a>realized_vol[<span class="st">"realized_vol_ann"</span>] <span class="op">=</span> realized_vol[<span class="st">"realized_vol"</span>] <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb73-1660"><a href="#cb73-1660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1661"><a href="#cb73-1661" aria-hidden="true" tabindex="-1"></a>plot_rvol <span class="op">=</span> (</span>
<span id="cb73-1662"><a href="#cb73-1662" aria-hidden="true" tabindex="-1"></a>    ggplot(realized_vol, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"realized_vol_ann"</span>)) <span class="op">+</span></span>
<span id="cb73-1663"><a href="#cb73-1663" aria-hidden="true" tabindex="-1"></a>    geom_line(color<span class="op">=</span><span class="st">"#d62728"</span>, size<span class="op">=</span><span class="fl">0.8</span>) <span class="op">+</span></span>
<span id="cb73-1664"><a href="#cb73-1664" aria-hidden="true" tabindex="-1"></a>    scale_y_continuous(labels<span class="op">=</span>percent_format()) <span class="op">+</span></span>
<span id="cb73-1665"><a href="#cb73-1665" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb73-1666"><a href="#cb73-1666" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Annualized Realized Volatility"</span>,</span>
<span id="cb73-1667"><a href="#cb73-1667" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Realized Volatility of Momentum Strategy"</span></span>
<span id="cb73-1668"><a href="#cb73-1668" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb73-1669"><a href="#cb73-1669" aria-hidden="true" tabindex="-1"></a>    theme_minimal() <span class="op">+</span></span>
<span id="cb73-1670"><a href="#cb73-1670" aria-hidden="true" tabindex="-1"></a>    theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb73-1671"><a href="#cb73-1671" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1672"><a href="#cb73-1672" aria-hidden="true" tabindex="-1"></a>plot_rvol</span>
<span id="cb73-1673"><a href="#cb73-1673" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1674"><a href="#cb73-1674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1675"><a href="#cb73-1675" aria-hidden="true" tabindex="-1"></a><span class="fu">## Saving Results to the Database</span></span>
<span id="cb73-1676"><a href="#cb73-1676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1677"><a href="#cb73-1677" aria-hidden="true" tabindex="-1"></a>We save the momentum portfolio returns to our database for use in subsequent chapters, including factor model construction and portfolio optimization.</span>
<span id="cb73-1678"><a href="#cb73-1678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1681"><a href="#cb73-1681" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb73-1682"><a href="#cb73-1682" aria-hidden="true" tabindex="-1"></a><span class="co"># Save monthly equally weighted momentum portfolio returns</span></span>
<span id="cb73-1683"><a href="#cb73-1683" aria-hidden="true" tabindex="-1"></a>ewret_to_save <span class="op">=</span> ewret[[<span class="st">"date"</span>, <span class="st">"momr"</span>, <span class="st">"ewret"</span>]].copy()</span>
<span id="cb73-1684"><a href="#cb73-1684" aria-hidden="true" tabindex="-1"></a>ewret_to_save.to_sql(</span>
<span id="cb73-1685"><a href="#cb73-1685" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_portfolios_monthly"</span>,</span>
<span id="cb73-1686"><a href="#cb73-1686" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1687"><a href="#cb73-1687" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-1688"><a href="#cb73-1688" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-1689"><a href="#cb73-1689" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1690"><a href="#cb73-1690" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(ewret_to_save)<span class="sc">:,}</span><span class="ss"> monthly momentum portfolio observations."</span>)</span>
<span id="cb73-1691"><a href="#cb73-1691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1692"><a href="#cb73-1692" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the long-short return series</span></span>
<span id="cb73-1693"><a href="#cb73-1693" aria-hidden="true" tabindex="-1"></a>momentum_factor <span class="op">=</span> ewret_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].dropna().copy()</span>
<span id="cb73-1694"><a href="#cb73-1694" aria-hidden="true" tabindex="-1"></a>momentum_factor <span class="op">=</span> momentum_factor.rename(columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"wml"</span>})</span>
<span id="cb73-1695"><a href="#cb73-1695" aria-hidden="true" tabindex="-1"></a>momentum_factor.to_sql(</span>
<span id="cb73-1696"><a href="#cb73-1696" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_factor_monthly"</span>,</span>
<span id="cb73-1697"><a href="#cb73-1697" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1698"><a href="#cb73-1698" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-1699"><a href="#cb73-1699" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-1700"><a href="#cb73-1700" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1701"><a href="#cb73-1701" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(momentum_factor)<span class="sc">:,}</span><span class="ss"> monthly WML factor observations."</span>)</span>
<span id="cb73-1702"><a href="#cb73-1702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1703"><a href="#cb73-1703" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the daily long-short return series</span></span>
<span id="cb73-1704"><a href="#cb73-1704" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor <span class="op">=</span> daily_wide[[<span class="st">"date"</span>, <span class="st">"long_short"</span>]].dropna().copy()</span>
<span id="cb73-1705"><a href="#cb73-1705" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor <span class="op">=</span> daily_momentum_factor.rename(</span>
<span id="cb73-1706"><a href="#cb73-1706" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span>{<span class="st">"long_short"</span>: <span class="st">"wml"</span>}</span>
<span id="cb73-1707"><a href="#cb73-1707" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1708"><a href="#cb73-1708" aria-hidden="true" tabindex="-1"></a>daily_momentum_factor.to_sql(</span>
<span id="cb73-1709"><a href="#cb73-1709" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"momentum_factor_daily"</span>,</span>
<span id="cb73-1710"><a href="#cb73-1710" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb73-1711"><a href="#cb73-1711" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb73-1712"><a href="#cb73-1712" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb73-1713"><a href="#cb73-1713" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb73-1714"><a href="#cb73-1714" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Saved </span><span class="sc">{</span><span class="bu">len</span>(daily_momentum_factor)<span class="sc">:,}</span><span class="ss"> daily WML factor observations."</span>)</span>
<span id="cb73-1715"><a href="#cb73-1715" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb73-1716"><a href="#cb73-1716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1717"><a href="#cb73-1717" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Considerations</span></span>
<span id="cb73-1718"><a href="#cb73-1718" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1719"><a href="#cb73-1719" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transaction Costs</span></span>
<span id="cb73-1720"><a href="#cb73-1720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1721"><a href="#cb73-1721" aria-hidden="true" tabindex="-1"></a>Momentum strategies involve substantial portfolio turnover, as stocks enter and exit the extreme decile portfolios each month. @korajczyk2004momentum examine whether momentum profits survive transaction costs and find that profitability declines significantly for large institutional investors, though smaller portfolios can still capture meaningful returns.</span>
<span id="cb73-1722"><a href="#cb73-1722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1723"><a href="#cb73-1723" aria-hidden="true" tabindex="-1"></a>In the Vietnamese market, transaction costs include:</span>
<span id="cb73-1724"><a href="#cb73-1724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1725"><a href="#cb73-1725" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Brokerage commissions**: Typically 0.15%–0.25% of transaction value for institutional investors.</span>
<span id="cb73-1726"><a href="#cb73-1726" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Exchange fees**: Approximately 0.03% per trade.</span>
<span id="cb73-1727"><a href="#cb73-1727" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Market impact**: Particularly relevant for smaller, less liquid stocks that dominate the extreme momentum portfolios. Vietnam's lower liquidity compared to developed markets may amplify this cost.</span>
<span id="cb73-1728"><a href="#cb73-1728" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Trading band limits**: The $\pm 7\%$ daily price limit on HOSE can prevent immediate execution of trades, introducing tracking error relative to the theoretical portfolio.</span>
<span id="cb73-1729"><a href="#cb73-1729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1730"><a href="#cb73-1730" aria-hidden="true" tabindex="-1"></a><span class="fu">### Implementation Lag</span></span>
<span id="cb73-1731"><a href="#cb73-1731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1732"><a href="#cb73-1732" aria-hidden="true" tabindex="-1"></a>Our baseline implementation assumes that portfolios can be formed and rebalanced instantaneously at the end of each month. In practice, there is a lag between observing the formation period returns and executing the portfolio trades. The one-month gap between the formation period and the start of the holding period (@jegadeesh1990evidence) partially addresses this concern, but practitioners should consider additional implementation delays.</span>
<span id="cb73-1733"><a href="#cb73-1733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1734"><a href="#cb73-1734" aria-hidden="true" tabindex="-1"></a><span class="fu">### Survivorship Bias</span></span>
<span id="cb73-1735"><a href="#cb73-1735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1736"><a href="#cb73-1736" aria-hidden="true" tabindex="-1"></a>Our dataset from DataCore includes both active and delisted stocks, which mitigates survivorship bias. However, the treatment of delisted stocks can affect momentum results. Stocks that are delisted during the holding period may generate extreme returns (both positive for acquisitions and negative for failures). We retain delisted returns as reported in the database, which is consistent with the treatment in @jegadeesh1993returns.</span>
<span id="cb73-1737"><a href="#cb73-1737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1738"><a href="#cb73-1738" aria-hidden="true" tabindex="-1"></a><span class="fu">### Small Sample Considerations</span></span>
<span id="cb73-1739"><a href="#cb73-1739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1740"><a href="#cb73-1740" aria-hidden="true" tabindex="-1"></a>The Vietnamese stock market has a relatively short history compared to the U.S. market studied in @jegadeesh1993returns. Our sample spans approximately two decades, compared to the nearly three decades in the original study. This shorter sample period implies wider confidence intervals and greater sensitivity to specific episodes (such as the 2007–2009 financial crisis, which had a severe impact on Vietnamese equities). Results should be interpreted with this caveat in mind.</span>
<span id="cb73-1741"><a href="#cb73-1741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1742"><a href="#cb73-1742" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways</span></span>
<span id="cb73-1743"><a href="#cb73-1743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1744"><a href="#cb73-1744" aria-hidden="true" tabindex="-1"></a>This chapter has provided an implementation and analysis of momentum strategies in the Vietnamese equity market, following the methodology of @jegadeesh1993returns. The main findings and methodological contributions are:</span>
<span id="cb73-1745"><a href="#cb73-1745" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1746"><a href="#cb73-1746" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Methodology**: We implemented the full @jegadeesh1993returns overlapping portfolio methodology, including the two-stage averaging procedure (within-cohort, then across-cohort) that handles the $K$ active portfolios in each month.</span>
<span id="cb73-1747"><a href="#cb73-1747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1748"><a href="#cb73-1748" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Baseline results**: The $J=6$, $K=6$ strategy provides a natural benchmark. The spread between winner and loser portfolios reveals whether cross-sectional momentum exists in Vietnamese equities.</span>
<span id="cb73-1749"><a href="#cb73-1749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1750"><a href="#cb73-1750" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Robustness across horizons**: By computing the full $J \times K$ grid with $J, K \in <span class="sc">\{</span>3, 6, 9, 12<span class="sc">\}</span>$, we assessed whether the momentum premium is robust to the choice of formation and holding periods, following the approach in @jegadeesh1993returns Table 1.</span>
<span id="cb73-1751"><a href="#cb73-1751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1752"><a href="#cb73-1752" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Risk adjustment**: CAPM and Fama-French three-factor alphas measure whether the momentum premium is explained by standard risk factors, building on the analysis in @fama1996multifactor who show that their three-factor model fails to explain momentum.</span>
<span id="cb73-1753"><a href="#cb73-1753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1754"><a href="#cb73-1754" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Market state dependence**: Following @cooper2004market, we examined whether momentum profits vary with market conditions, which is particularly relevant in emerging markets with pronounced boom-bust cycles.</span>
<span id="cb73-1755"><a href="#cb73-1755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1756"><a href="#cb73-1756" aria-hidden="true" tabindex="-1"></a><span class="ss">6.  </span>**Value weighting**: The comparison of equally weighted and value-weighted strategies addresses practical implementability and isolates the role of firm size in driving momentum profits.</span>
<span id="cb73-1757"><a href="#cb73-1757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1758"><a href="#cb73-1758" aria-hidden="true" tabindex="-1"></a><span class="ss">7.  </span>**Daily analysis**: By tracking momentum portfolios at the daily frequency, we computed precise risk metrics including realized volatility, maximum drawdown, VaR, and CVaR, providing a complete risk profile of the strategy.</span>
<span id="cb73-1759"><a href="#cb73-1759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1760"><a href="#cb73-1760" aria-hidden="true" tabindex="-1"></a><span class="ss">8.  </span>**Emerging market context**: Throughout the analysis, we have highlighted features specific to the Vietnamese market—trading band limits, foreign ownership restrictions, shorter sample history, and higher transaction costs—that affect the interpretation and practical viability of momentum strategies.</span>
<span id="cb73-1761"><a href="#cb73-1761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1762"><a href="#cb73-1762" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb73-1763"><a href="#cb73-1763" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- ## Exercises</span></span>
<span id="cb73-1764"><a href="#cb73-1764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1765"><a href="#cb73-1765" aria-hidden="true" tabindex="-1"></a><span class="in">1.  **Skip-month momentum**: Modify the implementation to skip one month between the formation and holding periods (i.e., form portfolios based on months $t-J-1$ through $t-2$ rather than $t-J$ through $t-1$). Does this improve momentum profits by avoiding short-term reversal? Compare with the results in @jegadeesh1993returns.</span></span>
<span id="cb73-1766"><a href="#cb73-1766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1767"><a href="#cb73-1767" aria-hidden="true" tabindex="-1"></a><span class="in">2.  **Quintile portfolios**: Repeat the analysis using quintile (5-group) portfolios instead of deciles. How do the results change? In the Vietnamese market with fewer stocks, quintiles may produce more stable portfolios.</span></span>
<span id="cb73-1768"><a href="#cb73-1768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1769"><a href="#cb73-1769" aria-hidden="true" tabindex="-1"></a><span class="in">3.  **Exchange-specific momentum**: Separately analyze momentum on HOSE and HNX. Do the two exchanges exhibit different momentum patterns, potentially due to differences in liquidity, firm size, and investor composition?</span></span>
<span id="cb73-1770"><a href="#cb73-1770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1771"><a href="#cb73-1771" aria-hidden="true" tabindex="-1"></a><span class="in">4.  **Industry momentum**: Following @moskowitz1999industries, decompose stock-level momentum into an industry component and a stock-specific component. Assign each stock the equally weighted return of its industry group as the industry momentum signal. Is momentum in Vietnam primarily driven by industry rotation or stock selection?</span></span>
<span id="cb73-1772"><a href="#cb73-1772" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1773"><a href="#cb73-1773" aria-hidden="true" tabindex="-1"></a><span class="in">5.  **Momentum and volume**: @lee2000price document an interaction between momentum and trading volume. Construct double-sorted portfolios based on past returns and past trading volume. Do high-volume winners outperform low-volume winners?</span></span>
<span id="cb73-1774"><a href="#cb73-1774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1775"><a href="#cb73-1775" aria-hidden="true" tabindex="-1"></a><span class="in">6.  **Seasonal patterns**: Examine whether momentum profits exhibit seasonal patterns. In the U.S., @jegadeesh1993returns document that January returns of momentum portfolios are particularly unusual. Does a similar pattern exist in the Vietnamese market, potentially around the Lunar New Year (Tết)?</span></span>
<span id="cb73-1776"><a href="#cb73-1776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-1777"><a href="#cb73-1777" aria-hidden="true" tabindex="-1"></a><span class="in">7.  **Carhart four-factor model**: Using the WML factor saved to the database in this chapter, estimate the @carhart1997persistence four-factor model for the momentum portfolios. This adds the momentum factor to the Fama-French three-factor model: $r_{i,t} - r_{f,t} = \alpha_i + \beta_{1,i} \text{MKT}_t + \beta_{2,i} \text{SMB}_t + \beta_{3,i} \text{HML}_t + \beta_{4,i} \text{WML}_t + \epsilon_{i,t}$. --&gt;</span></span>
<span id="cb73-1778"><a href="#cb73-1778" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/13_momemtum.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>