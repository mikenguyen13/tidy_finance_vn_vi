<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>3&nbsp; Datacore Data – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./03_market_microstructure.html" rel="next">
<link href="./01_accessing_and_managing_financial_data.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="3&nbsp; Datacore Data – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/mikenguyen13/tidy_finance_vn/02_datacore_data_files/figure-html/fig-book-equity-coverage-output-1.png">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta property="og:image:alt" content="Line chart showing the coverage of book equity data over time.">
<meta property="og:image:height" content="960">
<meta property="og:image:width" content="1344">
<meta name="twitter:title" content="3&nbsp; Datacore Data – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://github.com/mikenguyen13/tidy_finance_vn/02_datacore_data_files/figure-html/fig-book-equity-coverage-output-1.png">
<meta name="twitter:image:alt" content="Line chart showing the coverage of book equity data over time.">
<meta name="twitter:image-height" content="960">
<meta name="twitter:image-width" content="1344">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_institutional_background.html">Vietnam Financial Markets, Institutions, and Data</a></li><li class="breadcrumb-item"><a href="./02_datacore_data.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Alternative Data and AI for Finance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-access-options" id="toc-data-access-options" class="nav-link active" data-scroll-target="#data-access-options"><span class="header-section-number">3.1</span> Data Access Options</a></li>
  <li><a href="#chapter-overview" id="toc-chapter-overview" class="nav-link" data-scroll-target="#chapter-overview"><span class="header-section-number">3.2</span> Chapter Overview</a></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment"><span class="header-section-number">3.3</span> Setting Up the Environment</a></li>
  <li><a href="#connecting-to-datacore" id="toc-connecting-to-datacore" class="nav-link" data-scroll-target="#connecting-to-datacore"><span class="header-section-number">3.4</span> Connecting to Datacore</a></li>
  <li><a href="#company-fundamentals-data" id="toc-company-fundamentals-data" class="nav-link" data-scroll-target="#company-fundamentals-data"><span class="header-section-number">3.5</span> Company Fundamentals Data</a>
  <ul class="collapse">
  <li><a href="#understanding-vietnamese-financial-statements" id="toc-understanding-vietnamese-financial-statements" class="nav-link" data-scroll-target="#understanding-vietnamese-financial-statements"><span class="header-section-number">3.5.1</span> Understanding Vietnamese Financial Statements</a></li>
  <li><a href="#downloading-fundamentals-data" id="toc-downloading-fundamentals-data" class="nav-link" data-scroll-target="#downloading-fundamentals-data"><span class="header-section-number">3.5.2</span> Downloading Fundamentals Data</a></li>
  <li><a href="#cleaning-and-standardizing-fundamentals" id="toc-cleaning-and-standardizing-fundamentals" class="nav-link" data-scroll-target="#cleaning-and-standardizing-fundamentals"><span class="header-section-number">3.5.3</span> Cleaning and Standardizing Fundamentals</a></li>
  <li><a href="#creating-standardized-variables" id="toc-creating-standardized-variables" class="nav-link" data-scroll-target="#creating-standardized-variables"><span class="header-section-number">3.5.4</span> Creating Standardized Variables</a></li>
  <li><a href="#computing-book-equity-and-profitability" id="toc-computing-book-equity-and-profitability" class="nav-link" data-scroll-target="#computing-book-equity-and-profitability"><span class="header-section-number">3.5.5</span> Computing Book Equity and Profitability</a></li>
  <li><a href="#computing-investment" id="toc-computing-investment" class="nav-link" data-scroll-target="#computing-investment"><span class="header-section-number">3.5.6</span> Computing Investment</a></li>
  <li><a href="#computing-total-debt" id="toc-computing-total-debt" class="nav-link" data-scroll-target="#computing-total-debt"><span class="header-section-number">3.5.7</span> Computing Total Debt</a></li>
  <li><a href="#applying-filters-and-final-preparation" id="toc-applying-filters-and-final-preparation" class="nav-link" data-scroll-target="#applying-filters-and-final-preparation"><span class="header-section-number">3.5.8</span> Applying Filters and Final Preparation</a></li>
  <li><a href="#storing-fundamentals-data" id="toc-storing-fundamentals-data" class="nav-link" data-scroll-target="#storing-fundamentals-data"><span class="header-section-number">3.5.9</span> Storing Fundamentals Data</a></li>
  </ul></li>
  <li><a href="#stock-price-data" id="toc-stock-price-data" class="nav-link" data-scroll-target="#stock-price-data"><span class="header-section-number">3.6</span> Stock Price Data</a>
  <ul class="collapse">
  <li><a href="#downloading-price-data" id="toc-downloading-price-data" class="nav-link" data-scroll-target="#downloading-price-data"><span class="header-section-number">3.6.1</span> Downloading Price Data</a></li>
  <li><a href="#processing-price-data" id="toc-processing-price-data" class="nav-link" data-scroll-target="#processing-price-data"><span class="header-section-number">3.6.2</span> Processing Price Data</a></li>
  <li><a href="#computing-shares-outstanding-and-market-capitalization" id="toc-computing-shares-outstanding-and-market-capitalization" class="nav-link" data-scroll-target="#computing-shares-outstanding-and-market-capitalization"><span class="header-section-number">3.6.3</span> Computing Shares Outstanding and Market Capitalization</a></li>
  <li><a href="#computing-returns-and-excess-returns" id="toc-computing-returns-and-excess-returns" class="nav-link" data-scroll-target="#computing-returns-and-excess-returns"><span class="header-section-number">3.6.4</span> Computing Returns and Excess Returns</a></li>
  <li><a href="#storing-price-data" id="toc-storing-price-data" class="nav-link" data-scroll-target="#storing-price-data"><span class="header-section-number">3.6.5</span> Storing Price Data</a></li>
  </ul></li>
  <li><a href="#descriptive-statistics" id="toc-descriptive-statistics" class="nav-link" data-scroll-target="#descriptive-statistics"><span class="header-section-number">3.7</span> Descriptive Statistics</a>
  <ul class="collapse">
  <li><a href="#market-evolution-over-time" id="toc-market-evolution-over-time" class="nav-link" data-scroll-target="#market-evolution-over-time"><span class="header-section-number">3.7.1</span> Market Evolution Over Time</a></li>
  <li><a href="#market-capitalization-evolution" id="toc-market-capitalization-evolution" class="nav-link" data-scroll-target="#market-capitalization-evolution"><span class="header-section-number">3.7.2</span> Market Capitalization Evolution</a></li>
  <li><a href="#return-distribution" id="toc-return-distribution" class="nav-link" data-scroll-target="#return-distribution"><span class="header-section-number">3.7.3</span> Return Distribution</a></li>
  <li><a href="#coverage-of-book-equity" id="toc-coverage-of-book-equity" class="nav-link" data-scroll-target="#coverage-of-book-equity"><span class="header-section-number">3.7.4</span> Coverage of Book Equity</a></li>
  </ul></li>
  <li><a href="#merging-stock-and-fundamental-data" id="toc-merging-stock-and-fundamental-data" class="nav-link" data-scroll-target="#merging-stock-and-fundamental-data"><span class="header-section-number">3.8</span> Merging Stock and Fundamental Data</a></li>
  <li><a href="#key-takeaways" id="toc-key-takeaways" class="nav-link" data-scroll-target="#key-takeaways"><span class="header-section-number">3.9</span> Key Takeaways</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/02_datacore_data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./00_institutional_background.html">Vietnam Financial Markets, Institutions, and Data</a></li><li class="breadcrumb-item"><a href="./02_datacore_data.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This chapter introduces <a href="https://datacore.vn/">Datacore</a>, Vietnam’s data platform for academic, corporate, and government research. Datacore provides comprehensive financial and economic datasets, including historical trading data, company fundamentals, and macroeconomic indicators essential for reproducible finance research. We use Datacore as the primary data source throughout this book.</p>
<section id="data-access-options" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="data-access-options"><span class="header-section-number">3.1</span> Data Access Options</h2>
<p>Readers can access the data used in this book through several channels:</p>
<ol type="1">
<li><p><strong>Institutional subscription</strong>: Many universities and research institutions subscribe to Datacore. Check with your library or research office for access credentials. If your institution does not yet have a subscription, consider requesting one through your library’s acquisition process—Datacore offers institutional pricing for academic use.</p></li>
<li><p><strong>Demo datasets</strong>: Datacore provides <a href="https://datacore.vn/demo/dataset-groups">demo datasets</a> that allow you to run the code examples in this book with sample data.</p></li>
</ol>
<!-- 3. **Sample data repository**: To ensure reproducibility, we provide a subset of anonymized data in the book's [GitHub repository](https://github.com/mikenguyen13/tidy_finance_vn). This sample covers a limited number of securities and time periods but is sufficient to execute all code examples. -->
<!-- 4. **Alternative data sources**: For readers without Datacore access, we provide guidance on adapting the code to work with publicly available data from sources such as [CafeF](https://cafef.vn/), though coverage and data quality may differ. -->
</section>
<section id="chapter-overview" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="chapter-overview"><span class="header-section-number">3.2</span> Chapter Overview</h2>
<p>The chapter is organized as follows. We first establish the connection to Datacore’s cloud storage infrastructure. Then, we download and prepare company fundamentals data, including balance sheet items, income statement variables, and derived metrics essential for asset pricing research. Next, we retrieve and process stock price data, computing returns, market capitalizations, and excess returns. We conclude by merging these datasets and providing descriptive statistics that characterize the Vietnamese equity market.</p>
</section>
<section id="setting-up-the-environment" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="setting-up-the-environment"><span class="header-section-number">3.3</span> Setting Up the Environment</h2>
<p>We begin by loading the Python packages used throughout this chapter. The core packages include <code>pandas</code> for data manipulation, <code>numpy</code> for numerical operations, and <code>sqlite3</code> for local database management. We also import visualization libraries for creating publication-quality figures.</p>
<div id="a5390008" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> comma_format, percent_format</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We establish a connection to our local SQLite database, which serves as the central repository for all processed data. This database was introduced in the previous chapter and will store the cleaned datasets for use in subsequent analyses.</p>
<div id="327ff521" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We define the date range for our data collection. The Vietnamese stock market began operations in July 2000 with the establishment of the Ho Chi Minh City Stock Exchange (HOSE), so our sample period starts from 2000 and extends through the end of 2024.</p>
<div id="e9122888" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2000-01-01"</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-12-31"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="connecting-to-datacore" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="connecting-to-datacore"><span class="header-section-number">3.4</span> Connecting to Datacore</h2>
<p>Datacore delivers data through a cloud-based object storage system built on MinIO, an S3-compatible storage infrastructure. This architecture enables efficient, programmatic access to large datasets without the limitations of traditional database connections. To access the data, you need credentials provided by Datacore upon subscription: an endpoint URL, access key, and secret key.</p>
<p>The following class establishes the connection to Datacore’s storage system. The credentials are stored as environment variables for security, following best practices for credential management in research computing environments.</p>
<div id="98476ca8" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> botocore.client <span class="im">import</span> Config</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DatacoreConnection:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Connection handler for Datacore's MinIO-based storage system.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This class manages authentication and provides methods for</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    accessing financial datasets stored in Datacore's cloud infrastructure.</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">    s3 : boto3.client</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co">        S3-compatible client for interacting with Datacore storage</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize connection using environment variables."""</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ENDPOINT <span class="op">=</span> os.environ[<span class="st">"MINIO_ENDPOINT"</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ACCESS_KEY <span class="op">=</span> os.environ[<span class="st">"MINIO_ACCESS_KEY"</span>]</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_SECRET_KEY <span class="op">=</span> os.environ[<span class="st">"MINIO_SECRET_KEY"</span>]</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.REGION <span class="op">=</span> os.getenv(<span class="st">"MINIO_REGION"</span>, <span class="st">"us-east-1"</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.s3 <span class="op">=</span> boto3.client(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"s3"</span>,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            endpoint_url<span class="op">=</span><span class="va">self</span>.MINIO_ENDPOINT,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            aws_access_key_id<span class="op">=</span><span class="va">self</span>.MINIO_ACCESS_KEY,</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            aws_secret_access_key<span class="op">=</span><span class="va">self</span>.MINIO_SECRET_KEY,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            region_name<span class="op">=</span><span class="va">self</span>.REGION,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>Config(signature_version<span class="op">=</span><span class="st">"s3v4"</span>),</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test_connection(<span class="va">self</span>):</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Verify connection by listing available buckets."""</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.s3.list_buckets()</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Connected successfully. Available buckets:"</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bucket <span class="kw">in</span> response.get(<span class="st">"Buckets"</span>, []):</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>bucket[<span class="st">'Name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> list_objects(<span class="va">self</span>, bucket_name, prefix<span class="op">=</span><span class="st">""</span>):</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""List objects in a bucket with optional prefix filter."""</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.s3.list_objects_v2(</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>            Bucket<span class="op">=</span>bucket_name, </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>            Prefix<span class="op">=</span>prefix</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [obj[<span class="st">"Key"</span>] <span class="cf">for</span> obj <span class="kw">in</span> response.get(<span class="st">"Contents"</span>, [])]</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_excel(<span class="va">self</span>, bucket_name, key):</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read an Excel file from Datacore storage."""</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> <span class="va">self</span>.s3.get_object(Bucket<span class="op">=</span>bucket_name, Key<span class="op">=</span>key)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_excel(BytesIO(obj[<span class="st">"Body"</span>].read()))</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_csv(<span class="va">self</span>, bucket_name, key, <span class="op">**</span>kwargs):</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read a CSV file from Datacore storage."""</span></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> <span class="va">self</span>.s3.get_object(Bucket<span class="op">=</span>bucket_name, Key<span class="op">=</span>key)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(BytesIO(obj[<span class="st">"Body"</span>].read()), <span class="op">**</span>kwargs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>With the connection class defined, we can establish a connection and verify access to Datacore’s data repositories.</p>
<div id="1784157c" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize connection</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> DatacoreConnection()</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>conn.test_connection()</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Get bucket name from environment</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>bucket_name <span class="op">=</span> os.environ[<span class="st">"MINIO_BUCKET"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Connected successfully. Available buckets:
  - dsteam-data
  - rawbctc</code></pre>
</div>
</div>
</section>
<section id="company-fundamentals-data" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="company-fundamentals-data"><span class="header-section-number">3.5</span> Company Fundamentals Data</h2>
<p>Firm accounting data are essential for portfolio analyses, factor construction, and valuation studies. Datacore hosts comprehensive fundamentals data for Vietnamese listed companies, including annual and quarterly financial statements prepared according to Vietnamese Accounting Standards (VAS).</p>
<section id="understanding-vietnamese-financial-statements" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="understanding-vietnamese-financial-statements"><span class="header-section-number">3.5.1</span> Understanding Vietnamese Financial Statements</h3>
<p>Before processing the data, it is important to understand the structure of Vietnamese financial reports. Vietnamese companies follow VAS, which shares similarities with International Financial Reporting Standards (IFRS) but has notable differences:</p>
<ol type="1">
<li><p><strong>Fiscal Year</strong>: Most Vietnamese companies use a calendar fiscal year ending December 31, though some companies (particularly in retail and agriculture) use different fiscal year-ends.</p></li>
<li><p><strong>Reporting Frequency</strong>: Listed companies must publish quarterly financial statements within 20 days of quarter-end and annual audited statements within 90 days of fiscal year-end.</p></li>
<li><p><strong>Industry-Specific Formats</strong>: Companies in banking, insurance, and securities sectors follow specialized reporting formats that differ from the standard industrial format.</p></li>
<li><p><strong>Currency</strong>: All figures are reported in Vietnamese Dong (VND). Given the large nominal values (millions to trillions of VND), we often scale figures to millions or billions for readability.</p></li>
</ol>
</section>
<section id="downloading-fundamentals-data" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="downloading-fundamentals-data"><span class="header-section-number">3.5.2</span> Downloading Fundamentals Data</h3>
<p>Datacore organizes fundamentals data in Excel files partitioned by time period for efficient access. We download and concatenate these files to create a comprehensive dataset spanning our sample period.</p>
<div id="672e3803" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths to fundamentals data files</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>fundamentals_paths <span class="op">=</span> [</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_1.xlsx"</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_2.xlsx"</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_3.xlsx"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and combine all files</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>fundamentals_list <span class="op">=</span> []</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> path <span class="kw">in</span> fundamentals_paths:</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="op">=</span> conn.read_excel(bucket_name, path)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    fundamentals_list.append(df_temp)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloaded: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(df_temp)<span class="sc">:,}</span><span class="ss"> rows)"</span>)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>df_fundamentals_raw <span class="op">=</span> pd.concat(fundamentals_list, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total observations: </span><span class="sc">{</span><span class="bu">len</span>(df_fundamentals_raw)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded: fundamental_annual_1767674486317/fundamental_annual_1.xlsx (10,000 rows)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded: fundamental_annual_1767674486317/fundamental_annual_2.xlsx (10,000 rows)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded: fundamental_annual_1767674486317/fundamental_annual_3.xlsx (2,821 rows)

Total observations: 22,821</code></pre>
</div>
</div>
</section>
<section id="cleaning-and-standardizing-fundamentals" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="cleaning-and-standardizing-fundamentals"><span class="header-section-number">3.5.3</span> Cleaning and Standardizing Fundamentals</h3>
<p>The raw fundamentals data requires several cleaning steps to ensure consistency and usability. We standardize variable names, handle missing values, and create derived variables commonly used in asset pricing research.</p>
<div id="1478a578" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_fundamentals(df):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Clean and standardize company fundamentals data.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw fundamentals data from Datacore</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Cleaned fundamentals with standardized column names</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize identifiers</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"symbol"</span>] <span class="op">=</span> df[<span class="st">"symbol"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.upper().<span class="bu">str</span>.strip()</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>).astype(<span class="st">"Int64"</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop rows with missing identifiers</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define columns that should be numeric</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    numeric_columns <span class="op">=</span> [</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_asset"</span>, <span class="st">"total_equity"</span>, <span class="st">"total_liabilities"</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_current_asset"</span>, <span class="st">"total_current_liabilities"</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_net_revenue"</span>, <span class="st">"is_cogs"</span>, <span class="st">"is_manage_expense"</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_interest_expense"</span>, <span class="st">"is_eat"</span>, <span class="st">"is_net_business_profit"</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"na_tax_deferred"</span>, <span class="st">"nl_tax_deferred"</span>, <span class="st">"e_preferred_stock"</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"capex"</span>, <span class="st">"total_cfo"</span>, <span class="st">"ca_cce"</span>, <span class="st">"ca_total_inventory"</span>,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ca_acc_receiv"</span>, <span class="st">"cfo_interest_expense"</span>, <span class="st">"basic_eps"</span>,</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_shareholders_eat"</span>, <span class="st">"cl_loan"</span>, <span class="st">"cl_finlease"</span>,</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cl_due_long_debt"</span>, <span class="st">"nl_loan"</span>, <span class="st">"nl_finlease"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_cos_of_sales"</span>, <span class="st">"e_equity"</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> numeric_columns:</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> pd.to_numeric(df[col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle duplicates: keep row with most non-missing values</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"_completeness"</span>] <span class="op">=</span> df.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> (df</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"_completeness"</span>])</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        .drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        .drop(columns<span class="op">=</span><span class="st">"_completeness"</span>)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> clean_fundamentals(df_fundamentals_raw)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"After cleaning: </span><span class="sc">{</span><span class="bu">len</span>(df_fundamentals)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>df_fundamentals[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>After cleaning: 21,232 firm-year observations
Unique firms: 1,554</code></pre>
</div>
</div>
</section>
<section id="creating-standardized-variables" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="creating-standardized-variables"><span class="header-section-number">3.5.4</span> Creating Standardized Variables</h3>
<p>To facilitate comparison with international studies and ensure compatibility with standard asset pricing methodologies, we create variables following conventions established in the academic literature. We map Vietnamese financial statement items to their Compustat equivalents where possible.</p>
<div id="2d895ee4" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_standard_variables(df):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create standardized financial variables for asset pricing research.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function maps Vietnamese financial statement items to standard</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    variable names used in the academic finance literature, following</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    conventions from Fama and French (1992, 1993, 2015).</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Cleaned fundamentals data</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with standardized variables added</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fiscal date (assume December year-end)</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"datadate"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"year"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-12-31"</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Balance Sheet Items ===</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"at"</span>] <span class="op">=</span> df[<span class="st">"total_asset"</span>]                    <span class="co"># Total assets</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"lt"</span>] <span class="op">=</span> df[<span class="st">"total_liabilities"</span>]              <span class="co"># Total liabilities</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"seq"</span>] <span class="op">=</span> df[<span class="st">"total_equity"</span>]                  <span class="co"># Stockholders' equity</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"act"</span>] <span class="op">=</span> df[<span class="st">"total_current_asset"</span>]           <span class="co"># Current assets</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"lct"</span>] <span class="op">=</span> df[<span class="st">"total_current_liabilities"</span>]     <span class="co"># Current liabilities</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Common equity (fallback to total equity if not available)</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ceq"</span>] <span class="op">=</span> df.get(<span class="st">"e_equity"</span>, df[<span class="st">"seq"</span>])</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Deferred Taxes ===</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"txditc"</span>] <span class="op">=</span> df.get(<span class="st">"na_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)  <span class="co"># Deferred tax assets</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"txdb"</span>] <span class="op">=</span> df.get(<span class="st">"nl_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)    <span class="co"># Deferred tax liab.</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"itcb"</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Investment tax credit (rare in Vietnam)</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Preferred Stock ===</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    pref <span class="op">=</span> df.get(<span class="st">"e_preferred_stock"</span>, <span class="dv">0</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pref, pd.Series):</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        pref <span class="op">=</span> pref.fillna(<span class="dv">0</span>)</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstk"</span>] <span class="op">=</span> pref</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstkrv"</span>] <span class="op">=</span> pref  <span class="co"># Redemption value</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstkl"</span>] <span class="op">=</span> pref   <span class="co"># Liquidating value</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Income Statement Items ===</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"sale"</span>] <span class="op">=</span> df[<span class="st">"is_net_revenue"</span>]                        <span class="co"># Net sales/revenue</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cogs"</span>] <span class="op">=</span> df.get(<span class="st">"is_cogs"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)              <span class="co"># Cost of goods sold</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"xsga"</span>] <span class="op">=</span> df.get(<span class="st">"is_manage_expense"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)    <span class="co"># SG&amp;A expenses</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"xint"</span>] <span class="op">=</span> df.get(<span class="st">"is_interest_expense"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)  <span class="co"># Interest expense</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ni"</span>] <span class="op">=</span> df.get(<span class="st">"is_eat"</span>, np.nan)                      <span class="co"># Net income</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"oibdp"</span>] <span class="op">=</span> df.get(<span class="st">"is_net_business_profit"</span>, np.nan)   <span class="co"># Operating income</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Cash Flow Items ===</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"oancf"</span>] <span class="op">=</span> df.get(<span class="st">"total_cfo"</span>, np.nan)  <span class="co"># Operating cash flow</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"capx"</span>] <span class="op">=</span> df.get(<span class="st">"capex"</span>, np.nan)       <span class="co"># Capital expenditures</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> create_standard_variables(df_fundamentals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-book-equity-and-profitability" class="level3" data-number="3.5.5">
<h3 data-number="3.5.5" class="anchored" data-anchor-id="computing-book-equity-and-profitability"><span class="header-section-number">3.5.5</span> Computing Book Equity and Profitability</h3>
<p>Book equity is a crucial variable for value investing strategies and the construction of HML (High Minus Low) factor portfolios. We follow the definition from Kenneth French’s data library, which accounts for deferred taxes and preferred stock.</p>
<div id="e63265d3" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_book_equity(df):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute book equity following Fama-French conventions.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Book equity = Stockholders' equity </span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">                  + Deferred taxes and investment tax credit</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">                  - Preferred stock</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Negative or zero book equity is set to missing, as book-to-market</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ratios are undefined for such firms.</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with standardized variables</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with book equity (be) added</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Primary measure: stockholders' equity</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 1: common equity + preferred stock</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 2: total assets - total liabilities</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    seq_measure <span class="op">=</span> (df[<span class="st">"seq"</span>]</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"ceq"</span>] <span class="op">+</span> df[<span class="st">"pstk"</span>])</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"at"</span>] <span class="op">-</span> df[<span class="st">"lt"</span>])</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add deferred taxes</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    deferred_taxes <span class="op">=</span> (df[<span class="st">"txditc"</span>]</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"txdb"</span>] <span class="op">+</span> df[<span class="st">"itcb"</span>])</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subtract preferred stock (use redemption value as primary)</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    preferred <span class="op">=</span> (df[<span class="st">"pstkrv"</span>]</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"pstkl"</span>])</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"pstk"</span>])</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Book equity calculation</span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> seq_measure <span class="op">+</span> deferred_taxes <span class="op">-</span> preferred</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set non-positive book equity to missing</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> df[<span class="st">"be"</span>].where(df[<span class="st">"be"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_book_equity(df_fundamentals)</span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics for book equity</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Book Equity Summary Statistics (in million VND):"</span>)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_fundamentals[<span class="st">"be"</span>].describe().<span class="bu">round</span>(<span class="dv">2</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Book Equity Summary Statistics (in million VND):
count    2.023500e+04
mean     1.031884e+12
std      4.705269e+12
min      4.404402e+07
25%      7.267610e+10
50%      1.803885e+11
75%      5.304653e+11
max      1.836314e+14
Name: be, dtype: float64</code></pre>
</div>
</div>
<p>Operating profitability, introduced by <span class="citation" data-cites="FamaFrench2015">Fama and French (<a href="references.html#ref-FamaFrench2015" role="doc-biblioref">2015</a>)</span>, measures a firm’s profits relative to its book equity. Firms with higher operating profitability tend to have higher expected returns.</p>
<div id="3788eadb" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_profitability(df):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute operating profitability following Fama-French (2015).</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Operating profitability = (Revenue - COGS - SG&amp;A - Interest) / Book Equity</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with book equity computed</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with operating profitability (op) added</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Operating profit before taxes</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    operating_profit <span class="op">=</span> (</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"sale"</span>] </span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"cogs"</span>].fillna(<span class="dv">0</span>) </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"xsga"</span>].fillna(<span class="dv">0</span>) </span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"xint"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by book equity</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"op"</span>] <span class="op">=</span> operating_profit <span class="op">/</span> df[<span class="st">"be"</span>]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Winsorize extreme values (outside 1st and 99th percentiles)</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> df[<span class="st">"op"</span>].quantile(<span class="fl">0.01</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> df[<span class="st">"op"</span>].quantile(<span class="fl">0.99</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"op"</span>] <span class="op">=</span> df[<span class="st">"op"</span>].clip(lower<span class="op">=</span>lower, upper<span class="op">=</span>upper)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_profitability(df_fundamentals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-investment" class="level3" data-number="3.5.6">
<h3 data-number="3.5.6" class="anchored" data-anchor-id="computing-investment"><span class="header-section-number">3.5.6</span> Computing Investment</h3>
<p>Investment, measured as asset growth, captures firms’ investment behavior. <span class="citation" data-cites="FamaFrench2015">Fama and French (<a href="references.html#ref-FamaFrench2015" role="doc-biblioref">2015</a>)</span> document that firms with high asset growth (aggressive investment) tend to have lower future returns.</p>
<div id="b85c9055" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_investment(df):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute investment (asset growth) following Fama-French (2015).</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Investment = (Total Assets_t / Total Assets_{t-1}) - 1</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals data</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with investment (inv) added</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create lagged assets</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    df_lag <span class="op">=</span> (df[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"at"</span>]]</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>        .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"year"</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"at"</span>: <span class="st">"at_lag"</span>})</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge lagged values</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(df_lag, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute investment (asset growth)</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"inv"</span>] <span class="op">=</span> df[<span class="st">"at"</span>] <span class="op">/</span> df[<span class="st">"at_lag"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set to missing if lagged assets non-positive</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"inv"</span>] <span class="op">=</span> df[<span class="st">"inv"</span>].where(df[<span class="st">"at_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_investment(df_fundamentals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-total-debt" class="level3" data-number="3.5.7">
<h3 data-number="3.5.7" class="anchored" data-anchor-id="computing-total-debt"><span class="header-section-number">3.5.7</span> Computing Total Debt</h3>
<p>In Vietnamese financial statements, total liabilities include non-interest-bearing items such as accounts payable and tax payables. For leverage analysis, we compute total interest-bearing debt by aggregating loan and lease obligations.</p>
<div id="89c25b8f" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_total_debt(df):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute total interest-bearing debt.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Total Debt = Short-term loans + Finance leases (current)</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">                 + Current portion of long-term debt</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">                 + Long-term loans + Finance leases (non-current)</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals data</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with total_debt added</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"total_debt"</span>] <span class="op">=</span> (</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_loan"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>           <span class="co"># Short-term bank loans</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_finlease"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>       <span class="co"># Current finance leases</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_due_long_debt"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>  <span class="co"># Current portion LT debt</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"nl_loan"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>           <span class="co"># Long-term bank loans</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"nl_finlease"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)         <span class="co"># Non-current finance leases</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_total_debt(df_fundamentals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="applying-filters-and-final-preparation" class="level3" data-number="3.5.8">
<h3 data-number="3.5.8" class="anchored" data-anchor-id="applying-filters-and-final-preparation"><span class="header-section-number">3.5.8</span> Applying Filters and Final Preparation</h3>
<p>We apply standard filters to ensure data quality: requiring positive assets, non-negative sales, and presence of core variables needed for portfolio construction.</p>
<div id="00e5cca7" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only observations with required variables</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>required_vars <span class="op">=</span> [<span class="st">"at"</span>, <span class="st">"lt"</span>, <span class="st">"seq"</span>, <span class="st">"sale"</span>]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> df_fundamentals.dropna(subset<span class="op">=</span>required_vars)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply quality filters</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> comp_vn.query(<span class="st">"at &gt; 0"</span>)      <span class="co"># Positive assets</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> comp_vn.query(<span class="st">"sale &gt;= 0"</span>)   <span class="co"># Non-negative sales</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep last observation per firm-year (in case of restatements)</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> (comp_vn</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"datadate"</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">1</span>)</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic summary</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final sample: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample period: </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final sample: 20,091 firm-year observations
Unique firms: 1,502
Sample period: 1998 - 2023</code></pre>
</div>
</div>
</section>
<section id="storing-fundamentals-data" class="level3" data-number="3.5.9">
<h3 data-number="3.5.9" class="anchored" data-anchor-id="storing-fundamentals-data"><span class="header-section-number">3.5.9</span> Storing Fundamentals Data</h3>
<p>We store the prepared fundamentals data in our local SQLite database for use in subsequent chapters.</p>
<div id="e5783a05" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>comp_vn.to_sql(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"comp_vn"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Company fundamentals saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Company fundamentals saved to database.</code></pre>
</div>
</div>
</section>
</section>
<section id="stock-price-data" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="stock-price-data"><span class="header-section-number">3.6</span> Stock Price Data</h2>
<p>Stock price data forms the foundation of return-based analyses in empirical finance. Datacore provides comprehensive historical price data for all securities traded on HOSE, HNX, and UPCoM, including adjusted prices that account for corporate actions.</p>
<section id="downloading-price-data" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="downloading-price-data"><span class="header-section-number">3.6.1</span> Downloading Price Data</h3>
<p>We download the historical price data from Datacore’s storage system. The data includes daily observations with open, high, low, close prices, trading volume, and adjustment factors.</p>
<div id="8c95675b" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical price data</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>prices_raw <span class="op">=</span> conn.read_csv(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    bucket_name,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"historycal_price/dataset_historical_price.csv"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    low_memory<span class="op">=</span><span class="va">False</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Downloaded </span><span class="sc">{</span><span class="bu">len</span>(prices_raw)<span class="sc">:,}</span><span class="ss"> daily price observations"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_raw[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_raw[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloaded 4,307,791 daily price observations
Date range: 2010-01-04 to 2025-05-12</code></pre>
</div>
</div>
</section>
<section id="processing-price-data" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="processing-price-data"><span class="header-section-number">3.6.2</span> Processing Price Data</h3>
<p>We clean the price data and compute adjusted prices that account for stock splits, stock dividends, and other corporate actions.</p>
<div id="b1c2504d" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_price_data(df):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Process raw price data from Datacore.</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse dates</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize column names</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"open_price"</span>: <span class="st">"open"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high_price"</span>: <span class="st">"high"</span>,</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"low_price"</span>: <span class="st">"low"</span>,</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"close_price"</span>: <span class="st">"close"</span>,</span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vol_total"</span>: <span class="st">"volume"</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute adjusted close price</span></span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"adjusted_close"</span>] <span class="op">=</span> df[<span class="st">"close"</span>] <span class="op">*</span> df[<span class="st">"adj_ratio"</span>]</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize symbol</span></span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"symbol"</span>] <span class="op">=</span> df[<span class="st">"symbol"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.upper().<span class="bu">str</span>.strip()</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort for return calculation</span></span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add year and month</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"year"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"month"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.month</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> process_price_data(prices_raw)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-shares-outstanding-and-market-capitalization" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="computing-shares-outstanding-and-market-capitalization"><span class="header-section-number">3.6.3</span> Computing Shares Outstanding and Market Capitalization</h3>
<p>Market capitalization is computed as the product of price and shares outstanding. Since Datacore provides earnings per share and net income, we can infer shares outstanding from these variables.</p>
<div id="26cefc48" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_shares_outstanding(fundamentals_df):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute shares outstanding from fundamentals.</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> fundamentals_df.copy()</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    shares[<span class="st">"shrout"</span>] <span class="op">=</span> shares[<span class="st">"is_shareholders_eat"</span>] <span class="op">/</span> shares[<span class="st">"basic_eps"</span>]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> shares[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"shrout"</span>]].dropna()</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>shares_outstanding <span class="op">=</span> compute_shares_outstanding(df_fundamentals)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fb62f28d" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_market_cap(df, shares_df):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Add market capitalization to price data.</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(shares_df, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute market cap (in million VND)</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap"</span>] <span class="op">=</span> (df[<span class="st">"close"</span>] <span class="op">*</span> df[<span class="st">"shrout"</span>]) <span class="op">/</span> <span class="dv">1_000_000</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set zero or negative market cap to missing</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap"</span>] <span class="op">=</span> df[<span class="st">"mktcap"</span>].where(df[<span class="st">"mktcap"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> add_market_cap(prices, shares_outstanding)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="computing-returns-and-excess-returns" class="level3" data-number="3.6.4">
<h3 data-number="3.6.4" class="anchored" data-anchor-id="computing-returns-and-excess-returns"><span class="header-section-number">3.6.4</span> Computing Returns and Excess Returns</h3>
<p>We compute returns using adjusted closing prices to ensure returns correctly reflect total shareholder returns including dividends and corporate actions.</p>
<section id="creating-daily-dataset" class="level4" data-number="3.6.4.1">
<h4 data-number="3.6.4.1" class="anchored" data-anchor-id="creating-daily-dataset"><span class="header-section-number">3.6.4.1</span> Creating Daily Dataset</h4>
<ol type="1">
<li>Sequential version</li>
</ol>
<div id="9e83160d" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_daily_dataset(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create daily price dataset with returns and excess returns.</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by symbol and date (critical for correct return calculation)</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates within each symbol (keep last observation)</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme negative returns</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Daily risk-free rate (assuming 252 trading days)</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>] <span class="op">-</span> df[<span class="st">"risk_free"</span>]</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> create_daily_dataset(prices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="2" type="1">
<li>Parallel version</li>
</ol>
<div id="e09534a9" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_daily_symbol(symbol_df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single symbol's daily data.</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> symbol_df.copy()</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date (critical for correct return calculation)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates (keep last observation if duplicates exist)</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace infinite values with NaN</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme negative returns</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Daily risk-free rate</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>] <span class="op">-</span> df[<span class="st">"risk_free"</span>]</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> df[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_daily_dataset_parallel(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co">    Create daily price dataset using parallel processing.</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted before splitting</span></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by symbol</span></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    symbol_groups <span class="op">=</span> [group <span class="cf">for</span> _, group <span class="kw">in</span> df.groupby(<span class="st">"symbol"</span>)]</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>    n_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, os.cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(symbol_groups)<span class="sc">:,}</span><span class="ss"> symbols using </span><span class="sc">{</span>n_jobs<span class="sc">}</span><span class="ss"> cores..."</span>)</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_jobs, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>        delayed(process_daily_symbol)(group, annual_rf) </span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> group <span class="kw">in</span> symbol_groups</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> create_daily_dataset_parallel(prices)</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick validation</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Validation checks:"</span>)</span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Any duplicate (symbol, date): </span><span class="sc">{</span>prices_daily<span class="sc">.</span>duplicated(subset<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'date'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample of non-zero returns:"</span>)</span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily[prices_daily[<span class="st">"ret"</span>] <span class="op">!=</span> <span class="dv">0</span>][[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>prices_daily.query(<span class="st">"symbol == 'FPT'"</span>)[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing 1,837 symbols using 87 cores...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Validation checks:
Any duplicate (symbol, date): 0
Sample of non-zero returns:
   symbol       date  adjusted_close       ret
0     A32 2018-10-23       44.574418       NaN
27    A32 2018-11-29       55.072640  0.235521
30    A32 2018-12-04       48.188560 -0.125000
43    A32 2018-12-21       51.974804  0.078571
49    A32 2019-01-02       55.072640  0.059603
53    A32 2019-01-08       50.030370 -0.091557
74    A32 2019-02-13       44.289180 -0.114754
75    A32 2019-02-14       41.008500 -0.074074
78    A32 2019-02-19       36.087480 -0.120000
91    A32 2019-03-08       41.336568  0.145455</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">adjusted_close</th>
<th data-quarto-table-cell-role="th">ret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">1146076</th>
<td>FPT</td>
<td>2010-01-04</td>
<td>1170.9885</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1146077</th>
<td>FPT</td>
<td>2010-01-05</td>
<td>1170.9885</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">1146078</th>
<td>FPT</td>
<td>2010-01-06</td>
<td>1149.6978</td>
<td>-0.018182</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="dcc669ec" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>daily_columns <span class="op">=</span> [</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adjusted_close"</span>, <span class="st">"shrout"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret"</span>, <span class="st">"risk_free"</span>, <span class="st">"ret_excess"</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> prices_daily[daily_columns]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing essential variables</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> prices_daily.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Return Summary Statistics:"</span>)</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final daily sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Daily Return Summary Statistics:
count    3.462157e+06
mean     3.000000e-04
std      4.480000e-02
min     -9.900000e-01
25%     -4.900000e-03
50%      0.000000e+00
75%      4.000000e-03
max      3.250000e+01
Name: ret, dtype: float64

Final daily sample: 3,462,157 observations</code></pre>
</div>
</div>
</section>
<section id="creating-monthly-dataset" class="level4" data-number="3.6.4.2">
<h4 data-number="3.6.4.2" class="anchored" data-anchor-id="creating-monthly-dataset"><span class="header-section-number">3.6.4.2</span> Creating Monthly Dataset</h4>
<p>For monthly returns, we compute returns directly from month-end adjusted prices rather than compounding daily returns. This avoids compounding errors from missing days and is the standard approach in empirical finance.</p>
<ol type="1">
<li>Sequential version</li>
</ol>
<div id="231ac7a7" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_monthly_dataset(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Create monthly price dataset with returns computed from </span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">    month-end to month-end adjusted prices.</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by symbol and date (critical for correct return calculation)</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates within each symbol (keep last observation)</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get month-end observations</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> (df</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        .resample(<span class="st">"ME"</span>, on<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        .agg({</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"open"</span>: <span class="st">"first"</span>,           <span class="co"># First day open</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"high"</span>: <span class="st">"max"</span>,             <span class="co"># Monthly high</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"low"</span>: <span class="st">"min"</span>,              <span class="co"># Monthly low</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"close"</span>: <span class="st">"last"</span>,           <span class="co"># Last day close</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volume"</span>: <span class="st">"sum"</span>,           <span class="co"># Total monthly volume</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"adjusted_close"</span>: <span class="st">"last"</span>,  <span class="co"># Month-end adjusted price</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shrout"</span>: <span class="st">"last"</span>,          <span class="co"># Month-end shares outstanding</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mktcap"</span>: <span class="st">"last"</span>,          <span class="co"># Month-end market cap</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"year"</span>: <span class="st">"last"</span>,</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"month"</span>: <span class="st">"last"</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate (symbol, date) after resampling (safety check)</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort again after resampling</span></span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute monthly returns from month-end to month-end adjusted prices</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme returns</span></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly risk-free rate</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>] <span class="op">-</span> monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap for portfolio weighting</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> monthly.groupby(<span class="st">"symbol"</span>)[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> create_monthly_dataset(prices)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ol start="2" type="1">
<li>Parallel version</li>
</ol>
<div id="39bfcaad" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_monthly_symbol(symbol_df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single symbol's data to monthly frequency.</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> symbol_df.copy()</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date (critical for correct return calculation)</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates (keep last observation if duplicates exist)</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set date as index for resampling</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.set_index(<span class="st">"date"</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample to monthly</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> df.resample(<span class="st">"ME"</span>).agg({</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">"symbol"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"open"</span>: <span class="st">"first"</span>,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high"</span>: <span class="st">"max"</span>,</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"low"</span>: <span class="st">"min"</span>,</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"close"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"volume"</span>: <span class="st">"sum"</span>,</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"adjusted_close"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shrout"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mktcap"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>: <span class="st">"last"</span>,</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: <span class="st">"last"</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows where symbol is NaN (months with no trading)</span></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.dropna(subset<span class="op">=</span>[<span class="st">"symbol"</span>])</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute monthly returns</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace infinite values with NaN</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme returns</span></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly risk-free rate</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>] <span class="op">-</span> monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> monthly[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_monthly_dataset_parallel(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Create monthly price dataset using parallel processing.</span></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted before splitting</span></span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by symbol</span></span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a>    symbol_groups <span class="op">=</span> [group <span class="cf">for</span> _, group <span class="kw">in</span> df.groupby(<span class="st">"symbol"</span>)]</span>
<span id="cb35-70"><a href="#cb35-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-71"><a href="#cb35-71" aria-hidden="true" tabindex="-1"></a>    n_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, os.cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(symbol_groups)<span class="sc">:,}</span><span class="ss"> symbols using </span><span class="sc">{</span>n_jobs<span class="sc">}</span><span class="ss"> cores..."</span>)</span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_jobs, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a>        delayed(process_monthly_symbol)(group, annual_rf) </span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> group <span class="kw">in</span> symbol_groups</span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> create_monthly_dataset_parallel(prices)</span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation checks</span></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Validation checks:"</span>)</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Any duplicate (symbol, date): </span><span class="sc">{</span>prices_monthly<span class="sc">.</span>duplicated(subset<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'date'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Sample of non-zero returns:"</span>)</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[prices_monthly[<span class="st">"ret"</span>] <span class="op">!=</span> <span class="dv">0</span>][[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a>prices_monthly.query(<span class="st">"symbol == 'FPT'"</span>)[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">3</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Processing 1,837 symbols using 87 cores...</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Validation checks:
Any duplicate (symbol, date): 0

Sample of non-zero returns:
   symbol       date  adjusted_close       ret
0     A32 2018-10-31       44.574418       NaN
1     A32 2018-11-30       55.072640  0.235521
2     A32 2018-12-31       51.974804 -0.056250
3     A32 2019-01-31       50.030370 -0.037411
4     A32 2019-02-28       36.087480 -0.278689
5     A32 2019-03-31       41.828670  0.159091
7     A32 2019-05-31       43.304976  0.035294
8     A32 2019-06-30       35.929125 -0.170323
9     A32 2019-07-31       37.525975  0.044444
10    A32 2019-08-31       38.324400  0.021277</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">adjusted_close</th>
<th data-quarto-table-cell-role="th">ret</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">55963</th>
<td>FPT</td>
<td>2010-01-31</td>
<td>1092.9226</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">55964</th>
<td>FPT</td>
<td>2010-02-28</td>
<td>1107.1164</td>
<td>0.012987</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">55965</th>
<td>FPT</td>
<td>2010-03-31</td>
<td>1185.1823</td>
<td>0.070513</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="e5b034be" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns (same structure as daily)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>monthly_columns <span class="op">=</span> [</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adjusted_close"</span>, <span class="st">"shrout"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>,</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret"</span>, <span class="st">"risk_free"</span>, <span class="st">"ret_excess"</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly[monthly_columns]</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing essential variables</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Monthly Return Summary Statistics:"</span>)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final monthly sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Monthly Return Summary Statistics:
count    165499.0000
mean          0.0042
std           0.1862
min          -0.9900
25%          -0.0703
50%           0.0000
75%           0.0553
max          12.7500
Name: ret, dtype: float64

Final monthly sample: 165,499 observations</code></pre>
</div>
</div>
</section>
</section>
<section id="storing-price-data" class="level3" data-number="3.6.5">
<h3 data-number="3.6.5" class="anchored" data-anchor-id="storing-price-data"><span class="header-section-number">3.6.5</span> Storing Price Data</h3>
<div id="44691cde" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>prices_daily.to_sql(</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"prices_daily"</span>,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily price data saved to database."</span>)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>prices_monthly.to_sql(</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"prices_monthly"</span>,</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Monthly price data saved to database."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="descriptive-statistics" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="descriptive-statistics"><span class="header-section-number">3.7</span> Descriptive Statistics</h2>
<p>Before proceeding to asset pricing analyses, we examine the characteristics of our sample to understand the Vietnamese equity market’s evolution and composition.</p>
<section id="market-evolution-over-time" class="level3" data-number="3.7.1">
<h3 data-number="3.7.1" class="anchored" data-anchor-id="market-evolution-over-time"><span class="header-section-number">3.7.1</span> Market Evolution Over Time</h3>
<p>We first examine how the number of listed securities has grown over time.</p>
<div id="6bd4f40f" class="cell" data-execution_count="26">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>securities_over_time <span class="op">=</span> (prices_monthly</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>        n_securities<span class="op">=</span>(<span class="st">"symbol"</span>, <span class="st">"nunique"</span>),</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>        total_mktcap<span class="op">=</span>(<span class="st">"mktcap"</span>, <span class="st">"sum"</span>)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="cell-fig-securities-over-time" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>securities_figure <span class="op">=</span> (</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>    ggplot(securities_over_time, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"n_securities"</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"steelblue"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of Securities"</span>,</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Growth of Vietnamese Stock Market"</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>securities_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-securities-over-time" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing the growth in number of listed securities over time.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-securities-over-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02_datacore_data_files/figure-html/fig-securities-over-time-output-1.png" alt="Line chart showing the growth in number of listed securities over time." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-securities-over-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: The figure shows the monthly number of securities in the Vietnamese stock market sample.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="market-capitalization-evolution" class="level3" data-number="3.7.2">
<h3 data-number="3.7.2" class="anchored" data-anchor-id="market-capitalization-evolution"><span class="header-section-number">3.7.2</span> Market Capitalization Evolution</h3>
<p>The aggregate market capitalization reflects the overall size and development of the Vietnamese equity market.</p>
<div id="cell-fig-market-cap-over-time" class="cell" data-execution_count="28">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>mktcap_figure <span class="op">=</span> (</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    ggplot(securities_over_time, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"total_mktcap / 1000"</span>))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Market Cap (Trillion VND)"</span>,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Total Market Capitalization of Vietnamese Equities"</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>mktcap_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-market-cap-over-time" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing total market capitalization growth.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-market-cap-over-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02_datacore_data_files/figure-html/fig-market-cap-over-time-output-1.png" alt="Line chart showing total market capitalization growth." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-market-cap-over-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: The figure shows the total market capitalization of Vietnamese listed companies over time.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="return-distribution" class="level3" data-number="3.7.3">
<h3 data-number="3.7.3" class="anchored" data-anchor-id="return-distribution"><span class="header-section-number">3.7.3</span> Return Distribution</h3>
<p>Understanding the distribution of monthly returns helps identify potential data quality issues and characterize market risk.</p>
<div id="cell-fig-return-distribution" class="cell" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>return_distribution <span class="op">=</span> (</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    ggplot(prices_monthly, aes(x<span class="op">=</span><span class="st">"ret_excess"</span>))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_histogram(</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>        binwidth<span class="op">=</span><span class="fl">0.02</span>, </span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"steelblue"</span>, </span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly Excess Return"</span>,</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Monthly Excess Returns"</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_continuous(limits<span class="op">=</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>return_distribution.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-return-distribution" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Histogram showing the distribution of monthly excess returns.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-return-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02_datacore_data_files/figure-html/fig-return-distribution-output-1.png" alt="Histogram showing the distribution of monthly excess returns." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-return-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Distribution of monthly excess returns for Vietnamese stocks.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="coverage-of-book-equity" class="level3" data-number="3.7.4">
<h3 data-number="3.7.4" class="anchored" data-anchor-id="coverage-of-book-equity"><span class="header-section-number">3.7.4</span> Coverage of Book Equity</h3>
<p>Book equity is essential for constructing value portfolios. We examine what fraction of our sample has book equity data available over time.</p>
<div id="cell-fig-book-equity-coverage" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge prices with fundamentals</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>coverage_data <span class="op">=</span> (prices_monthly</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.year)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">1</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    .merge(comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"be"</span>]], </span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>           on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>           how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute coverage by year</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>be_coverage <span class="op">=</span> (coverage_data</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"share_with_be"</span>: x[<span class="st">"be"</span>].notna().mean()</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>coverage_figure <span class="op">=</span> (</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    ggplot(be_coverage, aes(x<span class="op">=</span><span class="st">"year"</span>, y<span class="op">=</span><span class="st">"share_with_be"</span>))</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_point(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Share with Book Equity"</span>,</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Coverage of Book Equity Data"</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format(), limits<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a>coverage_figure.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-book-equity-coverage" class="quarto-float quarto-figure quarto-figure-center anchored" alt="Line chart showing the coverage of book equity data over time.">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-book-equity-coverage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="02_datacore_data_files/figure-html/fig-book-equity-coverage-output-1.png" alt="Line chart showing the coverage of book equity data over time." width="672" height="480" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-book-equity-coverage-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Share of securities with available book equity data by year.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="merging-stock-and-fundamental-data" class="level2" data-number="3.8">
<h2 data-number="3.8" class="anchored" data-anchor-id="merging-stock-and-fundamental-data"><span class="header-section-number">3.8</span> Merging Stock and Fundamental Data</h2>
<p>The final step links price data with fundamental data using the stock symbol as the common identifier. This merged dataset forms the basis for constructing portfolios sorted on firm characteristics.</p>
<div id="1d22dcee" class="cell" data-execution_count="31">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Create merged dataset for end-of-June each year</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> (prices_monthly</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"month == 6"</span>)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"be"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>, <span class="st">"at"</span>]],</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>],</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        suffixes<span class="op">=</span>(<span class="st">""</span>, <span class="st">"_fundamental"</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert BE from VND to BILLION VND</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"be"</span>] <span class="op">=</span> merged_data[<span class="st">"be"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute book-to-market ratio</span></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"bm"</span>] <span class="op">=</span> merged_data[<span class="st">"be"</span>] <span class="op">/</span> merged_data[<span class="st">"mktcap"</span>]</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>merged_data.loc[</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    (merged_data[<span class="st">"bm"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">|</span></span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    (merged_data[<span class="st">"bm"</span>] <span class="op">&gt;</span> <span class="dv">20</span>),</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bm"</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> pd.NA</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"bm"</span>].describe(percentiles<span class="op">=</span>[<span class="fl">.01</span>, <span class="fl">.1</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">.99</span>])</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged observations: </span><span class="sc">{</span><span class="bu">len</span>(merged_data)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"With book-to-market: </span><span class="sc">{</span>merged_data[<span class="st">'bm'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>merged_data.head(<span class="dv">3</span>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>merged_data.describe()</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>merged_data</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Merged observations: 13,756
With book-to-market: 12,859</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="28">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">symbol</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">open</th>
<th data-quarto-table-cell-role="th">high</th>
<th data-quarto-table-cell-role="th">low</th>
<th data-quarto-table-cell-role="th">close</th>
<th data-quarto-table-cell-role="th">volume</th>
<th data-quarto-table-cell-role="th">adjusted_close</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">mktcap</th>
<th data-quarto-table-cell-role="th">mktcap_lag</th>
<th data-quarto-table-cell-role="th">ret</th>
<th data-quarto-table-cell-role="th">risk_free</th>
<th data-quarto-table-cell-role="th">ret_excess</th>
<th data-quarto-table-cell-role="th">be</th>
<th data-quarto-table-cell-role="th">op</th>
<th data-quarto-table-cell-role="th">inv</th>
<th data-quarto-table-cell-role="th">at</th>
<th data-quarto-table-cell-role="th">bm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>A32</td>
<td>2019-06-30</td>
<td>2019.0</td>
<td>6.0</td>
<td>26.4</td>
<td>26.4</td>
<td>21.0</td>
<td>22.5</td>
<td>3700</td>
<td>35.929125</td>
<td>...</td>
<td>153.000</td>
<td>179.52</td>
<td>-0.170323</td>
<td>0.003333</td>
<td>-0.173657</td>
<td>223.612748</td>
<td>0.232362</td>
<td>-0.072329</td>
<td>4.349303e+11</td>
<td>1.461521</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>A32</td>
<td>2020-06-30</td>
<td>2020.0</td>
<td>6.0</td>
<td>25.0</td>
<td>26.3</td>
<td>24.5</td>
<td>26.3</td>
<td>7500</td>
<td>38.811173</td>
<td>...</td>
<td>178.840</td>
<td>187.00</td>
<td>-0.067977</td>
<td>0.003333</td>
<td>-0.071311</td>
<td>242.216943</td>
<td>0.195565</td>
<td>0.122698</td>
<td>4.882955e+11</td>
<td>1.354378</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>A32</td>
<td>2021-06-30</td>
<td>2021.0</td>
<td>6.0</td>
<td>30.2</td>
<td>37.0</td>
<td>29.5</td>
<td>32.0</td>
<td>78400</td>
<td>45.363520</td>
<td>...</td>
<td>217.600</td>
<td>214.20</td>
<td>0.015873</td>
<td>0.003333</td>
<td>0.012540</td>
<td>238.385190</td>
<td>0.157723</td>
<td>0.081581</td>
<td>5.281309e+11</td>
<td>1.095520</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>A32</td>
<td>2022-06-30</td>
<td>2022.0</td>
<td>6.0</td>
<td>30.9</td>
<td>35.5</td>
<td>25.0</td>
<td>35.3</td>
<td>15200</td>
<td>47.503210</td>
<td>...</td>
<td>240.040</td>
<td>210.12</td>
<td>0.142395</td>
<td>0.003333</td>
<td>0.139061</td>
<td>215.399735</td>
<td>0.172085</td>
<td>0.036584</td>
<td>5.474523e+11</td>
<td>0.897349</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>A32</td>
<td>2023-06-30</td>
<td>2023.0</td>
<td>6.0</td>
<td>30.1</td>
<td>33.5</td>
<td>29.2</td>
<td>29.4</td>
<td>2400</td>
<td>35.064204</td>
<td>...</td>
<td>199.920</td>
<td>204.68</td>
<td>-0.023256</td>
<td>0.003333</td>
<td>-0.026589</td>
<td>222.024135</td>
<td>0.174658</td>
<td>-0.076752</td>
<td>5.054342e+11</td>
<td>1.110565</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">...</th>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13751</th>
<td>YTC</td>
<td>2019-06-30</td>
<td>2019.0</td>
<td>6.0</td>
<td>70.0</td>
<td>79.9</td>
<td>70.0</td>
<td>79.9</td>
<td>38900</td>
<td>171.451817</td>
<td>...</td>
<td>246.092</td>
<td>215.60</td>
<td>0.141429</td>
<td>0.003333</td>
<td>0.138095</td>
<td>59.901389</td>
<td>0.738190</td>
<td>-0.021758</td>
<td>7.521980e+11</td>
<td>0.243411</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13752</th>
<td>YTC</td>
<td>2020-06-30</td>
<td>2020.0</td>
<td>6.0</td>
<td>88.5</td>
<td>88.5</td>
<td>77.0</td>
<td>87.0</td>
<td>150640</td>
<td>180.966960</td>
<td>...</td>
<td>267.960</td>
<td>272.58</td>
<td>-0.016949</td>
<td>0.003333</td>
<td>-0.020282</td>
<td>13.459082</td>
<td>-0.458548</td>
<td>0.323501</td>
<td>9.955348e+11</td>
<td>0.050228</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13753</th>
<td>YTC</td>
<td>2021-06-30</td>
<td>2021.0</td>
<td>6.0</td>
<td>76.0</td>
<td>115.5</td>
<td>61.0</td>
<td>61.0</td>
<td>34100</td>
<td>126.884880</td>
<td>...</td>
<td>187.880</td>
<td>234.08</td>
<td>-0.197368</td>
<td>0.003333</td>
<td>-0.200702</td>
<td>21.746595</td>
<td>0.539521</td>
<td>-0.215694</td>
<td>7.808035e+11</td>
<td>0.115747</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">13754</th>
<td>YTC</td>
<td>2022-06-30</td>
<td>2022.0</td>
<td>6.0</td>
<td>68.0</td>
<td>68.0</td>
<td>65.0</td>
<td>65.5</td>
<td>200</td>
<td>136.245240</td>
<td>...</td>
<td>201.740</td>
<td>209.44</td>
<td>-0.036765</td>
<td>0.003333</td>
<td>-0.040098</td>
<td>32.403055</td>
<td>0.483088</td>
<td>0.182911</td>
<td>9.236206e+11</td>
<td>0.160618</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">13755</th>
<td>YTC</td>
<td>2023-06-30</td>
<td>2023.0</td>
<td>6.0</td>
<td>59.0</td>
<td>59.0</td>
<td>59.0</td>
<td>59.0</td>
<td>49545</td>
<td>122.724720</td>
<td>...</td>
<td>181.720</td>
<td>181.72</td>
<td>0.000000</td>
<td>0.003333</td>
<td>-0.003333</td>
<td>38.976624</td>
<td>0.450157</td>
<td>0.017930</td>
<td>9.401815e+11</td>
<td>0.214487</td>
</tr>
</tbody>
</table>

<p>13756 rows × 21 columns</p>
</div>
</div>
</div>
<div id="d581bc00" class="cell" data-execution_count="32">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>bm_plot_data <span class="op">=</span> (</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"bm"</span>]]</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>      .assign(bm_plot<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"bm"</span>].clip(upper<span class="op">=</span><span class="dv">10</span>))</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    ggplot(bm_plot_data, aes(x<span class="op">=</span><span class="st">"bm_plot"</span>)) <span class="op">+</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">80</span>) <span class="op">+</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Book to Market Ratios"</span>,</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Book to Market (capped at 10 for plotting)"</span>,</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of firms"</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<div>
<figure class="figure">
<p><img src="02_datacore_data_files/figure-html/cell-33-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="2ffa8269" class="cell" data-execution_count="33">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>size_plot_data <span class="op">=</span> (</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"mktcap_lag"</span>]]</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>      .assign(log_size<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>    ggplot(size_plot_data, aes(x<span class="op">=</span><span class="st">"log_size"</span>)) <span class="op">+</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">80</span>) <span class="op">+</span></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Log Market Capitalization"</span>,</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Log Market Cap"</span>,</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of firms"</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<div>
<figure class="figure">
<p><img src="02_datacore_data_files/figure-html/cell-34-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="36f7e0e6" class="cell" data-execution_count="34">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>scatter_data <span class="op">=</span> (</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"be"</span>, <span class="st">"mktcap_lag"</span>]]</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>      .assign(</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>          log_be<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"be"</span>]),</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>          log_me<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>    ggplot(scatter_data, aes(x<span class="op">=</span><span class="st">"log_me"</span>, y<span class="op">=</span><span class="st">"log_be"</span>)) <span class="op">+</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>    geom_point(alpha<span class="op">=</span><span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Log Book Equity vs Log Market Equity"</span>,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Log Market Cap"</span>,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Log Book Equity"</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<div>
<figure class="figure">
<p><img src="02_datacore_data_files/figure-html/cell-35-output-1.png" width="672" height="480" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="key-takeaways" class="level2" data-number="3.9">
<h2 data-number="3.9" class="anchored" data-anchor-id="key-takeaways"><span class="header-section-number">3.9</span> Key Takeaways</h2>
<ol type="1">
<li><p><strong>Datacore provides unified access</strong> to Vietnamese financial data through a modern cloud-based infrastructure, eliminating the need to aggregate data from multiple fragmented sources.</p></li>
<li><p><strong>Company fundamentals</strong> from Datacore include comprehensive balance sheet, income statement, and cash flow data prepared according to Vietnamese Accounting Standards, which we map to standard variables used in international research.</p></li>
<li><p><strong>Book equity computation</strong> follows the Fama-French methodology, accounting for deferred taxes and preferred stock to ensure comparability with US-based studies.</p></li>
<li><p><strong>Stock price data</strong> includes adjustment factors for corporate actions, enabling accurate return calculations over long horizons.</p></li>
<li><p><strong>Monthly frequency</strong> is standard for asset pricing research, reducing noise while maintaining sufficient observations for statistical inference.</p></li>
<li><p><strong>Risk-free rate approximation</strong> uses Vietnamese government bond yields as a proxy, given the absence of a standardized short-term rate series comparable to US Treasury bills.</p></li>
<li><p><strong>Data quality validation</strong> through descriptive statistics and visualization helps identify potential issues before conducting formal analyses.</p></li>
<li><p><strong>Batch processing</strong> enables efficient handling of large daily datasets that would otherwise exceed memory constraints.</p></li>
</ol>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-FamaFrench2015" class="csl-entry" role="listitem">
Fama, Eugene F., and Kenneth R. French. 2015. <span>“A Five-Factor Asset Pricing Model.”</span> <em>Journal of Financial Economics</em> 116 (1): 1–22. <a href="https://doi.org/10.1016/j.jfineco.2014.10.010">https://doi.org/10.1016/j.jfineco.2014.10.010</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./01_accessing_and_managing_financial_data.html" class="pagination-link" aria-label="Accessing and Managing VN Financial Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./03_market_microstructure.html" class="pagination-link" aria-label="Market Microstructure in Vietnam">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> Datacore Data</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: true</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>This chapter introduces <span class="co">[</span><span class="ot">Datacore</span><span class="co">](https://datacore.vn/)</span>, Vietnam's data platform for academic, corporate, and government research. Datacore provides comprehensive financial and economic datasets, including historical trading data, company fundamentals, and macroeconomic indicators essential for reproducible finance research. We use Datacore as the primary data source throughout this book.</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Access Options</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>Readers can access the data used in this book through several channels:</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Institutional subscription**: Many universities and research institutions subscribe to Datacore. Check with your library or research office for access credentials. If your institution does not yet have a subscription, consider requesting one through your library's acquisition process—Datacore offers institutional pricing for academic use.</span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Demo datasets**: Datacore provides <span class="co">[</span><span class="ot">demo datasets</span><span class="co">](https://datacore.vn/demo/dataset-groups)</span> that allow you to run the code examples in this book with sample data.</span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 3. **Sample data repository**: To ensure reproducibility, we provide a subset of anonymized data in the book's [GitHub repository](https://github.com/mikenguyen13/tidy_finance_vn). This sample covers a limited number of securities and time periods but is sufficient to execute all code examples. --&gt;</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 4. **Alternative data sources**: For readers without Datacore access, we provide guidance on adapting the code to work with publicly available data from sources such as [CafeF](https://cafef.vn/), though coverage and data quality may differ. --&gt;</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="fu">## Chapter Overview</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a>The chapter is organized as follows. We first establish the connection to Datacore's cloud storage infrastructure. Then, we download and prepare company fundamentals data, including balance sheet items, income statement variables, and derived metrics essential for asset pricing research. Next, we retrieve and process stock price data, computing returns, market capitalizations, and excess returns. We conclude by merging these datasets and providing descriptive statistics that characterize the Vietnamese equity market.</span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up the Environment</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a>We begin by loading the Python packages used throughout this chapter. The core packages include <span class="in">`pandas`</span> for data manipulation, <span class="in">`numpy`</span> for numerical operations, and <span class="in">`sqlite3`</span> for local database management. We also import visualization libraries for creating publication-quality figures.</span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> io <span class="im">import</span> BytesIO</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> comma_format, percent_format</span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a>We establish a connection to our local SQLite database, which serves as the central repository for all processed data. This database was introduced in the previous chapter and will store the cleaned datasets for use in subsequent analyses.</span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a>tidy_finance <span class="op">=</span> sqlite3.<span class="ex">connect</span>(database<span class="op">=</span><span class="st">"data/tidy_finance_python.sqlite"</span>)</span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a>We define the date range for our data collection. The Vietnamese stock market began operations in July 2000 with the establishment of the Ho Chi Minh City Stock Exchange (HOSE), so our sample period starts from 2000 and extends through the end of 2024.</span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> <span class="st">"2000-01-01"</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> <span class="st">"2024-12-31"</span></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a><span class="fu">## Connecting to Datacore</span></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a>Datacore delivers data through a cloud-based object storage system built on MinIO, an S3-compatible storage infrastructure. This architecture enables efficient, programmatic access to large datasets without the limitations of traditional database connections. To access the data, you need credentials provided by Datacore upon subscription: an endpoint URL, access key, and secret key.</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a>The following class establishes the connection to Datacore's storage system. The credentials are stored as environment variables for security, following best practices for credential management in research computing environments.</span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-74"><a href="#cb51-74" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-75"><a href="#cb51-75" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb51-76"><a href="#cb51-76" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> boto3</span>
<span id="cb51-77"><a href="#cb51-77" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> botocore.client <span class="im">import</span> Config</span>
<span id="cb51-78"><a href="#cb51-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-79"><a href="#cb51-79" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DatacoreConnection:</span>
<span id="cb51-80"><a href="#cb51-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-81"><a href="#cb51-81" aria-hidden="true" tabindex="-1"></a><span class="co">    Connection handler for Datacore's MinIO-based storage system.</span></span>
<span id="cb51-82"><a href="#cb51-82" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-83"><a href="#cb51-83" aria-hidden="true" tabindex="-1"></a><span class="co">    This class manages authentication and provides methods for</span></span>
<span id="cb51-84"><a href="#cb51-84" aria-hidden="true" tabindex="-1"></a><span class="co">    accessing financial datasets stored in Datacore's cloud infrastructure.</span></span>
<span id="cb51-85"><a href="#cb51-85" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-86"><a href="#cb51-86" aria-hidden="true" tabindex="-1"></a><span class="co">    Attributes</span></span>
<span id="cb51-87"><a href="#cb51-87" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-88"><a href="#cb51-88" aria-hidden="true" tabindex="-1"></a><span class="co">    s3 : boto3.client</span></span>
<span id="cb51-89"><a href="#cb51-89" aria-hidden="true" tabindex="-1"></a><span class="co">        S3-compatible client for interacting with Datacore storage</span></span>
<span id="cb51-90"><a href="#cb51-90" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-91"><a href="#cb51-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-92"><a href="#cb51-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb51-93"><a href="#cb51-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Initialize connection using environment variables."""</span></span>
<span id="cb51-94"><a href="#cb51-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ENDPOINT <span class="op">=</span> os.environ[<span class="st">"MINIO_ENDPOINT"</span>]</span>
<span id="cb51-95"><a href="#cb51-95" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_ACCESS_KEY <span class="op">=</span> os.environ[<span class="st">"MINIO_ACCESS_KEY"</span>]</span>
<span id="cb51-96"><a href="#cb51-96" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.MINIO_SECRET_KEY <span class="op">=</span> os.environ[<span class="st">"MINIO_SECRET_KEY"</span>]</span>
<span id="cb51-97"><a href="#cb51-97" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.REGION <span class="op">=</span> os.getenv(<span class="st">"MINIO_REGION"</span>, <span class="st">"us-east-1"</span>)</span>
<span id="cb51-98"><a href="#cb51-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb51-99"><a href="#cb51-99" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.s3 <span class="op">=</span> boto3.client(</span>
<span id="cb51-100"><a href="#cb51-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">"s3"</span>,</span>
<span id="cb51-101"><a href="#cb51-101" aria-hidden="true" tabindex="-1"></a>            endpoint_url<span class="op">=</span><span class="va">self</span>.MINIO_ENDPOINT,</span>
<span id="cb51-102"><a href="#cb51-102" aria-hidden="true" tabindex="-1"></a>            aws_access_key_id<span class="op">=</span><span class="va">self</span>.MINIO_ACCESS_KEY,</span>
<span id="cb51-103"><a href="#cb51-103" aria-hidden="true" tabindex="-1"></a>            aws_secret_access_key<span class="op">=</span><span class="va">self</span>.MINIO_SECRET_KEY,</span>
<span id="cb51-104"><a href="#cb51-104" aria-hidden="true" tabindex="-1"></a>            region_name<span class="op">=</span><span class="va">self</span>.REGION,</span>
<span id="cb51-105"><a href="#cb51-105" aria-hidden="true" tabindex="-1"></a>            config<span class="op">=</span>Config(signature_version<span class="op">=</span><span class="st">"s3v4"</span>),</span>
<span id="cb51-106"><a href="#cb51-106" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-107"><a href="#cb51-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-108"><a href="#cb51-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test_connection(<span class="va">self</span>):</span>
<span id="cb51-109"><a href="#cb51-109" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Verify connection by listing available buckets."""</span></span>
<span id="cb51-110"><a href="#cb51-110" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.s3.list_buckets()</span>
<span id="cb51-111"><a href="#cb51-111" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Connected successfully. Available buckets:"</span>)</span>
<span id="cb51-112"><a href="#cb51-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bucket <span class="kw">in</span> response.get(<span class="st">"Buckets"</span>, []):</span>
<span id="cb51-113"><a href="#cb51-113" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>bucket[<span class="st">'Name'</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-114"><a href="#cb51-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-115"><a href="#cb51-115" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> list_objects(<span class="va">self</span>, bucket_name, prefix<span class="op">=</span><span class="st">""</span>):</span>
<span id="cb51-116"><a href="#cb51-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""List objects in a bucket with optional prefix filter."""</span></span>
<span id="cb51-117"><a href="#cb51-117" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> <span class="va">self</span>.s3.list_objects_v2(</span>
<span id="cb51-118"><a href="#cb51-118" aria-hidden="true" tabindex="-1"></a>            Bucket<span class="op">=</span>bucket_name, </span>
<span id="cb51-119"><a href="#cb51-119" aria-hidden="true" tabindex="-1"></a>            Prefix<span class="op">=</span>prefix</span>
<span id="cb51-120"><a href="#cb51-120" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb51-121"><a href="#cb51-121" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [obj[<span class="st">"Key"</span>] <span class="cf">for</span> obj <span class="kw">in</span> response.get(<span class="st">"Contents"</span>, [])]</span>
<span id="cb51-122"><a href="#cb51-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-123"><a href="#cb51-123" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_excel(<span class="va">self</span>, bucket_name, key):</span>
<span id="cb51-124"><a href="#cb51-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read an Excel file from Datacore storage."""</span></span>
<span id="cb51-125"><a href="#cb51-125" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> <span class="va">self</span>.s3.get_object(Bucket<span class="op">=</span>bucket_name, Key<span class="op">=</span>key)</span>
<span id="cb51-126"><a href="#cb51-126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_excel(BytesIO(obj[<span class="st">"Body"</span>].read()))</span>
<span id="cb51-127"><a href="#cb51-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-128"><a href="#cb51-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> read_csv(<span class="va">self</span>, bucket_name, key, <span class="op">**</span>kwargs):</span>
<span id="cb51-129"><a href="#cb51-129" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Read a CSV file from Datacore storage."""</span></span>
<span id="cb51-130"><a href="#cb51-130" aria-hidden="true" tabindex="-1"></a>        obj <span class="op">=</span> <span class="va">self</span>.s3.get_object(Bucket<span class="op">=</span>bucket_name, Key<span class="op">=</span>key)</span>
<span id="cb51-131"><a href="#cb51-131" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.read_csv(BytesIO(obj[<span class="st">"Body"</span>].read()), <span class="op">**</span>kwargs)</span>
<span id="cb51-132"><a href="#cb51-132" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-133"><a href="#cb51-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-134"><a href="#cb51-134" aria-hidden="true" tabindex="-1"></a>With the connection class defined, we can establish a connection and verify access to Datacore's data repositories.</span>
<span id="cb51-135"><a href="#cb51-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-138"><a href="#cb51-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-139"><a href="#cb51-139" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize connection</span></span>
<span id="cb51-140"><a href="#cb51-140" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> DatacoreConnection()</span>
<span id="cb51-141"><a href="#cb51-141" aria-hidden="true" tabindex="-1"></a>conn.test_connection()</span>
<span id="cb51-142"><a href="#cb51-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-143"><a href="#cb51-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Get bucket name from environment</span></span>
<span id="cb51-144"><a href="#cb51-144" aria-hidden="true" tabindex="-1"></a>bucket_name <span class="op">=</span> os.environ[<span class="st">"MINIO_BUCKET"</span>]</span>
<span id="cb51-145"><a href="#cb51-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-146"><a href="#cb51-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-147"><a href="#cb51-147" aria-hidden="true" tabindex="-1"></a><span class="fu">## Company Fundamentals Data</span></span>
<span id="cb51-148"><a href="#cb51-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-149"><a href="#cb51-149" aria-hidden="true" tabindex="-1"></a>Firm accounting data are essential for portfolio analyses, factor construction, and valuation studies. Datacore hosts comprehensive fundamentals data for Vietnamese listed companies, including annual and quarterly financial statements prepared according to Vietnamese Accounting Standards (VAS).</span>
<span id="cb51-150"><a href="#cb51-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-151"><a href="#cb51-151" aria-hidden="true" tabindex="-1"></a><span class="fu">### Understanding Vietnamese Financial Statements</span></span>
<span id="cb51-152"><a href="#cb51-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-153"><a href="#cb51-153" aria-hidden="true" tabindex="-1"></a>Before processing the data, it is important to understand the structure of Vietnamese financial reports. Vietnamese companies follow VAS, which shares similarities with International Financial Reporting Standards (IFRS) but has notable differences:</span>
<span id="cb51-154"><a href="#cb51-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-155"><a href="#cb51-155" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Fiscal Year**: Most Vietnamese companies use a calendar fiscal year ending December 31, though some companies (particularly in retail and agriculture) use different fiscal year-ends.</span>
<span id="cb51-156"><a href="#cb51-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-157"><a href="#cb51-157" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Reporting Frequency**: Listed companies must publish quarterly financial statements within 20 days of quarter-end and annual audited statements within 90 days of fiscal year-end.</span>
<span id="cb51-158"><a href="#cb51-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-159"><a href="#cb51-159" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Industry-Specific Formats**: Companies in banking, insurance, and securities sectors follow specialized reporting formats that differ from the standard industrial format.</span>
<span id="cb51-160"><a href="#cb51-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-161"><a href="#cb51-161" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Currency**: All figures are reported in Vietnamese Dong (VND). Given the large nominal values (millions to trillions of VND), we often scale figures to millions or billions for readability.</span>
<span id="cb51-162"><a href="#cb51-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-163"><a href="#cb51-163" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downloading Fundamentals Data</span></span>
<span id="cb51-164"><a href="#cb51-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-165"><a href="#cb51-165" aria-hidden="true" tabindex="-1"></a>Datacore organizes fundamentals data in Excel files partitioned by time period for efficient access. We download and concatenate these files to create a comprehensive dataset spanning our sample period.</span>
<span id="cb51-166"><a href="#cb51-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-169"><a href="#cb51-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-170"><a href="#cb51-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths to fundamentals data files</span></span>
<span id="cb51-171"><a href="#cb51-171" aria-hidden="true" tabindex="-1"></a>fundamentals_paths <span class="op">=</span> [</span>
<span id="cb51-172"><a href="#cb51-172" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_1.xlsx"</span>,</span>
<span id="cb51-173"><a href="#cb51-173" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_2.xlsx"</span>,</span>
<span id="cb51-174"><a href="#cb51-174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fundamental_annual_1767674486317/fundamental_annual_3.xlsx"</span>,</span>
<span id="cb51-175"><a href="#cb51-175" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb51-176"><a href="#cb51-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-177"><a href="#cb51-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Download and combine all files</span></span>
<span id="cb51-178"><a href="#cb51-178" aria-hidden="true" tabindex="-1"></a>fundamentals_list <span class="op">=</span> []</span>
<span id="cb51-179"><a href="#cb51-179" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> path <span class="kw">in</span> fundamentals_paths:</span>
<span id="cb51-180"><a href="#cb51-180" aria-hidden="true" tabindex="-1"></a>    df_temp <span class="op">=</span> conn.read_excel(bucket_name, path)</span>
<span id="cb51-181"><a href="#cb51-181" aria-hidden="true" tabindex="-1"></a>    fundamentals_list.append(df_temp)</span>
<span id="cb51-182"><a href="#cb51-182" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Downloaded: </span><span class="sc">{</span>path<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(df_temp)<span class="sc">:,}</span><span class="ss"> rows)"</span>)</span>
<span id="cb51-183"><a href="#cb51-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-184"><a href="#cb51-184" aria-hidden="true" tabindex="-1"></a>df_fundamentals_raw <span class="op">=</span> pd.concat(fundamentals_list, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-185"><a href="#cb51-185" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Total observations: </span><span class="sc">{</span><span class="bu">len</span>(df_fundamentals_raw)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-186"><a href="#cb51-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-187"><a href="#cb51-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-188"><a href="#cb51-188" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cleaning and Standardizing Fundamentals</span></span>
<span id="cb51-189"><a href="#cb51-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-190"><a href="#cb51-190" aria-hidden="true" tabindex="-1"></a>The raw fundamentals data requires several cleaning steps to ensure consistency and usability. We standardize variable names, handle missing values, and create derived variables commonly used in asset pricing research.</span>
<span id="cb51-191"><a href="#cb51-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-194"><a href="#cb51-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-195"><a href="#cb51-195" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> clean_fundamentals(df):</span>
<span id="cb51-196"><a href="#cb51-196" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-197"><a href="#cb51-197" aria-hidden="true" tabindex="-1"></a><span class="co">    Clean and standardize company fundamentals data.</span></span>
<span id="cb51-198"><a href="#cb51-198" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-199"><a href="#cb51-199" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-200"><a href="#cb51-200" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-201"><a href="#cb51-201" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-202"><a href="#cb51-202" aria-hidden="true" tabindex="-1"></a><span class="co">        Raw fundamentals data from Datacore</span></span>
<span id="cb51-203"><a href="#cb51-203" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-204"><a href="#cb51-204" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-205"><a href="#cb51-205" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-206"><a href="#cb51-206" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-207"><a href="#cb51-207" aria-hidden="true" tabindex="-1"></a><span class="co">        Cleaned fundamentals with standardized column names</span></span>
<span id="cb51-208"><a href="#cb51-208" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-209"><a href="#cb51-209" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-210"><a href="#cb51-210" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-211"><a href="#cb51-211" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize identifiers</span></span>
<span id="cb51-212"><a href="#cb51-212" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"symbol"</span>] <span class="op">=</span> df[<span class="st">"symbol"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.upper().<span class="bu">str</span>.strip()</span>
<span id="cb51-213"><a href="#cb51-213" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"year"</span>] <span class="op">=</span> pd.to_numeric(df[<span class="st">"year"</span>], errors<span class="op">=</span><span class="st">"coerce"</span>).astype(<span class="st">"Int64"</span>)</span>
<span id="cb51-214"><a href="#cb51-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-215"><a href="#cb51-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Drop rows with missing identifiers</span></span>
<span id="cb51-216"><a href="#cb51-216" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb51-217"><a href="#cb51-217" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-218"><a href="#cb51-218" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define columns that should be numeric</span></span>
<span id="cb51-219"><a href="#cb51-219" aria-hidden="true" tabindex="-1"></a>    numeric_columns <span class="op">=</span> [</span>
<span id="cb51-220"><a href="#cb51-220" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_asset"</span>, <span class="st">"total_equity"</span>, <span class="st">"total_liabilities"</span>,</span>
<span id="cb51-221"><a href="#cb51-221" aria-hidden="true" tabindex="-1"></a>        <span class="st">"total_current_asset"</span>, <span class="st">"total_current_liabilities"</span>,</span>
<span id="cb51-222"><a href="#cb51-222" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_net_revenue"</span>, <span class="st">"is_cogs"</span>, <span class="st">"is_manage_expense"</span>,</span>
<span id="cb51-223"><a href="#cb51-223" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_interest_expense"</span>, <span class="st">"is_eat"</span>, <span class="st">"is_net_business_profit"</span>,</span>
<span id="cb51-224"><a href="#cb51-224" aria-hidden="true" tabindex="-1"></a>        <span class="st">"na_tax_deferred"</span>, <span class="st">"nl_tax_deferred"</span>, <span class="st">"e_preferred_stock"</span>,</span>
<span id="cb51-225"><a href="#cb51-225" aria-hidden="true" tabindex="-1"></a>        <span class="st">"capex"</span>, <span class="st">"total_cfo"</span>, <span class="st">"ca_cce"</span>, <span class="st">"ca_total_inventory"</span>,</span>
<span id="cb51-226"><a href="#cb51-226" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ca_acc_receiv"</span>, <span class="st">"cfo_interest_expense"</span>, <span class="st">"basic_eps"</span>,</span>
<span id="cb51-227"><a href="#cb51-227" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_shareholders_eat"</span>, <span class="st">"cl_loan"</span>, <span class="st">"cl_finlease"</span>,</span>
<span id="cb51-228"><a href="#cb51-228" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cl_due_long_debt"</span>, <span class="st">"nl_loan"</span>, <span class="st">"nl_finlease"</span>,</span>
<span id="cb51-229"><a href="#cb51-229" aria-hidden="true" tabindex="-1"></a>        <span class="st">"is_cos_of_sales"</span>, <span class="st">"e_equity"</span></span>
<span id="cb51-230"><a href="#cb51-230" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb51-231"><a href="#cb51-231" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-232"><a href="#cb51-232" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> numeric_columns:</span>
<span id="cb51-233"><a href="#cb51-233" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> df.columns:</span>
<span id="cb51-234"><a href="#cb51-234" aria-hidden="true" tabindex="-1"></a>            df[col] <span class="op">=</span> pd.to_numeric(df[col], errors<span class="op">=</span><span class="st">"coerce"</span>)</span>
<span id="cb51-235"><a href="#cb51-235" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-236"><a href="#cb51-236" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle duplicates: keep row with most non-missing values</span></span>
<span id="cb51-237"><a href="#cb51-237" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"_completeness"</span>] <span class="op">=</span> df.notna().<span class="bu">sum</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-238"><a href="#cb51-238" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> (df</span>
<span id="cb51-239"><a href="#cb51-239" aria-hidden="true" tabindex="-1"></a>        .sort_values([<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"_completeness"</span>])</span>
<span id="cb51-240"><a href="#cb51-240" aria-hidden="true" tabindex="-1"></a>        .drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-241"><a href="#cb51-241" aria-hidden="true" tabindex="-1"></a>        .drop(columns<span class="op">=</span><span class="st">"_completeness"</span>)</span>
<span id="cb51-242"><a href="#cb51-242" aria-hidden="true" tabindex="-1"></a>        .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-243"><a href="#cb51-243" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-244"><a href="#cb51-244" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-245"><a href="#cb51-245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-246"><a href="#cb51-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-247"><a href="#cb51-247" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> clean_fundamentals(df_fundamentals_raw)</span>
<span id="cb51-248"><a href="#cb51-248" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"After cleaning: </span><span class="sc">{</span><span class="bu">len</span>(df_fundamentals)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb51-249"><a href="#cb51-249" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>df_fundamentals[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-250"><a href="#cb51-250" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-251"><a href="#cb51-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-252"><a href="#cb51-252" aria-hidden="true" tabindex="-1"></a><span class="fu">### Creating Standardized Variables</span></span>
<span id="cb51-253"><a href="#cb51-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-254"><a href="#cb51-254" aria-hidden="true" tabindex="-1"></a>To facilitate comparison with international studies and ensure compatibility with standard asset pricing methodologies, we create variables following conventions established in the academic literature. We map Vietnamese financial statement items to their Compustat equivalents where possible.</span>
<span id="cb51-255"><a href="#cb51-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-258"><a href="#cb51-258" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-259"><a href="#cb51-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_standard_variables(df):</span>
<span id="cb51-260"><a href="#cb51-260" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-261"><a href="#cb51-261" aria-hidden="true" tabindex="-1"></a><span class="co">    Create standardized financial variables for asset pricing research.</span></span>
<span id="cb51-262"><a href="#cb51-262" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-263"><a href="#cb51-263" aria-hidden="true" tabindex="-1"></a><span class="co">    This function maps Vietnamese financial statement items to standard</span></span>
<span id="cb51-264"><a href="#cb51-264" aria-hidden="true" tabindex="-1"></a><span class="co">    variable names used in the academic finance literature, following</span></span>
<span id="cb51-265"><a href="#cb51-265" aria-hidden="true" tabindex="-1"></a><span class="co">    conventions from Fama and French (1992, 1993, 2015).</span></span>
<span id="cb51-266"><a href="#cb51-266" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-267"><a href="#cb51-267" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-268"><a href="#cb51-268" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-269"><a href="#cb51-269" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-270"><a href="#cb51-270" aria-hidden="true" tabindex="-1"></a><span class="co">        Cleaned fundamentals data</span></span>
<span id="cb51-271"><a href="#cb51-271" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-272"><a href="#cb51-272" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-273"><a href="#cb51-273" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-274"><a href="#cb51-274" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-275"><a href="#cb51-275" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with standardized variables added</span></span>
<span id="cb51-276"><a href="#cb51-276" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-277"><a href="#cb51-277" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-278"><a href="#cb51-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-279"><a href="#cb51-279" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fiscal date (assume December year-end)</span></span>
<span id="cb51-280"><a href="#cb51-280" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"datadate"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"year"</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">"-12-31"</span>)</span>
<span id="cb51-281"><a href="#cb51-281" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-282"><a href="#cb51-282" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Balance Sheet Items ===</span></span>
<span id="cb51-283"><a href="#cb51-283" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"at"</span>] <span class="op">=</span> df[<span class="st">"total_asset"</span>]                    <span class="co"># Total assets</span></span>
<span id="cb51-284"><a href="#cb51-284" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"lt"</span>] <span class="op">=</span> df[<span class="st">"total_liabilities"</span>]              <span class="co"># Total liabilities</span></span>
<span id="cb51-285"><a href="#cb51-285" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"seq"</span>] <span class="op">=</span> df[<span class="st">"total_equity"</span>]                  <span class="co"># Stockholders' equity</span></span>
<span id="cb51-286"><a href="#cb51-286" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"act"</span>] <span class="op">=</span> df[<span class="st">"total_current_asset"</span>]           <span class="co"># Current assets</span></span>
<span id="cb51-287"><a href="#cb51-287" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"lct"</span>] <span class="op">=</span> df[<span class="st">"total_current_liabilities"</span>]     <span class="co"># Current liabilities</span></span>
<span id="cb51-288"><a href="#cb51-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-289"><a href="#cb51-289" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Common equity (fallback to total equity if not available)</span></span>
<span id="cb51-290"><a href="#cb51-290" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ceq"</span>] <span class="op">=</span> df.get(<span class="st">"e_equity"</span>, df[<span class="st">"seq"</span>])</span>
<span id="cb51-291"><a href="#cb51-291" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-292"><a href="#cb51-292" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Deferred Taxes ===</span></span>
<span id="cb51-293"><a href="#cb51-293" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"txditc"</span>] <span class="op">=</span> df.get(<span class="st">"na_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)  <span class="co"># Deferred tax assets</span></span>
<span id="cb51-294"><a href="#cb51-294" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"txdb"</span>] <span class="op">=</span> df.get(<span class="st">"nl_tax_deferred"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)    <span class="co"># Deferred tax liab.</span></span>
<span id="cb51-295"><a href="#cb51-295" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"itcb"</span>] <span class="op">=</span> <span class="dv">0</span>  <span class="co"># Investment tax credit (rare in Vietnam)</span></span>
<span id="cb51-296"><a href="#cb51-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-297"><a href="#cb51-297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Preferred Stock ===</span></span>
<span id="cb51-298"><a href="#cb51-298" aria-hidden="true" tabindex="-1"></a>    pref <span class="op">=</span> df.get(<span class="st">"e_preferred_stock"</span>, <span class="dv">0</span>)</span>
<span id="cb51-299"><a href="#cb51-299" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(pref, pd.Series):</span>
<span id="cb51-300"><a href="#cb51-300" aria-hidden="true" tabindex="-1"></a>        pref <span class="op">=</span> pref.fillna(<span class="dv">0</span>)</span>
<span id="cb51-301"><a href="#cb51-301" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstk"</span>] <span class="op">=</span> pref</span>
<span id="cb51-302"><a href="#cb51-302" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstkrv"</span>] <span class="op">=</span> pref  <span class="co"># Redemption value</span></span>
<span id="cb51-303"><a href="#cb51-303" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"pstkl"</span>] <span class="op">=</span> pref   <span class="co"># Liquidating value</span></span>
<span id="cb51-304"><a href="#cb51-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-305"><a href="#cb51-305" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Income Statement Items ===</span></span>
<span id="cb51-306"><a href="#cb51-306" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"sale"</span>] <span class="op">=</span> df[<span class="st">"is_net_revenue"</span>]                        <span class="co"># Net sales/revenue</span></span>
<span id="cb51-307"><a href="#cb51-307" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"cogs"</span>] <span class="op">=</span> df.get(<span class="st">"is_cogs"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)              <span class="co"># Cost of goods sold</span></span>
<span id="cb51-308"><a href="#cb51-308" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"xsga"</span>] <span class="op">=</span> df.get(<span class="st">"is_manage_expense"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)    <span class="co"># SG&amp;A expenses</span></span>
<span id="cb51-309"><a href="#cb51-309" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"xint"</span>] <span class="op">=</span> df.get(<span class="st">"is_interest_expense"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)  <span class="co"># Interest expense</span></span>
<span id="cb51-310"><a href="#cb51-310" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ni"</span>] <span class="op">=</span> df.get(<span class="st">"is_eat"</span>, np.nan)                      <span class="co"># Net income</span></span>
<span id="cb51-311"><a href="#cb51-311" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"oibdp"</span>] <span class="op">=</span> df.get(<span class="st">"is_net_business_profit"</span>, np.nan)   <span class="co"># Operating income</span></span>
<span id="cb51-312"><a href="#cb51-312" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-313"><a href="#cb51-313" aria-hidden="true" tabindex="-1"></a>    <span class="co"># === Cash Flow Items ===</span></span>
<span id="cb51-314"><a href="#cb51-314" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"oancf"</span>] <span class="op">=</span> df.get(<span class="st">"total_cfo"</span>, np.nan)  <span class="co"># Operating cash flow</span></span>
<span id="cb51-315"><a href="#cb51-315" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"capx"</span>] <span class="op">=</span> df.get(<span class="st">"capex"</span>, np.nan)       <span class="co"># Capital expenditures</span></span>
<span id="cb51-316"><a href="#cb51-316" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-317"><a href="#cb51-317" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-318"><a href="#cb51-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-319"><a href="#cb51-319" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> create_standard_variables(df_fundamentals)</span>
<span id="cb51-320"><a href="#cb51-320" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-321"><a href="#cb51-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-322"><a href="#cb51-322" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Book Equity and Profitability</span></span>
<span id="cb51-323"><a href="#cb51-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-324"><a href="#cb51-324" aria-hidden="true" tabindex="-1"></a>Book equity is a crucial variable for value investing strategies and the construction of HML (High Minus Low) factor portfolios. We follow the definition from Kenneth French's data library, which accounts for deferred taxes and preferred stock.</span>
<span id="cb51-325"><a href="#cb51-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-328"><a href="#cb51-328" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-329"><a href="#cb51-329" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_book_equity(df):</span>
<span id="cb51-330"><a href="#cb51-330" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-331"><a href="#cb51-331" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute book equity following Fama-French conventions.</span></span>
<span id="cb51-332"><a href="#cb51-332" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-333"><a href="#cb51-333" aria-hidden="true" tabindex="-1"></a><span class="co">    Book equity = Stockholders' equity </span></span>
<span id="cb51-334"><a href="#cb51-334" aria-hidden="true" tabindex="-1"></a><span class="co">                  + Deferred taxes and investment tax credit</span></span>
<span id="cb51-335"><a href="#cb51-335" aria-hidden="true" tabindex="-1"></a><span class="co">                  - Preferred stock</span></span>
<span id="cb51-336"><a href="#cb51-336" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-337"><a href="#cb51-337" aria-hidden="true" tabindex="-1"></a><span class="co">    Negative or zero book equity is set to missing, as book-to-market</span></span>
<span id="cb51-338"><a href="#cb51-338" aria-hidden="true" tabindex="-1"></a><span class="co">    ratios are undefined for such firms.</span></span>
<span id="cb51-339"><a href="#cb51-339" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-340"><a href="#cb51-340" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-341"><a href="#cb51-341" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-342"><a href="#cb51-342" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-343"><a href="#cb51-343" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with standardized variables</span></span>
<span id="cb51-344"><a href="#cb51-344" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-345"><a href="#cb51-345" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-346"><a href="#cb51-346" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-347"><a href="#cb51-347" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-348"><a href="#cb51-348" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with book equity (be) added</span></span>
<span id="cb51-349"><a href="#cb51-349" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-350"><a href="#cb51-350" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-351"><a href="#cb51-351" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-352"><a href="#cb51-352" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Primary measure: stockholders' equity</span></span>
<span id="cb51-353"><a href="#cb51-353" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 1: common equity + preferred stock</span></span>
<span id="cb51-354"><a href="#cb51-354" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fallback 2: total assets - total liabilities</span></span>
<span id="cb51-355"><a href="#cb51-355" aria-hidden="true" tabindex="-1"></a>    seq_measure <span class="op">=</span> (df[<span class="st">"seq"</span>]</span>
<span id="cb51-356"><a href="#cb51-356" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"ceq"</span>] <span class="op">+</span> df[<span class="st">"pstk"</span>])</span>
<span id="cb51-357"><a href="#cb51-357" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"at"</span>] <span class="op">-</span> df[<span class="st">"lt"</span>])</span>
<span id="cb51-358"><a href="#cb51-358" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-359"><a href="#cb51-359" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-360"><a href="#cb51-360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add deferred taxes</span></span>
<span id="cb51-361"><a href="#cb51-361" aria-hidden="true" tabindex="-1"></a>    deferred_taxes <span class="op">=</span> (df[<span class="st">"txditc"</span>]</span>
<span id="cb51-362"><a href="#cb51-362" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"txdb"</span>] <span class="op">+</span> df[<span class="st">"itcb"</span>])</span>
<span id="cb51-363"><a href="#cb51-363" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb51-364"><a href="#cb51-364" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-365"><a href="#cb51-365" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-366"><a href="#cb51-366" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subtract preferred stock (use redemption value as primary)</span></span>
<span id="cb51-367"><a href="#cb51-367" aria-hidden="true" tabindex="-1"></a>    preferred <span class="op">=</span> (df[<span class="st">"pstkrv"</span>]</span>
<span id="cb51-368"><a href="#cb51-368" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"pstkl"</span>])</span>
<span id="cb51-369"><a href="#cb51-369" aria-hidden="true" tabindex="-1"></a>        .combine_first(df[<span class="st">"pstk"</span>])</span>
<span id="cb51-370"><a href="#cb51-370" aria-hidden="true" tabindex="-1"></a>        .fillna(<span class="dv">0</span>)</span>
<span id="cb51-371"><a href="#cb51-371" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-372"><a href="#cb51-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-373"><a href="#cb51-373" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Book equity calculation</span></span>
<span id="cb51-374"><a href="#cb51-374" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> seq_measure <span class="op">+</span> deferred_taxes <span class="op">-</span> preferred</span>
<span id="cb51-375"><a href="#cb51-375" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-376"><a href="#cb51-376" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set non-positive book equity to missing</span></span>
<span id="cb51-377"><a href="#cb51-377" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"be"</span>] <span class="op">=</span> df[<span class="st">"be"</span>].where(df[<span class="st">"be"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb51-378"><a href="#cb51-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-379"><a href="#cb51-379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-380"><a href="#cb51-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-381"><a href="#cb51-381" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_book_equity(df_fundamentals)</span>
<span id="cb51-382"><a href="#cb51-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-383"><a href="#cb51-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics for book equity</span></span>
<span id="cb51-384"><a href="#cb51-384" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Book Equity Summary Statistics (in million VND):"</span>)</span>
<span id="cb51-385"><a href="#cb51-385" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_fundamentals[<span class="st">"be"</span>].describe().<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb51-386"><a href="#cb51-386" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-387"><a href="#cb51-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-388"><a href="#cb51-388" aria-hidden="true" tabindex="-1"></a>Operating profitability, introduced by @FamaFrench2015, measures a firm's profits relative to its book equity. Firms with higher operating profitability tend to have higher expected returns.</span>
<span id="cb51-389"><a href="#cb51-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-392"><a href="#cb51-392" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-393"><a href="#cb51-393" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_profitability(df):</span>
<span id="cb51-394"><a href="#cb51-394" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-395"><a href="#cb51-395" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute operating profitability following Fama-French (2015).</span></span>
<span id="cb51-396"><a href="#cb51-396" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-397"><a href="#cb51-397" aria-hidden="true" tabindex="-1"></a><span class="co">    Operating profitability = (Revenue - COGS - SG&amp;A - Interest) / Book Equity</span></span>
<span id="cb51-398"><a href="#cb51-398" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-399"><a href="#cb51-399" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-400"><a href="#cb51-400" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-401"><a href="#cb51-401" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-402"><a href="#cb51-402" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with book equity computed</span></span>
<span id="cb51-403"><a href="#cb51-403" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-404"><a href="#cb51-404" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-405"><a href="#cb51-405" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-406"><a href="#cb51-406" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-407"><a href="#cb51-407" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with operating profitability (op) added</span></span>
<span id="cb51-408"><a href="#cb51-408" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-409"><a href="#cb51-409" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-410"><a href="#cb51-410" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-411"><a href="#cb51-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Operating profit before taxes</span></span>
<span id="cb51-412"><a href="#cb51-412" aria-hidden="true" tabindex="-1"></a>    operating_profit <span class="op">=</span> (</span>
<span id="cb51-413"><a href="#cb51-413" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"sale"</span>] </span>
<span id="cb51-414"><a href="#cb51-414" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"cogs"</span>].fillna(<span class="dv">0</span>) </span>
<span id="cb51-415"><a href="#cb51-415" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"xsga"</span>].fillna(<span class="dv">0</span>) </span>
<span id="cb51-416"><a href="#cb51-416" aria-hidden="true" tabindex="-1"></a>        <span class="op">-</span> df[<span class="st">"xint"</span>].fillna(<span class="dv">0</span>)</span>
<span id="cb51-417"><a href="#cb51-417" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-418"><a href="#cb51-418" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-419"><a href="#cb51-419" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by book equity</span></span>
<span id="cb51-420"><a href="#cb51-420" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"op"</span>] <span class="op">=</span> operating_profit <span class="op">/</span> df[<span class="st">"be"</span>]</span>
<span id="cb51-421"><a href="#cb51-421" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-422"><a href="#cb51-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Winsorize extreme values (outside 1st and 99th percentiles)</span></span>
<span id="cb51-423"><a href="#cb51-423" aria-hidden="true" tabindex="-1"></a>    lower <span class="op">=</span> df[<span class="st">"op"</span>].quantile(<span class="fl">0.01</span>)</span>
<span id="cb51-424"><a href="#cb51-424" aria-hidden="true" tabindex="-1"></a>    upper <span class="op">=</span> df[<span class="st">"op"</span>].quantile(<span class="fl">0.99</span>)</span>
<span id="cb51-425"><a href="#cb51-425" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"op"</span>] <span class="op">=</span> df[<span class="st">"op"</span>].clip(lower<span class="op">=</span>lower, upper<span class="op">=</span>upper)</span>
<span id="cb51-426"><a href="#cb51-426" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-427"><a href="#cb51-427" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-428"><a href="#cb51-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-429"><a href="#cb51-429" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_profitability(df_fundamentals)</span>
<span id="cb51-430"><a href="#cb51-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-431"><a href="#cb51-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-432"><a href="#cb51-432" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Investment</span></span>
<span id="cb51-433"><a href="#cb51-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-434"><a href="#cb51-434" aria-hidden="true" tabindex="-1"></a>Investment, measured as asset growth, captures firms' investment behavior. @FamaFrench2015 document that firms with high asset growth (aggressive investment) tend to have lower future returns.</span>
<span id="cb51-435"><a href="#cb51-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-438"><a href="#cb51-438" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-439"><a href="#cb51-439" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_investment(df):</span>
<span id="cb51-440"><a href="#cb51-440" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-441"><a href="#cb51-441" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute investment (asset growth) following Fama-French (2015).</span></span>
<span id="cb51-442"><a href="#cb51-442" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-443"><a href="#cb51-443" aria-hidden="true" tabindex="-1"></a><span class="co">    Investment = (Total Assets_t / Total Assets_{t-1}) - 1</span></span>
<span id="cb51-444"><a href="#cb51-444" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-445"><a href="#cb51-445" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-446"><a href="#cb51-446" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-447"><a href="#cb51-447" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-448"><a href="#cb51-448" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals data</span></span>
<span id="cb51-449"><a href="#cb51-449" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-450"><a href="#cb51-450" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-451"><a href="#cb51-451" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-452"><a href="#cb51-452" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-453"><a href="#cb51-453" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with investment (inv) added</span></span>
<span id="cb51-454"><a href="#cb51-454" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-455"><a href="#cb51-455" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-456"><a href="#cb51-456" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-457"><a href="#cb51-457" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create lagged assets</span></span>
<span id="cb51-458"><a href="#cb51-458" aria-hidden="true" tabindex="-1"></a>    df_lag <span class="op">=</span> (df[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"at"</span>]]</span>
<span id="cb51-459"><a href="#cb51-459" aria-hidden="true" tabindex="-1"></a>        .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"year"</span>] <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb51-460"><a href="#cb51-460" aria-hidden="true" tabindex="-1"></a>        .rename(columns<span class="op">=</span>{<span class="st">"at"</span>: <span class="st">"at_lag"</span>})</span>
<span id="cb51-461"><a href="#cb51-461" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-462"><a href="#cb51-462" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-463"><a href="#cb51-463" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge lagged values</span></span>
<span id="cb51-464"><a href="#cb51-464" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(df_lag, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb51-465"><a href="#cb51-465" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-466"><a href="#cb51-466" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute investment (asset growth)</span></span>
<span id="cb51-467"><a href="#cb51-467" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"inv"</span>] <span class="op">=</span> df[<span class="st">"at"</span>] <span class="op">/</span> df[<span class="st">"at_lag"</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb51-468"><a href="#cb51-468" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-469"><a href="#cb51-469" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set to missing if lagged assets non-positive</span></span>
<span id="cb51-470"><a href="#cb51-470" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"inv"</span>] <span class="op">=</span> df[<span class="st">"inv"</span>].where(df[<span class="st">"at_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb51-471"><a href="#cb51-471" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-472"><a href="#cb51-472" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-473"><a href="#cb51-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-474"><a href="#cb51-474" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_investment(df_fundamentals)</span>
<span id="cb51-475"><a href="#cb51-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-476"><a href="#cb51-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-477"><a href="#cb51-477" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Total Debt</span></span>
<span id="cb51-478"><a href="#cb51-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-479"><a href="#cb51-479" aria-hidden="true" tabindex="-1"></a>In Vietnamese financial statements, total liabilities include non-interest-bearing items such as accounts payable and tax payables. For leverage analysis, we compute total interest-bearing debt by aggregating loan and lease obligations.</span>
<span id="cb51-480"><a href="#cb51-480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-483"><a href="#cb51-483" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-484"><a href="#cb51-484" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_total_debt(df):</span>
<span id="cb51-485"><a href="#cb51-485" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-486"><a href="#cb51-486" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute total interest-bearing debt.</span></span>
<span id="cb51-487"><a href="#cb51-487" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-488"><a href="#cb51-488" aria-hidden="true" tabindex="-1"></a><span class="co">    Total Debt = Short-term loans + Finance leases (current)</span></span>
<span id="cb51-489"><a href="#cb51-489" aria-hidden="true" tabindex="-1"></a><span class="co">                 + Current portion of long-term debt</span></span>
<span id="cb51-490"><a href="#cb51-490" aria-hidden="true" tabindex="-1"></a><span class="co">                 + Long-term loans + Finance leases (non-current)</span></span>
<span id="cb51-491"><a href="#cb51-491" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-492"><a href="#cb51-492" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb51-493"><a href="#cb51-493" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb51-494"><a href="#cb51-494" aria-hidden="true" tabindex="-1"></a><span class="co">    df : pd.DataFrame</span></span>
<span id="cb51-495"><a href="#cb51-495" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals data</span></span>
<span id="cb51-496"><a href="#cb51-496" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb51-497"><a href="#cb51-497" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb51-498"><a href="#cb51-498" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb51-499"><a href="#cb51-499" aria-hidden="true" tabindex="-1"></a><span class="co">    pd.DataFrame</span></span>
<span id="cb51-500"><a href="#cb51-500" aria-hidden="true" tabindex="-1"></a><span class="co">        Fundamentals with total_debt added</span></span>
<span id="cb51-501"><a href="#cb51-501" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-502"><a href="#cb51-502" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-503"><a href="#cb51-503" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-504"><a href="#cb51-504" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"total_debt"</span>] <span class="op">=</span> (</span>
<span id="cb51-505"><a href="#cb51-505" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_loan"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>           <span class="co"># Short-term bank loans</span></span>
<span id="cb51-506"><a href="#cb51-506" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_finlease"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>       <span class="co"># Current finance leases</span></span>
<span id="cb51-507"><a href="#cb51-507" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"cl_due_long_debt"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>  <span class="co"># Current portion LT debt</span></span>
<span id="cb51-508"><a href="#cb51-508" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"nl_loan"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>) <span class="op">+</span>           <span class="co"># Long-term bank loans</span></span>
<span id="cb51-509"><a href="#cb51-509" aria-hidden="true" tabindex="-1"></a>        df.get(<span class="st">"nl_finlease"</span>, <span class="dv">0</span>).fillna(<span class="dv">0</span>)         <span class="co"># Non-current finance leases</span></span>
<span id="cb51-510"><a href="#cb51-510" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-511"><a href="#cb51-511" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-512"><a href="#cb51-512" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-513"><a href="#cb51-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-514"><a href="#cb51-514" aria-hidden="true" tabindex="-1"></a>df_fundamentals <span class="op">=</span> compute_total_debt(df_fundamentals)</span>
<span id="cb51-515"><a href="#cb51-515" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-516"><a href="#cb51-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-517"><a href="#cb51-517" aria-hidden="true" tabindex="-1"></a><span class="fu">### Applying Filters and Final Preparation</span></span>
<span id="cb51-518"><a href="#cb51-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-519"><a href="#cb51-519" aria-hidden="true" tabindex="-1"></a>We apply standard filters to ensure data quality: requiring positive assets, non-negative sales, and presence of core variables needed for portfolio construction.</span>
<span id="cb51-520"><a href="#cb51-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-523"><a href="#cb51-523" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-524"><a href="#cb51-524" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep only observations with required variables</span></span>
<span id="cb51-525"><a href="#cb51-525" aria-hidden="true" tabindex="-1"></a>required_vars <span class="op">=</span> [<span class="st">"at"</span>, <span class="st">"lt"</span>, <span class="st">"seq"</span>, <span class="st">"sale"</span>]</span>
<span id="cb51-526"><a href="#cb51-526" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> df_fundamentals.dropna(subset<span class="op">=</span>required_vars)</span>
<span id="cb51-527"><a href="#cb51-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-528"><a href="#cb51-528" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply quality filters</span></span>
<span id="cb51-529"><a href="#cb51-529" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> comp_vn.query(<span class="st">"at &gt; 0"</span>)      <span class="co"># Positive assets</span></span>
<span id="cb51-530"><a href="#cb51-530" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> comp_vn.query(<span class="st">"sale &gt;= 0"</span>)   <span class="co"># Non-negative sales</span></span>
<span id="cb51-531"><a href="#cb51-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-532"><a href="#cb51-532" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep last observation per firm-year (in case of restatements)</span></span>
<span id="cb51-533"><a href="#cb51-533" aria-hidden="true" tabindex="-1"></a>comp_vn <span class="op">=</span> (comp_vn</span>
<span id="cb51-534"><a href="#cb51-534" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">"datadate"</span>)</span>
<span id="cb51-535"><a href="#cb51-535" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb51-536"><a href="#cb51-536" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">1</span>)</span>
<span id="cb51-537"><a href="#cb51-537" aria-hidden="true" tabindex="-1"></a>    .reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-538"><a href="#cb51-538" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-539"><a href="#cb51-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-540"><a href="#cb51-540" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostic summary</span></span>
<span id="cb51-541"><a href="#cb51-541" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Final sample: </span><span class="sc">{</span><span class="bu">len</span>(comp_vn)<span class="sc">:,}</span><span class="ss"> firm-year observations"</span>)</span>
<span id="cb51-542"><a href="#cb51-542" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique firms: </span><span class="sc">{</span>comp_vn[<span class="st">'symbol'</span>]<span class="sc">.</span>nunique()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-543"><a href="#cb51-543" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample period: </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> - </span><span class="sc">{</span>comp_vn[<span class="st">'year'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-544"><a href="#cb51-544" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-545"><a href="#cb51-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-546"><a href="#cb51-546" aria-hidden="true" tabindex="-1"></a><span class="fu">### Storing Fundamentals Data</span></span>
<span id="cb51-547"><a href="#cb51-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-548"><a href="#cb51-548" aria-hidden="true" tabindex="-1"></a>We store the prepared fundamentals data in our local SQLite database for use in subsequent chapters.</span>
<span id="cb51-549"><a href="#cb51-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-552"><a href="#cb51-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-553"><a href="#cb51-553" aria-hidden="true" tabindex="-1"></a>comp_vn.to_sql(</span>
<span id="cb51-554"><a href="#cb51-554" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"comp_vn"</span>,</span>
<span id="cb51-555"><a href="#cb51-555" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-556"><a href="#cb51-556" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-557"><a href="#cb51-557" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-558"><a href="#cb51-558" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-559"><a href="#cb51-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-560"><a href="#cb51-560" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Company fundamentals saved to database."</span>)</span>
<span id="cb51-561"><a href="#cb51-561" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-562"><a href="#cb51-562" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-563"><a href="#cb51-563" aria-hidden="true" tabindex="-1"></a><span class="fu">## Stock Price Data</span></span>
<span id="cb51-564"><a href="#cb51-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-565"><a href="#cb51-565" aria-hidden="true" tabindex="-1"></a>Stock price data forms the foundation of return-based analyses in empirical finance. Datacore provides comprehensive historical price data for all securities traded on HOSE, HNX, and UPCoM, including adjusted prices that account for corporate actions.</span>
<span id="cb51-566"><a href="#cb51-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-567"><a href="#cb51-567" aria-hidden="true" tabindex="-1"></a><span class="fu">### Downloading Price Data</span></span>
<span id="cb51-568"><a href="#cb51-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-569"><a href="#cb51-569" aria-hidden="true" tabindex="-1"></a>We download the historical price data from Datacore's storage system. The data includes daily observations with open, high, low, close prices, trading volume, and adjustment factors.</span>
<span id="cb51-570"><a href="#cb51-570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-573"><a href="#cb51-573" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-574"><a href="#cb51-574" aria-hidden="true" tabindex="-1"></a><span class="co"># Download historical price data</span></span>
<span id="cb51-575"><a href="#cb51-575" aria-hidden="true" tabindex="-1"></a>prices_raw <span class="op">=</span> conn.read_csv(</span>
<span id="cb51-576"><a href="#cb51-576" aria-hidden="true" tabindex="-1"></a>    bucket_name,</span>
<span id="cb51-577"><a href="#cb51-577" aria-hidden="true" tabindex="-1"></a>    <span class="st">"historycal_price/dataset_historical_price.csv"</span>,</span>
<span id="cb51-578"><a href="#cb51-578" aria-hidden="true" tabindex="-1"></a>    low_memory<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-579"><a href="#cb51-579" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-580"><a href="#cb51-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-581"><a href="#cb51-581" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Downloaded </span><span class="sc">{</span><span class="bu">len</span>(prices_raw)<span class="sc">:,}</span><span class="ss"> daily price observations"</span>)</span>
<span id="cb51-582"><a href="#cb51-582" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>prices_raw[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>prices_raw[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-583"><a href="#cb51-583" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-584"><a href="#cb51-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-585"><a href="#cb51-585" aria-hidden="true" tabindex="-1"></a><span class="fu">### Processing Price Data</span></span>
<span id="cb51-586"><a href="#cb51-586" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-587"><a href="#cb51-587" aria-hidden="true" tabindex="-1"></a>We clean the price data and compute adjusted prices that account for stock splits, stock dividends, and other corporate actions.</span>
<span id="cb51-588"><a href="#cb51-588" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-591"><a href="#cb51-591" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-592"><a href="#cb51-592" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_price_data(df):</span>
<span id="cb51-593"><a href="#cb51-593" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-594"><a href="#cb51-594" aria-hidden="true" tabindex="-1"></a><span class="co">    Process raw price data from Datacore.</span></span>
<span id="cb51-595"><a href="#cb51-595" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-596"><a href="#cb51-596" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-597"><a href="#cb51-597" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-598"><a href="#cb51-598" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse dates</span></span>
<span id="cb51-599"><a href="#cb51-599" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb51-600"><a href="#cb51-600" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-601"><a href="#cb51-601" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize column names</span></span>
<span id="cb51-602"><a href="#cb51-602" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.rename(columns<span class="op">=</span>{</span>
<span id="cb51-603"><a href="#cb51-603" aria-hidden="true" tabindex="-1"></a>        <span class="st">"open_price"</span>: <span class="st">"open"</span>,</span>
<span id="cb51-604"><a href="#cb51-604" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high_price"</span>: <span class="st">"high"</span>,</span>
<span id="cb51-605"><a href="#cb51-605" aria-hidden="true" tabindex="-1"></a>        <span class="st">"low_price"</span>: <span class="st">"low"</span>,</span>
<span id="cb51-606"><a href="#cb51-606" aria-hidden="true" tabindex="-1"></a>        <span class="st">"close_price"</span>: <span class="st">"close"</span>,</span>
<span id="cb51-607"><a href="#cb51-607" aria-hidden="true" tabindex="-1"></a>        <span class="st">"vol_total"</span>: <span class="st">"volume"</span></span>
<span id="cb51-608"><a href="#cb51-608" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb51-609"><a href="#cb51-609" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-610"><a href="#cb51-610" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute adjusted close price</span></span>
<span id="cb51-611"><a href="#cb51-611" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"adjusted_close"</span>] <span class="op">=</span> df[<span class="st">"close"</span>] <span class="op">*</span> df[<span class="st">"adj_ratio"</span>]</span>
<span id="cb51-612"><a href="#cb51-612" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-613"><a href="#cb51-613" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardize symbol</span></span>
<span id="cb51-614"><a href="#cb51-614" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"symbol"</span>] <span class="op">=</span> df[<span class="st">"symbol"</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.upper().<span class="bu">str</span>.strip()</span>
<span id="cb51-615"><a href="#cb51-615" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-616"><a href="#cb51-616" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort for return calculation</span></span>
<span id="cb51-617"><a href="#cb51-617" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb51-618"><a href="#cb51-618" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-619"><a href="#cb51-619" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add year and month</span></span>
<span id="cb51-620"><a href="#cb51-620" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"year"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.year</span>
<span id="cb51-621"><a href="#cb51-621" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"month"</span>] <span class="op">=</span> df[<span class="st">"date"</span>].dt.month</span>
<span id="cb51-622"><a href="#cb51-622" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-623"><a href="#cb51-623" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-624"><a href="#cb51-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-625"><a href="#cb51-625" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> process_price_data(prices_raw)</span>
<span id="cb51-626"><a href="#cb51-626" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-627"><a href="#cb51-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-628"><a href="#cb51-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-629"><a href="#cb51-629" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Shares Outstanding and Market Capitalization</span></span>
<span id="cb51-630"><a href="#cb51-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-631"><a href="#cb51-631" aria-hidden="true" tabindex="-1"></a>Market capitalization is computed as the product of price and shares outstanding. Since Datacore provides earnings per share and net income, we can infer shares outstanding from these variables.</span>
<span id="cb51-632"><a href="#cb51-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-635"><a href="#cb51-635" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-636"><a href="#cb51-636" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_shares_outstanding(fundamentals_df):</span>
<span id="cb51-637"><a href="#cb51-637" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-638"><a href="#cb51-638" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute shares outstanding from fundamentals.</span></span>
<span id="cb51-639"><a href="#cb51-639" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-640"><a href="#cb51-640" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> fundamentals_df.copy()</span>
<span id="cb51-641"><a href="#cb51-641" aria-hidden="true" tabindex="-1"></a>    shares[<span class="st">"shrout"</span>] <span class="op">=</span> shares[<span class="st">"is_shareholders_eat"</span>] <span class="op">/</span> shares[<span class="st">"basic_eps"</span>]</span>
<span id="cb51-642"><a href="#cb51-642" aria-hidden="true" tabindex="-1"></a>    shares <span class="op">=</span> shares[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"shrout"</span>]].dropna()</span>
<span id="cb51-643"><a href="#cb51-643" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-644"><a href="#cb51-644" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shares</span>
<span id="cb51-645"><a href="#cb51-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-646"><a href="#cb51-646" aria-hidden="true" tabindex="-1"></a>shares_outstanding <span class="op">=</span> compute_shares_outstanding(df_fundamentals)</span>
<span id="cb51-647"><a href="#cb51-647" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-648"><a href="#cb51-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-649"><a href="#cb51-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-652"><a href="#cb51-652" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-653"><a href="#cb51-653" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_market_cap(df, shares_df):</span>
<span id="cb51-654"><a href="#cb51-654" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-655"><a href="#cb51-655" aria-hidden="true" tabindex="-1"></a><span class="co">    Add market capitalization to price data.</span></span>
<span id="cb51-656"><a href="#cb51-656" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-657"><a href="#cb51-657" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.merge(shares_df, on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb51-658"><a href="#cb51-658" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-659"><a href="#cb51-659" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute market cap (in million VND)</span></span>
<span id="cb51-660"><a href="#cb51-660" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap"</span>] <span class="op">=</span> (df[<span class="st">"close"</span>] <span class="op">*</span> df[<span class="st">"shrout"</span>]) <span class="op">/</span> <span class="dv">1_000_000</span></span>
<span id="cb51-661"><a href="#cb51-661" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-662"><a href="#cb51-662" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set zero or negative market cap to missing</span></span>
<span id="cb51-663"><a href="#cb51-663" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap"</span>] <span class="op">=</span> df[<span class="st">"mktcap"</span>].where(df[<span class="st">"mktcap"</span>] <span class="op">&gt;</span> <span class="dv">0</span>, np.nan)</span>
<span id="cb51-664"><a href="#cb51-664" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-665"><a href="#cb51-665" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-666"><a href="#cb51-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-667"><a href="#cb51-667" aria-hidden="true" tabindex="-1"></a>prices <span class="op">=</span> add_market_cap(prices, shares_outstanding)</span>
<span id="cb51-668"><a href="#cb51-668" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-669"><a href="#cb51-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-670"><a href="#cb51-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-671"><a href="#cb51-671" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computing Returns and Excess Returns</span></span>
<span id="cb51-672"><a href="#cb51-672" aria-hidden="true" tabindex="-1"></a>We compute returns using adjusted closing prices to ensure returns correctly reflect total shareholder returns including dividends and corporate actions.</span>
<span id="cb51-673"><a href="#cb51-673" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-674"><a href="#cb51-674" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Creating Daily Dataset</span></span>
<span id="cb51-675"><a href="#cb51-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-676"><a href="#cb51-676" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Sequential version</span>
<span id="cb51-679"><a href="#cb51-679" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-680"><a href="#cb51-680" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-681"><a href="#cb51-681" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_daily_dataset(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-682"><a href="#cb51-682" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-683"><a href="#cb51-683" aria-hidden="true" tabindex="-1"></a><span class="co">    Create daily price dataset with returns and excess returns.</span></span>
<span id="cb51-684"><a href="#cb51-684" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-685"><a href="#cb51-685" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-686"><a href="#cb51-686" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-687"><a href="#cb51-687" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by symbol and date (critical for correct return calculation)</span></span>
<span id="cb51-688"><a href="#cb51-688" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-689"><a href="#cb51-689" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-690"><a href="#cb51-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates within each symbol (keep last observation)</span></span>
<span id="cb51-691"><a href="#cb51-691" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-692"><a href="#cb51-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-693"><a href="#cb51-693" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns</span></span>
<span id="cb51-694"><a href="#cb51-694" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb51-695"><a href="#cb51-695" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-696"><a href="#cb51-696" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme negative returns</span></span>
<span id="cb51-697"><a href="#cb51-697" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb51-698"><a href="#cb51-698" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-699"><a href="#cb51-699" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Daily risk-free rate (assuming 252 trading days)</span></span>
<span id="cb51-700"><a href="#cb51-700" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb51-701"><a href="#cb51-701" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-702"><a href="#cb51-702" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb51-703"><a href="#cb51-703" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>] <span class="op">-</span> df[<span class="st">"risk_free"</span>]</span>
<span id="cb51-704"><a href="#cb51-704" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb51-705"><a href="#cb51-705" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-706"><a href="#cb51-706" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb51-707"><a href="#cb51-707" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"symbol"</span>)[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb51-708"><a href="#cb51-708" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-709"><a href="#cb51-709" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-710"><a href="#cb51-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-711"><a href="#cb51-711" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> create_daily_dataset(prices)</span>
<span id="cb51-712"><a href="#cb51-712" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-713"><a href="#cb51-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-714"><a href="#cb51-714" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Parallel version</span>
<span id="cb51-715"><a href="#cb51-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-718"><a href="#cb51-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-719"><a href="#cb51-719" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb51-720"><a href="#cb51-720" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb51-721"><a href="#cb51-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-722"><a href="#cb51-722" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_daily_symbol(symbol_df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-723"><a href="#cb51-723" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-724"><a href="#cb51-724" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single symbol's daily data.</span></span>
<span id="cb51-725"><a href="#cb51-725" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-726"><a href="#cb51-726" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> symbol_df.copy()</span>
<span id="cb51-727"><a href="#cb51-727" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-728"><a href="#cb51-728" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date (critical for correct return calculation)</span></span>
<span id="cb51-729"><a href="#cb51-729" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-730"><a href="#cb51-730" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-731"><a href="#cb51-731" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates (keep last observation if duplicates exist)</span></span>
<span id="cb51-732"><a href="#cb51-732" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-733"><a href="#cb51-733" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-734"><a href="#cb51-734" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute daily returns</span></span>
<span id="cb51-735"><a href="#cb51-735" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb51-736"><a href="#cb51-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-737"><a href="#cb51-737" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace infinite values with NaN</span></span>
<span id="cb51-738"><a href="#cb51-738" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb51-739"><a href="#cb51-739" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-740"><a href="#cb51-740" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme negative returns</span></span>
<span id="cb51-741"><a href="#cb51-741" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb51-742"><a href="#cb51-742" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-743"><a href="#cb51-743" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Daily risk-free rate</span></span>
<span id="cb51-744"><a href="#cb51-744" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb51-745"><a href="#cb51-745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-746"><a href="#cb51-746" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb51-747"><a href="#cb51-747" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret"</span>] <span class="op">-</span> df[<span class="st">"risk_free"</span>]</span>
<span id="cb51-748"><a href="#cb51-748" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"ret_excess"</span>] <span class="op">=</span> df[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb51-749"><a href="#cb51-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-750"><a href="#cb51-750" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb51-751"><a href="#cb51-751" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> df[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb51-752"><a href="#cb51-752" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-753"><a href="#cb51-753" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb51-754"><a href="#cb51-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-755"><a href="#cb51-755" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_daily_dataset_parallel(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-756"><a href="#cb51-756" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-757"><a href="#cb51-757" aria-hidden="true" tabindex="-1"></a><span class="co">    Create daily price dataset using parallel processing.</span></span>
<span id="cb51-758"><a href="#cb51-758" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-759"><a href="#cb51-759" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted before splitting</span></span>
<span id="cb51-760"><a href="#cb51-760" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb51-761"><a href="#cb51-761" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-762"><a href="#cb51-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by symbol</span></span>
<span id="cb51-763"><a href="#cb51-763" aria-hidden="true" tabindex="-1"></a>    symbol_groups <span class="op">=</span> [group <span class="cf">for</span> _, group <span class="kw">in</span> df.groupby(<span class="st">"symbol"</span>)]</span>
<span id="cb51-764"><a href="#cb51-764" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-765"><a href="#cb51-765" aria-hidden="true" tabindex="-1"></a>    n_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, os.cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb51-766"><a href="#cb51-766" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(symbol_groups)<span class="sc">:,}</span><span class="ss"> symbols using </span><span class="sc">{</span>n_jobs<span class="sc">}</span><span class="ss"> cores..."</span>)</span>
<span id="cb51-767"><a href="#cb51-767" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-768"><a href="#cb51-768" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_jobs, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb51-769"><a href="#cb51-769" aria-hidden="true" tabindex="-1"></a>        delayed(process_daily_symbol)(group, annual_rf) </span>
<span id="cb51-770"><a href="#cb51-770" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> group <span class="kw">in</span> symbol_groups</span>
<span id="cb51-771"><a href="#cb51-771" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-772"><a href="#cb51-772" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-773"><a href="#cb51-773" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-774"><a href="#cb51-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-775"><a href="#cb51-775" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> create_daily_dataset_parallel(prices)</span>
<span id="cb51-776"><a href="#cb51-776" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-777"><a href="#cb51-777" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick validation</span></span>
<span id="cb51-778"><a href="#cb51-778" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Validation checks:"</span>)</span>
<span id="cb51-779"><a href="#cb51-779" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Any duplicate (symbol, date): </span><span class="sc">{</span>prices_daily<span class="sc">.</span>duplicated(subset<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'date'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-780"><a href="#cb51-780" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Sample of non-zero returns:"</span>)</span>
<span id="cb51-781"><a href="#cb51-781" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily[prices_daily[<span class="st">"ret"</span>] <span class="op">!=</span> <span class="dv">0</span>][[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb51-782"><a href="#cb51-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-783"><a href="#cb51-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-784"><a href="#cb51-784" aria-hidden="true" tabindex="-1"></a>prices_daily.query(<span class="st">"symbol == 'FPT'"</span>)[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">3</span>)</span>
<span id="cb51-785"><a href="#cb51-785" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-786"><a href="#cb51-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-789"><a href="#cb51-789" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-790"><a href="#cb51-790" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns</span></span>
<span id="cb51-791"><a href="#cb51-791" aria-hidden="true" tabindex="-1"></a>daily_columns <span class="op">=</span> [</span>
<span id="cb51-792"><a href="#cb51-792" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>,</span>
<span id="cb51-793"><a href="#cb51-793" aria-hidden="true" tabindex="-1"></a>    <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>,</span>
<span id="cb51-794"><a href="#cb51-794" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adjusted_close"</span>, <span class="st">"shrout"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>,</span>
<span id="cb51-795"><a href="#cb51-795" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret"</span>, <span class="st">"risk_free"</span>, <span class="st">"ret_excess"</span></span>
<span id="cb51-796"><a href="#cb51-796" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb51-797"><a href="#cb51-797" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> prices_daily[daily_columns]</span>
<span id="cb51-798"><a href="#cb51-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-799"><a href="#cb51-799" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing essential variables</span></span>
<span id="cb51-800"><a href="#cb51-800" aria-hidden="true" tabindex="-1"></a>prices_daily <span class="op">=</span> prices_daily.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb51-801"><a href="#cb51-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-802"><a href="#cb51-802" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily Return Summary Statistics:"</span>)</span>
<span id="cb51-803"><a href="#cb51-803" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_daily[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb51-804"><a href="#cb51-804" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final daily sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_daily)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb51-805"><a href="#cb51-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-806"><a href="#cb51-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-807"><a href="#cb51-807" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Creating Monthly Dataset</span></span>
<span id="cb51-808"><a href="#cb51-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-809"><a href="#cb51-809" aria-hidden="true" tabindex="-1"></a>For monthly returns, we compute returns directly from month-end adjusted prices rather than compounding daily returns. This avoids compounding errors from missing days and is the standard approach in empirical finance.</span>
<span id="cb51-810"><a href="#cb51-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-811"><a href="#cb51-811" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Sequential version</span>
<span id="cb51-812"><a href="#cb51-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-815"><a href="#cb51-815" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-816"><a href="#cb51-816" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-817"><a href="#cb51-817" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_monthly_dataset(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-818"><a href="#cb51-818" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-819"><a href="#cb51-819" aria-hidden="true" tabindex="-1"></a><span class="co">    Create monthly price dataset with returns computed from </span></span>
<span id="cb51-820"><a href="#cb51-820" aria-hidden="true" tabindex="-1"></a><span class="co">    month-end to month-end adjusted prices.</span></span>
<span id="cb51-821"><a href="#cb51-821" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-822"><a href="#cb51-822" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb51-823"><a href="#cb51-823" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-824"><a href="#cb51-824" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by symbol and date (critical for correct return calculation)</span></span>
<span id="cb51-825"><a href="#cb51-825" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-826"><a href="#cb51-826" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-827"><a href="#cb51-827" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates within each symbol (keep last observation)</span></span>
<span id="cb51-828"><a href="#cb51-828" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-829"><a href="#cb51-829" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-830"><a href="#cb51-830" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get month-end observations</span></span>
<span id="cb51-831"><a href="#cb51-831" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> (df</span>
<span id="cb51-832"><a href="#cb51-832" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">"symbol"</span>)</span>
<span id="cb51-833"><a href="#cb51-833" aria-hidden="true" tabindex="-1"></a>        .resample(<span class="st">"ME"</span>, on<span class="op">=</span><span class="st">"date"</span>)</span>
<span id="cb51-834"><a href="#cb51-834" aria-hidden="true" tabindex="-1"></a>        .agg({</span>
<span id="cb51-835"><a href="#cb51-835" aria-hidden="true" tabindex="-1"></a>            <span class="st">"open"</span>: <span class="st">"first"</span>,           <span class="co"># First day open</span></span>
<span id="cb51-836"><a href="#cb51-836" aria-hidden="true" tabindex="-1"></a>            <span class="st">"high"</span>: <span class="st">"max"</span>,             <span class="co"># Monthly high</span></span>
<span id="cb51-837"><a href="#cb51-837" aria-hidden="true" tabindex="-1"></a>            <span class="st">"low"</span>: <span class="st">"min"</span>,              <span class="co"># Monthly low</span></span>
<span id="cb51-838"><a href="#cb51-838" aria-hidden="true" tabindex="-1"></a>            <span class="st">"close"</span>: <span class="st">"last"</span>,           <span class="co"># Last day close</span></span>
<span id="cb51-839"><a href="#cb51-839" aria-hidden="true" tabindex="-1"></a>            <span class="st">"volume"</span>: <span class="st">"sum"</span>,           <span class="co"># Total monthly volume</span></span>
<span id="cb51-840"><a href="#cb51-840" aria-hidden="true" tabindex="-1"></a>            <span class="st">"adjusted_close"</span>: <span class="st">"last"</span>,  <span class="co"># Month-end adjusted price</span></span>
<span id="cb51-841"><a href="#cb51-841" aria-hidden="true" tabindex="-1"></a>            <span class="st">"shrout"</span>: <span class="st">"last"</span>,          <span class="co"># Month-end shares outstanding</span></span>
<span id="cb51-842"><a href="#cb51-842" aria-hidden="true" tabindex="-1"></a>            <span class="st">"mktcap"</span>: <span class="st">"last"</span>,          <span class="co"># Month-end market cap</span></span>
<span id="cb51-843"><a href="#cb51-843" aria-hidden="true" tabindex="-1"></a>            <span class="st">"year"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-844"><a href="#cb51-844" aria-hidden="true" tabindex="-1"></a>            <span class="st">"month"</span>: <span class="st">"last"</span></span>
<span id="cb51-845"><a href="#cb51-845" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb51-846"><a href="#cb51-846" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb51-847"><a href="#cb51-847" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-848"><a href="#cb51-848" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-849"><a href="#cb51-849" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate (symbol, date) after resampling (safety check)</span></span>
<span id="cb51-850"><a href="#cb51-850" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.drop_duplicates(subset<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-851"><a href="#cb51-851" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-852"><a href="#cb51-852" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort again after resampling</span></span>
<span id="cb51-853"><a href="#cb51-853" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-854"><a href="#cb51-854" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-855"><a href="#cb51-855" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute monthly returns from month-end to month-end adjusted prices</span></span>
<span id="cb51-856"><a href="#cb51-856" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly.groupby(<span class="st">"symbol"</span>)[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb51-857"><a href="#cb51-857" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-858"><a href="#cb51-858" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme returns</span></span>
<span id="cb51-859"><a href="#cb51-859" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb51-860"><a href="#cb51-860" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-861"><a href="#cb51-861" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly risk-free rate</span></span>
<span id="cb51-862"><a href="#cb51-862" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb51-863"><a href="#cb51-863" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-864"><a href="#cb51-864" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb51-865"><a href="#cb51-865" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>] <span class="op">-</span> monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb51-866"><a href="#cb51-866" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb51-867"><a href="#cb51-867" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-868"><a href="#cb51-868" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap for portfolio weighting</span></span>
<span id="cb51-869"><a href="#cb51-869" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> monthly.groupby(<span class="st">"symbol"</span>)[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb51-870"><a href="#cb51-870" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-871"><a href="#cb51-871" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly</span>
<span id="cb51-872"><a href="#cb51-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-873"><a href="#cb51-873" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> create_monthly_dataset(prices)</span>
<span id="cb51-874"><a href="#cb51-874" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-875"><a href="#cb51-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-876"><a href="#cb51-876" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Parallel version</span>
<span id="cb51-877"><a href="#cb51-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-880"><a href="#cb51-880" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-881"><a href="#cb51-881" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> joblib <span class="im">import</span> Parallel, delayed</span>
<span id="cb51-882"><a href="#cb51-882" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb51-883"><a href="#cb51-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-884"><a href="#cb51-884" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_monthly_symbol(symbol_df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-885"><a href="#cb51-885" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-886"><a href="#cb51-886" aria-hidden="true" tabindex="-1"></a><span class="co">    Process a single symbol's data to monthly frequency.</span></span>
<span id="cb51-887"><a href="#cb51-887" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-888"><a href="#cb51-888" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> symbol_df.copy()</span>
<span id="cb51-889"><a href="#cb51-889" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-890"><a href="#cb51-890" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date (critical for correct return calculation)</span></span>
<span id="cb51-891"><a href="#cb51-891" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-892"><a href="#cb51-892" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-893"><a href="#cb51-893" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove duplicate dates (keep last observation if duplicates exist)</span></span>
<span id="cb51-894"><a href="#cb51-894" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.drop_duplicates(subset<span class="op">=</span>[<span class="st">"date"</span>], keep<span class="op">=</span><span class="st">"last"</span>)</span>
<span id="cb51-895"><a href="#cb51-895" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-896"><a href="#cb51-896" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set date as index for resampling</span></span>
<span id="cb51-897"><a href="#cb51-897" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.set_index(<span class="st">"date"</span>)</span>
<span id="cb51-898"><a href="#cb51-898" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-899"><a href="#cb51-899" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Resample to monthly</span></span>
<span id="cb51-900"><a href="#cb51-900" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> df.resample(<span class="st">"ME"</span>).agg({</span>
<span id="cb51-901"><a href="#cb51-901" aria-hidden="true" tabindex="-1"></a>        <span class="st">"symbol"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-902"><a href="#cb51-902" aria-hidden="true" tabindex="-1"></a>        <span class="st">"open"</span>: <span class="st">"first"</span>,</span>
<span id="cb51-903"><a href="#cb51-903" aria-hidden="true" tabindex="-1"></a>        <span class="st">"high"</span>: <span class="st">"max"</span>,</span>
<span id="cb51-904"><a href="#cb51-904" aria-hidden="true" tabindex="-1"></a>        <span class="st">"low"</span>: <span class="st">"min"</span>,</span>
<span id="cb51-905"><a href="#cb51-905" aria-hidden="true" tabindex="-1"></a>        <span class="st">"close"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-906"><a href="#cb51-906" aria-hidden="true" tabindex="-1"></a>        <span class="st">"volume"</span>: <span class="st">"sum"</span>,</span>
<span id="cb51-907"><a href="#cb51-907" aria-hidden="true" tabindex="-1"></a>        <span class="st">"adjusted_close"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-908"><a href="#cb51-908" aria-hidden="true" tabindex="-1"></a>        <span class="st">"shrout"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-909"><a href="#cb51-909" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mktcap"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-910"><a href="#cb51-910" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>: <span class="st">"last"</span>,</span>
<span id="cb51-911"><a href="#cb51-911" aria-hidden="true" tabindex="-1"></a>        <span class="st">"month"</span>: <span class="st">"last"</span></span>
<span id="cb51-912"><a href="#cb51-912" aria-hidden="true" tabindex="-1"></a>    }).reset_index()</span>
<span id="cb51-913"><a href="#cb51-913" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-914"><a href="#cb51-914" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove rows where symbol is NaN (months with no trading)</span></span>
<span id="cb51-915"><a href="#cb51-915" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.dropna(subset<span class="op">=</span>[<span class="st">"symbol"</span>])</span>
<span id="cb51-916"><a href="#cb51-916" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-917"><a href="#cb51-917" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort by date</span></span>
<span id="cb51-918"><a href="#cb51-918" aria-hidden="true" tabindex="-1"></a>    monthly <span class="op">=</span> monthly.sort_values(<span class="st">"date"</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-919"><a href="#cb51-919" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-920"><a href="#cb51-920" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute monthly returns</span></span>
<span id="cb51-921"><a href="#cb51-921" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"adjusted_close"</span>].pct_change()</span>
<span id="cb51-922"><a href="#cb51-922" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-923"><a href="#cb51-923" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace infinite values with NaN</span></span>
<span id="cb51-924"><a href="#cb51-924" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].replace([np.inf, <span class="op">-</span>np.inf], np.nan)</span>
<span id="cb51-925"><a href="#cb51-925" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-926"><a href="#cb51-926" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cap extreme returns</span></span>
<span id="cb51-927"><a href="#cb51-927" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>].clip(lower<span class="op">=-</span><span class="fl">0.99</span>)</span>
<span id="cb51-928"><a href="#cb51-928" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-929"><a href="#cb51-929" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Monthly risk-free rate</span></span>
<span id="cb51-930"><a href="#cb51-930" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"risk_free"</span>] <span class="op">=</span> annual_rf <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb51-931"><a href="#cb51-931" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-932"><a href="#cb51-932" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Excess returns</span></span>
<span id="cb51-933"><a href="#cb51-933" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret"</span>] <span class="op">-</span> monthly[<span class="st">"risk_free"</span>]</span>
<span id="cb51-934"><a href="#cb51-934" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"ret_excess"</span>] <span class="op">=</span> monthly[<span class="st">"ret_excess"</span>].clip(lower<span class="op">=-</span><span class="fl">1.0</span>)</span>
<span id="cb51-935"><a href="#cb51-935" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-936"><a href="#cb51-936" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lagged market cap</span></span>
<span id="cb51-937"><a href="#cb51-937" aria-hidden="true" tabindex="-1"></a>    monthly[<span class="st">"mktcap_lag"</span>] <span class="op">=</span> monthly[<span class="st">"mktcap"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb51-938"><a href="#cb51-938" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-939"><a href="#cb51-939" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly</span>
<span id="cb51-940"><a href="#cb51-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-941"><a href="#cb51-941" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_monthly_dataset_parallel(df, annual_rf<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb51-942"><a href="#cb51-942" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb51-943"><a href="#cb51-943" aria-hidden="true" tabindex="-1"></a><span class="co">    Create monthly price dataset using parallel processing.</span></span>
<span id="cb51-944"><a href="#cb51-944" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb51-945"><a href="#cb51-945" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure data is sorted before splitting</span></span>
<span id="cb51-946"><a href="#cb51-946" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"symbol"</span>, <span class="st">"date"</span>])</span>
<span id="cb51-947"><a href="#cb51-947" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-948"><a href="#cb51-948" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split by symbol</span></span>
<span id="cb51-949"><a href="#cb51-949" aria-hidden="true" tabindex="-1"></a>    symbol_groups <span class="op">=</span> [group <span class="cf">for</span> _, group <span class="kw">in</span> df.groupby(<span class="st">"symbol"</span>)]</span>
<span id="cb51-950"><a href="#cb51-950" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-951"><a href="#cb51-951" aria-hidden="true" tabindex="-1"></a>    n_jobs <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, os.cpu_count() <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb51-952"><a href="#cb51-952" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Processing </span><span class="sc">{</span><span class="bu">len</span>(symbol_groups)<span class="sc">:,}</span><span class="ss"> symbols using </span><span class="sc">{</span>n_jobs<span class="sc">}</span><span class="ss"> cores..."</span>)</span>
<span id="cb51-953"><a href="#cb51-953" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-954"><a href="#cb51-954" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> Parallel(n_jobs<span class="op">=</span>n_jobs, verbose<span class="op">=</span><span class="dv">1</span>)(</span>
<span id="cb51-955"><a href="#cb51-955" aria-hidden="true" tabindex="-1"></a>        delayed(process_monthly_symbol)(group, annual_rf) </span>
<span id="cb51-956"><a href="#cb51-956" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> group <span class="kw">in</span> symbol_groups</span>
<span id="cb51-957"><a href="#cb51-957" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-958"><a href="#cb51-958" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-959"><a href="#cb51-959" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-960"><a href="#cb51-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-961"><a href="#cb51-961" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> create_monthly_dataset_parallel(prices)</span>
<span id="cb51-962"><a href="#cb51-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-963"><a href="#cb51-963" aria-hidden="true" tabindex="-1"></a><span class="co"># Validation checks</span></span>
<span id="cb51-964"><a href="#cb51-964" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Validation checks:"</span>)</span>
<span id="cb51-965"><a href="#cb51-965" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Any duplicate (symbol, date): </span><span class="sc">{</span>prices_monthly<span class="sc">.</span>duplicated(subset<span class="op">=</span>[<span class="st">'symbol'</span>, <span class="st">'date'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb51-966"><a href="#cb51-966" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Sample of non-zero returns:"</span>)</span>
<span id="cb51-967"><a href="#cb51-967" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[prices_monthly[<span class="st">"ret"</span>] <span class="op">!=</span> <span class="dv">0</span>][[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">10</span>))</span>
<span id="cb51-968"><a href="#cb51-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-969"><a href="#cb51-969" aria-hidden="true" tabindex="-1"></a>prices_monthly.query(<span class="st">"symbol == 'FPT'"</span>)[[<span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"adjusted_close"</span>, <span class="st">"ret"</span>]].head(<span class="dv">3</span>)</span>
<span id="cb51-970"><a href="#cb51-970" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-971"><a href="#cb51-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-972"><a href="#cb51-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-975"><a href="#cb51-975" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-976"><a href="#cb51-976" aria-hidden="true" tabindex="-1"></a><span class="co"># Select columns (same structure as daily)</span></span>
<span id="cb51-977"><a href="#cb51-977" aria-hidden="true" tabindex="-1"></a>monthly_columns <span class="op">=</span> [</span>
<span id="cb51-978"><a href="#cb51-978" aria-hidden="true" tabindex="-1"></a>    <span class="st">"symbol"</span>, <span class="st">"date"</span>, <span class="st">"year"</span>, <span class="st">"month"</span>,</span>
<span id="cb51-979"><a href="#cb51-979" aria-hidden="true" tabindex="-1"></a>    <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>, <span class="st">"volume"</span>,</span>
<span id="cb51-980"><a href="#cb51-980" aria-hidden="true" tabindex="-1"></a>    <span class="st">"adjusted_close"</span>, <span class="st">"shrout"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>,</span>
<span id="cb51-981"><a href="#cb51-981" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ret"</span>, <span class="st">"risk_free"</span>, <span class="st">"ret_excess"</span></span>
<span id="cb51-982"><a href="#cb51-982" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb51-983"><a href="#cb51-983" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly[monthly_columns]</span>
<span id="cb51-984"><a href="#cb51-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-985"><a href="#cb51-985" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove observations with missing essential variables</span></span>
<span id="cb51-986"><a href="#cb51-986" aria-hidden="true" tabindex="-1"></a>prices_monthly <span class="op">=</span> prices_monthly.dropna(subset<span class="op">=</span>[<span class="st">"ret_excess"</span>, <span class="st">"mktcap"</span>, <span class="st">"mktcap_lag"</span>])</span>
<span id="cb51-987"><a href="#cb51-987" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-988"><a href="#cb51-988" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Monthly Return Summary Statistics:"</span>)</span>
<span id="cb51-989"><a href="#cb51-989" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(prices_monthly[<span class="st">"ret"</span>].describe().<span class="bu">round</span>(<span class="dv">4</span>))</span>
<span id="cb51-990"><a href="#cb51-990" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Final monthly sample: </span><span class="sc">{</span><span class="bu">len</span>(prices_monthly)<span class="sc">:,}</span><span class="ss"> observations"</span>)</span>
<span id="cb51-991"><a href="#cb51-991" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-992"><a href="#cb51-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-993"><a href="#cb51-993" aria-hidden="true" tabindex="-1"></a><span class="fu">### Storing Price Data</span></span>
<span id="cb51-994"><a href="#cb51-994" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-997"><a href="#cb51-997" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-998"><a href="#cb51-998" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb51-999"><a href="#cb51-999" aria-hidden="true" tabindex="-1"></a>prices_daily.to_sql(</span>
<span id="cb51-1000"><a href="#cb51-1000" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"prices_daily"</span>,</span>
<span id="cb51-1001"><a href="#cb51-1001" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-1002"><a href="#cb51-1002" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-1003"><a href="#cb51-1003" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-1004"><a href="#cb51-1004" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1005"><a href="#cb51-1005" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Daily price data saved to database."</span>)</span>
<span id="cb51-1006"><a href="#cb51-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1007"><a href="#cb51-1007" aria-hidden="true" tabindex="-1"></a>prices_monthly.to_sql(</span>
<span id="cb51-1008"><a href="#cb51-1008" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"prices_monthly"</span>,</span>
<span id="cb51-1009"><a href="#cb51-1009" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>tidy_finance,</span>
<span id="cb51-1010"><a href="#cb51-1010" aria-hidden="true" tabindex="-1"></a>    if_exists<span class="op">=</span><span class="st">"replace"</span>,</span>
<span id="cb51-1011"><a href="#cb51-1011" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="va">False</span></span>
<span id="cb51-1012"><a href="#cb51-1012" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1013"><a href="#cb51-1013" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Monthly price data saved to database."</span>)</span>
<span id="cb51-1014"><a href="#cb51-1014" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1015"><a href="#cb51-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1016"><a href="#cb51-1016" aria-hidden="true" tabindex="-1"></a><span class="fu">## Descriptive Statistics</span></span>
<span id="cb51-1017"><a href="#cb51-1017" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1018"><a href="#cb51-1018" aria-hidden="true" tabindex="-1"></a>Before proceeding to asset pricing analyses, we examine the characteristics of our sample to understand the Vietnamese equity market's evolution and composition.</span>
<span id="cb51-1019"><a href="#cb51-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1020"><a href="#cb51-1020" aria-hidden="true" tabindex="-1"></a><span class="fu">### Market Evolution Over Time</span></span>
<span id="cb51-1021"><a href="#cb51-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1022"><a href="#cb51-1022" aria-hidden="true" tabindex="-1"></a>We first examine how the number of listed securities has grown over time.</span>
<span id="cb51-1023"><a href="#cb51-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1026"><a href="#cb51-1026" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1027"><a href="#cb51-1027" aria-hidden="true" tabindex="-1"></a>securities_over_time <span class="op">=</span> (prices_monthly</span>
<span id="cb51-1028"><a href="#cb51-1028" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"date"</span>)</span>
<span id="cb51-1029"><a href="#cb51-1029" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb51-1030"><a href="#cb51-1030" aria-hidden="true" tabindex="-1"></a>        n_securities<span class="op">=</span>(<span class="st">"symbol"</span>, <span class="st">"nunique"</span>),</span>
<span id="cb51-1031"><a href="#cb51-1031" aria-hidden="true" tabindex="-1"></a>        total_mktcap<span class="op">=</span>(<span class="st">"mktcap"</span>, <span class="st">"sum"</span>)</span>
<span id="cb51-1032"><a href="#cb51-1032" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1033"><a href="#cb51-1033" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-1034"><a href="#cb51-1034" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1035"><a href="#cb51-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1036"><a href="#cb51-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1039"><a href="#cb51-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1040"><a href="#cb51-1040" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-securities-over-time</span></span>
<span id="cb51-1041"><a href="#cb51-1041" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The figure shows the monthly number of securities in the Vietnamese stock market sample."</span></span>
<span id="cb51-1042"><a href="#cb51-1042" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing the growth in number of listed securities over time."</span></span>
<span id="cb51-1043"><a href="#cb51-1043" aria-hidden="true" tabindex="-1"></a>securities_figure <span class="op">=</span> (</span>
<span id="cb51-1044"><a href="#cb51-1044" aria-hidden="true" tabindex="-1"></a>    ggplot(securities_over_time, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"n_securities"</span>))</span>
<span id="cb51-1045"><a href="#cb51-1045" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"steelblue"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-1046"><a href="#cb51-1046" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1047"><a href="#cb51-1047" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-1048"><a href="#cb51-1048" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of Securities"</span>,</span>
<span id="cb51-1049"><a href="#cb51-1049" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Growth of Vietnamese Stock Market"</span></span>
<span id="cb51-1050"><a href="#cb51-1050" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1051"><a href="#cb51-1051" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-1052"><a href="#cb51-1052" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb51-1053"><a href="#cb51-1053" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1054"><a href="#cb51-1054" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1055"><a href="#cb51-1055" aria-hidden="true" tabindex="-1"></a>securities_figure.show()</span>
<span id="cb51-1056"><a href="#cb51-1056" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1057"><a href="#cb51-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1058"><a href="#cb51-1058" aria-hidden="true" tabindex="-1"></a><span class="fu">### Market Capitalization Evolution</span></span>
<span id="cb51-1059"><a href="#cb51-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1060"><a href="#cb51-1060" aria-hidden="true" tabindex="-1"></a>The aggregate market capitalization reflects the overall size and development of the Vietnamese equity market.</span>
<span id="cb51-1061"><a href="#cb51-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1064"><a href="#cb51-1064" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1065"><a href="#cb51-1065" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-market-cap-over-time</span></span>
<span id="cb51-1066"><a href="#cb51-1066" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The figure shows the total market capitalization of Vietnamese listed companies over time."</span></span>
<span id="cb51-1067"><a href="#cb51-1067" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing total market capitalization growth."</span></span>
<span id="cb51-1068"><a href="#cb51-1068" aria-hidden="true" tabindex="-1"></a>mktcap_figure <span class="op">=</span> (</span>
<span id="cb51-1069"><a href="#cb51-1069" aria-hidden="true" tabindex="-1"></a>    ggplot(securities_over_time, aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"total_mktcap / 1000"</span>))</span>
<span id="cb51-1070"><a href="#cb51-1070" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-1071"><a href="#cb51-1071" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1072"><a href="#cb51-1072" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb51-1073"><a href="#cb51-1073" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Market Cap (Trillion VND)"</span>,</span>
<span id="cb51-1074"><a href="#cb51-1074" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Total Market Capitalization of Vietnamese Equities"</span></span>
<span id="cb51-1075"><a href="#cb51-1075" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1076"><a href="#cb51-1076" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_datetime(date_breaks<span class="op">=</span><span class="st">"2 years"</span>, date_labels<span class="op">=</span><span class="st">"%Y"</span>)</span>
<span id="cb51-1077"><a href="#cb51-1077" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>comma_format())</span>
<span id="cb51-1078"><a href="#cb51-1078" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1079"><a href="#cb51-1079" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1080"><a href="#cb51-1080" aria-hidden="true" tabindex="-1"></a>mktcap_figure.show()</span>
<span id="cb51-1081"><a href="#cb51-1081" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1082"><a href="#cb51-1082" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1083"><a href="#cb51-1083" aria-hidden="true" tabindex="-1"></a><span class="fu">### Return Distribution</span></span>
<span id="cb51-1084"><a href="#cb51-1084" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1085"><a href="#cb51-1085" aria-hidden="true" tabindex="-1"></a>Understanding the distribution of monthly returns helps identify potential data quality issues and characterize market risk.</span>
<span id="cb51-1086"><a href="#cb51-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1089"><a href="#cb51-1089" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1090"><a href="#cb51-1090" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-return-distribution</span></span>
<span id="cb51-1091"><a href="#cb51-1091" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of monthly excess returns for Vietnamese stocks."</span></span>
<span id="cb51-1092"><a href="#cb51-1092" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Histogram showing the distribution of monthly excess returns."</span></span>
<span id="cb51-1093"><a href="#cb51-1093" aria-hidden="true" tabindex="-1"></a>return_distribution <span class="op">=</span> (</span>
<span id="cb51-1094"><a href="#cb51-1094" aria-hidden="true" tabindex="-1"></a>    ggplot(prices_monthly, aes(x<span class="op">=</span><span class="st">"ret_excess"</span>))</span>
<span id="cb51-1095"><a href="#cb51-1095" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_histogram(</span>
<span id="cb51-1096"><a href="#cb51-1096" aria-hidden="true" tabindex="-1"></a>        binwidth<span class="op">=</span><span class="fl">0.02</span>, </span>
<span id="cb51-1097"><a href="#cb51-1097" aria-hidden="true" tabindex="-1"></a>        fill<span class="op">=</span><span class="st">"steelblue"</span>, </span>
<span id="cb51-1098"><a href="#cb51-1098" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb51-1099"><a href="#cb51-1099" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.7</span></span>
<span id="cb51-1100"><a href="#cb51-1100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1101"><a href="#cb51-1101" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1102"><a href="#cb51-1102" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Monthly Excess Return"</span>,</span>
<span id="cb51-1103"><a href="#cb51-1103" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Frequency"</span>,</span>
<span id="cb51-1104"><a href="#cb51-1104" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Monthly Excess Returns"</span></span>
<span id="cb51-1105"><a href="#cb51-1105" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1106"><a href="#cb51-1106" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_x_continuous(limits<span class="op">=</span>(<span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span>))</span>
<span id="cb51-1107"><a href="#cb51-1107" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1108"><a href="#cb51-1108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1109"><a href="#cb51-1109" aria-hidden="true" tabindex="-1"></a>return_distribution.show()</span>
<span id="cb51-1110"><a href="#cb51-1110" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1111"><a href="#cb51-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1112"><a href="#cb51-1112" aria-hidden="true" tabindex="-1"></a><span class="fu">### Coverage of Book Equity</span></span>
<span id="cb51-1113"><a href="#cb51-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1114"><a href="#cb51-1114" aria-hidden="true" tabindex="-1"></a>Book equity is essential for constructing value portfolios. We examine what fraction of our sample has book equity data available over time.</span>
<span id="cb51-1115"><a href="#cb51-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1118"><a href="#cb51-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1119"><a href="#cb51-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-book-equity-coverage</span></span>
<span id="cb51-1120"><a href="#cb51-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Share of securities with available book equity data by year."</span></span>
<span id="cb51-1121"><a href="#cb51-1121" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "Line chart showing the coverage of book equity data over time."</span></span>
<span id="cb51-1122"><a href="#cb51-1122" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge prices with fundamentals</span></span>
<span id="cb51-1123"><a href="#cb51-1123" aria-hidden="true" tabindex="-1"></a>coverage_data <span class="op">=</span> (prices_monthly</span>
<span id="cb51-1124"><a href="#cb51-1124" aria-hidden="true" tabindex="-1"></a>    .assign(year<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"date"</span>].dt.year)</span>
<span id="cb51-1125"><a href="#cb51-1125" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">"symbol"</span>, <span class="st">"year"</span>])</span>
<span id="cb51-1126"><a href="#cb51-1126" aria-hidden="true" tabindex="-1"></a>    .tail(<span class="dv">1</span>)</span>
<span id="cb51-1127"><a href="#cb51-1127" aria-hidden="true" tabindex="-1"></a>    .merge(comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"be"</span>]], </span>
<span id="cb51-1128"><a href="#cb51-1128" aria-hidden="true" tabindex="-1"></a>           on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>], </span>
<span id="cb51-1129"><a href="#cb51-1129" aria-hidden="true" tabindex="-1"></a>           how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb51-1130"><a href="#cb51-1130" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1131"><a href="#cb51-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1132"><a href="#cb51-1132" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute coverage by year</span></span>
<span id="cb51-1133"><a href="#cb51-1133" aria-hidden="true" tabindex="-1"></a>be_coverage <span class="op">=</span> (coverage_data</span>
<span id="cb51-1134"><a href="#cb51-1134" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">"year"</span>)</span>
<span id="cb51-1135"><a href="#cb51-1135" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> x: pd.Series({</span>
<span id="cb51-1136"><a href="#cb51-1136" aria-hidden="true" tabindex="-1"></a>        <span class="st">"share_with_be"</span>: x[<span class="st">"be"</span>].notna().mean()</span>
<span id="cb51-1137"><a href="#cb51-1137" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb51-1138"><a href="#cb51-1138" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb51-1139"><a href="#cb51-1139" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1140"><a href="#cb51-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1141"><a href="#cb51-1141" aria-hidden="true" tabindex="-1"></a>coverage_figure <span class="op">=</span> (</span>
<span id="cb51-1142"><a href="#cb51-1142" aria-hidden="true" tabindex="-1"></a>    ggplot(be_coverage, aes(x<span class="op">=</span><span class="st">"year"</span>, y<span class="op">=</span><span class="st">"share_with_be"</span>))</span>
<span id="cb51-1143"><a href="#cb51-1143" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_line(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb51-1144"><a href="#cb51-1144" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> geom_point(color<span class="op">=</span><span class="st">"darkorange"</span>, size<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb51-1145"><a href="#cb51-1145" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> labs(</span>
<span id="cb51-1146"><a href="#cb51-1146" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb51-1147"><a href="#cb51-1147" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Share with Book Equity"</span>,</span>
<span id="cb51-1148"><a href="#cb51-1148" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Coverage of Book Equity Data"</span></span>
<span id="cb51-1149"><a href="#cb51-1149" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1150"><a href="#cb51-1150" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> scale_y_continuous(labels<span class="op">=</span>percent_format(), limits<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb51-1151"><a href="#cb51-1151" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> theme_minimal()</span>
<span id="cb51-1152"><a href="#cb51-1152" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1153"><a href="#cb51-1153" aria-hidden="true" tabindex="-1"></a>coverage_figure.show()</span>
<span id="cb51-1154"><a href="#cb51-1154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1155"><a href="#cb51-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1156"><a href="#cb51-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1157"><a href="#cb51-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Merging Stock and Fundamental Data</span></span>
<span id="cb51-1158"><a href="#cb51-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1159"><a href="#cb51-1159" aria-hidden="true" tabindex="-1"></a>The final step links price data with fundamental data using the stock symbol as the common identifier. This merged dataset forms the basis for constructing portfolios sorted on firm characteristics.</span>
<span id="cb51-1160"><a href="#cb51-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1163"><a href="#cb51-1163" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1164"><a href="#cb51-1164" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Create merged dataset for end-of-June each year</span></span>
<span id="cb51-1165"><a href="#cb51-1165" aria-hidden="true" tabindex="-1"></a>merged_data <span class="op">=</span> (prices_monthly</span>
<span id="cb51-1166"><a href="#cb51-1166" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"month == 6"</span>)</span>
<span id="cb51-1167"><a href="#cb51-1167" aria-hidden="true" tabindex="-1"></a>    .merge(</span>
<span id="cb51-1168"><a href="#cb51-1168" aria-hidden="true" tabindex="-1"></a>        comp_vn[[<span class="st">"symbol"</span>, <span class="st">"year"</span>, <span class="st">"be"</span>, <span class="st">"op"</span>, <span class="st">"inv"</span>, <span class="st">"at"</span>]],</span>
<span id="cb51-1169"><a href="#cb51-1169" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"symbol"</span>, <span class="st">"year"</span>],</span>
<span id="cb51-1170"><a href="#cb51-1170" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb51-1171"><a href="#cb51-1171" aria-hidden="true" tabindex="-1"></a>        suffixes<span class="op">=</span>(<span class="st">""</span>, <span class="st">"_fundamental"</span>)</span>
<span id="cb51-1172"><a href="#cb51-1172" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-1173"><a href="#cb51-1173" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1174"><a href="#cb51-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1175"><a href="#cb51-1175" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert BE from VND to BILLION VND</span></span>
<span id="cb51-1176"><a href="#cb51-1176" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"be"</span>] <span class="op">=</span> merged_data[<span class="st">"be"</span>] <span class="op">/</span> <span class="fl">1e9</span></span>
<span id="cb51-1177"><a href="#cb51-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1178"><a href="#cb51-1178" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute book-to-market ratio</span></span>
<span id="cb51-1179"><a href="#cb51-1179" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"bm"</span>] <span class="op">=</span> merged_data[<span class="st">"be"</span>] <span class="op">/</span> merged_data[<span class="st">"mktcap"</span>]</span>
<span id="cb51-1180"><a href="#cb51-1180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1181"><a href="#cb51-1181" aria-hidden="true" tabindex="-1"></a>merged_data.loc[</span>
<span id="cb51-1182"><a href="#cb51-1182" aria-hidden="true" tabindex="-1"></a>    (merged_data[<span class="st">"bm"</span>] <span class="op">&lt;=</span> <span class="dv">0</span>) <span class="op">|</span></span>
<span id="cb51-1183"><a href="#cb51-1183" aria-hidden="true" tabindex="-1"></a>    (merged_data[<span class="st">"bm"</span>] <span class="op">&gt;</span> <span class="dv">20</span>),</span>
<span id="cb51-1184"><a href="#cb51-1184" aria-hidden="true" tabindex="-1"></a>    <span class="st">"bm"</span></span>
<span id="cb51-1185"><a href="#cb51-1185" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> pd.NA</span>
<span id="cb51-1186"><a href="#cb51-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1187"><a href="#cb51-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1188"><a href="#cb51-1188" aria-hidden="true" tabindex="-1"></a>merged_data[<span class="st">"bm"</span>].describe(percentiles<span class="op">=</span>[<span class="fl">.01</span>, <span class="fl">.1</span>, <span class="fl">.5</span>, <span class="fl">.9</span>, <span class="fl">.99</span>])</span>
<span id="cb51-1189"><a href="#cb51-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1190"><a href="#cb51-1190" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged observations: </span><span class="sc">{</span><span class="bu">len</span>(merged_data)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-1191"><a href="#cb51-1191" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"With book-to-market: </span><span class="sc">{</span>merged_data[<span class="st">'bm'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb51-1192"><a href="#cb51-1192" aria-hidden="true" tabindex="-1"></a>merged_data.head(<span class="dv">3</span>)</span>
<span id="cb51-1193"><a href="#cb51-1193" aria-hidden="true" tabindex="-1"></a>merged_data.describe()</span>
<span id="cb51-1194"><a href="#cb51-1194" aria-hidden="true" tabindex="-1"></a>merged_data</span>
<span id="cb51-1195"><a href="#cb51-1195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1196"><a href="#cb51-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1199"><a href="#cb51-1199" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1200"><a href="#cb51-1200" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotnine <span class="im">import</span> <span class="op">*</span></span>
<span id="cb51-1201"><a href="#cb51-1201" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-1202"><a href="#cb51-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1203"><a href="#cb51-1203" aria-hidden="true" tabindex="-1"></a>bm_plot_data <span class="op">=</span> (</span>
<span id="cb51-1204"><a href="#cb51-1204" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"bm"</span>]]</span>
<span id="cb51-1205"><a href="#cb51-1205" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb51-1206"><a href="#cb51-1206" aria-hidden="true" tabindex="-1"></a>      .assign(bm_plot<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">"bm"</span>].clip(upper<span class="op">=</span><span class="dv">10</span>))</span>
<span id="cb51-1207"><a href="#cb51-1207" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1208"><a href="#cb51-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1209"><a href="#cb51-1209" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb51-1210"><a href="#cb51-1210" aria-hidden="true" tabindex="-1"></a>    ggplot(bm_plot_data, aes(x<span class="op">=</span><span class="st">"bm_plot"</span>)) <span class="op">+</span></span>
<span id="cb51-1211"><a href="#cb51-1211" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">80</span>) <span class="op">+</span></span>
<span id="cb51-1212"><a href="#cb51-1212" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb51-1213"><a href="#cb51-1213" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Book to Market Ratios"</span>,</span>
<span id="cb51-1214"><a href="#cb51-1214" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Book to Market (capped at 10 for plotting)"</span>,</span>
<span id="cb51-1215"><a href="#cb51-1215" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of firms"</span></span>
<span id="cb51-1216"><a href="#cb51-1216" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb51-1217"><a href="#cb51-1217" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb51-1218"><a href="#cb51-1218" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1219"><a href="#cb51-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1220"><a href="#cb51-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1223"><a href="#cb51-1223" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1224"><a href="#cb51-1224" aria-hidden="true" tabindex="-1"></a>size_plot_data <span class="op">=</span> (</span>
<span id="cb51-1225"><a href="#cb51-1225" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"mktcap_lag"</span>]]</span>
<span id="cb51-1226"><a href="#cb51-1226" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb51-1227"><a href="#cb51-1227" aria-hidden="true" tabindex="-1"></a>      .assign(log_size<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"mktcap_lag"</span>]))</span>
<span id="cb51-1228"><a href="#cb51-1228" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1229"><a href="#cb51-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1230"><a href="#cb51-1230" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb51-1231"><a href="#cb51-1231" aria-hidden="true" tabindex="-1"></a>    ggplot(size_plot_data, aes(x<span class="op">=</span><span class="st">"log_size"</span>)) <span class="op">+</span></span>
<span id="cb51-1232"><a href="#cb51-1232" aria-hidden="true" tabindex="-1"></a>    geom_histogram(bins<span class="op">=</span><span class="dv">80</span>) <span class="op">+</span></span>
<span id="cb51-1233"><a href="#cb51-1233" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb51-1234"><a href="#cb51-1234" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Log Market Capitalization"</span>,</span>
<span id="cb51-1235"><a href="#cb51-1235" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Log Market Cap"</span>,</span>
<span id="cb51-1236"><a href="#cb51-1236" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Number of firms"</span></span>
<span id="cb51-1237"><a href="#cb51-1237" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb51-1238"><a href="#cb51-1238" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb51-1239"><a href="#cb51-1239" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1240"><a href="#cb51-1240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1241"><a href="#cb51-1241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1244"><a href="#cb51-1244" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb51-1245"><a href="#cb51-1245" aria-hidden="true" tabindex="-1"></a>scatter_data <span class="op">=</span> (</span>
<span id="cb51-1246"><a href="#cb51-1246" aria-hidden="true" tabindex="-1"></a>    merged_data[[<span class="st">"be"</span>, <span class="st">"mktcap_lag"</span>]]</span>
<span id="cb51-1247"><a href="#cb51-1247" aria-hidden="true" tabindex="-1"></a>      .dropna()</span>
<span id="cb51-1248"><a href="#cb51-1248" aria-hidden="true" tabindex="-1"></a>      .assign(</span>
<span id="cb51-1249"><a href="#cb51-1249" aria-hidden="true" tabindex="-1"></a>          log_be<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"be"</span>]),</span>
<span id="cb51-1250"><a href="#cb51-1250" aria-hidden="true" tabindex="-1"></a>          log_me<span class="op">=</span><span class="kw">lambda</span> x: np.log(x[<span class="st">"mktcap_lag"</span>])</span>
<span id="cb51-1251"><a href="#cb51-1251" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb51-1252"><a href="#cb51-1252" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1253"><a href="#cb51-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1254"><a href="#cb51-1254" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb51-1255"><a href="#cb51-1255" aria-hidden="true" tabindex="-1"></a>    ggplot(scatter_data, aes(x<span class="op">=</span><span class="st">"log_me"</span>, y<span class="op">=</span><span class="st">"log_be"</span>)) <span class="op">+</span></span>
<span id="cb51-1256"><a href="#cb51-1256" aria-hidden="true" tabindex="-1"></a>    geom_point(alpha<span class="op">=</span><span class="fl">0.2</span>) <span class="op">+</span></span>
<span id="cb51-1257"><a href="#cb51-1257" aria-hidden="true" tabindex="-1"></a>    labs(</span>
<span id="cb51-1258"><a href="#cb51-1258" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Log Book Equity vs Log Market Equity"</span>,</span>
<span id="cb51-1259"><a href="#cb51-1259" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Log Market Cap"</span>,</span>
<span id="cb51-1260"><a href="#cb51-1260" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Log Book Equity"</span></span>
<span id="cb51-1261"><a href="#cb51-1261" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span></span>
<span id="cb51-1262"><a href="#cb51-1262" aria-hidden="true" tabindex="-1"></a>    theme_minimal()</span>
<span id="cb51-1263"><a href="#cb51-1263" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb51-1264"><a href="#cb51-1264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb51-1265"><a href="#cb51-1265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1266"><a href="#cb51-1266" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Takeaways</span></span>
<span id="cb51-1267"><a href="#cb51-1267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1268"><a href="#cb51-1268" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Datacore provides unified access** to Vietnamese financial data through a modern cloud-based infrastructure, eliminating the need to aggregate data from multiple fragmented sources.</span>
<span id="cb51-1269"><a href="#cb51-1269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1270"><a href="#cb51-1270" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Company fundamentals** from Datacore include comprehensive balance sheet, income statement, and cash flow data prepared according to Vietnamese Accounting Standards, which we map to standard variables used in international research.</span>
<span id="cb51-1271"><a href="#cb51-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1272"><a href="#cb51-1272" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Book equity computation** follows the Fama-French methodology, accounting for deferred taxes and preferred stock to ensure comparability with US-based studies.</span>
<span id="cb51-1273"><a href="#cb51-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1274"><a href="#cb51-1274" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Stock price data** includes adjustment factors for corporate actions, enabling accurate return calculations over long horizons.</span>
<span id="cb51-1275"><a href="#cb51-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1276"><a href="#cb51-1276" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Monthly frequency** is standard for asset pricing research, reducing noise while maintaining sufficient observations for statistical inference.</span>
<span id="cb51-1277"><a href="#cb51-1277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1278"><a href="#cb51-1278" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Risk-free rate approximation** uses Vietnamese government bond yields as a proxy, given the absence of a standardized short-term rate series comparable to US Treasury bills.</span>
<span id="cb51-1279"><a href="#cb51-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1280"><a href="#cb51-1280" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Data quality validation** through descriptive statistics and visualization helps identify potential issues before conducting formal analyses.</span>
<span id="cb51-1281"><a href="#cb51-1281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-1282"><a href="#cb51-1282" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Batch processing** enables efficient handling of large daily datasets that would otherwise exceed memory constraints.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/02_datacore_data.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>