<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>12&nbsp; Portfolio Weighting and Rebalancing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./15_missing_data_and_survivorship.html" rel="next">
<link href="./13_value_bivariate.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="12&nbsp; Portfolio Weighting and Rebalancing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta property="og:description" content="">
<meta property="og:site_name" content="T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:title" content="12&nbsp; Portfolio Weighting and Rebalancing ‚Äì T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">T√†i Ch√≠nh ·ª®ng D·ª•ng v·ªõi Python</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">üìò English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn_vi/"> 
<span class="menu-text">üìó S√°ch Ti·∫øng Vi·ªát</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn_vi" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10_modern_portfolio_theory.html">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</a></li><li class="breadcrumb-item"><a href="./14_portfolio_weighting_and_rebalancing.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">L·ªùi n√≥i ƒë·∫ßu</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Th·ªã tr∆∞·ªùng t√†i ch√≠nh, th·ªÉ ch·∫ø v√† d·ªØ li·ªáu Vi·ªát Nam</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">N·ªÅn t·∫£ng th·ªÉ ch·∫ø v√† c·∫•u tr√∫c th·ªã tr∆∞·ªùng c·ªßa th·ªã tr∆∞·ªùng ch·ª©ng kho√°n Vi·ªát Nam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Truy c·∫≠p v√† qu·∫£n l√Ω d·ªØ li·ªáu t√†i ch√≠nh VN</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh ƒë·ªãnh gi√° t√†i s·∫£n</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">C√°c y·∫øu t·ªë c∆° b·∫£n c·ªßa c√¥ng ty, ƒë·ªãnh gi√° v√† t√≠n hi·ªáu doanh nghi·ªáp</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Quy·ªÅn s·ªü h·ªØu, ma s√°t th·ªã tr∆∞·ªùng v√† r·ªßi ro qu·ªëc t·∫ø</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">M√¥ h√¨nh t√†i ch√≠nh n√¢ng cao</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">D·ªØ li·ªáu thay th·∫ø v√† Tr√≠ tu·ªá nh√¢n t·∫°o trong t√†i ch√≠nh</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-weight-theory" id="toc-sec-weight-theory" class="nav-link active" data-scroll-target="#sec-weight-theory"><span class="header-section-number">12.1</span> Theoretical Framework</a>
  <ul class="collapse">
  <li><a href="#value-weighted-portfolios" id="toc-value-weighted-portfolios" class="nav-link" data-scroll-target="#value-weighted-portfolios"><span class="header-section-number">12.1.1</span> Value-Weighted Portfolios</a></li>
  <li><a href="#equal-weighted-portfolios" id="toc-equal-weighted-portfolios" class="nav-link" data-scroll-target="#equal-weighted-portfolios"><span class="header-section-number">12.1.2</span> Equal-Weighted Portfolios</a></li>
  <li><a href="#the-weighting-spectrum" id="toc-the-weighting-spectrum" class="nav-link" data-scroll-target="#the-weighting-spectrum"><span class="header-section-number">12.1.3</span> The Weighting Spectrum</a></li>
  </ul></li>
  <li><a href="#sec-weight-data" id="toc-sec-weight-data" class="nav-link" data-scroll-target="#sec-weight-data"><span class="header-section-number">12.2</span> Data Construction</a>
  <ul class="collapse">
  <li><a href="#universe-construction-and-liquidity-filters" id="toc-universe-construction-and-liquidity-filters" class="nav-link" data-scroll-target="#universe-construction-and-liquidity-filters"><span class="header-section-number">12.2.1</span> Universe Construction and Liquidity Filters</a></li>
  <li><a href="#market-capitalization-concentration" id="toc-market-capitalization-concentration" class="nav-link" data-scroll-target="#market-capitalization-concentration"><span class="header-section-number">12.2.2</span> Market Capitalization Concentration</a></li>
  </ul></li>
  <li><a href="#sec-weight-implementation" id="toc-sec-weight-implementation" class="nav-link" data-scroll-target="#sec-weight-implementation"><span class="header-section-number">12.3</span> Implementing Weighting Schemes</a>
  <ul class="collapse">
  <li><a href="#core-portfolio-engine" id="toc-core-portfolio-engine" class="nav-link" data-scroll-target="#core-portfolio-engine"><span class="header-section-number">12.3.1</span> Core Portfolio Engine</a></li>
  <li><a href="#value-weighted-portfolio" id="toc-value-weighted-portfolio" class="nav-link" data-scroll-target="#value-weighted-portfolio"><span class="header-section-number">12.3.2</span> Value-Weighted Portfolio</a></li>
  <li><a href="#equal-weighted-portfolio" id="toc-equal-weighted-portfolio" class="nav-link" data-scroll-target="#equal-weighted-portfolio"><span class="header-section-number">12.3.3</span> Equal-Weighted Portfolio</a></li>
  <li><a href="#capped-value-weighted-portfolio" id="toc-capped-value-weighted-portfolio" class="nav-link" data-scroll-target="#capped-value-weighted-portfolio"><span class="header-section-number">12.3.4</span> Capped Value-Weighted Portfolio</a></li>
  <li><a href="#fundamental-weighted-portfolio" id="toc-fundamental-weighted-portfolio" class="nav-link" data-scroll-target="#fundamental-weighted-portfolio"><span class="header-section-number">12.3.5</span> Fundamental-Weighted Portfolio</a></li>
  </ul></li>
  <li><a href="#sec-weight-risk-based" id="toc-sec-weight-risk-based" class="nav-link" data-scroll-target="#sec-weight-risk-based"><span class="header-section-number">12.4</span> Risk-Based Weighting Schemes</a>
  <ul class="collapse">
  <li><a href="#covariance-estimation" id="toc-covariance-estimation" class="nav-link" data-scroll-target="#covariance-estimation"><span class="header-section-number">12.4.1</span> Covariance Estimation</a></li>
  <li><a href="#minimum-variance-portfolio" id="toc-minimum-variance-portfolio" class="nav-link" data-scroll-target="#minimum-variance-portfolio"><span class="header-section-number">12.4.2</span> Minimum Variance Portfolio</a></li>
  <li><a href="#risk-parity-equal-risk-contribution" id="toc-risk-parity-equal-risk-contribution" class="nav-link" data-scroll-target="#risk-parity-equal-risk-contribution"><span class="header-section-number">12.4.3</span> Risk Parity (Equal Risk Contribution)</a></li>
  <li><a href="#maximum-diversification-portfolio" id="toc-maximum-diversification-portfolio" class="nav-link" data-scroll-target="#maximum-diversification-portfolio"><span class="header-section-number">12.4.4</span> Maximum Diversification Portfolio</a></li>
  </ul></li>
  <li><a href="#sec-weight-comparison" id="toc-sec-weight-comparison" class="nav-link" data-scroll-target="#sec-weight-comparison"><span class="header-section-number">12.5</span> Comprehensive Performance Comparison</a>
  <ul class="collapse">
  <li><a href="#performance-metrics" id="toc-performance-metrics" class="nav-link" data-scroll-target="#performance-metrics"><span class="header-section-number">12.5.1</span> Performance Metrics</a></li>
  <li><a href="#risk-return-trade-off" id="toc-risk-return-trade-off" class="nav-link" data-scroll-target="#risk-return-trade-off"><span class="header-section-number">12.5.2</span> Risk-Return Trade-Off</a></li>
  </ul></li>
  <li><a href="#sec-weight-transaction-costs" id="toc-sec-weight-transaction-costs" class="nav-link" data-scroll-target="#sec-weight-transaction-costs"><span class="header-section-number">12.6</span> Transaction Costs and Net-of-Cost Performance</a>
  <ul class="collapse">
  <li><a href="#estimating-trading-costs-in-vietnam" id="toc-estimating-trading-costs-in-vietnam" class="nav-link" data-scroll-target="#estimating-trading-costs-in-vietnam"><span class="header-section-number">12.6.1</span> Estimating Trading Costs in Vietnam</a></li>
  <li><a href="#net-of-cost-performance" id="toc-net-of-cost-performance" class="nav-link" data-scroll-target="#net-of-cost-performance"><span class="header-section-number">12.6.2</span> Net-of-Cost Performance</a></li>
  <li><a href="#cost-erosion-at-scale" id="toc-cost-erosion-at-scale" class="nav-link" data-scroll-target="#cost-erosion-at-scale"><span class="header-section-number">12.6.3</span> Cost Erosion at Scale</a></li>
  </ul></li>
  <li><a href="#sec-weight-rebalancing" id="toc-sec-weight-rebalancing" class="nav-link" data-scroll-target="#sec-weight-rebalancing"><span class="header-section-number">12.7</span> Rebalancing Frequency Analysis</a>
  <ul class="collapse">
  <li><a href="#the-rebalancing-trade-off" id="toc-the-rebalancing-trade-off" class="nav-link" data-scroll-target="#the-rebalancing-trade-off"><span class="header-section-number">12.7.1</span> The Rebalancing Trade-Off</a></li>
  <li><a href="#threshold-based-rebalancing" id="toc-threshold-based-rebalancing" class="nav-link" data-scroll-target="#threshold-based-rebalancing"><span class="header-section-number">12.7.2</span> Threshold-Based Rebalancing</a></li>
  </ul></li>
  <li><a href="#sec-weight-rebalancing-bonus" id="toc-sec-weight-rebalancing-bonus" class="nav-link" data-scroll-target="#sec-weight-rebalancing-bonus"><span class="header-section-number">12.8</span> The Rebalancing Bonus: Decomposition</a></li>
  <li><a href="#sec-weight-factor-exposure" id="toc-sec-weight-factor-exposure" class="nav-link" data-scroll-target="#sec-weight-factor-exposure"><span class="header-section-number">12.9</span> Factor Exposure Analysis</a></li>
  <li><a href="#sec-weight-practical" id="toc-sec-weight-practical" class="nav-link" data-scroll-target="#sec-weight-practical"><span class="header-section-number">12.10</span> Practical Guidance for Vietnam</a></li>
  <li><a href="#sec-weight-summary" id="toc-sec-weight-summary" class="nav-link" data-scroll-target="#sec-weight-summary"><span class="header-section-number">12.11</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/14_portfolio_weighting_and_rebalancing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10_modern_portfolio_theory.html">X√¢y d·ª±ng danh m·ª•c ƒë·∫ßu t∆∞, r·ªßi ro v√† c∆° h·ªçc th·ª±c nghi·ªám</a></li><li class="breadcrumb-item"><a href="./14_portfolio_weighting_and_rebalancing.html"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we systematically compare portfolio weighting schemes (e.g., value-weighted, equal-weighted, and several risk-based alternativesin the Vietnamese equity market. We quantify the impact of rebalancing frequency and transaction costs on realized performance, and develop practical tools for constructing implementable portfolios under the frictions characteristic of an emerging market.</p>
</div>
</div>
<p>Every portfolio construction decision ultimately reduces to two choices: which assets to hold, and how much to allocate to each. While earlier chapters have focused on the first question, using factor models, anomalies, and fundamental analysis to select stocks, this chapter addresses the second. The weighting scheme a researcher or investor applies can fundamentally alter the conclusions drawn from portfolio-level tests and the returns earned from an investment strategy.</p>
<p>The distinction matters more in Vietnam than in large, liquid markets. The Vietnamese equity market features extreme skewness in the market capitalization distribution: the top 10 firms on HOSE account for roughly 50% of total market capitalization, while hundreds of small firms contribute negligible weight. Under value-weighting, a portfolio‚Äôs performance is dominated by a handful of large-cap names (Vinhomes, Vingroup, Vietcombank, FPT). Under equal-weighting, every firm contributes equally, tilting the portfolio toward small, illiquid stocks that may be expensive or impossible to trade at scale. Neither scheme is inherently correct; the choice depends on the question being asked.</p>
<p>This chapter develops the analytical framework for making that choice. We begin with the theoretical properties of weighting schemes, implement each scheme in practice with Vietnamese data, quantify the transaction costs of rebalancing, and extend the analysis to risk-based alternatives that explicitly incorporate the covariance structure of returns.</p>
<section id="sec-weight-theory" class="level2" data-number="12.1">
<h2 data-number="12.1" class="anchored" data-anchor-id="sec-weight-theory"><span class="header-section-number">12.1</span> Theoretical Framework</h2>
<section id="value-weighted-portfolios" class="level3" data-number="12.1.1">
<h3 data-number="12.1.1" class="anchored" data-anchor-id="value-weighted-portfolios"><span class="header-section-number">12.1.1</span> Value-Weighted Portfolios</h3>
<p>A value-weighted (VW) portfolio allocates to each stock in proportion to its market capitalization:</p>
<p><span id="eq-vw"><span class="math display">\[
w_{i,t}^{VW} = \frac{\text{MCap}_{i,t}}{\sum_{j=1}^{N_t} \text{MCap}_{j,t}}
\tag{12.1}\]</span></span></p>
<p>where <span class="math inline">\(\text{MCap}_{i,t} = P_{i,t} \times \text{Shares}_{i,t}\)</span> is the market capitalization of stock <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span>.</p>
<p>The VW portfolio has a unique theoretical status: it is the portfolio that all investors collectively hold (the ‚Äúmarket portfolio‚Äù in CAPM). Its key properties are:</p>
<ol type="1">
<li><strong>Self-rebalancing.</strong> As prices move, weights adjust automatically. A VW portfolio requires trading only when constituents enter or leave the index, or when corporate actions (splits, issuances) change shares outstanding.</li>
<li><strong>Low turnover.</strong> Because weights drift with prices rather than being reset to targets, VW portfolios have minimal rebalancing costs.</li>
<li><strong>Large-cap bias.</strong> Returns are dominated by the largest firms. In Vietnam, this means the portfolio‚Äôs risk-return profile is heavily influenced by banking, real estate, and technology conglomerates.</li>
</ol>
<p><span class="citation" data-cites="hsu2004cap">Hsu (<a href="references.html#ref-hsu2004cap" role="doc-biblioref">2004</a>)</span> argues that VW portfolios are sub-optimal because they mechanically overweight overpriced stocks and underweight underpriced stocks (i.e., any deviation of price from fundamental value creates a systematic drag on VW performance relative to a fundamentally weighted alternative).</p>
</section>
<section id="equal-weighted-portfolios" class="level3" data-number="12.1.2">
<h3 data-number="12.1.2" class="anchored" data-anchor-id="equal-weighted-portfolios"><span class="header-section-number">12.1.2</span> Equal-Weighted Portfolios</h3>
<p>An equal-weighted (EW) portfolio assigns the same weight to each constituent:</p>
<p><span id="eq-ew"><span class="math display">\[
w_{i,t}^{EW} = \frac{1}{N_t}
\tag{12.2}\]</span></span></p>
<p><span class="citation" data-cites="demiguel2009optimal">DeMiguel, Garlappi, and Uppal (<a href="references.html#ref-demiguel2009optimal" role="doc-biblioref">2009</a>)</span> show that the 1/N portfolio is surprisingly competitive with mean-variance optimized portfolios, particularly when estimation windows are short and the number of assets is large (conditions that closely describe the Vietnamese market). The intuition is that estimation error in expected returns and covariances can overwhelm the gains from optimization, making the ‚Äúnaive‚Äù equal-weight scheme a robust default.</p>
<p><span class="citation" data-cites="plyakha2021equal">Plyakha, Uppal, and Vilkov (<a href="references.html#ref-plyakha2021equal" role="doc-biblioref">2021</a>)</span> decompose the EW outperformance over VW into two components:</p>
<ol type="1">
<li><strong>Size tilt.</strong> EW allocates more to small firms, which historically earn a size premium.</li>
<li><strong>Rebalancing bonus.</strong> Monthly rebalancing back to equal weights is a contrarian strategy: it sells recent winners and buys recent losers, profiting from mean reversion in individual stock returns. <!-- 3.  **Diversification.** EW provides lower concentration and higher effective diversification. --></li>
</ol>
<p>However, the EW portfolio has practical disadvantages that are particularly severe in Vietnam:</p>
<ul>
<li><strong>High turnover.</strong> Every rebalancing date requires trading every stock back to equal weight.</li>
<li><strong>Illiquidity exposure.</strong> Equal weighting of micro-cap stocks that trade VND 100 million/day alongside large-caps trading VND 500 billion/day creates severe implementation challenges.</li>
<li><strong>Price impact.</strong> In a market with daily price limits (<span class="math inline">\(\pm\)</span> 7% on HOSE, <span class="math inline">\(\pm\)</span> 10% on HNX), rebalancing trades for illiquid names may hit limit-up or limit-down, preventing full execution.</li>
</ul>
</section>
<section id="the-weighting-spectrum" class="level3" data-number="12.1.3">
<h3 data-number="12.1.3" class="anchored" data-anchor-id="the-weighting-spectrum"><span class="header-section-number">12.1.3</span> The Weighting Spectrum</h3>
<p>Between VW and EW lies a continuum of weighting schemes. <a href="#tbl-weight-schemes" class="quarto-xref">Table&nbsp;<span>12.1</span></a> summarizes the major alternatives.</p>
<div id="tbl-weight-schemes" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-weight-schemes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.1: Summary of portfolio weighting schemes.
</figcaption>
<div aria-describedby="tbl-weight-schemes-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Scheme</th>
<th>Weight Formula</th>
<th>Key Property</th>
<th>Key Risk</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Value-weighted</td>
<td><span class="math inline">\(w_i \propto \text{MCap}_i\)</span></td>
<td>Self-rebalancing, low turnover</td>
<td>Large-cap concentration</td>
</tr>
<tr class="even">
<td>Equal-weighted</td>
<td><span class="math inline">\(w_i = 1/N\)</span></td>
<td>Maximum naive diversification</td>
<td>High turnover, illiquidity</td>
</tr>
<tr class="odd">
<td>Fundamental</td>
<td><span class="math inline">\(w_i \propto F_i\)</span> (revenue, book equity, etc.)</td>
<td>Breaks price-value link</td>
<td>Requires accounting data</td>
</tr>
<tr class="even">
<td>Minimum variance</td>
<td><span class="math inline">\(\mathbf{w} = \arg\min \mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}\)</span></td>
<td>Lowest portfolio volatility</td>
<td>Estimation error in <span class="math inline">\(\boldsymbol{\Sigma}\)</span></td>
</tr>
<tr class="odd">
<td>Risk parity</td>
<td><span class="math inline">\(w_i \sigma_i = w_j \sigma_j \; \forall \, i,j\)</span></td>
<td>Equal risk contribution</td>
<td>Leverages low-vol assets</td>
</tr>
<tr class="even">
<td>Maximum diversification</td>
<td><span class="math inline">\(\max \frac{\mathbf{w}'\boldsymbol{\sigma}}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}\)</span></td>
<td>Maximizes diversification ratio</td>
<td>Sensitive to correlation estimates</td>
</tr>
<tr class="odd">
<td>Capped VW</td>
<td><span class="math inline">\(w_i \propto \text{MCap}_i\)</span>, <span class="math inline">\(w_i \leq \bar{w}\)</span></td>
<td>Reduces concentration</td>
<td>Arbitrary cap threshold</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-weight-data" class="level2" data-number="12.2">
<h2 data-number="12.2" class="anchored" data-anchor-id="sec-weight-data"><span class="header-section-number">12.2</span> Data Construction</h2>
<div id="setup" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.covariance <span class="im">import</span> LedoitWolf</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="data-load" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily prices and volume</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>daily <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'turnover_value'</span>, <span class="st">'market_cap'</span>, <span class="st">'shares_outstanding'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bid_ask_spread'</span>, <span class="st">'free_float_pct'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (pre-computed for convenience)</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Fundamentals for fundamental weighting</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>fundamentals <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'revenue'</span>, <span class="st">'book_equity'</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_assets'</span>, <span class="st">'dividends_paid'</span>, <span class="st">'operating_cash_flow'</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Market-level returns for benchmarking</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>market_index <span class="op">=</span> client.get_index(</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">'VNINDEX'</span>,</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'monthly'</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span>daily<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly observations: </span><span class="sc">{</span>monthly<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique tickers: </span><span class="sc">{</span>monthly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="universe-construction-and-liquidity-filters" class="level3" data-number="12.2.1">
<h3 data-number="12.2.1" class="anchored" data-anchor-id="universe-construction-and-liquidity-filters"><span class="header-section-number">12.2.1</span> Universe Construction and Liquidity Filters</h3>
<p>A critical pre-processing step is defining the investable universe. Including all listed stocks, regardless of liquidity, inflates the apparent benefits of equal-weighting and other small-cap-tilted schemes because it implicitly assumes the ability to trade illiquid stocks without friction. We apply graduated liquidity filters and track how results change.</p>
<div id="universe-construction" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_universe(monthly_df, min_mcap_pct<span class="op">=</span><span class="dv">0</span>, min_turnover<span class="op">=</span><span class="dv">0</span>, min_months<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct investable universe with liquidity filters.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    min_mcap_pct : float</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Exclude stocks below this market cap percentile (0-100).</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">    min_turnover : float</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum average daily turnover in VND billion.</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">    min_months : int</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum months of return history required.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> monthly_df.copy()</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market cap percentile filter (within each month)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> min_mcap_pct <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"mcap_pctile"</span>] <span class="op">=</span> df.groupby(<span class="st">"month_end"</span>)[<span class="st">"market_cap"</span>].transform(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rank(pct<span class="op">=</span><span class="va">True</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"mcap_pctile"</span>] <span class="op">&gt;=</span> min_mcap_pct]</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover filter</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> min_turnover <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"turnover_value_avg_20d"</span>] <span class="op">&gt;=</span> min_turnover <span class="op">*</span> <span class="fl">1e9</span>]</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># History filter</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    ticker_months <span class="op">=</span> df.groupby(<span class="st">"ticker"</span>)[<span class="st">"month_end"</span>].transform(<span class="st">"count"</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[ticker_months <span class="op">&gt;=</span> min_months]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Define three universes of increasing restrictiveness</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>universe_all <span class="op">=</span> construct_universe(monthly)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>universe_mid <span class="op">=</span> construct_universe(monthly, min_mcap_pct<span class="op">=</span><span class="dv">20</span>, min_turnover<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>universe_liquid <span class="op">=</span> construct_universe(monthly, min_mcap_pct<span class="op">=</span><span class="dv">40</span>, min_turnover<span class="op">=</span><span class="fl">2.0</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, univ <span class="kw">in</span> [</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"All stocks"</span>, universe_all),</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Mid filter"</span>, universe_mid),</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Liquid only"</span>, universe_liquid),</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    n_stocks <span class="op">=</span> univ.groupby(<span class="st">"month_end"</span>)[<span class="st">"ticker"</span>].nunique().median()</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: median </span><span class="sc">{</span>n_stocks<span class="sc">:.0f}</span><span class="ss"> stocks/month"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="market-capitalization-concentration" class="level3" data-number="12.2.2">
<h3 data-number="12.2.2" class="anchored" data-anchor-id="market-capitalization-concentration"><span class="header-section-number">12.2.2</span> Market Capitalization Concentration</h3>
<p>Before comparing weighting schemes, it is instructive to document how concentrated the Vietnamese market actually is.</p>
<div id="fig-concentration" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-concentration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Cumulative market cap share (latest month)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> monthly[monthly[<span class="st">'month_end'</span>] <span class="op">==</span> monthly[<span class="st">'month_end'</span>].<span class="bu">max</span>()].copy()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> latest.sort_values(<span class="st">'market_cap'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'cum_mcap_share'</span>] <span class="op">=</span> (</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    latest[<span class="st">'market_cap'</span>].cumsum() <span class="op">/</span> latest[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'rank'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(latest) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'rank_pct'</span>] <span class="op">=</span> latest[<span class="st">'rank'</span>] <span class="op">/</span> <span class="bu">len</span>(latest) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(latest[<span class="st">'rank_pct'</span>], latest[<span class="st">'cum_mcap_share'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">80</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark top 10 and top 30</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>n_at_50 <span class="op">=</span> (latest[<span class="st">'cum_mcap_share'</span>] <span class="op">&lt;=</span> <span class="fl">0.50</span>).<span class="bu">sum</span>()</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].annotate(<span class="ss">f'Top </span><span class="sc">{</span>n_at_50<span class="sc">}</span><span class="ss"> stocks = 50%'</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                 xy<span class="op">=</span>(n_at_50 <span class="op">/</span> <span class="bu">len</span>(latest) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">50</span>),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Cumulative Stock Rank (%)'</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Cumulative Market Cap Share (%)'</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Market Cap Concentration Curve'</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: HHI over time</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>hhi_ts <span class="op">=</span> (</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    monthly</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'month_end'</span>)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: (g[<span class="st">'market_cap'</span>] <span class="op">/</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()).<span class="bu">pow</span>(<span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'hhi'</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>hhi_ts[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(hhi_ts[<span class="st">'month_end'</span>])</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(hhi_ts[<span class="st">'month_end'</span>], hhi_ts[<span class="st">'hhi'</span>] <span class="op">*</span> <span class="dv">10000</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'HHI (basis points)'</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Herfindahl Index of VW Weights'</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-concentration-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.1
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-weight-implementation" class="level2" data-number="12.3">
<h2 data-number="12.3" class="anchored" data-anchor-id="sec-weight-implementation"><span class="header-section-number">12.3</span> Implementing Weighting Schemes</h2>
<p>We now implement each weighting scheme and compute monthly portfolio returns. All implementations follow a common structure: at each rebalancing date, compute target weights from available information, then compute the weighted return over the subsequent holding period.</p>
<section id="core-portfolio-engine" class="level3" data-number="12.3.1">
<h3 data-number="12.3.1" class="anchored" data-anchor-id="core-portfolio-engine"><span class="header-section-number">12.3.1</span> Core Portfolio Engine</h3>
<div id="portfolio-engine" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    monthly_df,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    weight_fn,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    rebal_freq<span class="op">=</span><span class="st">"M"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    max_weight<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    min_weight<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute time series of portfolio returns for a given weighting function.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain 'ticker', 'month_end', 'monthly_return', and any</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">        columns needed by weight_fn.</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">    weight_fn : callable</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">        Function that takes a cross-section DataFrame and returns a</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Series of weights indexed by ticker. Weights need not sum to 1</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">        (they will be normalized).</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="co">    rebal_freq : str</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co">        'M' for monthly, 'Q' for quarterly, 'A' for annual.</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">    max_weight : float</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum weight per stock (for capped schemes).</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co">    min_weight : float</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum weight per stock.</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with columns: month_end, port_return, n_stocks,</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a><span class="co">    turnover, hhi, effective_n</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(monthly_df[<span class="st">"month_end"</span>].unique())</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine rebalancing dates</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rebal_freq <span class="op">==</span> <span class="st">"M"</span>:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(months)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebal_freq <span class="op">==</span> <span class="st">"Q"</span>:</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(pd.to_datetime(months).to_period(<span class="st">"Q"</span>).to_timestamp(<span class="st">"M"</span>))</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map to nearest month-end</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> {m <span class="cf">for</span> m <span class="kw">in</span> months <span class="cf">if</span> pd.Timestamp(m).month <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> <span class="dv">0</span>}</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> rebal_dates:</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>            rebal_dates <span class="op">=</span> <span class="bu">set</span>(months[::<span class="dv">3</span>])</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebal_freq <span class="op">==</span> <span class="st">"A"</span>:</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> {m <span class="cf">for</span> m <span class="kw">in</span> months <span class="cf">if</span> pd.Timestamp(m).month <span class="op">==</span> <span class="dv">6</span>}</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> rebal_dates:</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>            rebal_dates <span class="op">=</span> <span class="bu">set</span>(months[::<span class="dv">12</span>])</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(months)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    prev_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> monthly_df[monthly_df[<span class="st">"month_end"</span>] <span class="op">==</span> month].copy()</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> cross_section.dropna(subset<span class="op">=</span>[<span class="st">"monthly_return"</span>])</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cross_section) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> month <span class="kw">in</span> rebal_dates <span class="kw">or</span> prev_weights <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute fresh weights</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>            raw_weights <span class="op">=</span> weight_fn(cross_section)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>            raw_weights <span class="op">=</span> raw_weights.clip(lower<span class="op">=</span>min_weight, upper<span class="op">=</span>max_weight)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>            total <span class="op">=</span> raw_weights.<span class="bu">sum</span>()</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>            target_weights <span class="op">=</span> raw_weights <span class="op">/</span> total</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift weights forward from previous month</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>                available <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>                drifted <span class="op">=</span> prev_weights.reindex(available.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Adjust for returns</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a>                drifted <span class="op">=</span> drifted <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> available[<span class="st">"monthly_return"</span>])</span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>                total <span class="op">=</span> drifted.<span class="bu">sum</span>()</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>                target_weights <span class="op">=</span> drifted <span class="op">/</span> total</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align weights with available stocks</span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>        aligned_w <span class="op">=</span> target_weights.reindex(cross_section.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a>        aligned_w <span class="op">=</span> aligned_w <span class="op">/</span> aligned_w.<span class="bu">sum</span>()</span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Portfolio return</span></span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>        port_ret <span class="op">=</span> (aligned_w <span class="op">*</span> cross_section[<span class="st">"monthly_return"</span>]).<span class="bu">sum</span>()</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turnover (two-way)</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>            prev_aligned <span class="op">=</span> prev_weights.reindex(aligned_w.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift previous weights</span></span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>            prev_drifted <span class="op">=</span> prev_aligned <span class="op">*</span> (</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span></span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> cross_section[<span class="st">"monthly_return"</span>].reindex(</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>                    prev_aligned.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            prev_drifted <span class="op">=</span> (</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>                prev_drifted <span class="op">/</span> prev_drifted.<span class="bu">sum</span>()</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prev_drifted.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb5-103"><a href="#cb5-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span> prev_drifted</span>
<span id="cb5-104"><a href="#cb5-104" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb5-105"><a href="#cb5-105" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> (aligned_w <span class="op">-</span> prev_drifted).<span class="bu">abs</span>().<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb5-106"><a href="#cb5-106" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb5-107"><a href="#cb5-107" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb5-108"><a href="#cb5-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-109"><a href="#cb5-109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concentration metrics</span></span>
<span id="cb5-110"><a href="#cb5-110" aria-hidden="true" tabindex="-1"></a>        hhi <span class="op">=</span> (aligned_w<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb5-111"><a href="#cb5-111" aria-hidden="true" tabindex="-1"></a>        effective_n <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> hhi <span class="cf">if</span> hhi <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb5-112"><a href="#cb5-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-113"><a href="#cb5-113" aria-hidden="true" tabindex="-1"></a>        results.append(</span>
<span id="cb5-114"><a href="#cb5-114" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb5-115"><a href="#cb5-115" aria-hidden="true" tabindex="-1"></a>                <span class="st">"month_end"</span>: month,</span>
<span id="cb5-116"><a href="#cb5-116" aria-hidden="true" tabindex="-1"></a>                <span class="st">"port_return"</span>: port_ret,</span>
<span id="cb5-117"><a href="#cb5-117" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_stocks"</span>: (aligned_w <span class="op">&gt;</span> <span class="fl">1e-6</span>).<span class="bu">sum</span>(),</span>
<span id="cb5-118"><a href="#cb5-118" aria-hidden="true" tabindex="-1"></a>                <span class="st">"turnover"</span>: turnover,</span>
<span id="cb5-119"><a href="#cb5-119" aria-hidden="true" tabindex="-1"></a>                <span class="st">"hhi"</span>: hhi,</span>
<span id="cb5-120"><a href="#cb5-120" aria-hidden="true" tabindex="-1"></a>                <span class="st">"effective_n"</span>: effective_n,</span>
<span id="cb5-121"><a href="#cb5-121" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb5-122"><a href="#cb5-122" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-123"><a href="#cb5-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-124"><a href="#cb5-124" aria-hidden="true" tabindex="-1"></a>        prev_weights <span class="op">=</span> aligned_w.copy()</span>
<span id="cb5-125"><a href="#cb5-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-126"><a href="#cb5-126" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="value-weighted-portfolio" class="level3" data-number="12.3.2">
<h3 data-number="12.3.2" class="anchored" data-anchor-id="value-weighted-portfolio"><span class="header-section-number">12.3.2</span> Value-Weighted Portfolio</h3>
<div id="vw-portfolio" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vw_weights(cross_section):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Value-weighted: proportional to market cap."""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cross_section.set_index(<span class="st">'ticker'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>vw_returns <span class="op">=</span> compute_portfolio_returns(universe_mid, vw_weights, rebal_freq<span class="op">=</span><span class="st">'M'</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"VW portfolio: </span><span class="sc">{</span><span class="bu">len</span>(vw_returns)<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean monthly return: </span><span class="sc">{</span>vw_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean turnover: </span><span class="sc">{</span>vw_returns[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean effective N: </span><span class="sc">{</span>vw_returns[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="equal-weighted-portfolio" class="level3" data-number="12.3.3">
<h3 data-number="12.3.3" class="anchored" data-anchor-id="equal-weighted-portfolio"><span class="header-section-number">12.3.3</span> Equal-Weighted Portfolio</h3>
<div id="ew-portfolio" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ew_weights(cross_section):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Equal-weighted: 1/N."""</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> cross_section.set_index(<span class="st">'ticker'</span>).index</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>tickers)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly rebalancing</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>ew_monthly <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Quarterly rebalancing</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>ew_quarterly <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Annual rebalancing (June)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>ew_annual <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'A'</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">'EW Monthly'</span>, ew_monthly),</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">'EW Quarterly'</span>, ew_quarterly),</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">'EW Annual'</span>, ew_annual)]:</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: mean ret = </span><span class="sc">{</span>df[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"turnover = </span><span class="sc">{</span>df[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="capped-value-weighted-portfolio" class="level3" data-number="12.3.4">
<h3 data-number="12.3.4" class="anchored" data-anchor-id="capped-value-weighted-portfolio"><span class="header-section-number">12.3.4</span> Capped Value-Weighted Portfolio</h3>
<p>To mitigate the concentration of pure VW while retaining its low-turnover properties, we impose a cap on individual stock weights. A common choice is 5% or 10%, mimicking the construction rules of capped indices such as the MSCI Capped indices.</p>
<div id="capped-vw" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> capped_vw_weights(cross_section, cap<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Capped VW: market cap weights with an upper bound."""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cross_section.set_index(<span class="st">'ticker'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> w <span class="op">/</span> w.<span class="bu">sum</span>()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterative capping (redistribute excess weight)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>):</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> w[w <span class="op">&gt;</span> cap] <span class="op">-</span> cap</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> excess.<span class="bu">sum</span>() <span class="op">&lt;=</span> <span class="fl">1e-8</span>:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        w[w <span class="op">&gt;</span> cap] <span class="op">=</span> cap</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        w[w <span class="op">&lt;=</span> cap] <span class="op">*=</span> (<span class="dv">1</span> <span class="op">+</span> excess.<span class="bu">sum</span>() <span class="op">/</span> w[w <span class="op">&lt;=</span> cap].<span class="bu">sum</span>())</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> w</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>capped5 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    universe_mid, <span class="kw">lambda</span> cs: capped_vw_weights(cs, <span class="fl">0.05</span>), rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>capped10 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    universe_mid, <span class="kw">lambda</span> cs: capped_vw_weights(cs, <span class="fl">0.10</span>), rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Capped 5%: eff_N = </span><span class="sc">{</span>capped5[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">, "</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"turnover = </span><span class="sc">{</span>capped5[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Capped 10%: eff_N = </span><span class="sc">{</span>capped10[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">, "</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"turnover = </span><span class="sc">{</span>capped10[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="fundamental-weighted-portfolio" class="level3" data-number="12.3.5">
<h3 data-number="12.3.5" class="anchored" data-anchor-id="fundamental-weighted-portfolio"><span class="header-section-number">12.3.5</span> Fundamental-Weighted Portfolio</h3>
<p><span class="citation" data-cites="arnott2005fundamental">Arnott, Hsu, and Moore (<a href="references.html#ref-arnott2005fundamental" role="doc-biblioref">2005</a>)</span> propose weighting stocks by fundamental measures (revenue, book equity, dividends, cash flow) rather than market cap. The logic is that fundamental weights are not contaminated by pricing errors, breaking the mechanical overweighting of overvalued stocks inherent in VW. We construct a composite fundamental weight using the average rank across four measures:</p>
<p><span id="eq-fw"><span class="math display">\[
w_{i,t}^{FW} \propto \frac{1}{4}\left(\text{Rank}_{i,t}^{\text{Rev}} + \text{Rank}_{i,t}^{\text{BE}} + \text{Rank}_{i,t}^{\text{Div}} + \text{Rank}_{i,t}^{\text{CFO}}\right)
\tag{12.3}\]</span></span></p>
<div id="fundamental-weighted" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge fundamentals with monthly data (use most recent fiscal year)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fundamentals[<span class="st">"merge_year"</span>] <span class="op">=</span> fundamentals[<span class="st">"fiscal_year"</span>] <span class="op">+</span> <span class="dv">1</span>  <span class="co"># Lag by 1 year</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>monthly_fund <span class="op">=</span> monthly.copy()</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>monthly_fund[<span class="st">"year"</span>] <span class="op">=</span> pd.to_datetime(monthly_fund[<span class="st">"month_end"</span>]).dt.year</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>monthly_fund <span class="op">=</span> monthly_fund.merge(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    fundamentals.rename(columns<span class="op">=</span>{<span class="st">"merge_year"</span>: <span class="st">"year"</span>}),</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"year"</span>],</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fw_weights(cross_section):</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fundamental-weighted: composite of revenue, book equity, dividends, CFO."""</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    cs <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    ranks <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>cs.index)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"revenue"</span>, <span class="st">"book_equity"</span>, <span class="st">"dividends_paid"</span>, <span class="st">"operating_cash_flow"</span>]:</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> cs.columns:</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            vals <span class="op">=</span> cs[col].clip(lower<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Only positive values</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>            ranks[col] <span class="op">=</span> vals.rank(pct<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    composite <span class="op">=</span> ranks.mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    composite <span class="op">=</span> composite.fillna(<span class="dv">0</span>)</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> composite</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>fw_returns <span class="op">=</span> compute_portfolio_returns(monthly_fund, fw_weights, rebal_freq<span class="op">=</span><span class="st">"A"</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Fundamental-weighted: mean ret = </span><span class="sc">{</span>fw_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"eff_N = </span><span class="sc">{</span>fw_returns[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-weight-risk-based" class="level2" data-number="12.4">
<h2 data-number="12.4" class="anchored" data-anchor-id="sec-weight-risk-based"><span class="header-section-number">12.4</span> Risk-Based Weighting Schemes</h2>
<p>The weighting schemes above use only market cap or accounting data. Risk-based schemes incorporate the covariance structure of returns, aiming to produce portfolios with better risk-adjusted performance. The trade-off is that they require estimating the covariance matrix (i.e., a high-dimensional object that is notoriously difficult to estimate precisely with short time series).</p>
<section id="covariance-estimation" class="level3" data-number="12.4.1">
<h3 data-number="12.4.1" class="anchored" data-anchor-id="covariance-estimation"><span class="header-section-number">12.4.1</span> Covariance Estimation</h3>
<p>With <span class="math inline">\(N \approx 300\)</span> stocks and <span class="math inline">\(T \approx 60\)</span> months, the sample covariance matrix is severely ill-conditioned. We use the <span class="citation" data-cites="ledoit2004well">Ledoit and Wolf (<a href="references.html#ref-ledoit2004well" role="doc-biblioref">2004</a>)</span> shrinkage estimator, which pulls the sample covariance toward a structured target (the identity matrix scaled by the average variance):</p>
<p><span id="eq-shrinkage"><span class="math display">\[
\hat{\boldsymbol{\Sigma}}^{\text{shrink}} = \delta \mathbf{F} + (1 - \delta) \mathbf{S}
\tag{12.4}\]</span></span></p>
<p>where <span class="math inline">\(\mathbf{S}\)</span> is the sample covariance, <span class="math inline">\(\mathbf{F}\)</span> is the shrinkage target, and <span class="math inline">\(\delta \in [0,1]\)</span> is the optimal shrinkage intensity derived analytically.</p>
<div id="covariance-estimation" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_covariance(monthly_df, month, lookback<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate covariance matrix using Ledoit-Wolf shrinkage.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame with ticker, month_end, monthly_return</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    month : target month (use returns before this date)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    lookback : number of months to use</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : minimum observations per stock</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co">    cov_matrix : DataFrame (N x N)</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co">    tickers : list of tickers with sufficient data</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    end_date <span class="op">=</span> pd.Timestamp(month)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> end_date <span class="op">-</span> pd.DateOffset(months<span class="op">=</span>lookback)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> monthly_df[</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        (monthly_df[<span class="st">'month_end'</span>] <span class="op">&gt;</span> start_date) <span class="op">&amp;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        (monthly_df[<span class="st">'month_end'</span>] <span class="op">&lt;=</span> end_date)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to wide format</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    returns_wide <span class="op">=</span> window.pivot_table(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">'month_end'</span>, columns<span class="op">=</span><span class="st">'ticker'</span>, values<span class="op">=</span><span class="st">'monthly_return'</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep stocks with sufficient observations</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    valid_cols <span class="op">=</span> returns_wide.columns[returns_wide.notna().<span class="bu">sum</span>() <span class="op">&gt;=</span> min_obs]</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    returns_wide <span class="op">=</span> returns_wide[valid_cols].dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill remaining NAs with 0 (conservative)</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>    returns_clean <span class="op">=</span> returns_wide.fillna(<span class="dv">0</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> returns_clean.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ledoit-Wolf shrinkage</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>    lw <span class="op">=</span> LedoitWolf()</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    lw.fit(returns_clean.values)</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> pd.DataFrame(</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        lw.covariance_,</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>valid_cols, columns<span class="op">=</span>valid_cols</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cov_matrix, <span class="bu">list</span>(valid_cols)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="minimum-variance-portfolio" class="level3" data-number="12.4.2">
<h3 data-number="12.4.2" class="anchored" data-anchor-id="minimum-variance-portfolio"><span class="header-section-number">12.4.2</span> Minimum Variance Portfolio</h3>
<p>The global minimum variance (GMV) portfolio minimizes portfolio variance without targeting a specific return level <span class="citation" data-cites="clarke2011minimum">(<a href="references.html#ref-clarke2011minimum" role="doc-biblioref">Clarke, De Silva, and Thorley 2011</a>)</span>:</p>
<p><span id="eq-minvar"><span class="math display">\[
\mathbf{w}^{MV} = \arg\min_{\mathbf{w}} \; \mathbf{w}'\hat{\boldsymbol{\Sigma}}\mathbf{w} \quad \text{s.t.} \quad \mathbf{1}'\mathbf{w} = 1, \; w_i \geq 0
\tag{12.5}\]</span></span></p>
<p>The long-only constraint (<span class="math inline">\(w_i \geq 0\)</span>) is essential in practice and also acts as an implicit shrinkage that improves out-of-sample performance <span class="citation" data-cites="jagannathan2003risk">(<a href="references.html#ref-jagannathan2003risk" role="doc-biblioref">Jagannathan and Ma 2003</a>)</span>.</p>
<div id="minimum-variance" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minimum_variance_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Solve for the minimum variance portfolio with long-only</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">    and position-size constraints.</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> portfolio_variance(w):</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> w <span class="op">@</span> Sigma <span class="op">@</span> w</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="dv">0</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        portfolio_variance, x0,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mv_weight_fn(cross_section, cov_cache<span class="op">=</span>{}):</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Wrapper for portfolio engine: minimum variance."""</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> cross_section[<span class="st">'month_end'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> cov_cache:</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        cov_matrix, tickers <span class="op">=</span> estimate_covariance(monthly, month)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        cov_cache[month] <span class="op">=</span> (cov_matrix, tickers)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    cov_matrix, tickers <span class="op">=</span> cov_cache[month]</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback to equal weight</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict to stocks in both cross-section and covariance matrix</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    available <span class="op">=</span> <span class="bu">set</span>(cross_section[<span class="st">'ticker'</span>]) <span class="op">&amp;</span> <span class="bu">set</span>(tickers)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    sub_cov <span class="op">=</span> cov_matrix.loc[<span class="bu">list</span>(available), <span class="bu">list</span>(available)]</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> minimum_variance_weights(sub_cov)</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weights</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>mv_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>    universe_mid, mv_weight_fn, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Min Variance: mean ret = </span><span class="sc">{</span>mv_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"std = </span><span class="sc">{</span>mv_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="risk-parity-equal-risk-contribution" class="level3" data-number="12.4.3">
<h3 data-number="12.4.3" class="anchored" data-anchor-id="risk-parity-equal-risk-contribution"><span class="header-section-number">12.4.3</span> Risk Parity (Equal Risk Contribution)</h3>
<p>Risk parity allocates so that each asset contributes equally to total portfolio risk <span class="citation" data-cites="maillard2010properties">(<a href="references.html#ref-maillard2010properties" role="doc-biblioref">Maillard, Roncalli, and Teƒ±Ãàletche 2010</a>)</span>. The risk contribution of asset <span class="math inline">\(i\)</span> is:</p>
<p><span id="eq-risk-contribution"><span class="math display">\[
RC_i = w_i \cdot \frac{(\boldsymbol{\Sigma} \mathbf{w})_i}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}
\tag{12.6}\]</span></span></p>
<p>The risk parity portfolio solves <span class="math inline">\(RC_i = RC_j\)</span> for all <span class="math inline">\(i, j\)</span>:</p>
<div id="risk-parity" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> risk_parity_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Solve for the risk parity portfolio where each asset</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">    contributes equally to total portfolio variance.</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> risk_parity_objective(w):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>        port_var <span class="op">=</span> w <span class="op">@</span> Sigma <span class="op">@</span> w</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        marginal <span class="op">=</span> Sigma <span class="op">@</span> w</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        risk_contrib <span class="op">=</span> w <span class="op">*</span> marginal</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        target_rc <span class="op">=</span> port_var <span class="op">/</span> n</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>((risk_contrib <span class="op">-</span> target_rc) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="fl">1e-6</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        risk_parity_objective, x0,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rp_weight_fn(cross_section, cov_cache<span class="op">=</span>{}):</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Wrapper for portfolio engine: risk parity."""</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> cross_section[<span class="st">'month_end'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> cov_cache:</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        cov_matrix, tickers <span class="op">=</span> estimate_covariance(monthly, month)</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        cov_cache[month] <span class="op">=</span> (cov_matrix, tickers)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>    cov_matrix, tickers <span class="op">=</span> cov_cache[month]</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    available <span class="op">=</span> <span class="bu">set</span>(cross_section[<span class="st">'ticker'</span>]) <span class="op">&amp;</span> <span class="bu">set</span>(tickers)</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    sub_cov <span class="op">=</span> cov_matrix.loc[<span class="bu">list</span>(available), <span class="bu">list</span>(available)]</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> risk_parity_weights(sub_cov)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>rp_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>    universe_mid, rp_weight_fn, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Risk Parity: mean ret = </span><span class="sc">{</span>rp_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"std = </span><span class="sc">{</span>rp_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="maximum-diversification-portfolio" class="level3" data-number="12.4.4">
<h3 data-number="12.4.4" class="anchored" data-anchor-id="maximum-diversification-portfolio"><span class="header-section-number">12.4.4</span> Maximum Diversification Portfolio</h3>
<p><span class="citation" data-cites="choueifaty2008towards">Choueifaty (<a href="references.html#ref-choueifaty2008towards" role="doc-biblioref">2008</a>)</span> define the diversification ratio as the ratio of weighted average volatility to portfolio volatility:</p>
<p><span id="eq-div-ratio"><span class="math display">\[
DR(\mathbf{w}) = \frac{\mathbf{w}'\boldsymbol{\sigma}}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}
\tag{12.7}\]</span></span></p>
<p>where <span class="math inline">\(\boldsymbol{\sigma}\)</span> is the vector of individual asset volatilities. The maximum diversification portfolio maximizes this ratio:</p>
<div id="max-diversification" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_diversification_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Maximize the diversification ratio."""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(np.diag(Sigma))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> neg_div_ratio(w):</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>        port_vol <span class="op">=</span> np.sqrt(w <span class="op">@</span> Sigma <span class="op">@</span> w)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> port_vol <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>(w <span class="op">@</span> sigma) <span class="op">/</span> port_vol</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="dv">0</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        neg_div_ratio, x0,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-weight-comparison" class="level2" data-number="12.5">
<h2 data-number="12.5" class="anchored" data-anchor-id="sec-weight-comparison"><span class="header-section-number">12.5</span> Comprehensive Performance Comparison</h2>
<p>We now compare all schemes on a common universe with consistent methodology.</p>
<div id="all-portfolios" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all portfolio return series</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>portfolios <span class="op">=</span> {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: vw_returns,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Monthly)'</span>: ew_monthly,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Quarterly)'</span>: ew_quarterly,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Annual)'</span>: ew_annual,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (5%)'</span>: capped5,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (10%)'</span>: capped10,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fundamental'</span>: fw_returns,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Variance'</span>: mv_returns,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Risk Parity'</span>: rp_returns,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Align to common date range</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>common_start <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'month_end'</span>].<span class="bu">min</span>() <span class="cf">for</span> df <span class="kw">in</span> portfolios.values())</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>common_end <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'month_end'</span>].<span class="bu">max</span>() <span class="cf">for</span> df <span class="kw">in</span> portfolios.values())</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> portfolios:</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    portfolios[name] <span class="op">=</span> portfolios[name][</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        (portfolios[name][<span class="st">'month_end'</span>] <span class="op">&gt;=</span> common_start) <span class="op">&amp;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>        (portfolios[name][<span class="st">'month_end'</span>] <span class="op">&lt;=</span> common_end)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Common period: </span><span class="sc">{</span>common_start<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>common_end<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of months: </span><span class="sc">{</span><span class="bu">len</span>(portfolios[<span class="st">'VW'</span>])<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="performance-metrics" class="level3" data-number="12.5.1">
<h3 data-number="12.5.1" class="anchored" data-anchor-id="performance-metrics"><span class="header-section-number">12.5.1</span> Performance Metrics</h3>
<div id="performance-metrics" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_metrics(returns_df, risk_free_annual<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute performance metrics from monthly portfolio returns."""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> returns_df[<span class="st">'port_return'</span>]</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    rf_monthly <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> risk_free_annual) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> r <span class="op">-</span> rf_monthly</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    n_months <span class="op">=</span> <span class="bu">len</span>(r)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualized return</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    cum_ret <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> r).prod()</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    ann_ret <span class="op">=</span> cum_ret <span class="op">**</span> (<span class="dv">12</span> <span class="op">/</span> n_months) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualized volatility</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    ann_vol <span class="op">=</span> r.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Maximum drawdown</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> r).cumprod()</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    running_max <span class="op">=</span> cum.cummax()</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cum <span class="op">-</span> running_max) <span class="op">/</span> running_max</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sortino ratio</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    downside <span class="op">=</span> excess[excess <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    downside_vol <span class="op">=</span> np.sqrt((downside <span class="op">**</span> <span class="dv">2</span>).mean()) <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>    sortino <span class="op">=</span> excess.mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">/</span> downside_vol <span class="cf">if</span> downside_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calmar ratio</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    calmar <span class="op">=</span> ann_ret <span class="op">/</span> <span class="bu">abs</span>(max_dd) <span class="cf">if</span> max_dd <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average turnover and effective N</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    avg_turnover <span class="op">=</span> returns_df[<span class="st">'turnover'</span>].mean()</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    avg_eff_n <span class="op">=</span> returns_df[<span class="st">'effective_n'</span>].mean()</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skewness and kurtosis</span></span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    skew <span class="op">=</span> r.skew()</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>    kurt <span class="op">=</span> r.kurtosis()</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Ann. Return'</span>: ann_ret,</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Ann. Volatility'</span>: ann_vol,</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Sharpe Ratio'</span>: sharpe,</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Sortino Ratio'</span>: sortino,</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Max Drawdown'</span>: max_dd,</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Calmar Ratio'</span>: calmar,</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Skewness'</span>: skew,</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Kurtosis'</span>: kurt,</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg. Turnover'</span>: avg_turnover,</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Effective N'</span>: avg_eff_n</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute metrics for all portfolios</span></span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>metrics_list <span class="op">=</span> []</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> compute_metrics(df)</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>    m[<span class="st">'Portfolio'</span>] <span class="op">=</span> name</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>    metrics_list.append(m)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_list).set_index(<span class="st">'Portfolio'</span>)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Format for display</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>display_cols <span class="op">=</span> [</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Ann. Return'</span>, <span class="st">'Ann. Volatility'</span>, <span class="st">'Sharpe Ratio'</span>, <span class="st">'Sortino Ratio'</span>,</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>, <span class="st">'Avg. Turnover'</span>, <span class="st">'Effective N'</span></span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df[display_cols].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-cumulative-returns" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="17">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumulative-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'EW (Monthly)'</span>: <span class="st">'#E67E22'</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Quarterly)'</span>: <span class="st">'#F39C12'</span>, <span class="st">'EW (Annual)'</span>: <span class="st">'#D4AC0D'</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (5%)'</span>: <span class="st">'#8E44AD'</span>, <span class="st">'Capped VW (10%)'</span>: <span class="st">'#9B59B6'</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fundamental'</span>: <span class="st">'#27AE60'</span>, <span class="st">'Min Variance'</span>: <span class="st">'#C0392B'</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Risk Parity'</span>: <span class="st">'#1ABC9C'</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>linestyles <span class="op">=</span> {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: <span class="st">'-'</span>, <span class="st">'EW (Monthly)'</span>: <span class="st">'-'</span>, <span class="st">'EW (Quarterly)'</span>: <span class="st">'--'</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Annual)'</span>: <span class="st">':'</span>, <span class="st">'Capped VW (5%)'</span>: <span class="st">'-'</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (10%)'</span>: <span class="st">'--'</span>, <span class="st">'Fundamental'</span>: <span class="st">'-'</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Variance'</span>: <span class="st">'-'</span>, <span class="st">'Risk Parity'</span>: <span class="st">'-'</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df.set_index(<span class="st">'month_end'</span>)[<span class="st">'port_return'</span>]).cumprod()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum.index, cum.values, label<span class="op">=</span>name,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>),</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            linestyle<span class="op">=</span>linestyles.get(name, <span class="st">'-'</span>),</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="fl">1.8</span> <span class="cf">if</span> name <span class="kw">in</span> [<span class="st">'VW'</span>, <span class="st">'EW (Monthly)'</span>, <span class="st">'Min Variance'</span>] <span class="cf">else</span> <span class="fl">1.2</span>)</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Cumulative Wealth (VND 1 invested)'</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Cumulative Performance by Weighting Scheme'</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-cumulative-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.2
</figcaption>
</figure>
</div>
</section>
<section id="risk-return-trade-off" class="level3" data-number="12.5.2">
<h3 data-number="12.5.2" class="anchored" data-anchor-id="risk-return-trade-off"><span class="header-section-number">12.5.2</span> Risk-Return Trade-Off</h3>
<div id="fig-risk-return" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-risk-return-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">7</span>))</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> metrics_df.index:</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        metrics_df.loc[name, <span class="st">'Ann. Volatility'</span>],</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        metrics_df.loc[name, <span class="st">'Ann. Return'</span>],</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>metrics_df.loc[name, <span class="st">'Effective N'</span>] <span class="op">*</span> <span class="dv">3</span>,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">5</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        name,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        (metrics_df.loc[name, <span class="st">'Ann. Volatility'</span>] <span class="op">+</span> <span class="fl">0.002</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>         metrics_df.loc[name, <span class="st">'Ann. Return'</span>]),</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">8</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Annualized Volatility'</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Annualized Return'</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Risk-Return Profile (bubble size = Effective N)'</span>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-risk-return-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.3
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-weight-transaction-costs" class="level2" data-number="12.6">
<h2 data-number="12.6" class="anchored" data-anchor-id="sec-weight-transaction-costs"><span class="header-section-number">12.6</span> Transaction Costs and Net-of-Cost Performance</h2>
<section id="estimating-trading-costs-in-vietnam" class="level3" data-number="12.6.1">
<h3 data-number="12.6.1" class="anchored" data-anchor-id="estimating-trading-costs-in-vietnam"><span class="header-section-number">12.6.1</span> Estimating Trading Costs in Vietnam</h3>
<p>Transaction costs in Vietnam include explicit components (brokerage commissions, exchange fees, taxes) and implicit components (bid-ask spread, price impact). The explicit cost structure as of 2024 is approximately:</p>
<div id="tbl-weight-costs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-weight-costs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.2: Explicit transaction cost components for Vietnamese equities.
</figcaption>
<div aria-describedby="tbl-weight-costs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 35%">
<col style="width: 16%">
<col style="width: 47%">
</colgroup>
<thead>
<tr class="header">
<th>Component</th>
<th>Rate</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Brokerage commission</td>
<td>0.15‚Äì0.35%</td>
<td>Varies by broker and volume tier</td>
</tr>
<tr class="even">
<td>Exchange &amp; clearing fee</td>
<td>0.003%</td>
<td>Fixed by exchange</td>
</tr>
<tr class="odd">
<td>Selling tax</td>
<td>0.10%</td>
<td>Levied on gross sale proceeds</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The total explicit round-trip cost (buy + sell) ranges from approximately 0.30% to 0.80%. Implicit costs‚Äîthe spread and price impact‚Äîcan be substantially larger for small and illiquid stocks.</p>
<p>We model total transaction costs as a function of trade size and stock liquidity:</p>
<p><span id="eq-tc-model"><span class="math display">\[
TC_{i,t} = c_{\text{fixed}} + \frac{1}{2} \text{Spread}_{i,t} + \lambda \sqrt{\frac{|\Delta w_{i,t}| \cdot \text{AUM}}{ADV_{i,t}}}
\tag{12.8}\]</span></span></p>
<p>where <span class="math inline">\(c_{\text{fixed}} \approx 0.25\%\)</span> is the explicit cost per trade, <span class="math inline">\(\text{Spread}_{i,t}\)</span> is the quoted bid-ask spread, <span class="math inline">\(\Delta w_{i,t}\)</span> is the weight change, <span class="math inline">\(\text{AUM}\)</span> is portfolio size, <span class="math inline">\(ADV_{i,t}\)</span> is average daily volume in VND, and <span class="math inline">\(\lambda\)</span> is the price impact coefficient estimated from the <span class="citation" data-cites="amihud2002illiquidity">Amihud (<a href="references.html#ref-amihud2002illiquidity" role="doc-biblioref">2002</a>)</span> model.</p>
<div id="transaction-cost-model" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_transaction_costs(weight_changes, stock_data,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>                                aum_vnd<span class="op">=</span><span class="fl">100e9</span>, fixed_cost<span class="op">=</span><span class="fl">0.0025</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                                impact_coef<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate total transaction costs for a rebalancing event.</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    weight_changes : Series indexed by ticker, absolute weight changes</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_data : DataFrame with ticker, bid_ask_spread, turnover_value_avg_20d</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    aum_vnd : float, portfolio AUM in VND</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">    fixed_cost : float, explicit cost per unit traded (one-way)</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co">    impact_coef : float, price impact coefficient (lambda)</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">    total_cost : float, total TC as fraction of AUM</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="co">    cost_detail : DataFrame with per-stock costs</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    costs <span class="op">=</span> []</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker, dw <span class="kw">in</span> weight_changes.items():</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(dw) <span class="op">&lt;</span> <span class="fl">1e-6</span>:</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        trade_vnd <span class="op">=</span> <span class="bu">abs</span>(dw) <span class="op">*</span> aum_vnd</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Explicit cost (one-way)</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        explicit <span class="op">=</span> fixed_cost <span class="op">*</span> trade_vnd</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Spread cost</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        stock_info <span class="op">=</span> stock_data[stock_data[<span class="st">'ticker'</span>] <span class="op">==</span> ticker]</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(stock_info) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>            spread <span class="op">=</span> stock_info[<span class="st">'bid_ask_spread'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>            adv <span class="op">=</span> stock_info[<span class="st">'turnover_value_avg_20d'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>            spread <span class="op">=</span> <span class="fl">0.005</span>  <span class="co"># Default 50 bps</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>            adv <span class="op">=</span> <span class="fl">1e9</span>  <span class="co"># Default VND 1bn</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>        spread_cost <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> spread <span class="op">*</span> trade_vnd</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price impact (square root model)</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>        participation_rate <span class="op">=</span> trade_vnd <span class="op">/</span> <span class="bu">max</span>(adv, <span class="fl">1e6</span>)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>        impact_cost <span class="op">=</span> impact_coef <span class="op">*</span> np.sqrt(participation_rate) <span class="op">*</span> trade_vnd</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> explicit <span class="op">+</span> spread_cost <span class="op">+</span> impact_cost</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        costs.append({</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weight_change'</span>: dw,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">'trade_vnd'</span>: trade_vnd,</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">'explicit'</span>: explicit,</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">'spread'</span>: spread_cost,</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">'impact'</span>: impact_cost,</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total'</span>: total</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>    cost_df <span class="op">=</span> pd.DataFrame(costs)</span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>    total_cost <span class="op">=</span> cost_df[<span class="st">'total'</span>].<span class="bu">sum</span>() <span class="op">/</span> aum_vnd <span class="cf">if</span> <span class="bu">len</span>(cost_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_cost, cost_df</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="net-of-cost-performance" class="level3" data-number="12.6.2">
<h3 data-number="12.6.2" class="anchored" data-anchor-id="net-of-cost-performance"><span class="header-section-number">12.6.2</span> Net-of-Cost Performance</h3>
<p>We apply the transaction cost model to compute net-of-cost returns for each weighting scheme at different assumed AUM levels. This is critical because strategies that appear attractive in gross terms may be unimplementable at scale due to the illiquidity of small-cap Vietnamese stocks.</p>
<div id="net-returns" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_net_returns(portfolio_df, cost_per_turnover<span class="op">=</span><span class="fl">0.005</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Approximate net returns using a proportional cost model.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Net return = gross return - (turnover * cost_per_unit_turnover)</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> portfolio_df.copy()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'tc'</span>] <span class="op">=</span> df[<span class="st">'turnover'</span>] <span class="op">*</span> cost_per_turnover</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'net_return'</span>] <span class="op">=</span> df[<span class="st">'port_return'</span>] <span class="op">-</span> df[<span class="st">'tc'</span>]</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute at different cost assumptions</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>cost_scenarios <span class="op">=</span> {</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Low (25 bps)'</span>: <span class="fl">0.0025</span>,</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medium (50 bps)'</span>: <span class="fl">0.005</span>,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'High (100 bps)'</span>: <span class="fl">0.01</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annualized Net Sharpe Ratios by Cost Scenario:"</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cost_name, cost_rate <span class="kw">in</span> cost_scenarios.items():</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> {<span class="st">'Scenario'</span>: cost_name}</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> port_name, port_df <span class="kw">in</span> portfolios.items():</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        net_df <span class="op">=</span> compute_net_returns(port_df, cost_rate)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        rf_monthly <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_monthly</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        sharpe <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>        row[port_name] <span class="op">=</span> <span class="bu">round</span>(sharpe, <span class="dv">3</span>)</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>cost_name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> row.items():</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">!=</span> <span class="st">'Scenario'</span>:</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-turnover-comparison" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-turnover-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>turnover_data <span class="op">=</span> {}</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    turnover_data[name] <span class="op">=</span> df[<span class="st">'turnover'</span>].values</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>positions <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(turnover_data))</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>bp <span class="op">=</span> ax.boxplot(</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    turnover_data.values(),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    positions<span class="op">=</span>positions,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    widths<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    showfliers<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    medianprops<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'linewidth'</span>: <span class="fl">1.5</span>}</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (patch, name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(bp[<span class="st">'boxes'</span>], turnover_data.keys())):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    patch.set_facecolor(colors.get(name, <span class="st">'gray'</span>))</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    patch.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(positions)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(turnover_data.keys(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Monthly Turnover (one-way)'</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Turnover Distribution by Weighting Scheme'</span>)</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-turnover-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.4
</figcaption>
</figure>
</div>
</section>
<section id="cost-erosion-at-scale" class="level3" data-number="12.6.3">
<h3 data-number="12.6.3" class="anchored" data-anchor-id="cost-erosion-at-scale"><span class="header-section-number">12.6.3</span> Cost Erosion at Scale</h3>
<p>The relationship between portfolio AUM and implementable performance is non-linear because price impact costs grow with trade size. We simulate performance at different AUM levels:</p>
<div id="fig-aum-scaling" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="22">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-aum-scaling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>aum_levels <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]  <span class="co"># VND billions</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>selected_ports <span class="op">=</span> [<span class="st">'VW'</span>, <span class="st">'EW (Monthly)'</span>, <span class="st">'Capped VW (5%)'</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'Min Variance'</span>, <span class="st">'Risk Parity'</span>]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> selected_ports:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    sharpes <span class="op">=</span> []</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> portfolios[name]</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> aum <span class="kw">in</span> aum_levels:</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cost scales with sqrt(AUM / ADV)</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        base_cost <span class="op">=</span> <span class="fl">0.003</span>  <span class="co"># Base cost at small AUM</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        scale_factor <span class="op">=</span> np.sqrt(aum <span class="op">/</span> <span class="dv">100</span>)  <span class="co"># Normalized to VND 100bn</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        cost_rate <span class="op">=</span> base_cost <span class="op">*</span> scale_factor</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VW is less affected (large-cap tilt)</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="op">==</span> <span class="st">'VW'</span>:</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.3</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Capped'</span> <span class="kw">in</span> name:</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.5</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Min Variance'</span> <span class="kw">in</span> name <span class="kw">or</span> <span class="st">'Risk Parity'</span> <span class="kw">in</span> name:</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.7</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>        net_df <span class="op">=</span> compute_net_returns(df, cost_rate)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>        rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        sharpes.append(s)</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    ax.plot(aum_levels, sharpes, marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span>name,</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>), linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Portfolio AUM (VND Billion)'</span>)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Net Sharpe Ratio'</span>)</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Sharpe Ratio Degradation with AUM'</span>)</span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>ax.set_xscale(<span class="st">'log'</span>)</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-aum-scaling-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.5
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-weight-rebalancing" class="level2" data-number="12.7">
<h2 data-number="12.7" class="anchored" data-anchor-id="sec-weight-rebalancing"><span class="header-section-number">12.7</span> Rebalancing Frequency Analysis</h2>
<section id="the-rebalancing-trade-off" class="level3" data-number="12.7.1">
<h3 data-number="12.7.1" class="anchored" data-anchor-id="the-rebalancing-trade-off"><span class="header-section-number">12.7.1</span> The Rebalancing Trade-Off</h3>
<p>Rebalancing serves two purposes: (i) restoring target weights to maintain the desired risk profile, and (ii) harvesting the ‚Äúrebalancing bonus‚Äù‚Äîthe systematic profit from buying low and selling high that arises when weights are reset to targets in the presence of mean-reverting cross-sectional returns.</p>
<p>The trade-off is clear: more frequent rebalancing maintains tighter adherence to target weights and captures more of the rebalancing bonus, but incurs higher transaction costs. The optimal frequency depends on the magnitude of mean reversion (which determines the gross rebalancing bonus), the level of transaction costs, and the rate at which weights drift from targets.</p>
<div id="fig-rebal-frequency" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="23">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rebal-frequency-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>frequencies <span class="op">=</span> {</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Monthly'</span>: <span class="st">'M'</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Quarterly'</span>: <span class="st">'Q'</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Semi-annual'</span>: <span class="st">'Q'</span>,  <span class="co"># Approximate with every 6 months</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annual'</span>: <span class="st">'A'</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Recompute EW at each frequency</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>freq_results <span class="op">=</span> {}</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> freq_name, freq_code <span class="kw">in</span> frequencies.items():</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    freq_df <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        universe_mid, ew_weights, rebal_freq<span class="op">=</span>freq_code</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    freq_results[freq_name] <span class="op">=</span> freq_df</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Gross vs Net Sharpe</span></span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>freq_names <span class="op">=</span> <span class="bu">list</span>(freq_results.keys())</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>gross_sharpes <span class="op">=</span> []</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>net_sharpes <span class="op">=</span> []</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> freq_names:</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> freq_results[fn]</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    exc <span class="op">=</span> df[<span class="st">'port_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>    gross_sharpes.append(exc.mean() <span class="op">/</span> exc.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    net_df <span class="op">=</span> compute_net_returns(df, <span class="fl">0.005</span>)</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    exc_net <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>    net_sharpes.append(exc_net.mean() <span class="op">/</span> exc_net.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(freq_names))</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].bar([i <span class="op">-</span> <span class="fl">0.15</span> <span class="cf">for</span> i <span class="kw">in</span> x], gross_sharpes, width<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Gross'</span>)</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].bar([i <span class="op">+</span> <span class="fl">0.15</span> <span class="cf">for</span> i <span class="kw">in</span> x], net_sharpes, width<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Net (50 bps)'</span>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(x)</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels(freq_names)</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Annualized Sharpe Ratio'</span>)</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Sharpe Ratio by Rebalancing Frequency'</span>)</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Average turnover</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>turnovers <span class="op">=</span> [freq_results[fn][<span class="st">'turnover'</span>].mean() <span class="cf">for</span> fn <span class="kw">in</span> freq_names]</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x, turnovers, color<span class="op">=</span><span class="st">'#E67E22'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(x)</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels(freq_names)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Average Monthly Turnover'</span>)</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Turnover by Rebalancing Frequency'</span>)</span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rebal-frequency-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.6
</figcaption>
</figure>
</div>
</section>
<section id="threshold-based-rebalancing" class="level3" data-number="12.7.2">
<h3 data-number="12.7.2" class="anchored" data-anchor-id="threshold-based-rebalancing"><span class="header-section-number">12.7.2</span> Threshold-Based Rebalancing</h3>
<p>An alternative to calendar-based rebalancing is to rebalance only when portfolio weights drift beyond a tolerance band. This ‚Äúno-trade zone‚Äù approach is motivated by <span class="citation" data-cites="garleanu2013dynamic">G√¢rleanu and Pedersen (<a href="references.html#ref-garleanu2013dynamic" role="doc-biblioref">2013</a>)</span>, who derive the optimal dynamic trading strategy under quadratic transaction costs and show that the optimal portfolio is a weighted average of the current holdings and the frictionless target.</p>
<div id="threshold-rebalancing" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_threshold_rebalanced(monthly_df, weight_fn,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                                  threshold<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Rebalance only when maximum weight deviation exceeds threshold.</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    threshold : float</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Rebalance when max(|w_actual - w_target|) &gt; threshold.</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(monthly_df[<span class="st">'month_end'</span>].unique())</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    current_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    rebalance_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>        cs <span class="op">=</span> monthly_df[monthly_df[<span class="st">'month_end'</span>] <span class="op">==</span> month].copy()</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>        cs <span class="op">=</span> cs.dropna(subset<span class="op">=</span>[<span class="st">'monthly_return'</span>]).set_index(<span class="st">'ticker'</span>)</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cs) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> weight_fn(cs.reset_index())</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> target <span class="op">/</span> target.<span class="bu">sum</span>()</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_weights <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> target.copy()</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>            rebalance_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift weights</span></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> current_weights.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> current_weights <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> cs[<span class="st">'monthly_return'</span>])</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>            total <span class="op">=</span> current_weights.<span class="bu">sum</span>()</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> current_weights <span class="op">/</span> total</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if rebalancing needed</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>            max_dev <span class="op">=</span> (current_weights <span class="op">-</span> target.reindex(</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>                current_weights.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            )).<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> max_dev <span class="op">&gt;</span> threshold:</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>                turnover <span class="op">=</span> (current_weights <span class="op">-</span> target.reindex(</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>                    current_weights.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>                )).<span class="bu">abs</span>().<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> target.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> current_weights <span class="op">/</span> current_weights.<span class="bu">sum</span>()</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                rebalance_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>                turnover <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>        port_ret <span class="op">=</span> (current_weights.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>                    cs[<span class="st">'monthly_return'</span>]).<span class="bu">sum</span>()</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>        hhi <span class="op">=</span> (current_weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month,</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">'port_return'</span>: port_ret,</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            <span class="st">'turnover'</span>: turnover,</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hhi'</span>: hhi,</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>            <span class="st">'effective_n'</span>: <span class="dv">1</span><span class="op">/</span>hhi <span class="cf">if</span> hhi <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_stocks'</span>: (current_weights <span class="op">&gt;</span> <span class="fl">1e-6</span>).<span class="bu">sum</span>()</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Threshold </span><span class="sc">{</span>threshold<span class="sc">:.1%}</span><span class="ss">: rebalanced </span><span class="sc">{</span>rebalance_count<span class="sc">}</span><span class="ss"> / "</span></span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span>rebalance_count<span class="op">/</span><span class="bu">len</span>(results)<span class="sc">:.0%}</span><span class="ss">)"</span>)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Test different thresholds</span></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> [<span class="fl">0.005</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>]</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>threshold_results <span class="op">=</span> {}</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> thresholds:</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    threshold_results[<span class="ss">f'</span><span class="sc">{</span>t<span class="sc">:.1%}</span><span class="ss">'</span>] <span class="op">=</span> compute_threshold_rebalanced(</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>        universe_mid, ew_weights, threshold<span class="op">=</span>t</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-weight-rebalancing-bonus" class="level2" data-number="12.8">
<h2 data-number="12.8" class="anchored" data-anchor-id="sec-weight-rebalancing-bonus"><span class="header-section-number">12.8</span> The Rebalancing Bonus: Decomposition</h2>
<p>The excess return of the rebalanced EW portfolio over a buy-and-hold EW portfolio (which starts equal-weighted but drifts) can be decomposed following <span class="citation" data-cites="plyakha2021equal">Plyakha, Uppal, and Vilkov (<a href="references.html#ref-plyakha2021equal" role="doc-biblioref">2021</a>)</span>. Define <span class="math inline">\(r_i\)</span> as the return of stock <span class="math inline">\(i\)</span> over one period:</p>
<p><span id="eq-rebal-bonus"><span class="math display">\[
R^{EW}_{\text{rebal}} - R^{EW}_{\text{drift}} \approx \frac{1}{2N} \sum_{i=1}^N \text{Var}(r_i) - \frac{1}{2N^2}\sum_{i}\sum_{j}\text{Cov}(r_i, r_j)
\tag{12.9}\]</span></span></p>
<p>The first term captures the ‚Äúbuy low, sell high‚Äù effect from resetting weights after return dispersion. The second term is the cost of undoing covariance-induced drift. The rebalancing bonus is larger when cross-sectional return dispersion is high (which it is in Vietnam) and when pairwise correlations are low.</p>
<div id="rebalancing-bonus" class="cell" data-execution_count="25">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute buy-and-hold EW portfolio (no rebalancing after initial equal weight)</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>bh_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'A'</span>  <span class="co"># Rebalance once per year only</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co"># The rebalancing bonus is the difference</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>bonus_df <span class="op">=</span> pd.merge(</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    ew_monthly[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]].rename(</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'port_return'</span>: <span class="st">'rebal_return'</span>}),</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    bh_returns[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]].rename(</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'port_return'</span>: <span class="st">'bh_return'</span>}),</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>bonus_df[<span class="st">'bonus'</span>] <span class="op">=</span> bonus_df[<span class="st">'rebal_return'</span>] <span class="op">-</span> bonus_df[<span class="st">'bh_return'</span>]</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional return dispersion</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>dispersion <span class="op">=</span> (</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    universe_mid</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'cs_dispersion'</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>bonus_df <span class="op">=</span> bonus_df.merge(dispersion, on<span class="op">=</span><span class="st">'month_end'</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a>ann_bonus <span class="op">=</span> bonus_df[<span class="st">'bonus'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Annualized rebalancing bonus (EW monthly vs annual): </span><span class="sc">{</span>ann_bonus<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean cross-sectional dispersion: </span><span class="sc">{</span>bonus_df[<span class="st">'cs_dispersion'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-rebal-bonus-time" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="26">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rebal-bonus-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>ax1.bar(pd.to_datetime(bonus_df[<span class="st">'month_end'</span>]),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>        bonus_df[<span class="st">'bonus'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, width<span class="op">=</span><span class="dv">25</span>, label<span class="op">=</span><span class="st">'Rebal. Bonus'</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Rebalancing Bonus (%)'</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>ax2.plot(pd.to_datetime(bonus_df[<span class="st">'month_end'</span>]),</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>         bonus_df[<span class="st">'cs_dispersion'</span>],</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'CS Dispersion'</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Cross-Sectional Return Dispersion'</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Rebalancing Bonus and Return Dispersion'</span>)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>lines1, labels1 <span class="op">=</span> ax1.get_legend_handles_labels()</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>lines2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>ax1.legend(lines1 <span class="op">+</span> lines2, labels1 <span class="op">+</span> labels2, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rebal-bonus-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.7
</figcaption>
</figure>
</div>
</section>
<section id="sec-weight-factor-exposure" class="level2" data-number="12.9">
<h2 data-number="12.9" class="anchored" data-anchor-id="sec-weight-factor-exposure"><span class="header-section-number">12.9</span> Factor Exposure Analysis</h2>
<p>Different weighting schemes induce different factor exposures, which may explain their return differences. We regress each portfolio‚Äôs excess returns on the Vietnamese Fama-French factors:</p>
<p><span id="eq-factor-regression"><span class="math display">\[
R_{p,t} - R_{f,t} = \alpha_p + \beta_p^{MKT}(R_{m,t} - R_{f,t}) + \beta_p^{SMB} \text{SMB}_t + \beta_p^{HML} \text{HML}_t + \varepsilon_{p,t}
\tag{12.10}\]</span></span></p>
<div id="factor-regressions" class="cell" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve Vietnamese factor returns from DataCore</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>]</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run factor regressions for each portfolio</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>factor_results <span class="op">=</span> {}</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.merge(</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>        df[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]],</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>        factors,</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'excess'</span>] <span class="op">=</span> merged[<span class="st">'port_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'excess'</span>],</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(merged[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>]])</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>})</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>    factor_results[name] <span class="op">=</span> {</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alpha (ann.)'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alpha t-stat'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MKT'</span>: model.params[<span class="st">'mkt_excess'</span>],</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'SMB'</span>: model.params[<span class="st">'smb'</span>],</span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'HML'</span>: model.params[<span class="st">'hml'</span>],</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WML'</span>: model.params[<span class="st">'wml'</span>],</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">'R¬≤'</span>: model.rsquared</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>factor_df <span class="op">=</span> pd.DataFrame(factor_results).T</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-factor-exposures" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="28">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-factor-exposures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> factor_df[[<span class="st">'MKT'</span>, <span class="st">'SMB'</span>, <span class="st">'HML'</span>, <span class="st">'WML'</span>]].copy()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(plot_data.values, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>               vmin<span class="op">=-</span><span class="fl">1.5</span>, vmax<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(plot_data.columns)))</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(plot_data.columns, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(plot_data.index)))</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(plot_data.index, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text annotations</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(plot_data.index)):</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(plot_data.columns)):</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> plot_data.values[i, j]</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="st">'white'</span> <span class="cf">if</span> <span class="bu">abs</span>(val) <span class="op">&gt;</span> <span class="fl">0.8</span> <span class="cf">else</span> <span class="st">'black'</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>        ax.text(j, i, <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Factor Loading'</span>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Factor Exposures by Weighting Scheme'</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-factor-exposures-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;12.8
</figcaption>
</figure>
</div>
</section>
<section id="sec-weight-practical" class="level2" data-number="12.10">
<h2 data-number="12.10" class="anchored" data-anchor-id="sec-weight-practical"><span class="header-section-number">12.10</span> Practical Guidance for Vietnam</h2>
<p>The preceding analysis yields several practical recommendations for researchers and investors working with Vietnamese equities:</p>
<p><strong>For academic factor research:</strong> VW portfolios remain the default for asset pricing tests because they represent the investable opportunity set and avoid inflating alpha estimates with small-cap illiquidity premia. When EW portfolios are used (e.g., to give equal influence to each stock in cross-sectional sorts), researchers should report both VW and EW results and discuss the sensitivity. <span class="citation" data-cites="fama2008dissecting">Fama and French (<a href="references.html#ref-fama2008dissecting" role="doc-biblioref">2008</a>)</span> follow this practice systematically.</p>
<p><strong>For fund management:</strong> The choice depends on AUM and mandate. At AUM below VND 500 billion, capped VW or fundamental weighting offers a practical compromise between diversification and implementability. At larger AUM, pure VW or sector-capped VW is more realistic. Risk parity and minimum variance are suitable for low-volatility mandates but require robust covariance estimation and quarterly rebalancing.</p>
<p><strong>For index construction:</strong> Vietnamese index providers (VN30, VNINDEX) use variants of capped VW. The analysis suggests that the cap level significantly affects the index‚Äôs diversification properties and tracking error relative to the uncapped VW market. A 10% cap balances concentration reduction against turnover.</p>
<p><strong>For transaction cost management:</strong> In all schemes, the marginal benefit of rebalancing declines faster than the marginal cost as frequency increases beyond quarterly. Calendar-based quarterly rebalancing or threshold-based rebalancing (with a 1‚Äì2% tolerance band) provides the best cost-benefit trade-off in the Vietnamese market.</p>
</section>
<section id="sec-weight-summary" class="level2" data-number="12.11">
<h2 data-number="12.11" class="anchored" data-anchor-id="sec-weight-summary"><span class="header-section-number">12.11</span> Summary</h2>
<div id="tbl-weight-final-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-weight-final-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;12.3: Summary comparison of weighting schemes for Vietnamese equities.
</figcaption>
<div aria-describedby="tbl-weight-final-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th>Dimension</th>
<th>VW</th>
<th>EW</th>
<th>Capped VW</th>
<th>Fundamental</th>
<th>Min Var</th>
<th>Risk Parity</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Turnover</td>
<td>Very low</td>
<td>High</td>
<td>Low</td>
<td>Low</td>
<td>Moderate</td>
<td>Moderate</td>
</tr>
<tr class="even">
<td>Concentration</td>
<td>High</td>
<td>None</td>
<td>Moderate</td>
<td>Moderate</td>
<td>Variable</td>
<td>Low</td>
</tr>
<tr class="odd">
<td>Size tilt</td>
<td>Large</td>
<td>Small</td>
<td>Moderate</td>
<td>Large-mid</td>
<td>Low-vol</td>
<td>Mixed</td>
</tr>
<tr class="even">
<td>Data required</td>
<td>Prices</td>
<td>None</td>
<td>Prices</td>
<td>Accounting</td>
<td>Returns cov.</td>
<td>Returns cov.</td>
</tr>
<tr class="odd">
<td>Scale sensitivity</td>
<td>Low</td>
<td>High</td>
<td>Low</td>
<td>Low</td>
<td>Moderate</td>
<td>Moderate</td>
</tr>
<tr class="even">
<td>Rebal. frequency</td>
<td>Passive</td>
<td>Monthly</td>
<td>Monthly/Quarterly</td>
<td>Annual</td>
<td>Quarterly</td>
<td>Quarterly</td>
</tr>
<tr class="odd">
<td>Best use case</td>
<td>Benchmarks, large AUM</td>
<td>Cross-sectional tests</td>
<td>Index tracking</td>
<td>Long-term investing</td>
<td>Low-vol mandates</td>
<td>Balanced risk</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The choice of weighting scheme is not merely a technical detail‚Äîit reflects a substantive economic decision about the relative importance of diversification, investability, and cost control. In the Vietnamese market, where the capitalization distribution is highly skewed and small-cap liquidity is thin, this choice has larger consequences than in developed markets. Researchers who report results under only one weighting scheme risk conclusions that are specific to that scheme rather than reflective of a genuine economic relationship.</p>
<!-- ## Exercises {#sec-weight-exercises}

1. **Inverse volatility weighting.** Implement a weighting scheme where $w_i \propto 1/\sigma_i$ (inverse of trailing 60-day volatility). Compare its performance to equal-weight and risk parity. How does it differ from minimum variance?

2. **Turnover-constrained optimization.** Modify the minimum variance portfolio to include a turnover constraint: $\sum_i |w_i - w_{i,\text{prev}}| \leq \tau$ for a given turnover budget $\tau$. Solve this as a quadratic program with linear constraints. How does the frontier of risk vs. turnover look?

3. **Liquidity-weighted portfolios.** Construct a portfolio where weights are proportional to average daily turnover rather than market cap. What economic interpretation does this portfolio have? How does it compare to VW in terms of factor exposures?

4. **VN30 replication.** The VN30 index comprises the 30 largest and most liquid stocks on HOSE with a 10% cap. Replicate its construction rules using DataCore.vn data and compare the tracking error of your replication against the official VN30 index.

5. **Conditional rebalancing bonus.** Estimate the rebalancing bonus separately in bull markets (VN-Index return > 0) and bear markets (VN-Index return < 0). Is the bonus pro-cyclical or counter-cyclical? Relate your findings to the cross-sectional dispersion pattern in @fig-rebal-bonus-time.

6. **Covariance estimation comparison.** Compare the out-of-sample performance of minimum variance portfolios using: (a) sample covariance, (b) Ledoit-Wolf linear shrinkage, (c) nonlinear shrinkage [@ledoit2017nonlinear], and (d) a single-factor covariance model. Which estimator produces the lowest realized portfolio variance?

7. **Price limit effects on rebalancing.** Vietnamese stocks face daily price limits ($\pm$ 7% HOSE, $\pm$ 10% HNX). Simulate the impact of price limits on rebalancing execution: when a stock hits limit-up or limit-down, the rebalancing trade cannot execute. How does this partial execution affect realized portfolio weights and performance?

8. **Foreign ownership constraints.** Many Vietnamese sectors have foreign ownership limits (e.g., 49% for most industries, 30% for banking). Incorporate these constraints into the optimization-based weighting schemes. How do binding foreign ownership limits affect the achievable Sharpe ratio for foreign investors? -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-amihud2002illiquidity" class="csl-entry" role="listitem">
Amihud, Yakov. 2002. <span>‚ÄúIlliquidity and Stock Returns: Cross-Section and Time-Series Effects.‚Äù</span> <em>Journal of Financial Markets</em> 5 (1): 31‚Äì56.
</div>
<div id="ref-arnott2005fundamental" class="csl-entry" role="listitem">
Arnott, Robert D, Jason Hsu, and Philip Moore. 2005. <span>‚ÄúFundamental Indexation.‚Äù</span> <em>Financial Analysts Journal</em> 61 (2): 83‚Äì99.
</div>
<div id="ref-choueifaty2008towards" class="csl-entry" role="listitem">
Choueifaty, Yves. 2008. <span>‚ÄúTowards Maximum Diversification.‚Äù</span> <em>Available at SSRN 4063676</em>.
</div>
<div id="ref-clarke2011minimum" class="csl-entry" role="listitem">
Clarke, Roger, Harindra De Silva, and Steven Thorley. 2011. <span>‚ÄúMinimum-Variance Portfolio Composition.‚Äù</span> <em>Journal of Portfolio Management</em> 37 (2): 31.
</div>
<div id="ref-demiguel2009optimal" class="csl-entry" role="listitem">
DeMiguel, Victor, Lorenzo Garlappi, and Raman Uppal. 2009. <span>‚ÄúOptimal Versus Naive Diversification: How Inefficient Is the 1/n Portfolio Strategy?‚Äù</span> <em>The Review of Financial Studies</em> 22 (5): 1915‚Äì53.
</div>
<div id="ref-fama2008dissecting" class="csl-entry" role="listitem">
Fama, Eugene F, and Kenneth R French. 2008. <span>‚ÄúDissecting Anomalies.‚Äù</span> <em>The Journal of Finance</em> 63 (4): 1653‚Äì78.
</div>
<div id="ref-garleanu2013dynamic" class="csl-entry" role="listitem">
G√¢rleanu, Nicolae, and Lasse Heje Pedersen. 2013. <span>‚ÄúDynamic Trading with Predictable Returns and Transaction Costs.‚Äù</span> <em>The Journal of Finance</em> 68 (6): 2309‚Äì40.
</div>
<div id="ref-hsu2004cap" class="csl-entry" role="listitem">
Hsu, Jason C. 2004. <span>‚ÄúCap-Weighted Portfolios Are Sub-Optimal Portfolios.‚Äù</span> <em>Journal of Investment Management</em> 4 (3).
</div>
<div id="ref-jagannathan2003risk" class="csl-entry" role="listitem">
Jagannathan, Ravi, and Tongshu Ma. 2003. <span>‚ÄúRisk Reduction in Large Portfolios: Why Imposing the Wrong Constraints Helps.‚Äù</span> <em>The Journal of Finance</em> 58 (4): 1651‚Äì83.
</div>
<div id="ref-ledoit2004well" class="csl-entry" role="listitem">
Ledoit, Olivier, and Michael Wolf. 2004. <span>‚ÄúA Well-Conditioned Estimator for Large-Dimensional Covariance Matrices.‚Äù</span> <em>Journal of Multivariate Analysis</em> 88 (2): 365‚Äì411.
</div>
<div id="ref-maillard2010properties" class="csl-entry" role="listitem">
Maillard, S√©bastien, Thierry Roncalli, and J√©r√¥me Teƒ±Ãàletche. 2010. <span>‚ÄúThe Properties of Equally Weighted Risk Contribution Portfolios.‚Äù</span> <em>Journal of Portfolio Management</em> 36 (4): 60.
</div>
<div id="ref-plyakha2021equal" class="csl-entry" role="listitem">
Plyakha, Yuliya, Raman Uppal, and Grigory Vilkov. 2021. <span>‚ÄúEqual or Value Weighting? Implications for Asset-Pricing Tests.‚Äù</span> In <em>Financial Risk Management and Modeling</em>, 295‚Äì347. Springer.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "¬© " + year;
});
</script>
<!-- Google tag (gtag.js) -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-LG91D0C6RB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-LG91D0C6RB');
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mikenguyen13\.github\.io\/tidy_finance_vn_vi\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./13_value_bivariate.html" class="pagination-link" aria-label="Value and Bivariate Sorts">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./15_missing_data_and_survivorship.html" class="pagination-link" aria-label="Missing Data and Survivorship Bias">
        <span class="nav-page-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Portfolio Weighting and Rebalancing</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>In this chapter, we systematically compare portfolio weighting schemes (e.g., value-weighted, equal-weighted, and several risk-based alternativesin the Vietnamese equity market. We quantify the impact of rebalancing frequency and transaction costs on realized performance, and develop practical tools for constructing implementable portfolios under the frictions characteristic of an emerging market.</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>Every portfolio construction decision ultimately reduces to two choices: which assets to hold, and how much to allocate to each. While earlier chapters have focused on the first question, using factor models, anomalies, and fundamental analysis to select stocks, this chapter addresses the second. The weighting scheme a researcher or investor applies can fundamentally alter the conclusions drawn from portfolio-level tests and the returns earned from an investment strategy.</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>The distinction matters more in Vietnam than in large, liquid markets. The Vietnamese equity market features extreme skewness in the market capitalization distribution: the top 10 firms on HOSE account for roughly 50% of total market capitalization, while hundreds of small firms contribute negligible weight. Under value-weighting, a portfolio's performance is dominated by a handful of large-cap names (Vinhomes, Vingroup, Vietcombank, FPT). Under equal-weighting, every firm contributes equally, tilting the portfolio toward small, illiquid stocks that may be expensive or impossible to trade at scale. Neither scheme is inherently correct; the choice depends on the question being asked.</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>This chapter develops the analytical framework for making that choice. We begin with the theoretical properties of weighting schemes, implement each scheme in practice with Vietnamese data, quantify the transaction costs of rebalancing, and extend the analysis to risk-based alternatives that explicitly incorporate the covariance structure of returns.</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Theoretical Framework {#sec-weight-theory}</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### Value-Weighted Portfolios</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>A value-weighted (VW) portfolio allocates to each stock in proportion to its market capitalization:</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>w_{i,t}^{VW} = \frac{\text{MCap}_{i,t}}{\sum_{j=1}^{N_t} \text{MCap}_{j,t}}</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>$$ {#eq-vw}</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>where $\text{MCap}_{i,t} = P_{i,t} \times \text{Shares}_{i,t}$ is the market capitalization of stock $i$ at time $t$.</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>The VW portfolio has a unique theoretical status: it is the portfolio that all investors collectively hold (the "market portfolio" in CAPM). Its key properties are:</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Self-rebalancing.** As prices move, weights adjust automatically. A VW portfolio requires trading only when constituents enter or leave the index, or when corporate actions (splits, issuances) change shares outstanding.</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Low turnover.** Because weights drift with prices rather than being reset to targets, VW portfolios have minimal rebalancing costs.</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Large-cap bias.** Returns are dominated by the largest firms. In Vietnam, this means the portfolio's risk-return profile is heavily influenced by banking, real estate, and technology conglomerates.</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>@hsu2004cap argues that VW portfolios are sub-optimal because they mechanically overweight overpriced stocks and underweight underpriced stocks (i.e., any deviation of price from fundamental value creates a systematic drag on VW performance relative to a fundamentally weighted alternative).</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="fu">### Equal-Weighted Portfolios</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>An equal-weighted (EW) portfolio assigns the same weight to each constituent:</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>w_{i,t}^{EW} = \frac{1}{N_t}</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ew}</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>@demiguel2009optimal show that the 1/N portfolio is surprisingly competitive with mean-variance optimized portfolios, particularly when estimation windows are short and the number of assets is large (conditions that closely describe the Vietnamese market). The intuition is that estimation error in expected returns and covariances can overwhelm the gains from optimization, making the "naive" equal-weight scheme a robust default.</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>@plyakha2021equal decompose the EW outperformance over VW into two components:</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Size tilt.** EW allocates more to small firms, which historically earn a size premium.</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Rebalancing bonus.** Monthly rebalancing back to equal weights is a contrarian strategy: it sells recent winners and buys recent losers, profiting from mean reversion in individual stock returns.</span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- 3.  **Diversification.** EW provides lower concentration and higher effective diversification. --&gt;</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>However, the EW portfolio has practical disadvantages that are particularly severe in Vietnam:</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**High turnover.** Every rebalancing date requires trading every stock back to equal weight.</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Illiquidity exposure.** Equal weighting of micro-cap stocks that trade VND 100 million/day alongside large-caps trading VND 500 billion/day creates severe implementation challenges.</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Price impact.** In a market with daily price limits ($\pm$ 7% on HOSE, $\pm$ 10% on HNX), rebalancing trades for illiquid names may hit limit-up or limit-down, preventing full execution.</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Weighting Spectrum</span></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>Between VW and EW lies a continuum of weighting schemes. @tbl-weight-schemes summarizes the major alternatives.</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Scheme <span class="pp">|</span> Weight Formula <span class="pp">|</span> Key Property <span class="pp">|</span> Key Risk <span class="pp">|</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|------------------|------------------|------------------|</span></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Value-weighted <span class="pp">|</span> $w_i \propto \text{MCap}_i$ <span class="pp">|</span> Self-rebalancing, low turnover <span class="pp">|</span> Large-cap concentration <span class="pp">|</span></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Equal-weighted <span class="pp">|</span> $w_i = 1/N$ <span class="pp">|</span> Maximum naive diversification <span class="pp">|</span> High turnover, illiquidity <span class="pp">|</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fundamental <span class="pp">|</span> $w_i \propto F_i$ (revenue, book equity, etc.) <span class="pp">|</span> Breaks price-value link <span class="pp">|</span> Requires accounting data <span class="pp">|</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Minimum variance <span class="pp">|</span> $\mathbf{w} = \arg\min \mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}$ <span class="pp">|</span> Lowest portfolio volatility <span class="pp">|</span> Estimation error in $\boldsymbol{\Sigma}$ <span class="pp">|</span></span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Risk parity <span class="pp">|</span> $w_i \sigma_i = w_j \sigma_j \; \forall \, i,j$ <span class="pp">|</span> Equal risk contribution <span class="pp">|</span> Leverages low-vol assets <span class="pp">|</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Maximum diversification <span class="pp">|</span> $\max \frac{\mathbf{w}'\boldsymbol{\sigma}}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}$ <span class="pp">|</span> Maximizes diversification ratio <span class="pp">|</span> Sensitive to correlation estimates <span class="pp">|</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Capped VW <span class="pp">|</span> $w_i \propto \text{MCap}_i$, $w_i \leq \bar{w}$ <span class="pp">|</span> Reduces concentration <span class="pp">|</span> Arbitrary cap threshold <span class="pp">|</span></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>: Summary of portfolio weighting schemes. {#tbl-weight-schemes}</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Construction {#sec-weight-data}</span></span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure environment"</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb28-83"><a href="#cb28-83" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize</span>
<span id="cb28-84"><a href="#cb28-84" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.covariance <span class="im">import</span> LedoitWolf</span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-load</span></span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load market and fundamental data"</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily prices and volume</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a>daily <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb28-112"><a href="#cb28-112" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb28-113"><a href="#cb28-113" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>,</span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">'turnover_value'</span>, <span class="st">'market_cap'</span>, <span class="st">'shares_outstanding'</span>,</span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">'bid_ask_spread'</span>, <span class="st">'free_float_pct'</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (pre-computed for convenience)</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span></span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Fundamentals for fundamental weighting</span></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a>fundamentals <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'revenue'</span>, <span class="st">'book_equity'</span>,</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_assets'</span>, <span class="st">'dividends_paid'</span>, <span class="st">'operating_cash_flow'</span></span>
<span id="cb28-140"><a href="#cb28-140" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-141"><a href="#cb28-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Market-level returns for benchmarking</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a>market_index <span class="op">=</span> client.get_index(</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">'VNINDEX'</span>,</span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'monthly'</span></span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span>daily<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly observations: </span><span class="sc">{</span>monthly<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique tickers: </span><span class="sc">{</span>monthly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a><span class="fu">### Universe Construction and Liquidity Filters</span></span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>A critical pre-processing step is defining the investable universe. Including all listed stocks, regardless of liquidity, inflates the apparent benefits of equal-weighting and other small-cap-tilted schemes because it implicitly assumes the ability to trade illiquid stocks without friction. We apply graduated liquidity filters and track how results change.</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a><span class="co"># | label: universe-construction</span></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a><span class="co"># | eval: false</span></span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a><span class="co"># | code-summary: "Apply liquidity filters to define investable universes"</span></span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_universe(monthly_df, min_mcap_pct<span class="op">=</span><span class="dv">0</span>, min_turnover<span class="op">=</span><span class="dv">0</span>, min_months<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct investable universe with liquidity filters.</span></span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a><span class="co">    min_mcap_pct : float</span></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a><span class="co">        Exclude stocks below this market cap percentile (0-100).</span></span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a><span class="co">    min_turnover : float</span></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum average daily turnover in VND billion.</span></span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a><span class="co">    min_months : int</span></span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum months of return history required.</span></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> monthly_df.copy()</span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Market cap percentile filter (within each month)</span></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> min_mcap_pct <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">"mcap_pctile"</span>] <span class="op">=</span> df.groupby(<span class="st">"month_end"</span>)[<span class="st">"market_cap"</span>].transform(</span>
<span id="cb28-184"><a href="#cb28-184" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> x: x.rank(pct<span class="op">=</span><span class="va">True</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-185"><a href="#cb28-185" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"mcap_pctile"</span>] <span class="op">&gt;=</span> min_mcap_pct]</span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Turnover filter</span></span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> min_turnover <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df[df[<span class="st">"turnover_value_avg_20d"</span>] <span class="op">&gt;=</span> min_turnover <span class="op">*</span> <span class="fl">1e9</span>]</span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>    <span class="co"># History filter</span></span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>    ticker_months <span class="op">=</span> df.groupby(<span class="st">"ticker"</span>)[<span class="st">"month_end"</span>].transform(<span class="st">"count"</span>)</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[ticker_months <span class="op">&gt;=</span> min_months]</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Define three universes of increasing restrictiveness</span></span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>universe_all <span class="op">=</span> construct_universe(monthly)</span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a>universe_mid <span class="op">=</span> construct_universe(monthly, min_mcap_pct<span class="op">=</span><span class="dv">20</span>, min_turnover<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>universe_liquid <span class="op">=</span> construct_universe(monthly, min_mcap_pct<span class="op">=</span><span class="dv">40</span>, min_turnover<span class="op">=</span><span class="fl">2.0</span>)</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, univ <span class="kw">in</span> [</span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"All stocks"</span>, universe_all),</span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Mid filter"</span>, universe_mid),</span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Liquid only"</span>, universe_liquid),</span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>    n_stocks <span class="op">=</span> univ.groupby(<span class="st">"month_end"</span>)[<span class="st">"ticker"</span>].nunique().median()</span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: median </span><span class="sc">{</span>n_stocks<span class="sc">:.0f}</span><span class="ss"> stocks/month"</span>)</span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a><span class="fu">### Market Capitalization Concentration</span></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a>Before comparing weighting schemes, it is instructive to document how concentrated the Vietnamese market actually is.</span>
<span id="cb28-216"><a href="#cb28-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-concentration</span></span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Market capitalization concentration on HOSE and HNX. Panel A shows the cumulative market cap share of stocks ranked by size. Panel B shows the Herfindahl-Hirschman Index (HHI) of VW portfolio weights over time. The Vietnamese market is highly concentrated: the top 10 stocks account for approximately 40‚Äì50% of total capitalization."</span></span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize market cap concentration"</span></span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Cumulative market cap share (latest month)</span></span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> monthly[monthly[<span class="st">'month_end'</span>] <span class="op">==</span> monthly[<span class="st">'month_end'</span>].<span class="bu">max</span>()].copy()</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>latest <span class="op">=</span> latest.sort_values(<span class="st">'market_cap'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'cum_mcap_share'</span>] <span class="op">=</span> (</span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>    latest[<span class="st">'market_cap'</span>].cumsum() <span class="op">/</span> latest[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'rank'</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(latest) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>latest[<span class="st">'rank_pct'</span>] <span class="op">=</span> latest[<span class="st">'rank'</span>] <span class="op">/</span> <span class="bu">len</span>(latest) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(latest[<span class="st">'rank_pct'</span>], latest[<span class="st">'cum_mcap_share'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">50</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">80</span>, color<span class="op">=</span><span class="st">'gray'</span>, linestyle<span class="op">=</span><span class="st">'--'</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Mark top 10 and top 30</span></span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>n_at_50 <span class="op">=</span> (latest[<span class="st">'cum_mcap_share'</span>] <span class="op">&lt;=</span> <span class="fl">0.50</span>).<span class="bu">sum</span>()</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].annotate(<span class="ss">f'Top </span><span class="sc">{</span>n_at_50<span class="sc">}</span><span class="ss"> stocks = 50%'</span>,</span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>                 xy<span class="op">=</span>(n_at_50 <span class="op">/</span> <span class="bu">len</span>(latest) <span class="op">*</span> <span class="dv">100</span>, <span class="dv">50</span>),</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">9</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>)</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Cumulative Stock Rank (%)'</span>)</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Cumulative Market Cap Share (%)'</span>)</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Market Cap Concentration Curve'</span>)</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: HHI over time</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>hhi_ts <span class="op">=</span> (</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>    monthly</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'month_end'</span>)</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: (g[<span class="st">'market_cap'</span>] <span class="op">/</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()).<span class="bu">pow</span>(<span class="dv">2</span>).<span class="bu">sum</span>())</span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'hhi'</span>)</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a>hhi_ts[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(hhi_ts[<span class="st">'month_end'</span>])</span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(hhi_ts[<span class="st">'month_end'</span>], hhi_ts[<span class="st">'hhi'</span>] <span class="op">*</span> <span class="dv">10000</span>,</span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'HHI (basis points)'</span>)</span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Herfindahl Index of VW Weights'</span>)</span>
<span id="cb28-262"><a href="#cb28-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-263"><a href="#cb28-263" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a><span class="fu">## Implementing Weighting Schemes {#sec-weight-implementation}</span></span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>We now implement each weighting scheme and compute monthly portfolio returns. All implementations follow a common structure: at each rebalancing date, compute target weights from available information, then compute the weighted return over the subsequent holding period.</span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a><span class="fu">### Core Portfolio Engine</span></span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: portfolio-engine</span></span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Generic portfolio construction and backtesting engine"</span></span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>    monthly_df,</span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>    weight_fn,</span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>    rebal_freq<span class="op">=</span><span class="st">"M"</span>,</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>    max_weight<span class="op">=</span><span class="fl">1.0</span>,</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>    min_weight<span class="op">=</span><span class="fl">0.0</span>,</span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute time series of portfolio returns for a given weighting function.</span></span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame</span></span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a><span class="co">        Must contain 'ticker', 'month_end', 'monthly_return', and any</span></span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a><span class="co">        columns needed by weight_fn.</span></span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a><span class="co">    weight_fn : callable</span></span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a><span class="co">        Function that takes a cross-section DataFrame and returns a</span></span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a><span class="co">        Series of weights indexed by ticker. Weights need not sum to 1</span></span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a><span class="co">        (they will be normalized).</span></span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a><span class="co">    rebal_freq : str</span></span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a><span class="co">        'M' for monthly, 'Q' for quarterly, 'A' for annual.</span></span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a><span class="co">    max_weight : float</span></span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a><span class="co">        Maximum weight per stock (for capped schemes).</span></span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a><span class="co">    min_weight : float</span></span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a><span class="co">        Minimum weight per stock.</span></span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with columns: month_end, port_return, n_stocks,</span></span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a><span class="co">    turnover, hhi, effective_n</span></span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(monthly_df[<span class="st">"month_end"</span>].unique())</span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine rebalancing dates</span></span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rebal_freq <span class="op">==</span> <span class="st">"M"</span>:</span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(months)</span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebal_freq <span class="op">==</span> <span class="st">"Q"</span>:</span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(pd.to_datetime(months).to_period(<span class="st">"Q"</span>).to_timestamp(<span class="st">"M"</span>))</span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Map to nearest month-end</span></span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> {m <span class="cf">for</span> m <span class="kw">in</span> months <span class="cf">if</span> pd.Timestamp(m).month <span class="op">%</span> <span class="dv">3</span> <span class="op">==</span> <span class="dv">0</span>}</span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> rebal_dates:</span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a>            rebal_dates <span class="op">=</span> <span class="bu">set</span>(months[::<span class="dv">3</span>])</span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebal_freq <span class="op">==</span> <span class="st">"A"</span>:</span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> {m <span class="cf">for</span> m <span class="kw">in</span> months <span class="cf">if</span> pd.Timestamp(m).month <span class="op">==</span> <span class="dv">6</span>}</span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> rebal_dates:</span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>            rebal_dates <span class="op">=</span> <span class="bu">set</span>(months[::<span class="dv">12</span>])</span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a>        rebal_dates <span class="op">=</span> <span class="bu">set</span>(months)</span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a>    prev_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> monthly_df[monthly_df[<span class="st">"month_end"</span>] <span class="op">==</span> month].copy()</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> cross_section.dropna(subset<span class="op">=</span>[<span class="st">"monthly_return"</span>])</span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cross_section) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> month <span class="kw">in</span> rebal_dates <span class="kw">or</span> prev_weights <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-339"><a href="#cb28-339" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute fresh weights</span></span>
<span id="cb28-340"><a href="#cb28-340" aria-hidden="true" tabindex="-1"></a>            raw_weights <span class="op">=</span> weight_fn(cross_section)</span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a>            raw_weights <span class="op">=</span> raw_weights.clip(lower<span class="op">=</span>min_weight, upper<span class="op">=</span>max_weight)</span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a>            total <span class="op">=</span> raw_weights.<span class="bu">sum</span>()</span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>            target_weights <span class="op">=</span> raw_weights <span class="op">/</span> total</span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift weights forward from previous month</span></span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a>                available <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>                drifted <span class="op">=</span> prev_weights.reindex(available.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Adjust for returns</span></span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>                drifted <span class="op">=</span> drifted <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> available[<span class="st">"monthly_return"</span>])</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a>                total <span class="op">=</span> drifted.<span class="bu">sum</span>()</span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> total <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span></span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a>                target_weights <span class="op">=</span> drifted <span class="op">/</span> total</span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Align weights with available stocks</span></span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a>        cross_section <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a>        aligned_w <span class="op">=</span> target_weights.reindex(cross_section.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a>        aligned_w <span class="op">=</span> aligned_w <span class="op">/</span> aligned_w.<span class="bu">sum</span>()</span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Portfolio return</span></span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a>        port_ret <span class="op">=</span> (aligned_w <span class="op">*</span> cross_section[<span class="st">"monthly_return"</span>]).<span class="bu">sum</span>()</span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Turnover (two-way)</span></span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> prev_weights <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a>            prev_aligned <span class="op">=</span> prev_weights.reindex(aligned_w.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift previous weights</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>            prev_drifted <span class="op">=</span> prev_aligned <span class="op">*</span> (</span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a>                <span class="dv">1</span></span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> cross_section[<span class="st">"monthly_return"</span>].reindex(</span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a>                    prev_aligned.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>            prev_drifted <span class="op">=</span> (</span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a>                prev_drifted <span class="op">/</span> prev_drifted.<span class="bu">sum</span>()</span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> prev_drifted.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span> prev_drifted</span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> (aligned_w <span class="op">-</span> prev_drifted).<span class="bu">abs</span>().<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> <span class="fl">1.0</span></span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concentration metrics</span></span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>        hhi <span class="op">=</span> (aligned_w<span class="op">**</span><span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a>        effective_n <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> hhi <span class="cf">if</span> hhi <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>        results.append(</span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>                <span class="st">"month_end"</span>: month,</span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a>                <span class="st">"port_return"</span>: port_ret,</span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a>                <span class="st">"n_stocks"</span>: (aligned_w <span class="op">&gt;</span> <span class="fl">1e-6</span>).<span class="bu">sum</span>(),</span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a>                <span class="st">"turnover"</span>: turnover,</span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a>                <span class="st">"hhi"</span>: hhi,</span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a>                <span class="st">"effective_n"</span>: effective_n,</span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb28-400"><a href="#cb28-400" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-401"><a href="#cb28-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a>        prev_weights <span class="op">=</span> aligned_w.copy()</span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a><span class="fu">### Value-Weighted Portfolio</span></span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vw-portfolio</span></span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement value-weighted portfolio"</span></span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vw_weights(cross_section):</span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Value-weighted: proportional to market cap."""</span></span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cross_section.set_index(<span class="st">'ticker'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a>vw_returns <span class="op">=</span> compute_portfolio_returns(universe_mid, vw_weights, rebal_freq<span class="op">=</span><span class="st">'M'</span>)</span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"VW portfolio: </span><span class="sc">{</span><span class="bu">len</span>(vw_returns)<span class="sc">}</span><span class="ss"> months"</span>)</span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean monthly return: </span><span class="sc">{</span>vw_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean turnover: </span><span class="sc">{</span>vw_returns[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean effective N: </span><span class="sc">{</span>vw_returns[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span>)</span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### Equal-Weighted Portfolio</span></span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ew-portfolio</span></span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement equal-weighted portfolio at different rebalancing frequencies"</span></span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ew_weights(cross_section):</span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Equal-weighted: 1/N."""</span></span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> cross_section.set_index(<span class="st">'ticker'</span>).index</span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>tickers)</span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly rebalancing</span></span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a>ew_monthly <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-444"><a href="#cb28-444" aria-hidden="true" tabindex="-1"></a><span class="co"># Quarterly rebalancing</span></span>
<span id="cb28-445"><a href="#cb28-445" aria-hidden="true" tabindex="-1"></a>ew_quarterly <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Annual rebalancing (June)</span></span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a>ew_annual <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'A'</span></span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> [(<span class="st">'EW Monthly'</span>, ew_monthly),</span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">'EW Quarterly'</span>, ew_quarterly),</span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a>                  (<span class="st">'EW Annual'</span>, ew_annual)]:</span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">: mean ret = </span><span class="sc">{</span>df[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb28-458"><a href="#cb28-458" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"turnover = </span><span class="sc">{</span>df[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-459"><a href="#cb28-459" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a><span class="fu">### Capped Value-Weighted Portfolio</span></span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a>To mitigate the concentration of pure VW while retaining its low-turnover properties, we impose a cap on individual stock weights. A common choice is 5% or 10%, mimicking the construction rules of capped indices such as the MSCI Capped indices.</span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: capped-vw</span></span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement capped value-weighted portfolios"</span></span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> capped_vw_weights(cross_section, cap<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb28-472"><a href="#cb28-472" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Capped VW: market cap weights with an upper bound."""</span></span>
<span id="cb28-473"><a href="#cb28-473" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> cross_section.set_index(<span class="st">'ticker'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a>    w <span class="op">=</span> w <span class="op">/</span> w.<span class="bu">sum</span>()</span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Iterative capping (redistribute excess weight)</span></span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>):</span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> w[w <span class="op">&gt;</span> cap] <span class="op">-</span> cap</span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> excess.<span class="bu">sum</span>() <span class="op">&lt;=</span> <span class="fl">1e-8</span>:</span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a>        w[w <span class="op">&gt;</span> cap] <span class="op">=</span> cap</span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a>        w[w <span class="op">&lt;=</span> cap] <span class="op">*=</span> (<span class="dv">1</span> <span class="op">+</span> excess.<span class="bu">sum</span>() <span class="op">/</span> w[w <span class="op">&lt;=</span> cap].<span class="bu">sum</span>())</span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> w</span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a>capped5 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a>    universe_mid, <span class="kw">lambda</span> cs: capped_vw_weights(cs, <span class="fl">0.05</span>), rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb28-486"><a href="#cb28-486" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-487"><a href="#cb28-487" aria-hidden="true" tabindex="-1"></a>capped10 <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a>    universe_mid, <span class="kw">lambda</span> cs: capped_vw_weights(cs, <span class="fl">0.10</span>), rebal_freq<span class="op">=</span><span class="st">'M'</span></span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Capped 5%: eff_N = </span><span class="sc">{</span>capped5[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">, "</span></span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"turnover = </span><span class="sc">{</span>capped5[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Capped 10%: eff_N = </span><span class="sc">{</span>capped10[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">, "</span></span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"turnover = </span><span class="sc">{</span>capped10[<span class="st">'turnover'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fundamental-Weighted Portfolio</span></span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a>@arnott2005fundamental propose weighting stocks by fundamental measures (revenue, book equity, dividends, cash flow) rather than market cap. The logic is that fundamental weights are not contaminated by pricing errors, breaking the mechanical overweighting of overvalued stocks inherent in VW. We construct a composite fundamental weight using the average rank across four measures:</span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a>w_{i,t}^{FW} \propto \frac{1}{4}\left(\text{Rank}_{i,t}^{\text{Rev}} + \text{Rank}_{i,t}^{\text{BE}} + \text{Rank}_{i,t}^{\text{Div}} + \text{Rank}_{i,t}^{\text{CFO}}\right)</span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fw}</span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a><span class="co"># | label: fundamental-weighted</span></span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a><span class="co"># | eval: false</span></span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a><span class="co"># | code-summary: "Implement fundamental-weighted portfolio"</span></span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge fundamentals with monthly data (use most recent fiscal year)</span></span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a>fundamentals[<span class="st">"merge_year"</span>] <span class="op">=</span> fundamentals[<span class="st">"fiscal_year"</span>] <span class="op">+</span> <span class="dv">1</span>  <span class="co"># Lag by 1 year</span></span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a>monthly_fund <span class="op">=</span> monthly.copy()</span>
<span id="cb28-514"><a href="#cb28-514" aria-hidden="true" tabindex="-1"></a>monthly_fund[<span class="st">"year"</span>] <span class="op">=</span> pd.to_datetime(monthly_fund[<span class="st">"month_end"</span>]).dt.year</span>
<span id="cb28-515"><a href="#cb28-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a>monthly_fund <span class="op">=</span> monthly_fund.merge(</span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a>    fundamentals.rename(columns<span class="op">=</span>{<span class="st">"merge_year"</span>: <span class="st">"year"</span>}),</span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"year"</span>],</span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"left"</span>,</span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fw_weights(cross_section):</span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fundamental-weighted: composite of revenue, book equity, dividends, CFO."""</span></span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a>    cs <span class="op">=</span> cross_section.set_index(<span class="st">"ticker"</span>)</span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a>    ranks <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>cs.index)</span>
<span id="cb28-527"><a href="#cb28-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-528"><a href="#cb28-528" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"revenue"</span>, <span class="st">"book_equity"</span>, <span class="st">"dividends_paid"</span>, <span class="st">"operating_cash_flow"</span>]:</span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> col <span class="kw">in</span> cs.columns:</span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a>            vals <span class="op">=</span> cs[col].clip(lower<span class="op">=</span><span class="dv">0</span>)  <span class="co"># Only positive values</span></span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a>            ranks[col] <span class="op">=</span> vals.rank(pct<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a>    composite <span class="op">=</span> ranks.mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a>    composite <span class="op">=</span> composite.fillna(<span class="dv">0</span>)</span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> composite</span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a>fw_returns <span class="op">=</span> compute_portfolio_returns(monthly_fund, fw_weights, rebal_freq<span class="op">=</span><span class="st">"A"</span>)</span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(</span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"Fundamental-weighted: mean ret = </span><span class="sc">{</span>fw_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"eff_N = </span><span class="sc">{</span>fw_returns[<span class="st">'effective_n'</span>]<span class="sc">.</span>mean()<span class="sc">:.1f}</span><span class="ss">"</span></span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-543"><a href="#cb28-543" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-544"><a href="#cb28-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a><span class="fu">## Risk-Based Weighting Schemes {#sec-weight-risk-based}</span></span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a>The weighting schemes above use only market cap or accounting data. Risk-based schemes incorporate the covariance structure of returns, aiming to produce portfolios with better risk-adjusted performance. The trade-off is that they require estimating the covariance matrix (i.e., a high-dimensional object that is notoriously difficult to estimate precisely with short time series).</span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a><span class="fu">### Covariance Estimation</span></span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a>With $N \approx 300$ stocks and $T \approx 60$ months, the sample covariance matrix is severely ill-conditioned. We use the @ledoit2004well shrinkage estimator, which pulls the sample covariance toward a structured target (the identity matrix scaled by the average variance):</span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a>\hat{\boldsymbol{\Sigma}}^{\text{shrink}} = \delta \mathbf{F} + (1 - \delta) \mathbf{S}</span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a>$$ {#eq-shrinkage}</span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a>where $\mathbf{S}$ is the sample covariance, $\mathbf{F}$ is the shrinkage target, and $\delta \in <span class="co">[</span><span class="ot">0,1</span><span class="co">]</span>$ is the optimal shrinkage intensity derived analytically.</span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: covariance-estimation</span></span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Estimate covariance matrix with Ledoit-Wolf shrinkage"</span></span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_covariance(monthly_df, month, lookback<span class="op">=</span><span class="dv">60</span>, min_obs<span class="op">=</span><span class="dv">36</span>):</span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate covariance matrix using Ledoit-Wolf shrinkage.</span></span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-569"><a href="#cb28-569" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-570"><a href="#cb28-570" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame with ticker, month_end, monthly_return</span></span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a><span class="co">    month : target month (use returns before this date)</span></span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a><span class="co">    lookback : number of months to use</span></span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a><span class="co">    min_obs : minimum observations per stock</span></span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a><span class="co">    cov_matrix : DataFrame (N x N)</span></span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a><span class="co">    tickers : list of tickers with sufficient data</span></span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a>    end_date <span class="op">=</span> pd.Timestamp(month)</span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a>    start_date <span class="op">=</span> end_date <span class="op">-</span> pd.DateOffset(months<span class="op">=</span>lookback)</span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> monthly_df[</span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a>        (monthly_df[<span class="st">'month_end'</span>] <span class="op">&gt;</span> start_date) <span class="op">&amp;</span></span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a>        (monthly_df[<span class="st">'month_end'</span>] <span class="op">&lt;=</span> end_date)</span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pivot to wide format</span></span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a>    returns_wide <span class="op">=</span> window.pivot_table(</span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span><span class="st">'month_end'</span>, columns<span class="op">=</span><span class="st">'ticker'</span>, values<span class="op">=</span><span class="st">'monthly_return'</span></span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Keep stocks with sufficient observations</span></span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a>    valid_cols <span class="op">=</span> returns_wide.columns[returns_wide.notna().<span class="bu">sum</span>() <span class="op">&gt;=</span> min_obs]</span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a>    returns_wide <span class="op">=</span> returns_wide[valid_cols].dropna(axis<span class="op">=</span><span class="dv">0</span>, how<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill remaining NAs with 0 (conservative)</span></span>
<span id="cb28-599"><a href="#cb28-599" aria-hidden="true" tabindex="-1"></a>    returns_clean <span class="op">=</span> returns_wide.fillna(<span class="dv">0</span>)</span>
<span id="cb28-600"><a href="#cb28-600" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> returns_clean.shape[<span class="dv">1</span>] <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span>, <span class="va">None</span></span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ledoit-Wolf shrinkage</span></span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a>    lw <span class="op">=</span> LedoitWolf()</span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a>    lw.fit(returns_clean.values)</span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-608"><a href="#cb28-608" aria-hidden="true" tabindex="-1"></a>    cov_matrix <span class="op">=</span> pd.DataFrame(</span>
<span id="cb28-609"><a href="#cb28-609" aria-hidden="true" tabindex="-1"></a>        lw.covariance_,</span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a>        index<span class="op">=</span>valid_cols, columns<span class="op">=</span>valid_cols</span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> cov_matrix, <span class="bu">list</span>(valid_cols)</span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a><span class="fu">### Minimum Variance Portfolio</span></span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a>The global minimum variance (GMV) portfolio minimizes portfolio variance without targeting a specific return level <span class="co">[</span><span class="ot">@clarke2011minimum</span><span class="co">]</span>:</span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a>\mathbf{w}^{MV} = \arg\min_{\mathbf{w}} \; \mathbf{w}'\hat{\boldsymbol{\Sigma}}\mathbf{w} \quad \text{s.t.} \quad \mathbf{1}'\mathbf{w} = 1, \; w_i \geq 0</span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a>$$ {#eq-minvar}</span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a>The long-only constraint ($w_i \geq 0$) is essential in practice and also acts as an implicit shrinkage that improves out-of-sample performance <span class="co">[</span><span class="ot">@jagannathan2003risk</span><span class="co">]</span>.</span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: minimum-variance</span></span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement minimum variance portfolio"</span></span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> minimum_variance_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a><span class="co">    Solve for the minimum variance portfolio with long-only</span></span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a><span class="co">    and position-size constraints.</span></span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> portfolio_variance(w):</span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> w <span class="op">@</span> Sigma <span class="op">@</span> w</span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="dv">0</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a>        portfolio_variance, x0,</span>
<span id="cb28-651"><a href="#cb28-651" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb28-652"><a href="#cb28-652" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mv_weight_fn(cross_section, cov_cache<span class="op">=</span>{}):</span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Wrapper for portfolio engine: minimum variance."""</span></span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> cross_section[<span class="st">'month_end'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> cov_cache:</span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a>        cov_matrix, tickers <span class="op">=</span> estimate_covariance(monthly, month)</span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>        cov_cache[month] <span class="op">=</span> (cov_matrix, tickers)</span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>    cov_matrix, tickers <span class="op">=</span> cov_cache[month]</span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback to equal weight</span></span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Restrict to stocks in both cross-section and covariance matrix</span></span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a>    available <span class="op">=</span> <span class="bu">set</span>(cross_section[<span class="st">'ticker'</span>]) <span class="op">&amp;</span> <span class="bu">set</span>(tickers)</span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>    sub_cov <span class="op">=</span> cov_matrix.loc[<span class="bu">list</span>(available), <span class="bu">list</span>(available)]</span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a>    weights <span class="op">=</span> minimum_variance_weights(sub_cov)</span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weights</span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a>mv_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>    universe_mid, mv_weight_fn, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Min Variance: mean ret = </span><span class="sc">{</span>mv_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"std = </span><span class="sc">{</span>mv_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a><span class="fu">### Risk Parity (Equal Risk Contribution)</span></span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a>Risk parity allocates so that each asset contributes equally to total portfolio risk <span class="co">[</span><span class="ot">@maillard2010properties</span><span class="co">]</span>. The risk contribution of asset $i$ is:</span>
<span id="cb28-695"><a href="#cb28-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-696"><a href="#cb28-696" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a>RC_i = w_i \cdot \frac{(\boldsymbol{\Sigma} \mathbf{w})_i}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}</span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a>$$ {#eq-risk-contribution}</span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a>The risk parity portfolio solves $RC_i = RC_j$ for all $i, j$:</span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: risk-parity</span></span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement risk parity (equal risk contribution) portfolio"</span></span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> risk_parity_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a><span class="co">    Solve for the risk parity portfolio where each asset</span></span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a><span class="co">    contributes equally to total portfolio variance.</span></span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> risk_parity_objective(w):</span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a>        port_var <span class="op">=</span> w <span class="op">@</span> Sigma <span class="op">@</span> w</span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a>        marginal <span class="op">=</span> Sigma <span class="op">@</span> w</span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a>        risk_contrib <span class="op">=</span> w <span class="op">*</span> marginal</span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a>        target_rc <span class="op">=</span> port_var <span class="op">/</span> n</span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.<span class="bu">sum</span>((risk_contrib <span class="op">-</span> target_rc) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb28-724"><a href="#cb28-724" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb28-725"><a href="#cb28-725" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="fl">1e-6</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a>        risk_parity_objective, x0,</span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rp_weight_fn(cross_section, cov_cache<span class="op">=</span>{}):</span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Wrapper for portfolio engine: risk parity."""</span></span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a>    month <span class="op">=</span> cross_section[<span class="st">'month_end'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> month <span class="kw">not</span> <span class="kw">in</span> cov_cache:</span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a>        cov_matrix, tickers <span class="op">=</span> estimate_covariance(monthly, month)</span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a>        cov_cache[month] <span class="op">=</span> (cov_matrix, tickers)</span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a>    cov_matrix, tickers <span class="op">=</span> cov_cache[month]</span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a>    available <span class="op">=</span> <span class="bu">set</span>(cross_section[<span class="st">'ticker'</span>]) <span class="op">&amp;</span> <span class="bu">set</span>(tickers)</span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span>, index<span class="op">=</span>cross_section.set_index(<span class="st">'ticker'</span>).index)</span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-758"><a href="#cb28-758" aria-hidden="true" tabindex="-1"></a>    sub_cov <span class="op">=</span> cov_matrix.loc[<span class="bu">list</span>(available), <span class="bu">list</span>(available)]</span>
<span id="cb28-759"><a href="#cb28-759" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> risk_parity_weights(sub_cov)</span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a>rp_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a>    universe_mid, rp_weight_fn, rebal_freq<span class="op">=</span><span class="st">'Q'</span></span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Risk Parity: mean ret = </span><span class="sc">{</span>rp_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"std = </span><span class="sc">{</span>rp_returns[<span class="st">'port_return'</span>]<span class="sc">.</span>std()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a><span class="fu">### Maximum Diversification Portfolio</span></span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a>@choueifaty2008towards define the diversification ratio as the ratio of weighted average volatility to portfolio volatility:</span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a>DR(\mathbf{w}) = \frac{\mathbf{w}'\boldsymbol{\sigma}}{\sqrt{\mathbf{w}'\boldsymbol{\Sigma}\mathbf{w}}}</span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a>$$ {#eq-div-ratio}</span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a>where $\boldsymbol{\sigma}$ is the vector of individual asset volatilities. The maximum diversification portfolio maximizes this ratio:</span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: max-diversification</span></span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement maximum diversification portfolio"</span></span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> max_diversification_weights(cov_matrix, max_weight<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Maximize the diversification ratio."""</span></span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> cov_matrix.shape[<span class="dv">0</span>]</span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a>    Sigma <span class="op">=</span> cov_matrix.values</span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a>    sigma <span class="op">=</span> np.sqrt(np.diag(Sigma))</span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> neg_div_ratio(w):</span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a>        port_vol <span class="op">=</span> np.sqrt(w <span class="op">@</span> Sigma <span class="op">@</span> w)</span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> port_vol <span class="op">&lt;</span> <span class="fl">1e-10</span>:</span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>(w <span class="op">@</span> sigma) <span class="op">/</span> port_vol</span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a>    constraints <span class="op">=</span> [</span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a>        {<span class="st">'type'</span>: <span class="st">'eq'</span>, <span class="st">'fun'</span>: <span class="kw">lambda</span> w: np.<span class="bu">sum</span>(w) <span class="op">-</span> <span class="dv">1</span>}</span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a>    bounds <span class="op">=</span> [(<span class="dv">0</span>, max_weight) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n)]</span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a>    x0 <span class="op">=</span> np.ones(n) <span class="op">/</span> n</span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> minimize(</span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a>        neg_div_ratio, x0,</span>
<span id="cb28-804"><a href="#cb28-804" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">'SLSQP'</span>,</span>
<span id="cb28-805"><a href="#cb28-805" aria-hidden="true" tabindex="-1"></a>        bounds<span class="op">=</span>bounds,</span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a>        constraints<span class="op">=</span>constraints,</span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a>        options<span class="op">=</span>{<span class="st">'maxiter'</span>: <span class="dv">1000</span>, <span class="st">'ftol'</span>: <span class="fl">1e-12</span>}</span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result.success:</span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(result.x, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(<span class="fl">1.0</span> <span class="op">/</span> n, index<span class="op">=</span>cov_matrix.index)</span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comprehensive Performance Comparison {#sec-weight-comparison}</span></span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a>We now compare all schemes on a common universe with consistent methodology.</span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-822"><a href="#cb28-822" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-823"><a href="#cb28-823" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: all-portfolios</span></span>
<span id="cb28-824"><a href="#cb28-824" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-825"><a href="#cb28-825" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute returns for all weighting schemes"</span></span>
<span id="cb28-826"><a href="#cb28-826" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect all portfolio return series</span></span>
<span id="cb28-827"><a href="#cb28-827" aria-hidden="true" tabindex="-1"></a>portfolios <span class="op">=</span> {</span>
<span id="cb28-828"><a href="#cb28-828" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: vw_returns,</span>
<span id="cb28-829"><a href="#cb28-829" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Monthly)'</span>: ew_monthly,</span>
<span id="cb28-830"><a href="#cb28-830" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Quarterly)'</span>: ew_quarterly,</span>
<span id="cb28-831"><a href="#cb28-831" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Annual)'</span>: ew_annual,</span>
<span id="cb28-832"><a href="#cb28-832" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (5%)'</span>: capped5,</span>
<span id="cb28-833"><a href="#cb28-833" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (10%)'</span>: capped10,</span>
<span id="cb28-834"><a href="#cb28-834" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fundamental'</span>: fw_returns,</span>
<span id="cb28-835"><a href="#cb28-835" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Variance'</span>: mv_returns,</span>
<span id="cb28-836"><a href="#cb28-836" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Risk Parity'</span>: rp_returns,</span>
<span id="cb28-837"><a href="#cb28-837" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-838"><a href="#cb28-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-839"><a href="#cb28-839" aria-hidden="true" tabindex="-1"></a><span class="co"># Align to common date range</span></span>
<span id="cb28-840"><a href="#cb28-840" aria-hidden="true" tabindex="-1"></a>common_start <span class="op">=</span> <span class="bu">max</span>(df[<span class="st">'month_end'</span>].<span class="bu">min</span>() <span class="cf">for</span> df <span class="kw">in</span> portfolios.values())</span>
<span id="cb28-841"><a href="#cb28-841" aria-hidden="true" tabindex="-1"></a>common_end <span class="op">=</span> <span class="bu">min</span>(df[<span class="st">'month_end'</span>].<span class="bu">max</span>() <span class="cf">for</span> df <span class="kw">in</span> portfolios.values())</span>
<span id="cb28-842"><a href="#cb28-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-843"><a href="#cb28-843" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> portfolios:</span>
<span id="cb28-844"><a href="#cb28-844" aria-hidden="true" tabindex="-1"></a>    portfolios[name] <span class="op">=</span> portfolios[name][</span>
<span id="cb28-845"><a href="#cb28-845" aria-hidden="true" tabindex="-1"></a>        (portfolios[name][<span class="st">'month_end'</span>] <span class="op">&gt;=</span> common_start) <span class="op">&amp;</span></span>
<span id="cb28-846"><a href="#cb28-846" aria-hidden="true" tabindex="-1"></a>        (portfolios[name][<span class="st">'month_end'</span>] <span class="op">&lt;=</span> common_end)</span>
<span id="cb28-847"><a href="#cb28-847" aria-hidden="true" tabindex="-1"></a>    ].copy()</span>
<span id="cb28-848"><a href="#cb28-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-849"><a href="#cb28-849" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Common period: </span><span class="sc">{</span>common_start<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>common_end<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-850"><a href="#cb28-850" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of months: </span><span class="sc">{</span><span class="bu">len</span>(portfolios[<span class="st">'VW'</span>])<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-851"><a href="#cb28-851" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-852"><a href="#cb28-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-853"><a href="#cb28-853" aria-hidden="true" tabindex="-1"></a><span class="fu">### Performance Metrics</span></span>
<span id="cb28-854"><a href="#cb28-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-857"><a href="#cb28-857" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-858"><a href="#cb28-858" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: performance-metrics</span></span>
<span id="cb28-859"><a href="#cb28-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-860"><a href="#cb28-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute comprehensive performance statistics for all schemes"</span></span>
<span id="cb28-861"><a href="#cb28-861" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_metrics(returns_df, risk_free_annual<span class="op">=</span><span class="fl">0.04</span>):</span>
<span id="cb28-862"><a href="#cb28-862" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute performance metrics from monthly portfolio returns."""</span></span>
<span id="cb28-863"><a href="#cb28-863" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> returns_df[<span class="st">'port_return'</span>]</span>
<span id="cb28-864"><a href="#cb28-864" aria-hidden="true" tabindex="-1"></a>    rf_monthly <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> risk_free_annual) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-865"><a href="#cb28-865" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-866"><a href="#cb28-866" aria-hidden="true" tabindex="-1"></a>    excess <span class="op">=</span> r <span class="op">-</span> rf_monthly</span>
<span id="cb28-867"><a href="#cb28-867" aria-hidden="true" tabindex="-1"></a>    n_months <span class="op">=</span> <span class="bu">len</span>(r)</span>
<span id="cb28-868"><a href="#cb28-868" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-869"><a href="#cb28-869" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualized return</span></span>
<span id="cb28-870"><a href="#cb28-870" aria-hidden="true" tabindex="-1"></a>    cum_ret <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> r).prod()</span>
<span id="cb28-871"><a href="#cb28-871" aria-hidden="true" tabindex="-1"></a>    ann_ret <span class="op">=</span> cum_ret <span class="op">**</span> (<span class="dv">12</span> <span class="op">/</span> n_months) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-872"><a href="#cb28-872" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-873"><a href="#cb28-873" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Annualized volatility</span></span>
<span id="cb28-874"><a href="#cb28-874" aria-hidden="true" tabindex="-1"></a>    ann_vol <span class="op">=</span> r.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb28-875"><a href="#cb28-875" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-876"><a href="#cb28-876" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sharpe ratio</span></span>
<span id="cb28-877"><a href="#cb28-877" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-878"><a href="#cb28-878" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-879"><a href="#cb28-879" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Maximum drawdown</span></span>
<span id="cb28-880"><a href="#cb28-880" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> r).cumprod()</span>
<span id="cb28-881"><a href="#cb28-881" aria-hidden="true" tabindex="-1"></a>    running_max <span class="op">=</span> cum.cummax()</span>
<span id="cb28-882"><a href="#cb28-882" aria-hidden="true" tabindex="-1"></a>    drawdown <span class="op">=</span> (cum <span class="op">-</span> running_max) <span class="op">/</span> running_max</span>
<span id="cb28-883"><a href="#cb28-883" aria-hidden="true" tabindex="-1"></a>    max_dd <span class="op">=</span> drawdown.<span class="bu">min</span>()</span>
<span id="cb28-884"><a href="#cb28-884" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-885"><a href="#cb28-885" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sortino ratio</span></span>
<span id="cb28-886"><a href="#cb28-886" aria-hidden="true" tabindex="-1"></a>    downside <span class="op">=</span> excess[excess <span class="op">&lt;</span> <span class="dv">0</span>]</span>
<span id="cb28-887"><a href="#cb28-887" aria-hidden="true" tabindex="-1"></a>    downside_vol <span class="op">=</span> np.sqrt((downside <span class="op">**</span> <span class="dv">2</span>).mean()) <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb28-888"><a href="#cb28-888" aria-hidden="true" tabindex="-1"></a>    sortino <span class="op">=</span> excess.mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">/</span> downside_vol <span class="cf">if</span> downside_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-889"><a href="#cb28-889" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-890"><a href="#cb28-890" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calmar ratio</span></span>
<span id="cb28-891"><a href="#cb28-891" aria-hidden="true" tabindex="-1"></a>    calmar <span class="op">=</span> ann_ret <span class="op">/</span> <span class="bu">abs</span>(max_dd) <span class="cf">if</span> max_dd <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-892"><a href="#cb28-892" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-893"><a href="#cb28-893" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average turnover and effective N</span></span>
<span id="cb28-894"><a href="#cb28-894" aria-hidden="true" tabindex="-1"></a>    avg_turnover <span class="op">=</span> returns_df[<span class="st">'turnover'</span>].mean()</span>
<span id="cb28-895"><a href="#cb28-895" aria-hidden="true" tabindex="-1"></a>    avg_eff_n <span class="op">=</span> returns_df[<span class="st">'effective_n'</span>].mean()</span>
<span id="cb28-896"><a href="#cb28-896" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-897"><a href="#cb28-897" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Skewness and kurtosis</span></span>
<span id="cb28-898"><a href="#cb28-898" aria-hidden="true" tabindex="-1"></a>    skew <span class="op">=</span> r.skew()</span>
<span id="cb28-899"><a href="#cb28-899" aria-hidden="true" tabindex="-1"></a>    kurt <span class="op">=</span> r.kurtosis()</span>
<span id="cb28-900"><a href="#cb28-900" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-901"><a href="#cb28-901" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb28-902"><a href="#cb28-902" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Ann. Return'</span>: ann_ret,</span>
<span id="cb28-903"><a href="#cb28-903" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Ann. Volatility'</span>: ann_vol,</span>
<span id="cb28-904"><a href="#cb28-904" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Sharpe Ratio'</span>: sharpe,</span>
<span id="cb28-905"><a href="#cb28-905" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Sortino Ratio'</span>: sortino,</span>
<span id="cb28-906"><a href="#cb28-906" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Max Drawdown'</span>: max_dd,</span>
<span id="cb28-907"><a href="#cb28-907" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Calmar Ratio'</span>: calmar,</span>
<span id="cb28-908"><a href="#cb28-908" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Skewness'</span>: skew,</span>
<span id="cb28-909"><a href="#cb28-909" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Kurtosis'</span>: kurt,</span>
<span id="cb28-910"><a href="#cb28-910" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg. Turnover'</span>: avg_turnover,</span>
<span id="cb28-911"><a href="#cb28-911" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Effective N'</span>: avg_eff_n</span>
<span id="cb28-912"><a href="#cb28-912" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-913"><a href="#cb28-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-914"><a href="#cb28-914" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute metrics for all portfolios</span></span>
<span id="cb28-915"><a href="#cb28-915" aria-hidden="true" tabindex="-1"></a>metrics_list <span class="op">=</span> []</span>
<span id="cb28-916"><a href="#cb28-916" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb28-917"><a href="#cb28-917" aria-hidden="true" tabindex="-1"></a>    m <span class="op">=</span> compute_metrics(df)</span>
<span id="cb28-918"><a href="#cb28-918" aria-hidden="true" tabindex="-1"></a>    m[<span class="st">'Portfolio'</span>] <span class="op">=</span> name</span>
<span id="cb28-919"><a href="#cb28-919" aria-hidden="true" tabindex="-1"></a>    metrics_list.append(m)</span>
<span id="cb28-920"><a href="#cb28-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-921"><a href="#cb28-921" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> pd.DataFrame(metrics_list).set_index(<span class="st">'Portfolio'</span>)</span>
<span id="cb28-922"><a href="#cb28-922" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-923"><a href="#cb28-923" aria-hidden="true" tabindex="-1"></a><span class="co"># Format for display</span></span>
<span id="cb28-924"><a href="#cb28-924" aria-hidden="true" tabindex="-1"></a>display_cols <span class="op">=</span> [</span>
<span id="cb28-925"><a href="#cb28-925" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Ann. Return'</span>, <span class="st">'Ann. Volatility'</span>, <span class="st">'Sharpe Ratio'</span>, <span class="st">'Sortino Ratio'</span>,</span>
<span id="cb28-926"><a href="#cb28-926" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Max Drawdown'</span>, <span class="st">'Avg. Turnover'</span>, <span class="st">'Effective N'</span></span>
<span id="cb28-927"><a href="#cb28-927" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb28-928"><a href="#cb28-928" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(metrics_df[display_cols].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb28-929"><a href="#cb28-929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-930"><a href="#cb28-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-933"><a href="#cb28-933" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-934"><a href="#cb28-934" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumulative-returns</span></span>
<span id="cb28-935"><a href="#cb28-935" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-936"><a href="#cb28-936" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative wealth paths for different weighting schemes applied to Vietnamese equities (2012‚Äì2024). The chart shows that the choice of weighting scheme has a material effect on cumulative performance. Equal-weighted portfolios outperform value-weighted portfolios in gross terms, but this advantage must be weighed against higher turnover costs."</span></span>
<span id="cb28-937"><a href="#cb28-937" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot cumulative returns for all weighting schemes"</span></span>
<span id="cb28-938"><a href="#cb28-938" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb28-939"><a href="#cb28-939" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-940"><a href="#cb28-940" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {</span>
<span id="cb28-941"><a href="#cb28-941" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'EW (Monthly)'</span>: <span class="st">'#E67E22'</span>,</span>
<span id="cb28-942"><a href="#cb28-942" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Quarterly)'</span>: <span class="st">'#F39C12'</span>, <span class="st">'EW (Annual)'</span>: <span class="st">'#D4AC0D'</span>,</span>
<span id="cb28-943"><a href="#cb28-943" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (5%)'</span>: <span class="st">'#8E44AD'</span>, <span class="st">'Capped VW (10%)'</span>: <span class="st">'#9B59B6'</span>,</span>
<span id="cb28-944"><a href="#cb28-944" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Fundamental'</span>: <span class="st">'#27AE60'</span>, <span class="st">'Min Variance'</span>: <span class="st">'#C0392B'</span>,</span>
<span id="cb28-945"><a href="#cb28-945" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Risk Parity'</span>: <span class="st">'#1ABC9C'</span></span>
<span id="cb28-946"><a href="#cb28-946" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-947"><a href="#cb28-947" aria-hidden="true" tabindex="-1"></a>linestyles <span class="op">=</span> {</span>
<span id="cb28-948"><a href="#cb28-948" aria-hidden="true" tabindex="-1"></a>    <span class="st">'VW'</span>: <span class="st">'-'</span>, <span class="st">'EW (Monthly)'</span>: <span class="st">'-'</span>, <span class="st">'EW (Quarterly)'</span>: <span class="st">'--'</span>,</span>
<span id="cb28-949"><a href="#cb28-949" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EW (Annual)'</span>: <span class="st">':'</span>, <span class="st">'Capped VW (5%)'</span>: <span class="st">'-'</span>,</span>
<span id="cb28-950"><a href="#cb28-950" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Capped VW (10%)'</span>: <span class="st">'--'</span>, <span class="st">'Fundamental'</span>: <span class="st">'-'</span>,</span>
<span id="cb28-951"><a href="#cb28-951" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Min Variance'</span>: <span class="st">'-'</span>, <span class="st">'Risk Parity'</span>: <span class="st">'-'</span></span>
<span id="cb28-952"><a href="#cb28-952" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-953"><a href="#cb28-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-954"><a href="#cb28-954" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb28-955"><a href="#cb28-955" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df.set_index(<span class="st">'month_end'</span>)[<span class="st">'port_return'</span>]).cumprod()</span>
<span id="cb28-956"><a href="#cb28-956" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum.index, cum.values, label<span class="op">=</span>name,</span>
<span id="cb28-957"><a href="#cb28-957" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>),</span>
<span id="cb28-958"><a href="#cb28-958" aria-hidden="true" tabindex="-1"></a>            linestyle<span class="op">=</span>linestyles.get(name, <span class="st">'-'</span>),</span>
<span id="cb28-959"><a href="#cb28-959" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="fl">1.8</span> <span class="cf">if</span> name <span class="kw">in</span> [<span class="st">'VW'</span>, <span class="st">'EW (Monthly)'</span>, <span class="st">'Min Variance'</span>] <span class="cf">else</span> <span class="fl">1.2</span>)</span>
<span id="cb28-960"><a href="#cb28-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-961"><a href="#cb28-961" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb28-962"><a href="#cb28-962" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Cumulative Wealth (VND 1 invested)'</span>)</span>
<span id="cb28-963"><a href="#cb28-963" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Cumulative Performance by Weighting Scheme'</span>)</span>
<span id="cb28-964"><a href="#cb28-964" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">'upper left'</span>, fontsize<span class="op">=</span><span class="dv">9</span>, ncol<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-965"><a href="#cb28-965" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb28-966"><a href="#cb28-966" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-967"><a href="#cb28-967" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-968"><a href="#cb28-968" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-969"><a href="#cb28-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-970"><a href="#cb28-970" aria-hidden="true" tabindex="-1"></a><span class="fu">### Risk-Return Trade-Off</span></span>
<span id="cb28-971"><a href="#cb28-971" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-974"><a href="#cb28-974" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-975"><a href="#cb28-975" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-risk-return</span></span>
<span id="cb28-976"><a href="#cb28-976" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-977"><a href="#cb28-977" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Annualized risk-return scatter plot for all weighting schemes. Risk-based methods (minimum variance, risk parity) cluster in the lower-left with lower volatility, while equal-weighted schemes offer higher returns at the cost of higher turnover and volatility."</span></span>
<span id="cb28-978"><a href="#cb28-978" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Risk-return scatter plot"</span></span>
<span id="cb28-979"><a href="#cb28-979" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">9</span>, <span class="dv">7</span>))</span>
<span id="cb28-980"><a href="#cb28-980" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-981"><a href="#cb28-981" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> metrics_df.index:</span>
<span id="cb28-982"><a href="#cb28-982" aria-hidden="true" tabindex="-1"></a>    ax.scatter(</span>
<span id="cb28-983"><a href="#cb28-983" aria-hidden="true" tabindex="-1"></a>        metrics_df.loc[name, <span class="st">'Ann. Volatility'</span>],</span>
<span id="cb28-984"><a href="#cb28-984" aria-hidden="true" tabindex="-1"></a>        metrics_df.loc[name, <span class="st">'Ann. Return'</span>],</span>
<span id="cb28-985"><a href="#cb28-985" aria-hidden="true" tabindex="-1"></a>        s<span class="op">=</span>metrics_df.loc[name, <span class="st">'Effective N'</span>] <span class="op">*</span> <span class="dv">3</span>,</span>
<span id="cb28-986"><a href="#cb28-986" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>),</span>
<span id="cb28-987"><a href="#cb28-987" aria-hidden="true" tabindex="-1"></a>        alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolors<span class="op">=</span><span class="st">'white'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, zorder<span class="op">=</span><span class="dv">5</span></span>
<span id="cb28-988"><a href="#cb28-988" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-989"><a href="#cb28-989" aria-hidden="true" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb28-990"><a href="#cb28-990" aria-hidden="true" tabindex="-1"></a>        name,</span>
<span id="cb28-991"><a href="#cb28-991" aria-hidden="true" tabindex="-1"></a>        (metrics_df.loc[name, <span class="st">'Ann. Volatility'</span>] <span class="op">+</span> <span class="fl">0.002</span>,</span>
<span id="cb28-992"><a href="#cb28-992" aria-hidden="true" tabindex="-1"></a>         metrics_df.loc[name, <span class="st">'Ann. Return'</span>]),</span>
<span id="cb28-993"><a href="#cb28-993" aria-hidden="true" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">8</span></span>
<span id="cb28-994"><a href="#cb28-994" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-995"><a href="#cb28-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-996"><a href="#cb28-996" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Annualized Volatility'</span>)</span>
<span id="cb28-997"><a href="#cb28-997" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Annualized Return'</span>)</span>
<span id="cb28-998"><a href="#cb28-998" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Risk-Return Profile (bubble size = Effective N)'</span>)</span>
<span id="cb28-999"><a href="#cb28-999" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1000"><a href="#cb28-1000" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1001"><a href="#cb28-1001" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1002"><a href="#cb28-1002" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1003"><a href="#cb28-1003" aria-hidden="true" tabindex="-1"></a><span class="fu">## Transaction Costs and Net-of-Cost Performance {#sec-weight-transaction-costs}</span></span>
<span id="cb28-1004"><a href="#cb28-1004" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1005"><a href="#cb28-1005" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimating Trading Costs in Vietnam</span></span>
<span id="cb28-1006"><a href="#cb28-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1007"><a href="#cb28-1007" aria-hidden="true" tabindex="-1"></a>Transaction costs in Vietnam include explicit components (brokerage commissions, exchange fees, taxes) and implicit components (bid-ask spread, price impact). The explicit cost structure as of 2024 is approximately:</span>
<span id="cb28-1008"><a href="#cb28-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1009"><a href="#cb28-1009" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Component               <span class="pp">|</span> Rate       <span class="pp">|</span> Notes                            <span class="pp">|</span></span>
<span id="cb28-1010"><a href="#cb28-1010" aria-hidden="true" tabindex="-1"></a><span class="pp">|-------------------------|------------|----------------------------------|</span></span>
<span id="cb28-1011"><a href="#cb28-1011" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Brokerage commission    <span class="pp">|</span> 0.15‚Äì0.35% <span class="pp">|</span> Varies by broker and volume tier <span class="pp">|</span></span>
<span id="cb28-1012"><a href="#cb28-1012" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Exchange &amp; clearing fee <span class="pp">|</span> 0.003%     <span class="pp">|</span> Fixed by exchange                <span class="pp">|</span></span>
<span id="cb28-1013"><a href="#cb28-1013" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Selling tax             <span class="pp">|</span> 0.10%      <span class="pp">|</span> Levied on gross sale proceeds    <span class="pp">|</span></span>
<span id="cb28-1014"><a href="#cb28-1014" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1015"><a href="#cb28-1015" aria-hidden="true" tabindex="-1"></a>: Explicit transaction cost components for Vietnamese equities. {#tbl-weight-costs}</span>
<span id="cb28-1016"><a href="#cb28-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1017"><a href="#cb28-1017" aria-hidden="true" tabindex="-1"></a>The total explicit round-trip cost (buy + sell) ranges from approximately 0.30% to 0.80%. Implicit costs‚Äîthe spread and price impact‚Äîcan be substantially larger for small and illiquid stocks.</span>
<span id="cb28-1018"><a href="#cb28-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1019"><a href="#cb28-1019" aria-hidden="true" tabindex="-1"></a>We model total transaction costs as a function of trade size and stock liquidity:</span>
<span id="cb28-1020"><a href="#cb28-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1021"><a href="#cb28-1021" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1022"><a href="#cb28-1022" aria-hidden="true" tabindex="-1"></a>TC_{i,t} = c_{\text{fixed}} + \frac{1}{2} \text{Spread}_{i,t} + \lambda \sqrt{\frac{|\Delta w_{i,t}| \cdot \text{AUM}}{ADV_{i,t}}}</span>
<span id="cb28-1023"><a href="#cb28-1023" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tc-model}</span>
<span id="cb28-1024"><a href="#cb28-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1025"><a href="#cb28-1025" aria-hidden="true" tabindex="-1"></a>where $c_{\text{fixed}} \approx 0.25\%$ is the explicit cost per trade, $\text{Spread}_{i,t}$ is the quoted bid-ask spread, $\Delta w_{i,t}$ is the weight change, $\text{AUM}$ is portfolio size, $ADV_{i,t}$ is average daily volume in VND, and $\lambda$ is the price impact coefficient estimated from the @amihud2002illiquidity model.</span>
<span id="cb28-1026"><a href="#cb28-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1029"><a href="#cb28-1029" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1030"><a href="#cb28-1030" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: transaction-cost-model</span></span>
<span id="cb28-1031"><a href="#cb28-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1032"><a href="#cb28-1032" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement transaction cost model calibrated to Vietnamese market"</span></span>
<span id="cb28-1033"><a href="#cb28-1033" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_transaction_costs(weight_changes, stock_data,</span>
<span id="cb28-1034"><a href="#cb28-1034" aria-hidden="true" tabindex="-1"></a>                                aum_vnd<span class="op">=</span><span class="fl">100e9</span>, fixed_cost<span class="op">=</span><span class="fl">0.0025</span>,</span>
<span id="cb28-1035"><a href="#cb28-1035" aria-hidden="true" tabindex="-1"></a>                                impact_coef<span class="op">=</span><span class="fl">0.10</span>):</span>
<span id="cb28-1036"><a href="#cb28-1036" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-1037"><a href="#cb28-1037" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate total transaction costs for a rebalancing event.</span></span>
<span id="cb28-1038"><a href="#cb28-1038" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-1039"><a href="#cb28-1039" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-1040"><a href="#cb28-1040" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-1041"><a href="#cb28-1041" aria-hidden="true" tabindex="-1"></a><span class="co">    weight_changes : Series indexed by ticker, absolute weight changes</span></span>
<span id="cb28-1042"><a href="#cb28-1042" aria-hidden="true" tabindex="-1"></a><span class="co">    stock_data : DataFrame with ticker, bid_ask_spread, turnover_value_avg_20d</span></span>
<span id="cb28-1043"><a href="#cb28-1043" aria-hidden="true" tabindex="-1"></a><span class="co">    aum_vnd : float, portfolio AUM in VND</span></span>
<span id="cb28-1044"><a href="#cb28-1044" aria-hidden="true" tabindex="-1"></a><span class="co">    fixed_cost : float, explicit cost per unit traded (one-way)</span></span>
<span id="cb28-1045"><a href="#cb28-1045" aria-hidden="true" tabindex="-1"></a><span class="co">    impact_coef : float, price impact coefficient (lambda)</span></span>
<span id="cb28-1046"><a href="#cb28-1046" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-1047"><a href="#cb28-1047" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb28-1048"><a href="#cb28-1048" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb28-1049"><a href="#cb28-1049" aria-hidden="true" tabindex="-1"></a><span class="co">    total_cost : float, total TC as fraction of AUM</span></span>
<span id="cb28-1050"><a href="#cb28-1050" aria-hidden="true" tabindex="-1"></a><span class="co">    cost_detail : DataFrame with per-stock costs</span></span>
<span id="cb28-1051"><a href="#cb28-1051" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-1052"><a href="#cb28-1052" aria-hidden="true" tabindex="-1"></a>    costs <span class="op">=</span> []</span>
<span id="cb28-1053"><a href="#cb28-1053" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1054"><a href="#cb28-1054" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker, dw <span class="kw">in</span> weight_changes.items():</span>
<span id="cb28-1055"><a href="#cb28-1055" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">abs</span>(dw) <span class="op">&lt;</span> <span class="fl">1e-6</span>:</span>
<span id="cb28-1056"><a href="#cb28-1056" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb28-1057"><a href="#cb28-1057" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1058"><a href="#cb28-1058" aria-hidden="true" tabindex="-1"></a>        trade_vnd <span class="op">=</span> <span class="bu">abs</span>(dw) <span class="op">*</span> aum_vnd</span>
<span id="cb28-1059"><a href="#cb28-1059" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1060"><a href="#cb28-1060" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Explicit cost (one-way)</span></span>
<span id="cb28-1061"><a href="#cb28-1061" aria-hidden="true" tabindex="-1"></a>        explicit <span class="op">=</span> fixed_cost <span class="op">*</span> trade_vnd</span>
<span id="cb28-1062"><a href="#cb28-1062" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1063"><a href="#cb28-1063" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Spread cost</span></span>
<span id="cb28-1064"><a href="#cb28-1064" aria-hidden="true" tabindex="-1"></a>        stock_info <span class="op">=</span> stock_data[stock_data[<span class="st">'ticker'</span>] <span class="op">==</span> ticker]</span>
<span id="cb28-1065"><a href="#cb28-1065" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(stock_info) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-1066"><a href="#cb28-1066" aria-hidden="true" tabindex="-1"></a>            spread <span class="op">=</span> stock_info[<span class="st">'bid_ask_spread'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb28-1067"><a href="#cb28-1067" aria-hidden="true" tabindex="-1"></a>            adv <span class="op">=</span> stock_info[<span class="st">'turnover_value_avg_20d'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb28-1068"><a href="#cb28-1068" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-1069"><a href="#cb28-1069" aria-hidden="true" tabindex="-1"></a>            spread <span class="op">=</span> <span class="fl">0.005</span>  <span class="co"># Default 50 bps</span></span>
<span id="cb28-1070"><a href="#cb28-1070" aria-hidden="true" tabindex="-1"></a>            adv <span class="op">=</span> <span class="fl">1e9</span>  <span class="co"># Default VND 1bn</span></span>
<span id="cb28-1071"><a href="#cb28-1071" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1072"><a href="#cb28-1072" aria-hidden="true" tabindex="-1"></a>        spread_cost <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> spread <span class="op">*</span> trade_vnd</span>
<span id="cb28-1073"><a href="#cb28-1073" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1074"><a href="#cb28-1074" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price impact (square root model)</span></span>
<span id="cb28-1075"><a href="#cb28-1075" aria-hidden="true" tabindex="-1"></a>        participation_rate <span class="op">=</span> trade_vnd <span class="op">/</span> <span class="bu">max</span>(adv, <span class="fl">1e6</span>)</span>
<span id="cb28-1076"><a href="#cb28-1076" aria-hidden="true" tabindex="-1"></a>        impact_cost <span class="op">=</span> impact_coef <span class="op">*</span> np.sqrt(participation_rate) <span class="op">*</span> trade_vnd</span>
<span id="cb28-1077"><a href="#cb28-1077" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1078"><a href="#cb28-1078" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> explicit <span class="op">+</span> spread_cost <span class="op">+</span> impact_cost</span>
<span id="cb28-1079"><a href="#cb28-1079" aria-hidden="true" tabindex="-1"></a>        costs.append({</span>
<span id="cb28-1080"><a href="#cb28-1080" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb28-1081"><a href="#cb28-1081" aria-hidden="true" tabindex="-1"></a>            <span class="st">'weight_change'</span>: dw,</span>
<span id="cb28-1082"><a href="#cb28-1082" aria-hidden="true" tabindex="-1"></a>            <span class="st">'trade_vnd'</span>: trade_vnd,</span>
<span id="cb28-1083"><a href="#cb28-1083" aria-hidden="true" tabindex="-1"></a>            <span class="st">'explicit'</span>: explicit,</span>
<span id="cb28-1084"><a href="#cb28-1084" aria-hidden="true" tabindex="-1"></a>            <span class="st">'spread'</span>: spread_cost,</span>
<span id="cb28-1085"><a href="#cb28-1085" aria-hidden="true" tabindex="-1"></a>            <span class="st">'impact'</span>: impact_cost,</span>
<span id="cb28-1086"><a href="#cb28-1086" aria-hidden="true" tabindex="-1"></a>            <span class="st">'total'</span>: total</span>
<span id="cb28-1087"><a href="#cb28-1087" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb28-1088"><a href="#cb28-1088" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1089"><a href="#cb28-1089" aria-hidden="true" tabindex="-1"></a>    cost_df <span class="op">=</span> pd.DataFrame(costs)</span>
<span id="cb28-1090"><a href="#cb28-1090" aria-hidden="true" tabindex="-1"></a>    total_cost <span class="op">=</span> cost_df[<span class="st">'total'</span>].<span class="bu">sum</span>() <span class="op">/</span> aum_vnd <span class="cf">if</span> <span class="bu">len</span>(cost_df) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-1091"><a href="#cb28-1091" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1092"><a href="#cb28-1092" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> total_cost, cost_df</span>
<span id="cb28-1093"><a href="#cb28-1093" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1094"><a href="#cb28-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1095"><a href="#cb28-1095" aria-hidden="true" tabindex="-1"></a><span class="fu">### Net-of-Cost Performance</span></span>
<span id="cb28-1096"><a href="#cb28-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1097"><a href="#cb28-1097" aria-hidden="true" tabindex="-1"></a>We apply the transaction cost model to compute net-of-cost returns for each weighting scheme at different assumed AUM levels. This is critical because strategies that appear attractive in gross terms may be unimplementable at scale due to the illiquidity of small-cap Vietnamese stocks.</span>
<span id="cb28-1098"><a href="#cb28-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1101"><a href="#cb28-1101" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1102"><a href="#cb28-1102" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: net-returns</span></span>
<span id="cb28-1103"><a href="#cb28-1103" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1104"><a href="#cb28-1104" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute net-of-cost returns using simplified proportional cost model"</span></span>
<span id="cb28-1105"><a href="#cb28-1105" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_net_returns(portfolio_df, cost_per_turnover<span class="op">=</span><span class="fl">0.005</span>):</span>
<span id="cb28-1106"><a href="#cb28-1106" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-1107"><a href="#cb28-1107" aria-hidden="true" tabindex="-1"></a><span class="co">    Approximate net returns using a proportional cost model.</span></span>
<span id="cb28-1108"><a href="#cb28-1108" aria-hidden="true" tabindex="-1"></a><span class="co">    Net return = gross return - (turnover * cost_per_unit_turnover)</span></span>
<span id="cb28-1109"><a href="#cb28-1109" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-1110"><a href="#cb28-1110" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> portfolio_df.copy()</span>
<span id="cb28-1111"><a href="#cb28-1111" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'tc'</span>] <span class="op">=</span> df[<span class="st">'turnover'</span>] <span class="op">*</span> cost_per_turnover</span>
<span id="cb28-1112"><a href="#cb28-1112" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'net_return'</span>] <span class="op">=</span> df[<span class="st">'port_return'</span>] <span class="op">-</span> df[<span class="st">'tc'</span>]</span>
<span id="cb28-1113"><a href="#cb28-1113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb28-1114"><a href="#cb28-1114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1115"><a href="#cb28-1115" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute at different cost assumptions</span></span>
<span id="cb28-1116"><a href="#cb28-1116" aria-hidden="true" tabindex="-1"></a>cost_scenarios <span class="op">=</span> {</span>
<span id="cb28-1117"><a href="#cb28-1117" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Low (25 bps)'</span>: <span class="fl">0.0025</span>,</span>
<span id="cb28-1118"><a href="#cb28-1118" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Medium (50 bps)'</span>: <span class="fl">0.005</span>,</span>
<span id="cb28-1119"><a href="#cb28-1119" aria-hidden="true" tabindex="-1"></a>    <span class="st">'High (100 bps)'</span>: <span class="fl">0.01</span></span>
<span id="cb28-1120"><a href="#cb28-1120" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1121"><a href="#cb28-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1122"><a href="#cb28-1122" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annualized Net Sharpe Ratios by Cost Scenario:"</span>)</span>
<span id="cb28-1123"><a href="#cb28-1123" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb28-1124"><a href="#cb28-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1125"><a href="#cb28-1125" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> cost_name, cost_rate <span class="kw">in</span> cost_scenarios.items():</span>
<span id="cb28-1126"><a href="#cb28-1126" aria-hidden="true" tabindex="-1"></a>    row <span class="op">=</span> {<span class="st">'Scenario'</span>: cost_name}</span>
<span id="cb28-1127"><a href="#cb28-1127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> port_name, port_df <span class="kw">in</span> portfolios.items():</span>
<span id="cb28-1128"><a href="#cb28-1128" aria-hidden="true" tabindex="-1"></a>        net_df <span class="op">=</span> compute_net_returns(port_df, cost_rate)</span>
<span id="cb28-1129"><a href="#cb28-1129" aria-hidden="true" tabindex="-1"></a>        rf_monthly <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-1130"><a href="#cb28-1130" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_monthly</span>
<span id="cb28-1131"><a href="#cb28-1131" aria-hidden="true" tabindex="-1"></a>        sharpe <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-1132"><a href="#cb28-1132" aria-hidden="true" tabindex="-1"></a>        row[port_name] <span class="op">=</span> <span class="bu">round</span>(sharpe, <span class="dv">3</span>)</span>
<span id="cb28-1133"><a href="#cb28-1133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>cost_name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb28-1134"><a href="#cb28-1134" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k, v <span class="kw">in</span> row.items():</span>
<span id="cb28-1135"><a href="#cb28-1135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> k <span class="op">!=</span> <span class="st">'Scenario'</span>:</span>
<span id="cb28-1136"><a href="#cb28-1136" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>k<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>v<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb28-1137"><a href="#cb28-1137" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span>
<span id="cb28-1138"><a href="#cb28-1138" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1139"><a href="#cb28-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1142"><a href="#cb28-1142" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1143"><a href="#cb28-1143" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-turnover-comparison</span></span>
<span id="cb28-1144"><a href="#cb28-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1145"><a href="#cb28-1145" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Monthly portfolio turnover by weighting scheme. Value-weighted portfolios have the lowest turnover because weights drift naturally with prices. Equal-weighted portfolios with monthly rebalancing have the highest turnover. Risk-based schemes with quarterly rebalancing fall in between."</span></span>
<span id="cb28-1146"><a href="#cb28-1146" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare turnover distributions across schemes"</span></span>
<span id="cb28-1147"><a href="#cb28-1147" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb28-1148"><a href="#cb28-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1149"><a href="#cb28-1149" aria-hidden="true" tabindex="-1"></a>turnover_data <span class="op">=</span> {}</span>
<span id="cb28-1150"><a href="#cb28-1150" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb28-1151"><a href="#cb28-1151" aria-hidden="true" tabindex="-1"></a>    turnover_data[name] <span class="op">=</span> df[<span class="st">'turnover'</span>].values</span>
<span id="cb28-1152"><a href="#cb28-1152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1153"><a href="#cb28-1153" aria-hidden="true" tabindex="-1"></a>positions <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(turnover_data))</span>
<span id="cb28-1154"><a href="#cb28-1154" aria-hidden="true" tabindex="-1"></a>bp <span class="op">=</span> ax.boxplot(</span>
<span id="cb28-1155"><a href="#cb28-1155" aria-hidden="true" tabindex="-1"></a>    turnover_data.values(),</span>
<span id="cb28-1156"><a href="#cb28-1156" aria-hidden="true" tabindex="-1"></a>    positions<span class="op">=</span>positions,</span>
<span id="cb28-1157"><a href="#cb28-1157" aria-hidden="true" tabindex="-1"></a>    widths<span class="op">=</span><span class="fl">0.6</span>,</span>
<span id="cb28-1158"><a href="#cb28-1158" aria-hidden="true" tabindex="-1"></a>    patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb28-1159"><a href="#cb28-1159" aria-hidden="true" tabindex="-1"></a>    showfliers<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb28-1160"><a href="#cb28-1160" aria-hidden="true" tabindex="-1"></a>    medianprops<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'black'</span>, <span class="st">'linewidth'</span>: <span class="fl">1.5</span>}</span>
<span id="cb28-1161"><a href="#cb28-1161" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1162"><a href="#cb28-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1163"><a href="#cb28-1163" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (patch, name) <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="bu">zip</span>(bp[<span class="st">'boxes'</span>], turnover_data.keys())):</span>
<span id="cb28-1164"><a href="#cb28-1164" aria-hidden="true" tabindex="-1"></a>    patch.set_facecolor(colors.get(name, <span class="st">'gray'</span>))</span>
<span id="cb28-1165"><a href="#cb28-1165" aria-hidden="true" tabindex="-1"></a>    patch.set_alpha(<span class="fl">0.7</span>)</span>
<span id="cb28-1166"><a href="#cb28-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1167"><a href="#cb28-1167" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(positions)</span>
<span id="cb28-1168"><a href="#cb28-1168" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(turnover_data.keys(), rotation<span class="op">=</span><span class="dv">45</span>, ha<span class="op">=</span><span class="st">'right'</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-1169"><a href="#cb28-1169" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Monthly Turnover (one-way)'</span>)</span>
<span id="cb28-1170"><a href="#cb28-1170" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Turnover Distribution by Weighting Scheme'</span>)</span>
<span id="cb28-1171"><a href="#cb28-1171" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1172"><a href="#cb28-1172" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1173"><a href="#cb28-1173" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1174"><a href="#cb28-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1175"><a href="#cb28-1175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Cost Erosion at Scale</span></span>
<span id="cb28-1176"><a href="#cb28-1176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1177"><a href="#cb28-1177" aria-hidden="true" tabindex="-1"></a>The relationship between portfolio AUM and implementable performance is non-linear because price impact costs grow with trade size. We simulate performance at different AUM levels:</span>
<span id="cb28-1178"><a href="#cb28-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1181"><a href="#cb28-1181" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1182"><a href="#cb28-1182" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-aum-scaling</span></span>
<span id="cb28-1183"><a href="#cb28-1183" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1184"><a href="#cb28-1184" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Sharpe ratio as a function of portfolio AUM for selected weighting schemes. Value-weighted portfolios are nearly scale-invariant due to their tilt toward liquid large-caps. Equal-weighted portfolios degrade rapidly as AUM increases because rebalancing trades in small-cap names face prohibitive price impact."</span></span>
<span id="cb28-1185"><a href="#cb28-1185" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Simulate performance degradation with AUM for different schemes"</span></span>
<span id="cb28-1186"><a href="#cb28-1186" aria-hidden="true" tabindex="-1"></a>aum_levels <span class="op">=</span> [<span class="dv">10</span>, <span class="dv">50</span>, <span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]  <span class="co"># VND billions</span></span>
<span id="cb28-1187"><a href="#cb28-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1188"><a href="#cb28-1188" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb28-1189"><a href="#cb28-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1190"><a href="#cb28-1190" aria-hidden="true" tabindex="-1"></a>selected_ports <span class="op">=</span> [<span class="st">'VW'</span>, <span class="st">'EW (Monthly)'</span>, <span class="st">'Capped VW (5%)'</span>,</span>
<span id="cb28-1191"><a href="#cb28-1191" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'Min Variance'</span>, <span class="st">'Risk Parity'</span>]</span>
<span id="cb28-1192"><a href="#cb28-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1193"><a href="#cb28-1193" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name <span class="kw">in</span> selected_ports:</span>
<span id="cb28-1194"><a href="#cb28-1194" aria-hidden="true" tabindex="-1"></a>    sharpes <span class="op">=</span> []</span>
<span id="cb28-1195"><a href="#cb28-1195" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> portfolios[name]</span>
<span id="cb28-1196"><a href="#cb28-1196" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1197"><a href="#cb28-1197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> aum <span class="kw">in</span> aum_levels:</span>
<span id="cb28-1198"><a href="#cb28-1198" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Cost scales with sqrt(AUM / ADV)</span></span>
<span id="cb28-1199"><a href="#cb28-1199" aria-hidden="true" tabindex="-1"></a>        base_cost <span class="op">=</span> <span class="fl">0.003</span>  <span class="co"># Base cost at small AUM</span></span>
<span id="cb28-1200"><a href="#cb28-1200" aria-hidden="true" tabindex="-1"></a>        scale_factor <span class="op">=</span> np.sqrt(aum <span class="op">/</span> <span class="dv">100</span>)  <span class="co"># Normalized to VND 100bn</span></span>
<span id="cb28-1201"><a href="#cb28-1201" aria-hidden="true" tabindex="-1"></a>        cost_rate <span class="op">=</span> base_cost <span class="op">*</span> scale_factor</span>
<span id="cb28-1202"><a href="#cb28-1202" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1203"><a href="#cb28-1203" aria-hidden="true" tabindex="-1"></a>        <span class="co"># VW is less affected (large-cap tilt)</span></span>
<span id="cb28-1204"><a href="#cb28-1204" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name <span class="op">==</span> <span class="st">'VW'</span>:</span>
<span id="cb28-1205"><a href="#cb28-1205" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.3</span></span>
<span id="cb28-1206"><a href="#cb28-1206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Capped'</span> <span class="kw">in</span> name:</span>
<span id="cb28-1207"><a href="#cb28-1207" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.5</span></span>
<span id="cb28-1208"><a href="#cb28-1208" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Min Variance'</span> <span class="kw">in</span> name <span class="kw">or</span> <span class="st">'Risk Parity'</span> <span class="kw">in</span> name:</span>
<span id="cb28-1209"><a href="#cb28-1209" aria-hidden="true" tabindex="-1"></a>            cost_rate <span class="op">*=</span> <span class="fl">0.7</span></span>
<span id="cb28-1210"><a href="#cb28-1210" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1211"><a href="#cb28-1211" aria-hidden="true" tabindex="-1"></a>        net_df <span class="op">=</span> compute_net_returns(df, cost_rate)</span>
<span id="cb28-1212"><a href="#cb28-1212" aria-hidden="true" tabindex="-1"></a>        rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-1213"><a href="#cb28-1213" aria-hidden="true" tabindex="-1"></a>        excess <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb28-1214"><a href="#cb28-1214" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> excess.mean() <span class="op">/</span> excess.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> excess.std() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb28-1215"><a href="#cb28-1215" aria-hidden="true" tabindex="-1"></a>        sharpes.append(s)</span>
<span id="cb28-1216"><a href="#cb28-1216" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1217"><a href="#cb28-1217" aria-hidden="true" tabindex="-1"></a>    ax.plot(aum_levels, sharpes, marker<span class="op">=</span><span class="st">'o'</span>, label<span class="op">=</span>name,</span>
<span id="cb28-1218"><a href="#cb28-1218" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>colors.get(name, <span class="st">'gray'</span>), linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb28-1219"><a href="#cb28-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1220"><a href="#cb28-1220" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Portfolio AUM (VND Billion)'</span>)</span>
<span id="cb28-1221"><a href="#cb28-1221" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Net Sharpe Ratio'</span>)</span>
<span id="cb28-1222"><a href="#cb28-1222" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Sharpe Ratio Degradation with AUM'</span>)</span>
<span id="cb28-1223"><a href="#cb28-1223" aria-hidden="true" tabindex="-1"></a>ax.set_xscale(<span class="st">'log'</span>)</span>
<span id="cb28-1224"><a href="#cb28-1224" aria-hidden="true" tabindex="-1"></a>ax.legend(fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-1225"><a href="#cb28-1225" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb28-1226"><a href="#cb28-1226" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1227"><a href="#cb28-1227" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1228"><a href="#cb28-1228" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1229"><a href="#cb28-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1230"><a href="#cb28-1230" aria-hidden="true" tabindex="-1"></a><span class="fu">## Rebalancing Frequency Analysis {#sec-weight-rebalancing}</span></span>
<span id="cb28-1231"><a href="#cb28-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1232"><a href="#cb28-1232" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Rebalancing Trade-Off</span></span>
<span id="cb28-1233"><a href="#cb28-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1234"><a href="#cb28-1234" aria-hidden="true" tabindex="-1"></a>Rebalancing serves two purposes: (i) restoring target weights to maintain the desired risk profile, and (ii) harvesting the "rebalancing bonus"‚Äîthe systematic profit from buying low and selling high that arises when weights are reset to targets in the presence of mean-reverting cross-sectional returns.</span>
<span id="cb28-1235"><a href="#cb28-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1236"><a href="#cb28-1236" aria-hidden="true" tabindex="-1"></a>The trade-off is clear: more frequent rebalancing maintains tighter adherence to target weights and captures more of the rebalancing bonus, but incurs higher transaction costs. The optimal frequency depends on the magnitude of mean reversion (which determines the gross rebalancing bonus), the level of transaction costs, and the rate at which weights drift from targets.</span>
<span id="cb28-1237"><a href="#cb28-1237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1240"><a href="#cb28-1240" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1241"><a href="#cb28-1241" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rebal-frequency</span></span>
<span id="cb28-1242"><a href="#cb28-1242" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1243"><a href="#cb28-1243" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Impact of rebalancing frequency on the equal-weighted portfolio. Panel A shows the gross and net Sharpe ratios. Panel B shows the decomposition of the rebalancing bonus. Quarterly rebalancing offers the best trade-off between capturing the rebalancing bonus and controlling costs in the Vietnamese market."</span></span>
<span id="cb28-1244"><a href="#cb28-1244" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Analyze rebalancing frequency impact on EW portfolio"</span></span>
<span id="cb28-1245"><a href="#cb28-1245" aria-hidden="true" tabindex="-1"></a>frequencies <span class="op">=</span> {</span>
<span id="cb28-1246"><a href="#cb28-1246" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Monthly'</span>: <span class="st">'M'</span>,</span>
<span id="cb28-1247"><a href="#cb28-1247" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Quarterly'</span>: <span class="st">'Q'</span>,</span>
<span id="cb28-1248"><a href="#cb28-1248" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Semi-annual'</span>: <span class="st">'Q'</span>,  <span class="co"># Approximate with every 6 months</span></span>
<span id="cb28-1249"><a href="#cb28-1249" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Annual'</span>: <span class="st">'A'</span></span>
<span id="cb28-1250"><a href="#cb28-1250" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-1251"><a href="#cb28-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1252"><a href="#cb28-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># Recompute EW at each frequency</span></span>
<span id="cb28-1253"><a href="#cb28-1253" aria-hidden="true" tabindex="-1"></a>freq_results <span class="op">=</span> {}</span>
<span id="cb28-1254"><a href="#cb28-1254" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> freq_name, freq_code <span class="kw">in</span> frequencies.items():</span>
<span id="cb28-1255"><a href="#cb28-1255" aria-hidden="true" tabindex="-1"></a>    freq_df <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-1256"><a href="#cb28-1256" aria-hidden="true" tabindex="-1"></a>        universe_mid, ew_weights, rebal_freq<span class="op">=</span>freq_code</span>
<span id="cb28-1257"><a href="#cb28-1257" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1258"><a href="#cb28-1258" aria-hidden="true" tabindex="-1"></a>    freq_results[freq_name] <span class="op">=</span> freq_df</span>
<span id="cb28-1259"><a href="#cb28-1259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1260"><a href="#cb28-1260" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb28-1261"><a href="#cb28-1261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1262"><a href="#cb28-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Gross vs Net Sharpe</span></span>
<span id="cb28-1263"><a href="#cb28-1263" aria-hidden="true" tabindex="-1"></a>freq_names <span class="op">=</span> <span class="bu">list</span>(freq_results.keys())</span>
<span id="cb28-1264"><a href="#cb28-1264" aria-hidden="true" tabindex="-1"></a>gross_sharpes <span class="op">=</span> []</span>
<span id="cb28-1265"><a href="#cb28-1265" aria-hidden="true" tabindex="-1"></a>net_sharpes <span class="op">=</span> []</span>
<span id="cb28-1266"><a href="#cb28-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1267"><a href="#cb28-1267" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> fn <span class="kw">in</span> freq_names:</span>
<span id="cb28-1268"><a href="#cb28-1268" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> freq_results[fn]</span>
<span id="cb28-1269"><a href="#cb28-1269" aria-hidden="true" tabindex="-1"></a>    rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-1270"><a href="#cb28-1270" aria-hidden="true" tabindex="-1"></a>    exc <span class="op">=</span> df[<span class="st">'port_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb28-1271"><a href="#cb28-1271" aria-hidden="true" tabindex="-1"></a>    gross_sharpes.append(exc.mean() <span class="op">/</span> exc.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb28-1272"><a href="#cb28-1272" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1273"><a href="#cb28-1273" aria-hidden="true" tabindex="-1"></a>    net_df <span class="op">=</span> compute_net_returns(df, <span class="fl">0.005</span>)</span>
<span id="cb28-1274"><a href="#cb28-1274" aria-hidden="true" tabindex="-1"></a>    exc_net <span class="op">=</span> net_df[<span class="st">'net_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb28-1275"><a href="#cb28-1275" aria-hidden="true" tabindex="-1"></a>    net_sharpes.append(exc_net.mean() <span class="op">/</span> exc_net.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb28-1276"><a href="#cb28-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1277"><a href="#cb28-1277" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(freq_names))</span>
<span id="cb28-1278"><a href="#cb28-1278" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].bar([i <span class="op">-</span> <span class="fl">0.15</span> <span class="cf">for</span> i <span class="kw">in</span> x], gross_sharpes, width<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb28-1279"><a href="#cb28-1279" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Gross'</span>)</span>
<span id="cb28-1280"><a href="#cb28-1280" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].bar([i <span class="op">+</span> <span class="fl">0.15</span> <span class="cf">for</span> i <span class="kw">in</span> x], net_sharpes, width<span class="op">=</span><span class="fl">0.3</span>,</span>
<span id="cb28-1281"><a href="#cb28-1281" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Net (50 bps)'</span>)</span>
<span id="cb28-1282"><a href="#cb28-1282" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(x)</span>
<span id="cb28-1283"><a href="#cb28-1283" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels(freq_names)</span>
<span id="cb28-1284"><a href="#cb28-1284" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Annualized Sharpe Ratio'</span>)</span>
<span id="cb28-1285"><a href="#cb28-1285" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Sharpe Ratio by Rebalancing Frequency'</span>)</span>
<span id="cb28-1286"><a href="#cb28-1286" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb28-1287"><a href="#cb28-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1288"><a href="#cb28-1288" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Average turnover</span></span>
<span id="cb28-1289"><a href="#cb28-1289" aria-hidden="true" tabindex="-1"></a>turnovers <span class="op">=</span> [freq_results[fn][<span class="st">'turnover'</span>].mean() <span class="cf">for</span> fn <span class="kw">in</span> freq_names]</span>
<span id="cb28-1290"><a href="#cb28-1290" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x, turnovers, color<span class="op">=</span><span class="st">'#E67E22'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>)</span>
<span id="cb28-1291"><a href="#cb28-1291" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(x)</span>
<span id="cb28-1292"><a href="#cb28-1292" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels(freq_names)</span>
<span id="cb28-1293"><a href="#cb28-1293" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Average Monthly Turnover'</span>)</span>
<span id="cb28-1294"><a href="#cb28-1294" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Turnover by Rebalancing Frequency'</span>)</span>
<span id="cb28-1295"><a href="#cb28-1295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1296"><a href="#cb28-1296" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1297"><a href="#cb28-1297" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1298"><a href="#cb28-1298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1299"><a href="#cb28-1299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1300"><a href="#cb28-1300" aria-hidden="true" tabindex="-1"></a><span class="fu">### Threshold-Based Rebalancing</span></span>
<span id="cb28-1301"><a href="#cb28-1301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1302"><a href="#cb28-1302" aria-hidden="true" tabindex="-1"></a>An alternative to calendar-based rebalancing is to rebalance only when portfolio weights drift beyond a tolerance band. This "no-trade zone" approach is motivated by @garleanu2013dynamic, who derive the optimal dynamic trading strategy under quadratic transaction costs and show that the optimal portfolio is a weighted average of the current holdings and the frictionless target.</span>
<span id="cb28-1303"><a href="#cb28-1303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1306"><a href="#cb28-1306" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1307"><a href="#cb28-1307" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: threshold-rebalancing</span></span>
<span id="cb28-1308"><a href="#cb28-1308" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1309"><a href="#cb28-1309" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement threshold-based rebalancing for EW portfolio"</span></span>
<span id="cb28-1310"><a href="#cb28-1310" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_threshold_rebalanced(monthly_df, weight_fn,</span>
<span id="cb28-1311"><a href="#cb28-1311" aria-hidden="true" tabindex="-1"></a>                                  threshold<span class="op">=</span><span class="fl">0.01</span>):</span>
<span id="cb28-1312"><a href="#cb28-1312" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb28-1313"><a href="#cb28-1313" aria-hidden="true" tabindex="-1"></a><span class="co">    Rebalance only when maximum weight deviation exceeds threshold.</span></span>
<span id="cb28-1314"><a href="#cb28-1314" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb28-1315"><a href="#cb28-1315" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb28-1316"><a href="#cb28-1316" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb28-1317"><a href="#cb28-1317" aria-hidden="true" tabindex="-1"></a><span class="co">    threshold : float</span></span>
<span id="cb28-1318"><a href="#cb28-1318" aria-hidden="true" tabindex="-1"></a><span class="co">        Rebalance when max(|w_actual - w_target|) &gt; threshold.</span></span>
<span id="cb28-1319"><a href="#cb28-1319" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb28-1320"><a href="#cb28-1320" aria-hidden="true" tabindex="-1"></a>    months <span class="op">=</span> <span class="bu">sorted</span>(monthly_df[<span class="st">'month_end'</span>].unique())</span>
<span id="cb28-1321"><a href="#cb28-1321" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb28-1322"><a href="#cb28-1322" aria-hidden="true" tabindex="-1"></a>    current_weights <span class="op">=</span> <span class="va">None</span></span>
<span id="cb28-1323"><a href="#cb28-1323" aria-hidden="true" tabindex="-1"></a>    rebalance_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-1324"><a href="#cb28-1324" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1325"><a href="#cb28-1325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb28-1326"><a href="#cb28-1326" aria-hidden="true" tabindex="-1"></a>        cs <span class="op">=</span> monthly_df[monthly_df[<span class="st">'month_end'</span>] <span class="op">==</span> month].copy()</span>
<span id="cb28-1327"><a href="#cb28-1327" aria-hidden="true" tabindex="-1"></a>        cs <span class="op">=</span> cs.dropna(subset<span class="op">=</span>[<span class="st">'monthly_return'</span>]).set_index(<span class="st">'ticker'</span>)</span>
<span id="cb28-1328"><a href="#cb28-1328" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1329"><a href="#cb28-1329" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cs) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb28-1330"><a href="#cb28-1330" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb28-1331"><a href="#cb28-1331" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1332"><a href="#cb28-1332" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> weight_fn(cs.reset_index())</span>
<span id="cb28-1333"><a href="#cb28-1333" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> target <span class="op">/</span> target.<span class="bu">sum</span>()</span>
<span id="cb28-1334"><a href="#cb28-1334" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1335"><a href="#cb28-1335" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_weights <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb28-1336"><a href="#cb28-1336" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> target.copy()</span>
<span id="cb28-1337"><a href="#cb28-1337" aria-hidden="true" tabindex="-1"></a>            rebalance_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb28-1338"><a href="#cb28-1338" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb28-1339"><a href="#cb28-1339" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Drift weights</span></span>
<span id="cb28-1340"><a href="#cb28-1340" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> current_weights.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-1341"><a href="#cb28-1341" aria-hidden="true" tabindex="-1"></a>            current_weights <span class="op">=</span> current_weights <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> cs[<span class="st">'monthly_return'</span>])</span>
<span id="cb28-1342"><a href="#cb28-1342" aria-hidden="true" tabindex="-1"></a>            total <span class="op">=</span> current_weights.<span class="bu">sum</span>()</span>
<span id="cb28-1343"><a href="#cb28-1343" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb28-1344"><a href="#cb28-1344" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> current_weights <span class="op">/</span> total</span>
<span id="cb28-1345"><a href="#cb28-1345" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-1346"><a href="#cb28-1346" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check if rebalancing needed</span></span>
<span id="cb28-1347"><a href="#cb28-1347" aria-hidden="true" tabindex="-1"></a>            max_dev <span class="op">=</span> (current_weights <span class="op">-</span> target.reindex(</span>
<span id="cb28-1348"><a href="#cb28-1348" aria-hidden="true" tabindex="-1"></a>                current_weights.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb28-1349"><a href="#cb28-1349" aria-hidden="true" tabindex="-1"></a>            )).<span class="bu">abs</span>().<span class="bu">max</span>()</span>
<span id="cb28-1350"><a href="#cb28-1350" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb28-1351"><a href="#cb28-1351" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> max_dev <span class="op">&gt;</span> threshold:</span>
<span id="cb28-1352"><a href="#cb28-1352" aria-hidden="true" tabindex="-1"></a>                turnover <span class="op">=</span> (current_weights <span class="op">-</span> target.reindex(</span>
<span id="cb28-1353"><a href="#cb28-1353" aria-hidden="true" tabindex="-1"></a>                    current_weights.index, fill_value<span class="op">=</span><span class="dv">0</span></span>
<span id="cb28-1354"><a href="#cb28-1354" aria-hidden="true" tabindex="-1"></a>                )).<span class="bu">abs</span>().<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb28-1355"><a href="#cb28-1355" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> target.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb28-1356"><a href="#cb28-1356" aria-hidden="true" tabindex="-1"></a>                current_weights <span class="op">=</span> current_weights <span class="op">/</span> current_weights.<span class="bu">sum</span>()</span>
<span id="cb28-1357"><a href="#cb28-1357" aria-hidden="true" tabindex="-1"></a>                rebalance_count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb28-1358"><a href="#cb28-1358" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb28-1359"><a href="#cb28-1359" aria-hidden="true" tabindex="-1"></a>                turnover <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb28-1360"><a href="#cb28-1360" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1361"><a href="#cb28-1361" aria-hidden="true" tabindex="-1"></a>        port_ret <span class="op">=</span> (current_weights.reindex(cs.index, fill_value<span class="op">=</span><span class="dv">0</span>) <span class="op">*</span></span>
<span id="cb28-1362"><a href="#cb28-1362" aria-hidden="true" tabindex="-1"></a>                    cs[<span class="st">'monthly_return'</span>]).<span class="bu">sum</span>()</span>
<span id="cb28-1363"><a href="#cb28-1363" aria-hidden="true" tabindex="-1"></a>        hhi <span class="op">=</span> (current_weights <span class="op">**</span> <span class="dv">2</span>).<span class="bu">sum</span>()</span>
<span id="cb28-1364"><a href="#cb28-1364" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb28-1365"><a href="#cb28-1365" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb28-1366"><a href="#cb28-1366" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month,</span>
<span id="cb28-1367"><a href="#cb28-1367" aria-hidden="true" tabindex="-1"></a>            <span class="st">'port_return'</span>: port_ret,</span>
<span id="cb28-1368"><a href="#cb28-1368" aria-hidden="true" tabindex="-1"></a>            <span class="st">'turnover'</span>: turnover,</span>
<span id="cb28-1369"><a href="#cb28-1369" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hhi'</span>: hhi,</span>
<span id="cb28-1370"><a href="#cb28-1370" aria-hidden="true" tabindex="-1"></a>            <span class="st">'effective_n'</span>: <span class="dv">1</span><span class="op">/</span>hhi <span class="cf">if</span> hhi <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>,</span>
<span id="cb28-1371"><a href="#cb28-1371" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_stocks'</span>: (current_weights <span class="op">&gt;</span> <span class="fl">1e-6</span>).<span class="bu">sum</span>()</span>
<span id="cb28-1372"><a href="#cb28-1372" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb28-1373"><a href="#cb28-1373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1374"><a href="#cb28-1374" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Threshold </span><span class="sc">{</span>threshold<span class="sc">:.1%}</span><span class="ss">: rebalanced </span><span class="sc">{</span>rebalance_count<span class="sc">}</span><span class="ss"> / "</span></span>
<span id="cb28-1375"><a href="#cb28-1375" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span><span class="bu">len</span>(results)<span class="sc">}</span><span class="ss"> months (</span><span class="sc">{</span>rebalance_count<span class="op">/</span><span class="bu">len</span>(results)<span class="sc">:.0%}</span><span class="ss">)"</span>)</span>
<span id="cb28-1376"><a href="#cb28-1376" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb28-1377"><a href="#cb28-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1378"><a href="#cb28-1378" aria-hidden="true" tabindex="-1"></a><span class="co"># Test different thresholds</span></span>
<span id="cb28-1379"><a href="#cb28-1379" aria-hidden="true" tabindex="-1"></a>thresholds <span class="op">=</span> [<span class="fl">0.005</span>, <span class="fl">0.01</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>]</span>
<span id="cb28-1380"><a href="#cb28-1380" aria-hidden="true" tabindex="-1"></a>threshold_results <span class="op">=</span> {}</span>
<span id="cb28-1381"><a href="#cb28-1381" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> t <span class="kw">in</span> thresholds:</span>
<span id="cb28-1382"><a href="#cb28-1382" aria-hidden="true" tabindex="-1"></a>    threshold_results[<span class="ss">f'</span><span class="sc">{</span>t<span class="sc">:.1%}</span><span class="ss">'</span>] <span class="op">=</span> compute_threshold_rebalanced(</span>
<span id="cb28-1383"><a href="#cb28-1383" aria-hidden="true" tabindex="-1"></a>        universe_mid, ew_weights, threshold<span class="op">=</span>t</span>
<span id="cb28-1384"><a href="#cb28-1384" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1385"><a href="#cb28-1385" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1386"><a href="#cb28-1386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1387"><a href="#cb28-1387" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Rebalancing Bonus: Decomposition {#sec-weight-rebalancing-bonus}</span></span>
<span id="cb28-1388"><a href="#cb28-1388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1389"><a href="#cb28-1389" aria-hidden="true" tabindex="-1"></a>The excess return of the rebalanced EW portfolio over a buy-and-hold EW portfolio (which starts equal-weighted but drifts) can be decomposed following @plyakha2021equal. Define $r_i$ as the return of stock $i$ over one period:</span>
<span id="cb28-1390"><a href="#cb28-1390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1391"><a href="#cb28-1391" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1392"><a href="#cb28-1392" aria-hidden="true" tabindex="-1"></a>R^{EW}_{\text{rebal}} - R^{EW}_{\text{drift}} \approx \frac{1}{2N} \sum_{i=1}^N \text{Var}(r_i) - \frac{1}{2N^2}\sum_{i}\sum_{j}\text{Cov}(r_i, r_j)</span>
<span id="cb28-1393"><a href="#cb28-1393" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rebal-bonus}</span>
<span id="cb28-1394"><a href="#cb28-1394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1395"><a href="#cb28-1395" aria-hidden="true" tabindex="-1"></a>The first term captures the "buy low, sell high" effect from resetting weights after return dispersion. The second term is the cost of undoing covariance-induced drift. The rebalancing bonus is larger when cross-sectional return dispersion is high (which it is in Vietnam) and when pairwise correlations are low.</span>
<span id="cb28-1396"><a href="#cb28-1396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1399"><a href="#cb28-1399" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1400"><a href="#cb28-1400" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rebalancing-bonus</span></span>
<span id="cb28-1401"><a href="#cb28-1401" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1402"><a href="#cb28-1402" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Estimate the rebalancing bonus for Vietnamese equities"</span></span>
<span id="cb28-1403"><a href="#cb28-1403" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute buy-and-hold EW portfolio (no rebalancing after initial equal weight)</span></span>
<span id="cb28-1404"><a href="#cb28-1404" aria-hidden="true" tabindex="-1"></a>bh_returns <span class="op">=</span> compute_portfolio_returns(</span>
<span id="cb28-1405"><a href="#cb28-1405" aria-hidden="true" tabindex="-1"></a>    universe_mid, ew_weights, rebal_freq<span class="op">=</span><span class="st">'A'</span>  <span class="co"># Rebalance once per year only</span></span>
<span id="cb28-1406"><a href="#cb28-1406" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1407"><a href="#cb28-1407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1408"><a href="#cb28-1408" aria-hidden="true" tabindex="-1"></a><span class="co"># The rebalancing bonus is the difference</span></span>
<span id="cb28-1409"><a href="#cb28-1409" aria-hidden="true" tabindex="-1"></a>bonus_df <span class="op">=</span> pd.merge(</span>
<span id="cb28-1410"><a href="#cb28-1410" aria-hidden="true" tabindex="-1"></a>    ew_monthly[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]].rename(</span>
<span id="cb28-1411"><a href="#cb28-1411" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'port_return'</span>: <span class="st">'rebal_return'</span>}),</span>
<span id="cb28-1412"><a href="#cb28-1412" aria-hidden="true" tabindex="-1"></a>    bh_returns[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]].rename(</span>
<span id="cb28-1413"><a href="#cb28-1413" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'port_return'</span>: <span class="st">'bh_return'</span>}),</span>
<span id="cb28-1414"><a href="#cb28-1414" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb28-1415"><a href="#cb28-1415" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1416"><a href="#cb28-1416" aria-hidden="true" tabindex="-1"></a>bonus_df[<span class="st">'bonus'</span>] <span class="op">=</span> bonus_df[<span class="st">'rebal_return'</span>] <span class="op">-</span> bonus_df[<span class="st">'bh_return'</span>]</span>
<span id="cb28-1417"><a href="#cb28-1417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1418"><a href="#cb28-1418" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional return dispersion</span></span>
<span id="cb28-1419"><a href="#cb28-1419" aria-hidden="true" tabindex="-1"></a>dispersion <span class="op">=</span> (</span>
<span id="cb28-1420"><a href="#cb28-1420" aria-hidden="true" tabindex="-1"></a>    universe_mid</span>
<span id="cb28-1421"><a href="#cb28-1421" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb28-1422"><a href="#cb28-1422" aria-hidden="true" tabindex="-1"></a>    .std()</span>
<span id="cb28-1423"><a href="#cb28-1423" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'cs_dispersion'</span>)</span>
<span id="cb28-1424"><a href="#cb28-1424" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1425"><a href="#cb28-1425" aria-hidden="true" tabindex="-1"></a>bonus_df <span class="op">=</span> bonus_df.merge(dispersion, on<span class="op">=</span><span class="st">'month_end'</span>)</span>
<span id="cb28-1426"><a href="#cb28-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1427"><a href="#cb28-1427" aria-hidden="true" tabindex="-1"></a>ann_bonus <span class="op">=</span> bonus_df[<span class="st">'bonus'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb28-1428"><a href="#cb28-1428" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Annualized rebalancing bonus (EW monthly vs annual): </span><span class="sc">{</span>ann_bonus<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-1429"><a href="#cb28-1429" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Mean cross-sectional dispersion: </span><span class="sc">{</span>bonus_df[<span class="st">'cs_dispersion'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb28-1430"><a href="#cb28-1430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1431"><a href="#cb28-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1434"><a href="#cb28-1434" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1435"><a href="#cb28-1435" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rebal-bonus-time</span></span>
<span id="cb28-1436"><a href="#cb28-1436" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1437"><a href="#cb28-1437" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Monthly rebalancing bonus (EW monthly minus EW annual) alongside cross-sectional return dispersion. The bonus is higher in periods of high dispersion, consistent with the theoretical prediction that rebalancing profits from mean reversion in individual stock returns."</span></span>
<span id="cb28-1438"><a href="#cb28-1438" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot rebalancing bonus over time"</span></span>
<span id="cb28-1439"><a href="#cb28-1439" aria-hidden="true" tabindex="-1"></a>fig, ax1 <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb28-1440"><a href="#cb28-1440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1441"><a href="#cb28-1441" aria-hidden="true" tabindex="-1"></a>ax1.bar(pd.to_datetime(bonus_df[<span class="st">'month_end'</span>]),</span>
<span id="cb28-1442"><a href="#cb28-1442" aria-hidden="true" tabindex="-1"></a>        bonus_df[<span class="st">'bonus'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb28-1443"><a href="#cb28-1443" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, width<span class="op">=</span><span class="dv">25</span>, label<span class="op">=</span><span class="st">'Rebal. Bonus'</span>)</span>
<span id="cb28-1444"><a href="#cb28-1444" aria-hidden="true" tabindex="-1"></a>ax1.set_ylabel(<span class="st">'Rebalancing Bonus (%)'</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>)</span>
<span id="cb28-1445"><a href="#cb28-1445" aria-hidden="true" tabindex="-1"></a>ax1.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb28-1446"><a href="#cb28-1446" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1447"><a href="#cb28-1447" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> ax1.twinx()</span>
<span id="cb28-1448"><a href="#cb28-1448" aria-hidden="true" tabindex="-1"></a>ax2.plot(pd.to_datetime(bonus_df[<span class="st">'month_end'</span>]),</span>
<span id="cb28-1449"><a href="#cb28-1449" aria-hidden="true" tabindex="-1"></a>         bonus_df[<span class="st">'cs_dispersion'</span>],</span>
<span id="cb28-1450"><a href="#cb28-1450" aria-hidden="true" tabindex="-1"></a>         color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, alpha<span class="op">=</span><span class="fl">0.7</span>,</span>
<span id="cb28-1451"><a href="#cb28-1451" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">'CS Dispersion'</span>)</span>
<span id="cb28-1452"><a href="#cb28-1452" aria-hidden="true" tabindex="-1"></a>ax2.set_ylabel(<span class="st">'Cross-Sectional Return Dispersion'</span>, color<span class="op">=</span><span class="st">'#C0392B'</span>)</span>
<span id="cb28-1453"><a href="#cb28-1453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1454"><a href="#cb28-1454" aria-hidden="true" tabindex="-1"></a>ax1.set_title(<span class="st">'Rebalancing Bonus and Return Dispersion'</span>)</span>
<span id="cb28-1455"><a href="#cb28-1455" aria-hidden="true" tabindex="-1"></a>lines1, labels1 <span class="op">=</span> ax1.get_legend_handles_labels()</span>
<span id="cb28-1456"><a href="#cb28-1456" aria-hidden="true" tabindex="-1"></a>lines2, labels2 <span class="op">=</span> ax2.get_legend_handles_labels()</span>
<span id="cb28-1457"><a href="#cb28-1457" aria-hidden="true" tabindex="-1"></a>ax1.legend(lines1 <span class="op">+</span> lines2, labels1 <span class="op">+</span> labels2, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb28-1458"><a href="#cb28-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1459"><a href="#cb28-1459" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1460"><a href="#cb28-1460" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1461"><a href="#cb28-1461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1462"><a href="#cb28-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1463"><a href="#cb28-1463" aria-hidden="true" tabindex="-1"></a><span class="fu">## Factor Exposure Analysis {#sec-weight-factor-exposure}</span></span>
<span id="cb28-1464"><a href="#cb28-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1465"><a href="#cb28-1465" aria-hidden="true" tabindex="-1"></a>Different weighting schemes induce different factor exposures, which may explain their return differences. We regress each portfolio's excess returns on the Vietnamese Fama-French factors:</span>
<span id="cb28-1466"><a href="#cb28-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1467"><a href="#cb28-1467" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb28-1468"><a href="#cb28-1468" aria-hidden="true" tabindex="-1"></a>R_{p,t} - R_{f,t} = \alpha_p + \beta_p^{MKT}(R_{m,t} - R_{f,t}) + \beta_p^{SMB} \text{SMB}_t + \beta_p^{HML} \text{HML}_t + \varepsilon_{p,t}</span>
<span id="cb28-1469"><a href="#cb28-1469" aria-hidden="true" tabindex="-1"></a>$$ {#eq-factor-regression}</span>
<span id="cb28-1470"><a href="#cb28-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1473"><a href="#cb28-1473" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1474"><a href="#cb28-1474" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: factor-regressions</span></span>
<span id="cb28-1475"><a href="#cb28-1475" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1476"><a href="#cb28-1476" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Regress portfolio returns on Fama-French-Carhart factors"</span></span>
<span id="cb28-1477"><a href="#cb28-1477" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve Vietnamese factor returns from DataCore</span></span>
<span id="cb28-1478"><a href="#cb28-1478" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> client.get_factor_returns(</span>
<span id="cb28-1479"><a href="#cb28-1479" aria-hidden="true" tabindex="-1"></a>    market<span class="op">=</span><span class="st">'vietnam'</span>,</span>
<span id="cb28-1480"><a href="#cb28-1480" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2012-01-01'</span>,</span>
<span id="cb28-1481"><a href="#cb28-1481" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb28-1482"><a href="#cb28-1482" aria-hidden="true" tabindex="-1"></a>    factors<span class="op">=</span>[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>]</span>
<span id="cb28-1483"><a href="#cb28-1483" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-1484"><a href="#cb28-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1485"><a href="#cb28-1485" aria-hidden="true" tabindex="-1"></a><span class="co"># Run factor regressions for each portfolio</span></span>
<span id="cb28-1486"><a href="#cb28-1486" aria-hidden="true" tabindex="-1"></a>factor_results <span class="op">=</span> {}</span>
<span id="cb28-1487"><a href="#cb28-1487" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, df <span class="kw">in</span> portfolios.items():</span>
<span id="cb28-1488"><a href="#cb28-1488" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.merge(</span>
<span id="cb28-1489"><a href="#cb28-1489" aria-hidden="true" tabindex="-1"></a>        df[[<span class="st">'month_end'</span>, <span class="st">'port_return'</span>]],</span>
<span id="cb28-1490"><a href="#cb28-1490" aria-hidden="true" tabindex="-1"></a>        factors,</span>
<span id="cb28-1491"><a href="#cb28-1491" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb28-1492"><a href="#cb28-1492" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-1493"><a href="#cb28-1493" aria-hidden="true" tabindex="-1"></a>    rf_m <span class="op">=</span> (<span class="fl">1.04</span>) <span class="op">**</span> (<span class="dv">1</span><span class="op">/</span><span class="dv">12</span>) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb28-1494"><a href="#cb28-1494" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'excess'</span>] <span class="op">=</span> merged[<span class="st">'port_return'</span>] <span class="op">-</span> rf_m</span>
<span id="cb28-1495"><a href="#cb28-1495" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1496"><a href="#cb28-1496" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb28-1497"><a href="#cb28-1497" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'excess'</span>],</span>
<span id="cb28-1498"><a href="#cb28-1498" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(merged[[<span class="st">'mkt_excess'</span>, <span class="st">'smb'</span>, <span class="st">'hml'</span>, <span class="st">'wml'</span>]])</span>
<span id="cb28-1499"><a href="#cb28-1499" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>})</span>
<span id="cb28-1500"><a href="#cb28-1500" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-1501"><a href="#cb28-1501" aria-hidden="true" tabindex="-1"></a>    factor_results[name] <span class="op">=</span> {</span>
<span id="cb28-1502"><a href="#cb28-1502" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alpha (ann.)'</span>: model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb28-1503"><a href="#cb28-1503" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Alpha t-stat'</span>: model.tvalues[<span class="st">'const'</span>],</span>
<span id="cb28-1504"><a href="#cb28-1504" aria-hidden="true" tabindex="-1"></a>        <span class="st">'MKT'</span>: model.params[<span class="st">'mkt_excess'</span>],</span>
<span id="cb28-1505"><a href="#cb28-1505" aria-hidden="true" tabindex="-1"></a>        <span class="st">'SMB'</span>: model.params[<span class="st">'smb'</span>],</span>
<span id="cb28-1506"><a href="#cb28-1506" aria-hidden="true" tabindex="-1"></a>        <span class="st">'HML'</span>: model.params[<span class="st">'hml'</span>],</span>
<span id="cb28-1507"><a href="#cb28-1507" aria-hidden="true" tabindex="-1"></a>        <span class="st">'WML'</span>: model.params[<span class="st">'wml'</span>],</span>
<span id="cb28-1508"><a href="#cb28-1508" aria-hidden="true" tabindex="-1"></a>        <span class="st">'R¬≤'</span>: model.rsquared</span>
<span id="cb28-1509"><a href="#cb28-1509" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-1510"><a href="#cb28-1510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1511"><a href="#cb28-1511" aria-hidden="true" tabindex="-1"></a>factor_df <span class="op">=</span> pd.DataFrame(factor_results).T</span>
<span id="cb28-1512"><a href="#cb28-1512" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(factor_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb28-1513"><a href="#cb28-1513" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1514"><a href="#cb28-1514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1517"><a href="#cb28-1517" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb28-1518"><a href="#cb28-1518" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-factor-exposures</span></span>
<span id="cb28-1519"><a href="#cb28-1519" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-1520"><a href="#cb28-1520" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Factor loadings by weighting scheme. Equal-weighted portfolios have large positive SMB loadings, confirming their mechanical size tilt. Minimum variance portfolios load negatively on the market factor (beta &lt; 1 by construction). The annualized alpha column reveals whether each scheme generates risk-adjusted returns beyond its factor exposures."</span></span>
<span id="cb28-1521"><a href="#cb28-1521" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Heatmap of factor exposures across weighting schemes"</span></span>
<span id="cb28-1522"><a href="#cb28-1522" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb28-1523"><a href="#cb28-1523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1524"><a href="#cb28-1524" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> factor_df[[<span class="st">'MKT'</span>, <span class="st">'SMB'</span>, <span class="st">'HML'</span>, <span class="st">'WML'</span>]].copy()</span>
<span id="cb28-1525"><a href="#cb28-1525" aria-hidden="true" tabindex="-1"></a>im <span class="op">=</span> ax.imshow(plot_data.values, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>, aspect<span class="op">=</span><span class="st">'auto'</span>,</span>
<span id="cb28-1526"><a href="#cb28-1526" aria-hidden="true" tabindex="-1"></a>               vmin<span class="op">=-</span><span class="fl">1.5</span>, vmax<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb28-1527"><a href="#cb28-1527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1528"><a href="#cb28-1528" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(plot_data.columns)))</span>
<span id="cb28-1529"><a href="#cb28-1529" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(plot_data.columns, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb28-1530"><a href="#cb28-1530" aria-hidden="true" tabindex="-1"></a>ax.set_yticks(<span class="bu">range</span>(<span class="bu">len</span>(plot_data.index)))</span>
<span id="cb28-1531"><a href="#cb28-1531" aria-hidden="true" tabindex="-1"></a>ax.set_yticklabels(plot_data.index, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-1532"><a href="#cb28-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1533"><a href="#cb28-1533" aria-hidden="true" tabindex="-1"></a><span class="co"># Add text annotations</span></span>
<span id="cb28-1534"><a href="#cb28-1534" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(plot_data.index)):</span>
<span id="cb28-1535"><a href="#cb28-1535" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(plot_data.columns)):</span>
<span id="cb28-1536"><a href="#cb28-1536" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> plot_data.values[i, j]</span>
<span id="cb28-1537"><a href="#cb28-1537" aria-hidden="true" tabindex="-1"></a>        color <span class="op">=</span> <span class="st">'white'</span> <span class="cf">if</span> <span class="bu">abs</span>(val) <span class="op">&gt;</span> <span class="fl">0.8</span> <span class="cf">else</span> <span class="st">'black'</span></span>
<span id="cb28-1538"><a href="#cb28-1538" aria-hidden="true" tabindex="-1"></a>        ax.text(j, i, <span class="ss">f'</span><span class="sc">{</span>val<span class="sc">:.2f}</span><span class="ss">'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>,</span>
<span id="cb28-1539"><a href="#cb28-1539" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb28-1540"><a href="#cb28-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1541"><a href="#cb28-1541" aria-hidden="true" tabindex="-1"></a>plt.colorbar(im, ax<span class="op">=</span>ax, label<span class="op">=</span><span class="st">'Factor Loading'</span>)</span>
<span id="cb28-1542"><a href="#cb28-1542" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Factor Exposures by Weighting Scheme'</span>)</span>
<span id="cb28-1543"><a href="#cb28-1543" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb28-1544"><a href="#cb28-1544" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb28-1545"><a href="#cb28-1545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-1546"><a href="#cb28-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1547"><a href="#cb28-1547" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Guidance for Vietnam {#sec-weight-practical}</span></span>
<span id="cb28-1548"><a href="#cb28-1548" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1549"><a href="#cb28-1549" aria-hidden="true" tabindex="-1"></a>The preceding analysis yields several practical recommendations for researchers and investors working with Vietnamese equities:</span>
<span id="cb28-1550"><a href="#cb28-1550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1551"><a href="#cb28-1551" aria-hidden="true" tabindex="-1"></a>**For academic factor research:** VW portfolios remain the default for asset pricing tests because they represent the investable opportunity set and avoid inflating alpha estimates with small-cap illiquidity premia. When EW portfolios are used (e.g., to give equal influence to each stock in cross-sectional sorts), researchers should report both VW and EW results and discuss the sensitivity. @fama2008dissecting follow this practice systematically.</span>
<span id="cb28-1552"><a href="#cb28-1552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1553"><a href="#cb28-1553" aria-hidden="true" tabindex="-1"></a>**For fund management:** The choice depends on AUM and mandate. At AUM below VND 500 billion, capped VW or fundamental weighting offers a practical compromise between diversification and implementability. At larger AUM, pure VW or sector-capped VW is more realistic. Risk parity and minimum variance are suitable for low-volatility mandates but require robust covariance estimation and quarterly rebalancing.</span>
<span id="cb28-1554"><a href="#cb28-1554" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1555"><a href="#cb28-1555" aria-hidden="true" tabindex="-1"></a>**For index construction:** Vietnamese index providers (VN30, VNINDEX) use variants of capped VW. The analysis suggests that the cap level significantly affects the index's diversification properties and tracking error relative to the uncapped VW market. A 10% cap balances concentration reduction against turnover.</span>
<span id="cb28-1556"><a href="#cb28-1556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1557"><a href="#cb28-1557" aria-hidden="true" tabindex="-1"></a>**For transaction cost management:** In all schemes, the marginal benefit of rebalancing declines faster than the marginal cost as frequency increases beyond quarterly. Calendar-based quarterly rebalancing or threshold-based rebalancing (with a 1‚Äì2% tolerance band) provides the best cost-benefit trade-off in the Vietnamese market.</span>
<span id="cb28-1558"><a href="#cb28-1558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1559"><a href="#cb28-1559" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary {#sec-weight-summary}</span></span>
<span id="cb28-1560"><a href="#cb28-1560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1561"><a href="#cb28-1561" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Dimension <span class="pp">|</span> VW <span class="pp">|</span> EW <span class="pp">|</span> Capped VW <span class="pp">|</span> Fundamental <span class="pp">|</span> Min Var <span class="pp">|</span> Risk Parity <span class="pp">|</span></span>
<span id="cb28-1562"><a href="#cb28-1562" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------|-----------|-----------|-----------|-----------|-----------|-----------|</span></span>
<span id="cb28-1563"><a href="#cb28-1563" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Turnover <span class="pp">|</span> Very low <span class="pp">|</span> High <span class="pp">|</span> Low <span class="pp">|</span> Low <span class="pp">|</span> Moderate <span class="pp">|</span> Moderate <span class="pp">|</span></span>
<span id="cb28-1564"><a href="#cb28-1564" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Concentration <span class="pp">|</span> High <span class="pp">|</span> None <span class="pp">|</span> Moderate <span class="pp">|</span> Moderate <span class="pp">|</span> Variable <span class="pp">|</span> Low <span class="pp">|</span></span>
<span id="cb28-1565"><a href="#cb28-1565" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Size tilt <span class="pp">|</span> Large <span class="pp">|</span> Small <span class="pp">|</span> Moderate <span class="pp">|</span> Large-mid <span class="pp">|</span> Low-vol <span class="pp">|</span> Mixed <span class="pp">|</span></span>
<span id="cb28-1566"><a href="#cb28-1566" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Data required <span class="pp">|</span> Prices <span class="pp">|</span> None <span class="pp">|</span> Prices <span class="pp">|</span> Accounting <span class="pp">|</span> Returns cov. <span class="pp">|</span> Returns cov. <span class="pp">|</span></span>
<span id="cb28-1567"><a href="#cb28-1567" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Scale sensitivity <span class="pp">|</span> Low <span class="pp">|</span> High <span class="pp">|</span> Low <span class="pp">|</span> Low <span class="pp">|</span> Moderate <span class="pp">|</span> Moderate <span class="pp">|</span></span>
<span id="cb28-1568"><a href="#cb28-1568" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Rebal. frequency <span class="pp">|</span> Passive <span class="pp">|</span> Monthly <span class="pp">|</span> Monthly/Quarterly <span class="pp">|</span> Annual <span class="pp">|</span> Quarterly <span class="pp">|</span> Quarterly <span class="pp">|</span></span>
<span id="cb28-1569"><a href="#cb28-1569" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Best use case <span class="pp">|</span> Benchmarks, large AUM <span class="pp">|</span> Cross-sectional tests <span class="pp">|</span> Index tracking <span class="pp">|</span> Long-term investing <span class="pp">|</span> Low-vol mandates <span class="pp">|</span> Balanced risk <span class="pp">|</span></span>
<span id="cb28-1570"><a href="#cb28-1570" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1571"><a href="#cb28-1571" aria-hidden="true" tabindex="-1"></a>: Summary comparison of weighting schemes for Vietnamese equities. {#tbl-weight-final-comparison}</span>
<span id="cb28-1572"><a href="#cb28-1572" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1573"><a href="#cb28-1573" aria-hidden="true" tabindex="-1"></a>The choice of weighting scheme is not merely a technical detail‚Äîit reflects a substantive economic decision about the relative importance of diversification, investability, and cost control. In the Vietnamese market, where the capitalization distribution is highly skewed and small-cap liquidity is thin, this choice has larger consequences than in developed markets. Researchers who report results under only one weighting scheme risk conclusions that are specific to that scheme rather than reflective of a genuine economic relationship.</span>
<span id="cb28-1574"><a href="#cb28-1574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1575"><a href="#cb28-1575" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb28-1576"><a href="#cb28-1576" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- ## Exercises {#sec-weight-exercises}</span></span>
<span id="cb28-1577"><a href="#cb28-1577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1578"><a href="#cb28-1578" aria-hidden="true" tabindex="-1"></a><span class="in">1. **Inverse volatility weighting.** Implement a weighting scheme where $w_i \propto 1/\sigma_i$ (inverse of trailing 60-day volatility). Compare its performance to equal-weight and risk parity. How does it differ from minimum variance?</span></span>
<span id="cb28-1579"><a href="#cb28-1579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1580"><a href="#cb28-1580" aria-hidden="true" tabindex="-1"></a><span class="in">2. **Turnover-constrained optimization.** Modify the minimum variance portfolio to include a turnover constraint: $\sum_i |w_i - w_{i,\text{prev}}| \leq \tau$ for a given turnover budget $\tau$. Solve this as a quadratic program with linear constraints. How does the frontier of risk vs. turnover look?</span></span>
<span id="cb28-1581"><a href="#cb28-1581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1582"><a href="#cb28-1582" aria-hidden="true" tabindex="-1"></a><span class="in">3. **Liquidity-weighted portfolios.** Construct a portfolio where weights are proportional to average daily turnover rather than market cap. What economic interpretation does this portfolio have? How does it compare to VW in terms of factor exposures?</span></span>
<span id="cb28-1583"><a href="#cb28-1583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1584"><a href="#cb28-1584" aria-hidden="true" tabindex="-1"></a><span class="in">4. **VN30 replication.** The VN30 index comprises the 30 largest and most liquid stocks on HOSE with a 10% cap. Replicate its construction rules using DataCore.vn data and compare the tracking error of your replication against the official VN30 index.</span></span>
<span id="cb28-1585"><a href="#cb28-1585" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1586"><a href="#cb28-1586" aria-hidden="true" tabindex="-1"></a><span class="in">5. **Conditional rebalancing bonus.** Estimate the rebalancing bonus separately in bull markets (VN-Index return &gt; 0) and bear markets (VN-Index return &lt; 0). Is the bonus pro-cyclical or counter-cyclical? Relate your findings to the cross-sectional dispersion pattern in @fig-rebal-bonus-time.</span></span>
<span id="cb28-1587"><a href="#cb28-1587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1588"><a href="#cb28-1588" aria-hidden="true" tabindex="-1"></a><span class="in">6. **Covariance estimation comparison.** Compare the out-of-sample performance of minimum variance portfolios using: (a) sample covariance, (b) Ledoit-Wolf linear shrinkage, (c) nonlinear shrinkage [@ledoit2017nonlinear], and (d) a single-factor covariance model. Which estimator produces the lowest realized portfolio variance?</span></span>
<span id="cb28-1589"><a href="#cb28-1589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1590"><a href="#cb28-1590" aria-hidden="true" tabindex="-1"></a><span class="in">7. **Price limit effects on rebalancing.** Vietnamese stocks face daily price limits ($\pm$ 7% HOSE, $\pm$ 10% HNX). Simulate the impact of price limits on rebalancing execution: when a stock hits limit-up or limit-down, the rebalancing trade cannot execute. How does this partial execution affect realized portfolio weights and performance?</span></span>
<span id="cb28-1591"><a href="#cb28-1591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-1592"><a href="#cb28-1592" aria-hidden="true" tabindex="-1"></a><span class="in">8. **Foreign ownership constraints.** Many Vietnamese sectors have foreign ownership limits (e.g., 49% for most industries, 30% for banking). Incorporate these constraints into the optimization-based weighting schemes. How do binding foreign ownership limits affect the achievable Sharpe ratio for foreign investors? --&gt;</span></span>
<span id="cb28-1593"><a href="#cb28-1593" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/edit/main/14_portfolio_weighting_and_rebalancing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn_vi/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>