<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>43&nbsp; Structural Models in Finance â€“ Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./70_textual.html" rel="next">
<link href="./62_corporate_finance_estimators.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="43&nbsp; Structural Models in Finance â€“ Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="43&nbsp; Structural Models in Finance â€“ Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Applying Tidy Finance with Python to Vietnam</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">ðŸ“˜ English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://YOUR-ORG.github.io/tidy-finance-vietnam-python-vi/"> 
<span class="menu-text">ðŸ“— SÃ¡ch Tiáº¿ng Viá»‡t</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./60_event_studies.html">Advanced Financial Modeling</a></li><li class="breadcrumb-item"><a href="./63_structural_models_finance.html"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnamâ€™s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Alternative Data and AI for Finance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-structural-estimation-means-in-finance" id="toc-what-structural-estimation-means-in-finance" class="nav-link active" data-scroll-target="#what-structural-estimation-means-in-finance"><span class="header-section-number">43.1</span> What Structural Estimation Means in Finance</a>
  <ul class="collapse">
  <li><a href="#reduced-form-versus-structural" id="toc-reduced-form-versus-structural" class="nav-link" data-scroll-target="#reduced-form-versus-structural"><span class="header-section-number">43.1.1</span> Reduced Form Versus Structural</a></li>
  <li><a href="#identification-through-economic-primitives" id="toc-identification-through-economic-primitives" class="nav-link" data-scroll-target="#identification-through-economic-primitives"><span class="header-section-number">43.1.2</span> Identification Through Economic Primitives</a></li>
  <li><a href="#tradeoffs-between-realism-and-tractability" id="toc-tradeoffs-between-realism-and-tractability" class="nav-link" data-scroll-target="#tradeoffs-between-realism-and-tractability"><span class="header-section-number">43.1.3</span> Tradeoffs Between Realism and Tractability</a></li>
  </ul></li>
  <li><a href="#demand-estimation-for-financial-assets" id="toc-demand-estimation-for-financial-assets" class="nav-link" data-scroll-target="#demand-estimation-for-financial-assets"><span class="header-section-number">43.2</span> Demand Estimation for Financial Assets</a>
  <ul class="collapse">
  <li><a href="#the-demand-system-approach" id="toc-the-demand-system-approach" class="nav-link" data-scroll-target="#the-demand-system-approach"><span class="header-section-number">43.2.1</span> The Demand System Approach</a></li>
  <li><a href="#demand-elasticity-estimation" id="toc-demand-elasticity-estimation" class="nav-link" data-scroll-target="#demand-elasticity-estimation"><span class="header-section-number">43.2.2</span> Demand Elasticity Estimation</a></li>
  <li><a href="#price-pressure-and-market-impact" id="toc-price-pressure-and-market-impact" class="nav-link" data-scroll-target="#price-pressure-and-market-impact"><span class="header-section-number">43.2.3</span> Price Pressure and Market Impact</a></li>
  <li><a href="#demand-inelasticity-and-its-implications" id="toc-demand-inelasticity-and-its-implications" class="nav-link" data-scroll-target="#demand-inelasticity-and-its-implications"><span class="header-section-number">43.2.4</span> Demand Inelasticity and Its Implications</a></li>
  </ul></li>
  <li><a href="#structural-models-of-trading-strategies" id="toc-structural-models-of-trading-strategies" class="nav-link" data-scroll-target="#structural-models-of-trading-strategies"><span class="header-section-number">43.3</span> Structural Models of Trading Strategies</a>
  <ul class="collapse">
  <li><a href="#optimal-execution-the-almgren-chriss-framework" id="toc-optimal-execution-the-almgren-chriss-framework" class="nav-link" data-scroll-target="#optimal-execution-the-almgren-chriss-framework"><span class="header-section-number">43.3.1</span> Optimal Execution: The Almgren-Chriss Framework</a></li>
  <li><a href="#estimating-market-impact-from-transaction-data" id="toc-estimating-market-impact-from-transaction-data" class="nav-link" data-scroll-target="#estimating-market-impact-from-transaction-data"><span class="header-section-number">43.3.2</span> Estimating Market Impact from Transaction Data</a></li>
  <li><a href="#transaction-cost-decomposition" id="toc-transaction-cost-decomposition" class="nav-link" data-scroll-target="#transaction-cost-decomposition"><span class="header-section-number">43.3.3</span> Transaction Cost Decomposition</a></li>
  </ul></li>
  <li><a href="#auction-models-in-primary-markets" id="toc-auction-models-in-primary-markets" class="nav-link" data-scroll-target="#auction-models-in-primary-markets"><span class="header-section-number">43.4</span> Auction Models in Primary Markets</a>
  <ul class="collapse">
  <li><a href="#the-ipo-allocation-problem" id="toc-the-ipo-allocation-problem" class="nav-link" data-scroll-target="#the-ipo-allocation-problem"><span class="header-section-number">43.4.1</span> The IPO Allocation Problem</a></li>
  <li><a href="#book-building-vs.-auction-mechanisms" id="toc-book-building-vs.-auction-mechanisms" class="nav-link" data-scroll-target="#book-building-vs.-auction-mechanisms"><span class="header-section-number">43.4.2</span> Book Building vs.&nbsp;Auction Mechanisms</a></li>
  <li><a href="#structural-estimation-of-information-asymmetry" id="toc-structural-estimation-of-information-asymmetry" class="nav-link" data-scroll-target="#structural-estimation-of-information-asymmetry"><span class="header-section-number">43.4.3</span> Structural Estimation of Information Asymmetry</a></li>
  <li><a href="#counterfactual-welfare-under-alternative-mechanisms" id="toc-counterfactual-welfare-under-alternative-mechanisms" class="nav-link" data-scroll-target="#counterfactual-welfare-under-alternative-mechanisms"><span class="header-section-number">43.4.4</span> Counterfactual: Welfare Under Alternative Mechanisms</a></li>
  </ul></li>
  <li><a href="#limit-order-book-models" id="toc-limit-order-book-models" class="nav-link" data-scroll-target="#limit-order-book-models"><span class="header-section-number">43.5</span> Limit Order Book Models</a>
  <ul class="collapse">
  <li><a href="#order-submission-as-a-strategic-choice" id="toc-order-submission-as-a-strategic-choice" class="nav-link" data-scroll-target="#order-submission-as-a-strategic-choice"><span class="header-section-number">43.5.1</span> Order Submission as a Strategic Choice</a></li>
  <li><a href="#the-glosten-milgrom-model" id="toc-the-glosten-milgrom-model" class="nav-link" data-scroll-target="#the-glosten-milgrom-model"><span class="header-section-number">43.5.2</span> The Glosten-Milgrom Model</a></li>
  <li><a href="#pin-probability-of-informed-trading" id="toc-pin-probability-of-informed-trading" class="nav-link" data-scroll-target="#pin-probability-of-informed-trading"><span class="header-section-number">43.5.3</span> PIN: Probability of Informed Trading</a></li>
  <li><a href="#pin-and-asset-pricing" id="toc-pin-and-asset-pricing" class="nav-link" data-scroll-target="#pin-and-asset-pricing"><span class="header-section-number">43.5.4</span> PIN and Asset Pricing</a></li>
  <li><a href="#estimation-challenges-in-limit-order-book-models" id="toc-estimation-challenges-in-limit-order-book-models" class="nav-link" data-scroll-target="#estimation-challenges-in-limit-order-book-models"><span class="header-section-number">43.5.5</span> Estimation Challenges in Limit Order Book Models</a></li>
  </ul></li>
  <li><a href="#when-structural-models-are-worth-it" id="toc-when-structural-models-are-worth-it" class="nav-link" data-scroll-target="#when-structural-models-are-worth-it"><span class="header-section-number">43.6</span> When Structural Models Are Worth It</a>
  <ul class="collapse">
  <li><a href="#decision-framework" id="toc-decision-framework" class="nav-link" data-scroll-target="#decision-framework"><span class="header-section-number">43.6.1</span> Decision Framework</a></li>
  <li><a href="#data-requirements" id="toc-data-requirements" class="nav-link" data-scroll-target="#data-requirements"><span class="header-section-number">43.6.2</span> Data Requirements</a></li>
  <li><a href="#computational-cost" id="toc-computational-cost" class="nav-link" data-scroll-target="#computational-cost"><span class="header-section-number">43.6.3</span> Computational Cost</a></li>
  <li><a href="#interpretation-risks" id="toc-interpretation-risks" class="nav-link" data-scroll-target="#interpretation-risks"><span class="header-section-number">43.6.4</span> Interpretation Risks</a></li>
  <li><a href="#journal-expectations" id="toc-journal-expectations" class="nav-link" data-scroll-target="#journal-expectations"><span class="header-section-number">43.6.5</span> Journal Expectations</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">43.7</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/63_structural_models_finance.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./60_event_studies.html">Advanced Financial Modeling</a></li><li class="breadcrumb-item"><a href="./63_structural_models_finance.html"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Most of empirical finance is reduced-form: regress returns on characteristics, estimate risk premia from factor portfolios, test whether a coefficient is significantly different from zero. Structural estimation takes a fundamentally different approach. It begins with an explicit economic model (i.e., specifying agentsâ€™ preferences, information sets, constraints, and optimization problems) and estimates the modelâ€™s primitive parameters directly from observed data. The payoff is the ability to perform counterfactual analysis: what would happen to prices if trading costs fell by half? How would IPO underpricing change if the allocation mechanism switched from book building to a uniform-price auction? What is the welfare cost of a particular market design choice? These questions are unanswerable within a reduced-form framework because they require knowledge of the data-generating process, not merely statistical associations within a single regime.</p>
<p>This chapter introduces the key structural estimation frameworks used in financial economics and implements them for Vietnamese equity markets. We cover four domains where structural models have proven most productive: investor demand estimation, trading cost and execution models, primary market auctions, and limit order book dynamics. Each domain involves distinct economic primitives such as preferences, beliefs, transaction costs, information asymmetries and each requires domain-specific identification strategies.</p>
<p>Vietnamese markets offer both challenges and opportunities for structural estimation. On the challenge side, data quality is uneven, market microstructure is evolving, and institutional features (price limits, foreign ownership caps, state ownership) introduce constraints that standard models do not accommodate. On the opportunity side, several features of Vietnamese markets create natural variation that aids identification: the coexistence of two exchanges (HOSE and HNX) with different trading rules, regulatory changes that shift trading costs and price limits, and the phased liberalization of foreign ownership caps that generates exogenous demand shocks.</p>
<div id="setup" class="cell" data-message="false" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats, optimize</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize, minimize_scalar</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.iv <span class="im">import</span> IV2SLS</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="what-structural-estimation-means-in-finance" class="level2" data-number="43.1">
<h2 data-number="43.1" class="anchored" data-anchor-id="what-structural-estimation-means-in-finance"><span class="header-section-number">43.1</span> What Structural Estimation Means in Finance</h2>
<section id="reduced-form-versus-structural" class="level3" data-number="43.1.1">
<h3 data-number="43.1.1" class="anchored" data-anchor-id="reduced-form-versus-structural"><span class="header-section-number">43.1.1</span> Reduced Form Versus Structural</h3>
<p>Consider two researchers studying the effect of transaction costs on trading volume. The reduced-form researcher exploits a fee reduction event and estimates:</p>
<p><span id="eq-reduced-form"><span class="math display">\[
\ln V_{i,t} = \alpha + \beta \cdot \text{Post}_t + \gamma \mathbf{X}_{i,t} + \varepsilon_{i,t}
\tag{43.1}\]</span></span></p>
<p>The coefficient <span class="math inline">\(\beta\)</span> identifies the causal effect of the fee change on volume, but it is local to this specific fee change, this specific market, and this specific time period. It says nothing about what a different fee change would do, or what the optimal fee structure might be.</p>
<p>The structural researcher writes down an explicit model of trader behavior:</p>
<p><span id="eq-structural-trader"><span class="math display">\[
\max_{q_t} \; E_t\left[\sum_{s=t}^{T} \delta^{s-t}\left(v_s q_s - c(q_s; \boldsymbol{\theta})\right)\right]
\tag{43.2}\]</span></span></p>
<p>where <span class="math inline">\(v_s\)</span> is the (possibly private) valuation, <span class="math inline">\(q_s\)</span> is the trade quantity, <span class="math inline">\(c(\cdot; \boldsymbol{\theta})\)</span> is the cost function parameterized by <span class="math inline">\(\boldsymbol{\theta}\)</span>, and <span class="math inline">\(\delta\)</span> is the discount factor. The researcher estimates <span class="math inline">\(\boldsymbol{\theta}\)</span> by requiring that the modelâ€™s predictions match observed trading patterns. With <span class="math inline">\(\hat{\boldsymbol{\theta}}\)</span> in hand, any counterfactual cost function <span class="math inline">\(c'(\cdot; \boldsymbol{\theta}')\)</span> can be fed into the model to predict the equilibrium response.</p>
<p>The distinction is not about sophistication (reduced-form work can be highly rigorous) but about the type of question being answered:</p>
<div id="tbl-rf-vs-structural" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-rf-vs-structural-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.1: Reduced Form vs.&nbsp;Structural Estimation
</figcaption>
<div aria-describedby="tbl-rf-vs-structural-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 41%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th>Reduced Form</th>
<th>Structural</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Answers</td>
<td>â€œWhat happened?â€</td>
<td>â€œWhat would happen ifâ€¦?â€</td>
</tr>
<tr class="even">
<td>Identification</td>
<td>Exogenous variation (events, instruments)</td>
<td>Model restrictions + data moments</td>
</tr>
<tr class="odd">
<td>Key assumption</td>
<td>Unconfoundedness or exclusion restriction</td>
<td>Correct model specification</td>
</tr>
<tr class="even">
<td>Output</td>
<td>Treatment effects, associations</td>
<td>Primitive parameters, counterfactuals</td>
</tr>
<tr class="odd">
<td>Risk</td>
<td>Omitted variable bias, weak instruments</td>
<td>Model misspecification</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="identification-through-economic-primitives" class="level3" data-number="43.1.2">
<h3 data-number="43.1.2" class="anchored" data-anchor-id="identification-through-economic-primitives"><span class="header-section-number">43.1.2</span> Identification Through Economic Primitives</h3>
<p>Structural identification relies on the economic model to convert observed outcomes into unobserved primitives. The classic example is the demand-supply system. Observing prices and quantities alone cannot identify demand and supply curves (the simultaneity problem). But if we know the functional form of demand and supply, and have instruments that shift one curve but not the other, the system is identified.</p>
<p>In financial contexts, identification often comes from the modelâ€™s equilibrium conditions. In <span class="citation" data-cites="kyle1985continuous">Kyle (<a href="references.html#ref-kyle1985continuous" role="doc-biblioref">1985</a>)</span>, the informed traderâ€™s strategy, the market makerâ€™s pricing rule, and the noise traderâ€™s demand jointly determine the equilibrium price impact coefficient <span class="math inline">\(\lambda\)</span>. The model maps the observable (i.e., the price impact of order flow) to the unobservable (i.e., the precision of private information). The identification is through the modelâ€™s structure, not through a conventional instrument.</p>
<p>Formally, let <span class="math inline">\(\boldsymbol{\theta} \in \Theta\)</span> denote the vector of structural parameters and <span class="math inline">\(\mathbf{m}(\boldsymbol{\theta})\)</span> the model-implied moments. The data provide empirical moments <span class="math inline">\(\hat{\mathbf{m}}\)</span>. Identification requires that the mapping <span class="math inline">\(\boldsymbol{\theta} \mapsto \mathbf{m}(\boldsymbol{\theta})\)</span> is injective: different parameter values produce different observable implications.</p>
<p><span id="eq-gmm-structural"><span class="math display">\[
\hat{\boldsymbol{\theta}} = \arg\min_{\boldsymbol{\theta} \in \Theta} \left[\hat{\mathbf{m}} - \mathbf{m}(\boldsymbol{\theta})\right]' \mathbf{W} \left[\hat{\mathbf{m}} - \mathbf{m}(\boldsymbol{\theta})\right]
\tag{43.3}\]</span></span></p>
<p>This is the Generalized Method of Moments (GMM) framework applied to structural estimation. The choice of weighting matrix <span class="math inline">\(\mathbf{W}\)</span> determines efficiency, and over-identifying restrictions (more moments than parameters) provide specification tests.</p>
</section>
<section id="tradeoffs-between-realism-and-tractability" class="level3" data-number="43.1.3">
<h3 data-number="43.1.3" class="anchored" data-anchor-id="tradeoffs-between-realism-and-tractability"><span class="header-section-number">43.1.3</span> Tradeoffs Between Realism and Tractability</h3>
<p>Every structural model involves choices about which features of reality to include and which to abstract from. <a href="#tbl-tradeoff" class="quarto-xref">Table&nbsp;<span>43.2</span></a> illustrates this for several canonical finance models.</p>
<div id="tbl-tradeoff" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-tradeoff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.2: Structural Model Tradeoffs
</figcaption>
<div aria-describedby="tbl-tradeoff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 29%">
<col style="width: 23%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Key Simplification</th>
<th>What It Misses</th>
<th>What It Gains</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="citation" data-cites="kyle1985continuous">Kyle (<a href="references.html#ref-kyle1985continuous" role="doc-biblioref">1985</a>)</span></td>
<td>Single informed trader, normal distributions</td>
<td>Multiple insiders, fat tails</td>
<td>Closed-form <span class="math inline">\(\lambda\)</span>, clean identification</td>
</tr>
<tr class="even">
<td><span class="citation" data-cites="glosten1985bid">Glosten and Milgrom (<a href="references.html#ref-glosten1985bid" role="doc-biblioref">1985</a>)</span></td>
<td>Binary signal, competitive market makers</td>
<td>Complex information, inventory costs</td>
<td>Bid-ask spread decomposition</td>
</tr>
<tr class="odd">
<td><span class="citation" data-cites="koijen2019demand">Koijen and Yogo (<a href="references.html#ref-koijen2019demand" role="doc-biblioref">2019</a>)</span></td>
<td>Characteristics-based demand, no dynamics</td>
<td>Dynamic portfolio rebalancing</td>
<td>Demand elasticity estimation at scale</td>
</tr>
<tr class="even">
<td><span class="citation" data-cites="roll1984simple">Roll (<a href="references.html#ref-roll1984simple" role="doc-biblioref">1984</a>)</span></td>
<td>No information, serial independence</td>
<td>Information-driven trades</td>
<td>Spread estimation from return autocovariance</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The researcherâ€™s task is to choose the simplest model that captures the economic mechanism of interest while remaining rich enough that its counterfactual predictions are credible. As <span class="citation" data-cites="rust1987optimal">Rust (<a href="references.html#ref-rust1987optimal" role="doc-biblioref">1987</a>)</span> emphasized, there is a tension between models that are â€œstructurally correctâ€ but computationally intractable and models that are tractable but potentially misspecified.</p>
</section>
</section>
<section id="demand-estimation-for-financial-assets" class="level2" data-number="43.2">
<h2 data-number="43.2" class="anchored" data-anchor-id="demand-estimation-for-financial-assets"><span class="header-section-number">43.2</span> Demand Estimation for Financial Assets</h2>
<section id="the-demand-system-approach" class="level3" data-number="43.2.1">
<h3 data-number="43.2.1" class="anchored" data-anchor-id="the-demand-system-approach"><span class="header-section-number">43.2.1</span> The Demand System Approach</h3>
<p><span class="citation" data-cites="koijen2019demand">Koijen and Yogo (<a href="references.html#ref-koijen2019demand" role="doc-biblioref">2019</a>)</span> (hereafter KY) develop a demand system for financial assets that estimates the elasticity of institutional investor demand with respect to asset characteristics. The framework adapts the discrete-choice demand estimation methodology of <span class="citation" data-cites="berry1995automobile">Berry, Levinsohn, and Pakes (<a href="references.html#ref-berry1995automobile" role="doc-biblioref">1995</a>)</span> from industrial organization to financial markets.</p>
<p>Each investor <span class="math inline">\(i\)</span> holds a portfolio of <span class="math inline">\(N\)</span> assets. The demand for asset <span class="math inline">\(j\)</span> by investor <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> is:</p>
<p><span id="eq-ky-demand"><span class="math display">\[
w_{ij,t} = \frac{\exp(\delta_{j,t} + \boldsymbol{\beta}_i' \mathbf{x}_{j,t})}{1 + \sum_{k=1}^{N} \exp(\delta_{k,t} + \boldsymbol{\beta}_i' \mathbf{x}_{k,t})}
\tag{43.4}\]</span></span></p>
<p>where <span class="math inline">\(w_{ij,t}\)</span> is the portfolio weight of asset <span class="math inline">\(j\)</span> for investor <span class="math inline">\(i\)</span>, <span class="math inline">\(\delta_{j,t}\)</span> is the mean utility (common valuation), <span class="math inline">\(\mathbf{x}_{j,t}\)</span> is a vector of observable characteristics (market cap, book-to-market, momentum, etc.), and <span class="math inline">\(\boldsymbol{\beta}_i\)</span> captures investor-specific preferences (heterogeneous demand elasticities). The denominator includes 1 to represent the outside option (holding cash or non-equity assets).</p>
<p>The key insight is that the market-clearing condition links demand to equilibrium prices:</p>
<p><span id="eq-market-clearing"><span class="math display">\[
\sum_i A_{i,t} \cdot w_{ij,t}(\boldsymbol{\theta}) = \text{ME}_{j,t} \qquad \forall j, t
\tag{43.5}\]</span></span></p>
<p>where <span class="math inline">\(A_{i,t}\)</span> is investor <span class="math inline">\(i\)</span>â€™s total assets under management and <span class="math inline">\(\text{ME}_{j,t}\)</span> is the market capitalization of asset <span class="math inline">\(j\)</span>. This system of equations determines the equilibrium price impacts and demand elasticities.</p>
</section>
<section id="demand-elasticity-estimation" class="level3" data-number="43.2.2">
<h3 data-number="43.2.2" class="anchored" data-anchor-id="demand-elasticity-estimation"><span class="header-section-number">43.2.2</span> Demand Elasticity Estimation</h3>
<p>The demand elasticity of asset <span class="math inline">\(j\)</span> with respect to its own price (or a characteristic that moves its price) is:</p>
<p><span id="eq-demand-elasticity"><span class="math display">\[
\varepsilon_{jj} = \frac{\partial \ln w_{ij}}{\partial \ln P_j} = \beta_{\text{price}} \cdot (1 - w_{ij})
\tag{43.6}\]</span></span></p>
<p>In a frictionless market with perfectly elastic demand, a supply shock (e.g., an index addition) would have zero price impact. Empirically, demand curves for financial assets slope downward with finite elasticity, implying that supply shocks move equilibrium prices.</p>
<div id="load-holdings-data" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load institutional holdings data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>holdings <span class="op">=</span> dc.get_institutional_holdings(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm characteristics</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>firm_chars <span class="op">=</span> dc.get_firm_characteristics(</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Load market data</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings observations: </span><span class="sc">{</span><span class="bu">len</span>(holdings)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique institutions: </span><span class="sc">{</span>holdings[<span class="st">'institution_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>holdings[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="demand-system-construction" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct demand system variables</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>demand <span class="op">=</span> holdings.merge(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    firm_chars[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"market_cap"</span>, <span class="st">"book_to_market"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>                <span class="st">"momentum_12m"</span>, <span class="st">"log_size"</span>, <span class="st">"profitability"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                <span class="st">"investment"</span>, <span class="st">"industry"</span>]],</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>],</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolio weights</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"total_aum"</span>] <span class="op">=</span> demand.groupby(</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"institution_id"</span>, <span class="st">"date"</span>]</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"holding_value"</span>].transform(<span class="st">"sum"</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"port_weight"</span>] <span class="op">=</span> demand[<span class="st">"holding_value"</span>] <span class="op">/</span> demand[<span class="st">"total_aum"</span>]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Log portfolio weight relative to outside option</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># w_ij / w_i0 where w_i0 = 1 - sum(w_ij) for equity holdings</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"sum_equity_weight"</span>] <span class="op">=</span> demand.groupby(</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"institution_id"</span>, <span class="st">"date"</span>]</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"port_weight"</span>].transform(<span class="st">"sum"</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"outside_weight"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> demand[<span class="st">"sum_equity_weight"</span>].clip(upper<span class="op">=</span><span class="fl">0.99</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"log_weight_ratio"</span>] <span class="op">=</span> np.log(</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    demand[<span class="st">"port_weight"</span>] <span class="op">/</span> demand[<span class="st">"outside_weight"</span>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="demand-estimation" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified KY demand estimation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># log(w_ij / w_i0) = delta_j + beta_i' x_j + epsilon_ij</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># First stage: estimate mean utility delta_j via OLS with asset FE</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression at each date</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_demand_cross_section(group):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate demand parameters for a single cross-section.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses OLS with stock fixed effects absorbed.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> group.dropna(subset<span class="op">=</span>[</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_weight_ratio"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"momentum_12m"</span>, <span class="st">"profitability"</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(g) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> g[[<span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>           <span class="st">"profitability"</span>]].values</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> g[<span class="st">"log_weight_ratio"</span>].values</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_size"</span>: model.params[<span class="dv">1</span>],</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_btm"</span>: model.params[<span class="dv">2</span>],</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_mom"</span>: model.params[<span class="dv">3</span>],</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_prof"</span>: model.params[<span class="dv">4</span>],</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_obs"</span>: <span class="bu">len</span>(g)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by institution type</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"institution_type"</span>] <span class="op">=</span> demand[<span class="st">"institution_type"</span>].fillna(<span class="st">"Other"</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>demand_params <span class="op">=</span> (</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    demand.groupby([<span class="st">"institution_type"</span>, <span class="st">"date"</span>])</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(estimate_demand_cross_section)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-demand-params" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-demand-params-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.3: Demand Elasticities by Investor Type
</figcaption>
<div aria-describedby="tbl-demand-params-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>avg_params <span class="op">=</span> (</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    demand_params.groupby(<span class="st">"institution_type"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        beta_size<span class="op">=</span>(<span class="st">"beta_size"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        beta_btm<span class="op">=</span>(<span class="st">"beta_btm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        beta_mom<span class="op">=</span>(<span class="st">"beta_mom"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        beta_prof<span class="op">=</span>(<span class="st">"beta_prof"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        avg_r2<span class="op">=</span>(<span class="st">"r_squared"</span>, <span class="st">"mean"</span>),</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        n_periods<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"nunique"</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>avg_params</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<div id="fig-demand-elasticity-time" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-demand-elasticity-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>top_types <span class="op">=</span> demand_params.groupby(<span class="st">"institution_type"</span>).size().nlargest(<span class="dv">4</span>).index</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> demand_params[</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    demand_params[<span class="st">"institution_type"</span>].isin(top_types)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_data, p9.aes(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta_size"</span>, color<span class="op">=</span><span class="st">"institution_type"</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, se<span class="op">=</span><span class="va">False</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Î² (Size)"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Institutional Demand Sensitivity to Firm Size"</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Institution Type"</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-demand-elasticity-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.1
</figcaption>
</figure>
</div>
</section>
<section id="price-pressure-and-market-impact" class="level3" data-number="43.2.3">
<h3 data-number="43.2.3" class="anchored" data-anchor-id="price-pressure-and-market-impact"><span class="header-section-number">43.2.3</span> Price Pressure and Market Impact</h3>
<p>The demand system framework directly yields price impact predictions. If investor <span class="math inline">\(i\)</span> receives an exogenous inflow <span class="math inline">\(\Delta A_i\)</span> (e.g., from a fund flow shock), the price of each stock must adjust to clear the market with the new demand. The equilibrium price impact of a demand shock is:</p>
<p><span id="eq-price-impact-demand"><span class="math display">\[
\frac{\Delta P_j}{P_j} = \frac{1}{\varepsilon_{jj}} \cdot \frac{\Delta D_j}{D_j}
\tag{43.7}\]</span></span></p>
<p>where <span class="math inline">\(\varepsilon_{jj}\)</span> is the demand elasticity and <span class="math inline">\(\Delta D_j / D_j\)</span> is the percentage demand shock. Less elastic demand implies larger price impact for the same demand shock (a prediction with direct implications for the price impact of index rebalancing, fund flows, and forced selling).</p>
<div id="price-pressure" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate aggregate demand elasticity via index rebalancing events</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Use VN30 index reconstitutions as demand shocks</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>index_changes <span class="op">=</span> dc.get_index_changes(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"VN30"</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Event study: abnormal returns around index additions/deletions</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> event_study_car(events, returns, window<span class="op">=</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>)):</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute cumulative abnormal returns around events.</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">    events : DataFrame</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: ticker, event_date, event_type (addition/deletion).</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : DataFrame</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: ticker, date, ret, mkt_ret.</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : CARs by event type and event day.</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> events.iterrows():</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> event[<span class="st">"ticker"</span>]</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        event_date <span class="op">=</span> pd.to_datetime(event[<span class="st">"event_date"</span>])</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimation window: -260 to -11</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>        stock_rets <span class="op">=</span> returns[returns[<span class="st">"ticker"</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>        stock_rets <span class="op">=</span> stock_rets.sort_values(<span class="st">"date"</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>        est_mask <span class="op">=</span> (</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&gt;=</span> event_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">365</span>)) <span class="op">&amp;</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&lt;</span> event_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">15</span>))</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>        est_data <span class="op">=</span> stock_rets[est_mask].dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>])</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(est_data) <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market model</span></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>            est_data[<span class="st">"ret"</span>],</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>            sm.add_constant(est_data[<span class="st">"mkt_ret"</span>])</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        ).fit()</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event window</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>        evt_mask <span class="op">=</span> (</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&gt;=</span> event_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>window[<span class="dv">0</span>] <span class="op">*</span> <span class="fl">1.5</span>)) <span class="op">&amp;</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&lt;=</span> event_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>window[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">1.5</span>))</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>        evt_data <span class="op">=</span> stock_rets[evt_mask].dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>])</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(evt_data) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Abnormal returns</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>        evt_data <span class="op">=</span> evt_data.copy()</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"expected"</span>] <span class="op">=</span> model.predict(</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            sm.add_constant(evt_data[<span class="st">"mkt_ret"</span>])</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"ar"</span>] <span class="op">=</span> evt_data[<span class="st">"ret"</span>] <span class="op">-</span> evt_data[<span class="st">"expected"</span>]</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign event-time index</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>        trading_dates <span class="op">=</span> evt_data[<span class="st">"date"</span>].sort_values().values</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> np.searchsorted(trading_dates, event_date)</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"event_day"</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="op">-</span>event_idx, <span class="bu">len</span>(evt_data) <span class="op">-</span> event_idx)</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"event_type"</span>] <span class="op">=</span> event[<span class="st">"event_type"</span>]</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"ticker"</span>] <span class="op">=</span> ticker</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>        results.append(evt_data[[<span class="st">"ticker"</span>, <span class="st">"event_day"</span>, <span class="st">"ar"</span>, <span class="st">"event_type"</span>]])</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> results:</span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute event study</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>daily_data <span class="op">=</span> market_data.merge(</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>    dc.get_market_returns(</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>        frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>    )[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>car_results <span class="op">=</span> event_study_car(index_changes, daily_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-index-event-study" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-index-event-study-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(car_results) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average AR by event day and type</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    avg_ar <span class="op">=</span> (</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        car_results.groupby([<span class="st">"event_type"</span>, <span class="st">"event_day"</span>])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>            mean_ar<span class="op">=</span>(<span class="st">"ar"</span>, <span class="st">"mean"</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>            se_ar<span class="op">=</span>(<span class="st">"ar"</span>, <span class="kw">lambda</span> x: x.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(x))),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>            n<span class="op">=</span>(<span class="st">"ar"</span>, <span class="st">"count"</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative AR</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> etype <span class="kw">in</span> avg_ar[<span class="st">"event_type"</span>].unique():</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> avg_ar[<span class="st">"event_type"</span>] <span class="op">==</span> etype</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        avg_ar.loc[mask, <span class="st">"car"</span>] <span class="op">=</span> avg_ar.loc[mask, <span class="st">"mean_ar"</span>].cumsum()</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    avg_ar <span class="op">=</span> avg_ar[avg_ar[<span class="st">"event_day"</span>].between(<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>)]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        p9.ggplot(avg_ar, p9.aes(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"event_day"</span>, y<span class="op">=</span><span class="st">"car"</span>, color<span class="op">=</span><span class="st">"event_type"</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dotted"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.scale_color_manual(values<span class="op">=</span>[<span class="st">"#27AE60"</span>, <span class="st">"#C0392B"</span>])</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.labs(</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"Event Day"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"Cumulative Abnormal Return"</span>,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Price Pressure from VN30 Index Additions and Deletions"</span>,</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">"Event"</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-index-event-study-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.2
</figcaption>
</figure>
</div>
<p>The permanent component of the CAR measures the information content of index inclusion, while the temporary component (reversal after the event) measures pure price pressure from demand. In a world with perfectly elastic demand, there would be no temporary price impact. The magnitude of the temporary component is inversely related to the demand elasticity, providing a second identification strategy (complementary to the holdings-based approach) for demand curves.</p>
</section>
<section id="demand-inelasticity-and-its-implications" class="level3" data-number="43.2.4">
<h3 data-number="43.2.4" class="anchored" data-anchor-id="demand-inelasticity-and-its-implications"><span class="header-section-number">43.2.4</span> Demand Inelasticity and Its Implications</h3>
<p><span class="citation" data-cites="gabaix2021search">Gabaix and Koijen (<a href="references.html#ref-gabaix2021search" role="doc-biblioref">2021</a>)</span> argue that the aggregate demand for equities is remarkably inelastic, with elasticity estimates on the order of 0.2 (meaning a 1% supply increase requires a 5% price decline to clear). The implications are profound: if demand is this inelastic, then flows (from index funds, foreign investors, retail traders) have outsized effects on prices. In Vietnamese markets, where foreign ownership caps create binding constraints on a key investor class, demand inelasticity may be even more severe.</p>
<p>The inelasticity also generates a role for â€œthe market portfolioâ€ as an equilibrium concept: if most investors hold portfolios close to the market (as in CAPM), then deviations from market weights require someone to absorb the excess supply, and the compensation required is the inverse of demand elasticity.</p>
</section>
</section>
<section id="structural-models-of-trading-strategies" class="level2" data-number="43.3">
<h2 data-number="43.3" class="anchored" data-anchor-id="structural-models-of-trading-strategies"><span class="header-section-number">43.3</span> Structural Models of Trading Strategies</h2>
<section id="optimal-execution-the-almgren-chriss-framework" class="level3" data-number="43.3.1">
<h3 data-number="43.3.1" class="anchored" data-anchor-id="optimal-execution-the-almgren-chriss-framework"><span class="header-section-number">43.3.1</span> Optimal Execution: The Almgren-Chriss Framework</h3>
<p>The optimal execution problem, formalized by <span class="citation" data-cites="almgren2001optimal">Almgren and Chriss (<a href="references.html#ref-almgren2001optimal" role="doc-biblioref">2001</a>)</span>, asks: given a large order to execute over a fixed horizon, what is the optimal trading schedule that minimizes the total execution cost? The problem is fundamental to institutional investing because large orders cannot be executed instantaneously without severe price impact.</p>
<p>Let <span class="math inline">\(X_t\)</span> denote the remaining shares to sell at time <span class="math inline">\(t\)</span>, with <span class="math inline">\(X_0 = X\)</span> (total order) and <span class="math inline">\(X_T = 0\)</span> (completion). The trading rate is <span class="math inline">\(n_t = X_{t-1} - X_t\)</span>. The execution price for shares traded at <span class="math inline">\(t\)</span> is affected by both temporary and permanent price impact:</p>
<p><span id="eq-almgren-chriss-price"><span class="math display">\[
S_t = S_0 + \sigma W_t - g(n_t) - h\left(\frac{n_t}{\tau}\right)
\tag{43.8}\]</span></span></p>
<p>where <span class="math inline">\(g(\cdot)\)</span> is the permanent impact function, <span class="math inline">\(h(\cdot)\)</span> is the temporary impact function, <span class="math inline">\(\sigma\)</span> is the volatility, <span class="math inline">\(W_t\)</span> is a Wiener process, and <span class="math inline">\(\tau\)</span> is the time interval. The total implementation shortfall (cost of execution relative to the arrival price <span class="math inline">\(S_0\)</span>) is:</p>
<p><span id="eq-shortfall"><span class="math display">\[
\text{IS} = \sum_{t=1}^{T} n_t (S_0 - S_t) = \sum_{t=1}^{T} n_t \left[\sigma W_t + g(n_t) + h\left(\frac{n_t}{\tau}\right)\right]
\tag{43.9}\]</span></span></p>
<p>The trader minimizes a mean-variance objective:</p>
<p><span id="eq-ac-objective"><span class="math display">\[
\min_{\{n_t\}} \; E[\text{IS}] + \lambda \cdot \text{Var}(\text{IS})
\tag{43.10}\]</span></span></p>
<p>where <span class="math inline">\(\lambda\)</span> is the risk aversion parameter. With linear impact functions <span class="math inline">\(g(n) = \gamma n\)</span> and <span class="math inline">\(h(v) = \eta v + \epsilon \text{sgn}(v)\)</span>, the optimal strategy has a closed-form solution.</p>
<p><strong>TWAP (Time-Weighted Average Price):</strong> Trade uniformly: <span class="math inline">\(n_t = X / T\)</span> for all <span class="math inline">\(t\)</span>. Optimal when permanent impact dominates temporary impact.</p>
<p><strong>VWAP (Volume-Weighted Average Price):</strong> Trade proportionally to expected volume: <span class="math inline">\(n_t \propto \hat{V}_t\)</span>. Approximates TWAP adjusted for intraday volume patterns.</p>
<p><strong>Almgren-Chriss Optimal:</strong> The risk-averse optimal trajectory for linear impact is:</p>
<p><span id="eq-ac-trajectory"><span class="math display">\[
x_t^* = X \cdot \frac{\sinh(\kappa (T - t))}{\sinh(\kappa T)}
\tag{43.11}\]</span></span></p>
<p>where <span class="math inline">\(\kappa = \sqrt{\lambda \sigma^2 / \eta}\)</span> governs the trade-off between urgency (trading quickly to reduce risk) and patience (trading slowly to reduce impact). High risk aversion (<span class="math inline">\(\lambda\)</span> large) implies front-loaded execution.</p>
<div id="almgren-chriss" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> almgren_chriss_trajectory(X, T, sigma, eta, gamma, lam, n_steps<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Almgren-Chriss optimal execution trajectory.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Total shares to execute.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co">    T : float</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Execution horizon (in trading days).</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co">    sigma : float</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily return volatility.</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co">    eta : float</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Temporary impact parameter.</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma : float</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Permanent impact parameter.</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co">    lam : float</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">        Risk aversion parameter.</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">    n_steps : int</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of time steps.</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Time, remaining shares, trading rate, expected cost.</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    tau <span class="op">=</span> T <span class="op">/</span> n_steps</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    kappa_sq <span class="op">=</span> lam <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (eta <span class="op">/</span> tau)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> kappa_sq <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Risk-neutral: trade uniformly</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> np.linspace(X, <span class="dv">0</span>, n_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> np.sqrt(kappa_sq)</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        t_grid <span class="op">=</span> np.linspace(<span class="dv">0</span>, T, n_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> X <span class="op">*</span> np.sinh(kappa <span class="op">*</span> (T <span class="op">-</span> t_grid)) <span class="op">/</span> np.sinh(kappa <span class="op">*</span> T)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trading rates</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    n_t <span class="op">=</span> <span class="op">-</span>np.diff(x_t)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected cost components</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    perm_cost <span class="op">=</span> gamma <span class="op">*</span> np.<span class="bu">sum</span>(n_t<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    temp_cost <span class="op">=</span> (eta <span class="op">/</span> tau) <span class="op">*</span> np.<span class="bu">sum</span>(n_t<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    total_expected_cost <span class="op">=</span> perm_cost <span class="op">+</span> temp_cost</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variance of cost</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    var_cost <span class="op">=</span> sigma<span class="op">**</span><span class="dv">2</span> <span class="op">*</span> tau <span class="op">*</span> np.<span class="bu">sum</span>(x_t[:<span class="op">-</span><span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"time"</span>: np.linspace(<span class="dv">0</span>, T, n_steps <span class="op">+</span> <span class="dv">1</span>)[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"remaining_shares"</span>: x_t[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trade_rate"</span>: n_t</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"expected_cost"</span>] <span class="op">=</span> total_expected_cost</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"cost_variance"</span>] <span class="op">=</span> var_cost</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"kappa"</span>] <span class="op">=</span> kappa <span class="cf">if</span> kappa_sq <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-execution-trajectories" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-execution-trajectories-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate market impact parameters from Vietnamese data</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical values for mid-cap Vietnamese stocks</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>sigma_daily <span class="op">=</span> <span class="fl">0.025</span>  <span class="co"># 2.5% daily vol</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>eta <span class="op">=</span> <span class="fl">2.5e-7</span>         <span class="co"># Temporary impact</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="fl">1.0e-7</span>       <span class="co"># Permanent impact</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>X_shares <span class="op">=</span> <span class="dv">500000</span>    <span class="co"># 500k shares to sell</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>T_days <span class="op">=</span> <span class="dv">5</span>           <span class="co"># 5-day horizon</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>trajectories <span class="op">=</span> []</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lam, label <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">"Risk Neutral (TWAP)"</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-6</span>, <span class="st">"Low Risk Aversion"</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-5</span>, <span class="st">"Medium Risk Aversion"</span>),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-4</span>, <span class="st">"High Risk Aversion"</span>)]:</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    traj <span class="op">=</span> almgren_chriss_trajectory(</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        X_shares, T_days, sigma_daily, eta, gamma, lam</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    traj[<span class="st">"strategy"</span>] <span class="op">=</span> label</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    traj[<span class="st">"pct_remaining"</span>] <span class="op">=</span> traj[<span class="st">"remaining_shares"</span>] <span class="op">/</span> X_shares <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    trajectories.append(traj)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>traj_all <span class="op">=</span> pd.concat(trajectories, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(traj_all, p9.aes(</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"time"</span>, y<span class="op">=</span><span class="st">"pct_remaining"</span>, color<span class="op">=</span><span class="st">"strategy"</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#95A5A6"</span>, <span class="st">"#27AE60"</span>, <span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>]</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Time (Trading Days)"</span>,</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Remaining Order (%)"</span>,</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Almgren-Chriss Optimal Execution Trajectories"</span>,</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Strategy"</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-execution-trajectories-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.3
</figcaption>
</figure>
</div>
</section>
<section id="estimating-market-impact-from-transaction-data" class="level3" data-number="43.3.2">
<h3 data-number="43.3.2" class="anchored" data-anchor-id="estimating-market-impact-from-transaction-data"><span class="header-section-number">43.3.2</span> Estimating Market Impact from Transaction Data</h3>
<p>The structural parameters <span class="math inline">\((\gamma, \eta, \sigma)\)</span> must be estimated from data. The standard approach uses the square-root law of market impact, documented empirically by <span class="citation" data-cites="kyle1985continuous">Kyle (<a href="references.html#ref-kyle1985continuous" role="doc-biblioref">1985</a>)</span> and <span class="citation" data-cites="hasbrouck1991measuring">Hasbrouck (<a href="references.html#ref-hasbrouck1991measuring" role="doc-biblioref">1991</a>)</span> and derived theoretically by <span class="citation" data-cites="gabaix2003theory">Gabaix et al. (<a href="references.html#ref-gabaix2003theory" role="doc-biblioref">2003</a>)</span>:</p>
<p><span id="eq-impact-model"><span class="math display">\[
\Delta P / P = c \cdot \text{sgn}(Q) \cdot |Q / V|^{\delta}
\tag{43.12}\]</span></span></p>
<p>where <span class="math inline">\(Q\)</span> is the signed order flow, <span class="math inline">\(V\)</span> is daily volume, <span class="math inline">\(c\)</span> is the impact coefficient, and <span class="math inline">\(\delta \approx 0.5\)</span> is the impact exponent. The â€œsquare rootâ€ refers to <span class="math inline">\(\delta = 0.5\)</span>, which is remarkably robust across markets, time periods, and asset classes.</p>
<div id="impact-estimation" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load intraday transaction data (or daily order flow proxy)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>order_flow <span class="op">=</span> dc.get_order_flow(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct signed order flow using Lee-Ready classification</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># (buy-initiated minus sell-initiated volume)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>impact_data <span class="op">=</span> order_flow.merge(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    dc.get_daily_returns(</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    )[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>, <span class="st">"volume"</span>, <span class="st">"market_cap"</span>]],</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>],</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize order flow</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"oib"</span>] <span class="op">=</span> impact_data[<span class="st">"net_buy_volume"</span>] <span class="op">/</span> impact_data[<span class="st">"volume"</span>]</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"abs_oib"</span>] <span class="op">=</span> np.<span class="bu">abs</span>(impact_data[<span class="st">"oib"</span>])</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"sign_oib"</span>] <span class="op">=</span> np.sign(impact_data[<span class="st">"oib"</span>])</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-log regression: ln|Î”P| = Î± + Î´ ln|Q/V| + Îµ</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"ln_abs_ret"</span>] <span class="op">=</span> np.log(np.<span class="bu">abs</span>(impact_data[<span class="st">"ret"</span>]).clip(lower<span class="op">=</span><span class="fl">1e-8</span>))</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"ln_abs_oib"</span>] <span class="op">=</span> np.log(impact_data[<span class="st">"abs_oib"</span>].clip(lower<span class="op">=</span><span class="fl">1e-8</span>))</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by size quintile</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"size_quintile"</span>] <span class="op">=</span> impact_data.groupby(<span class="st">"date"</span>)[</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"market_cap"</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>impact_results <span class="op">=</span> []</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> impact_data[impact_data[<span class="st">"size_quintile"</span>] <span class="op">==</span> q].dropna(</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">"ln_abs_ret"</span>, <span class="st">"ln_abs_oib"</span>]</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        subset[<span class="st">"ln_abs_ret"</span>],</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(subset[<span class="st">"ln_abs_oib"</span>])</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    impact_results.append({</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"size_quintile"</span>: q,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_hat"</span>: model.params.iloc[<span class="dv">1</span>],</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_se"</span>: model.bse.iloc[<span class="dv">1</span>],</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">"intercept"</span>: model.params.iloc[<span class="dv">0</span>],</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_obs"</span>: <span class="bu">int</span>(model.nobs)</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>impact_df <span class="op">=</span> pd.DataFrame(impact_results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-impact-by-size" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-impact-by-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.4: Market Impact Exponent by Firm Size Quintile
</figcaption>
<div aria-describedby="tbl-impact-by-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>impact_df.<span class="bu">round</span>(<span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
<p>The impact exponent <span class="math inline">\(\hat{\delta}\)</span> near 0.5 across size quintiles confirms the universality of the square-root law. Smaller firms typically exhibit higher impact coefficients (larger <span class="math inline">\(c\)</span>), consistent with lower liquidity.</p>
</section>
<section id="transaction-cost-decomposition" class="level3" data-number="43.3.3">
<h3 data-number="43.3.3" class="anchored" data-anchor-id="transaction-cost-decomposition"><span class="header-section-number">43.3.3</span> Transaction Cost Decomposition</h3>
<p>Total transaction costs comprise multiple components, each with distinct economic content:</p>
<p><span id="eq-tc-decomposition"><span class="math display">\[
\text{TC} = \underbrace{\frac{s}{2}}_{\text{Half-spread}} + \underbrace{\gamma \cdot Q}_{\text{Permanent impact}} + \underbrace{\eta \cdot \frac{Q}{V}}_{\text{Temporary impact}} + \underbrace{\sigma \sqrt{T}}_{\text{Timing risk}}
\tag{43.13}\]</span></span></p>
<p>We estimate each component separately, following the <span class="citation" data-cites="hasbrouck2009trading">Hasbrouck (<a href="references.html#ref-hasbrouck2009trading" role="doc-biblioref">2009</a>)</span> methodology for effective spread decomposition.</p>
<div id="tc-decomposition" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Effective spread estimation</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>spreads <span class="op">=</span> dc.get_bid_ask_data(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Quoted spread</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>spreads[<span class="st">"quoted_spread"</span>] <span class="op">=</span> (</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    (spreads[<span class="st">"ask"</span>] <span class="op">-</span> spreads[<span class="st">"bid"</span>]) <span class="op">/</span> spreads[<span class="st">"midpoint"</span>]</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Effective spread (from transaction prices)</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>spreads[<span class="st">"effective_spread"</span>] <span class="op">=</span> (</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span> <span class="op">*</span> np.<span class="bu">abs</span>(spreads[<span class="st">"trade_price"</span>] <span class="op">-</span> spreads[<span class="st">"midpoint"</span>]) <span class="op">/</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    spreads[<span class="st">"midpoint"</span>]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Roll (1984) implied spread from return autocovariance</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_spread(returns):</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate the Roll (1984) bid-ask spread.</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">    Spread = 2 * sqrt(-Cov(r_t, r_{t-1})) if covariance is negative.</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    cov <span class="op">=</span> np.cov(returns[<span class="dv">1</span>:], returns[:<span class="op">-</span><span class="dv">1</span>])[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> np.sqrt(<span class="op">-</span>cov)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute by stock-month</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>daily_rets <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>daily_rets[<span class="st">"month"</span>] <span class="op">=</span> daily_rets[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>roll_spreads <span class="op">=</span> (</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    daily_rets.groupby([<span class="st">"ticker"</span>, <span class="st">"month"</span>])</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        roll_spread<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: roll_spread(x.values)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">10</span> <span class="cf">else</span> np.nan),</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>        n_days<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"count"</span>),</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        avg_volume<span class="op">=</span>(<span class="st">"volume"</span>, <span class="st">"mean"</span>),</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>        market_cap<span class="op">=</span>(<span class="st">"market_cap"</span>, <span class="st">"last"</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"roll_spread"</span>])</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-spread-size" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="14">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-spread-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bin by market cap deciles</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>roll_spreads[<span class="st">"size_decile"</span>] <span class="op">=</span> roll_spreads.groupby(<span class="st">"month"</span>)[</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"market_cap"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>),</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>spread_by_size <span class="op">=</span> (</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    roll_spreads.groupby(<span class="st">"size_decile"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        median_spread<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="st">"median"</span>),</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        mean_spread<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="st">"mean"</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        q25<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>)),</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        q75<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>))</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(spread_by_size, p9.aes(x<span class="op">=</span><span class="st">"size_decile"</span>, y<span class="op">=</span><span class="st">"median_spread"</span>))</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_errorbar(</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"q25"</span>, ymax<span class="op">=</span><span class="st">"q75"</span>),</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">"#2E5090"</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Size Decile (1 = Smallest)"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Roll Implied Spread"</span>,</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Transaction Costs Decrease Monotonically with Firm Size"</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-spread-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.4
</figcaption>
</figure>
</div>
</section>
</section>
<section id="auction-models-in-primary-markets" class="level2" data-number="43.4">
<h2 data-number="43.4" class="anchored" data-anchor-id="auction-models-in-primary-markets"><span class="header-section-number">43.4</span> Auction Models in Primary Markets</h2>
<section id="the-ipo-allocation-problem" class="level3" data-number="43.4.1">
<h3 data-number="43.4.1" class="anchored" data-anchor-id="the-ipo-allocation-problem"><span class="header-section-number">43.4.1</span> The IPO Allocation Problem</h3>
<p>Initial public offerings present a classic information asymmetry problem. Issuers and underwriters do not know the true market-clearing price; informed investors do (approximately). The allocation mechanism (i.e., how shares are distributed and at what price) determines the IPOâ€™s pricing efficiency, the degree of underpricing, and the distribution of surplus between issuers and investors.</p>
<p><span class="citation" data-cites="rock1986new">Rock (<a href="references.html#ref-rock1986new" role="doc-biblioref">1986</a>)</span> provides the canonical model. There are two types of investors: informed (who know the true value <span class="math inline">\(v\)</span>) and uninformed (who know only the distribution <span class="math inline">\(v \sim F\)</span>). If the IPO is priced at <span class="math inline">\(P\)</span>:</p>
<ul>
<li>When <span class="math inline">\(v &gt; P\)</span> (good IPO): both informed and uninformed subscribe, so uninformed receive only a fraction of their order (rationing).</li>
<li>When <span class="math inline">\(v &lt; P\)</span> (bad IPO): only uninformed subscribe, so they receive full allocation (the â€œwinnerâ€™s curseâ€).</li>
</ul>
<p>The uninformed investorâ€™s expected return, accounting for rationing, is:</p>
<p><span id="eq-rock-return"><span class="math display">\[
E[R_{\text{uninformed}}] = \alpha_g \cdot E\left[\frac{v - P}{P} \mid v &gt; P\right] \cdot \Pr(v &gt; P) + E\left[\frac{v - P}{P} \mid v \leq P\right] \cdot \Pr(v \leq P)
\tag{43.14}\]</span></span></p>
<p>where <span class="math inline">\(\alpha_g &lt; 1\)</span> is the allocation probability in good IPOs (rationed) and allocation is 1 in bad IPOs. For uninformed investors to participate, <span class="math inline">\(E[R_{\text{uninformed}}] \geq 0\)</span>, which requires:</p>
<p><span id="eq-underpricing-condition"><span class="math display">\[
E\left[\frac{v - P}{P}\right] &gt; 0
\tag{43.15}\]</span></span></p>
<p>That is, IPOs must be underpriced on average to compensate uninformed investors for the winnerâ€™s curse. The degree of required underpricing increases with the proportion of informed investors and the variance of the true value.</p>
</section>
<section id="book-building-vs.-auction-mechanisms" class="level3" data-number="43.4.2">
<h3 data-number="43.4.2" class="anchored" data-anchor-id="book-building-vs.-auction-mechanisms"><span class="header-section-number">43.4.2</span> Book Building vs.&nbsp;Auction Mechanisms</h3>
<p>Vietnamese IPO history provides variation in allocation mechanisms. State-owned enterprise equitizations have used Dutch auctions, while private-sector IPOs have used book building. This institutional variation allows structural comparison of the mechanisms.</p>
<p><strong>Book Building</strong> <span class="citation" data-cites="benveniste1989investment">(<a href="references.html#ref-benveniste1989investment" role="doc-biblioref">Benveniste and Spindt 1989</a>)</span>: The underwriter solicits indications of interest from institutional investors during the roadshow. Investors who reveal positive information (high valuations) receive favorable allocations as compensation. The mechanism aggregates information efficiently but grants discretion to the underwriter.</p>
<p><strong>Uniform-Price Auction</strong>: All winning bidders pay the same market-clearing price. This eliminates the underwriterâ€™s allocation discretion but may lead to free-riding on information revelation.</p>
<div id="ipo-data" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load IPO data</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>ipo_data <span class="op">=</span> dc.get_ipo_data(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2005-01-01"</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute first-day returns (underpricing)</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>ipo_data[<span class="st">"underpricing"</span>] <span class="op">=</span> (</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    (ipo_data[<span class="st">"first_day_close"</span>] <span class="op">-</span> ipo_data[<span class="st">"offer_price"</span>]) <span class="op">/</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    ipo_data[<span class="st">"offer_price"</span>]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Classify mechanism</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>ipo_data[<span class="st">"mechanism"</span>] <span class="op">=</span> ipo_data[<span class="st">"ipo_method"</span>].<span class="bu">map</span>({</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"auction"</span>: <span class="st">"Auction"</span>,</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"book_building"</span>: <span class="st">"Book Building"</span>,</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fixed_price"</span>: <span class="st">"Fixed Price"</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total IPOs: </span><span class="sc">{</span><span class="bu">len</span>(ipo_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"By mechanism:</span><span class="ch">\n</span><span class="sc">{</span>ipo_data[<span class="st">'mechanism'</span>]<span class="sc">.</span>value_counts()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-ipo-underpricing" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="16">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-ipo-underpricing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.5: IPO Underpricing by Allocation Mechanism
</figcaption>
<div aria-describedby="tbl-ipo-underpricing-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ipo_summary <span class="op">=</span> (</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    ipo_data.groupby(<span class="st">"mechanism"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        n_ipos<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"count"</span>),</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>        mean_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"mean"</span>),</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        median_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"median"</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        std_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"std"</span>),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        pct_positive<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean()),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        mean_proceeds<span class="op">=</span>(<span class="st">"proceeds_bn_vnd"</span>, <span class="st">"mean"</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>ipo_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
<section id="structural-estimation-of-information-asymmetry" class="level3" data-number="43.4.3">
<h3 data-number="43.4.3" class="anchored" data-anchor-id="structural-estimation-of-information-asymmetry"><span class="header-section-number">43.4.3</span> Structural Estimation of Information Asymmetry</h3>
<p>We estimate the <span class="citation" data-cites="rock1986new">Rock (<a href="references.html#ref-rock1986new" role="doc-biblioref">1986</a>)</span> model parameters (i.e., the fraction of informed investors (<span class="math inline">\(\mu\)</span>) and the precision of their information (<span class="math inline">\(\sigma_v^2\)</span>)) using the method of simulated moments (MSM).</p>
<p>The model predicts two key moments:</p>
<p>1 . Average underpricing: <span class="math inline">\(E[U] = f(\mu, \sigma_v^2)\)</span> 2. Cross-sectional variance of underpricing: <span class="math inline">\(\text{Var}(U) = g(\mu, \sigma_v^2)\)</span></p>
<p>We match these model-implied moments to the data.</p>
<div id="rock-model-estimation" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rock_model_moments(params, n_sim<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate Rock (1986) IPO model and compute moments.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    params : tuple</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">        (mu, sigma_v) - fraction of informed investors,</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">        std dev of true value.</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple : (mean underpricing, variance of underpricing).</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    mu, sigma_v <span class="op">=</span> params</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># True values</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.random.lognormal(mean<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span>sigma_v, size<span class="op">=</span>n_sim)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Offer price: set to break even for uninformed</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplified: P = E[v] * discount_factor</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> <span class="fl">0.9</span>  <span class="co"># 10% average discount</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First-day returns</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> (v <span class="op">-</span> P) <span class="op">/</span> P</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allocation probability for uninformed in good IPOs</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Depends on mu: more informed -&gt; more rationing</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    good_mask <span class="op">=</span> v <span class="op">&gt;</span> P</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    alpha_g <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> mu) <span class="op">/</span> <span class="fl">1.0</span>  <span class="co"># Simplified rationing</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uninformed realized returns</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    uninformed_returns <span class="op">=</span> np.where(</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        good_mask,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        alpha_g <span class="op">*</span> returns,</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        returns</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    mean_u <span class="op">=</span> uninformed_returns.mean()</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    var_u <span class="op">=</span> uninformed_returns.var()</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_u, var_u</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rock_model_objective(params, target_moments, weight_matrix<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="co">    GMM objective for Rock model estimation.</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    mu, sigma_v <span class="op">=</span> params</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mu <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> mu <span class="op">&gt;=</span> <span class="dv">1</span> <span class="kw">or</span> sigma_v <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> sigma_v <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1e10</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    model_moments <span class="op">=</span> rock_model_moments(params)</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> np.array(model_moments) <span class="op">-</span> np.array(target_moments)</span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weight_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>        weight_matrix <span class="op">=</span> np.eye(<span class="bu">len</span>(diff))</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> diff <span class="op">@</span> weight_matrix <span class="op">@</span> diff</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Target moments from data</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>target_mean <span class="op">=</span> ipo_data[<span class="st">"underpricing"</span>].mean()</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>target_var <span class="op">=</span> ipo_data[<span class="st">"underpricing"</span>].var()</span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> minimize(</span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    rock_model_objective,</span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>[<span class="fl">0.3</span>, <span class="fl">0.5</span>],</span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>([target_mean, target_var],),</span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"Nelder-Mead"</span>,</span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"maxiter"</span>: <span class="dv">5000</span>}</span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a>mu_hat, sigma_v_hat <span class="op">=</span> result.x</span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rock Model Estimates:"</span>)</span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Fraction informed (Î¼): </span><span class="sc">{</span>mu_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Value uncertainty (Ïƒ_v): </span><span class="sc">{</span>sigma_v_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Objective value: </span><span class="sc">{</span>result<span class="sc">.</span>fun<span class="sc">:.6f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-ipo-underpricing-time" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ipo-underpricing-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ipo_plot <span class="op">=</span> ipo_data.dropna(subset<span class="op">=</span>[<span class="st">"underpricing"</span>, <span class="st">"mechanism"</span>]).copy()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>ipo_plot[<span class="st">"year"</span>] <span class="op">=</span> pd.to_datetime(ipo_plot[<span class="st">"ipo_date"</span>]).dt.year</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>annual_underpricing <span class="op">=</span> (</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    ipo_plot.groupby([<span class="st">"year"</span>, <span class="st">"mechanism"</span>])</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        mean_up<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"mean"</span>),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        n<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"count"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n &gt;= 3"</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(annual_underpricing, p9.aes(</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"year"</span>, y<span class="op">=</span><span class="st">"mean_up"</span>, color<span class="op">=</span><span class="st">"mechanism"</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(p9.aes(size<span class="op">=</span><span class="st">"n"</span>))</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>])</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Average First-Day Return"</span>,</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"IPO Underpricing by Allocation Mechanism"</span>,</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Mechanism"</span>, size<span class="op">=</span><span class="st">"# IPOs"</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-ipo-underpricing-time-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.5
</figcaption>
</figure>
</div>
</section>
<section id="counterfactual-welfare-under-alternative-mechanisms" class="level3" data-number="43.4.4">
<h3 data-number="43.4.4" class="anchored" data-anchor-id="counterfactual-welfare-under-alternative-mechanisms"><span class="header-section-number">43.4.4</span> Counterfactual: Welfare Under Alternative Mechanisms</h3>
<p>With the structural parameters <span class="math inline">\((\hat{\mu}, \hat{\sigma}_v)\)</span> in hand, we can simulate counterfactual outcomes. For instance: if all Vietnamese IPOs used uniform-price auctions instead of book building, how would underpricing and welfare change?</p>
<div id="counterfactual-ipo" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_ipo_mechanism(mu, sigma_v, mechanism<span class="op">=</span><span class="st">"book_building"</span>,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                           n_sim<span class="op">=</span><span class="dv">50000</span>):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate IPO outcomes under different mechanisms.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns issuer surplus, informed profit, uninformed profit.</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.random.lognormal(mean<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span>sigma_v, size<span class="op">=</span>n_sim)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mechanism <span class="op">==</span> <span class="st">"book_building"</span>:</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price partially reveals information</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># P = E[v] + 0.5 * (v - E[v]) * signal_quality</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> v <span class="op">+</span> np.random.normal(<span class="dv">0</span>, sigma_v <span class="op">*</span> <span class="fl">0.5</span>, n_sim)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> (signal <span class="op">-</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> P.clip(<span class="bu">min</span><span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mechanism <span class="op">==</span> <span class="st">"auction"</span>:</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Competitive bidding: P closer to v</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma_v <span class="op">*</span> <span class="fl">0.3</span>, n_sim)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> v <span class="op">+</span> noise</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> P.clip(<span class="bu">min</span><span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mechanism <span class="op">==</span> <span class="st">"fixed_price"</span>:</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fixed at E[v] * discount</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> np.full(n_sim, np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> <span class="fl">0.85</span>)</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    underpricing <span class="op">=</span> (v <span class="op">-</span> P) <span class="op">/</span> P</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    issuer_surplus <span class="op">=</span> P  <span class="co"># Revenue per share</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    investor_surplus <span class="op">=</span> v <span class="op">-</span> P  <span class="co"># Profit per share</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mechanism"</span>: mechanism,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mean_underpricing"</span>: underpricing.mean(),</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"median_underpricing"</span>: np.median(underpricing),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"std_underpricing"</span>: underpricing.std(),</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"issuer_revenue"</span>: issuer_surplus.mean(),</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"investor_profit"</span>: investor_surplus.mean(),</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"money_left"</span>: (investor_surplus[investor_surplus <span class="op">&gt;</span> <span class="dv">0</span>]).<span class="bu">sum</span>() <span class="op">/</span> n_sim</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare mechanisms</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>counterfactual <span class="op">=</span> pd.DataFrame([</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"book_building"</span>),</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"auction"</span>),</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"fixed_price"</span>)</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>]).set_index(<span class="st">"mechanism"</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>counterfactual</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="limit-order-book-models" class="level2" data-number="43.5">
<h2 data-number="43.5" class="anchored" data-anchor-id="limit-order-book-models"><span class="header-section-number">43.5</span> Limit Order Book Models</h2>
<section id="order-submission-as-a-strategic-choice" class="level3" data-number="43.5.1">
<h3 data-number="43.5.1" class="anchored" data-anchor-id="order-submission-as-a-strategic-choice"><span class="header-section-number">43.5.1</span> Order Submission as a Strategic Choice</h3>
<p>In a limit order market, every trader faces a fundamental tradeoff: submit a market order (immediate execution, but at an adverse price) or a limit order (better price, but risk of non-execution). <span class="citation" data-cites="parlour1998price">Parlour (<a href="references.html#ref-parlour1998price" role="doc-biblioref">1998</a>)</span> models this as a sequential game where each traderâ€™s optimal strategy depends on the current state of the order book.</p>
<p>Let <span class="math inline">\(a_t\)</span> and <span class="math inline">\(b_t\)</span> denote the best ask and bid prices at time <span class="math inline">\(t\)</span>, with the spread <span class="math inline">\(s_t = a_t - b_t\)</span>. A buyer who arrives at time <span class="math inline">\(t\)</span> chooses between:</p>
<ul>
<li><strong>Market buy</strong>: Execute immediately at <span class="math inline">\(a_t\)</span>. Cost: <span class="math inline">\(a_t - v_t\)</span> where <span class="math inline">\(v_t\)</span> is the true value.</li>
<li><strong>Limit buy at</strong> <span class="math inline">\(b_t\)</span>: Provides liquidity. If executed, profit: <span class="math inline">\(v_t - b_t\)</span>. Probability of execution: <span class="math inline">\(\pi(b_t, \text{book state})\)</span>.</li>
</ul>
<p>The buyer submits a market order if:</p>
<p><span id="eq-order-choice"><span class="math display">\[
a_t - v_t &lt; (1 - \pi_t)(v_t - b_t) + \pi_t \cdot 0
\tag{43.16}\]</span></span></p>
<p>Rearranging: market orders are optimal when the spread is narrow relative to the non-execution risk of limit orders. This generates the empirically observed pattern that limit orders are more attractive when spreads are wide and the book is thin.</p>
</section>
<section id="the-glosten-milgrom-model" class="level3" data-number="43.5.2">
<h3 data-number="43.5.2" class="anchored" data-anchor-id="the-glosten-milgrom-model"><span class="header-section-number">43.5.2</span> The Glosten-Milgrom Model</h3>
<p><span class="citation" data-cites="glosten1985bid">Glosten and Milgrom (<a href="references.html#ref-glosten1985bid" role="doc-biblioref">1985</a>)</span> provide the foundational structural model of bid-ask spread determination under asymmetric information. A competitive market maker sets bid and ask prices to break even in expectation, recognizing that some trades come from informed traders.</p>
<p>Let <span class="math inline">\(\mu\)</span> denote the probability that an incoming order is from an informed trader, and let <span class="math inline">\(V^H\)</span> and <span class="math inline">\(V^L\)</span> denote the high and low values of the asset (<span class="math inline">\(\Pr(V = V^H) = p\)</span>). The zero-profit conditions yield:</p>
<p><span id="eq-gm-ask"><span class="math display">\[
a = E[V \mid \text{buy order}] = \frac{p(1-\mu) + p\mu}{(1-\mu) + p\mu} V^H + \frac{(1-p)(1-\mu)}{(1-\mu) + p\mu} V^L
\tag{43.17}\]</span></span></p>
<p><span id="eq-gm-bid"><span class="math display">\[
b = E[V \mid \text{sell order}] = \frac{p(1-\mu)}{(1-\mu) + (1-p)\mu} V^H + \frac{(1-p)(1-\mu) + (1-p)\mu}{(1-\mu) + (1-p)\mu} V^L
\tag{43.18}\]</span></span></p>
<p>The spread <span class="math inline">\(s = a - b\)</span> is positive whenever <span class="math inline">\(\mu &gt; 0\)</span>, and increases in both the proportion of informed traders (<span class="math inline">\(\mu\)</span>) and the information asymmetry (<span class="math inline">\(V^H - V^L\)</span>). This decomposition is foundational: the spread compensates liquidity providers for the adverse selection cost of trading with informed counterparties.</p>
</section>
<section id="pin-probability-of-informed-trading" class="level3" data-number="43.5.3">
<h3 data-number="43.5.3" class="anchored" data-anchor-id="pin-probability-of-informed-trading"><span class="header-section-number">43.5.3</span> PIN: Probability of Informed Trading</h3>
<p><span class="citation" data-cites="easley1996liquidity">Easley et al. (<a href="references.html#ref-easley1996liquidity" role="doc-biblioref">1996</a>)</span> extend the Glosten-Milgrom framework to a dynamic setting and develop the Probability of Informed Trading (PIN) measure, which can be estimated from trade data. The model assumes that on each trading day, an information event occurs with probability <span class="math inline">\(\alpha\)</span>. Conditional on an event, it is bad news with probability <span class="math inline">\(\delta\)</span>. Informed traders arrive at rate <span class="math inline">\(\mu\)</span>; uninformed buyers and sellers arrive at rates <span class="math inline">\(\varepsilon_b\)</span> and <span class="math inline">\(\varepsilon_s\)</span>, respectively.</p>
<p>The likelihood of observing <span class="math inline">\(B_t\)</span> buys and <span class="math inline">\(S_t\)</span> sells on day <span class="math inline">\(t\)</span> is:</p>
<p><span id="eq-pin-likelihood"><span class="math display">\[
\mathcal{L}(B_t, S_t | \boldsymbol{\theta}) = (1-\alpha) f(B_t|\varepsilon_b) f(S_t|\varepsilon_s) + \alpha\delta \cdot f(B_t|\varepsilon_b) f(S_t|\varepsilon_s + \mu) + \alpha(1-\delta) \cdot f(B_t|\varepsilon_b + \mu) f(S_t|\varepsilon_s)
\tag{43.19}\]</span></span></p>
<p>where <span class="math inline">\(f(\cdot|\lambda)\)</span> is the Poisson density with rate <span class="math inline">\(\lambda\)</span>, and <span class="math inline">\(\boldsymbol{\theta} = (\alpha, \delta, \mu, \varepsilon_b, \varepsilon_s)\)</span>. PIN is then:</p>
<p><span id="eq-pin"><span class="math display">\[
\text{PIN} = \frac{\alpha \mu}{\alpha \mu + \varepsilon_b + \varepsilon_s}
\tag{43.20}\]</span></span></p>
<div id="pin-estimation" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pin_log_likelihood(params, data):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute negative log-likelihood for the Easley-Kiefer-O'Hara-Paperman</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="co">    (1996) PIN model.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">    params : array</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">        [alpha, delta, mu, eps_b, eps_s]</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co">    data : DataFrame</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: buys, sells (daily counts).</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">    float : Negative log-likelihood.</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    alpha, delta, mu, eps_b, eps_s <span class="op">=</span> params</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parameter bounds</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (alpha <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> alpha <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">or</span> delta <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> delta <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">or</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> eps_b <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> eps_s <span class="op">&lt;</span> <span class="dv">0</span>):</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1e15</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> data[<span class="st">"buys"</span>].values</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> data[<span class="st">"sells"</span>].values</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use log-sum-exp for numerical stability</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Three components: no event, bad news, good news</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    log_L <span class="op">=</span> np.zeros(<span class="bu">len</span>(B))</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(B)):</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        b, s <span class="op">=</span> B[i], S[i]</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log-Poisson components</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> log_poisson(k, lam):</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> lam <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="op">-</span><span class="fl">1e10</span> <span class="cf">if</span> k <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> k <span class="op">*</span> np.log(lam) <span class="op">-</span> lam <span class="op">-</span> np.<span class="bu">sum</span>(np.log(np.arange(<span class="dv">1</span>, k <span class="op">+</span> <span class="dv">1</span>)))</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="co"># No event</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        c1 <span class="op">=</span> (np.log(<span class="dv">1</span> <span class="op">-</span> alpha <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b) <span class="op">+</span> log_poisson(s, eps_s))</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bad news (extra sells)</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        c2 <span class="op">=</span> (np.log(alpha <span class="op">*</span> delta <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b) <span class="op">+</span> log_poisson(s, eps_s <span class="op">+</span> mu))</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Good news (extra buys)</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>        c3 <span class="op">=</span> (np.log(alpha <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> delta) <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b <span class="op">+</span> mu) <span class="op">+</span> log_poisson(s, eps_s))</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log-sum-exp</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>        max_c <span class="op">=</span> <span class="bu">max</span>(c1, c2, c3)</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>        log_L[i] <span class="op">=</span> max_c <span class="op">+</span> np.log(</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>            np.exp(c1 <span class="op">-</span> max_c) <span class="op">+</span> np.exp(c2 <span class="op">-</span> max_c) <span class="op">+</span> np.exp(c3 <span class="op">-</span> max_c)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>np.<span class="bu">sum</span>(log_L)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_pin(buys, sells, n_starts<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate PIN via MLE with multiple random starts.</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Estimated parameters and PIN value.</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.DataFrame({<span class="st">"buys"</span>: buys, <span class="st">"sells"</span>: sells})</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    best_result <span class="op">=</span> <span class="va">None</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>    best_nll <span class="op">=</span> np.inf</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    avg_b <span class="op">=</span> data[<span class="st">"buys"</span>].mean()</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    avg_s <span class="op">=</span> data[<span class="st">"sells"</span>].mean()</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_starts):</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Random initial values</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>        alpha0 <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.8</span>)</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>        delta0 <span class="op">=</span> np.random.uniform(<span class="fl">0.2</span>, <span class="fl">0.8</span>)</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>        mu0 <span class="op">=</span> np.random.uniform(<span class="dv">0</span>, <span class="bu">max</span>(avg_b, avg_s))</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>        eps_b0 <span class="op">=</span> avg_b <span class="op">*</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>        eps_s0 <span class="op">=</span> avg_s <span class="op">*</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> minimize(</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>                pin_log_likelihood,</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>                x0<span class="op">=</span>[alpha0, delta0, mu0, eps_b0, eps_s0],</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>(data,),</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>                method<span class="op">=</span><span class="st">"L-BFGS-B"</span>,</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>                bounds<span class="op">=</span>[(<span class="fl">0.01</span>, <span class="fl">0.99</span>), (<span class="fl">0.01</span>, <span class="fl">0.99</span>),</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>                        (<span class="fl">0.01</span>, <span class="va">None</span>), (<span class="fl">0.01</span>, <span class="va">None</span>), (<span class="fl">0.01</span>, <span class="va">None</span>)],</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>                options<span class="op">=</span>{<span class="st">"maxiter"</span>: <span class="dv">1000</span>}</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> result.fun <span class="op">&lt;</span> best_nll:</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>                best_nll <span class="op">=</span> result.fun</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>                best_result <span class="op">=</span> result</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"pin"</span>: np.nan}</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>    alpha, delta, mu, eps_b, eps_s <span class="op">=</span> best_result.x</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>    pin <span class="op">=</span> alpha <span class="op">*</span> mu <span class="op">/</span> (alpha <span class="op">*</span> mu <span class="op">+</span> eps_b <span class="op">+</span> eps_s)</span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha"</span>: alpha,</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta"</span>: delta,</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu"</span>: mu,</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eps_b"</span>: eps_b,</span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eps_s"</span>: eps_s,</span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pin"</span>: pin,</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_likelihood"</span>: <span class="op">-</span>best_nll</span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="pin-cross-section" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate PIN for a cross-section of stocks</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Using daily buy/sell counts from Lee-Ready classification</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>trade_counts <span class="op">=</span> dc.get_trade_counts(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2023-12-31"</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample of stocks for estimation (PIN is computationally intensive)</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>top_stocks <span class="op">=</span> (</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    trade_counts.groupby(<span class="st">"ticker"</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    .agg(n_days<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"nunique"</span>))</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n_days &gt;= 200"</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    .index[:<span class="dv">50</span>]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>pin_estimates <span class="op">=</span> []</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ticker <span class="kw">in</span> top_stocks:</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    stock_data <span class="op">=</span> trade_counts[trade_counts[<span class="st">"ticker"</span>] <span class="op">==</span> ticker]</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> estimate_pin(</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        stock_data[<span class="st">"buys"</span>].values,</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>        stock_data[<span class="st">"sells"</span>].values,</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>        n_starts<span class="op">=</span><span class="dv">5</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">"ticker"</span>] <span class="op">=</span> ticker</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    pin_estimates.append(result)</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>pin_df <span class="op">=</span> pd.DataFrame(pin_estimates).dropna(subset<span class="op">=</span>[<span class="st">"pin"</span>])</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"PIN estimates for </span><span class="sc">{</span><span class="bu">len</span>(pin_df)<span class="sc">}</span><span class="ss"> stocks"</span>)</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean PIN: </span><span class="sc">{</span>pin_df[<span class="st">'pin'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median PIN: </span><span class="sc">{</span>pin_df[<span class="st">'pin'</span>]<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-pin-distribution" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="22">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-pin-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(pin_df, p9.aes(x<span class="op">=</span><span class="st">"pin"</span>))</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">25</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>        xintercept<span class="op">=</span>pin_df[<span class="st">"pin"</span>].median(),</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>        linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"PIN"</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Informed Trading Probability"</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-pin-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.6
</figcaption>
</figure>
</div>
</section>
<section id="pin-and-asset-pricing" class="level3" data-number="43.5.4">
<h3 data-number="43.5.4" class="anchored" data-anchor-id="pin-and-asset-pricing"><span class="header-section-number">43.5.4</span> PIN and Asset Pricing</h3>
<p><span class="citation" data-cites="easley2002information">Easley, Hvidkjaer, and Oâ€™hara (<a href="references.html#ref-easley2002information" role="doc-biblioref">2002</a>)</span> argue that PIN should be priced in the cross-section of expected returns: stocks with higher information asymmetry require a risk premium to compensate uninformed investors. We test this prediction using Fama-MacBeth regressions.</p>
<div id="pin-asset-pricing" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge PIN with firm characteristics and forward returns</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>pin_chars <span class="op">=</span> pin_df[[<span class="st">"ticker"</span>, <span class="st">"pin"</span>]].merge(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    dc.get_firm_characteristics(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2023-12-31"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    ).groupby(<span class="st">"ticker"</span>).last().reset_index()[</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"ticker"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward 12-month returns (2024)</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>forward_returns <span class="op">=</span> dc.get_annual_returns(</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2024-01-01"</span>,</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>pin_returns <span class="op">=</span> pin_chars.merge(</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    forward_returns[[<span class="st">"ticker"</span>, <span class="st">"annual_ret"</span>]],</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>,</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(pin_returns) <span class="op">&gt;</span> <span class="dv">20</span>:</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    cs_model <span class="op">=</span> sm.OLS(</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>        pin_returns[<span class="st">"annual_ret"</span>],</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>            pin_returns[[<span class="st">"pin"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]]</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Cross-Sectional Return Regression with PIN:"</span>)</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">"pin"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]:</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>cs_model<span class="sc">.</span>params[var]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"(t = </span><span class="sc">{</span>cs_model<span class="sc">.</span>tvalues[var]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="estimation-challenges-in-limit-order-book-models" class="level3" data-number="43.5.5">
<h3 data-number="43.5.5" class="anchored" data-anchor-id="estimation-challenges-in-limit-order-book-models"><span class="header-section-number">43.5.5</span> Estimation Challenges in Limit Order Book Models</h3>
<p>Structural estimation of limit order book models faces several challenges specific to Vietnamese markets:</p>
<p><strong>Tick size effects.</strong> Vietnamese exchanges use discrete tick sizes that vary with price level. At low prices, the minimum tick size represents a large fraction of the price, artificially widening the spread and distorting the structural parameters. The standard Glosten-Milgrom and PIN models assume continuous prices; adapting them to discrete price grids requires the modifications proposed by <span class="citation" data-cites="bollen2004modeling">Bollen, Smith, and Whaley (<a href="references.html#ref-bollen2004modeling" role="doc-biblioref">2004</a>)</span>.</p>
<p><strong>Price limits.</strong> When a stock hits its price limit, the order book is effectively frozen at one side. Orders accumulate but cannot execute until the limit is lifted. This creates a censoring problem analogous to the price limit censoring in return distributions: the observed order flow is a truncated version of the latent flow.</p>
<p><strong>Missing data.</strong> Full order book snapshots at high frequency are not universally available for Vietnamese stocks. PIN estimation requires only daily buy/sell counts, making it feasible with lower-frequency data. But richer models (<span class="citation" data-cites="foucault1999order">Foucault (<a href="references.html#ref-foucault1999order" role="doc-biblioref">1999</a>)</span> dynamic limit order book, <span class="citation" data-cites="rocsu2009dynamic">RoÅŸu (<a href="references.html#ref-rocsu2009dynamic" role="doc-biblioref">2009</a>)</span> continuous-time model) require tick-by-tick order book data that may be unavailable for smaller stocks.</p>
<p><strong>Institutional features.</strong> The coexistence of HOSE (continuous auction) and HNX (with periodic call auctions for less liquid stocks) creates heterogeneity in the appropriate structural model. A model estimated on HOSE continuous trading data does not directly apply to HNX call auction stocks.</p>
</section>
</section>
<section id="when-structural-models-are-worth-it" class="level2" data-number="43.6">
<h2 data-number="43.6" class="anchored" data-anchor-id="when-structural-models-are-worth-it"><span class="header-section-number">43.6</span> When Structural Models Are Worth It</h2>
<section id="decision-framework" class="level3" data-number="43.6.1">
<h3 data-number="43.6.1" class="anchored" data-anchor-id="decision-framework"><span class="header-section-number">43.6.1</span> Decision Framework</h3>
<p>Structural estimation is not always the right tool. The additional complexity, data requirements, and model risk must be justified by the research question. <a href="#tbl-when-structural" class="quarto-xref">Table&nbsp;<span>43.6</span></a> provides a decision framework.</p>
<div id="tbl-when-structural" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-when-structural-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.6: When to Choose Structural vs.&nbsp;Reduced Form
</figcaption>
<div aria-describedby="tbl-when-structural-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 24%">
<col style="width: 36%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th>Criterion</th>
<th>Structural Preferred</th>
<th>Reduced Form Preferred</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Research question</td>
<td>Counterfactual or policy evaluation</td>
<td>Causal effect of observed variation</td>
</tr>
<tr class="even">
<td>Data availability</td>
<td>Rich micro-data (transactions, holdings)</td>
<td>Standard panel (returns, fundamentals)</td>
</tr>
<tr class="odd">
<td>Institutional environment</td>
<td>Stable (model assumptions plausible)</td>
<td>Rapidly changing (model may be misspecified)</td>
</tr>
<tr class="even">
<td>Number of parameters</td>
<td>Few primitives, many observables</td>
<td>Many parameters, few identifying assumptions</td>
</tr>
<tr class="odd">
<td>Publication venue</td>
<td>JF, RFS, Econometrica, JPE</td>
<td>JFE, RFS, MS, JFQA</td>
</tr>
<tr class="even">
<td>Computational budget</td>
<td>Weeks to months of estimation</td>
<td>Hours to days</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="data-requirements" class="level3" data-number="43.6.2">
<h3 data-number="43.6.2" class="anchored" data-anchor-id="data-requirements"><span class="header-section-number">43.6.2</span> Data Requirements</h3>
<p>Structural models are data-hungry. <a href="#tbl-data-requirements" class="quarto-xref">Table&nbsp;<span>43.7</span></a> summarizes the minimum data needs for each model class covered in this chapter.</p>
<div id="tbl-data-requirements" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-data-requirements-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;43.7: Data Requirements for Structural Estimation
</figcaption>
<div aria-describedby="tbl-data-requirements-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 21%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th>Model</th>
<th>Minimum Data</th>
<th>Ideal Data</th>
<th>Vietnamese Availability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>KY demand system</td>
<td>Quarterly institutional holdings + prices</td>
<td>13F-equivalent filings + fund flows</td>
<td>Partial (semi-annual disclosure)</td>
</tr>
<tr class="even">
<td>Almgren-Chriss</td>
<td>Daily volume, spread, volatility</td>
<td>Intraday order-by-order data</td>
<td>Good (HOSE provides)</td>
</tr>
<tr class="odd">
<td>Rock/IPO</td>
<td>Offer price, first-day close, allocation</td>
<td>Investor-level bids and allocations</td>
<td>Limited (auction data available)</td>
</tr>
<tr class="even">
<td>PIN</td>
<td>Daily buy/sell counts (Lee-Ready)</td>
<td>Tick-by-tick trade and quote</td>
<td>Moderate (requires trade classification)</td>
</tr>
<tr class="odd">
<td>Glosten-Milgrom</td>
<td>Best bid/ask, trade direction</td>
<td>Full order book snapshots</td>
<td>Moderate (top-of-book available)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="computational-cost" class="level3" data-number="43.6.3">
<h3 data-number="43.6.3" class="anchored" data-anchor-id="computational-cost"><span class="header-section-number">43.6.3</span> Computational Cost</h3>
<p>Structural estimation is orders of magnitude more expensive than reduced-form regression. The cost arises from three sources:</p>
<p><strong>Likelihood evaluation.</strong> Each evaluation of the structural likelihood or moment function requires solving the model for given parameters. For dynamic models (e.g., inventory models, dynamic discrete choice), this involves solving a dynamic programming problem at each iteration.</p>
<p><strong>Optimization.</strong> The GMM or MLE objective is typically non-convex, requiring multiple starting points and global optimization algorithms. The PIN model with 5 parameters requires <span class="math inline">\(\sim 10\)</span> random starts; a richer model with <span class="math inline">\(\sim 20\)</span> parameters might require hundreds.</p>
<p><strong>Inference.</strong> Standard errors for structural parameters often require bootstrapping (because the asymptotic distribution is non-standard or the delta method is unreliable), adding a multiplicative factor of 200â€“1000 to the computational budget.</p>
<div id="computational-cost-comparison" class="cell" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Illustration: computational cost comparison</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduced form: OLS regression</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>n_obs <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>X_sim <span class="op">=</span> np.random.randn(n_obs, <span class="dv">5</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>y_sim <span class="op">=</span> X_sim <span class="op">@</span> np.random.randn(<span class="dv">5</span>) <span class="op">+</span> np.random.randn(n_obs)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    sm.OLS(y_sim, sm.add_constant(X_sim)).fit()</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>ols_time <span class="op">=</span> (time.time() <span class="op">-</span> start) <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Structural: PIN estimation (single stock)</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>sim_buys <span class="op">=</span> np.random.poisson(<span class="dv">50</span>, <span class="dv">250</span>)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>sim_sells <span class="op">=</span> np.random.poisson(<span class="dv">45</span>, <span class="dv">250</span>)</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>pin_result <span class="op">=</span> estimate_pin(sim_buys, sim_sells, n_starts<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>pin_time <span class="op">=</span> time.time() <span class="op">-</span> start</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Computational Cost Comparison:"</span>)</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  OLS (100k obs): </span><span class="sc">{</span>ols_time<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ms per estimation"</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  PIN (250 days, 5 starts): </span><span class="sc">{</span>pin_time<span class="sc">:.1f}</span><span class="ss"> s per stock"</span>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ratio: </span><span class="sc">{</span>pin_time <span class="op">/</span> ols_time<span class="sc">:.0f}</span><span class="ss">x"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Computational Cost Comparison:
  OLS (100k obs): 42.7 ms per estimation
  PIN (250 days, 5 starts): 26.9 s per stock
  Ratio: 632x</code></pre>
</div>
</div>
</section>
<section id="interpretation-risks" class="level3" data-number="43.6.4">
<h3 data-number="43.6.4" class="anchored" data-anchor-id="interpretation-risks"><span class="header-section-number">43.6.4</span> Interpretation Risks</h3>
<p>The primary risk of structural estimation is model misspecification. If the model is wrong, the estimated parameters have no economic meaning and the counterfactual predictions are unreliable. Several strategies mitigate this risk:</p>
<p><strong>Specification tests.</strong> Over-identifying restrictions (more moments than parameters) provide the Hansen <span class="math inline">\(J\)</span>-test for model fit. A rejection suggests misspecification, though the test has low power in small samples.</p>
<p><strong>Model comparison.</strong> Estimate multiple nested or non-nested models and compare fit. If a simpler model fits the data equally well, prefer it (Occamâ€™s razor).</p>
<p><strong>Sensitivity analysis.</strong> Report how structural parameters change under plausible alternative assumptions (e.g., different functional forms for the impact function, different distributional assumptions for valuations).</p>
<p><strong>Out-of-sample validation.</strong> Estimate the model on one sample period and test its predictions on a holdout sample. Structural models that fit in-sample but fail out-of-sample are likely overfit.</p>
</section>
<section id="journal-expectations" class="level3" data-number="43.6.5">
<h3 data-number="43.6.5" class="anchored" data-anchor-id="journal-expectations"><span class="header-section-number">43.6.5</span> Journal Expectations</h3>
<p>Structural papers in top finance journals are held to specific standards:</p>
<p><strong>Identification clarity.</strong> The paper must clearly state which parameters are identified, from which moments, and what variation in the data provides identification. The <span class="citation" data-cites="rust1987optimal">Rust (<a href="references.html#ref-rust1987optimal" role="doc-biblioref">1987</a>)</span> critique that without clear identification, structural estimation is curve-fitting, must be addressed head-on.</p>
<p><strong>Counterfactual credibility.</strong> Counterfactual exercises should be economically motivated and the range of counterfactual scenarios should not extrapolate far beyond the data.</p>
<p><strong>Robustness to specification.</strong> Reviewers will ask what happens under alternative distributional assumptions, alternative moment conditions, and alternative model features.</p>
<p><strong>Transparency.</strong> Code and data should be made available. Structural estimation is sufficiently complex that replicability is a first-order concern.</p>
<!-- ## Exercises

1.  **Demand Elasticity Heterogeneity.** Extend the KY demand system by allowing demand elasticities to vary by investor type (mutual funds, insurance companies, pension funds, foreign institutional investors). Estimate separate $\boldsymbol{\beta}_i$ vectors for each type. Which investor type has the most elastic demand? Which has the most inelastic? Relate your findings to the price impact predictions of @gabaix2021search.

2.  **Optimal Execution with Price Limits.** Modify the Almgren-Chriss framework to incorporate Vietnamese daily price limits. The constraint is that the execution price on any day cannot exceed the limit: $|S_t - S_{t-1}| \leq L$. Solve the modified optimization numerically and compare the optimal trajectory with the unconstrained solution. How do price limits affect total execution cost and the optimal time horizon?

3.  **Mechanism Design for SOE Equitization.** Using the estimated Rock model parameters, simulate IPO outcomes under a Vickrey (second-price) auction mechanism. Compare welfare (issuer revenue, investor surplus, total surplus) with the observed auction and book building outcomes. Under what conditions does the Vickrey mechanism dominate?

4.  **PIN and Corporate Events.** Estimate PIN in event windows around earnings announcements, M&A announcements, and regulatory changes for a sample of Vietnamese firms. Does PIN spike before public announcements (consistent with informed trading or leakage)? Compare the magnitude of the pre-announcement PIN increase across event types.

5.  **Kyle's Lambda and Market Depth.** Estimate Kyle's $\lambda$ (the price impact coefficient from the regression of price changes on signed order flow) for the cross-section of Vietnamese stocks. Test whether $\lambda$ is inversely related to measures of market depth (average volume, number of active traders, institutional ownership). Construct a tradeable portfolio long low-$\lambda$ (liquid) stocks and short high-$\lambda$ (illiquid) stocks. Does this liquidity factor earn a risk premium?

6.  **Structural Break in Market Microstructure.** Vietnam implemented tick size changes and trading hour extensions at various points. Using the PIN model and the Roll spread, estimate structural breaks in information asymmetry and transaction costs around these regulatory changes. Do the structural parameters change in the direction predicted by market microstructure theory? Use the @bai1998estimating sequential breakpoint methodology to formally test for and date the breaks. -->
</section>
</section>
<section id="summary" class="level2" data-number="43.7">
<h2 data-number="43.7" class="anchored" data-anchor-id="summary"><span class="header-section-number">43.7</span> Summary</h2>
<p>This chapter introduced structural estimation as a distinct methodology for financial economics, one that trades the simplicity and transparency of reduced-form analysis for the ability to estimate economic primitives and conduct counterfactual policy evaluation. We implemented four classes of structural models: demand systems for financial assets, optimal execution and transaction cost models, IPO auction models, and limit order book models of informed trading.</p>
<p>The demand system approach of <span class="citation" data-cites="koijen2019demand">Koijen and Yogo (<a href="references.html#ref-koijen2019demand" role="doc-biblioref">2019</a>)</span> reveals that institutional investors in Vietnam exhibit heterogeneous demand elasticities across characteristics, with foreign investors showing different sensitivity patterns than domestic institutions. Market impact estimation confirms the universality of the square-root law, while the Almgren-Chriss framework provides the optimal execution benchmark for large institutional orders. The Rock IPO model quantifies the information asymmetry premium embedded in Vietnamese IPO underpricing, and the PIN model estimates the probability of informed trading across the cross-section.</p>
<p>Each model involves a tradeoff between the economic questions it can answer and the assumptions it requires. The decision to use structural estimation should be driven by the research question (specifically, whether counterfactual analysis is essential) and tempered by honest assessment of whether the modelâ€™s assumptions are sufficiently credible in the Vietnamese institutional environment. When they are, structural models provide insights that no amount of reduced-form regression can deliver.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-almgren2001optimal" class="csl-entry" role="listitem">
Almgren, Robert, and Neil Chriss. 2001. <span>â€œOptimal Execution of Portfolio Transactions.â€</span> <em>Journal of Risk</em> 3: 5â€“40.
</div>
<div id="ref-benveniste1989investment" class="csl-entry" role="listitem">
Benveniste, Lawrence M, and Paul A Spindt. 1989. <span>â€œHow Investment Bankers Determine the Offer Price and Allocation of New Issues.â€</span> <em>Journal of Financial Economics</em> 24 (2): 343â€“61.
</div>
<div id="ref-berry1995automobile" class="csl-entry" role="listitem">
Berry, Steven, James Levinsohn, and Ariel Pakes. 1995. <span>â€œAutomobile Prices in Market Equilibrium.â€</span> <em>Econometrica</em> 63 (4): 841â€“90.
</div>
<div id="ref-bollen2004modeling" class="csl-entry" role="listitem">
Bollen, Nicolas PB, Tom Smith, and Robert E Whaley. 2004. <span>â€œModeling the Bid/Ask Spread: Measuring the Inventory-Holding Premium.â€</span> <em>Journal of Financial Economics</em> 72 (1): 97â€“141.
</div>
<div id="ref-easley2002information" class="csl-entry" role="listitem">
Easley, David, Soeren Hvidkjaer, and Maureen Oâ€™hara. 2002. <span>â€œIs Information Risk a Determinant of Asset Returns?â€</span> <em>The Journal of Finance</em> 57 (5): 2185â€“2221.
</div>
<div id="ref-easley1996liquidity" class="csl-entry" role="listitem">
Easley, David, Nicholas M Kiefer, Maureen Oâ€™hara, and Joseph B Paperman. 1996. <span>â€œLiquidity, Information, and Infrequently Traded Stocks.â€</span> <em>The Journal of Finance</em> 51 (4): 1405â€“36.
</div>
<div id="ref-foucault1999order" class="csl-entry" role="listitem">
Foucault, Thierry. 1999. <span>â€œOrder Flow Composition and Trading Costs in a Dynamic Limit Order Market.â€</span> <em>Journal of Financial Markets</em> 2 (2): 99â€“134.
</div>
<div id="ref-gabaix2003theory" class="csl-entry" role="listitem">
Gabaix, Xavier, Parameswaran Gopikrishnan, Vasiliki Plerou, and H Eugene Stanley. 2003. <span>â€œA Theory of Power-Law Distributions in Financial Market Fluctuations.â€</span> <em>Nature</em> 423 (6937): 267â€“70.
</div>
<div id="ref-gabaix2021search" class="csl-entry" role="listitem">
Gabaix, Xavier, and Ralph SJ Koijen. 2021. <span>â€œIn Search of the Origins of Financial Fluctuations: The Inelastic Markets Hypothesis.â€</span> National Bureau of Economic Research.
</div>
<div id="ref-glosten1985bid" class="csl-entry" role="listitem">
Glosten, Lawrence R, and Paul R Milgrom. 1985. <span>â€œBid, Ask and Transaction Prices in a Specialist Market with Heterogeneously Informed Traders.â€</span> <em>Journal of Financial Economics</em> 14 (1): 71â€“100.
</div>
<div id="ref-hasbrouck1991measuring" class="csl-entry" role="listitem">
Hasbrouck, Joel. 1991. <span>â€œMeasuring the Information Content of Stock Trades.â€</span> <em>The Journal of Finance</em> 46 (1): 179â€“207.
</div>
<div id="ref-hasbrouck2009trading" class="csl-entry" role="listitem">
â€”â€”â€”. 2009. <span>â€œTrading Costs and Returns for US Equities: Estimating Effective Costs from Daily Data.â€</span> <em>The Journal of Finance</em> 64 (3): 1445â€“77.
</div>
<div id="ref-koijen2019demand" class="csl-entry" role="listitem">
Koijen, Ralph SJ, and Motohiro Yogo. 2019. <span>â€œA Demand System Approach to Asset Pricing.â€</span> <em>Journal of Political Economy</em> 127 (4): 1475â€“515.
</div>
<div id="ref-kyle1985continuous" class="csl-entry" role="listitem">
Kyle, Albert S. 1985. <span>â€œContinuous Auctions and Insider Trading.â€</span> <em>Econometrica: Journal of the Econometric Society</em>, 1315â€“35.
</div>
<div id="ref-parlour1998price" class="csl-entry" role="listitem">
Parlour, Christine A. 1998. <span>â€œPrice Dynamics in Limit Order Markets.â€</span> <em>The Review of Financial Studies</em> 11 (4): 789â€“816.
</div>
<div id="ref-rock1986new" class="csl-entry" role="listitem">
Rock, Kevin. 1986. <span>â€œWhy New Issues Are Underpriced.â€</span> <em>Journal of Financial Economics</em> 15 (1-2): 187â€“212.
</div>
<div id="ref-roll1984simple" class="csl-entry" role="listitem">
Roll, Richard. 1984. <span>â€œA Simple Implicit Measure of the Effective Bid-Ask Spread in an Efficient Market.â€</span> <em>The Journal of Finance</em> 39 (4): 1127â€“39.
</div>
<div id="ref-rocsu2009dynamic" class="csl-entry" role="listitem">
RoÅŸu, Ioanid. 2009. <span>â€œA Dynamic Model of the Limit Order Book.â€</span> <em>The Review of Financial Studies</em> 22 (11): 4601â€“41.
</div>
<div id="ref-rust1987optimal" class="csl-entry" role="listitem">
Rust, John. 1987. <span>â€œOptimal Replacement of GMC Bus Engines: An Empirical Model of Harold Zurcher.â€</span> <em>Econometrica: Journal of the Econometric Society</em>, 999â€“1033.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "Â© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./62_corporate_finance_estimators.html" class="pagination-link" aria-label="Corporate Finance Estimators and Identification">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./70_textual.html" class="pagination-link" aria-label="Textual Analysis">
        <span class="nav-page-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Structural Models in Finance</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>Most of empirical finance is reduced-form: regress returns on characteristics, estimate risk premia from factor portfolios, test whether a coefficient is significantly different from zero. Structural estimation takes a fundamentally different approach. It begins with an explicit economic model (i.e., specifying agents' preferences, information sets, constraints, and optimization problems) and estimates the model's primitive parameters directly from observed data. The payoff is the ability to perform counterfactual analysis: what would happen to prices if trading costs fell by half? How would IPO underpricing change if the allocation mechanism switched from book building to a uniform-price auction? What is the welfare cost of a particular market design choice? These questions are unanswerable within a reduced-form framework because they require knowledge of the data-generating process, not merely statistical associations within a single regime.</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>This chapter introduces the key structural estimation frameworks used in financial economics and implements them for Vietnamese equity markets. We cover four domains where structural models have proven most productive: investor demand estimation, trading cost and execution models, primary market auctions, and limit order book dynamics. Each domain involves distinct economic primitives such as preferences, beliefs, transaction costs, information asymmetries and each requires domain-specific identification strategies.</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>Vietnamese markets offer both challenges and opportunities for structural estimation. On the challenge side, data quality is uneven, market microstructure is evolving, and institutional features (price limits, foreign ownership caps, state ownership) introduce constraints that standard models do not accommodate. On the opportunity side, several features of Vietnamese markets create natural variation that aids identification: the coexistence of two exchanges (HOSE and HNX) with different trading rules, regulatory changes that shift trading costs and price limits, and the phased liberalization of foreign ownership caps that generates exogenous demand shocks.</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats, optimize</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.optimize <span class="im">import</span> minimize, minimize_scalar</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.iv <span class="im">import</span> IV2SLS</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="fu">## What Structural Estimation Means in Finance</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a><span class="fu">### Reduced Form Versus Structural</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>Consider two researchers studying the effect of transaction costs on trading volume. The reduced-form researcher exploits a fee reduction event and estimates:</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>\ln V_{i,t} = \alpha + \beta \cdot \text{Post}_t + \gamma \mathbf{X}_{i,t} + \varepsilon_{i,t}</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>$$ {#eq-reduced-form}</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>The coefficient $\beta$ identifies the causal effect of the fee change on volume, but it is local to this specific fee change, this specific market, and this specific time period. It says nothing about what a different fee change would do, or what the optimal fee structure might be.</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a>The structural researcher writes down an explicit model of trader behavior:</span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a>\max_{q_t} \; E_t\left<span class="co">[</span><span class="ot">\sum_{s=t}^{T} \delta^{s-t}\left(v_s q_s - c(q_s; \boldsymbol{\theta})\right)\right</span><span class="co">]</span></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a>$$ {#eq-structural-trader}</span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>where $v_s$ is the (possibly private) valuation, $q_s$ is the trade quantity, $c(\cdot; \boldsymbol{\theta})$ is the cost function parameterized by $\boldsymbol{\theta}$, and $\delta$ is the discount factor. The researcher estimates $\boldsymbol{\theta}$ by requiring that the model's predictions match observed trading patterns. With $\hat{\boldsymbol{\theta}}$ in hand, any counterfactual cost function $c'(\cdot; \boldsymbol{\theta}')$ can be fed into the model to predict the equilibrium response.</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>The distinction is not about sophistication (reduced-form work can be highly rigorous) but about the type of question being answered:</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span>   <span class="pp">|</span> Reduced Form <span class="pp">|</span> Structural <span class="pp">|</span></span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|------------------------------|-------------------------|</span></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Answers <span class="pp">|</span> "What happened?" <span class="pp">|</span> "What would happen if...?" <span class="pp">|</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Identification <span class="pp">|</span> Exogenous variation (events, instruments) <span class="pp">|</span> Model restrictions + data moments <span class="pp">|</span></span>
<span id="cb26-55"><a href="#cb26-55" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Key assumption <span class="pp">|</span> Unconfoundedness or exclusion restriction <span class="pp">|</span> Correct model specification <span class="pp">|</span></span>
<span id="cb26-56"><a href="#cb26-56" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Output <span class="pp">|</span> Treatment effects, associations <span class="pp">|</span> Primitive parameters, counterfactuals <span class="pp">|</span></span>
<span id="cb26-57"><a href="#cb26-57" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Risk <span class="pp">|</span> Omitted variable bias, weak instruments <span class="pp">|</span> Model misspecification <span class="pp">|</span></span>
<span id="cb26-58"><a href="#cb26-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-59"><a href="#cb26-59" aria-hidden="true" tabindex="-1"></a>: Reduced Form vs. Structural Estimation {#tbl-rf-vs-structural}</span>
<span id="cb26-60"><a href="#cb26-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-61"><a href="#cb26-61" aria-hidden="true" tabindex="-1"></a><span class="fu">### Identification Through Economic Primitives</span></span>
<span id="cb26-62"><a href="#cb26-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-63"><a href="#cb26-63" aria-hidden="true" tabindex="-1"></a>Structural identification relies on the economic model to convert observed outcomes into unobserved primitives. The classic example is the demand-supply system. Observing prices and quantities alone cannot identify demand and supply curves (the simultaneity problem). But if we know the functional form of demand and supply, and have instruments that shift one curve but not the other, the system is identified.</span>
<span id="cb26-64"><a href="#cb26-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" aria-hidden="true" tabindex="-1"></a>In financial contexts, identification often comes from the model's equilibrium conditions. In @kyle1985continuous, the informed trader's strategy, the market maker's pricing rule, and the noise trader's demand jointly determine the equilibrium price impact coefficient $\lambda$. The model maps the observable (i.e., the price impact of order flow) to the unobservable (i.e., the precision of private information). The identification is through the model's structure, not through a conventional instrument.</span>
<span id="cb26-66"><a href="#cb26-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-67"><a href="#cb26-67" aria-hidden="true" tabindex="-1"></a>Formally, let $\boldsymbol{\theta} \in \Theta$ denote the vector of structural parameters and $\mathbf{m}(\boldsymbol{\theta})$ the model-implied moments. The data provide empirical moments $\hat{\mathbf{m}}$. Identification requires that the mapping $\boldsymbol{\theta} \mapsto \mathbf{m}(\boldsymbol{\theta})$ is injective: different parameter values produce different observable implications.</span>
<span id="cb26-68"><a href="#cb26-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-69"><a href="#cb26-69" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-70"><a href="#cb26-70" aria-hidden="true" tabindex="-1"></a>\hat{\boldsymbol{\theta}} = \arg\min_{\boldsymbol{\theta} \in \Theta} \left<span class="co">[</span><span class="ot">\hat{\mathbf{m}} - \mathbf{m}(\boldsymbol{\theta})\right</span><span class="co">]</span>' \mathbf{W} \left<span class="co">[</span><span class="ot">\hat{\mathbf{m}} - \mathbf{m}(\boldsymbol{\theta})\right</span><span class="co">]</span></span>
<span id="cb26-71"><a href="#cb26-71" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gmm-structural}</span>
<span id="cb26-72"><a href="#cb26-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-73"><a href="#cb26-73" aria-hidden="true" tabindex="-1"></a>This is the Generalized Method of Moments (GMM) framework applied to structural estimation. The choice of weighting matrix $\mathbf{W}$ determines efficiency, and over-identifying restrictions (more moments than parameters) provide specification tests.</span>
<span id="cb26-74"><a href="#cb26-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-75"><a href="#cb26-75" aria-hidden="true" tabindex="-1"></a><span class="fu">### Tradeoffs Between Realism and Tractability</span></span>
<span id="cb26-76"><a href="#cb26-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-77"><a href="#cb26-77" aria-hidden="true" tabindex="-1"></a>Every structural model involves choices about which features of reality to include and which to abstract from. @tbl-tradeoff illustrates this for several canonical finance models.</span>
<span id="cb26-78"><a href="#cb26-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-79"><a href="#cb26-79" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Model <span class="pp">|</span> Key Simplification <span class="pp">|</span> What It Misses <span class="pp">|</span> What It Gains <span class="pp">|</span></span>
<span id="cb26-80"><a href="#cb26-80" aria-hidden="true" tabindex="-1"></a><span class="pp">|-----------------|---------------------|-----------------|-----------------|</span></span>
<span id="cb26-81"><a href="#cb26-81" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> @kyle1985continuous <span class="pp">|</span> Single informed trader, normal distributions <span class="pp">|</span> Multiple insiders, fat tails <span class="pp">|</span> Closed-form $\lambda$, clean identification <span class="pp">|</span></span>
<span id="cb26-82"><a href="#cb26-82" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> @glosten1985bid <span class="pp">|</span> Binary signal, competitive market makers <span class="pp">|</span> Complex information, inventory costs <span class="pp">|</span> Bid-ask spread decomposition <span class="pp">|</span></span>
<span id="cb26-83"><a href="#cb26-83" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> @koijen2019demand <span class="pp">|</span> Characteristics-based demand, no dynamics <span class="pp">|</span> Dynamic portfolio rebalancing <span class="pp">|</span> Demand elasticity estimation at scale <span class="pp">|</span></span>
<span id="cb26-84"><a href="#cb26-84" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> @roll1984simple <span class="pp">|</span> No information, serial independence <span class="pp">|</span> Information-driven trades <span class="pp">|</span> Spread estimation from return autocovariance <span class="pp">|</span></span>
<span id="cb26-85"><a href="#cb26-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-86"><a href="#cb26-86" aria-hidden="true" tabindex="-1"></a>: Structural Model Tradeoffs {#tbl-tradeoff}</span>
<span id="cb26-87"><a href="#cb26-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-88"><a href="#cb26-88" aria-hidden="true" tabindex="-1"></a>The researcher's task is to choose the simplest model that captures the economic mechanism of interest while remaining rich enough that its counterfactual predictions are credible. As @rust1987optimal emphasized, there is a tension between models that are "structurally correct" but computationally intractable and models that are tractable but potentially misspecified.</span>
<span id="cb26-89"><a href="#cb26-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-90"><a href="#cb26-90" aria-hidden="true" tabindex="-1"></a><span class="fu">## Demand Estimation for Financial Assets</span></span>
<span id="cb26-91"><a href="#cb26-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-92"><a href="#cb26-92" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Demand System Approach</span></span>
<span id="cb26-93"><a href="#cb26-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-94"><a href="#cb26-94" aria-hidden="true" tabindex="-1"></a>@koijen2019demand (hereafter KY) develop a demand system for financial assets that estimates the elasticity of institutional investor demand with respect to asset characteristics. The framework adapts the discrete-choice demand estimation methodology of @berry1995automobile from industrial organization to financial markets.</span>
<span id="cb26-95"><a href="#cb26-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-96"><a href="#cb26-96" aria-hidden="true" tabindex="-1"></a>Each investor $i$ holds a portfolio of $N$ assets. The demand for asset $j$ by investor $i$ at time $t$ is:</span>
<span id="cb26-97"><a href="#cb26-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-98"><a href="#cb26-98" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-99"><a href="#cb26-99" aria-hidden="true" tabindex="-1"></a>w_{ij,t} = \frac{\exp(\delta_{j,t} + \boldsymbol{\beta}_i' \mathbf{x}_{j,t})}{1 + \sum_{k=1}^{N} \exp(\delta_{k,t} + \boldsymbol{\beta}_i' \mathbf{x}_{k,t})}</span>
<span id="cb26-100"><a href="#cb26-100" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ky-demand}</span>
<span id="cb26-101"><a href="#cb26-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-102"><a href="#cb26-102" aria-hidden="true" tabindex="-1"></a>where $w_{ij,t}$ is the portfolio weight of asset $j$ for investor $i$, $\delta_{j,t}$ is the mean utility (common valuation), $\mathbf{x}_{j,t}$ is a vector of observable characteristics (market cap, book-to-market, momentum, etc.), and $\boldsymbol{\beta}_i$ captures investor-specific preferences (heterogeneous demand elasticities). The denominator includes 1 to represent the outside option (holding cash or non-equity assets).</span>
<span id="cb26-103"><a href="#cb26-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-104"><a href="#cb26-104" aria-hidden="true" tabindex="-1"></a>The key insight is that the market-clearing condition links demand to equilibrium prices:</span>
<span id="cb26-105"><a href="#cb26-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-106"><a href="#cb26-106" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-107"><a href="#cb26-107" aria-hidden="true" tabindex="-1"></a>\sum_i A_{i,t} \cdot w_{ij,t}(\boldsymbol{\theta}) = \text{ME}_{j,t} \qquad \forall j, t</span>
<span id="cb26-108"><a href="#cb26-108" aria-hidden="true" tabindex="-1"></a>$$ {#eq-market-clearing}</span>
<span id="cb26-109"><a href="#cb26-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-110"><a href="#cb26-110" aria-hidden="true" tabindex="-1"></a>where $A_{i,t}$ is investor $i$'s total assets under management and $\text{ME}_{j,t}$ is the market capitalization of asset $j$. This system of equations determines the equilibrium price impacts and demand elasticities.</span>
<span id="cb26-111"><a href="#cb26-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-112"><a href="#cb26-112" aria-hidden="true" tabindex="-1"></a><span class="fu">### Demand Elasticity Estimation</span></span>
<span id="cb26-113"><a href="#cb26-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-114"><a href="#cb26-114" aria-hidden="true" tabindex="-1"></a>The demand elasticity of asset $j$ with respect to its own price (or a characteristic that moves its price) is:</span>
<span id="cb26-115"><a href="#cb26-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-116"><a href="#cb26-116" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-117"><a href="#cb26-117" aria-hidden="true" tabindex="-1"></a>\varepsilon_{jj} = \frac{\partial \ln w_{ij}}{\partial \ln P_j} = \beta_{\text{price}} \cdot (1 - w_{ij})</span>
<span id="cb26-118"><a href="#cb26-118" aria-hidden="true" tabindex="-1"></a>$$ {#eq-demand-elasticity}</span>
<span id="cb26-119"><a href="#cb26-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-120"><a href="#cb26-120" aria-hidden="true" tabindex="-1"></a>In a frictionless market with perfectly elastic demand, a supply shock (e.g., an index addition) would have zero price impact. Empirically, demand curves for financial assets slope downward with finite elasticity, implying that supply shocks move equilibrium prices.</span>
<span id="cb26-121"><a href="#cb26-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-124"><a href="#cb26-124" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-125"><a href="#cb26-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-holdings-data</span></span>
<span id="cb26-126"><a href="#cb26-126" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-127"><a href="#cb26-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-128"><a href="#cb26-128" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb26-129"><a href="#cb26-129" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb26-130"><a href="#cb26-130" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb26-131"><a href="#cb26-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-132"><a href="#cb26-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Load institutional holdings data</span></span>
<span id="cb26-133"><a href="#cb26-133" aria-hidden="true" tabindex="-1"></a>holdings <span class="op">=</span> dc.get_institutional_holdings(</span>
<span id="cb26-134"><a href="#cb26-134" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb26-135"><a href="#cb26-135" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-136"><a href="#cb26-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-137"><a href="#cb26-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-138"><a href="#cb26-138" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm characteristics</span></span>
<span id="cb26-139"><a href="#cb26-139" aria-hidden="true" tabindex="-1"></a>firm_chars <span class="op">=</span> dc.get_firm_characteristics(</span>
<span id="cb26-140"><a href="#cb26-140" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb26-141"><a href="#cb26-141" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-142"><a href="#cb26-142" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-143"><a href="#cb26-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-144"><a href="#cb26-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Load market data</span></span>
<span id="cb26-145"><a href="#cb26-145" aria-hidden="true" tabindex="-1"></a>market_data <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb26-146"><a href="#cb26-146" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb26-147"><a href="#cb26-147" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-148"><a href="#cb26-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-149"><a href="#cb26-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-150"><a href="#cb26-150" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings observations: </span><span class="sc">{</span><span class="bu">len</span>(holdings)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-151"><a href="#cb26-151" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique institutions: </span><span class="sc">{</span>holdings[<span class="st">'institution_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-152"><a href="#cb26-152" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>holdings[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-153"><a href="#cb26-153" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-154"><a href="#cb26-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-157"><a href="#cb26-157" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-158"><a href="#cb26-158" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: demand-system-construction</span></span>
<span id="cb26-159"><a href="#cb26-159" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-160"><a href="#cb26-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-161"><a href="#cb26-161" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct demand system variables</span></span>
<span id="cb26-162"><a href="#cb26-162" aria-hidden="true" tabindex="-1"></a>demand <span class="op">=</span> holdings.merge(</span>
<span id="cb26-163"><a href="#cb26-163" aria-hidden="true" tabindex="-1"></a>    firm_chars[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"market_cap"</span>, <span class="st">"book_to_market"</span>,</span>
<span id="cb26-164"><a href="#cb26-164" aria-hidden="true" tabindex="-1"></a>                <span class="st">"momentum_12m"</span>, <span class="st">"log_size"</span>, <span class="st">"profitability"</span>,</span>
<span id="cb26-165"><a href="#cb26-165" aria-hidden="true" tabindex="-1"></a>                <span class="st">"investment"</span>, <span class="st">"industry"</span>]],</span>
<span id="cb26-166"><a href="#cb26-166" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>],</span>
<span id="cb26-167"><a href="#cb26-167" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb26-168"><a href="#cb26-168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-169"><a href="#cb26-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-170"><a href="#cb26-170" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolio weights</span></span>
<span id="cb26-171"><a href="#cb26-171" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"total_aum"</span>] <span class="op">=</span> demand.groupby(</span>
<span id="cb26-172"><a href="#cb26-172" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"institution_id"</span>, <span class="st">"date"</span>]</span>
<span id="cb26-173"><a href="#cb26-173" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"holding_value"</span>].transform(<span class="st">"sum"</span>)</span>
<span id="cb26-174"><a href="#cb26-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-175"><a href="#cb26-175" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"port_weight"</span>] <span class="op">=</span> demand[<span class="st">"holding_value"</span>] <span class="op">/</span> demand[<span class="st">"total_aum"</span>]</span>
<span id="cb26-176"><a href="#cb26-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-177"><a href="#cb26-177" aria-hidden="true" tabindex="-1"></a><span class="co"># Log portfolio weight relative to outside option</span></span>
<span id="cb26-178"><a href="#cb26-178" aria-hidden="true" tabindex="-1"></a><span class="co"># w_ij / w_i0 where w_i0 = 1 - sum(w_ij) for equity holdings</span></span>
<span id="cb26-179"><a href="#cb26-179" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"sum_equity_weight"</span>] <span class="op">=</span> demand.groupby(</span>
<span id="cb26-180"><a href="#cb26-180" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"institution_id"</span>, <span class="st">"date"</span>]</span>
<span id="cb26-181"><a href="#cb26-181" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"port_weight"</span>].transform(<span class="st">"sum"</span>)</span>
<span id="cb26-182"><a href="#cb26-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-183"><a href="#cb26-183" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"outside_weight"</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> demand[<span class="st">"sum_equity_weight"</span>].clip(upper<span class="op">=</span><span class="fl">0.99</span>)</span>
<span id="cb26-184"><a href="#cb26-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-185"><a href="#cb26-185" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"log_weight_ratio"</span>] <span class="op">=</span> np.log(</span>
<span id="cb26-186"><a href="#cb26-186" aria-hidden="true" tabindex="-1"></a>    demand[<span class="st">"port_weight"</span>] <span class="op">/</span> demand[<span class="st">"outside_weight"</span>]</span>
<span id="cb26-187"><a href="#cb26-187" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-188"><a href="#cb26-188" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-189"><a href="#cb26-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-192"><a href="#cb26-192" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-193"><a href="#cb26-193" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: demand-estimation</span></span>
<span id="cb26-194"><a href="#cb26-194" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-195"><a href="#cb26-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-196"><a href="#cb26-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified KY demand estimation</span></span>
<span id="cb26-197"><a href="#cb26-197" aria-hidden="true" tabindex="-1"></a><span class="co"># log(w_ij / w_i0) = delta_j + beta_i' x_j + epsilon_ij</span></span>
<span id="cb26-198"><a href="#cb26-198" aria-hidden="true" tabindex="-1"></a><span class="co"># First stage: estimate mean utility delta_j via OLS with asset FE</span></span>
<span id="cb26-199"><a href="#cb26-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-200"><a href="#cb26-200" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression at each date</span></span>
<span id="cb26-201"><a href="#cb26-201" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_demand_cross_section(group):</span>
<span id="cb26-202"><a href="#cb26-202" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-203"><a href="#cb26-203" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate demand parameters for a single cross-section.</span></span>
<span id="cb26-204"><a href="#cb26-204" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses OLS with stock fixed effects absorbed.</span></span>
<span id="cb26-205"><a href="#cb26-205" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-206"><a href="#cb26-206" aria-hidden="true" tabindex="-1"></a>    g <span class="op">=</span> group.dropna(subset<span class="op">=</span>[</span>
<span id="cb26-207"><a href="#cb26-207" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_weight_ratio"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>,</span>
<span id="cb26-208"><a href="#cb26-208" aria-hidden="true" tabindex="-1"></a>        <span class="st">"momentum_12m"</span>, <span class="st">"profitability"</span></span>
<span id="cb26-209"><a href="#cb26-209" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb26-210"><a href="#cb26-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-211"><a href="#cb26-211" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(g) <span class="op">&lt;</span> <span class="dv">50</span>:</span>
<span id="cb26-212"><a href="#cb26-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb26-213"><a href="#cb26-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-214"><a href="#cb26-214" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> g[[<span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>,</span>
<span id="cb26-215"><a href="#cb26-215" aria-hidden="true" tabindex="-1"></a>           <span class="st">"profitability"</span>]].values</span>
<span id="cb26-216"><a href="#cb26-216" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(X)</span>
<span id="cb26-217"><a href="#cb26-217" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> g[<span class="st">"log_weight_ratio"</span>].values</span>
<span id="cb26-218"><a href="#cb26-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-219"><a href="#cb26-219" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb26-220"><a href="#cb26-220" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(y, X).fit()</span>
<span id="cb26-221"><a href="#cb26-221" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({</span>
<span id="cb26-222"><a href="#cb26-222" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_size"</span>: model.params[<span class="dv">1</span>],</span>
<span id="cb26-223"><a href="#cb26-223" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_btm"</span>: model.params[<span class="dv">2</span>],</span>
<span id="cb26-224"><a href="#cb26-224" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_mom"</span>: model.params[<span class="dv">3</span>],</span>
<span id="cb26-225"><a href="#cb26-225" aria-hidden="true" tabindex="-1"></a>            <span class="st">"beta_prof"</span>: model.params[<span class="dv">4</span>],</span>
<span id="cb26-226"><a href="#cb26-226" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb26-227"><a href="#cb26-227" aria-hidden="true" tabindex="-1"></a>            <span class="st">"n_obs"</span>: <span class="bu">len</span>(g)</span>
<span id="cb26-228"><a href="#cb26-228" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb26-229"><a href="#cb26-229" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb26-230"><a href="#cb26-230" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series(dtype<span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb26-231"><a href="#cb26-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-232"><a href="#cb26-232" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by institution type</span></span>
<span id="cb26-233"><a href="#cb26-233" aria-hidden="true" tabindex="-1"></a>demand[<span class="st">"institution_type"</span>] <span class="op">=</span> demand[<span class="st">"institution_type"</span>].fillna(<span class="st">"Other"</span>)</span>
<span id="cb26-234"><a href="#cb26-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-235"><a href="#cb26-235" aria-hidden="true" tabindex="-1"></a>demand_params <span class="op">=</span> (</span>
<span id="cb26-236"><a href="#cb26-236" aria-hidden="true" tabindex="-1"></a>    demand.groupby([<span class="st">"institution_type"</span>, <span class="st">"date"</span>])</span>
<span id="cb26-237"><a href="#cb26-237" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(estimate_demand_cross_section)</span>
<span id="cb26-238"><a href="#cb26-238" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb26-239"><a href="#cb26-239" aria-hidden="true" tabindex="-1"></a>    .dropna()</span>
<span id="cb26-240"><a href="#cb26-240" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-241"><a href="#cb26-241" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-242"><a href="#cb26-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-245"><a href="#cb26-245" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-246"><a href="#cb26-246" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-demand-params</span></span>
<span id="cb26-247"><a href="#cb26-247" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-248"><a href="#cb26-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Demand Elasticities by Investor Type"</span></span>
<span id="cb26-249"><a href="#cb26-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-250"><a href="#cb26-250" aria-hidden="true" tabindex="-1"></a>avg_params <span class="op">=</span> (</span>
<span id="cb26-251"><a href="#cb26-251" aria-hidden="true" tabindex="-1"></a>    demand_params.groupby(<span class="st">"institution_type"</span>)</span>
<span id="cb26-252"><a href="#cb26-252" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb26-253"><a href="#cb26-253" aria-hidden="true" tabindex="-1"></a>        beta_size<span class="op">=</span>(<span class="st">"beta_size"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-254"><a href="#cb26-254" aria-hidden="true" tabindex="-1"></a>        beta_btm<span class="op">=</span>(<span class="st">"beta_btm"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-255"><a href="#cb26-255" aria-hidden="true" tabindex="-1"></a>        beta_mom<span class="op">=</span>(<span class="st">"beta_mom"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-256"><a href="#cb26-256" aria-hidden="true" tabindex="-1"></a>        beta_prof<span class="op">=</span>(<span class="st">"beta_prof"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-257"><a href="#cb26-257" aria-hidden="true" tabindex="-1"></a>        avg_r2<span class="op">=</span>(<span class="st">"r_squared"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-258"><a href="#cb26-258" aria-hidden="true" tabindex="-1"></a>        n_periods<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"nunique"</span>)</span>
<span id="cb26-259"><a href="#cb26-259" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-260"><a href="#cb26-260" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb26-261"><a href="#cb26-261" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-262"><a href="#cb26-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-263"><a href="#cb26-263" aria-hidden="true" tabindex="-1"></a>avg_params</span>
<span id="cb26-264"><a href="#cb26-264" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-265"><a href="#cb26-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-268"><a href="#cb26-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-269"><a href="#cb26-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-demand-elasticity-time</span></span>
<span id="cb26-270"><a href="#cb26-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-271"><a href="#cb26-271" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Time-Varying Demand Sensitivity to Size Across Investor Types"</span></span>
<span id="cb26-272"><a href="#cb26-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-273"><a href="#cb26-273" aria-hidden="true" tabindex="-1"></a>top_types <span class="op">=</span> demand_params.groupby(<span class="st">"institution_type"</span>).size().nlargest(<span class="dv">4</span>).index</span>
<span id="cb26-274"><a href="#cb26-274" aria-hidden="true" tabindex="-1"></a>plot_data <span class="op">=</span> demand_params[</span>
<span id="cb26-275"><a href="#cb26-275" aria-hidden="true" tabindex="-1"></a>    demand_params[<span class="st">"institution_type"</span>].isin(top_types)</span>
<span id="cb26-276"><a href="#cb26-276" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb26-277"><a href="#cb26-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-278"><a href="#cb26-278" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-279"><a href="#cb26-279" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(plot_data, p9.aes(</span>
<span id="cb26-280"><a href="#cb26-280" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"beta_size"</span>, color<span class="op">=</span><span class="st">"institution_type"</span></span>
<span id="cb26-281"><a href="#cb26-281" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-282"><a href="#cb26-282" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, se<span class="op">=</span><span class="va">False</span>, size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-283"><a href="#cb26-283" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-284"><a href="#cb26-284" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>, y<span class="op">=</span><span class="st">"Î² (Size)"</span>,</span>
<span id="cb26-285"><a href="#cb26-285" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Institutional Demand Sensitivity to Firm Size"</span>,</span>
<span id="cb26-286"><a href="#cb26-286" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Institution Type"</span></span>
<span id="cb26-287"><a href="#cb26-287" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-288"><a href="#cb26-288" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-289"><a href="#cb26-289" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb26-290"><a href="#cb26-290" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-291"><a href="#cb26-291" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-292"><a href="#cb26-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-293"><a href="#cb26-293" aria-hidden="true" tabindex="-1"></a><span class="fu">### Price Pressure and Market Impact</span></span>
<span id="cb26-294"><a href="#cb26-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-295"><a href="#cb26-295" aria-hidden="true" tabindex="-1"></a>The demand system framework directly yields price impact predictions. If investor $i$ receives an exogenous inflow $\Delta A_i$ (e.g., from a fund flow shock), the price of each stock must adjust to clear the market with the new demand. The equilibrium price impact of a demand shock is:</span>
<span id="cb26-296"><a href="#cb26-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-297"><a href="#cb26-297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-298"><a href="#cb26-298" aria-hidden="true" tabindex="-1"></a>\frac{\Delta P_j}{P_j} = \frac{1}{\varepsilon_{jj}} \cdot \frac{\Delta D_j}{D_j}</span>
<span id="cb26-299"><a href="#cb26-299" aria-hidden="true" tabindex="-1"></a>$$ {#eq-price-impact-demand}</span>
<span id="cb26-300"><a href="#cb26-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-301"><a href="#cb26-301" aria-hidden="true" tabindex="-1"></a>where $\varepsilon_{jj}$ is the demand elasticity and $\Delta D_j / D_j$ is the percentage demand shock. Less elastic demand implies larger price impact for the same demand shock (a prediction with direct implications for the price impact of index rebalancing, fund flows, and forced selling).</span>
<span id="cb26-302"><a href="#cb26-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-305"><a href="#cb26-305" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-306"><a href="#cb26-306" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: price-pressure</span></span>
<span id="cb26-307"><a href="#cb26-307" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-308"><a href="#cb26-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-309"><a href="#cb26-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate aggregate demand elasticity via index rebalancing events</span></span>
<span id="cb26-310"><a href="#cb26-310" aria-hidden="true" tabindex="-1"></a><span class="co"># Use VN30 index reconstitutions as demand shocks</span></span>
<span id="cb26-311"><a href="#cb26-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-312"><a href="#cb26-312" aria-hidden="true" tabindex="-1"></a>index_changes <span class="op">=</span> dc.get_index_changes(</span>
<span id="cb26-313"><a href="#cb26-313" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"VN30"</span>,</span>
<span id="cb26-314"><a href="#cb26-314" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb26-315"><a href="#cb26-315" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-316"><a href="#cb26-316" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-317"><a href="#cb26-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-318"><a href="#cb26-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Event study: abnormal returns around index additions/deletions</span></span>
<span id="cb26-319"><a href="#cb26-319" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> event_study_car(events, returns, window<span class="op">=</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>)):</span>
<span id="cb26-320"><a href="#cb26-320" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-321"><a href="#cb26-321" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute cumulative abnormal returns around events.</span></span>
<span id="cb26-322"><a href="#cb26-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-323"><a href="#cb26-323" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-324"><a href="#cb26-324" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-325"><a href="#cb26-325" aria-hidden="true" tabindex="-1"></a><span class="co">    events : DataFrame</span></span>
<span id="cb26-326"><a href="#cb26-326" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: ticker, event_date, event_type (addition/deletion).</span></span>
<span id="cb26-327"><a href="#cb26-327" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : DataFrame</span></span>
<span id="cb26-328"><a href="#cb26-328" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: ticker, date, ret, mkt_ret.</span></span>
<span id="cb26-329"><a href="#cb26-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-330"><a href="#cb26-330" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-331"><a href="#cb26-331" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-332"><a href="#cb26-332" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : CARs by event type and event day.</span></span>
<span id="cb26-333"><a href="#cb26-333" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-334"><a href="#cb26-334" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb26-335"><a href="#cb26-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-336"><a href="#cb26-336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, event <span class="kw">in</span> events.iterrows():</span>
<span id="cb26-337"><a href="#cb26-337" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> event[<span class="st">"ticker"</span>]</span>
<span id="cb26-338"><a href="#cb26-338" aria-hidden="true" tabindex="-1"></a>        event_date <span class="op">=</span> pd.to_datetime(event[<span class="st">"event_date"</span>])</span>
<span id="cb26-339"><a href="#cb26-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-340"><a href="#cb26-340" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Estimation window: -260 to -11</span></span>
<span id="cb26-341"><a href="#cb26-341" aria-hidden="true" tabindex="-1"></a>        stock_rets <span class="op">=</span> returns[returns[<span class="st">"ticker"</span>] <span class="op">==</span> ticker].copy()</span>
<span id="cb26-342"><a href="#cb26-342" aria-hidden="true" tabindex="-1"></a>        stock_rets <span class="op">=</span> stock_rets.sort_values(<span class="st">"date"</span>)</span>
<span id="cb26-343"><a href="#cb26-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-344"><a href="#cb26-344" aria-hidden="true" tabindex="-1"></a>        est_mask <span class="op">=</span> (</span>
<span id="cb26-345"><a href="#cb26-345" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&gt;=</span> event_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">365</span>)) <span class="op">&amp;</span></span>
<span id="cb26-346"><a href="#cb26-346" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&lt;</span> event_date <span class="op">-</span> pd.Timedelta(days<span class="op">=</span><span class="dv">15</span>))</span>
<span id="cb26-347"><a href="#cb26-347" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-348"><a href="#cb26-348" aria-hidden="true" tabindex="-1"></a>        est_data <span class="op">=</span> stock_rets[est_mask].dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>])</span>
<span id="cb26-349"><a href="#cb26-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-350"><a href="#cb26-350" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(est_data) <span class="op">&lt;</span> <span class="dv">60</span>:</span>
<span id="cb26-351"><a href="#cb26-351" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb26-352"><a href="#cb26-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-353"><a href="#cb26-353" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Market model</span></span>
<span id="cb26-354"><a href="#cb26-354" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> sm.OLS(</span>
<span id="cb26-355"><a href="#cb26-355" aria-hidden="true" tabindex="-1"></a>            est_data[<span class="st">"ret"</span>],</span>
<span id="cb26-356"><a href="#cb26-356" aria-hidden="true" tabindex="-1"></a>            sm.add_constant(est_data[<span class="st">"mkt_ret"</span>])</span>
<span id="cb26-357"><a href="#cb26-357" aria-hidden="true" tabindex="-1"></a>        ).fit()</span>
<span id="cb26-358"><a href="#cb26-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-359"><a href="#cb26-359" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Event window</span></span>
<span id="cb26-360"><a href="#cb26-360" aria-hidden="true" tabindex="-1"></a>        evt_mask <span class="op">=</span> (</span>
<span id="cb26-361"><a href="#cb26-361" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&gt;=</span> event_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>window[<span class="dv">0</span>] <span class="op">*</span> <span class="fl">1.5</span>)) <span class="op">&amp;</span></span>
<span id="cb26-362"><a href="#cb26-362" aria-hidden="true" tabindex="-1"></a>            (stock_rets[<span class="st">"date"</span>] <span class="op">&lt;=</span> event_date <span class="op">+</span> pd.Timedelta(days<span class="op">=</span>window[<span class="dv">1</span>] <span class="op">*</span> <span class="fl">1.5</span>))</span>
<span id="cb26-363"><a href="#cb26-363" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-364"><a href="#cb26-364" aria-hidden="true" tabindex="-1"></a>        evt_data <span class="op">=</span> stock_rets[evt_mask].dropna(subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"mkt_ret"</span>])</span>
<span id="cb26-365"><a href="#cb26-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-366"><a href="#cb26-366" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(evt_data) <span class="op">&lt;</span> <span class="dv">5</span>:</span>
<span id="cb26-367"><a href="#cb26-367" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb26-368"><a href="#cb26-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-369"><a href="#cb26-369" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Abnormal returns</span></span>
<span id="cb26-370"><a href="#cb26-370" aria-hidden="true" tabindex="-1"></a>        evt_data <span class="op">=</span> evt_data.copy()</span>
<span id="cb26-371"><a href="#cb26-371" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"expected"</span>] <span class="op">=</span> model.predict(</span>
<span id="cb26-372"><a href="#cb26-372" aria-hidden="true" tabindex="-1"></a>            sm.add_constant(evt_data[<span class="st">"mkt_ret"</span>])</span>
<span id="cb26-373"><a href="#cb26-373" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-374"><a href="#cb26-374" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"ar"</span>] <span class="op">=</span> evt_data[<span class="st">"ret"</span>] <span class="op">-</span> evt_data[<span class="st">"expected"</span>]</span>
<span id="cb26-375"><a href="#cb26-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-376"><a href="#cb26-376" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign event-time index</span></span>
<span id="cb26-377"><a href="#cb26-377" aria-hidden="true" tabindex="-1"></a>        trading_dates <span class="op">=</span> evt_data[<span class="st">"date"</span>].sort_values().values</span>
<span id="cb26-378"><a href="#cb26-378" aria-hidden="true" tabindex="-1"></a>        event_idx <span class="op">=</span> np.searchsorted(trading_dates, event_date)</span>
<span id="cb26-379"><a href="#cb26-379" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"event_day"</span>] <span class="op">=</span> <span class="bu">range</span>(<span class="op">-</span>event_idx, <span class="bu">len</span>(evt_data) <span class="op">-</span> event_idx)</span>
<span id="cb26-380"><a href="#cb26-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-381"><a href="#cb26-381" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"event_type"</span>] <span class="op">=</span> event[<span class="st">"event_type"</span>]</span>
<span id="cb26-382"><a href="#cb26-382" aria-hidden="true" tabindex="-1"></a>        evt_data[<span class="st">"ticker"</span>] <span class="op">=</span> ticker</span>
<span id="cb26-383"><a href="#cb26-383" aria-hidden="true" tabindex="-1"></a>        results.append(evt_data[[<span class="st">"ticker"</span>, <span class="st">"event_day"</span>, <span class="st">"ar"</span>, <span class="st">"event_type"</span>]])</span>
<span id="cb26-384"><a href="#cb26-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-385"><a href="#cb26-385" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> results:</span>
<span id="cb26-386"><a href="#cb26-386" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb26-387"><a href="#cb26-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-388"><a href="#cb26-388" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.concat(results, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-389"><a href="#cb26-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-390"><a href="#cb26-390" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute event study</span></span>
<span id="cb26-391"><a href="#cb26-391" aria-hidden="true" tabindex="-1"></a>daily_data <span class="op">=</span> market_data.merge(</span>
<span id="cb26-392"><a href="#cb26-392" aria-hidden="true" tabindex="-1"></a>    dc.get_market_returns(</span>
<span id="cb26-393"><a href="#cb26-393" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2012-01-01"</span>,</span>
<span id="cb26-394"><a href="#cb26-394" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb26-395"><a href="#cb26-395" aria-hidden="true" tabindex="-1"></a>        frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb26-396"><a href="#cb26-396" aria-hidden="true" tabindex="-1"></a>    )[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb26-397"><a href="#cb26-397" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"left"</span></span>
<span id="cb26-398"><a href="#cb26-398" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-399"><a href="#cb26-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-400"><a href="#cb26-400" aria-hidden="true" tabindex="-1"></a>car_results <span class="op">=</span> event_study_car(index_changes, daily_data)</span>
<span id="cb26-401"><a href="#cb26-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-402"><a href="#cb26-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-405"><a href="#cb26-405" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-406"><a href="#cb26-406" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-index-event-study</span></span>
<span id="cb26-407"><a href="#cb26-407" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-408"><a href="#cb26-408" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative Abnormal Returns Around VN30 Index Reconstitutions"</span></span>
<span id="cb26-409"><a href="#cb26-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-410"><a href="#cb26-410" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(car_results) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb26-411"><a href="#cb26-411" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Average AR by event day and type</span></span>
<span id="cb26-412"><a href="#cb26-412" aria-hidden="true" tabindex="-1"></a>    avg_ar <span class="op">=</span> (</span>
<span id="cb26-413"><a href="#cb26-413" aria-hidden="true" tabindex="-1"></a>        car_results.groupby([<span class="st">"event_type"</span>, <span class="st">"event_day"</span>])</span>
<span id="cb26-414"><a href="#cb26-414" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb26-415"><a href="#cb26-415" aria-hidden="true" tabindex="-1"></a>            mean_ar<span class="op">=</span>(<span class="st">"ar"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-416"><a href="#cb26-416" aria-hidden="true" tabindex="-1"></a>            se_ar<span class="op">=</span>(<span class="st">"ar"</span>, <span class="kw">lambda</span> x: x.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(x))),</span>
<span id="cb26-417"><a href="#cb26-417" aria-hidden="true" tabindex="-1"></a>            n<span class="op">=</span>(<span class="st">"ar"</span>, <span class="st">"count"</span>)</span>
<span id="cb26-418"><a href="#cb26-418" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-419"><a href="#cb26-419" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb26-420"><a href="#cb26-420" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-421"><a href="#cb26-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-422"><a href="#cb26-422" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cumulative AR</span></span>
<span id="cb26-423"><a href="#cb26-423" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> etype <span class="kw">in</span> avg_ar[<span class="st">"event_type"</span>].unique():</span>
<span id="cb26-424"><a href="#cb26-424" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> avg_ar[<span class="st">"event_type"</span>] <span class="op">==</span> etype</span>
<span id="cb26-425"><a href="#cb26-425" aria-hidden="true" tabindex="-1"></a>        avg_ar.loc[mask, <span class="st">"car"</span>] <span class="op">=</span> avg_ar.loc[mask, <span class="st">"mean_ar"</span>].cumsum()</span>
<span id="cb26-426"><a href="#cb26-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-427"><a href="#cb26-427" aria-hidden="true" tabindex="-1"></a>    avg_ar <span class="op">=</span> avg_ar[avg_ar[<span class="st">"event_day"</span>].between(<span class="op">-</span><span class="dv">5</span>, <span class="dv">20</span>)]</span>
<span id="cb26-428"><a href="#cb26-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-429"><a href="#cb26-429" aria-hidden="true" tabindex="-1"></a>    (</span>
<span id="cb26-430"><a href="#cb26-430" aria-hidden="true" tabindex="-1"></a>        p9.ggplot(avg_ar, p9.aes(</span>
<span id="cb26-431"><a href="#cb26-431" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"event_day"</span>, y<span class="op">=</span><span class="st">"car"</span>, color<span class="op">=</span><span class="st">"event_type"</span></span>
<span id="cb26-432"><a href="#cb26-432" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb26-433"><a href="#cb26-433" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-434"><a href="#cb26-434" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_vline(xintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb26-435"><a href="#cb26-435" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dotted"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb26-436"><a href="#cb26-436" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.scale_color_manual(values<span class="op">=</span>[<span class="st">"#27AE60"</span>, <span class="st">"#C0392B"</span>])</span>
<span id="cb26-437"><a href="#cb26-437" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.labs(</span>
<span id="cb26-438"><a href="#cb26-438" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">"Event Day"</span>,</span>
<span id="cb26-439"><a href="#cb26-439" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">"Cumulative Abnormal Return"</span>,</span>
<span id="cb26-440"><a href="#cb26-440" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="st">"Price Pressure from VN30 Index Additions and Deletions"</span>,</span>
<span id="cb26-441"><a href="#cb26-441" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">"Event"</span></span>
<span id="cb26-442"><a href="#cb26-442" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-443"><a href="#cb26-443" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-444"><a href="#cb26-444" aria-hidden="true" tabindex="-1"></a>        <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb26-445"><a href="#cb26-445" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-446"><a href="#cb26-446" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-447"><a href="#cb26-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-448"><a href="#cb26-448" aria-hidden="true" tabindex="-1"></a>The permanent component of the CAR measures the information content of index inclusion, while the temporary component (reversal after the event) measures pure price pressure from demand. In a world with perfectly elastic demand, there would be no temporary price impact. The magnitude of the temporary component is inversely related to the demand elasticity, providing a second identification strategy (complementary to the holdings-based approach) for demand curves.</span>
<span id="cb26-449"><a href="#cb26-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-450"><a href="#cb26-450" aria-hidden="true" tabindex="-1"></a><span class="fu">### Demand Inelasticity and Its Implications</span></span>
<span id="cb26-451"><a href="#cb26-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-452"><a href="#cb26-452" aria-hidden="true" tabindex="-1"></a>@gabaix2021search argue that the aggregate demand for equities is remarkably inelastic, with elasticity estimates on the order of 0.2 (meaning a 1% supply increase requires a 5% price decline to clear). The implications are profound: if demand is this inelastic, then flows (from index funds, foreign investors, retail traders) have outsized effects on prices. In Vietnamese markets, where foreign ownership caps create binding constraints on a key investor class, demand inelasticity may be even more severe.</span>
<span id="cb26-453"><a href="#cb26-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-454"><a href="#cb26-454" aria-hidden="true" tabindex="-1"></a>The inelasticity also generates a role for "the market portfolio" as an equilibrium concept: if most investors hold portfolios close to the market (as in CAPM), then deviations from market weights require someone to absorb the excess supply, and the compensation required is the inverse of demand elasticity.</span>
<span id="cb26-455"><a href="#cb26-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-456"><a href="#cb26-456" aria-hidden="true" tabindex="-1"></a><span class="fu">## Structural Models of Trading Strategies</span></span>
<span id="cb26-457"><a href="#cb26-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-458"><a href="#cb26-458" aria-hidden="true" tabindex="-1"></a><span class="fu">### Optimal Execution: The Almgren-Chriss Framework</span></span>
<span id="cb26-459"><a href="#cb26-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-460"><a href="#cb26-460" aria-hidden="true" tabindex="-1"></a>The optimal execution problem, formalized by @almgren2001optimal, asks: given a large order to execute over a fixed horizon, what is the optimal trading schedule that minimizes the total execution cost? The problem is fundamental to institutional investing because large orders cannot be executed instantaneously without severe price impact.</span>
<span id="cb26-461"><a href="#cb26-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-462"><a href="#cb26-462" aria-hidden="true" tabindex="-1"></a>Let $X_t$ denote the remaining shares to sell at time $t$, with $X_0 = X$ (total order) and $X_T = 0$ (completion). The trading rate is $n_t = X_{t-1} - X_t$. The execution price for shares traded at $t$ is affected by both temporary and permanent price impact:</span>
<span id="cb26-463"><a href="#cb26-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-464"><a href="#cb26-464" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-465"><a href="#cb26-465" aria-hidden="true" tabindex="-1"></a>S_t = S_0 + \sigma W_t - g(n_t) - h\left(\frac{n_t}{\tau}\right)</span>
<span id="cb26-466"><a href="#cb26-466" aria-hidden="true" tabindex="-1"></a>$$ {#eq-almgren-chriss-price}</span>
<span id="cb26-467"><a href="#cb26-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-468"><a href="#cb26-468" aria-hidden="true" tabindex="-1"></a>where $g(\cdot)$ is the permanent impact function, $h(\cdot)$ is the temporary impact function, $\sigma$ is the volatility, $W_t$ is a Wiener process, and $\tau$ is the time interval. The total implementation shortfall (cost of execution relative to the arrival price $S_0$) is:</span>
<span id="cb26-469"><a href="#cb26-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-470"><a href="#cb26-470" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-471"><a href="#cb26-471" aria-hidden="true" tabindex="-1"></a>\text{IS} = \sum_{t=1}^{T} n_t (S_0 - S_t) = \sum_{t=1}^{T} n_t \left<span class="co">[</span><span class="ot">\sigma W_t + g(n_t) + h\left(\frac{n_t}{\tau}\right)\right</span><span class="co">]</span></span>
<span id="cb26-472"><a href="#cb26-472" aria-hidden="true" tabindex="-1"></a>$$ {#eq-shortfall}</span>
<span id="cb26-473"><a href="#cb26-473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-474"><a href="#cb26-474" aria-hidden="true" tabindex="-1"></a>The trader minimizes a mean-variance objective:</span>
<span id="cb26-475"><a href="#cb26-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-476"><a href="#cb26-476" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-477"><a href="#cb26-477" aria-hidden="true" tabindex="-1"></a>\min_{<span class="sc">\{</span>n_t<span class="sc">\}</span>} \; E<span class="co">[</span><span class="ot">\text{IS}</span><span class="co">]</span> + \lambda \cdot \text{Var}(\text{IS})</span>
<span id="cb26-478"><a href="#cb26-478" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ac-objective}</span>
<span id="cb26-479"><a href="#cb26-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-480"><a href="#cb26-480" aria-hidden="true" tabindex="-1"></a>where $\lambda$ is the risk aversion parameter. With linear impact functions $g(n) = \gamma n$ and $h(v) = \eta v + \epsilon \text{sgn}(v)$, the optimal strategy has a closed-form solution.</span>
<span id="cb26-481"><a href="#cb26-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-482"><a href="#cb26-482" aria-hidden="true" tabindex="-1"></a>**TWAP (Time-Weighted Average Price):** Trade uniformly: $n_t = X / T$ for all $t$. Optimal when permanent impact dominates temporary impact.</span>
<span id="cb26-483"><a href="#cb26-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-484"><a href="#cb26-484" aria-hidden="true" tabindex="-1"></a>**VWAP (Volume-Weighted Average Price):** Trade proportionally to expected volume: $n_t \propto \hat{V}_t$. Approximates TWAP adjusted for intraday volume patterns.</span>
<span id="cb26-485"><a href="#cb26-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-486"><a href="#cb26-486" aria-hidden="true" tabindex="-1"></a>**Almgren-Chriss Optimal:** The risk-averse optimal trajectory for linear impact is:</span>
<span id="cb26-487"><a href="#cb26-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-488"><a href="#cb26-488" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-489"><a href="#cb26-489" aria-hidden="true" tabindex="-1"></a>x_t^* = X \cdot \frac{\sinh(\kappa (T - t))}{\sinh(\kappa T)}</span>
<span id="cb26-490"><a href="#cb26-490" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ac-trajectory}</span>
<span id="cb26-491"><a href="#cb26-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-492"><a href="#cb26-492" aria-hidden="true" tabindex="-1"></a>where $\kappa = \sqrt{\lambda \sigma^2 / \eta}$ governs the trade-off between urgency (trading quickly to reduce risk) and patience (trading slowly to reduce impact). High risk aversion ($\lambda$ large) implies front-loaded execution.</span>
<span id="cb26-493"><a href="#cb26-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-496"><a href="#cb26-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-497"><a href="#cb26-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: almgren-chriss</span></span>
<span id="cb26-498"><a href="#cb26-498" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-499"><a href="#cb26-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-500"><a href="#cb26-500" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> almgren_chriss_trajectory(X, T, sigma, eta, gamma, lam, n_steps<span class="op">=</span><span class="dv">100</span>):</span>
<span id="cb26-501"><a href="#cb26-501" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-502"><a href="#cb26-502" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute Almgren-Chriss optimal execution trajectory.</span></span>
<span id="cb26-503"><a href="#cb26-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-504"><a href="#cb26-504" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-505"><a href="#cb26-505" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-506"><a href="#cb26-506" aria-hidden="true" tabindex="-1"></a><span class="co">    X : float</span></span>
<span id="cb26-507"><a href="#cb26-507" aria-hidden="true" tabindex="-1"></a><span class="co">        Total shares to execute.</span></span>
<span id="cb26-508"><a href="#cb26-508" aria-hidden="true" tabindex="-1"></a><span class="co">    T : float</span></span>
<span id="cb26-509"><a href="#cb26-509" aria-hidden="true" tabindex="-1"></a><span class="co">        Execution horizon (in trading days).</span></span>
<span id="cb26-510"><a href="#cb26-510" aria-hidden="true" tabindex="-1"></a><span class="co">    sigma : float</span></span>
<span id="cb26-511"><a href="#cb26-511" aria-hidden="true" tabindex="-1"></a><span class="co">        Daily return volatility.</span></span>
<span id="cb26-512"><a href="#cb26-512" aria-hidden="true" tabindex="-1"></a><span class="co">    eta : float</span></span>
<span id="cb26-513"><a href="#cb26-513" aria-hidden="true" tabindex="-1"></a><span class="co">        Temporary impact parameter.</span></span>
<span id="cb26-514"><a href="#cb26-514" aria-hidden="true" tabindex="-1"></a><span class="co">    gamma : float</span></span>
<span id="cb26-515"><a href="#cb26-515" aria-hidden="true" tabindex="-1"></a><span class="co">        Permanent impact parameter.</span></span>
<span id="cb26-516"><a href="#cb26-516" aria-hidden="true" tabindex="-1"></a><span class="co">    lam : float</span></span>
<span id="cb26-517"><a href="#cb26-517" aria-hidden="true" tabindex="-1"></a><span class="co">        Risk aversion parameter.</span></span>
<span id="cb26-518"><a href="#cb26-518" aria-hidden="true" tabindex="-1"></a><span class="co">    n_steps : int</span></span>
<span id="cb26-519"><a href="#cb26-519" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of time steps.</span></span>
<span id="cb26-520"><a href="#cb26-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-521"><a href="#cb26-521" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-522"><a href="#cb26-522" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-523"><a href="#cb26-523" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Time, remaining shares, trading rate, expected cost.</span></span>
<span id="cb26-524"><a href="#cb26-524" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-525"><a href="#cb26-525" aria-hidden="true" tabindex="-1"></a>    tau <span class="op">=</span> T <span class="op">/</span> n_steps</span>
<span id="cb26-526"><a href="#cb26-526" aria-hidden="true" tabindex="-1"></a>    kappa_sq <span class="op">=</span> lam <span class="op">*</span> sigma<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> (eta <span class="op">/</span> tau)</span>
<span id="cb26-527"><a href="#cb26-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-528"><a href="#cb26-528" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> kappa_sq <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb26-529"><a href="#cb26-529" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Risk-neutral: trade uniformly</span></span>
<span id="cb26-530"><a href="#cb26-530" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb26-531"><a href="#cb26-531" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> np.linspace(X, <span class="dv">0</span>, n_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb26-532"><a href="#cb26-532" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb26-533"><a href="#cb26-533" aria-hidden="true" tabindex="-1"></a>        kappa <span class="op">=</span> np.sqrt(kappa_sq)</span>
<span id="cb26-534"><a href="#cb26-534" aria-hidden="true" tabindex="-1"></a>        t_grid <span class="op">=</span> np.linspace(<span class="dv">0</span>, T, n_steps <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb26-535"><a href="#cb26-535" aria-hidden="true" tabindex="-1"></a>        x_t <span class="op">=</span> X <span class="op">*</span> np.sinh(kappa <span class="op">*</span> (T <span class="op">-</span> t_grid)) <span class="op">/</span> np.sinh(kappa <span class="op">*</span> T)</span>
<span id="cb26-536"><a href="#cb26-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-537"><a href="#cb26-537" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Trading rates</span></span>
<span id="cb26-538"><a href="#cb26-538" aria-hidden="true" tabindex="-1"></a>    n_t <span class="op">=</span> <span class="op">-</span>np.diff(x_t)</span>
<span id="cb26-539"><a href="#cb26-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-540"><a href="#cb26-540" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Expected cost components</span></span>
<span id="cb26-541"><a href="#cb26-541" aria-hidden="true" tabindex="-1"></a>    perm_cost <span class="op">=</span> gamma <span class="op">*</span> np.<span class="bu">sum</span>(n_t<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb26-542"><a href="#cb26-542" aria-hidden="true" tabindex="-1"></a>    temp_cost <span class="op">=</span> (eta <span class="op">/</span> tau) <span class="op">*</span> np.<span class="bu">sum</span>(n_t<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb26-543"><a href="#cb26-543" aria-hidden="true" tabindex="-1"></a>    total_expected_cost <span class="op">=</span> perm_cost <span class="op">+</span> temp_cost</span>
<span id="cb26-544"><a href="#cb26-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-545"><a href="#cb26-545" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Variance of cost</span></span>
<span id="cb26-546"><a href="#cb26-546" aria-hidden="true" tabindex="-1"></a>    var_cost <span class="op">=</span> sigma<span class="op">**</span><span class="dv">2</span> <span class="op">*</span> tau <span class="op">*</span> np.<span class="bu">sum</span>(x_t[:<span class="op">-</span><span class="dv">1</span>]<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb26-547"><a href="#cb26-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-548"><a href="#cb26-548" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb26-549"><a href="#cb26-549" aria-hidden="true" tabindex="-1"></a>        <span class="st">"time"</span>: np.linspace(<span class="dv">0</span>, T, n_steps <span class="op">+</span> <span class="dv">1</span>)[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb26-550"><a href="#cb26-550" aria-hidden="true" tabindex="-1"></a>        <span class="st">"remaining_shares"</span>: x_t[:<span class="op">-</span><span class="dv">1</span>],</span>
<span id="cb26-551"><a href="#cb26-551" aria-hidden="true" tabindex="-1"></a>        <span class="st">"trade_rate"</span>: n_t</span>
<span id="cb26-552"><a href="#cb26-552" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-553"><a href="#cb26-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-554"><a href="#cb26-554" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"expected_cost"</span>] <span class="op">=</span> total_expected_cost</span>
<span id="cb26-555"><a href="#cb26-555" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"cost_variance"</span>] <span class="op">=</span> var_cost</span>
<span id="cb26-556"><a href="#cb26-556" aria-hidden="true" tabindex="-1"></a>    results.attrs[<span class="st">"kappa"</span>] <span class="op">=</span> kappa <span class="cf">if</span> kappa_sq <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb26-557"><a href="#cb26-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-558"><a href="#cb26-558" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb26-559"><a href="#cb26-559" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-560"><a href="#cb26-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-563"><a href="#cb26-563" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-564"><a href="#cb26-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-execution-trajectories</span></span>
<span id="cb26-565"><a href="#cb26-565" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-566"><a href="#cb26-566" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Optimal Execution Trajectories for Different Risk Aversion Levels"</span></span>
<span id="cb26-567"><a href="#cb26-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-568"><a href="#cb26-568" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate market impact parameters from Vietnamese data</span></span>
<span id="cb26-569"><a href="#cb26-569" aria-hidden="true" tabindex="-1"></a><span class="co"># Typical values for mid-cap Vietnamese stocks</span></span>
<span id="cb26-570"><a href="#cb26-570" aria-hidden="true" tabindex="-1"></a>sigma_daily <span class="op">=</span> <span class="fl">0.025</span>  <span class="co"># 2.5% daily vol</span></span>
<span id="cb26-571"><a href="#cb26-571" aria-hidden="true" tabindex="-1"></a>eta <span class="op">=</span> <span class="fl">2.5e-7</span>         <span class="co"># Temporary impact</span></span>
<span id="cb26-572"><a href="#cb26-572" aria-hidden="true" tabindex="-1"></a>gamma <span class="op">=</span> <span class="fl">1.0e-7</span>       <span class="co"># Permanent impact</span></span>
<span id="cb26-573"><a href="#cb26-573" aria-hidden="true" tabindex="-1"></a>X_shares <span class="op">=</span> <span class="dv">500000</span>    <span class="co"># 500k shares to sell</span></span>
<span id="cb26-574"><a href="#cb26-574" aria-hidden="true" tabindex="-1"></a>T_days <span class="op">=</span> <span class="dv">5</span>           <span class="co"># 5-day horizon</span></span>
<span id="cb26-575"><a href="#cb26-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-576"><a href="#cb26-576" aria-hidden="true" tabindex="-1"></a>trajectories <span class="op">=</span> []</span>
<span id="cb26-577"><a href="#cb26-577" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lam, label <span class="kw">in</span> [(<span class="dv">0</span>, <span class="st">"Risk Neutral (TWAP)"</span>),</span>
<span id="cb26-578"><a href="#cb26-578" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-6</span>, <span class="st">"Low Risk Aversion"</span>),</span>
<span id="cb26-579"><a href="#cb26-579" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-5</span>, <span class="st">"Medium Risk Aversion"</span>),</span>
<span id="cb26-580"><a href="#cb26-580" aria-hidden="true" tabindex="-1"></a>                    (<span class="fl">1e-4</span>, <span class="st">"High Risk Aversion"</span>)]:</span>
<span id="cb26-581"><a href="#cb26-581" aria-hidden="true" tabindex="-1"></a>    traj <span class="op">=</span> almgren_chriss_trajectory(</span>
<span id="cb26-582"><a href="#cb26-582" aria-hidden="true" tabindex="-1"></a>        X_shares, T_days, sigma_daily, eta, gamma, lam</span>
<span id="cb26-583"><a href="#cb26-583" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-584"><a href="#cb26-584" aria-hidden="true" tabindex="-1"></a>    traj[<span class="st">"strategy"</span>] <span class="op">=</span> label</span>
<span id="cb26-585"><a href="#cb26-585" aria-hidden="true" tabindex="-1"></a>    traj[<span class="st">"pct_remaining"</span>] <span class="op">=</span> traj[<span class="st">"remaining_shares"</span>] <span class="op">/</span> X_shares <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb26-586"><a href="#cb26-586" aria-hidden="true" tabindex="-1"></a>    trajectories.append(traj)</span>
<span id="cb26-587"><a href="#cb26-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-588"><a href="#cb26-588" aria-hidden="true" tabindex="-1"></a>traj_all <span class="op">=</span> pd.concat(trajectories, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb26-589"><a href="#cb26-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-590"><a href="#cb26-590" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-591"><a href="#cb26-591" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(traj_all, p9.aes(</span>
<span id="cb26-592"><a href="#cb26-592" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"time"</span>, y<span class="op">=</span><span class="st">"pct_remaining"</span>, color<span class="op">=</span><span class="st">"strategy"</span></span>
<span id="cb26-593"><a href="#cb26-593" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-594"><a href="#cb26-594" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-595"><a href="#cb26-595" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(</span>
<span id="cb26-596"><a href="#cb26-596" aria-hidden="true" tabindex="-1"></a>        values<span class="op">=</span>[<span class="st">"#95A5A6"</span>, <span class="st">"#27AE60"</span>, <span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>]</span>
<span id="cb26-597"><a href="#cb26-597" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-598"><a href="#cb26-598" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-599"><a href="#cb26-599" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Time (Trading Days)"</span>,</span>
<span id="cb26-600"><a href="#cb26-600" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Remaining Order (%)"</span>,</span>
<span id="cb26-601"><a href="#cb26-601" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Almgren-Chriss Optimal Execution Trajectories"</span>,</span>
<span id="cb26-602"><a href="#cb26-602" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Strategy"</span></span>
<span id="cb26-603"><a href="#cb26-603" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-604"><a href="#cb26-604" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-605"><a href="#cb26-605" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>), legend_position<span class="op">=</span><span class="st">"top"</span>)</span>
<span id="cb26-606"><a href="#cb26-606" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-607"><a href="#cb26-607" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-608"><a href="#cb26-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-609"><a href="#cb26-609" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimating Market Impact from Transaction Data</span></span>
<span id="cb26-610"><a href="#cb26-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-611"><a href="#cb26-611" aria-hidden="true" tabindex="-1"></a>The structural parameters $(\gamma, \eta, \sigma)$ must be estimated from data. The standard approach uses the square-root law of market impact, documented empirically by @kyle1985continuous and @hasbrouck1991measuring and derived theoretically by @gabaix2003theory:</span>
<span id="cb26-612"><a href="#cb26-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-613"><a href="#cb26-613" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-614"><a href="#cb26-614" aria-hidden="true" tabindex="-1"></a>\Delta P / P = c \cdot \text{sgn}(Q) \cdot |Q / V|^{\delta}</span>
<span id="cb26-615"><a href="#cb26-615" aria-hidden="true" tabindex="-1"></a>$$ {#eq-impact-model}</span>
<span id="cb26-616"><a href="#cb26-616" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-617"><a href="#cb26-617" aria-hidden="true" tabindex="-1"></a>where $Q$ is the signed order flow, $V$ is daily volume, $c$ is the impact coefficient, and $\delta \approx 0.5$ is the impact exponent. The "square root" refers to $\delta = 0.5$, which is remarkably robust across markets, time periods, and asset classes.</span>
<span id="cb26-618"><a href="#cb26-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-621"><a href="#cb26-621" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-622"><a href="#cb26-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: impact-estimation</span></span>
<span id="cb26-623"><a href="#cb26-623" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-624"><a href="#cb26-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-625"><a href="#cb26-625" aria-hidden="true" tabindex="-1"></a><span class="co"># Load intraday transaction data (or daily order flow proxy)</span></span>
<span id="cb26-626"><a href="#cb26-626" aria-hidden="true" tabindex="-1"></a>order_flow <span class="op">=</span> dc.get_order_flow(</span>
<span id="cb26-627"><a href="#cb26-627" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb26-628"><a href="#cb26-628" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb26-629"><a href="#cb26-629" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb26-630"><a href="#cb26-630" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-631"><a href="#cb26-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-632"><a href="#cb26-632" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct signed order flow using Lee-Ready classification</span></span>
<span id="cb26-633"><a href="#cb26-633" aria-hidden="true" tabindex="-1"></a><span class="co"># (buy-initiated minus sell-initiated volume)</span></span>
<span id="cb26-634"><a href="#cb26-634" aria-hidden="true" tabindex="-1"></a>impact_data <span class="op">=</span> order_flow.merge(</span>
<span id="cb26-635"><a href="#cb26-635" aria-hidden="true" tabindex="-1"></a>    dc.get_daily_returns(</span>
<span id="cb26-636"><a href="#cb26-636" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb26-637"><a href="#cb26-637" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-638"><a href="#cb26-638" aria-hidden="true" tabindex="-1"></a>    )[[<span class="st">"ticker"</span>, <span class="st">"date"</span>, <span class="st">"ret"</span>, <span class="st">"volume"</span>, <span class="st">"market_cap"</span>]],</span>
<span id="cb26-639"><a href="#cb26-639" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"date"</span>],</span>
<span id="cb26-640"><a href="#cb26-640" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb26-641"><a href="#cb26-641" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-642"><a href="#cb26-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-643"><a href="#cb26-643" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalize order flow</span></span>
<span id="cb26-644"><a href="#cb26-644" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"oib"</span>] <span class="op">=</span> impact_data[<span class="st">"net_buy_volume"</span>] <span class="op">/</span> impact_data[<span class="st">"volume"</span>]</span>
<span id="cb26-645"><a href="#cb26-645" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"abs_oib"</span>] <span class="op">=</span> np.<span class="bu">abs</span>(impact_data[<span class="st">"oib"</span>])</span>
<span id="cb26-646"><a href="#cb26-646" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"sign_oib"</span>] <span class="op">=</span> np.sign(impact_data[<span class="st">"oib"</span>])</span>
<span id="cb26-647"><a href="#cb26-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-648"><a href="#cb26-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-log regression: ln|Î”P| = Î± + Î´ ln|Q/V| + Îµ</span></span>
<span id="cb26-649"><a href="#cb26-649" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"ln_abs_ret"</span>] <span class="op">=</span> np.log(np.<span class="bu">abs</span>(impact_data[<span class="st">"ret"</span>]).clip(lower<span class="op">=</span><span class="fl">1e-8</span>))</span>
<span id="cb26-650"><a href="#cb26-650" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"ln_abs_oib"</span>] <span class="op">=</span> np.log(impact_data[<span class="st">"abs_oib"</span>].clip(lower<span class="op">=</span><span class="fl">1e-8</span>))</span>
<span id="cb26-651"><a href="#cb26-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-652"><a href="#cb26-652" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate by size quintile</span></span>
<span id="cb26-653"><a href="#cb26-653" aria-hidden="true" tabindex="-1"></a>impact_data[<span class="st">"size_quintile"</span>] <span class="op">=</span> impact_data.groupby(<span class="st">"date"</span>)[</span>
<span id="cb26-654"><a href="#cb26-654" aria-hidden="true" tabindex="-1"></a>    <span class="st">"market_cap"</span></span>
<span id="cb26-655"><a href="#cb26-655" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb26-656"><a href="#cb26-656" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb26-657"><a href="#cb26-657" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-658"><a href="#cb26-658" aria-hidden="true" tabindex="-1"></a>impact_results <span class="op">=</span> []</span>
<span id="cb26-659"><a href="#cb26-659" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb26-660"><a href="#cb26-660" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> impact_data[impact_data[<span class="st">"size_quintile"</span>] <span class="op">==</span> q].dropna(</span>
<span id="cb26-661"><a href="#cb26-661" aria-hidden="true" tabindex="-1"></a>        subset<span class="op">=</span>[<span class="st">"ln_abs_ret"</span>, <span class="st">"ln_abs_oib"</span>]</span>
<span id="cb26-662"><a href="#cb26-662" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-663"><a href="#cb26-663" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> <span class="dv">500</span>:</span>
<span id="cb26-664"><a href="#cb26-664" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb26-665"><a href="#cb26-665" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-666"><a href="#cb26-666" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb26-667"><a href="#cb26-667" aria-hidden="true" tabindex="-1"></a>        subset[<span class="st">"ln_abs_ret"</span>],</span>
<span id="cb26-668"><a href="#cb26-668" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(subset[<span class="st">"ln_abs_oib"</span>])</span>
<span id="cb26-669"><a href="#cb26-669" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb26-670"><a href="#cb26-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-671"><a href="#cb26-671" aria-hidden="true" tabindex="-1"></a>    impact_results.append({</span>
<span id="cb26-672"><a href="#cb26-672" aria-hidden="true" tabindex="-1"></a>        <span class="st">"size_quintile"</span>: q,</span>
<span id="cb26-673"><a href="#cb26-673" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_hat"</span>: model.params.iloc[<span class="dv">1</span>],</span>
<span id="cb26-674"><a href="#cb26-674" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta_se"</span>: model.bse.iloc[<span class="dv">1</span>],</span>
<span id="cb26-675"><a href="#cb26-675" aria-hidden="true" tabindex="-1"></a>        <span class="st">"intercept"</span>: model.params.iloc[<span class="dv">0</span>],</span>
<span id="cb26-676"><a href="#cb26-676" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb26-677"><a href="#cb26-677" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_obs"</span>: <span class="bu">int</span>(model.nobs)</span>
<span id="cb26-678"><a href="#cb26-678" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-679"><a href="#cb26-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-680"><a href="#cb26-680" aria-hidden="true" tabindex="-1"></a>impact_df <span class="op">=</span> pd.DataFrame(impact_results)</span>
<span id="cb26-681"><a href="#cb26-681" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-682"><a href="#cb26-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-685"><a href="#cb26-685" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-686"><a href="#cb26-686" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-impact-by-size</span></span>
<span id="cb26-687"><a href="#cb26-687" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-688"><a href="#cb26-688" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Market Impact Exponent by Firm Size Quintile"</span></span>
<span id="cb26-689"><a href="#cb26-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-690"><a href="#cb26-690" aria-hidden="true" tabindex="-1"></a>impact_df.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb26-691"><a href="#cb26-691" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-692"><a href="#cb26-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-693"><a href="#cb26-693" aria-hidden="true" tabindex="-1"></a>The impact exponent $\hat{\delta}$ near 0.5 across size quintiles confirms the universality of the square-root law. Smaller firms typically exhibit higher impact coefficients (larger $c$), consistent with lower liquidity.</span>
<span id="cb26-694"><a href="#cb26-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-695"><a href="#cb26-695" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transaction Cost Decomposition</span></span>
<span id="cb26-696"><a href="#cb26-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-697"><a href="#cb26-697" aria-hidden="true" tabindex="-1"></a>Total transaction costs comprise multiple components, each with distinct economic content:</span>
<span id="cb26-698"><a href="#cb26-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-699"><a href="#cb26-699" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-700"><a href="#cb26-700" aria-hidden="true" tabindex="-1"></a>\text{TC} = \underbrace{\frac{s}{2}}_{\text{Half-spread}} + \underbrace{\gamma \cdot Q}_{\text{Permanent impact}} + \underbrace{\eta \cdot \frac{Q}{V}}_{\text{Temporary impact}} + \underbrace{\sigma \sqrt{T}}_{\text{Timing risk}}</span>
<span id="cb26-701"><a href="#cb26-701" aria-hidden="true" tabindex="-1"></a>$$ {#eq-tc-decomposition}</span>
<span id="cb26-702"><a href="#cb26-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-703"><a href="#cb26-703" aria-hidden="true" tabindex="-1"></a>We estimate each component separately, following the @hasbrouck2009trading methodology for effective spread decomposition.</span>
<span id="cb26-704"><a href="#cb26-704" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-707"><a href="#cb26-707" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-708"><a href="#cb26-708" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tc-decomposition</span></span>
<span id="cb26-709"><a href="#cb26-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-710"><a href="#cb26-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-711"><a href="#cb26-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Effective spread estimation</span></span>
<span id="cb26-712"><a href="#cb26-712" aria-hidden="true" tabindex="-1"></a>spreads <span class="op">=</span> dc.get_bid_ask_data(</span>
<span id="cb26-713"><a href="#cb26-713" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb26-714"><a href="#cb26-714" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-715"><a href="#cb26-715" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-716"><a href="#cb26-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-717"><a href="#cb26-717" aria-hidden="true" tabindex="-1"></a><span class="co"># Quoted spread</span></span>
<span id="cb26-718"><a href="#cb26-718" aria-hidden="true" tabindex="-1"></a>spreads[<span class="st">"quoted_spread"</span>] <span class="op">=</span> (</span>
<span id="cb26-719"><a href="#cb26-719" aria-hidden="true" tabindex="-1"></a>    (spreads[<span class="st">"ask"</span>] <span class="op">-</span> spreads[<span class="st">"bid"</span>]) <span class="op">/</span> spreads[<span class="st">"midpoint"</span>]</span>
<span id="cb26-720"><a href="#cb26-720" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-721"><a href="#cb26-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-722"><a href="#cb26-722" aria-hidden="true" tabindex="-1"></a><span class="co"># Effective spread (from transaction prices)</span></span>
<span id="cb26-723"><a href="#cb26-723" aria-hidden="true" tabindex="-1"></a>spreads[<span class="st">"effective_spread"</span>] <span class="op">=</span> (</span>
<span id="cb26-724"><a href="#cb26-724" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span> <span class="op">*</span> np.<span class="bu">abs</span>(spreads[<span class="st">"trade_price"</span>] <span class="op">-</span> spreads[<span class="st">"midpoint"</span>]) <span class="op">/</span></span>
<span id="cb26-725"><a href="#cb26-725" aria-hidden="true" tabindex="-1"></a>    spreads[<span class="st">"midpoint"</span>]</span>
<span id="cb26-726"><a href="#cb26-726" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-727"><a href="#cb26-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-728"><a href="#cb26-728" aria-hidden="true" tabindex="-1"></a><span class="co"># Roll (1984) implied spread from return autocovariance</span></span>
<span id="cb26-729"><a href="#cb26-729" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> roll_spread(returns):</span>
<span id="cb26-730"><a href="#cb26-730" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-731"><a href="#cb26-731" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate the Roll (1984) bid-ask spread.</span></span>
<span id="cb26-732"><a href="#cb26-732" aria-hidden="true" tabindex="-1"></a><span class="co">    Spread = 2 * sqrt(-Cov(r_t, r_{t-1})) if covariance is negative.</span></span>
<span id="cb26-733"><a href="#cb26-733" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-734"><a href="#cb26-734" aria-hidden="true" tabindex="-1"></a>    cov <span class="op">=</span> np.cov(returns[<span class="dv">1</span>:], returns[:<span class="op">-</span><span class="dv">1</span>])[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb26-735"><a href="#cb26-735" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> cov <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb26-736"><a href="#cb26-736" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span> <span class="op">*</span> np.sqrt(<span class="op">-</span>cov)</span>
<span id="cb26-737"><a href="#cb26-737" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb26-738"><a href="#cb26-738" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb26-739"><a href="#cb26-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-740"><a href="#cb26-740" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute by stock-month</span></span>
<span id="cb26-741"><a href="#cb26-741" aria-hidden="true" tabindex="-1"></a>daily_rets <span class="op">=</span> dc.get_daily_returns(</span>
<span id="cb26-742"><a href="#cb26-742" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2020-01-01"</span>,</span>
<span id="cb26-743"><a href="#cb26-743" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-744"><a href="#cb26-744" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-745"><a href="#cb26-745" aria-hidden="true" tabindex="-1"></a>daily_rets[<span class="st">"month"</span>] <span class="op">=</span> daily_rets[<span class="st">"date"</span>].dt.to_period(<span class="st">"M"</span>)</span>
<span id="cb26-746"><a href="#cb26-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-747"><a href="#cb26-747" aria-hidden="true" tabindex="-1"></a>roll_spreads <span class="op">=</span> (</span>
<span id="cb26-748"><a href="#cb26-748" aria-hidden="true" tabindex="-1"></a>    daily_rets.groupby([<span class="st">"ticker"</span>, <span class="st">"month"</span>])</span>
<span id="cb26-749"><a href="#cb26-749" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb26-750"><a href="#cb26-750" aria-hidden="true" tabindex="-1"></a>        roll_spread<span class="op">=</span>(<span class="st">"ret"</span>, <span class="kw">lambda</span> x: roll_spread(x.values)</span>
<span id="cb26-751"><a href="#cb26-751" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> <span class="bu">len</span>(x) <span class="op">&gt;</span> <span class="dv">10</span> <span class="cf">else</span> np.nan),</span>
<span id="cb26-752"><a href="#cb26-752" aria-hidden="true" tabindex="-1"></a>        n_days<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"count"</span>),</span>
<span id="cb26-753"><a href="#cb26-753" aria-hidden="true" tabindex="-1"></a>        avg_volume<span class="op">=</span>(<span class="st">"volume"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-754"><a href="#cb26-754" aria-hidden="true" tabindex="-1"></a>        market_cap<span class="op">=</span>(<span class="st">"market_cap"</span>, <span class="st">"last"</span>)</span>
<span id="cb26-755"><a href="#cb26-755" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-756"><a href="#cb26-756" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb26-757"><a href="#cb26-757" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">"roll_spread"</span>])</span>
<span id="cb26-758"><a href="#cb26-758" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-759"><a href="#cb26-759" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-760"><a href="#cb26-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-763"><a href="#cb26-763" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-764"><a href="#cb26-764" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-spread-size</span></span>
<span id="cb26-765"><a href="#cb26-765" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-766"><a href="#cb26-766" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Transaction Costs by Firm Size: Roll Implied Spread"</span></span>
<span id="cb26-767"><a href="#cb26-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-768"><a href="#cb26-768" aria-hidden="true" tabindex="-1"></a><span class="co"># Bin by market cap deciles</span></span>
<span id="cb26-769"><a href="#cb26-769" aria-hidden="true" tabindex="-1"></a>roll_spreads[<span class="st">"size_decile"</span>] <span class="op">=</span> roll_spreads.groupby(<span class="st">"month"</span>)[</span>
<span id="cb26-770"><a href="#cb26-770" aria-hidden="true" tabindex="-1"></a>    <span class="st">"market_cap"</span></span>
<span id="cb26-771"><a href="#cb26-771" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">10</span>, labels<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>),</span>
<span id="cb26-772"><a href="#cb26-772" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb26-773"><a href="#cb26-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-774"><a href="#cb26-774" aria-hidden="true" tabindex="-1"></a>spread_by_size <span class="op">=</span> (</span>
<span id="cb26-775"><a href="#cb26-775" aria-hidden="true" tabindex="-1"></a>    roll_spreads.groupby(<span class="st">"size_decile"</span>)</span>
<span id="cb26-776"><a href="#cb26-776" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb26-777"><a href="#cb26-777" aria-hidden="true" tabindex="-1"></a>        median_spread<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="st">"median"</span>),</span>
<span id="cb26-778"><a href="#cb26-778" aria-hidden="true" tabindex="-1"></a>        mean_spread<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-779"><a href="#cb26-779" aria-hidden="true" tabindex="-1"></a>        q25<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>)),</span>
<span id="cb26-780"><a href="#cb26-780" aria-hidden="true" tabindex="-1"></a>        q75<span class="op">=</span>(<span class="st">"roll_spread"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>))</span>
<span id="cb26-781"><a href="#cb26-781" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-782"><a href="#cb26-782" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb26-783"><a href="#cb26-783" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-784"><a href="#cb26-784" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-785"><a href="#cb26-785" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-786"><a href="#cb26-786" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(spread_by_size, p9.aes(x<span class="op">=</span><span class="st">"size_decile"</span>, y<span class="op">=</span><span class="st">"median_spread"</span>))</span>
<span id="cb26-787"><a href="#cb26-787" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_bar(stat<span class="op">=</span><span class="st">"identity"</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb26-788"><a href="#cb26-788" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_errorbar(</span>
<span id="cb26-789"><a href="#cb26-789" aria-hidden="true" tabindex="-1"></a>        p9.aes(ymin<span class="op">=</span><span class="st">"q25"</span>, ymax<span class="op">=</span><span class="st">"q75"</span>),</span>
<span id="cb26-790"><a href="#cb26-790" aria-hidden="true" tabindex="-1"></a>        width<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">"#2E5090"</span></span>
<span id="cb26-791"><a href="#cb26-791" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-792"><a href="#cb26-792" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-793"><a href="#cb26-793" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Size Decile (1 = Smallest)"</span>,</span>
<span id="cb26-794"><a href="#cb26-794" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Roll Implied Spread"</span>,</span>
<span id="cb26-795"><a href="#cb26-795" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Transaction Costs Decrease Monotonically with Firm Size"</span></span>
<span id="cb26-796"><a href="#cb26-796" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-797"><a href="#cb26-797" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb26-798"><a href="#cb26-798" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-799"><a href="#cb26-799" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb26-800"><a href="#cb26-800" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-801"><a href="#cb26-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-802"><a href="#cb26-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-803"><a href="#cb26-803" aria-hidden="true" tabindex="-1"></a><span class="fu">## Auction Models in Primary Markets</span></span>
<span id="cb26-804"><a href="#cb26-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-805"><a href="#cb26-805" aria-hidden="true" tabindex="-1"></a><span class="fu">### The IPO Allocation Problem</span></span>
<span id="cb26-806"><a href="#cb26-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-807"><a href="#cb26-807" aria-hidden="true" tabindex="-1"></a>Initial public offerings present a classic information asymmetry problem. Issuers and underwriters do not know the true market-clearing price; informed investors do (approximately). The allocation mechanism (i.e., how shares are distributed and at what price) determines the IPO's pricing efficiency, the degree of underpricing, and the distribution of surplus between issuers and investors.</span>
<span id="cb26-808"><a href="#cb26-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-809"><a href="#cb26-809" aria-hidden="true" tabindex="-1"></a>@rock1986new provides the canonical model. There are two types of investors: informed (who know the true value $v$) and uninformed (who know only the distribution $v \sim F$). If the IPO is priced at $P$:</span>
<span id="cb26-810"><a href="#cb26-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-811"><a href="#cb26-811" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>When $v &gt; P$ (good IPO): both informed and uninformed subscribe, so uninformed receive only a fraction of their order (rationing).</span>
<span id="cb26-812"><a href="#cb26-812" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>When $v &lt; P$ (bad IPO): only uninformed subscribe, so they receive full allocation (the "winner's curse").</span>
<span id="cb26-813"><a href="#cb26-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-814"><a href="#cb26-814" aria-hidden="true" tabindex="-1"></a>The uninformed investor's expected return, accounting for rationing, is:</span>
<span id="cb26-815"><a href="#cb26-815" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-816"><a href="#cb26-816" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-817"><a href="#cb26-817" aria-hidden="true" tabindex="-1"></a>E<span class="co">[</span><span class="ot">R_{\text{uninformed}}</span><span class="co">]</span> = \alpha_g \cdot E\left<span class="co">[</span><span class="ot">\frac{v - P}{P} \mid v &gt; P\right</span><span class="co">]</span> \cdot \Pr(v &gt; P) + E\left<span class="co">[</span><span class="ot">\frac{v - P}{P} \mid v \leq P\right</span><span class="co">]</span> \cdot \Pr(v \leq P)</span>
<span id="cb26-818"><a href="#cb26-818" aria-hidden="true" tabindex="-1"></a>$$ {#eq-rock-return}</span>
<span id="cb26-819"><a href="#cb26-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-820"><a href="#cb26-820" aria-hidden="true" tabindex="-1"></a>where $\alpha_g &lt; 1$ is the allocation probability in good IPOs (rationed) and allocation is 1 in bad IPOs. For uninformed investors to participate, $E<span class="co">[</span><span class="ot">R_{\text{uninformed}}</span><span class="co">]</span> \geq 0$, which requires:</span>
<span id="cb26-821"><a href="#cb26-821" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-822"><a href="#cb26-822" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-823"><a href="#cb26-823" aria-hidden="true" tabindex="-1"></a>E\left<span class="co">[</span><span class="ot">\frac{v - P}{P}\right</span><span class="co">]</span> &gt; 0</span>
<span id="cb26-824"><a href="#cb26-824" aria-hidden="true" tabindex="-1"></a>$$ {#eq-underpricing-condition}</span>
<span id="cb26-825"><a href="#cb26-825" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-826"><a href="#cb26-826" aria-hidden="true" tabindex="-1"></a>That is, IPOs must be underpriced on average to compensate uninformed investors for the winner's curse. The degree of required underpricing increases with the proportion of informed investors and the variance of the true value.</span>
<span id="cb26-827"><a href="#cb26-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-828"><a href="#cb26-828" aria-hidden="true" tabindex="-1"></a><span class="fu">### Book Building vs. Auction Mechanisms</span></span>
<span id="cb26-829"><a href="#cb26-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-830"><a href="#cb26-830" aria-hidden="true" tabindex="-1"></a>Vietnamese IPO history provides variation in allocation mechanisms. State-owned enterprise equitizations have used Dutch auctions, while private-sector IPOs have used book building. This institutional variation allows structural comparison of the mechanisms.</span>
<span id="cb26-831"><a href="#cb26-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-832"><a href="#cb26-832" aria-hidden="true" tabindex="-1"></a>**Book Building** <span class="co">[</span><span class="ot">@benveniste1989investment</span><span class="co">]</span>: The underwriter solicits indications of interest from institutional investors during the roadshow. Investors who reveal positive information (high valuations) receive favorable allocations as compensation. The mechanism aggregates information efficiently but grants discretion to the underwriter.</span>
<span id="cb26-833"><a href="#cb26-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-834"><a href="#cb26-834" aria-hidden="true" tabindex="-1"></a>**Uniform-Price Auction**: All winning bidders pay the same market-clearing price. This eliminates the underwriter's allocation discretion but may lead to free-riding on information revelation.</span>
<span id="cb26-835"><a href="#cb26-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-838"><a href="#cb26-838" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-839"><a href="#cb26-839" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ipo-data</span></span>
<span id="cb26-840"><a href="#cb26-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-841"><a href="#cb26-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-842"><a href="#cb26-842" aria-hidden="true" tabindex="-1"></a><span class="co"># Load IPO data</span></span>
<span id="cb26-843"><a href="#cb26-843" aria-hidden="true" tabindex="-1"></a>ipo_data <span class="op">=</span> dc.get_ipo_data(</span>
<span id="cb26-844"><a href="#cb26-844" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2005-01-01"</span>,</span>
<span id="cb26-845"><a href="#cb26-845" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-846"><a href="#cb26-846" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-847"><a href="#cb26-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-848"><a href="#cb26-848" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute first-day returns (underpricing)</span></span>
<span id="cb26-849"><a href="#cb26-849" aria-hidden="true" tabindex="-1"></a>ipo_data[<span class="st">"underpricing"</span>] <span class="op">=</span> (</span>
<span id="cb26-850"><a href="#cb26-850" aria-hidden="true" tabindex="-1"></a>    (ipo_data[<span class="st">"first_day_close"</span>] <span class="op">-</span> ipo_data[<span class="st">"offer_price"</span>]) <span class="op">/</span></span>
<span id="cb26-851"><a href="#cb26-851" aria-hidden="true" tabindex="-1"></a>    ipo_data[<span class="st">"offer_price"</span>]</span>
<span id="cb26-852"><a href="#cb26-852" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-853"><a href="#cb26-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-854"><a href="#cb26-854" aria-hidden="true" tabindex="-1"></a><span class="co"># Classify mechanism</span></span>
<span id="cb26-855"><a href="#cb26-855" aria-hidden="true" tabindex="-1"></a>ipo_data[<span class="st">"mechanism"</span>] <span class="op">=</span> ipo_data[<span class="st">"ipo_method"</span>].<span class="bu">map</span>({</span>
<span id="cb26-856"><a href="#cb26-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">"auction"</span>: <span class="st">"Auction"</span>,</span>
<span id="cb26-857"><a href="#cb26-857" aria-hidden="true" tabindex="-1"></a>    <span class="st">"book_building"</span>: <span class="st">"Book Building"</span>,</span>
<span id="cb26-858"><a href="#cb26-858" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fixed_price"</span>: <span class="st">"Fixed Price"</span></span>
<span id="cb26-859"><a href="#cb26-859" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb26-860"><a href="#cb26-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-861"><a href="#cb26-861" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total IPOs: </span><span class="sc">{</span><span class="bu">len</span>(ipo_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-862"><a href="#cb26-862" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"By mechanism:</span><span class="ch">\n</span><span class="sc">{</span>ipo_data[<span class="st">'mechanism'</span>]<span class="sc">.</span>value_counts()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb26-863"><a href="#cb26-863" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-864"><a href="#cb26-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-867"><a href="#cb26-867" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-868"><a href="#cb26-868" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-ipo-underpricing</span></span>
<span id="cb26-869"><a href="#cb26-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-870"><a href="#cb26-870" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "IPO Underpricing by Allocation Mechanism"</span></span>
<span id="cb26-871"><a href="#cb26-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-872"><a href="#cb26-872" aria-hidden="true" tabindex="-1"></a>ipo_summary <span class="op">=</span> (</span>
<span id="cb26-873"><a href="#cb26-873" aria-hidden="true" tabindex="-1"></a>    ipo_data.groupby(<span class="st">"mechanism"</span>)</span>
<span id="cb26-874"><a href="#cb26-874" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb26-875"><a href="#cb26-875" aria-hidden="true" tabindex="-1"></a>        n_ipos<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"count"</span>),</span>
<span id="cb26-876"><a href="#cb26-876" aria-hidden="true" tabindex="-1"></a>        mean_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-877"><a href="#cb26-877" aria-hidden="true" tabindex="-1"></a>        median_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"median"</span>),</span>
<span id="cb26-878"><a href="#cb26-878" aria-hidden="true" tabindex="-1"></a>        std_underpricing<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"std"</span>),</span>
<span id="cb26-879"><a href="#cb26-879" aria-hidden="true" tabindex="-1"></a>        pct_positive<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="kw">lambda</span> x: (x <span class="op">&gt;</span> <span class="dv">0</span>).mean()),</span>
<span id="cb26-880"><a href="#cb26-880" aria-hidden="true" tabindex="-1"></a>        mean_proceeds<span class="op">=</span>(<span class="st">"proceeds_bn_vnd"</span>, <span class="st">"mean"</span>)</span>
<span id="cb26-881"><a href="#cb26-881" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-882"><a href="#cb26-882" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb26-883"><a href="#cb26-883" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-884"><a href="#cb26-884" aria-hidden="true" tabindex="-1"></a>ipo_summary</span>
<span id="cb26-885"><a href="#cb26-885" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-886"><a href="#cb26-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-887"><a href="#cb26-887" aria-hidden="true" tabindex="-1"></a><span class="fu">### Structural Estimation of Information Asymmetry</span></span>
<span id="cb26-888"><a href="#cb26-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-889"><a href="#cb26-889" aria-hidden="true" tabindex="-1"></a>We estimate the @rock1986new model parameters (i.e., the fraction of informed investors ($\mu$) and the precision of their information ($\sigma_v^2$)) using the method of simulated moments (MSM).</span>
<span id="cb26-890"><a href="#cb26-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-891"><a href="#cb26-891" aria-hidden="true" tabindex="-1"></a>The model predicts two key moments: </span>
<span id="cb26-892"><a href="#cb26-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-893"><a href="#cb26-893" aria-hidden="true" tabindex="-1"></a>1 . Average underpricing: $E<span class="co">[</span><span class="ot">U</span><span class="co">]</span> = f(\mu, \sigma_v^2)$ </span>
<span id="cb26-894"><a href="#cb26-894" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Cross-sectional variance of underpricing: $\text{Var}(U) = g(\mu, \sigma_v^2)$</span>
<span id="cb26-895"><a href="#cb26-895" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-896"><a href="#cb26-896" aria-hidden="true" tabindex="-1"></a>We match these model-implied moments to the data.</span>
<span id="cb26-897"><a href="#cb26-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-900"><a href="#cb26-900" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-901"><a href="#cb26-901" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rock-model-estimation</span></span>
<span id="cb26-902"><a href="#cb26-902" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-903"><a href="#cb26-903" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-904"><a href="#cb26-904" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rock_model_moments(params, n_sim<span class="op">=</span><span class="dv">10000</span>):</span>
<span id="cb26-905"><a href="#cb26-905" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-906"><a href="#cb26-906" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate Rock (1986) IPO model and compute moments.</span></span>
<span id="cb26-907"><a href="#cb26-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-908"><a href="#cb26-908" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-909"><a href="#cb26-909" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-910"><a href="#cb26-910" aria-hidden="true" tabindex="-1"></a><span class="co">    params : tuple</span></span>
<span id="cb26-911"><a href="#cb26-911" aria-hidden="true" tabindex="-1"></a><span class="co">        (mu, sigma_v) - fraction of informed investors,</span></span>
<span id="cb26-912"><a href="#cb26-912" aria-hidden="true" tabindex="-1"></a><span class="co">        std dev of true value.</span></span>
<span id="cb26-913"><a href="#cb26-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-914"><a href="#cb26-914" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-915"><a href="#cb26-915" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-916"><a href="#cb26-916" aria-hidden="true" tabindex="-1"></a><span class="co">    tuple : (mean underpricing, variance of underpricing).</span></span>
<span id="cb26-917"><a href="#cb26-917" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-918"><a href="#cb26-918" aria-hidden="true" tabindex="-1"></a>    mu, sigma_v <span class="op">=</span> params</span>
<span id="cb26-919"><a href="#cb26-919" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb26-920"><a href="#cb26-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-921"><a href="#cb26-921" aria-hidden="true" tabindex="-1"></a>    <span class="co"># True values</span></span>
<span id="cb26-922"><a href="#cb26-922" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.random.lognormal(mean<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span>sigma_v, size<span class="op">=</span>n_sim)</span>
<span id="cb26-923"><a href="#cb26-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-924"><a href="#cb26-924" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Offer price: set to break even for uninformed</span></span>
<span id="cb26-925"><a href="#cb26-925" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simplified: P = E[v] * discount_factor</span></span>
<span id="cb26-926"><a href="#cb26-926" aria-hidden="true" tabindex="-1"></a>    P <span class="op">=</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> <span class="fl">0.9</span>  <span class="co"># 10% average discount</span></span>
<span id="cb26-927"><a href="#cb26-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-928"><a href="#cb26-928" aria-hidden="true" tabindex="-1"></a>    <span class="co"># First-day returns</span></span>
<span id="cb26-929"><a href="#cb26-929" aria-hidden="true" tabindex="-1"></a>    returns <span class="op">=</span> (v <span class="op">-</span> P) <span class="op">/</span> P</span>
<span id="cb26-930"><a href="#cb26-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-931"><a href="#cb26-931" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Allocation probability for uninformed in good IPOs</span></span>
<span id="cb26-932"><a href="#cb26-932" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Depends on mu: more informed -&gt; more rationing</span></span>
<span id="cb26-933"><a href="#cb26-933" aria-hidden="true" tabindex="-1"></a>    good_mask <span class="op">=</span> v <span class="op">&gt;</span> P</span>
<span id="cb26-934"><a href="#cb26-934" aria-hidden="true" tabindex="-1"></a>    alpha_g <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> mu) <span class="op">/</span> <span class="fl">1.0</span>  <span class="co"># Simplified rationing</span></span>
<span id="cb26-935"><a href="#cb26-935" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-936"><a href="#cb26-936" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Uninformed realized returns</span></span>
<span id="cb26-937"><a href="#cb26-937" aria-hidden="true" tabindex="-1"></a>    uninformed_returns <span class="op">=</span> np.where(</span>
<span id="cb26-938"><a href="#cb26-938" aria-hidden="true" tabindex="-1"></a>        good_mask,</span>
<span id="cb26-939"><a href="#cb26-939" aria-hidden="true" tabindex="-1"></a>        alpha_g <span class="op">*</span> returns,</span>
<span id="cb26-940"><a href="#cb26-940" aria-hidden="true" tabindex="-1"></a>        returns</span>
<span id="cb26-941"><a href="#cb26-941" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-942"><a href="#cb26-942" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-943"><a href="#cb26-943" aria-hidden="true" tabindex="-1"></a>    mean_u <span class="op">=</span> uninformed_returns.mean()</span>
<span id="cb26-944"><a href="#cb26-944" aria-hidden="true" tabindex="-1"></a>    var_u <span class="op">=</span> uninformed_returns.var()</span>
<span id="cb26-945"><a href="#cb26-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-946"><a href="#cb26-946" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean_u, var_u</span>
<span id="cb26-947"><a href="#cb26-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-948"><a href="#cb26-948" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-949"><a href="#cb26-949" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> rock_model_objective(params, target_moments, weight_matrix<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb26-950"><a href="#cb26-950" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-951"><a href="#cb26-951" aria-hidden="true" tabindex="-1"></a><span class="co">    GMM objective for Rock model estimation.</span></span>
<span id="cb26-952"><a href="#cb26-952" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-953"><a href="#cb26-953" aria-hidden="true" tabindex="-1"></a>    mu, sigma_v <span class="op">=</span> params</span>
<span id="cb26-954"><a href="#cb26-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-955"><a href="#cb26-955" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mu <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> mu <span class="op">&gt;=</span> <span class="dv">1</span> <span class="kw">or</span> sigma_v <span class="op">&lt;=</span> <span class="dv">0</span> <span class="kw">or</span> sigma_v <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb26-956"><a href="#cb26-956" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1e10</span></span>
<span id="cb26-957"><a href="#cb26-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-958"><a href="#cb26-958" aria-hidden="true" tabindex="-1"></a>    model_moments <span class="op">=</span> rock_model_moments(params)</span>
<span id="cb26-959"><a href="#cb26-959" aria-hidden="true" tabindex="-1"></a>    diff <span class="op">=</span> np.array(model_moments) <span class="op">-</span> np.array(target_moments)</span>
<span id="cb26-960"><a href="#cb26-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-961"><a href="#cb26-961" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> weight_matrix <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-962"><a href="#cb26-962" aria-hidden="true" tabindex="-1"></a>        weight_matrix <span class="op">=</span> np.eye(<span class="bu">len</span>(diff))</span>
<span id="cb26-963"><a href="#cb26-963" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-964"><a href="#cb26-964" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> diff <span class="op">@</span> weight_matrix <span class="op">@</span> diff</span>
<span id="cb26-965"><a href="#cb26-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-966"><a href="#cb26-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-967"><a href="#cb26-967" aria-hidden="true" tabindex="-1"></a><span class="co"># Target moments from data</span></span>
<span id="cb26-968"><a href="#cb26-968" aria-hidden="true" tabindex="-1"></a>target_mean <span class="op">=</span> ipo_data[<span class="st">"underpricing"</span>].mean()</span>
<span id="cb26-969"><a href="#cb26-969" aria-hidden="true" tabindex="-1"></a>target_var <span class="op">=</span> ipo_data[<span class="st">"underpricing"</span>].var()</span>
<span id="cb26-970"><a href="#cb26-970" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-971"><a href="#cb26-971" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate</span></span>
<span id="cb26-972"><a href="#cb26-972" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> minimize(</span>
<span id="cb26-973"><a href="#cb26-973" aria-hidden="true" tabindex="-1"></a>    rock_model_objective,</span>
<span id="cb26-974"><a href="#cb26-974" aria-hidden="true" tabindex="-1"></a>    x0<span class="op">=</span>[<span class="fl">0.3</span>, <span class="fl">0.5</span>],</span>
<span id="cb26-975"><a href="#cb26-975" aria-hidden="true" tabindex="-1"></a>    args<span class="op">=</span>([target_mean, target_var],),</span>
<span id="cb26-976"><a href="#cb26-976" aria-hidden="true" tabindex="-1"></a>    method<span class="op">=</span><span class="st">"Nelder-Mead"</span>,</span>
<span id="cb26-977"><a href="#cb26-977" aria-hidden="true" tabindex="-1"></a>    options<span class="op">=</span>{<span class="st">"maxiter"</span>: <span class="dv">5000</span>}</span>
<span id="cb26-978"><a href="#cb26-978" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-979"><a href="#cb26-979" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-980"><a href="#cb26-980" aria-hidden="true" tabindex="-1"></a>mu_hat, sigma_v_hat <span class="op">=</span> result.x</span>
<span id="cb26-981"><a href="#cb26-981" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Rock Model Estimates:"</span>)</span>
<span id="cb26-982"><a href="#cb26-982" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Fraction informed (Î¼): </span><span class="sc">{</span>mu_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb26-983"><a href="#cb26-983" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Value uncertainty (Ïƒ_v): </span><span class="sc">{</span>sigma_v_hat<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb26-984"><a href="#cb26-984" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Objective value: </span><span class="sc">{</span>result<span class="sc">.</span>fun<span class="sc">:.6f}</span><span class="ss">"</span>)</span>
<span id="cb26-985"><a href="#cb26-985" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-986"><a href="#cb26-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-989"><a href="#cb26-989" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-990"><a href="#cb26-990" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ipo-underpricing-time</span></span>
<span id="cb26-991"><a href="#cb26-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-992"><a href="#cb26-992" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "IPO Underpricing Over Time by Mechanism"</span></span>
<span id="cb26-993"><a href="#cb26-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-994"><a href="#cb26-994" aria-hidden="true" tabindex="-1"></a>ipo_plot <span class="op">=</span> ipo_data.dropna(subset<span class="op">=</span>[<span class="st">"underpricing"</span>, <span class="st">"mechanism"</span>]).copy()</span>
<span id="cb26-995"><a href="#cb26-995" aria-hidden="true" tabindex="-1"></a>ipo_plot[<span class="st">"year"</span>] <span class="op">=</span> pd.to_datetime(ipo_plot[<span class="st">"ipo_date"</span>]).dt.year</span>
<span id="cb26-996"><a href="#cb26-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-997"><a href="#cb26-997" aria-hidden="true" tabindex="-1"></a>annual_underpricing <span class="op">=</span> (</span>
<span id="cb26-998"><a href="#cb26-998" aria-hidden="true" tabindex="-1"></a>    ipo_plot.groupby([<span class="st">"year"</span>, <span class="st">"mechanism"</span>])</span>
<span id="cb26-999"><a href="#cb26-999" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb26-1000"><a href="#cb26-1000" aria-hidden="true" tabindex="-1"></a>        mean_up<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"mean"</span>),</span>
<span id="cb26-1001"><a href="#cb26-1001" aria-hidden="true" tabindex="-1"></a>        n<span class="op">=</span>(<span class="st">"underpricing"</span>, <span class="st">"count"</span>)</span>
<span id="cb26-1002"><a href="#cb26-1002" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-1003"><a href="#cb26-1003" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb26-1004"><a href="#cb26-1004" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n &gt;= 3"</span>)</span>
<span id="cb26-1005"><a href="#cb26-1005" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1006"><a href="#cb26-1006" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1007"><a href="#cb26-1007" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-1008"><a href="#cb26-1008" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(annual_underpricing, p9.aes(</span>
<span id="cb26-1009"><a href="#cb26-1009" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"year"</span>, y<span class="op">=</span><span class="st">"mean_up"</span>, color<span class="op">=</span><span class="st">"mechanism"</span></span>
<span id="cb26-1010"><a href="#cb26-1010" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb26-1011"><a href="#cb26-1011" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(size<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-1012"><a href="#cb26-1012" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(p9.aes(size<span class="op">=</span><span class="st">"n"</span>))</span>
<span id="cb26-1013"><a href="#cb26-1013" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb26-1014"><a href="#cb26-1014" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_color_manual(values<span class="op">=</span>[<span class="st">"#2E5090"</span>, <span class="st">"#C0392B"</span>, <span class="st">"#27AE60"</span>])</span>
<span id="cb26-1015"><a href="#cb26-1015" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.scale_y_continuous(labels<span class="op">=</span>percent_format())</span>
<span id="cb26-1016"><a href="#cb26-1016" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-1017"><a href="#cb26-1017" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"Year"</span>,</span>
<span id="cb26-1018"><a href="#cb26-1018" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Average First-Day Return"</span>,</span>
<span id="cb26-1019"><a href="#cb26-1019" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"IPO Underpricing by Allocation Mechanism"</span>,</span>
<span id="cb26-1020"><a href="#cb26-1020" aria-hidden="true" tabindex="-1"></a>        color<span class="op">=</span><span class="st">"Mechanism"</span>, size<span class="op">=</span><span class="st">"# IPOs"</span></span>
<span id="cb26-1021"><a href="#cb26-1021" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-1022"><a href="#cb26-1022" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-1023"><a href="#cb26-1023" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb26-1024"><a href="#cb26-1024" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1025"><a href="#cb26-1025" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1026"><a href="#cb26-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1027"><a href="#cb26-1027" aria-hidden="true" tabindex="-1"></a><span class="fu">### Counterfactual: Welfare Under Alternative Mechanisms</span></span>
<span id="cb26-1028"><a href="#cb26-1028" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1029"><a href="#cb26-1029" aria-hidden="true" tabindex="-1"></a>With the structural parameters $(\hat{\mu}, \hat{\sigma}_v)$ in hand, we can simulate counterfactual outcomes. For instance: if all Vietnamese IPOs used uniform-price auctions instead of book building, how would underpricing and welfare change?</span>
<span id="cb26-1030"><a href="#cb26-1030" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1033"><a href="#cb26-1033" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1034"><a href="#cb26-1034" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: counterfactual-ipo</span></span>
<span id="cb26-1035"><a href="#cb26-1035" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-1036"><a href="#cb26-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1037"><a href="#cb26-1037" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> simulate_ipo_mechanism(mu, sigma_v, mechanism<span class="op">=</span><span class="st">"book_building"</span>,</span>
<span id="cb26-1038"><a href="#cb26-1038" aria-hidden="true" tabindex="-1"></a>                           n_sim<span class="op">=</span><span class="dv">50000</span>):</span>
<span id="cb26-1039"><a href="#cb26-1039" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-1040"><a href="#cb26-1040" aria-hidden="true" tabindex="-1"></a><span class="co">    Simulate IPO outcomes under different mechanisms.</span></span>
<span id="cb26-1041"><a href="#cb26-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1042"><a href="#cb26-1042" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns issuer surplus, informed profit, uninformed profit.</span></span>
<span id="cb26-1043"><a href="#cb26-1043" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-1044"><a href="#cb26-1044" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">42</span>)</span>
<span id="cb26-1045"><a href="#cb26-1045" aria-hidden="true" tabindex="-1"></a>    v <span class="op">=</span> np.random.lognormal(mean<span class="op">=</span><span class="dv">0</span>, sigma<span class="op">=</span>sigma_v, size<span class="op">=</span>n_sim)</span>
<span id="cb26-1046"><a href="#cb26-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1047"><a href="#cb26-1047" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> mechanism <span class="op">==</span> <span class="st">"book_building"</span>:</span>
<span id="cb26-1048"><a href="#cb26-1048" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Price partially reveals information</span></span>
<span id="cb26-1049"><a href="#cb26-1049" aria-hidden="true" tabindex="-1"></a>        <span class="co"># P = E[v] + 0.5 * (v - E[v]) * signal_quality</span></span>
<span id="cb26-1050"><a href="#cb26-1050" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> v <span class="op">+</span> np.random.normal(<span class="dv">0</span>, sigma_v <span class="op">*</span> <span class="fl">0.5</span>, n_sim)</span>
<span id="cb26-1051"><a href="#cb26-1051" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> (signal <span class="op">-</span> np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>))</span>
<span id="cb26-1052"><a href="#cb26-1052" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> P.clip(<span class="bu">min</span><span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb26-1053"><a href="#cb26-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1054"><a href="#cb26-1054" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mechanism <span class="op">==</span> <span class="st">"auction"</span>:</span>
<span id="cb26-1055"><a href="#cb26-1055" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Competitive bidding: P closer to v</span></span>
<span id="cb26-1056"><a href="#cb26-1056" aria-hidden="true" tabindex="-1"></a>        noise <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma_v <span class="op">*</span> <span class="fl">0.3</span>, n_sim)</span>
<span id="cb26-1057"><a href="#cb26-1057" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> v <span class="op">+</span> noise</span>
<span id="cb26-1058"><a href="#cb26-1058" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> P.clip(<span class="bu">min</span><span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb26-1059"><a href="#cb26-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1060"><a href="#cb26-1060" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> mechanism <span class="op">==</span> <span class="st">"fixed_price"</span>:</span>
<span id="cb26-1061"><a href="#cb26-1061" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fixed at E[v] * discount</span></span>
<span id="cb26-1062"><a href="#cb26-1062" aria-hidden="true" tabindex="-1"></a>        P <span class="op">=</span> np.full(n_sim, np.exp(sigma_v<span class="op">**</span><span class="dv">2</span> <span class="op">/</span> <span class="dv">2</span>) <span class="op">*</span> <span class="fl">0.85</span>)</span>
<span id="cb26-1063"><a href="#cb26-1063" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1064"><a href="#cb26-1064" aria-hidden="true" tabindex="-1"></a>    underpricing <span class="op">=</span> (v <span class="op">-</span> P) <span class="op">/</span> P</span>
<span id="cb26-1065"><a href="#cb26-1065" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1066"><a href="#cb26-1066" aria-hidden="true" tabindex="-1"></a>    issuer_surplus <span class="op">=</span> P  <span class="co"># Revenue per share</span></span>
<span id="cb26-1067"><a href="#cb26-1067" aria-hidden="true" tabindex="-1"></a>    investor_surplus <span class="op">=</span> v <span class="op">-</span> P  <span class="co"># Profit per share</span></span>
<span id="cb26-1068"><a href="#cb26-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1069"><a href="#cb26-1069" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb26-1070"><a href="#cb26-1070" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mechanism"</span>: mechanism,</span>
<span id="cb26-1071"><a href="#cb26-1071" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mean_underpricing"</span>: underpricing.mean(),</span>
<span id="cb26-1072"><a href="#cb26-1072" aria-hidden="true" tabindex="-1"></a>        <span class="st">"median_underpricing"</span>: np.median(underpricing),</span>
<span id="cb26-1073"><a href="#cb26-1073" aria-hidden="true" tabindex="-1"></a>        <span class="st">"std_underpricing"</span>: underpricing.std(),</span>
<span id="cb26-1074"><a href="#cb26-1074" aria-hidden="true" tabindex="-1"></a>        <span class="st">"issuer_revenue"</span>: issuer_surplus.mean(),</span>
<span id="cb26-1075"><a href="#cb26-1075" aria-hidden="true" tabindex="-1"></a>        <span class="st">"investor_profit"</span>: investor_surplus.mean(),</span>
<span id="cb26-1076"><a href="#cb26-1076" aria-hidden="true" tabindex="-1"></a>        <span class="st">"money_left"</span>: (investor_surplus[investor_surplus <span class="op">&gt;</span> <span class="dv">0</span>]).<span class="bu">sum</span>() <span class="op">/</span> n_sim</span>
<span id="cb26-1077"><a href="#cb26-1077" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-1078"><a href="#cb26-1078" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1079"><a href="#cb26-1079" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare mechanisms</span></span>
<span id="cb26-1080"><a href="#cb26-1080" aria-hidden="true" tabindex="-1"></a>counterfactual <span class="op">=</span> pd.DataFrame([</span>
<span id="cb26-1081"><a href="#cb26-1081" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"book_building"</span>),</span>
<span id="cb26-1082"><a href="#cb26-1082" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"auction"</span>),</span>
<span id="cb26-1083"><a href="#cb26-1083" aria-hidden="true" tabindex="-1"></a>    simulate_ipo_mechanism(mu_hat, sigma_v_hat, <span class="st">"fixed_price"</span>)</span>
<span id="cb26-1084"><a href="#cb26-1084" aria-hidden="true" tabindex="-1"></a>]).set_index(<span class="st">"mechanism"</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb26-1085"><a href="#cb26-1085" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1086"><a href="#cb26-1086" aria-hidden="true" tabindex="-1"></a>counterfactual</span>
<span id="cb26-1087"><a href="#cb26-1087" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1088"><a href="#cb26-1088" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1089"><a href="#cb26-1089" aria-hidden="true" tabindex="-1"></a><span class="fu">## Limit Order Book Models</span></span>
<span id="cb26-1090"><a href="#cb26-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1091"><a href="#cb26-1091" aria-hidden="true" tabindex="-1"></a><span class="fu">### Order Submission as a Strategic Choice</span></span>
<span id="cb26-1092"><a href="#cb26-1092" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1093"><a href="#cb26-1093" aria-hidden="true" tabindex="-1"></a>In a limit order market, every trader faces a fundamental tradeoff: submit a market order (immediate execution, but at an adverse price) or a limit order (better price, but risk of non-execution). @parlour1998price models this as a sequential game where each trader's optimal strategy depends on the current state of the order book.</span>
<span id="cb26-1094"><a href="#cb26-1094" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1095"><a href="#cb26-1095" aria-hidden="true" tabindex="-1"></a>Let $a_t$ and $b_t$ denote the best ask and bid prices at time $t$, with the spread $s_t = a_t - b_t$. A buyer who arrives at time $t$ chooses between:</span>
<span id="cb26-1096"><a href="#cb26-1096" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1097"><a href="#cb26-1097" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Market buy**: Execute immediately at $a_t$. Cost: $a_t - v_t$ where $v_t$ is the true value.</span>
<span id="cb26-1098"><a href="#cb26-1098" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Limit buy at** $b_t$: Provides liquidity. If executed, profit: $v_t - b_t$. Probability of execution: $\pi(b_t, \text{book state})$.</span>
<span id="cb26-1099"><a href="#cb26-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1100"><a href="#cb26-1100" aria-hidden="true" tabindex="-1"></a>The buyer submits a market order if:</span>
<span id="cb26-1101"><a href="#cb26-1101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1102"><a href="#cb26-1102" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-1103"><a href="#cb26-1103" aria-hidden="true" tabindex="-1"></a>a_t - v_t &lt; (1 - \pi_t)(v_t - b_t) + \pi_t \cdot 0</span>
<span id="cb26-1104"><a href="#cb26-1104" aria-hidden="true" tabindex="-1"></a>$$ {#eq-order-choice}</span>
<span id="cb26-1105"><a href="#cb26-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1106"><a href="#cb26-1106" aria-hidden="true" tabindex="-1"></a>Rearranging: market orders are optimal when the spread is narrow relative to the non-execution risk of limit orders. This generates the empirically observed pattern that limit orders are more attractive when spreads are wide and the book is thin.</span>
<span id="cb26-1107"><a href="#cb26-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1108"><a href="#cb26-1108" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Glosten-Milgrom Model</span></span>
<span id="cb26-1109"><a href="#cb26-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1110"><a href="#cb26-1110" aria-hidden="true" tabindex="-1"></a>@glosten1985bid provide the foundational structural model of bid-ask spread determination under asymmetric information. A competitive market maker sets bid and ask prices to break even in expectation, recognizing that some trades come from informed traders.</span>
<span id="cb26-1111"><a href="#cb26-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1112"><a href="#cb26-1112" aria-hidden="true" tabindex="-1"></a>Let $\mu$ denote the probability that an incoming order is from an informed trader, and let $V^H$ and $V^L$ denote the high and low values of the asset ($\Pr(V = V^H) = p$). The zero-profit conditions yield:</span>
<span id="cb26-1113"><a href="#cb26-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1114"><a href="#cb26-1114" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-1115"><a href="#cb26-1115" aria-hidden="true" tabindex="-1"></a>a = E<span class="co">[</span><span class="ot">V \mid \text{buy order}</span><span class="co">]</span> = \frac{p(1-\mu) + p\mu}{(1-\mu) + p\mu} V^H + \frac{(1-p)(1-\mu)}{(1-\mu) + p\mu} V^L</span>
<span id="cb26-1116"><a href="#cb26-1116" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gm-ask}</span>
<span id="cb26-1117"><a href="#cb26-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1118"><a href="#cb26-1118" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-1119"><a href="#cb26-1119" aria-hidden="true" tabindex="-1"></a>b = E<span class="co">[</span><span class="ot">V \mid \text{sell order}</span><span class="co">]</span> = \frac{p(1-\mu)}{(1-\mu) + (1-p)\mu} V^H + \frac{(1-p)(1-\mu) + (1-p)\mu}{(1-\mu) + (1-p)\mu} V^L</span>
<span id="cb26-1120"><a href="#cb26-1120" aria-hidden="true" tabindex="-1"></a>$$ {#eq-gm-bid}</span>
<span id="cb26-1121"><a href="#cb26-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1122"><a href="#cb26-1122" aria-hidden="true" tabindex="-1"></a>The spread $s = a - b$ is positive whenever $\mu &gt; 0$, and increases in both the proportion of informed traders ($\mu$) and the information asymmetry ($V^H - V^L$). This decomposition is foundational: the spread compensates liquidity providers for the adverse selection cost of trading with informed counterparties.</span>
<span id="cb26-1123"><a href="#cb26-1123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1124"><a href="#cb26-1124" aria-hidden="true" tabindex="-1"></a><span class="fu">### PIN: Probability of Informed Trading</span></span>
<span id="cb26-1125"><a href="#cb26-1125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1126"><a href="#cb26-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1127"><a href="#cb26-1127" aria-hidden="true" tabindex="-1"></a>@easley1996liquidity extend the Glosten-Milgrom framework to a dynamic setting and develop the Probability of Informed Trading (PIN) measure, which can be estimated from trade data. The model assumes that on each trading day, an information event occurs with probability $\alpha$. Conditional on an event, it is bad news with probability $\delta$. Informed traders arrive at rate $\mu$; uninformed buyers and sellers arrive at rates $\varepsilon_b$ and $\varepsilon_s$, respectively.</span>
<span id="cb26-1128"><a href="#cb26-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1129"><a href="#cb26-1129" aria-hidden="true" tabindex="-1"></a>The likelihood of observing $B_t$ buys and $S_t$ sells on day $t$ is:</span>
<span id="cb26-1130"><a href="#cb26-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1131"><a href="#cb26-1131" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-1132"><a href="#cb26-1132" aria-hidden="true" tabindex="-1"></a>\mathcal{L}(B_t, S_t | \boldsymbol{\theta}) = (1-\alpha) f(B_t|\varepsilon_b) f(S_t|\varepsilon_s) + \alpha\delta \cdot f(B_t|\varepsilon_b) f(S_t|\varepsilon_s + \mu) + \alpha(1-\delta) \cdot f(B_t|\varepsilon_b + \mu) f(S_t|\varepsilon_s)</span>
<span id="cb26-1133"><a href="#cb26-1133" aria-hidden="true" tabindex="-1"></a>$$ {#eq-pin-likelihood}</span>
<span id="cb26-1134"><a href="#cb26-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1135"><a href="#cb26-1135" aria-hidden="true" tabindex="-1"></a>where $f(\cdot|\lambda)$ is the Poisson density with rate $\lambda$, and $\boldsymbol{\theta} = (\alpha, \delta, \mu, \varepsilon_b, \varepsilon_s)$. PIN is then:</span>
<span id="cb26-1136"><a href="#cb26-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1137"><a href="#cb26-1137" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb26-1138"><a href="#cb26-1138" aria-hidden="true" tabindex="-1"></a>\text{PIN} = \frac{\alpha \mu}{\alpha \mu + \varepsilon_b + \varepsilon_s}</span>
<span id="cb26-1139"><a href="#cb26-1139" aria-hidden="true" tabindex="-1"></a>$$ {#eq-pin}</span>
<span id="cb26-1140"><a href="#cb26-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1143"><a href="#cb26-1143" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1144"><a href="#cb26-1144" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pin-estimation</span></span>
<span id="cb26-1145"><a href="#cb26-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1146"><a href="#cb26-1146" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pin_log_likelihood(params, data):</span>
<span id="cb26-1147"><a href="#cb26-1147" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-1148"><a href="#cb26-1148" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute negative log-likelihood for the Easley-Kiefer-O'Hara-Paperman</span></span>
<span id="cb26-1149"><a href="#cb26-1149" aria-hidden="true" tabindex="-1"></a><span class="co">    (1996) PIN model.</span></span>
<span id="cb26-1150"><a href="#cb26-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1151"><a href="#cb26-1151" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb26-1152"><a href="#cb26-1152" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb26-1153"><a href="#cb26-1153" aria-hidden="true" tabindex="-1"></a><span class="co">    params : array</span></span>
<span id="cb26-1154"><a href="#cb26-1154" aria-hidden="true" tabindex="-1"></a><span class="co">        [alpha, delta, mu, eps_b, eps_s]</span></span>
<span id="cb26-1155"><a href="#cb26-1155" aria-hidden="true" tabindex="-1"></a><span class="co">    data : DataFrame</span></span>
<span id="cb26-1156"><a href="#cb26-1156" aria-hidden="true" tabindex="-1"></a><span class="co">        Columns: buys, sells (daily counts).</span></span>
<span id="cb26-1157"><a href="#cb26-1157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1158"><a href="#cb26-1158" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-1159"><a href="#cb26-1159" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-1160"><a href="#cb26-1160" aria-hidden="true" tabindex="-1"></a><span class="co">    float : Negative log-likelihood.</span></span>
<span id="cb26-1161"><a href="#cb26-1161" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-1162"><a href="#cb26-1162" aria-hidden="true" tabindex="-1"></a>    alpha, delta, mu, eps_b, eps_s <span class="op">=</span> params</span>
<span id="cb26-1163"><a href="#cb26-1163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1164"><a href="#cb26-1164" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parameter bounds</span></span>
<span id="cb26-1165"><a href="#cb26-1165" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (alpha <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> alpha <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">or</span> delta <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> delta <span class="op">&gt;</span> <span class="dv">1</span> <span class="kw">or</span></span>
<span id="cb26-1166"><a href="#cb26-1166" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> eps_b <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> eps_s <span class="op">&lt;</span> <span class="dv">0</span>):</span>
<span id="cb26-1167"><a href="#cb26-1167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fl">1e15</span></span>
<span id="cb26-1168"><a href="#cb26-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1169"><a href="#cb26-1169" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> data[<span class="st">"buys"</span>].values</span>
<span id="cb26-1170"><a href="#cb26-1170" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> data[<span class="st">"sells"</span>].values</span>
<span id="cb26-1171"><a href="#cb26-1171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1172"><a href="#cb26-1172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use log-sum-exp for numerical stability</span></span>
<span id="cb26-1173"><a href="#cb26-1173" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Three components: no event, bad news, good news</span></span>
<span id="cb26-1174"><a href="#cb26-1174" aria-hidden="true" tabindex="-1"></a>    log_L <span class="op">=</span> np.zeros(<span class="bu">len</span>(B))</span>
<span id="cb26-1175"><a href="#cb26-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1176"><a href="#cb26-1176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(B)):</span>
<span id="cb26-1177"><a href="#cb26-1177" aria-hidden="true" tabindex="-1"></a>        b, s <span class="op">=</span> B[i], S[i]</span>
<span id="cb26-1178"><a href="#cb26-1178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1179"><a href="#cb26-1179" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log-Poisson components</span></span>
<span id="cb26-1180"><a href="#cb26-1180" aria-hidden="true" tabindex="-1"></a>        <span class="kw">def</span> log_poisson(k, lam):</span>
<span id="cb26-1181"><a href="#cb26-1181" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> lam <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb26-1182"><a href="#cb26-1182" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="op">-</span><span class="fl">1e10</span> <span class="cf">if</span> k <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb26-1183"><a href="#cb26-1183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> k <span class="op">*</span> np.log(lam) <span class="op">-</span> lam <span class="op">-</span> np.<span class="bu">sum</span>(np.log(np.arange(<span class="dv">1</span>, k <span class="op">+</span> <span class="dv">1</span>)))</span>
<span id="cb26-1184"><a href="#cb26-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1185"><a href="#cb26-1185" aria-hidden="true" tabindex="-1"></a>        <span class="co"># No event</span></span>
<span id="cb26-1186"><a href="#cb26-1186" aria-hidden="true" tabindex="-1"></a>        c1 <span class="op">=</span> (np.log(<span class="dv">1</span> <span class="op">-</span> alpha <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb26-1187"><a href="#cb26-1187" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b) <span class="op">+</span> log_poisson(s, eps_s))</span>
<span id="cb26-1188"><a href="#cb26-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1189"><a href="#cb26-1189" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Bad news (extra sells)</span></span>
<span id="cb26-1190"><a href="#cb26-1190" aria-hidden="true" tabindex="-1"></a>        c2 <span class="op">=</span> (np.log(alpha <span class="op">*</span> delta <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb26-1191"><a href="#cb26-1191" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b) <span class="op">+</span> log_poisson(s, eps_s <span class="op">+</span> mu))</span>
<span id="cb26-1192"><a href="#cb26-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1193"><a href="#cb26-1193" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Good news (extra buys)</span></span>
<span id="cb26-1194"><a href="#cb26-1194" aria-hidden="true" tabindex="-1"></a>        c3 <span class="op">=</span> (np.log(alpha <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> delta) <span class="op">+</span> <span class="fl">1e-15</span>) <span class="op">+</span></span>
<span id="cb26-1195"><a href="#cb26-1195" aria-hidden="true" tabindex="-1"></a>              log_poisson(b, eps_b <span class="op">+</span> mu) <span class="op">+</span> log_poisson(s, eps_s))</span>
<span id="cb26-1196"><a href="#cb26-1196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1197"><a href="#cb26-1197" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log-sum-exp</span></span>
<span id="cb26-1198"><a href="#cb26-1198" aria-hidden="true" tabindex="-1"></a>        max_c <span class="op">=</span> <span class="bu">max</span>(c1, c2, c3)</span>
<span id="cb26-1199"><a href="#cb26-1199" aria-hidden="true" tabindex="-1"></a>        log_L[i] <span class="op">=</span> max_c <span class="op">+</span> np.log(</span>
<span id="cb26-1200"><a href="#cb26-1200" aria-hidden="true" tabindex="-1"></a>            np.exp(c1 <span class="op">-</span> max_c) <span class="op">+</span> np.exp(c2 <span class="op">-</span> max_c) <span class="op">+</span> np.exp(c3 <span class="op">-</span> max_c)</span>
<span id="cb26-1201"><a href="#cb26-1201" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-1202"><a href="#cb26-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1203"><a href="#cb26-1203" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>np.<span class="bu">sum</span>(log_L)</span>
<span id="cb26-1204"><a href="#cb26-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1205"><a href="#cb26-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1206"><a href="#cb26-1206" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_pin(buys, sells, n_starts<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb26-1207"><a href="#cb26-1207" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb26-1208"><a href="#cb26-1208" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimate PIN via MLE with multiple random starts.</span></span>
<span id="cb26-1209"><a href="#cb26-1209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1210"><a href="#cb26-1210" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb26-1211"><a href="#cb26-1211" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb26-1212"><a href="#cb26-1212" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Estimated parameters and PIN value.</span></span>
<span id="cb26-1213"><a href="#cb26-1213" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb26-1214"><a href="#cb26-1214" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pd.DataFrame({<span class="st">"buys"</span>: buys, <span class="st">"sells"</span>: sells})</span>
<span id="cb26-1215"><a href="#cb26-1215" aria-hidden="true" tabindex="-1"></a>    best_result <span class="op">=</span> <span class="va">None</span></span>
<span id="cb26-1216"><a href="#cb26-1216" aria-hidden="true" tabindex="-1"></a>    best_nll <span class="op">=</span> np.inf</span>
<span id="cb26-1217"><a href="#cb26-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1218"><a href="#cb26-1218" aria-hidden="true" tabindex="-1"></a>    avg_b <span class="op">=</span> data[<span class="st">"buys"</span>].mean()</span>
<span id="cb26-1219"><a href="#cb26-1219" aria-hidden="true" tabindex="-1"></a>    avg_s <span class="op">=</span> data[<span class="st">"sells"</span>].mean()</span>
<span id="cb26-1220"><a href="#cb26-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1221"><a href="#cb26-1221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(n_starts):</span>
<span id="cb26-1222"><a href="#cb26-1222" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Random initial values</span></span>
<span id="cb26-1223"><a href="#cb26-1223" aria-hidden="true" tabindex="-1"></a>        alpha0 <span class="op">=</span> np.random.uniform(<span class="fl">0.1</span>, <span class="fl">0.8</span>)</span>
<span id="cb26-1224"><a href="#cb26-1224" aria-hidden="true" tabindex="-1"></a>        delta0 <span class="op">=</span> np.random.uniform(<span class="fl">0.2</span>, <span class="fl">0.8</span>)</span>
<span id="cb26-1225"><a href="#cb26-1225" aria-hidden="true" tabindex="-1"></a>        mu0 <span class="op">=</span> np.random.uniform(<span class="dv">0</span>, <span class="bu">max</span>(avg_b, avg_s))</span>
<span id="cb26-1226"><a href="#cb26-1226" aria-hidden="true" tabindex="-1"></a>        eps_b0 <span class="op">=</span> avg_b <span class="op">*</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb26-1227"><a href="#cb26-1227" aria-hidden="true" tabindex="-1"></a>        eps_s0 <span class="op">=</span> avg_s <span class="op">*</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb26-1228"><a href="#cb26-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1229"><a href="#cb26-1229" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb26-1230"><a href="#cb26-1230" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> minimize(</span>
<span id="cb26-1231"><a href="#cb26-1231" aria-hidden="true" tabindex="-1"></a>                pin_log_likelihood,</span>
<span id="cb26-1232"><a href="#cb26-1232" aria-hidden="true" tabindex="-1"></a>                x0<span class="op">=</span>[alpha0, delta0, mu0, eps_b0, eps_s0],</span>
<span id="cb26-1233"><a href="#cb26-1233" aria-hidden="true" tabindex="-1"></a>                args<span class="op">=</span>(data,),</span>
<span id="cb26-1234"><a href="#cb26-1234" aria-hidden="true" tabindex="-1"></a>                method<span class="op">=</span><span class="st">"L-BFGS-B"</span>,</span>
<span id="cb26-1235"><a href="#cb26-1235" aria-hidden="true" tabindex="-1"></a>                bounds<span class="op">=</span>[(<span class="fl">0.01</span>, <span class="fl">0.99</span>), (<span class="fl">0.01</span>, <span class="fl">0.99</span>),</span>
<span id="cb26-1236"><a href="#cb26-1236" aria-hidden="true" tabindex="-1"></a>                        (<span class="fl">0.01</span>, <span class="va">None</span>), (<span class="fl">0.01</span>, <span class="va">None</span>), (<span class="fl">0.01</span>, <span class="va">None</span>)],</span>
<span id="cb26-1237"><a href="#cb26-1237" aria-hidden="true" tabindex="-1"></a>                options<span class="op">=</span>{<span class="st">"maxiter"</span>: <span class="dv">1000</span>}</span>
<span id="cb26-1238"><a href="#cb26-1238" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb26-1239"><a href="#cb26-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1240"><a href="#cb26-1240" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> result.fun <span class="op">&lt;</span> best_nll:</span>
<span id="cb26-1241"><a href="#cb26-1241" aria-hidden="true" tabindex="-1"></a>                best_nll <span class="op">=</span> result.fun</span>
<span id="cb26-1242"><a href="#cb26-1242" aria-hidden="true" tabindex="-1"></a>                best_result <span class="op">=</span> result</span>
<span id="cb26-1243"><a href="#cb26-1243" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb26-1244"><a href="#cb26-1244" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb26-1245"><a href="#cb26-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1246"><a href="#cb26-1246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> best_result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb26-1247"><a href="#cb26-1247" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"pin"</span>: np.nan}</span>
<span id="cb26-1248"><a href="#cb26-1248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1249"><a href="#cb26-1249" aria-hidden="true" tabindex="-1"></a>    alpha, delta, mu, eps_b, eps_s <span class="op">=</span> best_result.x</span>
<span id="cb26-1250"><a href="#cb26-1250" aria-hidden="true" tabindex="-1"></a>    pin <span class="op">=</span> alpha <span class="op">*</span> mu <span class="op">/</span> (alpha <span class="op">*</span> mu <span class="op">+</span> eps_b <span class="op">+</span> eps_s)</span>
<span id="cb26-1251"><a href="#cb26-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1252"><a href="#cb26-1252" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb26-1253"><a href="#cb26-1253" aria-hidden="true" tabindex="-1"></a>        <span class="st">"alpha"</span>: alpha,</span>
<span id="cb26-1254"><a href="#cb26-1254" aria-hidden="true" tabindex="-1"></a>        <span class="st">"delta"</span>: delta,</span>
<span id="cb26-1255"><a href="#cb26-1255" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mu"</span>: mu,</span>
<span id="cb26-1256"><a href="#cb26-1256" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eps_b"</span>: eps_b,</span>
<span id="cb26-1257"><a href="#cb26-1257" aria-hidden="true" tabindex="-1"></a>        <span class="st">"eps_s"</span>: eps_s,</span>
<span id="cb26-1258"><a href="#cb26-1258" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pin"</span>: pin,</span>
<span id="cb26-1259"><a href="#cb26-1259" aria-hidden="true" tabindex="-1"></a>        <span class="st">"log_likelihood"</span>: <span class="op">-</span>best_nll</span>
<span id="cb26-1260"><a href="#cb26-1260" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-1261"><a href="#cb26-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1262"><a href="#cb26-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1265"><a href="#cb26-1265" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1266"><a href="#cb26-1266" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pin-cross-section</span></span>
<span id="cb26-1267"><a href="#cb26-1267" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-1268"><a href="#cb26-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1269"><a href="#cb26-1269" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate PIN for a cross-section of stocks</span></span>
<span id="cb26-1270"><a href="#cb26-1270" aria-hidden="true" tabindex="-1"></a><span class="co"># Using daily buy/sell counts from Lee-Ready classification</span></span>
<span id="cb26-1271"><a href="#cb26-1271" aria-hidden="true" tabindex="-1"></a>trade_counts <span class="op">=</span> dc.get_trade_counts(</span>
<span id="cb26-1272"><a href="#cb26-1272" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb26-1273"><a href="#cb26-1273" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2023-12-31"</span></span>
<span id="cb26-1274"><a href="#cb26-1274" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1275"><a href="#cb26-1275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1276"><a href="#cb26-1276" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample of stocks for estimation (PIN is computationally intensive)</span></span>
<span id="cb26-1277"><a href="#cb26-1277" aria-hidden="true" tabindex="-1"></a>top_stocks <span class="op">=</span> (</span>
<span id="cb26-1278"><a href="#cb26-1278" aria-hidden="true" tabindex="-1"></a>    trade_counts.groupby(<span class="st">"ticker"</span>)</span>
<span id="cb26-1279"><a href="#cb26-1279" aria-hidden="true" tabindex="-1"></a>    .agg(n_days<span class="op">=</span>(<span class="st">"date"</span>, <span class="st">"nunique"</span>))</span>
<span id="cb26-1280"><a href="#cb26-1280" aria-hidden="true" tabindex="-1"></a>    .query(<span class="st">"n_days &gt;= 200"</span>)</span>
<span id="cb26-1281"><a href="#cb26-1281" aria-hidden="true" tabindex="-1"></a>    .index[:<span class="dv">50</span>]</span>
<span id="cb26-1282"><a href="#cb26-1282" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1283"><a href="#cb26-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1284"><a href="#cb26-1284" aria-hidden="true" tabindex="-1"></a>pin_estimates <span class="op">=</span> []</span>
<span id="cb26-1285"><a href="#cb26-1285" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ticker <span class="kw">in</span> top_stocks:</span>
<span id="cb26-1286"><a href="#cb26-1286" aria-hidden="true" tabindex="-1"></a>    stock_data <span class="op">=</span> trade_counts[trade_counts[<span class="st">"ticker"</span>] <span class="op">==</span> ticker]</span>
<span id="cb26-1287"><a href="#cb26-1287" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> estimate_pin(</span>
<span id="cb26-1288"><a href="#cb26-1288" aria-hidden="true" tabindex="-1"></a>        stock_data[<span class="st">"buys"</span>].values,</span>
<span id="cb26-1289"><a href="#cb26-1289" aria-hidden="true" tabindex="-1"></a>        stock_data[<span class="st">"sells"</span>].values,</span>
<span id="cb26-1290"><a href="#cb26-1290" aria-hidden="true" tabindex="-1"></a>        n_starts<span class="op">=</span><span class="dv">5</span></span>
<span id="cb26-1291"><a href="#cb26-1291" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-1292"><a href="#cb26-1292" aria-hidden="true" tabindex="-1"></a>    result[<span class="st">"ticker"</span>] <span class="op">=</span> ticker</span>
<span id="cb26-1293"><a href="#cb26-1293" aria-hidden="true" tabindex="-1"></a>    pin_estimates.append(result)</span>
<span id="cb26-1294"><a href="#cb26-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1295"><a href="#cb26-1295" aria-hidden="true" tabindex="-1"></a>pin_df <span class="op">=</span> pd.DataFrame(pin_estimates).dropna(subset<span class="op">=</span>[<span class="st">"pin"</span>])</span>
<span id="cb26-1296"><a href="#cb26-1296" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"PIN estimates for </span><span class="sc">{</span><span class="bu">len</span>(pin_df)<span class="sc">}</span><span class="ss"> stocks"</span>)</span>
<span id="cb26-1297"><a href="#cb26-1297" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Mean PIN: </span><span class="sc">{</span>pin_df[<span class="st">'pin'</span>]<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb26-1298"><a href="#cb26-1298" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Median PIN: </span><span class="sc">{</span>pin_df[<span class="st">'pin'</span>]<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb26-1299"><a href="#cb26-1299" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1300"><a href="#cb26-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1303"><a href="#cb26-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1304"><a href="#cb26-1304" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-pin-distribution</span></span>
<span id="cb26-1305"><a href="#cb26-1305" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-1306"><a href="#cb26-1306" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cross-Sectional Distribution of Probability of Informed Trading (PIN)"</span></span>
<span id="cb26-1307"><a href="#cb26-1307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1308"><a href="#cb26-1308" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb26-1309"><a href="#cb26-1309" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(pin_df, p9.aes(x<span class="op">=</span><span class="st">"pin"</span>))</span>
<span id="cb26-1310"><a href="#cb26-1310" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_histogram(bins<span class="op">=</span><span class="dv">25</span>, fill<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb26-1311"><a href="#cb26-1311" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_vline(</span>
<span id="cb26-1312"><a href="#cb26-1312" aria-hidden="true" tabindex="-1"></a>        xintercept<span class="op">=</span>pin_df[<span class="st">"pin"</span>].median(),</span>
<span id="cb26-1313"><a href="#cb26-1313" aria-hidden="true" tabindex="-1"></a>        linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, size<span class="op">=</span><span class="fl">0.8</span></span>
<span id="cb26-1314"><a href="#cb26-1314" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-1315"><a href="#cb26-1315" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb26-1316"><a href="#cb26-1316" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"PIN"</span>,</span>
<span id="cb26-1317"><a href="#cb26-1317" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"Count"</span>,</span>
<span id="cb26-1318"><a href="#cb26-1318" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Distribution of Informed Trading Probability"</span></span>
<span id="cb26-1319"><a href="#cb26-1319" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb26-1320"><a href="#cb26-1320" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb26-1321"><a href="#cb26-1321" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb26-1322"><a href="#cb26-1322" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1323"><a href="#cb26-1323" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1324"><a href="#cb26-1324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1325"><a href="#cb26-1325" aria-hidden="true" tabindex="-1"></a><span class="fu">### PIN and Asset Pricing</span></span>
<span id="cb26-1326"><a href="#cb26-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1327"><a href="#cb26-1327" aria-hidden="true" tabindex="-1"></a>@easley2002information argue that PIN should be priced in the cross-section of expected returns: stocks with higher information asymmetry require a risk premium to compensate uninformed investors. We test this prediction using Fama-MacBeth regressions.</span>
<span id="cb26-1328"><a href="#cb26-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1331"><a href="#cb26-1331" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1332"><a href="#cb26-1332" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pin-asset-pricing</span></span>
<span id="cb26-1333"><a href="#cb26-1333" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb26-1334"><a href="#cb26-1334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1335"><a href="#cb26-1335" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge PIN with firm characteristics and forward returns</span></span>
<span id="cb26-1336"><a href="#cb26-1336" aria-hidden="true" tabindex="-1"></a>pin_chars <span class="op">=</span> pin_df[[<span class="st">"ticker"</span>, <span class="st">"pin"</span>]].merge(</span>
<span id="cb26-1337"><a href="#cb26-1337" aria-hidden="true" tabindex="-1"></a>    dc.get_firm_characteristics(</span>
<span id="cb26-1338"><a href="#cb26-1338" aria-hidden="true" tabindex="-1"></a>        start_date<span class="op">=</span><span class="st">"2023-01-01"</span>,</span>
<span id="cb26-1339"><a href="#cb26-1339" aria-hidden="true" tabindex="-1"></a>        end_date<span class="op">=</span><span class="st">"2023-12-31"</span></span>
<span id="cb26-1340"><a href="#cb26-1340" aria-hidden="true" tabindex="-1"></a>    ).groupby(<span class="st">"ticker"</span>).last().reset_index()[</span>
<span id="cb26-1341"><a href="#cb26-1341" aria-hidden="true" tabindex="-1"></a>        [<span class="st">"ticker"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]</span>
<span id="cb26-1342"><a href="#cb26-1342" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb26-1343"><a href="#cb26-1343" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>,</span>
<span id="cb26-1344"><a href="#cb26-1344" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb26-1345"><a href="#cb26-1345" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1346"><a href="#cb26-1346" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1347"><a href="#cb26-1347" aria-hidden="true" tabindex="-1"></a><span class="co"># Forward 12-month returns (2024)</span></span>
<span id="cb26-1348"><a href="#cb26-1348" aria-hidden="true" tabindex="-1"></a>forward_returns <span class="op">=</span> dc.get_annual_returns(</span>
<span id="cb26-1349"><a href="#cb26-1349" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2024-01-01"</span>,</span>
<span id="cb26-1350"><a href="#cb26-1350" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb26-1351"><a href="#cb26-1351" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1352"><a href="#cb26-1352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1353"><a href="#cb26-1353" aria-hidden="true" tabindex="-1"></a>pin_returns <span class="op">=</span> pin_chars.merge(</span>
<span id="cb26-1354"><a href="#cb26-1354" aria-hidden="true" tabindex="-1"></a>    forward_returns[[<span class="st">"ticker"</span>, <span class="st">"annual_ret"</span>]],</span>
<span id="cb26-1355"><a href="#cb26-1355" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"ticker"</span>,</span>
<span id="cb26-1356"><a href="#cb26-1356" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb26-1357"><a href="#cb26-1357" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-1358"><a href="#cb26-1358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1359"><a href="#cb26-1359" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression</span></span>
<span id="cb26-1360"><a href="#cb26-1360" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(pin_returns) <span class="op">&gt;</span> <span class="dv">20</span>:</span>
<span id="cb26-1361"><a href="#cb26-1361" aria-hidden="true" tabindex="-1"></a>    cs_model <span class="op">=</span> sm.OLS(</span>
<span id="cb26-1362"><a href="#cb26-1362" aria-hidden="true" tabindex="-1"></a>        pin_returns[<span class="st">"annual_ret"</span>],</span>
<span id="cb26-1363"><a href="#cb26-1363" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(</span>
<span id="cb26-1364"><a href="#cb26-1364" aria-hidden="true" tabindex="-1"></a>            pin_returns[[<span class="st">"pin"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]]</span>
<span id="cb26-1365"><a href="#cb26-1365" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb26-1366"><a href="#cb26-1366" aria-hidden="true" tabindex="-1"></a>    ).fit(cov_type<span class="op">=</span><span class="st">"HC1"</span>)</span>
<span id="cb26-1367"><a href="#cb26-1367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1368"><a href="#cb26-1368" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Cross-Sectional Return Regression with PIN:"</span>)</span>
<span id="cb26-1369"><a href="#cb26-1369" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> var <span class="kw">in</span> [<span class="st">"pin"</span>, <span class="st">"log_size"</span>, <span class="st">"book_to_market"</span>, <span class="st">"momentum_12m"</span>]:</span>
<span id="cb26-1370"><a href="#cb26-1370" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>cs_model<span class="sc">.</span>params[var]<span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb26-1371"><a href="#cb26-1371" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"(t = </span><span class="sc">{</span>cs_model<span class="sc">.</span>tvalues[var]<span class="sc">:.3f}</span><span class="ss">)"</span>)</span>
<span id="cb26-1372"><a href="#cb26-1372" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1373"><a href="#cb26-1373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1374"><a href="#cb26-1374" aria-hidden="true" tabindex="-1"></a><span class="fu">### Estimation Challenges in Limit Order Book Models</span></span>
<span id="cb26-1375"><a href="#cb26-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1376"><a href="#cb26-1376" aria-hidden="true" tabindex="-1"></a>Structural estimation of limit order book models faces several challenges specific to Vietnamese markets:</span>
<span id="cb26-1377"><a href="#cb26-1377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1378"><a href="#cb26-1378" aria-hidden="true" tabindex="-1"></a>**Tick size effects.** Vietnamese exchanges use discrete tick sizes that vary with price level. At low prices, the minimum tick size represents a large fraction of the price, artificially widening the spread and distorting the structural parameters. The standard Glosten-Milgrom and PIN models assume continuous prices; adapting them to discrete price grids requires the modifications proposed by @bollen2004modeling.</span>
<span id="cb26-1379"><a href="#cb26-1379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1380"><a href="#cb26-1380" aria-hidden="true" tabindex="-1"></a>**Price limits.** When a stock hits its price limit, the order book is effectively frozen at one side. Orders accumulate but cannot execute until the limit is lifted. This creates a censoring problem analogous to the price limit censoring in return distributions: the observed order flow is a truncated version of the latent flow.</span>
<span id="cb26-1381"><a href="#cb26-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1382"><a href="#cb26-1382" aria-hidden="true" tabindex="-1"></a>**Missing data.** Full order book snapshots at high frequency are not universally available for Vietnamese stocks. PIN estimation requires only daily buy/sell counts, making it feasible with lower-frequency data. But richer models (@foucault1999order dynamic limit order book, @rocsu2009dynamic continuous-time model) require tick-by-tick order book data that may be unavailable for smaller stocks.</span>
<span id="cb26-1383"><a href="#cb26-1383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1384"><a href="#cb26-1384" aria-hidden="true" tabindex="-1"></a>**Institutional features.** The coexistence of HOSE (continuous auction) and HNX (with periodic call auctions for less liquid stocks) creates heterogeneity in the appropriate structural model. A model estimated on HOSE continuous trading data does not directly apply to HNX call auction stocks.</span>
<span id="cb26-1385"><a href="#cb26-1385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1386"><a href="#cb26-1386" aria-hidden="true" tabindex="-1"></a><span class="fu">## When Structural Models Are Worth It</span></span>
<span id="cb26-1387"><a href="#cb26-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1388"><a href="#cb26-1388" aria-hidden="true" tabindex="-1"></a><span class="fu">### Decision Framework</span></span>
<span id="cb26-1389"><a href="#cb26-1389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1390"><a href="#cb26-1390" aria-hidden="true" tabindex="-1"></a>Structural estimation is not always the right tool. The additional complexity, data requirements, and model risk must be justified by the research question. @tbl-when-structural provides a decision framework.</span>
<span id="cb26-1391"><a href="#cb26-1391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1392"><a href="#cb26-1392" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Criterion <span class="pp">|</span> Structural Preferred <span class="pp">|</span> Reduced Form Preferred <span class="pp">|</span></span>
<span id="cb26-1393"><a href="#cb26-1393" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|---------------------------|----------------------------|</span></span>
<span id="cb26-1394"><a href="#cb26-1394" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Research question <span class="pp">|</span> Counterfactual or policy evaluation <span class="pp">|</span> Causal effect of observed variation <span class="pp">|</span></span>
<span id="cb26-1395"><a href="#cb26-1395" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Data availability <span class="pp">|</span> Rich micro-data (transactions, holdings) <span class="pp">|</span> Standard panel (returns, fundamentals) <span class="pp">|</span></span>
<span id="cb26-1396"><a href="#cb26-1396" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Institutional environment <span class="pp">|</span> Stable (model assumptions plausible) <span class="pp">|</span> Rapidly changing (model may be misspecified) <span class="pp">|</span></span>
<span id="cb26-1397"><a href="#cb26-1397" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Number of parameters <span class="pp">|</span> Few primitives, many observables <span class="pp">|</span> Many parameters, few identifying assumptions <span class="pp">|</span></span>
<span id="cb26-1398"><a href="#cb26-1398" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Publication venue <span class="pp">|</span> JF, RFS, Econometrica, JPE <span class="pp">|</span> JFE, RFS, MS, JFQA <span class="pp">|</span></span>
<span id="cb26-1399"><a href="#cb26-1399" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Computational budget <span class="pp">|</span> Weeks to months of estimation <span class="pp">|</span> Hours to days <span class="pp">|</span></span>
<span id="cb26-1400"><a href="#cb26-1400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1401"><a href="#cb26-1401" aria-hidden="true" tabindex="-1"></a>: When to Choose Structural vs. Reduced Form {#tbl-when-structural}</span>
<span id="cb26-1402"><a href="#cb26-1402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1403"><a href="#cb26-1403" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Requirements</span></span>
<span id="cb26-1404"><a href="#cb26-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1405"><a href="#cb26-1405" aria-hidden="true" tabindex="-1"></a>Structural models are data-hungry. @tbl-data-requirements summarizes the minimum data needs for each model class covered in this chapter.</span>
<span id="cb26-1406"><a href="#cb26-1406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1407"><a href="#cb26-1407" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Model <span class="pp">|</span> Minimum Data <span class="pp">|</span> Ideal Data <span class="pp">|</span> Vietnamese Availability <span class="pp">|</span></span>
<span id="cb26-1408"><a href="#cb26-1408" aria-hidden="true" tabindex="-1"></a><span class="pp">|----------------|----------------|----------------|-------------------------|</span></span>
<span id="cb26-1409"><a href="#cb26-1409" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> KY demand system <span class="pp">|</span> Quarterly institutional holdings + prices <span class="pp">|</span> 13F-equivalent filings + fund flows <span class="pp">|</span> Partial (semi-annual disclosure) <span class="pp">|</span></span>
<span id="cb26-1410"><a href="#cb26-1410" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Almgren-Chriss <span class="pp">|</span> Daily volume, spread, volatility <span class="pp">|</span> Intraday order-by-order data <span class="pp">|</span> Good (HOSE provides) <span class="pp">|</span></span>
<span id="cb26-1411"><a href="#cb26-1411" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Rock/IPO <span class="pp">|</span> Offer price, first-day close, allocation <span class="pp">|</span> Investor-level bids and allocations <span class="pp">|</span> Limited (auction data available) <span class="pp">|</span></span>
<span id="cb26-1412"><a href="#cb26-1412" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> PIN <span class="pp">|</span> Daily buy/sell counts (Lee-Ready) <span class="pp">|</span> Tick-by-tick trade and quote <span class="pp">|</span> Moderate (requires trade classification) <span class="pp">|</span></span>
<span id="cb26-1413"><a href="#cb26-1413" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Glosten-Milgrom <span class="pp">|</span> Best bid/ask, trade direction <span class="pp">|</span> Full order book snapshots <span class="pp">|</span> Moderate (top-of-book available) <span class="pp">|</span></span>
<span id="cb26-1414"><a href="#cb26-1414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1415"><a href="#cb26-1415" aria-hidden="true" tabindex="-1"></a>: Data Requirements for Structural Estimation {#tbl-data-requirements}</span>
<span id="cb26-1416"><a href="#cb26-1416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1417"><a href="#cb26-1417" aria-hidden="true" tabindex="-1"></a><span class="fu">### Computational Cost</span></span>
<span id="cb26-1418"><a href="#cb26-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1419"><a href="#cb26-1419" aria-hidden="true" tabindex="-1"></a>Structural estimation is orders of magnitude more expensive than reduced-form regression. The cost arises from three sources:</span>
<span id="cb26-1420"><a href="#cb26-1420" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1421"><a href="#cb26-1421" aria-hidden="true" tabindex="-1"></a>**Likelihood evaluation.** Each evaluation of the structural likelihood or moment function requires solving the model for given parameters. For dynamic models (e.g., inventory models, dynamic discrete choice), this involves solving a dynamic programming problem at each iteration.</span>
<span id="cb26-1422"><a href="#cb26-1422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1423"><a href="#cb26-1423" aria-hidden="true" tabindex="-1"></a>**Optimization.** The GMM or MLE objective is typically non-convex, requiring multiple starting points and global optimization algorithms. The PIN model with 5 parameters requires $\sim 10$ random starts; a richer model with $\sim 20$ parameters might require hundreds.</span>
<span id="cb26-1424"><a href="#cb26-1424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1425"><a href="#cb26-1425" aria-hidden="true" tabindex="-1"></a>**Inference.** Standard errors for structural parameters often require bootstrapping (because the asymptotic distribution is non-standard or the delta method is unreliable), adding a multiplicative factor of 200--1000 to the computational budget.</span>
<span id="cb26-1426"><a href="#cb26-1426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1429"><a href="#cb26-1429" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb26-1430"><a href="#cb26-1430" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: computational-cost-comparison</span></span>
<span id="cb26-1431"><a href="#cb26-1431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1432"><a href="#cb26-1432" aria-hidden="true" tabindex="-1"></a><span class="co"># Illustration: computational cost comparison</span></span>
<span id="cb26-1433"><a href="#cb26-1433" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb26-1434"><a href="#cb26-1434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1435"><a href="#cb26-1435" aria-hidden="true" tabindex="-1"></a><span class="co"># Reduced form: OLS regression</span></span>
<span id="cb26-1436"><a href="#cb26-1436" aria-hidden="true" tabindex="-1"></a>n_obs <span class="op">=</span> <span class="dv">100000</span></span>
<span id="cb26-1437"><a href="#cb26-1437" aria-hidden="true" tabindex="-1"></a>X_sim <span class="op">=</span> np.random.randn(n_obs, <span class="dv">5</span>)</span>
<span id="cb26-1438"><a href="#cb26-1438" aria-hidden="true" tabindex="-1"></a>y_sim <span class="op">=</span> X_sim <span class="op">@</span> np.random.randn(<span class="dv">5</span>) <span class="op">+</span> np.random.randn(n_obs)</span>
<span id="cb26-1439"><a href="#cb26-1439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1440"><a href="#cb26-1440" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb26-1441"><a href="#cb26-1441" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">100</span>):</span>
<span id="cb26-1442"><a href="#cb26-1442" aria-hidden="true" tabindex="-1"></a>    sm.OLS(y_sim, sm.add_constant(X_sim)).fit()</span>
<span id="cb26-1443"><a href="#cb26-1443" aria-hidden="true" tabindex="-1"></a>ols_time <span class="op">=</span> (time.time() <span class="op">-</span> start) <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb26-1444"><a href="#cb26-1444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1445"><a href="#cb26-1445" aria-hidden="true" tabindex="-1"></a><span class="co"># Structural: PIN estimation (single stock)</span></span>
<span id="cb26-1446"><a href="#cb26-1446" aria-hidden="true" tabindex="-1"></a>sim_buys <span class="op">=</span> np.random.poisson(<span class="dv">50</span>, <span class="dv">250</span>)</span>
<span id="cb26-1447"><a href="#cb26-1447" aria-hidden="true" tabindex="-1"></a>sim_sells <span class="op">=</span> np.random.poisson(<span class="dv">45</span>, <span class="dv">250</span>)</span>
<span id="cb26-1448"><a href="#cb26-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1449"><a href="#cb26-1449" aria-hidden="true" tabindex="-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb26-1450"><a href="#cb26-1450" aria-hidden="true" tabindex="-1"></a>pin_result <span class="op">=</span> estimate_pin(sim_buys, sim_sells, n_starts<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb26-1451"><a href="#cb26-1451" aria-hidden="true" tabindex="-1"></a>pin_time <span class="op">=</span> time.time() <span class="op">-</span> start</span>
<span id="cb26-1452"><a href="#cb26-1452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1453"><a href="#cb26-1453" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Computational Cost Comparison:"</span>)</span>
<span id="cb26-1454"><a href="#cb26-1454" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  OLS (100k obs): </span><span class="sc">{</span>ols_time<span class="op">*</span><span class="dv">1000</span><span class="sc">:.1f}</span><span class="ss"> ms per estimation"</span>)</span>
<span id="cb26-1455"><a href="#cb26-1455" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  PIN (250 days, 5 starts): </span><span class="sc">{</span>pin_time<span class="sc">:.1f}</span><span class="ss"> s per stock"</span>)</span>
<span id="cb26-1456"><a href="#cb26-1456" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Ratio: </span><span class="sc">{</span>pin_time <span class="op">/</span> ols_time<span class="sc">:.0f}</span><span class="ss">x"</span>)</span>
<span id="cb26-1457"><a href="#cb26-1457" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb26-1458"><a href="#cb26-1458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1459"><a href="#cb26-1459" aria-hidden="true" tabindex="-1"></a><span class="fu">### Interpretation Risks</span></span>
<span id="cb26-1460"><a href="#cb26-1460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1461"><a href="#cb26-1461" aria-hidden="true" tabindex="-1"></a>The primary risk of structural estimation is model misspecification. If the model is wrong, the estimated parameters have no economic meaning and the counterfactual predictions are unreliable. Several strategies mitigate this risk:</span>
<span id="cb26-1462"><a href="#cb26-1462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1463"><a href="#cb26-1463" aria-hidden="true" tabindex="-1"></a>**Specification tests.** Over-identifying restrictions (more moments than parameters) provide the Hansen $J$-test for model fit. A rejection suggests misspecification, though the test has low power in small samples.</span>
<span id="cb26-1464"><a href="#cb26-1464" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1465"><a href="#cb26-1465" aria-hidden="true" tabindex="-1"></a>**Model comparison.** Estimate multiple nested or non-nested models and compare fit. If a simpler model fits the data equally well, prefer it (Occam's razor).</span>
<span id="cb26-1466"><a href="#cb26-1466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1467"><a href="#cb26-1467" aria-hidden="true" tabindex="-1"></a>**Sensitivity analysis.** Report how structural parameters change under plausible alternative assumptions (e.g., different functional forms for the impact function, different distributional assumptions for valuations).</span>
<span id="cb26-1468"><a href="#cb26-1468" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1469"><a href="#cb26-1469" aria-hidden="true" tabindex="-1"></a>**Out-of-sample validation.** Estimate the model on one sample period and test its predictions on a holdout sample. Structural models that fit in-sample but fail out-of-sample are likely overfit.</span>
<span id="cb26-1470"><a href="#cb26-1470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1471"><a href="#cb26-1471" aria-hidden="true" tabindex="-1"></a><span class="fu">### Journal Expectations</span></span>
<span id="cb26-1472"><a href="#cb26-1472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1473"><a href="#cb26-1473" aria-hidden="true" tabindex="-1"></a>Structural papers in top finance journals are held to specific standards:</span>
<span id="cb26-1474"><a href="#cb26-1474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1475"><a href="#cb26-1475" aria-hidden="true" tabindex="-1"></a>**Identification clarity.** The paper must clearly state which parameters are identified, from which moments, and what variation in the data provides identification. The @rust1987optimal critique that without clear identification, structural estimation is curve-fitting, must be addressed head-on.</span>
<span id="cb26-1476"><a href="#cb26-1476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1477"><a href="#cb26-1477" aria-hidden="true" tabindex="-1"></a>**Counterfactual credibility.** Counterfactual exercises should be economically motivated and the range of counterfactual scenarios should not extrapolate far beyond the data.</span>
<span id="cb26-1478"><a href="#cb26-1478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1479"><a href="#cb26-1479" aria-hidden="true" tabindex="-1"></a>**Robustness to specification.** Reviewers will ask what happens under alternative distributional assumptions, alternative moment conditions, and alternative model features.</span>
<span id="cb26-1480"><a href="#cb26-1480" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1481"><a href="#cb26-1481" aria-hidden="true" tabindex="-1"></a>**Transparency.** Code and data should be made available. Structural estimation is sufficiently complex that replicability is a first-order concern. </span>
<span id="cb26-1482"><a href="#cb26-1482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1483"><a href="#cb26-1483" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises</span></span>
<span id="cb26-1484"><a href="#cb26-1484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1485"><a href="#cb26-1485" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Demand Elasticity Heterogeneity.** Extend the KY demand system by allowing demand elasticities to vary by investor type (mutual funds, insurance companies, pension funds, foreign institutional investors). Estimate separate $\boldsymbol{\beta}_i$ vectors for each type. Which investor type has the most elastic demand? Which has the most inelastic? Relate your findings to the price impact predictions of @gabaix2021search.</span></span>
<span id="cb26-1486"><a href="#cb26-1486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1487"><a href="#cb26-1487" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Optimal Execution with Price Limits.** Modify the Almgren-Chriss framework to incorporate Vietnamese daily price limits. The constraint is that the execution price on any day cannot exceed the limit: $|S_t - S_{t-1}| \leq L$. Solve the modified optimization numerically and compare the optimal trajectory with the unconstrained solution. How do price limits affect total execution cost and the optimal time horizon?</span></span>
<span id="cb26-1488"><a href="#cb26-1488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1489"><a href="#cb26-1489" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Mechanism Design for SOE Equitization.** Using the estimated Rock model parameters, simulate IPO outcomes under a Vickrey (second-price) auction mechanism. Compare welfare (issuer revenue, investor surplus, total surplus) with the observed auction and book building outcomes. Under what conditions does the Vickrey mechanism dominate?</span></span>
<span id="cb26-1490"><a href="#cb26-1490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1491"><a href="#cb26-1491" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **PIN and Corporate Events.** Estimate PIN in event windows around earnings announcements, M&amp;A announcements, and regulatory changes for a sample of Vietnamese firms. Does PIN spike before public announcements (consistent with informed trading or leakage)? Compare the magnitude of the pre-announcement PIN increase across event types.</span></span>
<span id="cb26-1492"><a href="#cb26-1492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1493"><a href="#cb26-1493" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Kyle's Lambda and Market Depth.** Estimate Kyle's $\lambda$ (the price impact coefficient from the regression of price changes on signed order flow) for the cross-section of Vietnamese stocks. Test whether $\lambda$ is inversely related to measures of market depth (average volume, number of active traders, institutional ownership). Construct a tradeable portfolio long low-$\lambda$ (liquid) stocks and short high-$\lambda$ (illiquid) stocks. Does this liquidity factor earn a risk premium?</span></span>
<span id="cb26-1494"><a href="#cb26-1494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1495"><a href="#cb26-1495" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Structural Break in Market Microstructure.** Vietnam implemented tick size changes and trading hour extensions at various points. Using the PIN model and the Roll spread, estimate structural breaks in information asymmetry and transaction costs around these regulatory changes. Do the structural parameters change in the direction predicted by market microstructure theory? Use the @bai1998estimating sequential breakpoint methodology to formally test for and date the breaks. --&gt;</span></span>
<span id="cb26-1496"><a href="#cb26-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1497"><a href="#cb26-1497" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb26-1498"><a href="#cb26-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1499"><a href="#cb26-1499" aria-hidden="true" tabindex="-1"></a>This chapter introduced structural estimation as a distinct methodology for financial economics, one that trades the simplicity and transparency of reduced-form analysis for the ability to estimate economic primitives and conduct counterfactual policy evaluation. We implemented four classes of structural models: demand systems for financial assets, optimal execution and transaction cost models, IPO auction models, and limit order book models of informed trading.</span>
<span id="cb26-1500"><a href="#cb26-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1501"><a href="#cb26-1501" aria-hidden="true" tabindex="-1"></a>The demand system approach of @koijen2019demand reveals that institutional investors in Vietnam exhibit heterogeneous demand elasticities across characteristics, with foreign investors showing different sensitivity patterns than domestic institutions. Market impact estimation confirms the universality of the square-root law, while the Almgren-Chriss framework provides the optimal execution benchmark for large institutional orders. The Rock IPO model quantifies the information asymmetry premium embedded in Vietnamese IPO underpricing, and the PIN model estimates the probability of informed trading across the cross-section.</span>
<span id="cb26-1502"><a href="#cb26-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-1503"><a href="#cb26-1503" aria-hidden="true" tabindex="-1"></a>Each model involves a tradeoff between the economic questions it can answer and the assumptions it requires. The decision to use structural estimation should be driven by the research question (specifically, whether counterfactual analysis is essential) and tempered by honest assessment of whether the model's assumptions are sufficiently credible in the Vietnamese institutional environment. When they are, structural models provide insights that no amount of reduced-form regression can deliver.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/63_structural_models_finance.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>