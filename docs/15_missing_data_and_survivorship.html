<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>13&nbsp; Missing Data and Survivorship Bias â€“ Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./16_liquidity_and_turnover_measures.html" rel="next">
<link href="./14_portfolio_weighting_and_rebalancing.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="13&nbsp; Missing Data and Survivorship Bias â€“ Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="13&nbsp; Missing Data and Survivorship Bias â€“ Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Applying Tidy Finance with Python to Vietnam</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">ðŸ“˜ English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://YOUR-ORG.github.io/tidy-finance-vietnam-python-vi/"> 
<span class="menu-text">ðŸ“— SÃ¡ch Tiáº¿ng Viá»‡t</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10_modern_portfolio_theory.html">Portfolio Construction, Risk, and Empirical Mechanics</a></li><li class="breadcrumb-item"><a href="./15_missing_data_and_survivorship.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnamâ€™s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Alternative Data and AI for Finance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-missing-taxonomy" id="toc-sec-missing-taxonomy" class="nav-link active" data-scroll-target="#sec-missing-taxonomy"><span class="header-section-number">13.1</span> Taxonomy of Data Problems</a></li>
  <li><a href="#sec-missing-data" id="toc-sec-missing-data" class="nav-link" data-scroll-target="#sec-missing-data"><span class="header-section-number">13.2</span> Data Construction</a></li>
  <li><a href="#sec-missing-listing-dynamics" id="toc-sec-missing-listing-dynamics" class="nav-link" data-scroll-target="#sec-missing-listing-dynamics"><span class="header-section-number">13.3</span> Listing Dynamics in Vietnam</a>
  <ul class="collapse">
  <li><a href="#the-growth-of-the-vietnamese-market" id="toc-the-growth-of-the-vietnamese-market" class="nav-link" data-scroll-target="#the-growth-of-the-vietnamese-market"><span class="header-section-number">13.3.1</span> The Growth of the Vietnamese Market</a></li>
  <li><a href="#delisting-reasons" id="toc-delisting-reasons" class="nav-link" data-scroll-target="#delisting-reasons"><span class="header-section-number">13.3.2</span> Delisting Reasons</a></li>
  <li><a href="#firm-characteristics-at-delisting" id="toc-firm-characteristics-at-delisting" class="nav-link" data-scroll-target="#firm-characteristics-at-delisting"><span class="header-section-number">13.3.3</span> Firm Characteristics at Delisting</a></li>
  </ul></li>
  <li><a href="#sec-missing-survivorship" id="toc-sec-missing-survivorship" class="nav-link" data-scroll-target="#sec-missing-survivorship"><span class="header-section-number">13.4</span> Survivorship Bias</a>
  <ul class="collapse">
  <li><a href="#definition-and-magnitude" id="toc-definition-and-magnitude" class="nav-link" data-scroll-target="#definition-and-magnitude"><span class="header-section-number">13.4.1</span> Definition and Magnitude</a></li>
  <li><a href="#time-varying-survivorship-bias" id="toc-time-varying-survivorship-bias" class="nav-link" data-scroll-target="#time-varying-survivorship-bias"><span class="header-section-number">13.4.2</span> Time-Varying Survivorship Bias</a></li>
  <li><a href="#survivorship-bias-in-cross-sectional-anomalies" id="toc-survivorship-bias-in-cross-sectional-anomalies" class="nav-link" data-scroll-target="#survivorship-bias-in-cross-sectional-anomalies"><span class="header-section-number">13.4.3</span> Survivorship Bias in Cross-Sectional Anomalies</a></li>
  </ul></li>
  <li><a href="#sec-missing-delisting" id="toc-sec-missing-delisting" class="nav-link" data-scroll-target="#sec-missing-delisting"><span class="header-section-number">13.5</span> Delisting Bias and Return Imputation</a>
  <ul class="collapse">
  <li><a href="#the-shumway-correction" id="toc-the-shumway-correction" class="nav-link" data-scroll-target="#the-shumway-correction"><span class="header-section-number">13.5.1</span> The Shumway Correction</a></li>
  <li><a href="#impact-of-delisting-return-imputation" id="toc-impact-of-delisting-return-imputation" class="nav-link" data-scroll-target="#impact-of-delisting-return-imputation"><span class="header-section-number">13.5.2</span> Impact of Delisting Return Imputation</a></li>
  </ul></li>
  <li><a href="#sec-missing-zero-trading" id="toc-sec-missing-zero-trading" class="nav-link" data-scroll-target="#sec-missing-zero-trading"><span class="header-section-number">13.6</span> Zero-Trading Days and Illiquidity Gaps</a>
  <ul class="collapse">
  <li><a href="#prevalence-of-zero-trading-days" id="toc-prevalence-of-zero-trading-days" class="nav-link" data-scroll-target="#prevalence-of-zero-trading-days"><span class="header-section-number">13.6.1</span> Prevalence of Zero-Trading Days</a></li>
  <li><a href="#return-measurement-during-zero-trading-periods" id="toc-return-measurement-during-zero-trading-periods" class="nav-link" data-scroll-target="#return-measurement-during-zero-trading-periods"><span class="header-section-number">13.6.2</span> Return Measurement During Zero-Trading Periods</a></li>
  </ul></li>
  <li><a href="#sec-missing-lookahead" id="toc-sec-missing-lookahead" class="nav-link" data-scroll-target="#sec-missing-lookahead"><span class="header-section-number">13.7</span> Look-Ahead Bias</a>
  <ul class="collapse">
  <li><a href="#definition" id="toc-definition" class="nav-link" data-scroll-target="#definition"><span class="header-section-number">13.7.1</span> Definition</a></li>
  <li><a href="#point-in-time-adjustment" id="toc-point-in-time-adjustment" class="nav-link" data-scroll-target="#point-in-time-adjustment"><span class="header-section-number">13.7.2</span> Point-in-Time Adjustment</a></li>
  <li><a href="#quantifying-look-ahead-bias-in-value-strategies" id="toc-quantifying-look-ahead-bias-in-value-strategies" class="nav-link" data-scroll-target="#quantifying-look-ahead-bias-in-value-strategies"><span class="header-section-number">13.7.3</span> Quantifying Look-Ahead Bias in Value Strategies</a></li>
  </ul></li>
  <li><a href="#sec-missing-transfers" id="toc-sec-missing-transfers" class="nav-link" data-scroll-target="#sec-missing-transfers"><span class="header-section-number">13.8</span> Exchange Transfers and Ticker Discontinuities</a>
  <ul class="collapse">
  <li><a href="#the-transfer-problem" id="toc-the-transfer-problem" class="nav-link" data-scroll-target="#the-transfer-problem"><span class="header-section-number">13.8.1</span> The Transfer Problem</a></li>
  </ul></li>
  <li><a href="#sec-missing-sensitivity" id="toc-sec-missing-sensitivity" class="nav-link" data-scroll-target="#sec-missing-sensitivity"><span class="header-section-number">13.9</span> Sensitivity Analysis Framework</a>
  <ul class="collapse">
  <li><a href="#how-fragile-are-your-results" id="toc-how-fragile-are-your-results" class="nav-link" data-scroll-target="#how-fragile-are-your-results"><span class="header-section-number">13.9.1</span> How Fragile Are Your Results?</a></li>
  </ul></li>
  <li><a href="#sec-missing-recommendations" id="toc-sec-missing-recommendations" class="nav-link" data-scroll-target="#sec-missing-recommendations"><span class="header-section-number">13.10</span> Practical Recommendations</a></li>
  <li><a href="#sec-missing-summary" id="toc-sec-missing-summary" class="nav-link" data-scroll-target="#sec-missing-summary"><span class="header-section-number">13.11</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/15_missing_data_and_survivorship.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./10_modern_portfolio_theory.html">Portfolio Construction, Risk, and Empirical Mechanics</a></li><li class="breadcrumb-item"><a href="./15_missing_data_and_survivorship.html"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we document the patterns of missing data, survivorship bias, and delisting bias in Vietnamese equity markets, develop diagnostic tools to detect these problems, and implement correction methods that yield more reliable empirical results.</p>
</div>
</div>
<p>Every empirical study in finance implicitly assumes that the data it analyzes are representative of the population it claims to study. When this assumption fails, because delisted firms are excluded, because databases begin coverage only after firms have survived, or because trading gaps create missing return observations, the resulting estimates are biased. In the U.S. context, <span class="citation" data-cites="shumway1997delisting">Shumway (<a href="references.html#ref-shumway1997delisting" role="doc-biblioref">1997</a>)</span> showed that ignoring delisting returns biases average returns upward by approximately 1% per year for NYSE stocks and substantially more for Nasdaq stocks, with severe consequences for anomaly-based strategies that overweight small, distressed firms.</p>
<p>The Vietnamese market presents a distinct and, in many ways, more acute set of data integrity challenges. The market is young. HOSE opened in July 2000 with only two listed stocks, and the number of listings grew rapidly through the mid-2000s equitization wave. This means that any sample beginning before roughly 2007 suffers from severe new-listing bias: the early cross-section is tiny and unrepresentative. Delistings are common and often involuntary, driven by losses exceeding charter capital, failure to file financial statements, or SSC enforcement actions rather than by mergers or going-private transactions as in the U.S. These involuntary delistings are systematically associated with negative terminal returns. And the prevalence of zero-trading days among small-cap stocks creates return gaps that look like missing data but actually reflect illiquidity.</p>
<p>This chapter provides the tools to diagnose and, where possible, correct these problems.</p>
<section id="sec-missing-taxonomy" class="level2" data-number="13.1">
<h2 data-number="13.1" class="anchored" data-anchor-id="sec-missing-taxonomy"><span class="header-section-number">13.1</span> Taxonomy of Data Problems</h2>
<p>Missing data in financial research is not monolithic. The consequences depend critically on the <em>mechanism</em> generating the missingness. <span class="citation" data-cites="rubin1976inference">Rubin (<a href="references.html#ref-rubin1976inference" role="doc-biblioref">1976</a>)</span> and <span class="citation" data-cites="little2019statistical">Little and Rubin (<a href="references.html#ref-little2019statistical" role="doc-biblioref">2019</a>)</span> classify missing data into three types:</p>
<ol type="1">
<li><strong>Missing Completely at Random (MCAR).</strong> The probability of a missing observation does not depend on any observed or unobserved variable. Example: a data vendorâ€™s server crashes on a random Tuesday, losing that dayâ€™s records. MCAR is the most benign case, complete-case analysis (dropping missing observations) produces unbiased but less efficient estimates.</li>
<li><strong>Missing at Random (MAR).</strong> The probability of missingness depends on observed variables but not on the missing value itself, conditional on observables. Example: small firms are more likely to have missing analyst coverage, but conditional on firm size, whether coverage is missing is unrelated to the firmâ€™s true expected return. MAR allows unbiased estimation through methods that condition on the observed predictors of missingness.</li>
<li><strong>Missing Not at Random (MNAR).</strong> The probability of missingness depends on the missing value itself. Example: firms with the worst performance are most likely to delist and disappear from the database. MNAR is a pathological case and, unfortunately, the most common in financial data. Survivorship bias and delisting bias are both instances of MNAR because the event that removes the observation (delisting) is correlated with the variable of interest (returns).</li>
</ol>
<p>In the Vietnamese context, we encounter all three types, often simultaneously (<a href="#tbl-missing-taxonomy" class="quarto-xref">Table&nbsp;<span>13.1</span></a>).</p>
<div id="tbl-missing-taxonomy" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-missing-taxonomy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.1: Taxonomy of missing data in Vietnamese equity databases
</figcaption>
<div aria-describedby="tbl-missing-taxonomy-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Data Problem</th>
<th>Missingness Type</th>
<th>Mechanism in Vietnam</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Zero-trading days</td>
<td>MAR/MNAR</td>
<td>Small/illiquid stocks; correlated with returns</td>
</tr>
<tr class="even">
<td>Price limit hits</td>
<td>MNAR</td>
<td>True return truncated at limit; observed return censored</td>
</tr>
<tr class="odd">
<td>Delisting</td>
<td>MNAR</td>
<td>Worst-performing firms exit; returns disappear</td>
</tr>
<tr class="even">
<td>Late listing coverage</td>
<td>Selection bias</td>
<td>Database begins after firm survives initial period</td>
</tr>
<tr class="odd">
<td>Exchange transfers</td>
<td>Administrative</td>
<td>HOSEâ†’HNX or UPCoM transfers break ticker continuity</td>
</tr>
<tr class="even">
<td>Suspended trading</td>
<td>MNAR</td>
<td>Suspension precedes negative events; returns missing</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="sec-missing-data" class="level2" data-number="13.2">
<h2 data-number="13.2" class="anchored" data-anchor-id="sec-missing-data"><span class="header-section-number">13.2</span> Data Construction</h2>
<div id="setup" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="data-load" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete listing history: includes all firms ever listed, not just current</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>listing_history <span class="op">=</span> client.get_listing_history(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'company_name'</span>, <span class="st">'exchange'</span>, <span class="st">'listing_date'</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">'delisting_date'</span>, <span class="st">'delisting_reason'</span>, <span class="st">'is_active'</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transfer_from'</span>, <span class="st">'transfer_to'</span>, <span class="st">'transfer_date'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ipo_date'</span>, <span class="st">'equitization_date'</span>, <span class="st">'sector'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns: includes delisted firms' full history</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2000-07-28'</span>,   <span class="co"># HOSE opening date</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,      <span class="co"># Critical flag</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">'turnover_value'</span>, <span class="st">'market_cap'</span>, <span class="st">'shares_outstanding'</span>,</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'price_limit_hit'</span>       <span class="co"># +1 = limit up, -1 = limit down, 0 = neither</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (pre-computed, survivorship-bias-free)</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2000-07-28'</span>,</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volume_avg_20d'</span>, <span class="st">'n_trading_days'</span>, <span class="st">'n_zero_volume_days'</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Listing history: </span><span class="sc">{</span>listing_history<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> firms"</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Active: </span><span class="sc">{</span>listing_history[<span class="st">'is_active'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Delisted: </span><span class="sc">{</span>(<span class="op">~</span>listing_history[<span class="st">'is_active'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span>daily_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly observations: </span><span class="sc">{</span>monthly_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-missing-listing-dynamics" class="level2" data-number="13.3">
<h2 data-number="13.3" class="anchored" data-anchor-id="sec-missing-listing-dynamics"><span class="header-section-number">13.3</span> Listing Dynamics in Vietnam</h2>
<section id="the-growth-of-the-vietnamese-market" class="level3" data-number="13.3.1">
<h3 data-number="13.3.1" class="anchored" data-anchor-id="the-growth-of-the-vietnamese-market"><span class="header-section-number">13.3.1</span> The Growth of the Vietnamese Market</h3>
<p>The Vietnamese stock marketâ€™s short history creates a distinctive pattern: the investable universe has grown from near-zero to over 1,500 listed firms in approximately two decades. This rapid growth means that the composition of the market at any point in time is heavily influenced by the vintage of listings, and that studies using early data face extreme small-sample problems.</p>
<div id="fig-listing-growth" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="3">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-listing-growth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'listing_date'</span>] <span class="op">=</span> pd.to_datetime(listing_history[<span class="st">'listing_date'</span>])</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'delisting_date'</span>] <span class="op">=</span> pd.to_datetime(listing_history[<span class="st">'delisting_date'</span>])</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Count active listings at each month-end</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>months <span class="op">=</span> pd.date_range(<span class="st">'2000-07-01'</span>, <span class="st">'2024-12-31'</span>, freq<span class="op">=</span><span class="st">'M'</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>active_counts <span class="op">=</span> []</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> exchange <span class="kw">in</span> [<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>]:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        active <span class="op">=</span> listing_history[</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>            (listing_history[<span class="st">'exchange'</span>] <span class="op">==</span> exchange) <span class="op">&amp;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            (listing_history[<span class="st">'listing_date'</span>] <span class="op">&lt;=</span> month) <span class="op">&amp;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            ((listing_history[<span class="st">'delisting_date'</span>].isna()) <span class="op">|</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>             (listing_history[<span class="st">'delisting_date'</span>] <span class="op">&gt;</span> month))</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        active_counts.append({</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month'</span>: month,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'exchange'</span>: exchange,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_active'</span>: <span class="bu">len</span>(active)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>active_df <span class="op">=</span> pd.DataFrame(active_counts)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Active listings over time</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> exchange, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'HNX'</span>, <span class="st">'#E67E22'</span>),</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>                         (<span class="st">'UPCoM'</span>, <span class="st">'#27AE60'</span>)]:</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> active_df[active_df[<span class="st">'exchange'</span>] <span class="op">==</span> exchange]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(subset[<span class="st">'month'</span>], subset[<span class="st">'n_active'</span>],</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span>exchange)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Active Listings'</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Active Listings by Exchange'</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Annual listings and delistings</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'listing_year'</span>] <span class="op">=</span> listing_history[<span class="st">'listing_date'</span>].dt.year</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'delisting_year'</span>] <span class="op">=</span> listing_history[<span class="st">'delisting_date'</span>].dt.year</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>annual_listings <span class="op">=</span> (</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    listing_history</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'listing_year'</span>)</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    .reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>annual_delistings <span class="op">=</span> (</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    listing_history</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">'delisting_year'</span>])</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'delisting_year'</span>)</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    .reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">2000</span>, <span class="dv">2025</span>)</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x <span class="op">-</span> <span class="fl">0.2</span>, annual_listings.values, width<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'New Listings'</span>)</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x <span class="op">+</span> <span class="fl">0.2</span>, annual_delistings.values, width<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Delistings'</span>)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Firms'</span>)</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Annual Listings and Delistings'</span>)</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-listing-growth-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.1
</figcaption>
</figure>
</div>
</section>
<section id="delisting-reasons" class="level3" data-number="13.3.2">
<h3 data-number="13.3.2" class="anchored" data-anchor-id="delisting-reasons"><span class="header-section-number">13.3.2</span> Delisting Reasons</h3>
<p>Vietnamese delistings are not homogeneous. The SSC mandates delisting for specific regulatory violations, but firms may also voluntarily delist, merge, or transfer between exchanges. The reason for delisting matters because it determines the likely terminal return.</p>
<div id="delisting-reasons" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>delisted <span class="op">=</span> listing_history[listing_history[<span class="st">'delisting_date'</span>].notna()].copy()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize delisting reasons into categories</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>reason_map <span class="op">=</span> {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'losses_exceed_charter'</span>: <span class="st">'Involuntary - Financial Distress'</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bankruptcy'</span>: <span class="st">'Involuntary - Financial Distress'</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'failure_to_file'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'audit_qualification'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ssc_enforcement'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'merger'</span>: <span class="st">'Voluntary - M&amp;A'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'going_private'</span>: <span class="st">'Voluntary - Going Private'</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transfer_exchange'</span>: <span class="st">'Transfer'</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'voluntary'</span>: <span class="st">'Voluntary - Other'</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'other'</span>: <span class="st">'Other/Unknown'</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>delisted[<span class="st">'reason_category'</span>] <span class="op">=</span> (</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    delisted[<span class="st">'delisting_reason'</span>]</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(reason_map)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="st">'Other/Unknown'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>reason_counts <span class="op">=</span> (</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    delisted[<span class="st">'reason_category'</span>]</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    .value_counts()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    .to_frame(<span class="st">'Count'</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>reason_counts[<span class="st">'Percentage'</span>] <span class="op">=</span> (</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    reason_counts[<span class="st">'Count'</span>] <span class="op">/</span> reason_counts[<span class="st">'Count'</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Delisting Reasons:"</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(reason_counts.<span class="bu">round</span>(<span class="dv">1</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-delisting-reasons" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-delisting-reasons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Pie chart</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>colors_pie <span class="op">=</span> [<span class="st">'#C0392B'</span>, <span class="st">'#E74C3C'</span>, <span class="st">'#8E44AD'</span>, <span class="st">'#27AE60'</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">'#2C5F8A'</span>, <span class="st">'#F1C40F'</span>, <span class="st">'#BDC3C7'</span>]</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].pie(reason_counts[<span class="st">'Count'</span>], labels<span class="op">=</span>reason_counts.index,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>            colors<span class="op">=</span>colors_pie[:<span class="bu">len</span>(reason_counts)],</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>            autopct<span class="op">=</span><span class="st">'%1.0f</span><span class="sc">%%</span><span class="st">'</span>, startangle<span class="op">=</span><span class="dv">90</span>, textprops<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">8</span>})</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Delisting Reasons'</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Delisting reasons over time</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>delisted[<span class="st">'year'</span>] <span class="op">=</span> delisted[<span class="st">'delisting_date'</span>].dt.year</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>reason_by_year <span class="op">=</span> pd.crosstab(delisted[<span class="st">'year'</span>], delisted[<span class="st">'reason_category'</span>])</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>reason_by_year <span class="op">=</span> reason_by_year.reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>reason_by_year.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>                     colormap<span class="op">=</span><span class="st">'Set2'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, width<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Delistings'</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Delisting Reasons Over Time'</span>)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(fontsize<span class="op">=</span><span class="dv">7</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-delisting-reasons-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.2
</figcaption>
</figure>
</div>
</section>
<section id="firm-characteristics-at-delisting" class="level3" data-number="13.3.3">
<h3 data-number="13.3.3" class="anchored" data-anchor-id="firm-characteristics-at-delisting"><span class="header-section-number">13.3.3</span> Firm Characteristics at Delisting</h3>
<p>Do delisted firms differ systematically from survivors? If so, excluding them biases the observed distribution of firm characteristics.</p>
<div id="fig-delisting-characteristics" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="6">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-delisting-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get fundamentals in the last available year before delisting</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>last_year_delisted <span class="op">=</span> (</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    delisted[[<span class="st">'ticker'</span>, <span class="st">'delisting_date'</span>]]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    .assign(last_fy<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'delisting_date'</span>].dt.year <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>fundamentals <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2005-01-01'</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_assets'</span>, <span class="st">'net_income'</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_equity'</span>, <span class="st">'revenue'</span>, <span class="st">'market_cap'</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Characteristics of delisted firms (last year before delisting)</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>delist_chars <span class="op">=</span> (</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    last_year_delisted</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    .merge(fundamentals.rename(columns<span class="op">=</span>{<span class="st">'fiscal_year'</span>: <span class="st">'last_fy'</span>}),</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>           on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'last_fy'</span>], how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'roa'</span>] <span class="op">=</span> delist_chars[<span class="st">'net_income'</span>] <span class="op">/</span> delist_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'leverage'</span>] <span class="op">=</span> (</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    (delist_chars[<span class="st">'total_assets'</span>] <span class="op">-</span> delist_chars[<span class="st">'total_equity'</span>])</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> delist_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(delist_chars[<span class="st">'total_assets'</span>])</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'group'</span>] <span class="op">=</span> <span class="st">'Delisted'</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Characteristics of all active firms (pooled)</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>all_chars <span class="op">=</span> fundamentals.copy()</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'roa'</span>] <span class="op">=</span> all_chars[<span class="st">'net_income'</span>] <span class="op">/</span> all_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'leverage'</span>] <span class="op">=</span> (</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    (all_chars[<span class="st">'total_assets'</span>] <span class="op">-</span> all_chars[<span class="st">'total_equity'</span>])</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> all_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(all_chars[<span class="st">'total_assets'</span>])</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'group'</span>] <span class="op">=</span> <span class="st">'All Active'</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare distributions</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>variables <span class="op">=</span> [</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'log_assets'</span>, <span class="st">'Log Total Assets'</span>, axes[<span class="dv">0</span>, <span class="dv">0</span>]),</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'roa'</span>, <span class="st">'Return on Assets'</span>, axes[<span class="dv">0</span>, <span class="dv">1</span>]),</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'leverage'</span>, <span class="st">'Leverage Ratio'</span>, axes[<span class="dv">1</span>, <span class="dv">0</span>]),</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col, label, ax <span class="kw">in</span> variables:</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> grp, color <span class="kw">in</span> [(<span class="st">'All Active'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'Delisted'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'Delisted'</span>:</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> delist_chars[col].dropna()</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> all_chars[col].dropna()</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> data[np.isfinite(data)]</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        ax.hist(data, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color, label<span class="op">=</span>grp, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(label)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel D: Market cap distribution</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp, color <span class="kw">in</span> [(<span class="st">'All Active'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'Delisted'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'Delisted'</span>:</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> np.log(delist_chars[<span class="st">'market_cap'</span>].dropna())</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> np.log(all_chars[<span class="st">'market_cap'</span>].dropna())</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data[np.isfinite(data)]</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>, <span class="dv">1</span>].hist(data, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>color, label<span class="op">=</span>grp, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Log Market Cap'</span>)</span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].legend()</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Characteristics of Delisted vs Active Firms'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Formal comparison</span></span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Mean Comparison (Delisted vs All Active):"</span>)</span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'log_assets'</span>, <span class="st">'roa'</span>, <span class="st">'leverage'</span>]:</span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> delist_chars[col].dropna()</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> all_chars[col].dropna()</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> d[np.isfinite(d)]</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> a[np.isfinite(a)]</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>    t, p <span class="op">=</span> stats.ttest_ind(d, a, equal_var<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">:&lt;15}</span><span class="ss">: Delisted = </span><span class="sc">{</span>d<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Active = </span><span class="sc">{</span>a<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, t = </span><span class="sc">{</span>t<span class="sc">:.2f}</span><span class="ss">, p = </span><span class="sc">{</span>p<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-delisting-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.3
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-missing-survivorship" class="level2" data-number="13.4">
<h2 data-number="13.4" class="anchored" data-anchor-id="sec-missing-survivorship"><span class="header-section-number">13.4</span> Survivorship Bias</h2>
<section id="definition-and-magnitude" class="level3" data-number="13.4.1">
<h3 data-number="13.4.1" class="anchored" data-anchor-id="definition-and-magnitude"><span class="header-section-number">13.4.1</span> Definition and Magnitude</h3>
<p>Survivorship bias arises when a study uses only firms that are currently listed (or listed at the end of the sample), excluding firms that delisted during the sample period. Because delisted firms disproportionately experienced negative returns before delisting, their exclusion inflates average returns, understates risk, and distorts cross-sectional patterns.</p>
<p>We quantify the magnitude of survivorship bias by comparing portfolio returns computed from the <strong>survivorship-bias-free</strong> sample (all firms, including those that subsequently delisted) against a <strong>survivors-only</strong> sample (firms that remained listed through the end of the sample).</p>
<div id="survivorship-magnitude" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define survivors: firms active as of 2024-12-31</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>survivors <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    listing_history[listing_history[<span class="st">'is_active'</span>]][<span class="st">'ticker'</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Full sample: all firms, including delisted</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>full_sample <span class="op">=</span> monthly_returns.copy()</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Survivors only: restrict to firms still listed at end of sample</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>survivors_only <span class="op">=</span> monthly_returns[</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    monthly_returns[<span class="st">'ticker'</span>].isin(survivors)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute EW monthly portfolio returns</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ew_portfolio(df):</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>        df</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>        .mean()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        .to_frame(<span class="st">'portfolio_return'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_vw_portfolio(df):</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        df</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: np.average(g[<span class="st">'monthly_return'</span>],</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                                     weights<span class="op">=</span>g[<span class="st">'market_cap'</span>])</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        .to_frame(<span class="st">'portfolio_return'</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>ew_full <span class="op">=</span> compute_ew_portfolio(full_sample)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>ew_survivors <span class="op">=</span> compute_ew_portfolio(survivors_only)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>vw_full <span class="op">=</span> compute_vw_portfolio(full_sample)</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>vw_survivors <span class="op">=</span> compute_vw_portfolio(survivors_only)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and compute bias</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>bias_ew <span class="op">=</span> pd.merge(</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    ew_full.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'full'</span>}),</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    ew_survivors.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>bias_ew[<span class="st">'bias'</span>] <span class="op">=</span> bias_ew[<span class="st">'survivors'</span>] <span class="op">-</span> bias_ew[<span class="st">'full'</span>]</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>bias_vw <span class="op">=</span> pd.merge(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    vw_full.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'full'</span>}),</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    vw_survivors.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>bias_vw[<span class="st">'bias'</span>] <span class="op">=</span> bias_vw[<span class="st">'survivors'</span>] <span class="op">-</span> bias_vw[<span class="st">'full'</span>]</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Survivorship Bias (Annualized):"</span>)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW: </span><span class="sc">{</span>bias_ew[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>bias_ew[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">1200</span><span class="sc">:.1f}</span><span class="ss"> bps/year)"</span>)</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  VW: </span><span class="sc">{</span>bias_vw[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>bias_vw[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">1200</span><span class="sc">:.1f}</span><span class="ss"> bps/year)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-survivorship-bias" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-survivorship-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (bias_df, title) <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    [(bias_ew, <span class="st">'Panel A: Equal-Weighted'</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>     (bias_vw, <span class="st">'Panel B: Value-Weighted'</span>)]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    cum_full <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> bias_df[<span class="st">'full'</span>]).cumprod()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    cum_surv <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> bias_df[<span class="st">'survivors'</span>]).cumprod()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(cum_full.index, cum_full,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Full Sample'</span>)</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(cum_surv.index, cum_surv,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Survivors Only'</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Cumulative Wealth'</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(title)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    axes[i].legend()</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    axes[i].set_yscale(<span class="st">'log'</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    ann_bias <span class="op">=</span> bias_df[<span class="st">'bias'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    axes[i].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>                 <span class="ss">f'Annual Bias: </span><span class="sc">{</span>ann_bias<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%'</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                 transform<span class="op">=</span>axes[i].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                 verticalalignment<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>                 bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>))</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-survivorship-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.4
</figcaption>
</figure>
</div>
</section>
<section id="time-varying-survivorship-bias" class="level3" data-number="13.4.2">
<h3 data-number="13.4.2" class="anchored" data-anchor-id="time-varying-survivorship-bias"><span class="header-section-number">13.4.2</span> Time-Varying Survivorship Bias</h3>
<p>The magnitude of survivorship bias is not constant. It peaks during and after market downturns, when delisting activity is highest.</p>
<div id="fig-rolling-bias" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="9">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-rolling-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">=</span> bias_ew[<span class="st">'bias'</span>].rolling(<span class="dv">12</span>).mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), height_ratios<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Rolling bias</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].fill_between(</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    bias_ew.index, <span class="dv">0</span>, bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    where<span class="op">=</span>bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.4</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(bias_ew.index, bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Annualized Bias (%)'</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Rolling 12-Month Survivorship Bias (EW)'</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of delistings per quarter</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>delistings_quarterly <span class="op">=</span> (</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    delisted</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">'delisting_date'</span>)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    .resample(<span class="st">'Q'</span>)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(delistings_quarterly.index, delistings_quarterly.values,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>            width<span class="op">=</span><span class="dv">80</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Delistings per Quarter'</span>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Quarterly Delisting Activity'</span>)</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-rolling-bias-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.5
</figcaption>
</figure>
</div>
</section>
<section id="survivorship-bias-in-cross-sectional-anomalies" class="level3" data-number="13.4.3">
<h3 data-number="13.4.3" class="anchored" data-anchor-id="survivorship-bias-in-cross-sectional-anomalies"><span class="header-section-number">13.4.3</span> Survivorship Bias in Cross-Sectional Anomalies</h3>
<p>The bias is not uniform across strategies. Anomalies that overweight small, distressed, or low-quality firms, precisely the firms most likely to delist, are most severely affected. We test this for the size, value, and momentum anomalies.</p>
<div id="anomaly-bias" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_long_short(df, sort_var, n_quantiles<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute long-short portfolio returns from quintile sorts.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Long = top quintile, Short = bottom quintile.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month, group <span class="kw">in</span> df.groupby(<span class="st">'month_end'</span>):</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.dropna(subset<span class="op">=</span>[sort_var, <span class="st">'monthly_return'</span>])</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> <span class="dv">20</span>:</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'quantile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>            group[sort_var], n_quantiles, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        long_ret <span class="op">=</span> group[group[<span class="st">'quantile'</span>] <span class="op">==</span> n_quantiles <span class="op">-</span> <span class="dv">1</span>][<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        short_ret <span class="op">=</span> group[group[<span class="st">'quantile'</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'long'</span>: long_ret,</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'short'</span>: short_ret,</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'long_short'</span>: long_ret <span class="op">-</span> short_ret</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare sort variables</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>monthly_with_chars <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    fundamentals[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_assets'</span>,</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'net_income'</span>, <span class="st">'total_equity'</span>]],</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_returns[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>],</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(monthly_with_chars[<span class="st">'market_cap'</span>])</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'bm'</span>] <span class="op">=</span> (</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    monthly_with_chars[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_with_chars[<span class="st">'market_cap'</span>]</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'past_12m'</span>] <span class="op">=</span> (</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    monthly_with_chars</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    .transform(<span class="kw">lambda</span> x: x.rolling(<span class="dv">12</span>).<span class="bu">sum</span>())</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute anomalies on full sample and survivors only</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>anomaly_bias <span class="op">=</span> {}</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> anomaly, sort_var, ascending <span class="kw">in</span> [</span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Size (SMB)'</span>, <span class="st">'log_mcap'</span>, <span class="va">True</span>),</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Value (HML)'</span>, <span class="st">'bm'</span>, <span class="va">True</span>),</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Momentum (WML)'</span>, <span class="st">'past_12m'</span>, <span class="va">True</span>)</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    full_ls <span class="op">=</span> compute_long_short(</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>        monthly_with_chars, sort_var</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    surv_data <span class="op">=</span> monthly_with_chars[</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        monthly_with_chars[<span class="st">'ticker'</span>].isin(survivors)</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>    surv_ls <span class="op">=</span> compute_long_short(surv_data, sort_var)</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.merge(</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        full_ls[[<span class="st">'month_end'</span>, <span class="st">'long_short'</span>]].rename(</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'long_short'</span>: <span class="st">'full'</span>}),</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        surv_ls[[<span class="st">'month_end'</span>, <span class="st">'long_short'</span>]].rename(</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'long_short'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'bias'</span>] <span class="op">=</span> merged[<span class="st">'survivors'</span>] <span class="op">-</span> merged[<span class="st">'full'</span>]</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    ann_full <span class="op">=</span> merged[<span class="st">'full'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>    ann_surv <span class="op">=</span> merged[<span class="st">'survivors'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>    ann_bias <span class="op">=</span> merged[<span class="st">'bias'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>    anomaly_bias[anomaly] <span class="op">=</span> {</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Full Sample (ann.)'</span>: ann_full,</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Survivors Only (ann.)'</span>: ann_surv,</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Bias (ann.)'</span>: ann_bias,</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Bias (</span><span class="sc">% o</span><span class="st">f premium)'</span>: ann_bias <span class="op">/</span> ann_full <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> ann_full <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>anomaly_bias_df <span class="op">=</span> pd.DataFrame(anomaly_bias).T</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Survivorship Bias by Anomaly:"</span>)</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(anomaly_bias_df.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-missing-delisting" class="level2" data-number="13.5">
<h2 data-number="13.5" class="anchored" data-anchor-id="sec-missing-delisting"><span class="header-section-number">13.5</span> Delisting Bias and Return Imputation</h2>
<section id="the-shumway-correction" class="level3" data-number="13.5.1">
<h3 data-number="13.5.1" class="anchored" data-anchor-id="the-shumway-correction"><span class="header-section-number">13.5.1</span> The Shumway Correction</h3>
<p><span class="citation" data-cites="shumway1997delisting">Shumway (<a href="references.html#ref-shumway1997delisting" role="doc-biblioref">1997</a>)</span> showed that CRSPâ€™s treatment of delisting returns, often recording them as missing or zero, creates a systematic upward bias in average returns. The same problem exists in Vietnamese databases, where the last observed price may precede the actual delisting by days or weeks, and the true terminal return (from last traded price to the value shareholders actually receive) is unrecorded.</p>
<p>We implement a delisting return imputation procedure adapted for Vietnam:</p>
<p><strong>Step 1.</strong> For each delisted firm, identify the last trading day with a valid closing price.</p>
<p><strong>Step 2.</strong> Classify the delisting reason to determine the appropriate imputation (<a href="#tbl-missing-imputation" class="quarto-xref">Table&nbsp;<span>13.2</span></a>).</p>
<div id="tbl-missing-imputation" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-missing-imputation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.2: Delisting return imputation rules.
</figcaption>
<div aria-describedby="tbl-missing-imputation-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Delisting Reason</th>
<th>Imputed Return</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>M&amp;A / Acquisition</td>
<td>Actual tender offer premium (if available)</td>
<td>Acquisition at premium</td>
</tr>
<tr class="even">
<td>Going private</td>
<td>0% (or actual buyout price)</td>
<td>Negotiated exit</td>
</tr>
<tr class="odd">
<td>Financial distress</td>
<td>âˆ’30% to âˆ’100%</td>
<td>Substantial loss of value</td>
</tr>
<tr class="even">
<td>Regulatory violation</td>
<td>âˆ’50%</td>
<td>Partial loss; some recovery possible</td>
</tr>
<tr class="odd">
<td>Exchange transfer</td>
<td>0% (link to new ticker)</td>
<td>No economic event</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p><strong>Step 3.</strong> Apply the imputed return to the month of delisting to complete the return series.</p>
<div id="delisting-imputation" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impute_delisting_returns(listing_df, daily_df, monthly_df):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Impute terminal returns for delisted firms.</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a DataFrame of imputed delisting returns to be</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">    appended to the monthly return panel.</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    delisted_firms <span class="op">=</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].copy()</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    imputed <span class="op">=</span> []</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> delisted_firms.iterrows():</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> firm[<span class="st">'ticker'</span>]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        delist_date <span class="op">=</span> firm[<span class="st">'delisting_date'</span>]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        reason <span class="op">=</span> firm.get(<span class="st">'reason_category'</span>, firm.get(<span class="st">'delisting_reason'</span>, <span class="st">''</span>))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find last trading day</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        firm_daily <span class="op">=</span> daily_df[daily_df[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].sort_values(<span class="st">'date'</span>)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(firm_daily) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        last_trade <span class="op">=</span> firm_daily.iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        last_price <span class="op">=</span> last_trade[<span class="st">'adjusted_close'</span>]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        last_date <span class="op">=</span> last_trade[<span class="st">'date'</span>]</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if last trade is already close to delisting date</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        gap_days <span class="op">=</span> (pd.Timestamp(delist_date) <span class="op">-</span> pd.Timestamp(last_date)).days</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gap_days <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Data issue</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine imputation based on reason</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'M&amp;A'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'merger'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Conservative; ideally use tender price</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Going Private'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'voluntary'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Transfer'</span> <span class="kw">in</span> <span class="bu">str</span>(reason):</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Not a real delisting</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'bankruptcy'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.50</span>  <span class="co"># Conservative estimate</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Regulatory'</span> <span class="kw">in</span> <span class="bu">str</span>(reason):</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.30</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.30</span>  <span class="co"># Default for unknown reasons</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign to the delisting month</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        delist_month <span class="op">=</span> pd.Timestamp(delist_date).to_period(<span class="st">'M'</span>).to_timestamp()</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>        imputed.append({</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: delist_month,</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">'monthly_return'</span>: imputed_return,</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">'market_cap'</span>: last_trade.get(<span class="st">'market_cap'</span>, np.nan),</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>            <span class="st">'source'</span>: <span class="st">'imputed_delisting'</span>,</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>            <span class="st">'delisting_reason'</span>: reason,</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>            <span class="st">'gap_days'</span>: gap_days</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(imputed)</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply imputation</span></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a>imputed_returns <span class="op">=</span> impute_delisting_returns(</span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    delisted.assign(reason_category<span class="op">=</span>delisted[<span class="st">'reason_category'</span>]),</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    daily_returns, monthly_returns</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Imputed delisting returns: </span><span class="sc">{</span><span class="bu">len</span>(imputed_returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Imputed return distribution:"</span>)</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(imputed_returns[<span class="st">'monthly_return'</span>].value_counts().sort_index())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="impact-of-delisting-return-imputation" class="level3" data-number="13.5.2">
<h3 data-number="13.5.2" class="anchored" data-anchor-id="impact-of-delisting-return-imputation"><span class="header-section-number">13.5.2</span> Impact of Delisting Return Imputation</h3>
<div id="delisting-impact" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Augmented sample: monthly returns + imputed delisting returns</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>augmented <span class="op">=</span> pd.concat([</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    monthly_returns[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]],</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    imputed_returns[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare original vs augmented EW portfolios</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ew_original <span class="op">=</span> compute_ew_portfolio(monthly_returns)</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>ew_augmented <span class="op">=</span> compute_ew_portfolio(augmented)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> pd.merge(</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    ew_original.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'original'</span>}),</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    ew_augmented.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'augmented'</span>}),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>comparison[<span class="st">'imputation_effect'</span>] <span class="op">=</span> (</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    comparison[<span class="st">'augmented'</span>] <span class="op">-</span> comparison[<span class="st">'original'</span>]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>ann_original <span class="op">=</span> comparison[<span class="st">'original'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>ann_augmented <span class="op">=</span> comparison[<span class="st">'augmented'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>ann_effect <span class="op">=</span> comparison[<span class="st">'imputation_effect'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Delisting Return Imputation Impact:"</span>)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW without imputation: </span><span class="sc">{</span>ann_original<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_original<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW with imputation:    </span><span class="sc">{</span>ann_augmented<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_augmented<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Difference:            </span><span class="sc">{</span>ann_effect<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_effect<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-missing-zero-trading" class="level2" data-number="13.6">
<h2 data-number="13.6" class="anchored" data-anchor-id="sec-missing-zero-trading"><span class="header-section-number">13.6</span> Zero-Trading Days and Illiquidity Gaps</h2>
<section id="prevalence-of-zero-trading-days" class="level3" data-number="13.6.1">
<h3 data-number="13.6.1" class="anchored" data-anchor-id="prevalence-of-zero-trading-days"><span class="header-section-number">13.6.1</span> Prevalence of Zero-Trading Days</h3>
<p>A distinctive feature of Vietnamese equity data is the high frequency of zero-volume days (i.e., days on which a listed stock records no trades). These are not true â€œmissingâ€ data in the database sense (the stock is listed and a closing price is recorded, often equal to the previous close), but they represent economically missing information: the observed price is stale and does not reflect current market conditions.</p>
<div id="fig-zero-trading" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="13">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-zero-trading-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute zero-volume fraction per firm-year</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>daily_returns[<span class="st">'year'</span>] <span class="op">=</span> pd.to_datetime(daily_returns[<span class="st">'date'</span>]).dt.year</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>daily_returns[<span class="st">'zero_volume'</span>] <span class="op">=</span> (daily_returns[<span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>zero_vol_fy <span class="op">=</span> (</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    daily_returns</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">'ticker'</span>, <span class="st">'year'</span>])</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        n_days<span class="op">=</span>(<span class="st">'zero_volume'</span>, <span class="st">'count'</span>),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        n_zero<span class="op">=</span>(<span class="st">'zero_volume'</span>, <span class="st">'sum'</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        avg_mcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>zero_vol_fy[<span class="st">'zero_frac'</span>] <span class="op">=</span> zero_vol_fy[<span class="st">'n_zero'</span>] <span class="op">/</span> zero_vol_fy[<span class="st">'n_days'</span>]</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Distribution over time (boxplot by year)</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>years_to_plot <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2008</span>, <span class="dv">2025</span>)</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>data_by_year <span class="op">=</span> [</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy[zero_vol_fy[<span class="st">'year'</span>] <span class="op">==</span> y][<span class="st">'zero_frac'</span>].dropna().values</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> years_to_plot</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>bp <span class="op">=</span> axes[<span class="dv">0</span>].boxplot(data_by_year, positions<span class="op">=</span><span class="bu">range</span>(<span class="bu">len</span>(years_to_plot)),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                      widths<span class="op">=</span><span class="fl">0.6</span>, showfliers<span class="op">=</span><span class="va">False</span>, patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>                      medianprops<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'black'</span>})</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> patch <span class="kw">in</span> bp[<span class="st">'boxes'</span>]:</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    patch.set_facecolor(<span class="st">'#2C5F8A'</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    patch.set_alpha(<span class="fl">0.6</span>)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(years_to_plot)))</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels(years_to_plot, rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Zero-Volume Fraction'</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Zero-Volume Days by Year'</span>)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: By market cap decile</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>zero_vol_fy[<span class="st">'mcap_decile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy[<span class="st">'avg_mcap'</span>].rank(method<span class="op">=</span><span class="st">'first'</span>),</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>, labels<span class="op">=</span>[<span class="ss">f'D</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>decile_zero <span class="op">=</span> (</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'mcap_decile'</span>)[<span class="st">'zero_frac'</span>]</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">'mean'</span>, <span class="st">'median'</span>])</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(<span class="bu">range</span>(<span class="dv">10</span>), decile_zero[<span class="st">'mean'</span>],</span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">10</span>))</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels(decile_zero.index)</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Market Cap Decile (D1 = smallest)'</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Mean Zero-Volume Fraction'</span>)</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Zero-Volume Days by Size'</span>)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-zero-trading-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.6
</figcaption>
</figure>
</div>
</section>
<section id="return-measurement-during-zero-trading-periods" class="level3" data-number="13.6.2">
<h3 data-number="13.6.2" class="anchored" data-anchor-id="return-measurement-during-zero-trading-periods"><span class="header-section-number">13.6.2</span> Return Measurement During Zero-Trading Periods</h3>
<p>When a stock does not trade, the standard approach, using the last available closing price, produces a stale price that understates true volatility and biases returns toward zero. Several approaches exist to handle this:</p>
<p><strong>Approach 1: Drop zero-volume observations.</strong> Simple but discards information and introduces selection bias (if non-trading is correlated with returns).</p>
<p><strong>Approach 2: Multi-day compounding.</strong> Accumulate the return over the entire non-trading gap and assign it to the first day of resumption. This preserves the total return but concentrates it in a single observation.</p>
<p><strong>Approach 3: Distribute uniformly.</strong> Spread the accumulated return evenly across zero-volume days. This is economically unrealistic, but it reduces the impact of single-day outliers.</p>
<p><strong>Approach 4: Treat as missing and model.</strong> Treat zero-volume days as genuinely missing returns and use the <span class="citation" data-cites="lesmond2005liquidity">Lesmond (<a href="references.html#ref-lesmond2005liquidity" role="doc-biblioref">2005</a>)</span> zero-return measure as a liquidity proxy.</p>
<div id="zero-vol-correction" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> correct_zero_volume_returns(daily_df, method<span class="op">=</span><span class="st">'compound'</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Correct returns during zero-volume periods.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    method : str</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">        'compound': assign accumulated return to first non-zero day</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">        'distribute': spread return evenly across gap</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'drop': remove zero-volume observations</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> daily_df.copy()</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'daily_return'</span>] <span class="op">=</span> (</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>]</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        .pct_change()</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'drop'</span>:</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df[df[<span class="st">'volume'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'compound'</span>:</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each zero-volume streak, accumulate return and</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign to the next trading day</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> df.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>            accumulated <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>            gap_length <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> idx, row <span class="kw">in</span> group.iterrows():</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> row[<span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>                    accumulated <span class="op">+=</span> row[<span class="st">'daily_return'</span>] <span class="cf">if</span> pd.notna(row[<span class="st">'daily_return'</span>]) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>                    gap_length <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> gap_length <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Add accumulated return to this day's return</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>                        total_return <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> accumulated) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> (row[<span class="st">'daily_return'</span>] <span class="kw">or</span> <span class="dv">0</span>)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>                        group.loc[idx, <span class="st">'daily_return'</span>] <span class="op">=</span> total_return</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>                        accumulated <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>                        gap_length <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>                    results.append(group.loc[idx])</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If series ends with zero-volume days, include last non-zero</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gap_length <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(results) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>                last_valid <span class="op">=</span> results[<span class="op">-</span><span class="dv">1</span>].copy()</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>                last_valid[<span class="st">'daily_return'</span>] <span class="op">=</span> (</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>                    (<span class="dv">1</span> <span class="op">+</span> last_valid[<span class="st">'daily_return'</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> accumulated) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>                results[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> last_valid</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'distribute'</span>:</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> df.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>            i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(group):</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> group.loc[i, <span class="st">'volume'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>                    results.append(group.loc[i])</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>                    i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Find end of zero-volume streak</span></span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>                    j <span class="op">=</span> i</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> j <span class="op">&lt;</span> <span class="bu">len</span>(group) <span class="kw">and</span> group.loc[j, <span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>                        j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Total return over gap</span></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> j <span class="op">&lt;</span> <span class="bu">len</span>(group):</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>                        total_ret <span class="op">=</span> (</span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>                            group.loc[j, <span class="st">'adjusted_close'</span>]</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>                            <span class="op">/</span> group.loc[i <span class="op">-</span> <span class="dv">1</span>, <span class="st">'adjusted_close'</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>                        n_days <span class="op">=</span> j <span class="op">-</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>                        daily_r <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> total_ret) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> n_days) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(i, j <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>                            row <span class="op">=</span> group.loc[k].copy()</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>                            row[<span class="st">'daily_return'</span>] <span class="op">=</span> daily_r</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>                            results.append(row)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a>                    i <span class="op">=</span> j <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply corrections and compare</span></span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> [<span class="st">'drop'</span>, <span class="st">'compound'</span>, <span class="st">'distribute'</span>]:</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>    corrected <span class="op">=</span> correct_zero_volume_returns(</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a>        daily_returns.head(<span class="dv">500000</span>), method<span class="op">=</span>method</span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> corrected[<span class="st">'daily_return'</span>].mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> corrected[<span class="st">'daily_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>method<span class="sc">:&lt;12}</span><span class="ss">: Ann. Return = </span><span class="sc">{</span>mean_ret<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Ann. Vol = </span><span class="sc">{</span>vol<span class="sc">:.4f}</span><span class="ss">, N = </span><span class="sc">{</span><span class="bu">len</span>(corrected)<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-missing-lookahead" class="level2" data-number="13.7">
<h2 data-number="13.7" class="anchored" data-anchor-id="sec-missing-lookahead"><span class="header-section-number">13.7</span> Look-Ahead Bias</h2>
<section id="definition" class="level3" data-number="13.7.1">
<h3 data-number="13.7.1" class="anchored" data-anchor-id="definition"><span class="header-section-number">13.7.1</span> Definition</h3>
<p>Look-ahead bias occurs when a study uses information that was not available at the time the investment decision would have been made. In the Vietnamese context, the most common sources are:</p>
<ol type="1">
<li><strong>Conditioning on survival.</strong> Selecting firms based on their end-of-sample listing status implicitly uses future information (whether the firm will delist).</li>
<li><strong>Using revised financial data.</strong> Vietnamese firms often restate financial statements after audit. Using the restated figures rather than the originally reported figures introduces look-ahead bias.</li>
<li><strong>Backfill bias.</strong> When a database adds a new firm, it may backfill historical data, creating the illusion that the firm was available for selection before its actual listing date.</li>
<li><strong>Point-in-time accounting data.</strong> Using annual financial data as of the fiscal year-end rather than the date the financial statements were publicly filed assumes the data were available immediately.</li>
</ol>
</section>
<section id="point-in-time-adjustment" class="level3" data-number="13.7.2">
<h3 data-number="13.7.2" class="anchored" data-anchor-id="point-in-time-adjustment"><span class="header-section-number">13.7.2</span> Point-in-Time Adjustment</h3>
<p>We implement a point-in-time adjustment for accounting data that respects the actual reporting lag:</p>
<div id="point-in-time" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> point_in_time_merge(monthly_df, fundamentals_df, filings_df,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                         lag_months<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge accounting data with monthly returns respecting</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    the actual filing date (point-in-time).</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame with ticker, month_end</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    fundamentals_df : DataFrame with ticker, fiscal_year, and accounting vars</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    filings_df : DataFrame with ticker, fiscal_year, filing_date</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    lag_months : int, additional safety lag beyond filing date</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge fundamentals with filing dates</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    fund_with_date <span class="op">=</span> fundamentals_df.merge(</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>        filings_df[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>]],</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If filing date is missing, assume available 4 months after FY end</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'filing_date'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'filing_date'</span>]</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'fy_end'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'available_date'</span>] <span class="op">=</span> fund_with_date[<span class="st">'filing_date'</span>].fillna(</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'fy_end'</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add safety lag</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lag_months <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'available_date'</span>] <span class="op">+=</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each firm-month, find the most recent accounting data</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that was available (filing_date &lt;= month_end)</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> monthly_df.iterrows():</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> row[<span class="st">'ticker'</span>]</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> row[<span class="st">'month_end'</span>]</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> fund_with_date[</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>            (fund_with_date[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>            (fund_with_date[<span class="st">'available_date'</span>] <span class="op">&lt;=</span> month)</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            latest <span class="op">=</span> available.sort_values(<span class="st">'fiscal_year'</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> row.to_dict()</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'total_assets'</span>, <span class="st">'net_income'</span>, <span class="st">'total_equity'</span>,</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'revenue'</span>]:</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> col <span class="kw">in</span> latest:</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>                    result[col] <span class="op">=</span> latest[col]</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'data_fiscal_year'</span>] <span class="op">=</span> latest[<span class="st">'fiscal_year'</span>]</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'data_lag_months'</span>] <span class="op">=</span> (</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>                (pd.Timestamp(month) <span class="op">-</span> pd.Timestamp(latest[<span class="st">'available_date'</span>]))</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>                .days <span class="op">/</span> <span class="fl">30.44</span></span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>            results.append(result)</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: compare point-in-time vs naive merge</span></span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>filings <span class="op">=</span> client.get_filings(</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>    report_types<span class="op">=</span>[<span class="st">'annual'</span>],</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>]</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Point-in-time merge vs naive merge:"</span>)</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Naive: use fiscal year directly (introduces look-ahead bias)"</span>)</span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  PIT: use only data available as of the portfolio formation date"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="quantifying-look-ahead-bias-in-value-strategies" class="level3" data-number="13.7.3">
<h3 data-number="13.7.3" class="anchored" data-anchor-id="quantifying-look-ahead-bias-in-value-strategies"><span class="header-section-number">13.7.3</span> Quantifying Look-Ahead Bias in Value Strategies</h3>
<p>Value strategies sort stocks on book-to-market ratios computed from accounting data. Using end-of-fiscal-year data without respecting reporting lags inflates the value premium because it implicitly uses information that was not yet publicly available.</p>
<div id="lookahead-value" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive approach: use fiscal year data immediately</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>monthly_naive <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    fundamentals[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_equity'</span>]],</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_returns[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>],</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>monthly_naive[<span class="st">'bm_naive'</span>] <span class="op">=</span> (</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    monthly_naive[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_naive[<span class="st">'market_cap'</span>]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Point-in-time approach (using 4-month lag as conservative default)</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>monthly_pit <span class="op">=</span> monthly_returns.copy()</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>monthly_pit[<span class="st">'bm_pit'</span>] <span class="op">=</span> np.nan  <span class="co"># Would be filled by point_in_time_merge</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co"># For demonstration: approximate PIT by using t-1 fiscal year data</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co"># (ensures data were available at formation date)</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>fund_lagged <span class="op">=</span> fundamentals.copy()</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>fund_lagged[<span class="st">'merge_year'</span>] <span class="op">=</span> fund_lagged[<span class="st">'fiscal_year'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>monthly_pit <span class="op">=</span> monthly_pit.merge(</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    fund_lagged[[<span class="st">'ticker'</span>, <span class="st">'merge_year'</span>, <span class="st">'total_equity'</span>]].rename(</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'merge_year'</span>: <span class="st">'year'</span>}),</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_pit[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>monthly_pit[<span class="st">'bm_pit'</span>] <span class="op">=</span> (</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    monthly_pit[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_pit[<span class="st">'market_cap'</span>]</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute HML for both approaches</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>hml_naive <span class="op">=</span> compute_long_short(monthly_naive, <span class="st">'bm_naive'</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>hml_pit <span class="op">=</span> compute_long_short(monthly_pit, <span class="st">'bm_pit'</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>ann_naive <span class="op">=</span> hml_naive[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>ann_pit <span class="op">=</span> hml_pit[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Value Premium (HML):"</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Naive (look-ahead):     </span><span class="sc">{</span>ann_naive<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_naive<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Point-in-time:          </span><span class="sc">{</span>ann_pit<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_pit<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Look-ahead inflation:   </span><span class="sc">{</span>(ann_naive <span class="op">-</span> ann_pit)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-missing-transfers" class="level2" data-number="13.8">
<h2 data-number="13.8" class="anchored" data-anchor-id="sec-missing-transfers"><span class="header-section-number">13.8</span> Exchange Transfers and Ticker Discontinuities</h2>
<section id="the-transfer-problem" class="level3" data-number="13.8.1">
<h3 data-number="13.8.1" class="anchored" data-anchor-id="the-transfer-problem"><span class="header-section-number">13.8.1</span> The Transfer Problem</h3>
<p>Vietnamese firms frequently transfer between exchanges (e.g., from HNX to HOSE upon meeting HOSEâ€™s listing requirements, or from HOSE to UPCoM/HNX following regulatory issues). These transfers can break the continuity of return series if the database treats each exchange listing as a separate entity.</p>
<div id="transfers" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>transfers <span class="op">=</span> listing_history[</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    listing_history[<span class="st">'transfer_from'</span>].notna()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total exchange transfers: </span><span class="sc">{</span><span class="bu">len</span>(transfers)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Transfer patterns:"</span>)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>transfer_pattern <span class="op">=</span> transfers.groupby(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'transfer_from'</span>, <span class="st">'transfer_to'</span>]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(transfer_pattern.head(<span class="dv">10</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="link-transfers" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> link_transfer_returns(monthly_df, transfers_df):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Link return series across exchange transfers to create</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    continuous firm-level return histories.</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build mapping: old_ticker -&gt; new_ticker -&gt; transfer_date</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    transfer_map <span class="op">=</span> {}</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> transfers_df.iterrows():</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        old_ticker <span class="op">=</span> row.get(<span class="st">'transfer_from_ticker'</span>, row[<span class="st">'ticker'</span>])</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        new_ticker <span class="op">=</span> row[<span class="st">'ticker'</span>]</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        transfer_date <span class="op">=</span> row[<span class="st">'transfer_date'</span>]</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> old_ticker <span class="kw">and</span> new_ticker <span class="kw">and</span> old_ticker <span class="op">!=</span> new_ticker:</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>            transfer_map[old_ticker] <span class="op">=</span> {</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'new_ticker'</span>: new_ticker,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: transfer_date</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create unified ticker mapping</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> monthly_df.copy()</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'unified_ticker'</span>] <span class="op">=</span> df[<span class="st">'ticker'</span>]</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> old_t, info <span class="kw">in</span> transfer_map.items():</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'ticker'</span>] <span class="op">==</span> old_t) <span class="op">&amp;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'month_end'</span>] <span class="op">&lt;</span> info[<span class="st">'date'</span>])</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">'unified_ticker'</span>] <span class="op">=</span> info[<span class="st">'new_ticker'</span>]</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    n_linked <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> t <span class="kw">in</span> transfer_map <span class="cf">if</span> t <span class="kw">in</span> df[<span class="st">'ticker'</span>].values)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Linked </span><span class="sc">{</span>n_linked<span class="sc">}</span><span class="ss"> transfer pairs"</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>linked <span class="op">=</span> link_transfer_returns(monthly_returns, transfers)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-missing-sensitivity" class="level2" data-number="13.9">
<h2 data-number="13.9" class="anchored" data-anchor-id="sec-missing-sensitivity"><span class="header-section-number">13.9</span> Sensitivity Analysis Framework</h2>
<section id="how-fragile-are-your-results" class="level3" data-number="13.9.1">
<h3 data-number="13.9.1" class="anchored" data-anchor-id="how-fragile-are-your-results"><span class="header-section-number">13.9.1</span> How Fragile Are Your Results?</h3>
<p>Rather than choosing a single approach to handle missing data, a robust study tests how sensitive its conclusions are to different assumptions. We implement a systematic sensitivity framework that re-runs a given analysis under multiple data treatment assumptions.</p>
<div id="sensitivity-framework" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sensitivity_analysis(monthly_df, listing_df, sort_variable,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                          compute_fn):</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Run an analysis under multiple data treatment assumptions.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : Full monthly return panel (including delisted)</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    listing_df : Listing history with delisting info</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    sort_variable : Column name for portfolio sorting</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    compute_fn : Function that takes a DataFrame and returns a</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">                 scalar (e.g., annualized long-short return)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with results under each assumption</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    survivors <span class="op">=</span> <span class="bu">set</span>(listing_df[listing_df[<span class="st">'is_active'</span>]][<span class="st">'ticker'</span>])</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Survivors only (maximum bias)</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    surv_only <span class="op">=</span> monthly_df[monthly_df[<span class="st">'ticker'</span>].isin(survivors)]</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Survivors Only'</span>] <span class="op">=</span> compute_fn(surv_only, sort_variable)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Full sample, no delisting imputation</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full Sample (no imputation)'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        monthly_df, sort_variable</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Full sample + conservative delisting imputation (-50%)</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    augmented_50 <span class="op">=</span> monthly_df.copy()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append imputed returns at -50%</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].iterrows():</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(firm.get(<span class="st">'reason_category'</span>, <span class="st">''</span>)):</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            augmented_50 <span class="op">=</span> pd.concat([augmented_50, pd.DataFrame([{</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: firm[<span class="st">'ticker'</span>],</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">'month_end'</span>: firm[<span class="st">'delisting_date'</span>],</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">'monthly_return'</span>: <span class="op">-</span><span class="fl">0.50</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>                <span class="st">'market_cap'</span>: np.nan,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>                sort_variable: np.nan</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>            }])], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full + Impute -50%'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        augmented_50, sort_variable</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Full sample + aggressive delisting imputation (-100%)</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    augmented_100 <span class="op">=</span> monthly_df.copy()</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].iterrows():</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(firm.get(<span class="st">'reason_category'</span>, <span class="st">''</span>)):</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            augmented_100 <span class="op">=</span> pd.concat([augmented_100, pd.DataFrame([{</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: firm[<span class="st">'ticker'</span>],</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>                <span class="st">'month_end'</span>: firm[<span class="st">'delisting_date'</span>],</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>                <span class="st">'monthly_return'</span>: <span class="op">-</span><span class="fl">1.00</span>,</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">'market_cap'</span>: np.nan,</span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>                sort_variable: np.nan</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            }])], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full + Impute -100%'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>        augmented_100, sort_variable</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Exclude bottom market cap quintile (liquidity filter)</span></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    liquid <span class="op">=</span> monthly_df.copy()</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>    liquid[<span class="st">'mcap_quintile'</span>] <span class="op">=</span> (</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a>        liquid.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>        .transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span>))</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>    liquid <span class="op">=</span> liquid[liquid[<span class="st">'mcap_quintile'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Exclude Bottom Quintile'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>        liquid, sort_variable</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame.from_dict(results, orient<span class="op">=</span><span class="st">'index'</span>,</span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>                                   columns<span class="op">=</span>[<span class="st">'Result'</span>])</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: sensitivity of size premium</span></span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_size_premium(df, sort_var):</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> compute_long_short(df, sort_var, n_quantiles<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ls[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span> <span class="cf">if</span> <span class="bu">len</span>(ls) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Would need sort variable in the data; illustrative call:</span></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a><span class="co"># sensitivity_results = sensitivity_analysis(</span></span>
<span id="cb19-82"><a href="#cb19-82" aria-hidden="true" tabindex="-1"></a><span class="co">#     monthly_with_chars, listing_history, 'log_mcap',</span></span>
<span id="cb19-83"><a href="#cb19-83" aria-hidden="true" tabindex="-1"></a><span class="co">#     compute_size_premium</span></span>
<span id="cb19-84"><a href="#cb19-84" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-sensitivity" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="20">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sensitivity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Illustrative: create synthetic sensitivity results for plotting</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>assumptions <span class="op">=</span> [</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Survivors Only'</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full Sample</span><span class="ch">\n</span><span class="st">(no imputation)'</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -30%'</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -50%'</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -100%'</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Exclude Bottom</span><span class="ch">\n</span><span class="st">Mcap Quintile'</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Hypothetical results (would be computed from actual data)</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>size_premium <span class="op">=</span> [<span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.055</span>, <span class="fl">0.05</span>, <span class="fl">0.04</span>, <span class="fl">0.07</span>]</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>value_premium <span class="op">=</span> [<span class="fl">0.07</span>, <span class="fl">0.065</span>, <span class="fl">0.063</span>, <span class="fl">0.06</span>, <span class="fl">0.055</span>, <span class="fl">0.068</span>]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>momentum_premium <span class="op">=</span> [<span class="fl">0.10</span>, <span class="fl">0.08</span>, <span class="fl">0.075</span>, <span class="fl">0.07</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(assumptions))</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>ax.bar(x <span class="op">-</span> width, [s <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> s <span class="kw">in</span> size_premium], width,</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Size (SMB)'</span>)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>ax.bar(x, [v <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> v <span class="kw">in</span> value_premium], width,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Value (HML)'</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>ax.bar(x <span class="op">+</span> width, [m <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> m <span class="kw">in</span> momentum_premium], width,</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#E67E22'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Momentum (WML)'</span>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(assumptions, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Annualized Premium (%)'</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomaly Premium Sensitivity to Data Treatment'</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-sensitivity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;13.7
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-missing-recommendations" class="level2" data-number="13.10">
<h2 data-number="13.10" class="anchored" data-anchor-id="sec-missing-recommendations"><span class="header-section-number">13.10</span> Practical Recommendations</h2>
<p>Based on the analysis in this chapter, we offer the following recommendations for researchers working with Vietnamese equity data:</p>
<p><strong>1. Always use survivorship-bias-free databases.</strong> When querying DataCore.vn (or any database), explicitly request <code>include_delisted=True</code>. Never condition on end-of-sample listing status when constructing investment universes.</p>
<p><strong>2. Impute delisting returns.</strong> For involuntary delistings (financial distress, regulatory enforcement), impute a terminal return of âˆ’30% to âˆ’50% in the delisting month. Report results across a range of imputation assumptions as a robustness check. For voluntary delistings and exchange transfers, impute 0%.</p>
<p><strong>3. Respect point-in-time data availability.</strong> Use accounting data only after its public filing date, not as of the fiscal year-end. In Vietnam, the standard lag is 90 days for annual reports; use a conservative 4â€“6 month lag.</p>
<p><strong>4. Handle zero-volume days explicitly.</strong> Document the prevalence of zero-volume days in your sample. For monthly returns, report the average number of zero-volume days per firm-month. Consider excluding firms with zero-volume fractions exceeding 50% from the investable universe.</p>
<p><strong>5. Link exchange transfers.</strong> Use unified tickers that link pre-transfer and post-transfer series. Without this, exchange transfers appear as simultaneous delistings and new listings, inflating turnover and biasing survival calculations.</p>
<p><strong>6. Report sensitivity analysis.</strong> For any key finding, report results under at least three data treatment assumptions: survivors-only (upper bound), full sample with moderate imputation (baseline), and full sample with aggressive imputation plus liquidity filter (lower bound). If the finding survives all three, it is robust.</p>
<p><strong>7. Be especially cautious with pre-2007 data.</strong> The Vietnamese market had fewer than 100 listings before 2006, and the equitization wave of 2006-2009 produced a cohort of firms with systematically different characteristics than earlier listings. Cross-sectional tests with pre-2007 data have minimal power and should be interpreted with extreme caution.</p>
</section>
<section id="sec-missing-summary" class="level2" data-number="13.11">
<h2 data-number="13.11" class="anchored" data-anchor-id="sec-missing-summary"><span class="header-section-number">13.11</span> Summary</h2>
<div id="tbl-missing-summary" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-missing-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;13.3: Summary of data problems, their effects, and recommended corrections.
</figcaption>
<div aria-describedby="tbl-missing-summary-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
<col style="width: 25%">
</colgroup>
<thead>
<tr class="header">
<th>Data Problem</th>
<th>Bias Direction</th>
<th>Magnitude (Vietnam)</th>
<th>Recommended Fix</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Survivorship bias (EW)</td>
<td>Upward on returns</td>
<td>~1-3% per year</td>
<td>Include all delisted firms</td>
</tr>
<tr class="even">
<td>Survivorship bias (VW)</td>
<td>Upward (smaller)</td>
<td>~0.2-0.5% per year</td>
<td>Include all delisted firms</td>
</tr>
<tr class="odd">
<td>Delisting return bias</td>
<td>Upward on returns</td>
<td>~0.5â€“2% per year (EW)</td>
<td>Impute terminal returns</td>
</tr>
<tr class="even">
<td>Look-ahead bias</td>
<td>Inflates predictability</td>
<td>Varies by strategy</td>
<td>Point-in-time data alignment</td>
</tr>
<tr class="odd">
<td>Zero-trading days</td>
<td>Understates volatility</td>
<td>Severe for small caps</td>
<td>Compound or drop; document</td>
</tr>
<tr class="even">
<td>Exchange transfers</td>
<td>Creates false delistings</td>
<td>~50-100 firms</td>
<td>Link unified tickers</td>
</tr>
<tr class="odd">
<td>New-listing bias</td>
<td>Early sample unrepresentative</td>
<td>Extreme pre-2007</td>
<td>Start sample after 2007</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>The central message is that data problems in Vietnamese equity research are not merely a nuisanceâ€“they can create economically significant biases that alter the conclusions of empirical studies. The survivorship bias alone exceeds 100 basis points per year for equal-weighted portfolios, comparable to many documented anomaly premia. Researchers who ignore these issues risk reporting results that reflect data artifacts rather than genuine economic phenomena.</p>
<!-- ## Exercises {#sec-missing-exercises}

1. **Delisting return estimation from final prices.** For a sample of delisted Vietnamese firms, obtain the last 60 trading days of price data before delisting. Compute the cumulative return over this window. What is the average "run-up to delisting" return? Does it vary by delisting reason?

2. **Survivorship bias in fund performance.** Vietnamese open-ended mutual funds also experience survivorship bias (poorly performing funds are closed or merged). Using DataCore.vn's fund data, compare average fund returns in a survivorship-bias-free sample versus a survivors-only sample. How does the bias compare to @rohleder2011survivorship's findings for U.S. funds?

3. **Heckman selection correction.** Implement the @heckman1979sample two-step correction for survivorship bias. In the first stage, estimate a probit model for the probability of delisting. In the second stage, include the inverse Mills ratio as a control variable in cross-sectional return regressions. Does the correction materially change the estimated size or value premia?

4. **Multiple imputation.** Instead of a single imputed delisting return, implement a multiple imputation procedure: draw the delisting return from a distribution calibrated to observed terminal returns of similar firms. Repeat the analysis 100 times and report the distribution of results. How does parameter uncertainty from imputation compare to sampling uncertainty?

5. **Backfill bias detection.** Identify firms in the DataCore.vn database where historical data appears before the official listing date. What fraction of firms exhibit this pattern? Does excluding backfilled observations change the estimated size premium?

6. **Zero-volume and momentum.** Test whether the momentum anomaly is affected by the treatment of zero-volume days. Specifically, do zero-volume days create spurious autocorrelation in individual stock returns that inflates the apparent momentum premium?

7. **Real-time delisting monitor.** Design a scoring model that predicts involuntary delisting 6--12 months in advance using financial ratios, trading activity, and governance indicators. What is the model's predictive accuracy? How would a portfolio that screens out high-delisting-risk firms perform relative to an unscreened benchmark?

8. **Cross-country comparison.** Compare the survivorship bias magnitude in Vietnam to estimates for the U.S. [@shumway1997delisting], other ASEAN markets, and China. What institutional features explain cross-country differences in the severity of survivorship bias? -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-lesmond2005liquidity" class="csl-entry" role="listitem">
Lesmond, David A. 2005. <span>â€œLiquidity of Emerging Markets.â€</span> <em>Journal of Financial Economics</em> 77 (2): 411â€“52.
</div>
<div id="ref-little2019statistical" class="csl-entry" role="listitem">
Little, Roderick JA, and Donald B Rubin. 2019. <em>Statistical Analysis with Missing Data</em>. John Wiley &amp; Sons.
</div>
<div id="ref-rubin1976inference" class="csl-entry" role="listitem">
Rubin, Donald B. 1976. <span>â€œInference and Missing Data.â€</span> <em>Biometrika</em> 63 (3): 581â€“92.
</div>
<div id="ref-shumway1997delisting" class="csl-entry" role="listitem">
Shumway, Tyler. 1997. <span>â€œThe Delisting Bias in CRSP Data.â€</span> <em>The Journal of Finance</em> 52 (1): 327â€“40.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "Â© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./14_portfolio_weighting_and_rebalancing.html" class="pagination-link" aria-label="Portfolio Weighting and Rebalancing">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./16_liquidity_and_turnover_measures.html" class="pagination-link" aria-label="Liquidity and Turnover Measures">
        <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Missing Data and Survivorship Bias</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>In this chapter, we document the patterns of missing data, survivorship bias, and delisting bias in Vietnamese equity markets, develop diagnostic tools to detect these problems, and implement correction methods that yield more reliable empirical results.</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>Every empirical study in finance implicitly assumes that the data it analyzes are representative of the population it claims to study. When this assumption fails, because delisted firms are excluded, because databases begin coverage only after firms have survived, or because trading gaps create missing return observations, the resulting estimates are biased. In the U.S. context, @shumway1997delisting showed that ignoring delisting returns biases average returns upward by approximately 1% per year for NYSE stocks and substantially more for Nasdaq stocks, with severe consequences for anomaly-based strategies that overweight small, distressed firms.</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>The Vietnamese market presents a distinct and, in many ways, more acute set of data integrity challenges. The market is young. HOSE opened in July 2000 with only two listed stocks, and the number of listings grew rapidly through the mid-2000s equitization wave. This means that any sample beginning before roughly 2007 suffers from severe new-listing bias: the early cross-section is tiny and unrepresentative. Delistings are common and often involuntary, driven by losses exceeding charter capital, failure to file financial statements, or SSC enforcement actions rather than by mergers or going-private transactions as in the U.S. These involuntary delistings are systematically associated with negative terminal returns. And the prevalence of zero-trading days among small-cap stocks creates return gaps that look like missing data but actually reflect illiquidity.</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>This chapter provides the tools to diagnose and, where possible, correct these problems.</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## Taxonomy of Data Problems {#sec-missing-taxonomy}</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>Missing data in financial research is not monolithic. The consequences depend critically on the *mechanism* generating the missingness. @rubin1976inference and @little2019statistical classify missing data into three types:</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Missing Completely at Random (MCAR).** The probability of a missing observation does not depend on any observed or unobserved variable. Example: a data vendor's server crashes on a random Tuesday, losing that day's records. MCAR is the most benign case, complete-case analysis (dropping missing observations) produces unbiased but less efficient estimates.</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Missing at Random (MAR).** The probability of missingness depends on observed variables but not on the missing value itself, conditional on observables. Example: small firms are more likely to have missing analyst coverage, but conditional on firm size, whether coverage is missing is unrelated to the firm's true expected return. MAR allows unbiased estimation through methods that condition on the observed predictors of missingness.</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Missing Not at Random (MNAR).** The probability of missingness depends on the missing value itself. Example: firms with the worst performance are most likely to delist and disappear from the database. MNAR is a pathological case and, unfortunately, the most common in financial data. Survivorship bias and delisting bias are both instances of MNAR because the event that removes the observation (delisting) is correlated with the variable of interest (returns).</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>In the Vietnamese context, we encounter all three types, often simultaneously (@tbl-missing-taxonomy).</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Data Problem <span class="pp">|</span> Missingness Type <span class="pp">|</span> Mechanism in Vietnam <span class="pp">|</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------------|------------------------|------------------------|</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Zero-trading days <span class="pp">|</span> MAR/MNAR <span class="pp">|</span> Small/illiquid stocks; correlated with returns <span class="pp">|</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Price limit hits <span class="pp">|</span> MNAR <span class="pp">|</span> True return truncated at limit; observed return censored <span class="pp">|</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Delisting <span class="pp">|</span> MNAR <span class="pp">|</span> Worst-performing firms exit; returns disappear <span class="pp">|</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Late listing coverage <span class="pp">|</span> Selection bias <span class="pp">|</span> Database begins after firm survives initial period <span class="pp">|</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Exchange transfers <span class="pp">|</span> Administrative <span class="pp">|</span> HOSEâ†’HNX or UPCoM transfers break ticker continuity <span class="pp">|</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Suspended trading <span class="pp">|</span> MNAR <span class="pp">|</span> Suspension precedes negative events; returns missing <span class="pp">|</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>: Taxonomy of missing data in Vietnamese equity databases {#tbl-missing-taxonomy}</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Construction {#sec-missing-data}</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure environment"</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-load</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load comprehensive listing, delisting, and return data"</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Complete listing history: includes all firms ever listed, not just current</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>listing_history <span class="op">=</span> client.get_listing_history(</span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'company_name'</span>, <span class="st">'exchange'</span>, <span class="st">'listing_date'</span>,</span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">'delisting_date'</span>, <span class="st">'delisting_reason'</span>, <span class="st">'is_active'</span>,</span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">'transfer_from'</span>, <span class="st">'transfer_to'</span>, <span class="st">'transfer_date'</span>,</span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ipo_date'</span>, <span class="st">'equitization_date'</span>, <span class="st">'sector'</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily returns: includes delisted firms' full history</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>daily_returns <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2000-07-28'</span>,   <span class="co"># HOSE opening date</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,      <span class="co"># Critical flag</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'close'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>,</span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">'turnover_value'</span>, <span class="st">'market_cap'</span>, <span class="st">'shares_outstanding'</span>,</span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">'price_limit_hit'</span>       <span class="co"># +1 = limit up, -1 = limit down, 0 = neither</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (pre-computed, survivorship-bias-free)</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2000-07-28'</span>,</span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">'volume_avg_20d'</span>, <span class="st">'n_trading_days'</span>, <span class="st">'n_zero_volume_days'</span></span>
<span id="cb21-105"><a href="#cb21-105" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-106"><a href="#cb21-106" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-107"><a href="#cb21-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-108"><a href="#cb21-108" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Listing history: </span><span class="sc">{</span>listing_history<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> firms"</span>)</span>
<span id="cb21-109"><a href="#cb21-109" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Active: </span><span class="sc">{</span>listing_history[<span class="st">'is_active'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-110"><a href="#cb21-110" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Delisted: </span><span class="sc">{</span>(<span class="op">~</span>listing_history[<span class="st">'is_active'</span>])<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-111"><a href="#cb21-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Daily observations: </span><span class="sc">{</span>daily_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-112"><a href="#cb21-112" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly observations: </span><span class="sc">{</span>monthly_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-113"><a href="#cb21-113" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-114"><a href="#cb21-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-115"><a href="#cb21-115" aria-hidden="true" tabindex="-1"></a><span class="fu">## Listing Dynamics in Vietnam {#sec-missing-listing-dynamics}</span></span>
<span id="cb21-116"><a href="#cb21-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-117"><a href="#cb21-117" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Growth of the Vietnamese Market</span></span>
<span id="cb21-118"><a href="#cb21-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-119"><a href="#cb21-119" aria-hidden="true" tabindex="-1"></a>The Vietnamese stock market's short history creates a distinctive pattern: the investable universe has grown from near-zero to over 1,500 listed firms in approximately two decades. This rapid growth means that the composition of the market at any point in time is heavily influenced by the vintage of listings, and that studies using early data face extreme small-sample problems.</span>
<span id="cb21-120"><a href="#cb21-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-123"><a href="#cb21-123" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-124"><a href="#cb21-124" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-listing-growth</span></span>
<span id="cb21-125"><a href="#cb21-125" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-126"><a href="#cb21-126" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Evolution of the Vietnamese listed equity universe. Panel A shows the number of active listings on each exchange over time. Panel B shows the annual flow of new listings and delistings. The equitization wave of 2006--2009 produced a surge of IPOs, many of which subsequently delisted during the market downturn."</span></span>
<span id="cb21-127"><a href="#cb21-127" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot the growth of the Vietnamese listed universe"</span></span>
<span id="cb21-128"><a href="#cb21-128" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'listing_date'</span>] <span class="op">=</span> pd.to_datetime(listing_history[<span class="st">'listing_date'</span>])</span>
<span id="cb21-129"><a href="#cb21-129" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'delisting_date'</span>] <span class="op">=</span> pd.to_datetime(listing_history[<span class="st">'delisting_date'</span>])</span>
<span id="cb21-130"><a href="#cb21-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-131"><a href="#cb21-131" aria-hidden="true" tabindex="-1"></a><span class="co"># Count active listings at each month-end</span></span>
<span id="cb21-132"><a href="#cb21-132" aria-hidden="true" tabindex="-1"></a>months <span class="op">=</span> pd.date_range(<span class="st">'2000-07-01'</span>, <span class="st">'2024-12-31'</span>, freq<span class="op">=</span><span class="st">'M'</span>)</span>
<span id="cb21-133"><a href="#cb21-133" aria-hidden="true" tabindex="-1"></a>active_counts <span class="op">=</span> []</span>
<span id="cb21-134"><a href="#cb21-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-135"><a href="#cb21-135" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> month <span class="kw">in</span> months:</span>
<span id="cb21-136"><a href="#cb21-136" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> exchange <span class="kw">in</span> [<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>]:</span>
<span id="cb21-137"><a href="#cb21-137" aria-hidden="true" tabindex="-1"></a>        active <span class="op">=</span> listing_history[</span>
<span id="cb21-138"><a href="#cb21-138" aria-hidden="true" tabindex="-1"></a>            (listing_history[<span class="st">'exchange'</span>] <span class="op">==</span> exchange) <span class="op">&amp;</span></span>
<span id="cb21-139"><a href="#cb21-139" aria-hidden="true" tabindex="-1"></a>            (listing_history[<span class="st">'listing_date'</span>] <span class="op">&lt;=</span> month) <span class="op">&amp;</span></span>
<span id="cb21-140"><a href="#cb21-140" aria-hidden="true" tabindex="-1"></a>            ((listing_history[<span class="st">'delisting_date'</span>].isna()) <span class="op">|</span></span>
<span id="cb21-141"><a href="#cb21-141" aria-hidden="true" tabindex="-1"></a>             (listing_history[<span class="st">'delisting_date'</span>] <span class="op">&gt;</span> month))</span>
<span id="cb21-142"><a href="#cb21-142" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb21-143"><a href="#cb21-143" aria-hidden="true" tabindex="-1"></a>        active_counts.append({</span>
<span id="cb21-144"><a href="#cb21-144" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month'</span>: month,</span>
<span id="cb21-145"><a href="#cb21-145" aria-hidden="true" tabindex="-1"></a>            <span class="st">'exchange'</span>: exchange,</span>
<span id="cb21-146"><a href="#cb21-146" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_active'</span>: <span class="bu">len</span>(active)</span>
<span id="cb21-147"><a href="#cb21-147" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-148"><a href="#cb21-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-149"><a href="#cb21-149" aria-hidden="true" tabindex="-1"></a>active_df <span class="op">=</span> pd.DataFrame(active_counts)</span>
<span id="cb21-150"><a href="#cb21-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-151"><a href="#cb21-151" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-152"><a href="#cb21-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-153"><a href="#cb21-153" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Active listings over time</span></span>
<span id="cb21-154"><a href="#cb21-154" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> exchange, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'HNX'</span>, <span class="st">'#E67E22'</span>),</span>
<span id="cb21-155"><a href="#cb21-155" aria-hidden="true" tabindex="-1"></a>                         (<span class="st">'UPCoM'</span>, <span class="st">'#27AE60'</span>)]:</span>
<span id="cb21-156"><a href="#cb21-156" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> active_df[active_df[<span class="st">'exchange'</span>] <span class="op">==</span> exchange]</span>
<span id="cb21-157"><a href="#cb21-157" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(subset[<span class="st">'month'</span>], subset[<span class="st">'n_active'</span>],</span>
<span id="cb21-158"><a href="#cb21-158" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span>exchange)</span>
<span id="cb21-159"><a href="#cb21-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-160"><a href="#cb21-160" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb21-161"><a href="#cb21-161" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Active Listings'</span>)</span>
<span id="cb21-162"><a href="#cb21-162" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Active Listings by Exchange'</span>)</span>
<span id="cb21-163"><a href="#cb21-163" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb21-164"><a href="#cb21-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-165"><a href="#cb21-165" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Annual listings and delistings</span></span>
<span id="cb21-166"><a href="#cb21-166" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'listing_year'</span>] <span class="op">=</span> listing_history[<span class="st">'listing_date'</span>].dt.year</span>
<span id="cb21-167"><a href="#cb21-167" aria-hidden="true" tabindex="-1"></a>listing_history[<span class="st">'delisting_year'</span>] <span class="op">=</span> listing_history[<span class="st">'delisting_date'</span>].dt.year</span>
<span id="cb21-168"><a href="#cb21-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-169"><a href="#cb21-169" aria-hidden="true" tabindex="-1"></a>annual_listings <span class="op">=</span> (</span>
<span id="cb21-170"><a href="#cb21-170" aria-hidden="true" tabindex="-1"></a>    listing_history</span>
<span id="cb21-171"><a href="#cb21-171" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'listing_year'</span>)</span>
<span id="cb21-172"><a href="#cb21-172" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb21-173"><a href="#cb21-173" aria-hidden="true" tabindex="-1"></a>    .reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-174"><a href="#cb21-174" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-175"><a href="#cb21-175" aria-hidden="true" tabindex="-1"></a>annual_delistings <span class="op">=</span> (</span>
<span id="cb21-176"><a href="#cb21-176" aria-hidden="true" tabindex="-1"></a>    listing_history</span>
<span id="cb21-177"><a href="#cb21-177" aria-hidden="true" tabindex="-1"></a>    .dropna(subset<span class="op">=</span>[<span class="st">'delisting_year'</span>])</span>
<span id="cb21-178"><a href="#cb21-178" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'delisting_year'</span>)</span>
<span id="cb21-179"><a href="#cb21-179" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb21-180"><a href="#cb21-180" aria-hidden="true" tabindex="-1"></a>    .reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-181"><a href="#cb21-181" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-182"><a href="#cb21-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-183"><a href="#cb21-183" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="dv">2000</span>, <span class="dv">2025</span>)</span>
<span id="cb21-184"><a href="#cb21-184" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x <span class="op">-</span> <span class="fl">0.2</span>, annual_listings.values, width<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb21-185"><a href="#cb21-185" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'New Listings'</span>)</span>
<span id="cb21-186"><a href="#cb21-186" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(x <span class="op">+</span> <span class="fl">0.2</span>, annual_delistings.values, width<span class="op">=</span><span class="fl">0.4</span>,</span>
<span id="cb21-187"><a href="#cb21-187" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Delistings'</span>)</span>
<span id="cb21-188"><a href="#cb21-188" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb21-189"><a href="#cb21-189" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Firms'</span>)</span>
<span id="cb21-190"><a href="#cb21-190" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Annual Listings and Delistings'</span>)</span>
<span id="cb21-191"><a href="#cb21-191" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb21-192"><a href="#cb21-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-193"><a href="#cb21-193" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-194"><a href="#cb21-194" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-195"><a href="#cb21-195" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-196"><a href="#cb21-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-197"><a href="#cb21-197" aria-hidden="true" tabindex="-1"></a><span class="fu">### Delisting Reasons</span></span>
<span id="cb21-198"><a href="#cb21-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-199"><a href="#cb21-199" aria-hidden="true" tabindex="-1"></a>Vietnamese delistings are not homogeneous. The SSC mandates delisting for specific regulatory violations, but firms may also voluntarily delist, merge, or transfer between exchanges. The reason for delisting matters because it determines the likely terminal return.</span>
<span id="cb21-200"><a href="#cb21-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-203"><a href="#cb21-203" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-204"><a href="#cb21-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delisting-reasons</span></span>
<span id="cb21-205"><a href="#cb21-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-206"><a href="#cb21-206" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Categorize and tabulate delisting reasons"</span></span>
<span id="cb21-207"><a href="#cb21-207" aria-hidden="true" tabindex="-1"></a>delisted <span class="op">=</span> listing_history[listing_history[<span class="st">'delisting_date'</span>].notna()].copy()</span>
<span id="cb21-208"><a href="#cb21-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-209"><a href="#cb21-209" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize delisting reasons into categories</span></span>
<span id="cb21-210"><a href="#cb21-210" aria-hidden="true" tabindex="-1"></a>reason_map <span class="op">=</span> {</span>
<span id="cb21-211"><a href="#cb21-211" aria-hidden="true" tabindex="-1"></a>    <span class="st">'losses_exceed_charter'</span>: <span class="st">'Involuntary - Financial Distress'</span>,</span>
<span id="cb21-212"><a href="#cb21-212" aria-hidden="true" tabindex="-1"></a>    <span class="st">'bankruptcy'</span>: <span class="st">'Involuntary - Financial Distress'</span>,</span>
<span id="cb21-213"><a href="#cb21-213" aria-hidden="true" tabindex="-1"></a>    <span class="st">'failure_to_file'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb21-214"><a href="#cb21-214" aria-hidden="true" tabindex="-1"></a>    <span class="st">'audit_qualification'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb21-215"><a href="#cb21-215" aria-hidden="true" tabindex="-1"></a>    <span class="st">'ssc_enforcement'</span>: <span class="st">'Involuntary - Regulatory'</span>,</span>
<span id="cb21-216"><a href="#cb21-216" aria-hidden="true" tabindex="-1"></a>    <span class="st">'merger'</span>: <span class="st">'Voluntary - M&amp;A'</span>,</span>
<span id="cb21-217"><a href="#cb21-217" aria-hidden="true" tabindex="-1"></a>    <span class="st">'going_private'</span>: <span class="st">'Voluntary - Going Private'</span>,</span>
<span id="cb21-218"><a href="#cb21-218" aria-hidden="true" tabindex="-1"></a>    <span class="st">'transfer_exchange'</span>: <span class="st">'Transfer'</span>,</span>
<span id="cb21-219"><a href="#cb21-219" aria-hidden="true" tabindex="-1"></a>    <span class="st">'voluntary'</span>: <span class="st">'Voluntary - Other'</span>,</span>
<span id="cb21-220"><a href="#cb21-220" aria-hidden="true" tabindex="-1"></a>    <span class="st">'other'</span>: <span class="st">'Other/Unknown'</span></span>
<span id="cb21-221"><a href="#cb21-221" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb21-222"><a href="#cb21-222" aria-hidden="true" tabindex="-1"></a>delisted[<span class="st">'reason_category'</span>] <span class="op">=</span> (</span>
<span id="cb21-223"><a href="#cb21-223" aria-hidden="true" tabindex="-1"></a>    delisted[<span class="st">'delisting_reason'</span>]</span>
<span id="cb21-224"><a href="#cb21-224" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">map</span>(reason_map)</span>
<span id="cb21-225"><a href="#cb21-225" aria-hidden="true" tabindex="-1"></a>    .fillna(<span class="st">'Other/Unknown'</span>)</span>
<span id="cb21-226"><a href="#cb21-226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-227"><a href="#cb21-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-228"><a href="#cb21-228" aria-hidden="true" tabindex="-1"></a><span class="co"># Tabulate</span></span>
<span id="cb21-229"><a href="#cb21-229" aria-hidden="true" tabindex="-1"></a>reason_counts <span class="op">=</span> (</span>
<span id="cb21-230"><a href="#cb21-230" aria-hidden="true" tabindex="-1"></a>    delisted[<span class="st">'reason_category'</span>]</span>
<span id="cb21-231"><a href="#cb21-231" aria-hidden="true" tabindex="-1"></a>    .value_counts()</span>
<span id="cb21-232"><a href="#cb21-232" aria-hidden="true" tabindex="-1"></a>    .to_frame(<span class="st">'Count'</span>)</span>
<span id="cb21-233"><a href="#cb21-233" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-234"><a href="#cb21-234" aria-hidden="true" tabindex="-1"></a>reason_counts[<span class="st">'Percentage'</span>] <span class="op">=</span> (</span>
<span id="cb21-235"><a href="#cb21-235" aria-hidden="true" tabindex="-1"></a>    reason_counts[<span class="st">'Count'</span>] <span class="op">/</span> reason_counts[<span class="st">'Count'</span>].<span class="bu">sum</span>() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb21-236"><a href="#cb21-236" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-237"><a href="#cb21-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-238"><a href="#cb21-238" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Delisting Reasons:"</span>)</span>
<span id="cb21-239"><a href="#cb21-239" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(reason_counts.<span class="bu">round</span>(<span class="dv">1</span>).to_string())</span>
<span id="cb21-240"><a href="#cb21-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-241"><a href="#cb21-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-244"><a href="#cb21-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-245"><a href="#cb21-245" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-delisting-reasons</span></span>
<span id="cb21-246"><a href="#cb21-246" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-247"><a href="#cb21-247" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of delisting reasons for Vietnamese listed firms. Unlike the U.S. market where M&amp;A-driven delistings dominate, Vietnamese delistings are disproportionately involuntary, driven by financial distress and regulatory enforcement. This composition makes delisting bias more severe because involuntary delistings are associated with large negative terminal returns."</span></span>
<span id="cb21-248"><a href="#cb21-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize delisting reasons"</span></span>
<span id="cb21-249"><a href="#cb21-249" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-250"><a href="#cb21-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-251"><a href="#cb21-251" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Pie chart</span></span>
<span id="cb21-252"><a href="#cb21-252" aria-hidden="true" tabindex="-1"></a>colors_pie <span class="op">=</span> [<span class="st">'#C0392B'</span>, <span class="st">'#E74C3C'</span>, <span class="st">'#8E44AD'</span>, <span class="st">'#27AE60'</span>,</span>
<span id="cb21-253"><a href="#cb21-253" aria-hidden="true" tabindex="-1"></a>              <span class="st">'#2C5F8A'</span>, <span class="st">'#F1C40F'</span>, <span class="st">'#BDC3C7'</span>]</span>
<span id="cb21-254"><a href="#cb21-254" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].pie(reason_counts[<span class="st">'Count'</span>], labels<span class="op">=</span>reason_counts.index,</span>
<span id="cb21-255"><a href="#cb21-255" aria-hidden="true" tabindex="-1"></a>            colors<span class="op">=</span>colors_pie[:<span class="bu">len</span>(reason_counts)],</span>
<span id="cb21-256"><a href="#cb21-256" aria-hidden="true" tabindex="-1"></a>            autopct<span class="op">=</span><span class="st">'%1.0f</span><span class="sc">%%</span><span class="st">'</span>, startangle<span class="op">=</span><span class="dv">90</span>, textprops<span class="op">=</span>{<span class="st">'fontsize'</span>: <span class="dv">8</span>})</span>
<span id="cb21-257"><a href="#cb21-257" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Delisting Reasons'</span>)</span>
<span id="cb21-258"><a href="#cb21-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-259"><a href="#cb21-259" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Delisting reasons over time</span></span>
<span id="cb21-260"><a href="#cb21-260" aria-hidden="true" tabindex="-1"></a>delisted[<span class="st">'year'</span>] <span class="op">=</span> delisted[<span class="st">'delisting_date'</span>].dt.year</span>
<span id="cb21-261"><a href="#cb21-261" aria-hidden="true" tabindex="-1"></a>reason_by_year <span class="op">=</span> pd.crosstab(delisted[<span class="st">'year'</span>], delisted[<span class="st">'reason_category'</span>])</span>
<span id="cb21-262"><a href="#cb21-262" aria-hidden="true" tabindex="-1"></a>reason_by_year <span class="op">=</span> reason_by_year.reindex(<span class="bu">range</span>(<span class="dv">2000</span>, <span class="dv">2025</span>), fill_value<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb21-263"><a href="#cb21-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-264"><a href="#cb21-264" aria-hidden="true" tabindex="-1"></a>reason_by_year.plot(kind<span class="op">=</span><span class="st">'bar'</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>axes[<span class="dv">1</span>],</span>
<span id="cb21-265"><a href="#cb21-265" aria-hidden="true" tabindex="-1"></a>                     colormap<span class="op">=</span><span class="st">'Set2'</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>, width<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb21-266"><a href="#cb21-266" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Year'</span>)</span>
<span id="cb21-267"><a href="#cb21-267" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Number of Delistings'</span>)</span>
<span id="cb21-268"><a href="#cb21-268" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Delisting Reasons Over Time'</span>)</span>
<span id="cb21-269"><a href="#cb21-269" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(fontsize<span class="op">=</span><span class="dv">7</span>, loc<span class="op">=</span><span class="st">'upper left'</span>)</span>
<span id="cb21-270"><a href="#cb21-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-271"><a href="#cb21-271" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-272"><a href="#cb21-272" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-273"><a href="#cb21-273" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-274"><a href="#cb21-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-275"><a href="#cb21-275" aria-hidden="true" tabindex="-1"></a><span class="fu">### Firm Characteristics at Delisting</span></span>
<span id="cb21-276"><a href="#cb21-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-277"><a href="#cb21-277" aria-hidden="true" tabindex="-1"></a>Do delisted firms differ systematically from survivors? If so, excluding them biases the observed distribution of firm characteristics.</span>
<span id="cb21-278"><a href="#cb21-278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-281"><a href="#cb21-281" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-282"><a href="#cb21-282" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-delisting-characteristics</span></span>
<span id="cb21-283"><a href="#cb21-283" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-284"><a href="#cb21-284" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Firm characteristics in the year before delisting versus all active firms. Delisted firms are systematically smaller, less profitable, more leveraged, and more illiquid. These differences confirm that delisting is not random (MCAR) but is correlated with the variables used in empirical asset pricing tests."</span></span>
<span id="cb21-285"><a href="#cb21-285" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare characteristics of delisted vs surviving firms"</span></span>
<span id="cb21-286"><a href="#cb21-286" aria-hidden="true" tabindex="-1"></a><span class="co"># Get fundamentals in the last available year before delisting</span></span>
<span id="cb21-287"><a href="#cb21-287" aria-hidden="true" tabindex="-1"></a>last_year_delisted <span class="op">=</span> (</span>
<span id="cb21-288"><a href="#cb21-288" aria-hidden="true" tabindex="-1"></a>    delisted[[<span class="st">'ticker'</span>, <span class="st">'delisting_date'</span>]]</span>
<span id="cb21-289"><a href="#cb21-289" aria-hidden="true" tabindex="-1"></a>    .assign(last_fy<span class="op">=</span><span class="kw">lambda</span> x: x[<span class="st">'delisting_date'</span>].dt.year <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb21-290"><a href="#cb21-290" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-291"><a href="#cb21-291" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-292"><a href="#cb21-292" aria-hidden="true" tabindex="-1"></a>fundamentals <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb21-293"><a href="#cb21-293" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>, <span class="st">'UPCoM'</span>],</span>
<span id="cb21-294"><a href="#cb21-294" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2005-01-01'</span>,</span>
<span id="cb21-295"><a href="#cb21-295" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb21-296"><a href="#cb21-296" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-297"><a href="#cb21-297" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb21-298"><a href="#cb21-298" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_assets'</span>, <span class="st">'net_income'</span>,</span>
<span id="cb21-299"><a href="#cb21-299" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_equity'</span>, <span class="st">'revenue'</span>, <span class="st">'market_cap'</span></span>
<span id="cb21-300"><a href="#cb21-300" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-301"><a href="#cb21-301" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-302"><a href="#cb21-302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-303"><a href="#cb21-303" aria-hidden="true" tabindex="-1"></a><span class="co"># Characteristics of delisted firms (last year before delisting)</span></span>
<span id="cb21-304"><a href="#cb21-304" aria-hidden="true" tabindex="-1"></a>delist_chars <span class="op">=</span> (</span>
<span id="cb21-305"><a href="#cb21-305" aria-hidden="true" tabindex="-1"></a>    last_year_delisted</span>
<span id="cb21-306"><a href="#cb21-306" aria-hidden="true" tabindex="-1"></a>    .merge(fundamentals.rename(columns<span class="op">=</span>{<span class="st">'fiscal_year'</span>: <span class="st">'last_fy'</span>}),</span>
<span id="cb21-307"><a href="#cb21-307" aria-hidden="true" tabindex="-1"></a>           on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'last_fy'</span>], how<span class="op">=</span><span class="st">'inner'</span>)</span>
<span id="cb21-308"><a href="#cb21-308" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-309"><a href="#cb21-309" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'roa'</span>] <span class="op">=</span> delist_chars[<span class="st">'net_income'</span>] <span class="op">/</span> delist_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb21-310"><a href="#cb21-310" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'leverage'</span>] <span class="op">=</span> (</span>
<span id="cb21-311"><a href="#cb21-311" aria-hidden="true" tabindex="-1"></a>    (delist_chars[<span class="st">'total_assets'</span>] <span class="op">-</span> delist_chars[<span class="st">'total_equity'</span>])</span>
<span id="cb21-312"><a href="#cb21-312" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> delist_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb21-313"><a href="#cb21-313" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-314"><a href="#cb21-314" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(delist_chars[<span class="st">'total_assets'</span>])</span>
<span id="cb21-315"><a href="#cb21-315" aria-hidden="true" tabindex="-1"></a>delist_chars[<span class="st">'group'</span>] <span class="op">=</span> <span class="st">'Delisted'</span></span>
<span id="cb21-316"><a href="#cb21-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-317"><a href="#cb21-317" aria-hidden="true" tabindex="-1"></a><span class="co"># Characteristics of all active firms (pooled)</span></span>
<span id="cb21-318"><a href="#cb21-318" aria-hidden="true" tabindex="-1"></a>all_chars <span class="op">=</span> fundamentals.copy()</span>
<span id="cb21-319"><a href="#cb21-319" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'roa'</span>] <span class="op">=</span> all_chars[<span class="st">'net_income'</span>] <span class="op">/</span> all_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb21-320"><a href="#cb21-320" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'leverage'</span>] <span class="op">=</span> (</span>
<span id="cb21-321"><a href="#cb21-321" aria-hidden="true" tabindex="-1"></a>    (all_chars[<span class="st">'total_assets'</span>] <span class="op">-</span> all_chars[<span class="st">'total_equity'</span>])</span>
<span id="cb21-322"><a href="#cb21-322" aria-hidden="true" tabindex="-1"></a>    <span class="op">/</span> all_chars[<span class="st">'total_assets'</span>]</span>
<span id="cb21-323"><a href="#cb21-323" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-324"><a href="#cb21-324" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'log_assets'</span>] <span class="op">=</span> np.log(all_chars[<span class="st">'total_assets'</span>])</span>
<span id="cb21-325"><a href="#cb21-325" aria-hidden="true" tabindex="-1"></a>all_chars[<span class="st">'group'</span>] <span class="op">=</span> <span class="st">'All Active'</span></span>
<span id="cb21-326"><a href="#cb21-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-327"><a href="#cb21-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare distributions</span></span>
<span id="cb21-328"><a href="#cb21-328" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">10</span>))</span>
<span id="cb21-329"><a href="#cb21-329" aria-hidden="true" tabindex="-1"></a>variables <span class="op">=</span> [</span>
<span id="cb21-330"><a href="#cb21-330" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'log_assets'</span>, <span class="st">'Log Total Assets'</span>, axes[<span class="dv">0</span>, <span class="dv">0</span>]),</span>
<span id="cb21-331"><a href="#cb21-331" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'roa'</span>, <span class="st">'Return on Assets'</span>, axes[<span class="dv">0</span>, <span class="dv">1</span>]),</span>
<span id="cb21-332"><a href="#cb21-332" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'leverage'</span>, <span class="st">'Leverage Ratio'</span>, axes[<span class="dv">1</span>, <span class="dv">0</span>]),</span>
<span id="cb21-333"><a href="#cb21-333" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-334"><a href="#cb21-334" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-335"><a href="#cb21-335" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col, label, ax <span class="kw">in</span> variables:</span>
<span id="cb21-336"><a href="#cb21-336" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> grp, color <span class="kw">in</span> [(<span class="st">'All Active'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'Delisted'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb21-337"><a href="#cb21-337" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'Delisted'</span>:</span>
<span id="cb21-338"><a href="#cb21-338" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> delist_chars[col].dropna()</span>
<span id="cb21-339"><a href="#cb21-339" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-340"><a href="#cb21-340" aria-hidden="true" tabindex="-1"></a>            data <span class="op">=</span> all_chars[col].dropna()</span>
<span id="cb21-341"><a href="#cb21-341" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> data[np.isfinite(data)]</span>
<span id="cb21-342"><a href="#cb21-342" aria-hidden="true" tabindex="-1"></a>        ax.hist(data, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb21-343"><a href="#cb21-343" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>color, label<span class="op">=</span>grp, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb21-344"><a href="#cb21-344" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(label)</span>
<span id="cb21-345"><a href="#cb21-345" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb21-346"><a href="#cb21-346" aria-hidden="true" tabindex="-1"></a>    ax.legend()</span>
<span id="cb21-347"><a href="#cb21-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-348"><a href="#cb21-348" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel D: Market cap distribution</span></span>
<span id="cb21-349"><a href="#cb21-349" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> grp, color <span class="kw">in</span> [(<span class="st">'All Active'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'Delisted'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb21-350"><a href="#cb21-350" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> grp <span class="op">==</span> <span class="st">'Delisted'</span>:</span>
<span id="cb21-351"><a href="#cb21-351" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> np.log(delist_chars[<span class="st">'market_cap'</span>].dropna())</span>
<span id="cb21-352"><a href="#cb21-352" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb21-353"><a href="#cb21-353" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> np.log(all_chars[<span class="st">'market_cap'</span>].dropna())</span>
<span id="cb21-354"><a href="#cb21-354" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> data[np.isfinite(data)]</span>
<span id="cb21-355"><a href="#cb21-355" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>, <span class="dv">1</span>].hist(data, bins<span class="op">=</span><span class="dv">50</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb21-356"><a href="#cb21-356" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>color, label<span class="op">=</span>grp, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb21-357"><a href="#cb21-357" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_xlabel(<span class="st">'Log Market Cap'</span>)</span>
<span id="cb21-358"><a href="#cb21-358" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].set_ylabel(<span class="st">'Density'</span>)</span>
<span id="cb21-359"><a href="#cb21-359" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>, <span class="dv">1</span>].legend()</span>
<span id="cb21-360"><a href="#cb21-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-361"><a href="#cb21-361" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Characteristics of Delisted vs Active Firms'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb21-362"><a href="#cb21-362" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-363"><a href="#cb21-363" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-364"><a href="#cb21-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-365"><a href="#cb21-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Formal comparison</span></span>
<span id="cb21-366"><a href="#cb21-366" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Mean Comparison (Delisted vs All Active):"</span>)</span>
<span id="cb21-367"><a href="#cb21-367" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'log_assets'</span>, <span class="st">'roa'</span>, <span class="st">'leverage'</span>]:</span>
<span id="cb21-368"><a href="#cb21-368" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> delist_chars[col].dropna()</span>
<span id="cb21-369"><a href="#cb21-369" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> all_chars[col].dropna()</span>
<span id="cb21-370"><a href="#cb21-370" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> d[np.isfinite(d)]</span>
<span id="cb21-371"><a href="#cb21-371" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> a[np.isfinite(a)]</span>
<span id="cb21-372"><a href="#cb21-372" aria-hidden="true" tabindex="-1"></a>    t, p <span class="op">=</span> stats.ttest_ind(d, a, equal_var<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-373"><a href="#cb21-373" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>col<span class="sc">:&lt;15}</span><span class="ss">: Delisted = </span><span class="sc">{</span>d<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, "</span></span>
<span id="cb21-374"><a href="#cb21-374" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Active = </span><span class="sc">{</span>a<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">, t = </span><span class="sc">{</span>t<span class="sc">:.2f}</span><span class="ss">, p = </span><span class="sc">{</span>p<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb21-375"><a href="#cb21-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-376"><a href="#cb21-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-377"><a href="#cb21-377" aria-hidden="true" tabindex="-1"></a><span class="fu">## Survivorship Bias {#sec-missing-survivorship}</span></span>
<span id="cb21-378"><a href="#cb21-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-379"><a href="#cb21-379" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definition and Magnitude</span></span>
<span id="cb21-380"><a href="#cb21-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-381"><a href="#cb21-381" aria-hidden="true" tabindex="-1"></a>Survivorship bias arises when a study uses only firms that are currently listed (or listed at the end of the sample), excluding firms that delisted during the sample period. Because delisted firms disproportionately experienced negative returns before delisting, their exclusion inflates average returns, understates risk, and distorts cross-sectional patterns.</span>
<span id="cb21-382"><a href="#cb21-382" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-383"><a href="#cb21-383" aria-hidden="true" tabindex="-1"></a>We quantify the magnitude of survivorship bias by comparing portfolio returns computed from the **survivorship-bias-free** sample (all firms, including those that subsequently delisted) against a **survivors-only** sample (firms that remained listed through the end of the sample).</span>
<span id="cb21-384"><a href="#cb21-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-387"><a href="#cb21-387" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-388"><a href="#cb21-388" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: survivorship-magnitude</span></span>
<span id="cb21-389"><a href="#cb21-389" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-390"><a href="#cb21-390" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Quantify survivorship bias by comparing survivor-only vs full-sample portfolios"</span></span>
<span id="cb21-391"><a href="#cb21-391" aria-hidden="true" tabindex="-1"></a><span class="co"># Define survivors: firms active as of 2024-12-31</span></span>
<span id="cb21-392"><a href="#cb21-392" aria-hidden="true" tabindex="-1"></a>survivors <span class="op">=</span> <span class="bu">set</span>(</span>
<span id="cb21-393"><a href="#cb21-393" aria-hidden="true" tabindex="-1"></a>    listing_history[listing_history[<span class="st">'is_active'</span>]][<span class="st">'ticker'</span>]</span>
<span id="cb21-394"><a href="#cb21-394" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-395"><a href="#cb21-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-396"><a href="#cb21-396" aria-hidden="true" tabindex="-1"></a><span class="co"># Full sample: all firms, including delisted</span></span>
<span id="cb21-397"><a href="#cb21-397" aria-hidden="true" tabindex="-1"></a>full_sample <span class="op">=</span> monthly_returns.copy()</span>
<span id="cb21-398"><a href="#cb21-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-399"><a href="#cb21-399" aria-hidden="true" tabindex="-1"></a><span class="co"># Survivors only: restrict to firms still listed at end of sample</span></span>
<span id="cb21-400"><a href="#cb21-400" aria-hidden="true" tabindex="-1"></a>survivors_only <span class="op">=</span> monthly_returns[</span>
<span id="cb21-401"><a href="#cb21-401" aria-hidden="true" tabindex="-1"></a>    monthly_returns[<span class="st">'ticker'</span>].isin(survivors)</span>
<span id="cb21-402"><a href="#cb21-402" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb21-403"><a href="#cb21-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-404"><a href="#cb21-404" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute EW monthly portfolio returns</span></span>
<span id="cb21-405"><a href="#cb21-405" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_ew_portfolio(df):</span>
<span id="cb21-406"><a href="#cb21-406" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb21-407"><a href="#cb21-407" aria-hidden="true" tabindex="-1"></a>        df</span>
<span id="cb21-408"><a href="#cb21-408" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb21-409"><a href="#cb21-409" aria-hidden="true" tabindex="-1"></a>        .mean()</span>
<span id="cb21-410"><a href="#cb21-410" aria-hidden="true" tabindex="-1"></a>        .to_frame(<span class="st">'portfolio_return'</span>)</span>
<span id="cb21-411"><a href="#cb21-411" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-412"><a href="#cb21-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-413"><a href="#cb21-413" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_vw_portfolio(df):</span>
<span id="cb21-414"><a href="#cb21-414" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb21-415"><a href="#cb21-415" aria-hidden="true" tabindex="-1"></a>        df</span>
<span id="cb21-416"><a href="#cb21-416" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)</span>
<span id="cb21-417"><a href="#cb21-417" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(<span class="kw">lambda</span> g: np.average(g[<span class="st">'monthly_return'</span>],</span>
<span id="cb21-418"><a href="#cb21-418" aria-hidden="true" tabindex="-1"></a>                                     weights<span class="op">=</span>g[<span class="st">'market_cap'</span>])</span>
<span id="cb21-419"><a href="#cb21-419" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> g[<span class="st">'market_cap'</span>].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan)</span>
<span id="cb21-420"><a href="#cb21-420" aria-hidden="true" tabindex="-1"></a>        .to_frame(<span class="st">'portfolio_return'</span>)</span>
<span id="cb21-421"><a href="#cb21-421" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-422"><a href="#cb21-422" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-423"><a href="#cb21-423" aria-hidden="true" tabindex="-1"></a>ew_full <span class="op">=</span> compute_ew_portfolio(full_sample)</span>
<span id="cb21-424"><a href="#cb21-424" aria-hidden="true" tabindex="-1"></a>ew_survivors <span class="op">=</span> compute_ew_portfolio(survivors_only)</span>
<span id="cb21-425"><a href="#cb21-425" aria-hidden="true" tabindex="-1"></a>vw_full <span class="op">=</span> compute_vw_portfolio(full_sample)</span>
<span id="cb21-426"><a href="#cb21-426" aria-hidden="true" tabindex="-1"></a>vw_survivors <span class="op">=</span> compute_vw_portfolio(survivors_only)</span>
<span id="cb21-427"><a href="#cb21-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-428"><a href="#cb21-428" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge and compute bias</span></span>
<span id="cb21-429"><a href="#cb21-429" aria-hidden="true" tabindex="-1"></a>bias_ew <span class="op">=</span> pd.merge(</span>
<span id="cb21-430"><a href="#cb21-430" aria-hidden="true" tabindex="-1"></a>    ew_full.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'full'</span>}),</span>
<span id="cb21-431"><a href="#cb21-431" aria-hidden="true" tabindex="-1"></a>    ew_survivors.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb21-432"><a href="#cb21-432" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb21-433"><a href="#cb21-433" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-434"><a href="#cb21-434" aria-hidden="true" tabindex="-1"></a>bias_ew[<span class="st">'bias'</span>] <span class="op">=</span> bias_ew[<span class="st">'survivors'</span>] <span class="op">-</span> bias_ew[<span class="st">'full'</span>]</span>
<span id="cb21-435"><a href="#cb21-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-436"><a href="#cb21-436" aria-hidden="true" tabindex="-1"></a>bias_vw <span class="op">=</span> pd.merge(</span>
<span id="cb21-437"><a href="#cb21-437" aria-hidden="true" tabindex="-1"></a>    vw_full.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'full'</span>}),</span>
<span id="cb21-438"><a href="#cb21-438" aria-hidden="true" tabindex="-1"></a>    vw_survivors.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb21-439"><a href="#cb21-439" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb21-440"><a href="#cb21-440" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-441"><a href="#cb21-441" aria-hidden="true" tabindex="-1"></a>bias_vw[<span class="st">'bias'</span>] <span class="op">=</span> bias_vw[<span class="st">'survivors'</span>] <span class="op">-</span> bias_vw[<span class="st">'full'</span>]</span>
<span id="cb21-442"><a href="#cb21-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-443"><a href="#cb21-443" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Survivorship Bias (Annualized):"</span>)</span>
<span id="cb21-444"><a href="#cb21-444" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW: </span><span class="sc">{</span>bias_ew[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb21-445"><a href="#cb21-445" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>bias_ew[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">1200</span><span class="sc">:.1f}</span><span class="ss"> bps/year)"</span>)</span>
<span id="cb21-446"><a href="#cb21-446" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  VW: </span><span class="sc">{</span>bias_vw[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">12</span><span class="sc">:.4f}</span><span class="ss"> "</span></span>
<span id="cb21-447"><a href="#cb21-447" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"(</span><span class="sc">{</span>bias_vw[<span class="st">'bias'</span>]<span class="sc">.</span>mean() <span class="op">*</span> <span class="dv">1200</span><span class="sc">:.1f}</span><span class="ss"> bps/year)"</span>)</span>
<span id="cb21-448"><a href="#cb21-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-449"><a href="#cb21-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-452"><a href="#cb21-452" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-453"><a href="#cb21-453" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-survivorship-bias</span></span>
<span id="cb21-454"><a href="#cb21-454" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-455"><a href="#cb21-455" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of the full sample versus survivors-only portfolio. Panel A shows equal-weighted portfolios, where the bias is larger because delisted (and pre-delisting poor-performing) small firms receive equal weight. Panel B shows value-weighted portfolios, where the bias is smaller because delisted firms are typically small and contribute little to VW returns."</span></span>
<span id="cb21-456"><a href="#cb21-456" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot cumulative returns: full sample vs survivors only"</span></span>
<span id="cb21-457"><a href="#cb21-457" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-458"><a href="#cb21-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-459"><a href="#cb21-459" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (bias_df, title) <span class="kw">in</span> <span class="bu">enumerate</span>(</span>
<span id="cb21-460"><a href="#cb21-460" aria-hidden="true" tabindex="-1"></a>    [(bias_ew, <span class="st">'Panel A: Equal-Weighted'</span>),</span>
<span id="cb21-461"><a href="#cb21-461" aria-hidden="true" tabindex="-1"></a>     (bias_vw, <span class="st">'Panel B: Value-Weighted'</span>)]</span>
<span id="cb21-462"><a href="#cb21-462" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb21-463"><a href="#cb21-463" aria-hidden="true" tabindex="-1"></a>    cum_full <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> bias_df[<span class="st">'full'</span>]).cumprod()</span>
<span id="cb21-464"><a href="#cb21-464" aria-hidden="true" tabindex="-1"></a>    cum_surv <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> bias_df[<span class="st">'survivors'</span>]).cumprod()</span>
<span id="cb21-465"><a href="#cb21-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-466"><a href="#cb21-466" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(cum_full.index, cum_full,</span>
<span id="cb21-467"><a href="#cb21-467" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#2C5F8A'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Full Sample'</span>)</span>
<span id="cb21-468"><a href="#cb21-468" aria-hidden="true" tabindex="-1"></a>    axes[i].plot(cum_surv.index, cum_surv,</span>
<span id="cb21-469"><a href="#cb21-469" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">'Survivors Only'</span>)</span>
<span id="cb21-470"><a href="#cb21-470" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Cumulative Wealth'</span>)</span>
<span id="cb21-471"><a href="#cb21-471" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb21-472"><a href="#cb21-472" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(title)</span>
<span id="cb21-473"><a href="#cb21-473" aria-hidden="true" tabindex="-1"></a>    axes[i].legend()</span>
<span id="cb21-474"><a href="#cb21-474" aria-hidden="true" tabindex="-1"></a>    axes[i].set_yscale(<span class="st">'log'</span>)</span>
<span id="cb21-475"><a href="#cb21-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-476"><a href="#cb21-476" aria-hidden="true" tabindex="-1"></a>    ann_bias <span class="op">=</span> bias_df[<span class="st">'bias'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-477"><a href="#cb21-477" aria-hidden="true" tabindex="-1"></a>    axes[i].text(<span class="fl">0.05</span>, <span class="fl">0.95</span>,</span>
<span id="cb21-478"><a href="#cb21-478" aria-hidden="true" tabindex="-1"></a>                 <span class="ss">f'Annual Bias: </span><span class="sc">{</span>ann_bias<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%'</span>,</span>
<span id="cb21-479"><a href="#cb21-479" aria-hidden="true" tabindex="-1"></a>                 transform<span class="op">=</span>axes[i].transAxes, fontsize<span class="op">=</span><span class="dv">11</span>,</span>
<span id="cb21-480"><a href="#cb21-480" aria-hidden="true" tabindex="-1"></a>                 verticalalignment<span class="op">=</span><span class="st">'top'</span>,</span>
<span id="cb21-481"><a href="#cb21-481" aria-hidden="true" tabindex="-1"></a>                 bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">'white'</span>, alpha<span class="op">=</span><span class="fl">0.8</span>))</span>
<span id="cb21-482"><a href="#cb21-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-483"><a href="#cb21-483" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-484"><a href="#cb21-484" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-485"><a href="#cb21-485" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-486"><a href="#cb21-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-487"><a href="#cb21-487" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time-Varying Survivorship Bias</span></span>
<span id="cb21-488"><a href="#cb21-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-489"><a href="#cb21-489" aria-hidden="true" tabindex="-1"></a>The magnitude of survivorship bias is not constant. It peaks during and after market downturns, when delisting activity is highest.</span>
<span id="cb21-490"><a href="#cb21-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-493"><a href="#cb21-493" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-494"><a href="#cb21-494" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-rolling-bias</span></span>
<span id="cb21-495"><a href="#cb21-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-496"><a href="#cb21-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Rolling 12-month survivorship bias for equal-weighted portfolios. The bias spikes during periods of high delisting activity (post-2008 crisis, 2011--2012 downturn). During bull markets, few firms delist and the bias approaches zero."</span></span>
<span id="cb21-497"><a href="#cb21-497" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute rolling survivorship bias"</span></span>
<span id="cb21-498"><a href="#cb21-498" aria-hidden="true" tabindex="-1"></a>bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">=</span> bias_ew[<span class="st">'bias'</span>].rolling(<span class="dv">12</span>).mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-499"><a href="#cb21-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-500"><a href="#cb21-500" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">8</span>), height_ratios<span class="op">=</span>[<span class="dv">2</span>, <span class="dv">1</span>])</span>
<span id="cb21-501"><a href="#cb21-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-502"><a href="#cb21-502" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Rolling bias</span></span>
<span id="cb21-503"><a href="#cb21-503" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].fill_between(</span>
<span id="cb21-504"><a href="#cb21-504" aria-hidden="true" tabindex="-1"></a>    bias_ew.index, <span class="dv">0</span>, bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb21-505"><a href="#cb21-505" aria-hidden="true" tabindex="-1"></a>    where<span class="op">=</span>bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb21-506"><a href="#cb21-506" aria-hidden="true" tabindex="-1"></a>    color<span class="op">=</span><span class="st">'#C0392B'</span>, alpha<span class="op">=</span><span class="fl">0.4</span></span>
<span id="cb21-507"><a href="#cb21-507" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-508"><a href="#cb21-508" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot(bias_ew.index, bias_ew[<span class="st">'rolling_bias_12m'</span>] <span class="op">*</span> <span class="dv">100</span>,</span>
<span id="cb21-509"><a href="#cb21-509" aria-hidden="true" tabindex="-1"></a>             color<span class="op">=</span><span class="st">'#C0392B'</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb21-510"><a href="#cb21-510" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-511"><a href="#cb21-511" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Annualized Bias (%)'</span>)</span>
<span id="cb21-512"><a href="#cb21-512" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Rolling 12-Month Survivorship Bias (EW)'</span>)</span>
<span id="cb21-513"><a href="#cb21-513" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-514"><a href="#cb21-514" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of delistings per quarter</span></span>
<span id="cb21-515"><a href="#cb21-515" aria-hidden="true" tabindex="-1"></a>delistings_quarterly <span class="op">=</span> (</span>
<span id="cb21-516"><a href="#cb21-516" aria-hidden="true" tabindex="-1"></a>    delisted</span>
<span id="cb21-517"><a href="#cb21-517" aria-hidden="true" tabindex="-1"></a>    .set_index(<span class="st">'delisting_date'</span>)</span>
<span id="cb21-518"><a href="#cb21-518" aria-hidden="true" tabindex="-1"></a>    .resample(<span class="st">'Q'</span>)</span>
<span id="cb21-519"><a href="#cb21-519" aria-hidden="true" tabindex="-1"></a>    .size()</span>
<span id="cb21-520"><a href="#cb21-520" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-521"><a href="#cb21-521" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(delistings_quarterly.index, delistings_quarterly.values,</span>
<span id="cb21-522"><a href="#cb21-522" aria-hidden="true" tabindex="-1"></a>            width<span class="op">=</span><span class="dv">80</span>, color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb21-523"><a href="#cb21-523" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Delistings per Quarter'</span>)</span>
<span id="cb21-524"><a href="#cb21-524" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb21-525"><a href="#cb21-525" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Quarterly Delisting Activity'</span>)</span>
<span id="cb21-526"><a href="#cb21-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-527"><a href="#cb21-527" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-528"><a href="#cb21-528" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-529"><a href="#cb21-529" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-530"><a href="#cb21-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-531"><a href="#cb21-531" aria-hidden="true" tabindex="-1"></a><span class="fu">### Survivorship Bias in Cross-Sectional Anomalies</span></span>
<span id="cb21-532"><a href="#cb21-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-533"><a href="#cb21-533" aria-hidden="true" tabindex="-1"></a>The bias is not uniform across strategies. Anomalies that overweight small, distressed, or low-quality firms, precisely the firms most likely to delist, are most severely affected. We test this for the size, value, and momentum anomalies.</span>
<span id="cb21-534"><a href="#cb21-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-537"><a href="#cb21-537" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-538"><a href="#cb21-538" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: anomaly-bias</span></span>
<span id="cb21-539"><a href="#cb21-539" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-540"><a href="#cb21-540" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Quantify survivorship bias by anomaly portfolio"</span></span>
<span id="cb21-541"><a href="#cb21-541" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_long_short(df, sort_var, n_quantiles<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb21-542"><a href="#cb21-542" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-543"><a href="#cb21-543" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute long-short portfolio returns from quintile sorts.</span></span>
<span id="cb21-544"><a href="#cb21-544" aria-hidden="true" tabindex="-1"></a><span class="co">    Long = top quintile, Short = bottom quintile.</span></span>
<span id="cb21-545"><a href="#cb21-545" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-546"><a href="#cb21-546" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb21-547"><a href="#cb21-547" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> month, group <span class="kw">in</span> df.groupby(<span class="st">'month_end'</span>):</span>
<span id="cb21-548"><a href="#cb21-548" aria-hidden="true" tabindex="-1"></a>        group <span class="op">=</span> group.dropna(subset<span class="op">=</span>[sort_var, <span class="st">'monthly_return'</span>])</span>
<span id="cb21-549"><a href="#cb21-549" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(group) <span class="op">&lt;</span> <span class="dv">20</span>:</span>
<span id="cb21-550"><a href="#cb21-550" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-551"><a href="#cb21-551" aria-hidden="true" tabindex="-1"></a>        group[<span class="st">'quantile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb21-552"><a href="#cb21-552" aria-hidden="true" tabindex="-1"></a>            group[sort_var], n_quantiles, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span></span>
<span id="cb21-553"><a href="#cb21-553" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-554"><a href="#cb21-554" aria-hidden="true" tabindex="-1"></a>        long_ret <span class="op">=</span> group[group[<span class="st">'quantile'</span>] <span class="op">==</span> n_quantiles <span class="op">-</span> <span class="dv">1</span>][<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb21-555"><a href="#cb21-555" aria-hidden="true" tabindex="-1"></a>        short_ret <span class="op">=</span> group[group[<span class="st">'quantile'</span>] <span class="op">==</span> <span class="dv">0</span>][<span class="st">'monthly_return'</span>].mean()</span>
<span id="cb21-556"><a href="#cb21-556" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb21-557"><a href="#cb21-557" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month,</span>
<span id="cb21-558"><a href="#cb21-558" aria-hidden="true" tabindex="-1"></a>            <span class="st">'long'</span>: long_ret,</span>
<span id="cb21-559"><a href="#cb21-559" aria-hidden="true" tabindex="-1"></a>            <span class="st">'short'</span>: short_ret,</span>
<span id="cb21-560"><a href="#cb21-560" aria-hidden="true" tabindex="-1"></a>            <span class="st">'long_short'</span>: long_ret <span class="op">-</span> short_ret</span>
<span id="cb21-561"><a href="#cb21-561" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-562"><a href="#cb21-562" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb21-563"><a href="#cb21-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-564"><a href="#cb21-564" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare sort variables</span></span>
<span id="cb21-565"><a href="#cb21-565" aria-hidden="true" tabindex="-1"></a>monthly_with_chars <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb21-566"><a href="#cb21-566" aria-hidden="true" tabindex="-1"></a>    fundamentals[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_assets'</span>,</span>
<span id="cb21-567"><a href="#cb21-567" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'net_income'</span>, <span class="st">'total_equity'</span>]],</span>
<span id="cb21-568"><a href="#cb21-568" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_returns[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb21-569"><a href="#cb21-569" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>],</span>
<span id="cb21-570"><a href="#cb21-570" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb21-571"><a href="#cb21-571" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-572"><a href="#cb21-572" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(monthly_with_chars[<span class="st">'market_cap'</span>])</span>
<span id="cb21-573"><a href="#cb21-573" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'bm'</span>] <span class="op">=</span> (</span>
<span id="cb21-574"><a href="#cb21-574" aria-hidden="true" tabindex="-1"></a>    monthly_with_chars[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_with_chars[<span class="st">'market_cap'</span>]</span>
<span id="cb21-575"><a href="#cb21-575" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-576"><a href="#cb21-576" aria-hidden="true" tabindex="-1"></a>monthly_with_chars[<span class="st">'past_12m'</span>] <span class="op">=</span> (</span>
<span id="cb21-577"><a href="#cb21-577" aria-hidden="true" tabindex="-1"></a>    monthly_with_chars</span>
<span id="cb21-578"><a href="#cb21-578" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb21-579"><a href="#cb21-579" aria-hidden="true" tabindex="-1"></a>    .transform(<span class="kw">lambda</span> x: x.rolling(<span class="dv">12</span>).<span class="bu">sum</span>())</span>
<span id="cb21-580"><a href="#cb21-580" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-581"><a href="#cb21-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-582"><a href="#cb21-582" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute anomalies on full sample and survivors only</span></span>
<span id="cb21-583"><a href="#cb21-583" aria-hidden="true" tabindex="-1"></a>anomaly_bias <span class="op">=</span> {}</span>
<span id="cb21-584"><a href="#cb21-584" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> anomaly, sort_var, ascending <span class="kw">in</span> [</span>
<span id="cb21-585"><a href="#cb21-585" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Size (SMB)'</span>, <span class="st">'log_mcap'</span>, <span class="va">True</span>),</span>
<span id="cb21-586"><a href="#cb21-586" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Value (HML)'</span>, <span class="st">'bm'</span>, <span class="va">True</span>),</span>
<span id="cb21-587"><a href="#cb21-587" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'Momentum (WML)'</span>, <span class="st">'past_12m'</span>, <span class="va">True</span>)</span>
<span id="cb21-588"><a href="#cb21-588" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb21-589"><a href="#cb21-589" aria-hidden="true" tabindex="-1"></a>    full_ls <span class="op">=</span> compute_long_short(</span>
<span id="cb21-590"><a href="#cb21-590" aria-hidden="true" tabindex="-1"></a>        monthly_with_chars, sort_var</span>
<span id="cb21-591"><a href="#cb21-591" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-592"><a href="#cb21-592" aria-hidden="true" tabindex="-1"></a>    surv_data <span class="op">=</span> monthly_with_chars[</span>
<span id="cb21-593"><a href="#cb21-593" aria-hidden="true" tabindex="-1"></a>        monthly_with_chars[<span class="st">'ticker'</span>].isin(survivors)</span>
<span id="cb21-594"><a href="#cb21-594" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb21-595"><a href="#cb21-595" aria-hidden="true" tabindex="-1"></a>    surv_ls <span class="op">=</span> compute_long_short(surv_data, sort_var)</span>
<span id="cb21-596"><a href="#cb21-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-597"><a href="#cb21-597" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge</span></span>
<span id="cb21-598"><a href="#cb21-598" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.merge(</span>
<span id="cb21-599"><a href="#cb21-599" aria-hidden="true" tabindex="-1"></a>        full_ls[[<span class="st">'month_end'</span>, <span class="st">'long_short'</span>]].rename(</span>
<span id="cb21-600"><a href="#cb21-600" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'long_short'</span>: <span class="st">'full'</span>}),</span>
<span id="cb21-601"><a href="#cb21-601" aria-hidden="true" tabindex="-1"></a>        surv_ls[[<span class="st">'month_end'</span>, <span class="st">'long_short'</span>]].rename(</span>
<span id="cb21-602"><a href="#cb21-602" aria-hidden="true" tabindex="-1"></a>            columns<span class="op">=</span>{<span class="st">'long_short'</span>: <span class="st">'survivors'</span>}),</span>
<span id="cb21-603"><a href="#cb21-603" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span><span class="st">'month_end'</span></span>
<span id="cb21-604"><a href="#cb21-604" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-605"><a href="#cb21-605" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'bias'</span>] <span class="op">=</span> merged[<span class="st">'survivors'</span>] <span class="op">-</span> merged[<span class="st">'full'</span>]</span>
<span id="cb21-606"><a href="#cb21-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-607"><a href="#cb21-607" aria-hidden="true" tabindex="-1"></a>    ann_full <span class="op">=</span> merged[<span class="st">'full'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-608"><a href="#cb21-608" aria-hidden="true" tabindex="-1"></a>    ann_surv <span class="op">=</span> merged[<span class="st">'survivors'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-609"><a href="#cb21-609" aria-hidden="true" tabindex="-1"></a>    ann_bias <span class="op">=</span> merged[<span class="st">'bias'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-610"><a href="#cb21-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-611"><a href="#cb21-611" aria-hidden="true" tabindex="-1"></a>    anomaly_bias[anomaly] <span class="op">=</span> {</span>
<span id="cb21-612"><a href="#cb21-612" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Full Sample (ann.)'</span>: ann_full,</span>
<span id="cb21-613"><a href="#cb21-613" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Survivors Only (ann.)'</span>: ann_surv,</span>
<span id="cb21-614"><a href="#cb21-614" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Bias (ann.)'</span>: ann_bias,</span>
<span id="cb21-615"><a href="#cb21-615" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Bias (</span><span class="sc">% o</span><span class="st">f premium)'</span>: ann_bias <span class="op">/</span> ann_full <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> ann_full <span class="op">!=</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb21-616"><a href="#cb21-616" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb21-617"><a href="#cb21-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-618"><a href="#cb21-618" aria-hidden="true" tabindex="-1"></a>anomaly_bias_df <span class="op">=</span> pd.DataFrame(anomaly_bias).T</span>
<span id="cb21-619"><a href="#cb21-619" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Survivorship Bias by Anomaly:"</span>)</span>
<span id="cb21-620"><a href="#cb21-620" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(anomaly_bias_df.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb21-621"><a href="#cb21-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-622"><a href="#cb21-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-623"><a href="#cb21-623" aria-hidden="true" tabindex="-1"></a><span class="fu">## Delisting Bias and Return Imputation {#sec-missing-delisting}</span></span>
<span id="cb21-624"><a href="#cb21-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-625"><a href="#cb21-625" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Shumway Correction</span></span>
<span id="cb21-626"><a href="#cb21-626" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-627"><a href="#cb21-627" aria-hidden="true" tabindex="-1"></a>@shumway1997delisting showed that CRSP's treatment of delisting returns, often recording them as missing or zero, creates a systematic upward bias in average returns. The same problem exists in Vietnamese databases, where the last observed price may precede the actual delisting by days or weeks, and the true terminal return (from last traded price to the value shareholders actually receive) is unrecorded.</span>
<span id="cb21-628"><a href="#cb21-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-629"><a href="#cb21-629" aria-hidden="true" tabindex="-1"></a>We implement a delisting return imputation procedure adapted for Vietnam:</span>
<span id="cb21-630"><a href="#cb21-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-631"><a href="#cb21-631" aria-hidden="true" tabindex="-1"></a>**Step 1.** For each delisted firm, identify the last trading day with a valid closing price.</span>
<span id="cb21-632"><a href="#cb21-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-633"><a href="#cb21-633" aria-hidden="true" tabindex="-1"></a>**Step 2.** Classify the delisting reason to determine the appropriate imputation (@tbl-missing-imputation).</span>
<span id="cb21-634"><a href="#cb21-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-635"><a href="#cb21-635" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Delisting Reason <span class="pp">|</span> Imputed Return <span class="pp">|</span> Rationale <span class="pp">|</span></span>
<span id="cb21-636"><a href="#cb21-636" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------------|------------------------|------------------------|</span></span>
<span id="cb21-637"><a href="#cb21-637" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> M&amp;A / Acquisition <span class="pp">|</span> Actual tender offer premium (if available) <span class="pp">|</span> Acquisition at premium <span class="pp">|</span></span>
<span id="cb21-638"><a href="#cb21-638" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Going private <span class="pp">|</span> 0% (or actual buyout price) <span class="pp">|</span> Negotiated exit <span class="pp">|</span></span>
<span id="cb21-639"><a href="#cb21-639" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Financial distress <span class="pp">|</span> âˆ’30% to âˆ’100% <span class="pp">|</span> Substantial loss of value <span class="pp">|</span></span>
<span id="cb21-640"><a href="#cb21-640" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Regulatory violation <span class="pp">|</span> âˆ’50% <span class="pp">|</span> Partial loss; some recovery possible <span class="pp">|</span></span>
<span id="cb21-641"><a href="#cb21-641" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Exchange transfer <span class="pp">|</span> 0% (link to new ticker) <span class="pp">|</span> No economic event <span class="pp">|</span></span>
<span id="cb21-642"><a href="#cb21-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-643"><a href="#cb21-643" aria-hidden="true" tabindex="-1"></a>: Delisting return imputation rules. {#tbl-missing-imputation}</span>
<span id="cb21-644"><a href="#cb21-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-645"><a href="#cb21-645" aria-hidden="true" tabindex="-1"></a>**Step 3.** Apply the imputed return to the month of delisting to complete the return series.</span>
<span id="cb21-646"><a href="#cb21-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-649"><a href="#cb21-649" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-650"><a href="#cb21-650" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delisting-imputation</span></span>
<span id="cb21-651"><a href="#cb21-651" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-652"><a href="#cb21-652" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement delisting return imputation for Vietnamese firms"</span></span>
<span id="cb21-653"><a href="#cb21-653" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> impute_delisting_returns(listing_df, daily_df, monthly_df):</span>
<span id="cb21-654"><a href="#cb21-654" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-655"><a href="#cb21-655" aria-hidden="true" tabindex="-1"></a><span class="co">    Impute terminal returns for delisted firms.</span></span>
<span id="cb21-656"><a href="#cb21-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-657"><a href="#cb21-657" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a DataFrame of imputed delisting returns to be</span></span>
<span id="cb21-658"><a href="#cb21-658" aria-hidden="true" tabindex="-1"></a><span class="co">    appended to the monthly return panel.</span></span>
<span id="cb21-659"><a href="#cb21-659" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-660"><a href="#cb21-660" aria-hidden="true" tabindex="-1"></a>    delisted_firms <span class="op">=</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].copy()</span>
<span id="cb21-661"><a href="#cb21-661" aria-hidden="true" tabindex="-1"></a>    imputed <span class="op">=</span> []</span>
<span id="cb21-662"><a href="#cb21-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-663"><a href="#cb21-663" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> delisted_firms.iterrows():</span>
<span id="cb21-664"><a href="#cb21-664" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> firm[<span class="st">'ticker'</span>]</span>
<span id="cb21-665"><a href="#cb21-665" aria-hidden="true" tabindex="-1"></a>        delist_date <span class="op">=</span> firm[<span class="st">'delisting_date'</span>]</span>
<span id="cb21-666"><a href="#cb21-666" aria-hidden="true" tabindex="-1"></a>        reason <span class="op">=</span> firm.get(<span class="st">'reason_category'</span>, firm.get(<span class="st">'delisting_reason'</span>, <span class="st">''</span>))</span>
<span id="cb21-667"><a href="#cb21-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-668"><a href="#cb21-668" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find last trading day</span></span>
<span id="cb21-669"><a href="#cb21-669" aria-hidden="true" tabindex="-1"></a>        firm_daily <span class="op">=</span> daily_df[daily_df[<span class="st">'ticker'</span>] <span class="op">==</span> ticker].sort_values(<span class="st">'date'</span>)</span>
<span id="cb21-670"><a href="#cb21-670" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(firm_daily) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-671"><a href="#cb21-671" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb21-672"><a href="#cb21-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-673"><a href="#cb21-673" aria-hidden="true" tabindex="-1"></a>        last_trade <span class="op">=</span> firm_daily.iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb21-674"><a href="#cb21-674" aria-hidden="true" tabindex="-1"></a>        last_price <span class="op">=</span> last_trade[<span class="st">'adjusted_close'</span>]</span>
<span id="cb21-675"><a href="#cb21-675" aria-hidden="true" tabindex="-1"></a>        last_date <span class="op">=</span> last_trade[<span class="st">'date'</span>]</span>
<span id="cb21-676"><a href="#cb21-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-677"><a href="#cb21-677" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if last trade is already close to delisting date</span></span>
<span id="cb21-678"><a href="#cb21-678" aria-hidden="true" tabindex="-1"></a>        gap_days <span class="op">=</span> (pd.Timestamp(delist_date) <span class="op">-</span> pd.Timestamp(last_date)).days</span>
<span id="cb21-679"><a href="#cb21-679" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> gap_days <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb21-680"><a href="#cb21-680" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span>  <span class="co"># Data issue</span></span>
<span id="cb21-681"><a href="#cb21-681" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-682"><a href="#cb21-682" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Determine imputation based on reason</span></span>
<span id="cb21-683"><a href="#cb21-683" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'M&amp;A'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'merger'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb21-684"><a href="#cb21-684" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Conservative; ideally use tender price</span></span>
<span id="cb21-685"><a href="#cb21-685" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Going Private'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'voluntary'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb21-686"><a href="#cb21-686" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb21-687"><a href="#cb21-687" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Transfer'</span> <span class="kw">in</span> <span class="bu">str</span>(reason):</span>
<span id="cb21-688"><a href="#cb21-688" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Not a real delisting</span></span>
<span id="cb21-689"><a href="#cb21-689" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(reason) <span class="kw">or</span> <span class="st">'bankruptcy'</span> <span class="kw">in</span> <span class="bu">str</span>(reason).lower():</span>
<span id="cb21-690"><a href="#cb21-690" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.50</span>  <span class="co"># Conservative estimate</span></span>
<span id="cb21-691"><a href="#cb21-691" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="st">'Regulatory'</span> <span class="kw">in</span> <span class="bu">str</span>(reason):</span>
<span id="cb21-692"><a href="#cb21-692" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.30</span></span>
<span id="cb21-693"><a href="#cb21-693" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb21-694"><a href="#cb21-694" aria-hidden="true" tabindex="-1"></a>            imputed_return <span class="op">=</span> <span class="op">-</span><span class="fl">0.30</span>  <span class="co"># Default for unknown reasons</span></span>
<span id="cb21-695"><a href="#cb21-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-696"><a href="#cb21-696" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign to the delisting month</span></span>
<span id="cb21-697"><a href="#cb21-697" aria-hidden="true" tabindex="-1"></a>        delist_month <span class="op">=</span> pd.Timestamp(delist_date).to_period(<span class="st">'M'</span>).to_timestamp()</span>
<span id="cb21-698"><a href="#cb21-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-699"><a href="#cb21-699" aria-hidden="true" tabindex="-1"></a>        imputed.append({</span>
<span id="cb21-700"><a href="#cb21-700" aria-hidden="true" tabindex="-1"></a>            <span class="st">'ticker'</span>: ticker,</span>
<span id="cb21-701"><a href="#cb21-701" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: delist_month,</span>
<span id="cb21-702"><a href="#cb21-702" aria-hidden="true" tabindex="-1"></a>            <span class="st">'monthly_return'</span>: imputed_return,</span>
<span id="cb21-703"><a href="#cb21-703" aria-hidden="true" tabindex="-1"></a>            <span class="st">'market_cap'</span>: last_trade.get(<span class="st">'market_cap'</span>, np.nan),</span>
<span id="cb21-704"><a href="#cb21-704" aria-hidden="true" tabindex="-1"></a>            <span class="st">'source'</span>: <span class="st">'imputed_delisting'</span>,</span>
<span id="cb21-705"><a href="#cb21-705" aria-hidden="true" tabindex="-1"></a>            <span class="st">'delisting_reason'</span>: reason,</span>
<span id="cb21-706"><a href="#cb21-706" aria-hidden="true" tabindex="-1"></a>            <span class="st">'gap_days'</span>: gap_days</span>
<span id="cb21-707"><a href="#cb21-707" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb21-708"><a href="#cb21-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-709"><a href="#cb21-709" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(imputed)</span>
<span id="cb21-710"><a href="#cb21-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-711"><a href="#cb21-711" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply imputation</span></span>
<span id="cb21-712"><a href="#cb21-712" aria-hidden="true" tabindex="-1"></a>imputed_returns <span class="op">=</span> impute_delisting_returns(</span>
<span id="cb21-713"><a href="#cb21-713" aria-hidden="true" tabindex="-1"></a>    delisted.assign(reason_category<span class="op">=</span>delisted[<span class="st">'reason_category'</span>]),</span>
<span id="cb21-714"><a href="#cb21-714" aria-hidden="true" tabindex="-1"></a>    daily_returns, monthly_returns</span>
<span id="cb21-715"><a href="#cb21-715" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-716"><a href="#cb21-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-717"><a href="#cb21-717" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Imputed delisting returns: </span><span class="sc">{</span><span class="bu">len</span>(imputed_returns)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-718"><a href="#cb21-718" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Imputed return distribution:"</span>)</span>
<span id="cb21-719"><a href="#cb21-719" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(imputed_returns[<span class="st">'monthly_return'</span>].value_counts().sort_index())</span>
<span id="cb21-720"><a href="#cb21-720" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-721"><a href="#cb21-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-722"><a href="#cb21-722" aria-hidden="true" tabindex="-1"></a><span class="fu">### Impact of Delisting Return Imputation</span></span>
<span id="cb21-723"><a href="#cb21-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-726"><a href="#cb21-726" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-727"><a href="#cb21-727" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: delisting-impact</span></span>
<span id="cb21-728"><a href="#cb21-728" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-729"><a href="#cb21-729" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Quantify the impact of including imputed delisting returns"</span></span>
<span id="cb21-730"><a href="#cb21-730" aria-hidden="true" tabindex="-1"></a><span class="co"># Augmented sample: monthly returns + imputed delisting returns</span></span>
<span id="cb21-731"><a href="#cb21-731" aria-hidden="true" tabindex="-1"></a>augmented <span class="op">=</span> pd.concat([</span>
<span id="cb21-732"><a href="#cb21-732" aria-hidden="true" tabindex="-1"></a>    monthly_returns[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]],</span>
<span id="cb21-733"><a href="#cb21-733" aria-hidden="true" tabindex="-1"></a>    imputed_returns[[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>]]</span>
<span id="cb21-734"><a href="#cb21-734" aria-hidden="true" tabindex="-1"></a>], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-735"><a href="#cb21-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-736"><a href="#cb21-736" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare original vs augmented EW portfolios</span></span>
<span id="cb21-737"><a href="#cb21-737" aria-hidden="true" tabindex="-1"></a>ew_original <span class="op">=</span> compute_ew_portfolio(monthly_returns)</span>
<span id="cb21-738"><a href="#cb21-738" aria-hidden="true" tabindex="-1"></a>ew_augmented <span class="op">=</span> compute_ew_portfolio(augmented)</span>
<span id="cb21-739"><a href="#cb21-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-740"><a href="#cb21-740" aria-hidden="true" tabindex="-1"></a>comparison <span class="op">=</span> pd.merge(</span>
<span id="cb21-741"><a href="#cb21-741" aria-hidden="true" tabindex="-1"></a>    ew_original.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'original'</span>}),</span>
<span id="cb21-742"><a href="#cb21-742" aria-hidden="true" tabindex="-1"></a>    ew_augmented.rename(columns<span class="op">=</span>{<span class="st">'portfolio_return'</span>: <span class="st">'augmented'</span>}),</span>
<span id="cb21-743"><a href="#cb21-743" aria-hidden="true" tabindex="-1"></a>    left_index<span class="op">=</span><span class="va">True</span>, right_index<span class="op">=</span><span class="va">True</span></span>
<span id="cb21-744"><a href="#cb21-744" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-745"><a href="#cb21-745" aria-hidden="true" tabindex="-1"></a>comparison[<span class="st">'imputation_effect'</span>] <span class="op">=</span> (</span>
<span id="cb21-746"><a href="#cb21-746" aria-hidden="true" tabindex="-1"></a>    comparison[<span class="st">'augmented'</span>] <span class="op">-</span> comparison[<span class="st">'original'</span>]</span>
<span id="cb21-747"><a href="#cb21-747" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-748"><a href="#cb21-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-749"><a href="#cb21-749" aria-hidden="true" tabindex="-1"></a>ann_original <span class="op">=</span> comparison[<span class="st">'original'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-750"><a href="#cb21-750" aria-hidden="true" tabindex="-1"></a>ann_augmented <span class="op">=</span> comparison[<span class="st">'augmented'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-751"><a href="#cb21-751" aria-hidden="true" tabindex="-1"></a>ann_effect <span class="op">=</span> comparison[<span class="st">'imputation_effect'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-752"><a href="#cb21-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-753"><a href="#cb21-753" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Delisting Return Imputation Impact:"</span>)</span>
<span id="cb21-754"><a href="#cb21-754" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW without imputation: </span><span class="sc">{</span>ann_original<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_original<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb21-755"><a href="#cb21-755" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  EW with imputation:    </span><span class="sc">{</span>ann_augmented<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_augmented<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb21-756"><a href="#cb21-756" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Difference:            </span><span class="sc">{</span>ann_effect<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_effect<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb21-757"><a href="#cb21-757" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-758"><a href="#cb21-758" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-759"><a href="#cb21-759" aria-hidden="true" tabindex="-1"></a><span class="fu">## Zero-Trading Days and Illiquidity Gaps {#sec-missing-zero-trading}</span></span>
<span id="cb21-760"><a href="#cb21-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-761"><a href="#cb21-761" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prevalence of Zero-Trading Days</span></span>
<span id="cb21-762"><a href="#cb21-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-763"><a href="#cb21-763" aria-hidden="true" tabindex="-1"></a>A distinctive feature of Vietnamese equity data is the high frequency of zero-volume days (i.e., days on which a listed stock records no trades). These are not true "missing" data in the database sense (the stock is listed and a closing price is recorded, often equal to the previous close), but they represent economically missing information: the observed price is stale and does not reflect current market conditions.</span>
<span id="cb21-764"><a href="#cb21-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-767"><a href="#cb21-767" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-768"><a href="#cb21-768" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-zero-trading</span></span>
<span id="cb21-769"><a href="#cb21-769" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-770"><a href="#cb21-770" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Prevalence of zero-trading days across Vietnamese listed firms. Panel A shows the cross-sectional distribution of the zero-volume fraction (proportion of trading days with no volume) by year. Panel B shows the zero-volume fraction by market cap decile. Small-cap firms have zero-volume fractions exceeding 30%, creating severe return measurement problems."</span></span>
<span id="cb21-771"><a href="#cb21-771" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Analyze the prevalence of zero-trading days"</span></span>
<span id="cb21-772"><a href="#cb21-772" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute zero-volume fraction per firm-year</span></span>
<span id="cb21-773"><a href="#cb21-773" aria-hidden="true" tabindex="-1"></a>daily_returns[<span class="st">'year'</span>] <span class="op">=</span> pd.to_datetime(daily_returns[<span class="st">'date'</span>]).dt.year</span>
<span id="cb21-774"><a href="#cb21-774" aria-hidden="true" tabindex="-1"></a>daily_returns[<span class="st">'zero_volume'</span>] <span class="op">=</span> (daily_returns[<span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>).astype(<span class="bu">int</span>)</span>
<span id="cb21-775"><a href="#cb21-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-776"><a href="#cb21-776" aria-hidden="true" tabindex="-1"></a>zero_vol_fy <span class="op">=</span> (</span>
<span id="cb21-777"><a href="#cb21-777" aria-hidden="true" tabindex="-1"></a>    daily_returns</span>
<span id="cb21-778"><a href="#cb21-778" aria-hidden="true" tabindex="-1"></a>    .groupby([<span class="st">'ticker'</span>, <span class="st">'year'</span>])</span>
<span id="cb21-779"><a href="#cb21-779" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb21-780"><a href="#cb21-780" aria-hidden="true" tabindex="-1"></a>        n_days<span class="op">=</span>(<span class="st">'zero_volume'</span>, <span class="st">'count'</span>),</span>
<span id="cb21-781"><a href="#cb21-781" aria-hidden="true" tabindex="-1"></a>        n_zero<span class="op">=</span>(<span class="st">'zero_volume'</span>, <span class="st">'sum'</span>),</span>
<span id="cb21-782"><a href="#cb21-782" aria-hidden="true" tabindex="-1"></a>        avg_mcap<span class="op">=</span>(<span class="st">'market_cap'</span>, <span class="st">'mean'</span>)</span>
<span id="cb21-783"><a href="#cb21-783" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-784"><a href="#cb21-784" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb21-785"><a href="#cb21-785" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-786"><a href="#cb21-786" aria-hidden="true" tabindex="-1"></a>zero_vol_fy[<span class="st">'zero_frac'</span>] <span class="op">=</span> zero_vol_fy[<span class="st">'n_zero'</span>] <span class="op">/</span> zero_vol_fy[<span class="st">'n_days'</span>]</span>
<span id="cb21-787"><a href="#cb21-787" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-788"><a href="#cb21-788" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb21-789"><a href="#cb21-789" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-790"><a href="#cb21-790" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Distribution over time (boxplot by year)</span></span>
<span id="cb21-791"><a href="#cb21-791" aria-hidden="true" tabindex="-1"></a>years_to_plot <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2008</span>, <span class="dv">2025</span>)</span>
<span id="cb21-792"><a href="#cb21-792" aria-hidden="true" tabindex="-1"></a>data_by_year <span class="op">=</span> [</span>
<span id="cb21-793"><a href="#cb21-793" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy[zero_vol_fy[<span class="st">'year'</span>] <span class="op">==</span> y][<span class="st">'zero_frac'</span>].dropna().values</span>
<span id="cb21-794"><a href="#cb21-794" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> y <span class="kw">in</span> years_to_plot</span>
<span id="cb21-795"><a href="#cb21-795" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-796"><a href="#cb21-796" aria-hidden="true" tabindex="-1"></a>bp <span class="op">=</span> axes[<span class="dv">0</span>].boxplot(data_by_year, positions<span class="op">=</span><span class="bu">range</span>(<span class="bu">len</span>(years_to_plot)),</span>
<span id="cb21-797"><a href="#cb21-797" aria-hidden="true" tabindex="-1"></a>                      widths<span class="op">=</span><span class="fl">0.6</span>, showfliers<span class="op">=</span><span class="va">False</span>, patch_artist<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-798"><a href="#cb21-798" aria-hidden="true" tabindex="-1"></a>                      medianprops<span class="op">=</span>{<span class="st">'color'</span>: <span class="st">'black'</span>})</span>
<span id="cb21-799"><a href="#cb21-799" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> patch <span class="kw">in</span> bp[<span class="st">'boxes'</span>]:</span>
<span id="cb21-800"><a href="#cb21-800" aria-hidden="true" tabindex="-1"></a>    patch.set_facecolor(<span class="st">'#2C5F8A'</span>)</span>
<span id="cb21-801"><a href="#cb21-801" aria-hidden="true" tabindex="-1"></a>    patch.set_alpha(<span class="fl">0.6</span>)</span>
<span id="cb21-802"><a href="#cb21-802" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(years_to_plot)))</span>
<span id="cb21-803"><a href="#cb21-803" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xticklabels(years_to_plot, rotation<span class="op">=</span><span class="dv">45</span>, fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb21-804"><a href="#cb21-804" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Zero-Volume Fraction'</span>)</span>
<span id="cb21-805"><a href="#cb21-805" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Zero-Volume Days by Year'</span>)</span>
<span id="cb21-806"><a href="#cb21-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-807"><a href="#cb21-807" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: By market cap decile</span></span>
<span id="cb21-808"><a href="#cb21-808" aria-hidden="true" tabindex="-1"></a>zero_vol_fy[<span class="st">'mcap_decile'</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb21-809"><a href="#cb21-809" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy[<span class="st">'avg_mcap'</span>].rank(method<span class="op">=</span><span class="st">'first'</span>),</span>
<span id="cb21-810"><a href="#cb21-810" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span>, labels<span class="op">=</span>[<span class="ss">f'D</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>)]</span>
<span id="cb21-811"><a href="#cb21-811" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-812"><a href="#cb21-812" aria-hidden="true" tabindex="-1"></a>decile_zero <span class="op">=</span> (</span>
<span id="cb21-813"><a href="#cb21-813" aria-hidden="true" tabindex="-1"></a>    zero_vol_fy</span>
<span id="cb21-814"><a href="#cb21-814" aria-hidden="true" tabindex="-1"></a>    .groupby(<span class="st">'mcap_decile'</span>)[<span class="st">'zero_frac'</span>]</span>
<span id="cb21-815"><a href="#cb21-815" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">'mean'</span>, <span class="st">'median'</span>])</span>
<span id="cb21-816"><a href="#cb21-816" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-817"><a href="#cb21-817" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].bar(<span class="bu">range</span>(<span class="dv">10</span>), decile_zero[<span class="st">'mean'</span>],</span>
<span id="cb21-818"><a href="#cb21-818" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb21-819"><a href="#cb21-819" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(<span class="bu">range</span>(<span class="dv">10</span>))</span>
<span id="cb21-820"><a href="#cb21-820" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticklabels(decile_zero.index)</span>
<span id="cb21-821"><a href="#cb21-821" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Market Cap Decile (D1 = smallest)'</span>)</span>
<span id="cb21-822"><a href="#cb21-822" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Mean Zero-Volume Fraction'</span>)</span>
<span id="cb21-823"><a href="#cb21-823" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Zero-Volume Days by Size'</span>)</span>
<span id="cb21-824"><a href="#cb21-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-825"><a href="#cb21-825" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-826"><a href="#cb21-826" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-827"><a href="#cb21-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-828"><a href="#cb21-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-829"><a href="#cb21-829" aria-hidden="true" tabindex="-1"></a><span class="fu">### Return Measurement During Zero-Trading Periods</span></span>
<span id="cb21-830"><a href="#cb21-830" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-831"><a href="#cb21-831" aria-hidden="true" tabindex="-1"></a>When a stock does not trade, the standard approach, using the last available closing price, produces a stale price that understates true volatility and biases returns toward zero. Several approaches exist to handle this:</span>
<span id="cb21-832"><a href="#cb21-832" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-833"><a href="#cb21-833" aria-hidden="true" tabindex="-1"></a>**Approach 1: Drop zero-volume observations.** Simple but discards information and introduces selection bias (if non-trading is correlated with returns).</span>
<span id="cb21-834"><a href="#cb21-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-835"><a href="#cb21-835" aria-hidden="true" tabindex="-1"></a>**Approach 2: Multi-day compounding.** Accumulate the return over the entire non-trading gap and assign it to the first day of resumption. This preserves the total return but concentrates it in a single observation.</span>
<span id="cb21-836"><a href="#cb21-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-837"><a href="#cb21-837" aria-hidden="true" tabindex="-1"></a>**Approach 3: Distribute uniformly.** Spread the accumulated return evenly across zero-volume days. This is economically unrealistic, but it reduces the impact of single-day outliers.</span>
<span id="cb21-838"><a href="#cb21-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-839"><a href="#cb21-839" aria-hidden="true" tabindex="-1"></a>**Approach 4: Treat as missing and model.** Treat zero-volume days as genuinely missing returns and use the @lesmond2005liquidity zero-return measure as a liquidity proxy.</span>
<span id="cb21-840"><a href="#cb21-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-843"><a href="#cb21-843" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-844"><a href="#cb21-844" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: zero-vol-correction</span></span>
<span id="cb21-845"><a href="#cb21-845" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-846"><a href="#cb21-846" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement zero-trading-day return corrections"</span></span>
<span id="cb21-847"><a href="#cb21-847" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> correct_zero_volume_returns(daily_df, method<span class="op">=</span><span class="st">'compound'</span>):</span>
<span id="cb21-848"><a href="#cb21-848" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-849"><a href="#cb21-849" aria-hidden="true" tabindex="-1"></a><span class="co">    Correct returns during zero-volume periods.</span></span>
<span id="cb21-850"><a href="#cb21-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-851"><a href="#cb21-851" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-852"><a href="#cb21-852" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-853"><a href="#cb21-853" aria-hidden="true" tabindex="-1"></a><span class="co">    method : str</span></span>
<span id="cb21-854"><a href="#cb21-854" aria-hidden="true" tabindex="-1"></a><span class="co">        'compound': assign accumulated return to first non-zero day</span></span>
<span id="cb21-855"><a href="#cb21-855" aria-hidden="true" tabindex="-1"></a><span class="co">        'distribute': spread return evenly across gap</span></span>
<span id="cb21-856"><a href="#cb21-856" aria-hidden="true" tabindex="-1"></a><span class="co">        'drop': remove zero-volume observations</span></span>
<span id="cb21-857"><a href="#cb21-857" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-858"><a href="#cb21-858" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> daily_df.copy()</span>
<span id="cb21-859"><a href="#cb21-859" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">'ticker'</span>, <span class="st">'date'</span>])</span>
<span id="cb21-860"><a href="#cb21-860" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'daily_return'</span>] <span class="op">=</span> (</span>
<span id="cb21-861"><a href="#cb21-861" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>]</span>
<span id="cb21-862"><a href="#cb21-862" aria-hidden="true" tabindex="-1"></a>        .pct_change()</span>
<span id="cb21-863"><a href="#cb21-863" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-864"><a href="#cb21-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-865"><a href="#cb21-865" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> method <span class="op">==</span> <span class="st">'drop'</span>:</span>
<span id="cb21-866"><a href="#cb21-866" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> df[df[<span class="st">'volume'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb21-867"><a href="#cb21-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-868"><a href="#cb21-868" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'compound'</span>:</span>
<span id="cb21-869"><a href="#cb21-869" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each zero-volume streak, accumulate return and</span></span>
<span id="cb21-870"><a href="#cb21-870" aria-hidden="true" tabindex="-1"></a>        <span class="co"># assign to the next trading day</span></span>
<span id="cb21-871"><a href="#cb21-871" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb21-872"><a href="#cb21-872" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> df.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb21-873"><a href="#cb21-873" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-874"><a href="#cb21-874" aria-hidden="true" tabindex="-1"></a>            accumulated <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-875"><a href="#cb21-875" aria-hidden="true" tabindex="-1"></a>            gap_length <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-876"><a href="#cb21-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-877"><a href="#cb21-877" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> idx, row <span class="kw">in</span> group.iterrows():</span>
<span id="cb21-878"><a href="#cb21-878" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> row[<span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-879"><a href="#cb21-879" aria-hidden="true" tabindex="-1"></a>                    accumulated <span class="op">+=</span> row[<span class="st">'daily_return'</span>] <span class="cf">if</span> pd.notna(row[<span class="st">'daily_return'</span>]) <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb21-880"><a href="#cb21-880" aria-hidden="true" tabindex="-1"></a>                    gap_length <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-881"><a href="#cb21-881" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb21-882"><a href="#cb21-882" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> gap_length <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-883"><a href="#cb21-883" aria-hidden="true" tabindex="-1"></a>                        <span class="co"># Add accumulated return to this day's return</span></span>
<span id="cb21-884"><a href="#cb21-884" aria-hidden="true" tabindex="-1"></a>                        total_return <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> accumulated) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> (row[<span class="st">'daily_return'</span>] <span class="kw">or</span> <span class="dv">0</span>)) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-885"><a href="#cb21-885" aria-hidden="true" tabindex="-1"></a>                        group.loc[idx, <span class="st">'daily_return'</span>] <span class="op">=</span> total_return</span>
<span id="cb21-886"><a href="#cb21-886" aria-hidden="true" tabindex="-1"></a>                        accumulated <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-887"><a href="#cb21-887" aria-hidden="true" tabindex="-1"></a>                        gap_length <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-888"><a href="#cb21-888" aria-hidden="true" tabindex="-1"></a>                    results.append(group.loc[idx])</span>
<span id="cb21-889"><a href="#cb21-889" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-890"><a href="#cb21-890" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If series ends with zero-volume days, include last non-zero</span></span>
<span id="cb21-891"><a href="#cb21-891" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> gap_length <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(results) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-892"><a href="#cb21-892" aria-hidden="true" tabindex="-1"></a>                last_valid <span class="op">=</span> results[<span class="op">-</span><span class="dv">1</span>].copy()</span>
<span id="cb21-893"><a href="#cb21-893" aria-hidden="true" tabindex="-1"></a>                last_valid[<span class="st">'daily_return'</span>] <span class="op">=</span> (</span>
<span id="cb21-894"><a href="#cb21-894" aria-hidden="true" tabindex="-1"></a>                    (<span class="dv">1</span> <span class="op">+</span> last_valid[<span class="st">'daily_return'</span>]) <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> accumulated) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-895"><a href="#cb21-895" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb21-896"><a href="#cb21-896" aria-hidden="true" tabindex="-1"></a>                results[<span class="op">-</span><span class="dv">1</span>] <span class="op">=</span> last_valid</span>
<span id="cb21-897"><a href="#cb21-897" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-898"><a href="#cb21-898" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb21-899"><a href="#cb21-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-900"><a href="#cb21-900" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> method <span class="op">==</span> <span class="st">'distribute'</span>:</span>
<span id="cb21-901"><a href="#cb21-901" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> []</span>
<span id="cb21-902"><a href="#cb21-902" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker, group <span class="kw">in</span> df.groupby(<span class="st">'ticker'</span>):</span>
<span id="cb21-903"><a href="#cb21-903" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.sort_values(<span class="st">'date'</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-904"><a href="#cb21-904" aria-hidden="true" tabindex="-1"></a>            i <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb21-905"><a href="#cb21-905" aria-hidden="true" tabindex="-1"></a>            <span class="cf">while</span> i <span class="op">&lt;</span> <span class="bu">len</span>(group):</span>
<span id="cb21-906"><a href="#cb21-906" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> group.loc[i, <span class="st">'volume'</span>] <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-907"><a href="#cb21-907" aria-hidden="true" tabindex="-1"></a>                    results.append(group.loc[i])</span>
<span id="cb21-908"><a href="#cb21-908" aria-hidden="true" tabindex="-1"></a>                    i <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-909"><a href="#cb21-909" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb21-910"><a href="#cb21-910" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Find end of zero-volume streak</span></span>
<span id="cb21-911"><a href="#cb21-911" aria-hidden="true" tabindex="-1"></a>                    j <span class="op">=</span> i</span>
<span id="cb21-912"><a href="#cb21-912" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">while</span> j <span class="op">&lt;</span> <span class="bu">len</span>(group) <span class="kw">and</span> group.loc[j, <span class="st">'volume'</span>] <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb21-913"><a href="#cb21-913" aria-hidden="true" tabindex="-1"></a>                        j <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb21-914"><a href="#cb21-914" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Total return over gap</span></span>
<span id="cb21-915"><a href="#cb21-915" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> j <span class="op">&lt;</span> <span class="bu">len</span>(group):</span>
<span id="cb21-916"><a href="#cb21-916" aria-hidden="true" tabindex="-1"></a>                        total_ret <span class="op">=</span> (</span>
<span id="cb21-917"><a href="#cb21-917" aria-hidden="true" tabindex="-1"></a>                            group.loc[j, <span class="st">'adjusted_close'</span>]</span>
<span id="cb21-918"><a href="#cb21-918" aria-hidden="true" tabindex="-1"></a>                            <span class="op">/</span> group.loc[i <span class="op">-</span> <span class="dv">1</span>, <span class="st">'adjusted_close'</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-919"><a href="#cb21-919" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">if</span> i <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb21-920"><a href="#cb21-920" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb21-921"><a href="#cb21-921" aria-hidden="true" tabindex="-1"></a>                        n_days <span class="op">=</span> j <span class="op">-</span> i <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-922"><a href="#cb21-922" aria-hidden="true" tabindex="-1"></a>                        daily_r <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> total_ret) <span class="op">**</span> (<span class="dv">1</span> <span class="op">/</span> n_days) <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb21-923"><a href="#cb21-923" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(i, j <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb21-924"><a href="#cb21-924" aria-hidden="true" tabindex="-1"></a>                            row <span class="op">=</span> group.loc[k].copy()</span>
<span id="cb21-925"><a href="#cb21-925" aria-hidden="true" tabindex="-1"></a>                            row[<span class="st">'daily_return'</span>] <span class="op">=</span> daily_r</span>
<span id="cb21-926"><a href="#cb21-926" aria-hidden="true" tabindex="-1"></a>                            results.append(row)</span>
<span id="cb21-927"><a href="#cb21-927" aria-hidden="true" tabindex="-1"></a>                    i <span class="op">=</span> j <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-928"><a href="#cb21-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-929"><a href="#cb21-929" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb21-930"><a href="#cb21-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-931"><a href="#cb21-931" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply corrections and compare</span></span>
<span id="cb21-932"><a href="#cb21-932" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> method <span class="kw">in</span> [<span class="st">'drop'</span>, <span class="st">'compound'</span>, <span class="st">'distribute'</span>]:</span>
<span id="cb21-933"><a href="#cb21-933" aria-hidden="true" tabindex="-1"></a>    corrected <span class="op">=</span> correct_zero_volume_returns(</span>
<span id="cb21-934"><a href="#cb21-934" aria-hidden="true" tabindex="-1"></a>        daily_returns.head(<span class="dv">500000</span>), method<span class="op">=</span>method</span>
<span id="cb21-935"><a href="#cb21-935" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-936"><a href="#cb21-936" aria-hidden="true" tabindex="-1"></a>    mean_ret <span class="op">=</span> corrected[<span class="st">'daily_return'</span>].mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb21-937"><a href="#cb21-937" aria-hidden="true" tabindex="-1"></a>    vol <span class="op">=</span> corrected[<span class="st">'daily_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb21-938"><a href="#cb21-938" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>method<span class="sc">:&lt;12}</span><span class="ss">: Ann. Return = </span><span class="sc">{</span>mean_ret<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb21-939"><a href="#cb21-939" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"Ann. Vol = </span><span class="sc">{</span>vol<span class="sc">:.4f}</span><span class="ss">, N = </span><span class="sc">{</span><span class="bu">len</span>(corrected)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb21-940"><a href="#cb21-940" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-941"><a href="#cb21-941" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-942"><a href="#cb21-942" aria-hidden="true" tabindex="-1"></a><span class="fu">## Look-Ahead Bias {#sec-missing-lookahead}</span></span>
<span id="cb21-943"><a href="#cb21-943" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-944"><a href="#cb21-944" aria-hidden="true" tabindex="-1"></a><span class="fu">### Definition</span></span>
<span id="cb21-945"><a href="#cb21-945" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-946"><a href="#cb21-946" aria-hidden="true" tabindex="-1"></a>Look-ahead bias occurs when a study uses information that was not available at the time the investment decision would have been made. In the Vietnamese context, the most common sources are:</span>
<span id="cb21-947"><a href="#cb21-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-948"><a href="#cb21-948" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Conditioning on survival.** Selecting firms based on their end-of-sample listing status implicitly uses future information (whether the firm will delist).</span>
<span id="cb21-949"><a href="#cb21-949" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Using revised financial data.** Vietnamese firms often restate financial statements after audit. Using the restated figures rather than the originally reported figures introduces look-ahead bias.</span>
<span id="cb21-950"><a href="#cb21-950" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Backfill bias.** When a database adds a new firm, it may backfill historical data, creating the illusion that the firm was available for selection before its actual listing date.</span>
<span id="cb21-951"><a href="#cb21-951" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Point-in-time accounting data.** Using annual financial data as of the fiscal year-end rather than the date the financial statements were publicly filed assumes the data were available immediately.</span>
<span id="cb21-952"><a href="#cb21-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-953"><a href="#cb21-953" aria-hidden="true" tabindex="-1"></a><span class="fu">### Point-in-Time Adjustment</span></span>
<span id="cb21-954"><a href="#cb21-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-955"><a href="#cb21-955" aria-hidden="true" tabindex="-1"></a>We implement a point-in-time adjustment for accounting data that respects the actual reporting lag:</span>
<span id="cb21-956"><a href="#cb21-956" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-959"><a href="#cb21-959" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-960"><a href="#cb21-960" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: point-in-time</span></span>
<span id="cb21-961"><a href="#cb21-961" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-962"><a href="#cb21-962" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement point-in-time alignment of accounting data"</span></span>
<span id="cb21-963"><a href="#cb21-963" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> point_in_time_merge(monthly_df, fundamentals_df, filings_df,</span>
<span id="cb21-964"><a href="#cb21-964" aria-hidden="true" tabindex="-1"></a>                         lag_months<span class="op">=</span><span class="dv">0</span>):</span>
<span id="cb21-965"><a href="#cb21-965" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-966"><a href="#cb21-966" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge accounting data with monthly returns respecting</span></span>
<span id="cb21-967"><a href="#cb21-967" aria-hidden="true" tabindex="-1"></a><span class="co">    the actual filing date (point-in-time).</span></span>
<span id="cb21-968"><a href="#cb21-968" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-969"><a href="#cb21-969" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-970"><a href="#cb21-970" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-971"><a href="#cb21-971" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : DataFrame with ticker, month_end</span></span>
<span id="cb21-972"><a href="#cb21-972" aria-hidden="true" tabindex="-1"></a><span class="co">    fundamentals_df : DataFrame with ticker, fiscal_year, and accounting vars</span></span>
<span id="cb21-973"><a href="#cb21-973" aria-hidden="true" tabindex="-1"></a><span class="co">    filings_df : DataFrame with ticker, fiscal_year, filing_date</span></span>
<span id="cb21-974"><a href="#cb21-974" aria-hidden="true" tabindex="-1"></a><span class="co">    lag_months : int, additional safety lag beyond filing date</span></span>
<span id="cb21-975"><a href="#cb21-975" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-976"><a href="#cb21-976" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge fundamentals with filing dates</span></span>
<span id="cb21-977"><a href="#cb21-977" aria-hidden="true" tabindex="-1"></a>    fund_with_date <span class="op">=</span> fundamentals_df.merge(</span>
<span id="cb21-978"><a href="#cb21-978" aria-hidden="true" tabindex="-1"></a>        filings_df[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>]],</span>
<span id="cb21-979"><a href="#cb21-979" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb21-980"><a href="#cb21-980" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-981"><a href="#cb21-981" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-982"><a href="#cb21-982" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If filing date is missing, assume available 4 months after FY end</span></span>
<span id="cb21-983"><a href="#cb21-983" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'filing_date'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb21-984"><a href="#cb21-984" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'filing_date'</span>]</span>
<span id="cb21-985"><a href="#cb21-985" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-986"><a href="#cb21-986" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'fy_end'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb21-987"><a href="#cb21-987" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb21-988"><a href="#cb21-988" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-989"><a href="#cb21-989" aria-hidden="true" tabindex="-1"></a>    fund_with_date[<span class="st">'available_date'</span>] <span class="op">=</span> fund_with_date[<span class="st">'filing_date'</span>].fillna(</span>
<span id="cb21-990"><a href="#cb21-990" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'fy_end'</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb21-991"><a href="#cb21-991" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-992"><a href="#cb21-992" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-993"><a href="#cb21-993" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add safety lag</span></span>
<span id="cb21-994"><a href="#cb21-994" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> lag_months <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-995"><a href="#cb21-995" aria-hidden="true" tabindex="-1"></a>        fund_with_date[<span class="st">'available_date'</span>] <span class="op">+=</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb21-996"><a href="#cb21-996" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-997"><a href="#cb21-997" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each firm-month, find the most recent accounting data</span></span>
<span id="cb21-998"><a href="#cb21-998" aria-hidden="true" tabindex="-1"></a>    <span class="co"># that was available (filing_date &lt;= month_end)</span></span>
<span id="cb21-999"><a href="#cb21-999" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb21-1000"><a href="#cb21-1000" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> monthly_df.iterrows():</span>
<span id="cb21-1001"><a href="#cb21-1001" aria-hidden="true" tabindex="-1"></a>        ticker <span class="op">=</span> row[<span class="st">'ticker'</span>]</span>
<span id="cb21-1002"><a href="#cb21-1002" aria-hidden="true" tabindex="-1"></a>        month <span class="op">=</span> row[<span class="st">'month_end'</span>]</span>
<span id="cb21-1003"><a href="#cb21-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1004"><a href="#cb21-1004" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> fund_with_date[</span>
<span id="cb21-1005"><a href="#cb21-1005" aria-hidden="true" tabindex="-1"></a>            (fund_with_date[<span class="st">'ticker'</span>] <span class="op">==</span> ticker) <span class="op">&amp;</span></span>
<span id="cb21-1006"><a href="#cb21-1006" aria-hidden="true" tabindex="-1"></a>            (fund_with_date[<span class="st">'available_date'</span>] <span class="op">&lt;=</span> month)</span>
<span id="cb21-1007"><a href="#cb21-1007" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb21-1008"><a href="#cb21-1008" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1009"><a href="#cb21-1009" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb21-1010"><a href="#cb21-1010" aria-hidden="true" tabindex="-1"></a>            latest <span class="op">=</span> available.sort_values(<span class="st">'fiscal_year'</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb21-1011"><a href="#cb21-1011" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> row.to_dict()</span>
<span id="cb21-1012"><a href="#cb21-1012" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'total_assets'</span>, <span class="st">'net_income'</span>, <span class="st">'total_equity'</span>,</span>
<span id="cb21-1013"><a href="#cb21-1013" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'revenue'</span>]:</span>
<span id="cb21-1014"><a href="#cb21-1014" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> col <span class="kw">in</span> latest:</span>
<span id="cb21-1015"><a href="#cb21-1015" aria-hidden="true" tabindex="-1"></a>                    result[col] <span class="op">=</span> latest[col]</span>
<span id="cb21-1016"><a href="#cb21-1016" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'data_fiscal_year'</span>] <span class="op">=</span> latest[<span class="st">'fiscal_year'</span>]</span>
<span id="cb21-1017"><a href="#cb21-1017" aria-hidden="true" tabindex="-1"></a>            result[<span class="st">'data_lag_months'</span>] <span class="op">=</span> (</span>
<span id="cb21-1018"><a href="#cb21-1018" aria-hidden="true" tabindex="-1"></a>                (pd.Timestamp(month) <span class="op">-</span> pd.Timestamp(latest[<span class="st">'available_date'</span>]))</span>
<span id="cb21-1019"><a href="#cb21-1019" aria-hidden="true" tabindex="-1"></a>                .days <span class="op">/</span> <span class="fl">30.44</span></span>
<span id="cb21-1020"><a href="#cb21-1020" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb21-1021"><a href="#cb21-1021" aria-hidden="true" tabindex="-1"></a>            results.append(result)</span>
<span id="cb21-1022"><a href="#cb21-1022" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1023"><a href="#cb21-1023" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb21-1024"><a href="#cb21-1024" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1025"><a href="#cb21-1025" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: compare point-in-time vs naive merge</span></span>
<span id="cb21-1026"><a href="#cb21-1026" aria-hidden="true" tabindex="-1"></a>filings <span class="op">=</span> client.get_filings(</span>
<span id="cb21-1027"><a href="#cb21-1027" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb21-1028"><a href="#cb21-1028" aria-hidden="true" tabindex="-1"></a>    report_types<span class="op">=</span>[<span class="st">'annual'</span>],</span>
<span id="cb21-1029"><a href="#cb21-1029" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>]</span>
<span id="cb21-1030"><a href="#cb21-1030" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1031"><a href="#cb21-1031" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1032"><a href="#cb21-1032" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Point-in-time merge vs naive merge:"</span>)</span>
<span id="cb21-1033"><a href="#cb21-1033" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  Naive: use fiscal year directly (introduces look-ahead bias)"</span>)</span>
<span id="cb21-1034"><a href="#cb21-1034" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"  PIT: use only data available as of the portfolio formation date"</span>)</span>
<span id="cb21-1035"><a href="#cb21-1035" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1036"><a href="#cb21-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1037"><a href="#cb21-1037" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quantifying Look-Ahead Bias in Value Strategies</span></span>
<span id="cb21-1038"><a href="#cb21-1038" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1039"><a href="#cb21-1039" aria-hidden="true" tabindex="-1"></a>Value strategies sort stocks on book-to-market ratios computed from accounting data. Using end-of-fiscal-year data without respecting reporting lags inflates the value premium because it implicitly uses information that was not yet publicly available.</span>
<span id="cb21-1040"><a href="#cb21-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1043"><a href="#cb21-1043" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-1044"><a href="#cb21-1044" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: lookahead-value</span></span>
<span id="cb21-1045"><a href="#cb21-1045" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1046"><a href="#cb21-1046" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare value premium with and without point-in-time adjustment"</span></span>
<span id="cb21-1047"><a href="#cb21-1047" aria-hidden="true" tabindex="-1"></a><span class="co"># Naive approach: use fiscal year data immediately</span></span>
<span id="cb21-1048"><a href="#cb21-1048" aria-hidden="true" tabindex="-1"></a>monthly_naive <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb21-1049"><a href="#cb21-1049" aria-hidden="true" tabindex="-1"></a>    fundamentals[[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'total_equity'</span>]],</span>
<span id="cb21-1050"><a href="#cb21-1050" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_returns[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb21-1051"><a href="#cb21-1051" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>],</span>
<span id="cb21-1052"><a href="#cb21-1052" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb21-1053"><a href="#cb21-1053" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1054"><a href="#cb21-1054" aria-hidden="true" tabindex="-1"></a>monthly_naive[<span class="st">'bm_naive'</span>] <span class="op">=</span> (</span>
<span id="cb21-1055"><a href="#cb21-1055" aria-hidden="true" tabindex="-1"></a>    monthly_naive[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_naive[<span class="st">'market_cap'</span>]</span>
<span id="cb21-1056"><a href="#cb21-1056" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1057"><a href="#cb21-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1058"><a href="#cb21-1058" aria-hidden="true" tabindex="-1"></a><span class="co"># Point-in-time approach (using 4-month lag as conservative default)</span></span>
<span id="cb21-1059"><a href="#cb21-1059" aria-hidden="true" tabindex="-1"></a>monthly_pit <span class="op">=</span> monthly_returns.copy()</span>
<span id="cb21-1060"><a href="#cb21-1060" aria-hidden="true" tabindex="-1"></a>monthly_pit[<span class="st">'bm_pit'</span>] <span class="op">=</span> np.nan  <span class="co"># Would be filled by point_in_time_merge</span></span>
<span id="cb21-1061"><a href="#cb21-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1062"><a href="#cb21-1062" aria-hidden="true" tabindex="-1"></a><span class="co"># For demonstration: approximate PIT by using t-1 fiscal year data</span></span>
<span id="cb21-1063"><a href="#cb21-1063" aria-hidden="true" tabindex="-1"></a><span class="co"># (ensures data were available at formation date)</span></span>
<span id="cb21-1064"><a href="#cb21-1064" aria-hidden="true" tabindex="-1"></a>fund_lagged <span class="op">=</span> fundamentals.copy()</span>
<span id="cb21-1065"><a href="#cb21-1065" aria-hidden="true" tabindex="-1"></a>fund_lagged[<span class="st">'merge_year'</span>] <span class="op">=</span> fund_lagged[<span class="st">'fiscal_year'</span>] <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-1066"><a href="#cb21-1066" aria-hidden="true" tabindex="-1"></a>monthly_pit <span class="op">=</span> monthly_pit.merge(</span>
<span id="cb21-1067"><a href="#cb21-1067" aria-hidden="true" tabindex="-1"></a>    fund_lagged[[<span class="st">'ticker'</span>, <span class="st">'merge_year'</span>, <span class="st">'total_equity'</span>]].rename(</span>
<span id="cb21-1068"><a href="#cb21-1068" aria-hidden="true" tabindex="-1"></a>        columns<span class="op">=</span>{<span class="st">'merge_year'</span>: <span class="st">'year'</span>}),</span>
<span id="cb21-1069"><a href="#cb21-1069" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'ticker'</span>, monthly_pit[<span class="st">'month_end'</span>].dt.year],</span>
<span id="cb21-1070"><a href="#cb21-1070" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'year'</span>],</span>
<span id="cb21-1071"><a href="#cb21-1071" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb21-1072"><a href="#cb21-1072" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1073"><a href="#cb21-1073" aria-hidden="true" tabindex="-1"></a>monthly_pit[<span class="st">'bm_pit'</span>] <span class="op">=</span> (</span>
<span id="cb21-1074"><a href="#cb21-1074" aria-hidden="true" tabindex="-1"></a>    monthly_pit[<span class="st">'total_equity'</span>] <span class="op">/</span> monthly_pit[<span class="st">'market_cap'</span>]</span>
<span id="cb21-1075"><a href="#cb21-1075" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-1076"><a href="#cb21-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1077"><a href="#cb21-1077" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute HML for both approaches</span></span>
<span id="cb21-1078"><a href="#cb21-1078" aria-hidden="true" tabindex="-1"></a>hml_naive <span class="op">=</span> compute_long_short(monthly_naive, <span class="st">'bm_naive'</span>)</span>
<span id="cb21-1079"><a href="#cb21-1079" aria-hidden="true" tabindex="-1"></a>hml_pit <span class="op">=</span> compute_long_short(monthly_pit, <span class="st">'bm_pit'</span>)</span>
<span id="cb21-1080"><a href="#cb21-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1081"><a href="#cb21-1081" aria-hidden="true" tabindex="-1"></a>ann_naive <span class="op">=</span> hml_naive[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-1082"><a href="#cb21-1082" aria-hidden="true" tabindex="-1"></a>ann_pit <span class="op">=</span> hml_pit[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb21-1083"><a href="#cb21-1083" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1084"><a href="#cb21-1084" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Value Premium (HML):"</span>)</span>
<span id="cb21-1085"><a href="#cb21-1085" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Naive (look-ahead):     </span><span class="sc">{</span>ann_naive<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_naive<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb21-1086"><a href="#cb21-1086" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Point-in-time:          </span><span class="sc">{</span>ann_pit<span class="sc">:.4f}</span><span class="ss"> (</span><span class="sc">{</span>ann_pit<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr)"</span>)</span>
<span id="cb21-1087"><a href="#cb21-1087" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Look-ahead inflation:   </span><span class="sc">{</span>(ann_naive <span class="op">-</span> ann_pit)<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%/yr"</span>)</span>
<span id="cb21-1088"><a href="#cb21-1088" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1089"><a href="#cb21-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1090"><a href="#cb21-1090" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exchange Transfers and Ticker Discontinuities {#sec-missing-transfers}</span></span>
<span id="cb21-1091"><a href="#cb21-1091" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1092"><a href="#cb21-1092" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Transfer Problem</span></span>
<span id="cb21-1093"><a href="#cb21-1093" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1094"><a href="#cb21-1094" aria-hidden="true" tabindex="-1"></a>Vietnamese firms frequently transfer between exchanges (e.g., from HNX to HOSE upon meeting HOSE's listing requirements, or from HOSE to UPCoM/HNX following regulatory issues). These transfers can break the continuity of return series if the database treats each exchange listing as a separate entity.</span>
<span id="cb21-1095"><a href="#cb21-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1098"><a href="#cb21-1098" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-1099"><a href="#cb21-1099" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: transfers</span></span>
<span id="cb21-1100"><a href="#cb21-1100" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1101"><a href="#cb21-1101" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Identify and link exchange transfers"</span></span>
<span id="cb21-1102"><a href="#cb21-1102" aria-hidden="true" tabindex="-1"></a>transfers <span class="op">=</span> listing_history[</span>
<span id="cb21-1103"><a href="#cb21-1103" aria-hidden="true" tabindex="-1"></a>    listing_history[<span class="st">'transfer_from'</span>].notna()</span>
<span id="cb21-1104"><a href="#cb21-1104" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb21-1105"><a href="#cb21-1105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1106"><a href="#cb21-1106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total exchange transfers: </span><span class="sc">{</span><span class="bu">len</span>(transfers)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb21-1107"><a href="#cb21-1107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Transfer patterns:"</span>)</span>
<span id="cb21-1108"><a href="#cb21-1108" aria-hidden="true" tabindex="-1"></a>transfer_pattern <span class="op">=</span> transfers.groupby(</span>
<span id="cb21-1109"><a href="#cb21-1109" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'transfer_from'</span>, <span class="st">'transfer_to'</span>]</span>
<span id="cb21-1110"><a href="#cb21-1110" aria-hidden="true" tabindex="-1"></a>).size().sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb21-1111"><a href="#cb21-1111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(transfer_pattern.head(<span class="dv">10</span>))</span>
<span id="cb21-1112"><a href="#cb21-1112" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1113"><a href="#cb21-1113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1116"><a href="#cb21-1116" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-1117"><a href="#cb21-1117" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: link-transfers</span></span>
<span id="cb21-1118"><a href="#cb21-1118" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1119"><a href="#cb21-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Link pre-transfer and post-transfer return series"</span></span>
<span id="cb21-1120"><a href="#cb21-1120" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> link_transfer_returns(monthly_df, transfers_df):</span>
<span id="cb21-1121"><a href="#cb21-1121" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-1122"><a href="#cb21-1122" aria-hidden="true" tabindex="-1"></a><span class="co">    Link return series across exchange transfers to create</span></span>
<span id="cb21-1123"><a href="#cb21-1123" aria-hidden="true" tabindex="-1"></a><span class="co">    continuous firm-level return histories.</span></span>
<span id="cb21-1124"><a href="#cb21-1124" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-1125"><a href="#cb21-1125" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Build mapping: old_ticker -&gt; new_ticker -&gt; transfer_date</span></span>
<span id="cb21-1126"><a href="#cb21-1126" aria-hidden="true" tabindex="-1"></a>    transfer_map <span class="op">=</span> {}</span>
<span id="cb21-1127"><a href="#cb21-1127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> transfers_df.iterrows():</span>
<span id="cb21-1128"><a href="#cb21-1128" aria-hidden="true" tabindex="-1"></a>        old_ticker <span class="op">=</span> row.get(<span class="st">'transfer_from_ticker'</span>, row[<span class="st">'ticker'</span>])</span>
<span id="cb21-1129"><a href="#cb21-1129" aria-hidden="true" tabindex="-1"></a>        new_ticker <span class="op">=</span> row[<span class="st">'ticker'</span>]</span>
<span id="cb21-1130"><a href="#cb21-1130" aria-hidden="true" tabindex="-1"></a>        transfer_date <span class="op">=</span> row[<span class="st">'transfer_date'</span>]</span>
<span id="cb21-1131"><a href="#cb21-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1132"><a href="#cb21-1132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> old_ticker <span class="kw">and</span> new_ticker <span class="kw">and</span> old_ticker <span class="op">!=</span> new_ticker:</span>
<span id="cb21-1133"><a href="#cb21-1133" aria-hidden="true" tabindex="-1"></a>            transfer_map[old_ticker] <span class="op">=</span> {</span>
<span id="cb21-1134"><a href="#cb21-1134" aria-hidden="true" tabindex="-1"></a>                <span class="st">'new_ticker'</span>: new_ticker,</span>
<span id="cb21-1135"><a href="#cb21-1135" aria-hidden="true" tabindex="-1"></a>                <span class="st">'date'</span>: transfer_date</span>
<span id="cb21-1136"><a href="#cb21-1136" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb21-1137"><a href="#cb21-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1138"><a href="#cb21-1138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create unified ticker mapping</span></span>
<span id="cb21-1139"><a href="#cb21-1139" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> monthly_df.copy()</span>
<span id="cb21-1140"><a href="#cb21-1140" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'unified_ticker'</span>] <span class="op">=</span> df[<span class="st">'ticker'</span>]</span>
<span id="cb21-1141"><a href="#cb21-1141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1142"><a href="#cb21-1142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> old_t, info <span class="kw">in</span> transfer_map.items():</span>
<span id="cb21-1143"><a href="#cb21-1143" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> (</span>
<span id="cb21-1144"><a href="#cb21-1144" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'ticker'</span>] <span class="op">==</span> old_t) <span class="op">&amp;</span></span>
<span id="cb21-1145"><a href="#cb21-1145" aria-hidden="true" tabindex="-1"></a>            (df[<span class="st">'month_end'</span>] <span class="op">&lt;</span> info[<span class="st">'date'</span>])</span>
<span id="cb21-1146"><a href="#cb21-1146" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb21-1147"><a href="#cb21-1147" aria-hidden="true" tabindex="-1"></a>        df.loc[mask, <span class="st">'unified_ticker'</span>] <span class="op">=</span> info[<span class="st">'new_ticker'</span>]</span>
<span id="cb21-1148"><a href="#cb21-1148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1149"><a href="#cb21-1149" aria-hidden="true" tabindex="-1"></a>    n_linked <span class="op">=</span> <span class="bu">sum</span>(<span class="dv">1</span> <span class="cf">for</span> t <span class="kw">in</span> transfer_map <span class="cf">if</span> t <span class="kw">in</span> df[<span class="st">'ticker'</span>].values)</span>
<span id="cb21-1150"><a href="#cb21-1150" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Linked </span><span class="sc">{</span>n_linked<span class="sc">}</span><span class="ss"> transfer pairs"</span>)</span>
<span id="cb21-1151"><a href="#cb21-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1152"><a href="#cb21-1152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb21-1153"><a href="#cb21-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1154"><a href="#cb21-1154" aria-hidden="true" tabindex="-1"></a>linked <span class="op">=</span> link_transfer_returns(monthly_returns, transfers)</span>
<span id="cb21-1155"><a href="#cb21-1155" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1156"><a href="#cb21-1156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1157"><a href="#cb21-1157" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sensitivity Analysis Framework {#sec-missing-sensitivity}</span></span>
<span id="cb21-1158"><a href="#cb21-1158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1159"><a href="#cb21-1159" aria-hidden="true" tabindex="-1"></a><span class="fu">### How Fragile Are Your Results?</span></span>
<span id="cb21-1160"><a href="#cb21-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1161"><a href="#cb21-1161" aria-hidden="true" tabindex="-1"></a>Rather than choosing a single approach to handle missing data, a robust study tests how sensitive its conclusions are to different assumptions. We implement a systematic sensitivity framework that re-runs a given analysis under multiple data treatment assumptions.</span>
<span id="cb21-1162"><a href="#cb21-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1165"><a href="#cb21-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-1166"><a href="#cb21-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sensitivity-framework</span></span>
<span id="cb21-1167"><a href="#cb21-1167" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1168"><a href="#cb21-1168" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Implement sensitivity analysis for missing data assumptions"</span></span>
<span id="cb21-1169"><a href="#cb21-1169" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> sensitivity_analysis(monthly_df, listing_df, sort_variable,</span>
<span id="cb21-1170"><a href="#cb21-1170" aria-hidden="true" tabindex="-1"></a>                          compute_fn):</span>
<span id="cb21-1171"><a href="#cb21-1171" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb21-1172"><a href="#cb21-1172" aria-hidden="true" tabindex="-1"></a><span class="co">    Run an analysis under multiple data treatment assumptions.</span></span>
<span id="cb21-1173"><a href="#cb21-1173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1174"><a href="#cb21-1174" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb21-1175"><a href="#cb21-1175" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb21-1176"><a href="#cb21-1176" aria-hidden="true" tabindex="-1"></a><span class="co">    monthly_df : Full monthly return panel (including delisted)</span></span>
<span id="cb21-1177"><a href="#cb21-1177" aria-hidden="true" tabindex="-1"></a><span class="co">    listing_df : Listing history with delisting info</span></span>
<span id="cb21-1178"><a href="#cb21-1178" aria-hidden="true" tabindex="-1"></a><span class="co">    sort_variable : Column name for portfolio sorting</span></span>
<span id="cb21-1179"><a href="#cb21-1179" aria-hidden="true" tabindex="-1"></a><span class="co">    compute_fn : Function that takes a DataFrame and returns a</span></span>
<span id="cb21-1180"><a href="#cb21-1180" aria-hidden="true" tabindex="-1"></a><span class="co">                 scalar (e.g., annualized long-short return)</span></span>
<span id="cb21-1181"><a href="#cb21-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1182"><a href="#cb21-1182" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb21-1183"><a href="#cb21-1183" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb21-1184"><a href="#cb21-1184" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame with results under each assumption</span></span>
<span id="cb21-1185"><a href="#cb21-1185" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb21-1186"><a href="#cb21-1186" aria-hidden="true" tabindex="-1"></a>    survivors <span class="op">=</span> <span class="bu">set</span>(listing_df[listing_df[<span class="st">'is_active'</span>]][<span class="st">'ticker'</span>])</span>
<span id="cb21-1187"><a href="#cb21-1187" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> {}</span>
<span id="cb21-1188"><a href="#cb21-1188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1189"><a href="#cb21-1189" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Survivors only (maximum bias)</span></span>
<span id="cb21-1190"><a href="#cb21-1190" aria-hidden="true" tabindex="-1"></a>    surv_only <span class="op">=</span> monthly_df[monthly_df[<span class="st">'ticker'</span>].isin(survivors)]</span>
<span id="cb21-1191"><a href="#cb21-1191" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Survivors Only'</span>] <span class="op">=</span> compute_fn(surv_only, sort_variable)</span>
<span id="cb21-1192"><a href="#cb21-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1193"><a href="#cb21-1193" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Full sample, no delisting imputation</span></span>
<span id="cb21-1194"><a href="#cb21-1194" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full Sample (no imputation)'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb21-1195"><a href="#cb21-1195" aria-hidden="true" tabindex="-1"></a>        monthly_df, sort_variable</span>
<span id="cb21-1196"><a href="#cb21-1196" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1197"><a href="#cb21-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1198"><a href="#cb21-1198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Full sample + conservative delisting imputation (-50%)</span></span>
<span id="cb21-1199"><a href="#cb21-1199" aria-hidden="true" tabindex="-1"></a>    augmented_50 <span class="op">=</span> monthly_df.copy()</span>
<span id="cb21-1200"><a href="#cb21-1200" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append imputed returns at -50%</span></span>
<span id="cb21-1201"><a href="#cb21-1201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].iterrows():</span>
<span id="cb21-1202"><a href="#cb21-1202" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(firm.get(<span class="st">'reason_category'</span>, <span class="st">''</span>)):</span>
<span id="cb21-1203"><a href="#cb21-1203" aria-hidden="true" tabindex="-1"></a>            augmented_50 <span class="op">=</span> pd.concat([augmented_50, pd.DataFrame([{</span>
<span id="cb21-1204"><a href="#cb21-1204" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: firm[<span class="st">'ticker'</span>],</span>
<span id="cb21-1205"><a href="#cb21-1205" aria-hidden="true" tabindex="-1"></a>                <span class="st">'month_end'</span>: firm[<span class="st">'delisting_date'</span>],</span>
<span id="cb21-1206"><a href="#cb21-1206" aria-hidden="true" tabindex="-1"></a>                <span class="st">'monthly_return'</span>: <span class="op">-</span><span class="fl">0.50</span>,</span>
<span id="cb21-1207"><a href="#cb21-1207" aria-hidden="true" tabindex="-1"></a>                <span class="st">'market_cap'</span>: np.nan,</span>
<span id="cb21-1208"><a href="#cb21-1208" aria-hidden="true" tabindex="-1"></a>                sort_variable: np.nan</span>
<span id="cb21-1209"><a href="#cb21-1209" aria-hidden="true" tabindex="-1"></a>            }])], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-1210"><a href="#cb21-1210" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full + Impute -50%'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb21-1211"><a href="#cb21-1211" aria-hidden="true" tabindex="-1"></a>        augmented_50, sort_variable</span>
<span id="cb21-1212"><a href="#cb21-1212" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1213"><a href="#cb21-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1214"><a href="#cb21-1214" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Full sample + aggressive delisting imputation (-100%)</span></span>
<span id="cb21-1215"><a href="#cb21-1215" aria-hidden="true" tabindex="-1"></a>    augmented_100 <span class="op">=</span> monthly_df.copy()</span>
<span id="cb21-1216"><a href="#cb21-1216" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, firm <span class="kw">in</span> listing_df[listing_df[<span class="st">'delisting_date'</span>].notna()].iterrows():</span>
<span id="cb21-1217"><a href="#cb21-1217" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'Financial Distress'</span> <span class="kw">in</span> <span class="bu">str</span>(firm.get(<span class="st">'reason_category'</span>, <span class="st">''</span>)):</span>
<span id="cb21-1218"><a href="#cb21-1218" aria-hidden="true" tabindex="-1"></a>            augmented_100 <span class="op">=</span> pd.concat([augmented_100, pd.DataFrame([{</span>
<span id="cb21-1219"><a href="#cb21-1219" aria-hidden="true" tabindex="-1"></a>                <span class="st">'ticker'</span>: firm[<span class="st">'ticker'</span>],</span>
<span id="cb21-1220"><a href="#cb21-1220" aria-hidden="true" tabindex="-1"></a>                <span class="st">'month_end'</span>: firm[<span class="st">'delisting_date'</span>],</span>
<span id="cb21-1221"><a href="#cb21-1221" aria-hidden="true" tabindex="-1"></a>                <span class="st">'monthly_return'</span>: <span class="op">-</span><span class="fl">1.00</span>,</span>
<span id="cb21-1222"><a href="#cb21-1222" aria-hidden="true" tabindex="-1"></a>                <span class="st">'market_cap'</span>: np.nan,</span>
<span id="cb21-1223"><a href="#cb21-1223" aria-hidden="true" tabindex="-1"></a>                sort_variable: np.nan</span>
<span id="cb21-1224"><a href="#cb21-1224" aria-hidden="true" tabindex="-1"></a>            }])], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb21-1225"><a href="#cb21-1225" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Full + Impute -100%'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb21-1226"><a href="#cb21-1226" aria-hidden="true" tabindex="-1"></a>        augmented_100, sort_variable</span>
<span id="cb21-1227"><a href="#cb21-1227" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1228"><a href="#cb21-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1229"><a href="#cb21-1229" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Exclude bottom market cap quintile (liquidity filter)</span></span>
<span id="cb21-1230"><a href="#cb21-1230" aria-hidden="true" tabindex="-1"></a>    liquid <span class="op">=</span> monthly_df.copy()</span>
<span id="cb21-1231"><a href="#cb21-1231" aria-hidden="true" tabindex="-1"></a>    liquid[<span class="st">'mcap_quintile'</span>] <span class="op">=</span> (</span>
<span id="cb21-1232"><a href="#cb21-1232" aria-hidden="true" tabindex="-1"></a>        liquid.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb21-1233"><a href="#cb21-1233" aria-hidden="true" tabindex="-1"></a>        .transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">'drop'</span>))</span>
<span id="cb21-1234"><a href="#cb21-1234" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1235"><a href="#cb21-1235" aria-hidden="true" tabindex="-1"></a>    liquid <span class="op">=</span> liquid[liquid[<span class="st">'mcap_quintile'</span>] <span class="op">&gt;</span> <span class="dv">0</span>]</span>
<span id="cb21-1236"><a href="#cb21-1236" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'Exclude Bottom Quintile'</span>] <span class="op">=</span> compute_fn(</span>
<span id="cb21-1237"><a href="#cb21-1237" aria-hidden="true" tabindex="-1"></a>        liquid, sort_variable</span>
<span id="cb21-1238"><a href="#cb21-1238" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-1239"><a href="#cb21-1239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1240"><a href="#cb21-1240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame.from_dict(results, orient<span class="op">=</span><span class="st">'index'</span>,</span>
<span id="cb21-1241"><a href="#cb21-1241" aria-hidden="true" tabindex="-1"></a>                                   columns<span class="op">=</span>[<span class="st">'Result'</span>])</span>
<span id="cb21-1242"><a href="#cb21-1242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1243"><a href="#cb21-1243" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: sensitivity of size premium</span></span>
<span id="cb21-1244"><a href="#cb21-1244" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_size_premium(df, sort_var):</span>
<span id="cb21-1245"><a href="#cb21-1245" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> compute_long_short(df, sort_var, n_quantiles<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb21-1246"><a href="#cb21-1246" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ls[<span class="st">'long_short'</span>].mean() <span class="op">*</span> <span class="dv">12</span> <span class="cf">if</span> <span class="bu">len</span>(ls) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb21-1247"><a href="#cb21-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1248"><a href="#cb21-1248" aria-hidden="true" tabindex="-1"></a><span class="co"># Would need sort variable in the data; illustrative call:</span></span>
<span id="cb21-1249"><a href="#cb21-1249" aria-hidden="true" tabindex="-1"></a><span class="co"># sensitivity_results = sensitivity_analysis(</span></span>
<span id="cb21-1250"><a href="#cb21-1250" aria-hidden="true" tabindex="-1"></a><span class="co">#     monthly_with_chars, listing_history, 'log_mcap',</span></span>
<span id="cb21-1251"><a href="#cb21-1251" aria-hidden="true" tabindex="-1"></a><span class="co">#     compute_size_premium</span></span>
<span id="cb21-1252"><a href="#cb21-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb21-1253"><a href="#cb21-1253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1254"><a href="#cb21-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1257"><a href="#cb21-1257" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb21-1258"><a href="#cb21-1258" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-sensitivity</span></span>
<span id="cb21-1259"><a href="#cb21-1259" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb21-1260"><a href="#cb21-1260" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Sensitivity of anomaly premia to data treatment assumptions. Each bar represents the annualized long-short return under a different assumption about survivorship, delisting imputation, and liquidity filtering. Results that are robust to these choices are more credible; results that vary dramatically signal a fragile finding."</span></span>
<span id="cb21-1261"><a href="#cb21-1261" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize sensitivity of anomaly premia to data treatment"</span></span>
<span id="cb21-1262"><a href="#cb21-1262" aria-hidden="true" tabindex="-1"></a><span class="co"># Illustrative: create synthetic sensitivity results for plotting</span></span>
<span id="cb21-1263"><a href="#cb21-1263" aria-hidden="true" tabindex="-1"></a>assumptions <span class="op">=</span> [</span>
<span id="cb21-1264"><a href="#cb21-1264" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Survivors Only'</span>,</span>
<span id="cb21-1265"><a href="#cb21-1265" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full Sample</span><span class="ch">\n</span><span class="st">(no imputation)'</span>,</span>
<span id="cb21-1266"><a href="#cb21-1266" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -30%'</span>,</span>
<span id="cb21-1267"><a href="#cb21-1267" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -50%'</span>,</span>
<span id="cb21-1268"><a href="#cb21-1268" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Full +</span><span class="ch">\n</span><span class="st">Impute -100%'</span>,</span>
<span id="cb21-1269"><a href="#cb21-1269" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Exclude Bottom</span><span class="ch">\n</span><span class="st">Mcap Quintile'</span></span>
<span id="cb21-1270"><a href="#cb21-1270" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb21-1271"><a href="#cb21-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1272"><a href="#cb21-1272" aria-hidden="true" tabindex="-1"></a><span class="co"># Hypothetical results (would be computed from actual data)</span></span>
<span id="cb21-1273"><a href="#cb21-1273" aria-hidden="true" tabindex="-1"></a>size_premium <span class="op">=</span> [<span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.055</span>, <span class="fl">0.05</span>, <span class="fl">0.04</span>, <span class="fl">0.07</span>]</span>
<span id="cb21-1274"><a href="#cb21-1274" aria-hidden="true" tabindex="-1"></a>value_premium <span class="op">=</span> [<span class="fl">0.07</span>, <span class="fl">0.065</span>, <span class="fl">0.063</span>, <span class="fl">0.06</span>, <span class="fl">0.055</span>, <span class="fl">0.068</span>]</span>
<span id="cb21-1275"><a href="#cb21-1275" aria-hidden="true" tabindex="-1"></a>momentum_premium <span class="op">=</span> [<span class="fl">0.10</span>, <span class="fl">0.08</span>, <span class="fl">0.075</span>, <span class="fl">0.07</span>, <span class="fl">0.06</span>, <span class="fl">0.09</span>]</span>
<span id="cb21-1276"><a href="#cb21-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1277"><a href="#cb21-1277" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb21-1278"><a href="#cb21-1278" aria-hidden="true" tabindex="-1"></a>x <span class="op">=</span> np.arange(<span class="bu">len</span>(assumptions))</span>
<span id="cb21-1279"><a href="#cb21-1279" aria-hidden="true" tabindex="-1"></a>width <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb21-1280"><a href="#cb21-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1281"><a href="#cb21-1281" aria-hidden="true" tabindex="-1"></a>ax.bar(x <span class="op">-</span> width, [s <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> s <span class="kw">in</span> size_premium], width,</span>
<span id="cb21-1282"><a href="#cb21-1282" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#2C5F8A'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Size (SMB)'</span>)</span>
<span id="cb21-1283"><a href="#cb21-1283" aria-hidden="true" tabindex="-1"></a>ax.bar(x, [v <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> v <span class="kw">in</span> value_premium], width,</span>
<span id="cb21-1284"><a href="#cb21-1284" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#27AE60'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Value (HML)'</span>)</span>
<span id="cb21-1285"><a href="#cb21-1285" aria-hidden="true" tabindex="-1"></a>ax.bar(x <span class="op">+</span> width, [m <span class="op">*</span> <span class="dv">100</span> <span class="cf">for</span> m <span class="kw">in</span> momentum_premium], width,</span>
<span id="cb21-1286"><a href="#cb21-1286" aria-hidden="true" tabindex="-1"></a>       color<span class="op">=</span><span class="st">'#E67E22'</span>, alpha<span class="op">=</span><span class="fl">0.85</span>, label<span class="op">=</span><span class="st">'Momentum (WML)'</span>)</span>
<span id="cb21-1287"><a href="#cb21-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1288"><a href="#cb21-1288" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(x)</span>
<span id="cb21-1289"><a href="#cb21-1289" aria-hidden="true" tabindex="-1"></a>ax.set_xticklabels(assumptions, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb21-1290"><a href="#cb21-1290" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Annualized Premium (%)'</span>)</span>
<span id="cb21-1291"><a href="#cb21-1291" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Anomaly Premium Sensitivity to Data Treatment'</span>)</span>
<span id="cb21-1292"><a href="#cb21-1292" aria-hidden="true" tabindex="-1"></a>ax.legend()</span>
<span id="cb21-1293"><a href="#cb21-1293" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb21-1294"><a href="#cb21-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1295"><a href="#cb21-1295" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb21-1296"><a href="#cb21-1296" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb21-1297"><a href="#cb21-1297" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb21-1298"><a href="#cb21-1298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1299"><a href="#cb21-1299" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Recommendations {#sec-missing-recommendations}</span></span>
<span id="cb21-1300"><a href="#cb21-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1301"><a href="#cb21-1301" aria-hidden="true" tabindex="-1"></a>Based on the analysis in this chapter, we offer the following recommendations for researchers working with Vietnamese equity data:</span>
<span id="cb21-1302"><a href="#cb21-1302" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1303"><a href="#cb21-1303" aria-hidden="true" tabindex="-1"></a>**1. Always use survivorship-bias-free databases.** When querying DataCore.vn (or any database), explicitly request <span class="in">`include_delisted=True`</span>. Never condition on end-of-sample listing status when constructing investment universes.</span>
<span id="cb21-1304"><a href="#cb21-1304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1305"><a href="#cb21-1305" aria-hidden="true" tabindex="-1"></a>**2. Impute delisting returns.** For involuntary delistings (financial distress, regulatory enforcement), impute a terminal return of âˆ’30% to âˆ’50% in the delisting month. Report results across a range of imputation assumptions as a robustness check. For voluntary delistings and exchange transfers, impute 0%.</span>
<span id="cb21-1306"><a href="#cb21-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1307"><a href="#cb21-1307" aria-hidden="true" tabindex="-1"></a>**3. Respect point-in-time data availability.** Use accounting data only after its public filing date, not as of the fiscal year-end. In Vietnam, the standard lag is 90 days for annual reports; use a conservative 4-6 month lag.</span>
<span id="cb21-1308"><a href="#cb21-1308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1309"><a href="#cb21-1309" aria-hidden="true" tabindex="-1"></a>**4. Handle zero-volume days explicitly.** Document the prevalence of zero-volume days in your sample. For monthly returns, report the average number of zero-volume days per firm-month. Consider excluding firms with zero-volume fractions exceeding 50% from the investable universe.</span>
<span id="cb21-1310"><a href="#cb21-1310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1311"><a href="#cb21-1311" aria-hidden="true" tabindex="-1"></a>**5. Link exchange transfers.** Use unified tickers that link pre-transfer and post-transfer series. Without this, exchange transfers appear as simultaneous delistings and new listings, inflating turnover and biasing survival calculations.</span>
<span id="cb21-1312"><a href="#cb21-1312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1313"><a href="#cb21-1313" aria-hidden="true" tabindex="-1"></a>**6. Report sensitivity analysis.** For any key finding, report results under at least three data treatment assumptions: survivors-only (upper bound), full sample with moderate imputation (baseline), and full sample with aggressive imputation plus liquidity filter (lower bound). If the finding survives all three, it is robust.</span>
<span id="cb21-1314"><a href="#cb21-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1315"><a href="#cb21-1315" aria-hidden="true" tabindex="-1"></a>**7. Be especially cautious with pre-2007 data.** The Vietnamese market had fewer than 100 listings before 2006, and the equitization wave of 2006-2009 produced a cohort of firms with systematically different characteristics than earlier listings. Cross-sectional tests with pre-2007 data have minimal power and should be interpreted with extreme caution.</span>
<span id="cb21-1316"><a href="#cb21-1316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1317"><a href="#cb21-1317" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary {#sec-missing-summary}</span></span>
<span id="cb21-1318"><a href="#cb21-1318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1319"><a href="#cb21-1319" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Data Problem <span class="pp">|</span> Bias Direction <span class="pp">|</span> Magnitude (Vietnam) <span class="pp">|</span> Recommended Fix <span class="pp">|</span></span>
<span id="cb21-1320"><a href="#cb21-1320" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------|------------------|------------------|------------------|</span></span>
<span id="cb21-1321"><a href="#cb21-1321" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Survivorship bias (EW) <span class="pp">|</span> Upward on returns <span class="pp">|</span> \~1-3% per year <span class="pp">|</span> Include all delisted firms <span class="pp">|</span></span>
<span id="cb21-1322"><a href="#cb21-1322" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Survivorship bias (VW) <span class="pp">|</span> Upward (smaller) <span class="pp">|</span> \~0.2-0.5% per year <span class="pp">|</span> Include all delisted firms <span class="pp">|</span></span>
<span id="cb21-1323"><a href="#cb21-1323" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Delisting return bias <span class="pp">|</span> Upward on returns <span class="pp">|</span> \~0.5--2% per year (EW) <span class="pp">|</span> Impute terminal returns <span class="pp">|</span></span>
<span id="cb21-1324"><a href="#cb21-1324" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Look-ahead bias <span class="pp">|</span> Inflates predictability <span class="pp">|</span> Varies by strategy <span class="pp">|</span> Point-in-time data alignment <span class="pp">|</span></span>
<span id="cb21-1325"><a href="#cb21-1325" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Zero-trading days <span class="pp">|</span> Understates volatility <span class="pp">|</span> Severe for small caps <span class="pp">|</span> Compound or drop; document <span class="pp">|</span></span>
<span id="cb21-1326"><a href="#cb21-1326" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Exchange transfers <span class="pp">|</span> Creates false delistings <span class="pp">|</span> \~50-100 firms <span class="pp">|</span> Link unified tickers <span class="pp">|</span></span>
<span id="cb21-1327"><a href="#cb21-1327" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> New-listing bias <span class="pp">|</span> Early sample unrepresentative <span class="pp">|</span> Extreme pre-2007 <span class="pp">|</span> Start sample after 2007 <span class="pp">|</span></span>
<span id="cb21-1328"><a href="#cb21-1328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1329"><a href="#cb21-1329" aria-hidden="true" tabindex="-1"></a>: Summary of data problems, their effects, and recommended corrections. {#tbl-missing-summary}</span>
<span id="cb21-1330"><a href="#cb21-1330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1331"><a href="#cb21-1331" aria-hidden="true" tabindex="-1"></a>The central message is that data problems in Vietnamese equity research are not merely a nuisance--they can create economically significant biases that alter the conclusions of empirical studies. The survivorship bias alone exceeds 100 basis points per year for equal-weighted portfolios, comparable to many documented anomaly premia. Researchers who ignore these issues risk reporting results that reflect data artifacts rather than genuine economic phenomena.</span>
<span id="cb21-1332"><a href="#cb21-1332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1333"><a href="#cb21-1333" aria-hidden="true" tabindex="-1"></a><span class="in">```{=html}</span></span>
<span id="cb21-1334"><a href="#cb21-1334" aria-hidden="true" tabindex="-1"></a><span class="in">&lt;!-- ## Exercises {#sec-missing-exercises}</span></span>
<span id="cb21-1335"><a href="#cb21-1335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1336"><a href="#cb21-1336" aria-hidden="true" tabindex="-1"></a><span class="in">1. **Delisting return estimation from final prices.** For a sample of delisted Vietnamese firms, obtain the last 60 trading days of price data before delisting. Compute the cumulative return over this window. What is the average "run-up to delisting" return? Does it vary by delisting reason?</span></span>
<span id="cb21-1337"><a href="#cb21-1337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1338"><a href="#cb21-1338" aria-hidden="true" tabindex="-1"></a><span class="in">2. **Survivorship bias in fund performance.** Vietnamese open-ended mutual funds also experience survivorship bias (poorly performing funds are closed or merged). Using DataCore.vn's fund data, compare average fund returns in a survivorship-bias-free sample versus a survivors-only sample. How does the bias compare to @rohleder2011survivorship's findings for U.S. funds?</span></span>
<span id="cb21-1339"><a href="#cb21-1339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1340"><a href="#cb21-1340" aria-hidden="true" tabindex="-1"></a><span class="in">3. **Heckman selection correction.** Implement the @heckman1979sample two-step correction for survivorship bias. In the first stage, estimate a probit model for the probability of delisting. In the second stage, include the inverse Mills ratio as a control variable in cross-sectional return regressions. Does the correction materially change the estimated size or value premia?</span></span>
<span id="cb21-1341"><a href="#cb21-1341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1342"><a href="#cb21-1342" aria-hidden="true" tabindex="-1"></a><span class="in">4. **Multiple imputation.** Instead of a single imputed delisting return, implement a multiple imputation procedure: draw the delisting return from a distribution calibrated to observed terminal returns of similar firms. Repeat the analysis 100 times and report the distribution of results. How does parameter uncertainty from imputation compare to sampling uncertainty?</span></span>
<span id="cb21-1343"><a href="#cb21-1343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1344"><a href="#cb21-1344" aria-hidden="true" tabindex="-1"></a><span class="in">5. **Backfill bias detection.** Identify firms in the DataCore.vn database where historical data appears before the official listing date. What fraction of firms exhibit this pattern? Does excluding backfilled observations change the estimated size premium?</span></span>
<span id="cb21-1345"><a href="#cb21-1345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1346"><a href="#cb21-1346" aria-hidden="true" tabindex="-1"></a><span class="in">6. **Zero-volume and momentum.** Test whether the momentum anomaly is affected by the treatment of zero-volume days. Specifically, do zero-volume days create spurious autocorrelation in individual stock returns that inflates the apparent momentum premium?</span></span>
<span id="cb21-1347"><a href="#cb21-1347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1348"><a href="#cb21-1348" aria-hidden="true" tabindex="-1"></a><span class="in">7. **Real-time delisting monitor.** Design a scoring model that predicts involuntary delisting 6--12 months in advance using financial ratios, trading activity, and governance indicators. What is the model's predictive accuracy? How would a portfolio that screens out high-delisting-risk firms perform relative to an unscreened benchmark?</span></span>
<span id="cb21-1349"><a href="#cb21-1349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-1350"><a href="#cb21-1350" aria-hidden="true" tabindex="-1"></a><span class="in">8. **Cross-country comparison.** Compare the survivorship bias magnitude in Vietnam to estimates for the U.S. [@shumway1997delisting], other ASEAN markets, and China. What institutional features explain cross-country differences in the severity of survivorship bias? --&gt;</span></span>
<span id="cb21-1351"><a href="#cb21-1351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/15_missing_data_and_survivorship.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>