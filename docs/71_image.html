<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>45&nbsp; Image and Visual Data in Finance – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./99_conclusion.html" rel="next">
<link href="./70_textual.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="45&nbsp; Image and Visual Data in Finance – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="45&nbsp; Image and Visual Data in Finance – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./70_textual.html">Alternative Data and AI for Finance</a></li><li class="breadcrumb-item"><a href="./71_image.html"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Alternative Data and AI for Finance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#foundations-from-pixels-to-financial-signals" id="toc-foundations-from-pixels-to-financial-signals" class="nav-link active" data-scroll-target="#foundations-from-pixels-to-financial-signals"><span class="header-section-number">45.1</span> Foundations: From Pixels to Financial Signals</a>
  <ul class="collapse">
  <li><a href="#image-representation" id="toc-image-representation" class="nav-link" data-scroll-target="#image-representation"><span class="header-section-number">45.1.1</span> Image Representation</a></li>
  <li><a href="#transfer-learning-for-finance" id="toc-transfer-learning-for-finance" class="nav-link" data-scroll-target="#transfer-learning-for-finance"><span class="header-section-number">45.1.2</span> Transfer Learning for Finance</a></li>
  </ul></li>
  <li><a href="#satellite-and-geospatial-imagery" id="toc-satellite-and-geospatial-imagery" class="nav-link" data-scroll-target="#satellite-and-geospatial-imagery"><span class="header-section-number">45.2</span> Satellite and Geospatial Imagery</a>
  <ul class="collapse">
  <li><a href="#economic-activity-from-space" id="toc-economic-activity-from-space" class="nav-link" data-scroll-target="#economic-activity-from-space"><span class="header-section-number">45.2.1</span> Economic Activity from Space</a></li>
  <li><a href="#application-1-nighttime-luminosity-and-provincial-gdp" id="toc-application-1-nighttime-luminosity-and-provincial-gdp" class="nav-link" data-scroll-target="#application-1-nighttime-luminosity-and-provincial-gdp"><span class="header-section-number">45.2.2</span> Application 1: Nighttime Luminosity and Provincial GDP</a></li>
  <li><a href="#application-2-satellite-imagery-for-sector-nowcasting" id="toc-application-2-satellite-imagery-for-sector-nowcasting" class="nav-link" data-scroll-target="#application-2-satellite-imagery-for-sector-nowcasting"><span class="header-section-number">45.2.3</span> Application 2: Satellite Imagery for Sector Nowcasting</a></li>
  <li><a href="#satellite-feature-extraction-with-cnns" id="toc-satellite-feature-extraction-with-cnns" class="nav-link" data-scroll-target="#satellite-feature-extraction-with-cnns"><span class="header-section-number">45.2.4</span> Satellite Feature Extraction with CNNs</a></li>
  </ul></li>
  <li><a href="#document-image-analysis" id="toc-document-image-analysis" class="nav-link" data-scroll-target="#document-image-analysis"><span class="header-section-number">45.3</span> Document Image Analysis</a>
  <ul class="collapse">
  <li><a href="#the-vietnamese-filing-problem" id="toc-the-vietnamese-filing-problem" class="nav-link" data-scroll-target="#the-vietnamese-filing-problem"><span class="header-section-number">45.3.1</span> The Vietnamese Filing Problem</a></li>
  <li><a href="#ocr-for-vietnamese-financial-documents" id="toc-ocr-for-vietnamese-financial-documents" class="nav-link" data-scroll-target="#ocr-for-vietnamese-financial-documents"><span class="header-section-number">45.3.2</span> OCR for Vietnamese Financial Documents</a></li>
  <li><a href="#table-extraction-from-financial-statements" id="toc-table-extraction-from-financial-statements" class="nav-link" data-scroll-target="#table-extraction-from-financial-statements"><span class="header-section-number">45.3.3</span> Table Extraction from Financial Statements</a></li>
  <li><a href="#layout-aware-document-understanding" id="toc-layout-aware-document-understanding" class="nav-link" data-scroll-target="#layout-aware-document-understanding"><span class="header-section-number">45.3.4</span> Layout-Aware Document Understanding</a></li>
  </ul></li>
  <li><a href="#chart-and-figure-digitization" id="toc-chart-and-figure-digitization" class="nav-link" data-scroll-target="#chart-and-figure-digitization"><span class="header-section-number">45.4</span> Chart and Figure Digitization</a>
  <ul class="collapse">
  <li><a href="#motivation-unlocking-visual-financial-data" id="toc-motivation-unlocking-visual-financial-data" class="nav-link" data-scroll-target="#motivation-unlocking-visual-financial-data"><span class="header-section-number">45.4.1</span> Motivation: Unlocking Visual Financial Data</a></li>
  <li><a href="#chart-type-classification" id="toc-chart-type-classification" class="nav-link" data-scroll-target="#chart-type-classification"><span class="header-section-number">45.4.2</span> Chart Type Classification</a></li>
  <li><a href="#line-chart-digitization" id="toc-line-chart-digitization" class="nav-link" data-scroll-target="#line-chart-digitization"><span class="header-section-number">45.4.3</span> Line Chart Digitization</a></li>
  </ul></li>
  <li><a href="#visual-sentiment-analysis" id="toc-visual-sentiment-analysis" class="nav-link" data-scroll-target="#visual-sentiment-analysis"><span class="header-section-number">45.5</span> Visual Sentiment Analysis</a>
  <ul class="collapse">
  <li><a href="#image-sentiment-in-financial-news" id="toc-image-sentiment-in-financial-news" class="nav-link" data-scroll-target="#image-sentiment-in-financial-news"><span class="header-section-number">45.5.1</span> Image Sentiment in Financial News</a></li>
  <li><a href="#cnn-based-visual-sentiment" id="toc-cnn-based-visual-sentiment" class="nav-link" data-scroll-target="#cnn-based-visual-sentiment"><span class="header-section-number">45.5.2</span> CNN-Based Visual Sentiment</a></li>
  <li><a href="#vision-language-models-for-financial-image-understanding" id="toc-vision-language-models-for-financial-image-understanding" class="nav-link" data-scroll-target="#vision-language-models-for-financial-image-understanding"><span class="header-section-number">45.5.3</span> Vision-Language Models for Financial Image Understanding</a></li>
  </ul></li>
  <li><a href="#multimodal-fusion-combining-image-and-text" id="toc-multimodal-fusion-combining-image-and-text" class="nav-link" data-scroll-target="#multimodal-fusion-combining-image-and-text"><span class="header-section-number">45.6</span> Multimodal Fusion: Combining Image and Text</a>
  <ul class="collapse">
  <li><a href="#why-multimodal" id="toc-why-multimodal" class="nav-link" data-scroll-target="#why-multimodal"><span class="header-section-number">45.6.1</span> Why Multimodal?</a></li>
  <li><a href="#practical-considerations-for-vietnamese-markets" id="toc-practical-considerations-for-vietnamese-markets" class="nav-link" data-scroll-target="#practical-considerations-for-vietnamese-markets"><span class="header-section-number">45.6.2</span> Practical Considerations for Vietnamese Markets</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">45.7</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/71_image.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./70_textual.html">Alternative Data and AI for Finance</a></li><li class="breadcrumb-item"><a href="./71_image.html"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>The previous chapter demonstrated how unstructured text (e.g., earnings reports, news articles, business descriptions) can be transformed into structured signals for financial analysis. This chapter extends the alternative data toolkit to a second modality: images. Visual data is abundant in financial contexts yet systematically underexploited. Satellite photographs reveal real economic activity (e.g., parking lot occupancy at retail locations, construction progress at industrial sites, nighttime luminosity as a proxy for regional GDP, ship traffic at port terminals, crop health across agricultural zones). Corporate documents arrive as scanned PDFs whose tables and figures resist standard text extraction. Financial charts encode information that analysts interpret visually but that systematic strategies cannot consume without digitization. And the visual content of social media, advertising, and product imagery carries sentiment and brand signals that complement textual analysis.</p>
<p>The core challenge is representational: an image is a three-dimensional tensor of pixel intensities with no inherent semantic structure. Converting this raw array into a financial signal (i.e., a number that predicts returns, measures risk, or proxies for economic activity) requires either hand-crafted feature engineering or learned representations via deep convolutional neural networks (CNNs) and vision transformers (ViTs). This chapter covers both approaches.</p>
<p>We organize the material around five application domains, each with distinct data sources, modeling requirements, and economic motivations. First, satellite and geospatial imagery for nowcasting economic activity. Second, document image analysis for extracting structured data from Vietnamese financial filings. Third, chart and figure digitization for systematic backtesting. Fourth, visual sentiment analysis from social and news media. Fifth, multimodal fusion, combining image and text signals into joint predictive models.</p>
<p>Vietnamese markets present particular opportunities in this space. Satellite imagery is especially informative in an economy with large agricultural and manufacturing sectors where ground-truth data arrives with significant lags. Vietnamese financial filings are often distributed as scanned images rather than machine-readable formats, making document AI essential rather than optional. And the rapid urbanization visible in construction and infrastructure imagery provides high-frequency proxies for macroeconomic momentum that official statistics cannot match.</p>
<div id="setup" class="cell" data-message="false" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Core image processing</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Deep learning</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.models <span class="im">as</span> models</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical analysis</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="foundations-from-pixels-to-financial-signals" class="level2" data-number="45.1">
<h2 data-number="45.1" class="anchored" data-anchor-id="foundations-from-pixels-to-financial-signals"><span class="header-section-number">45.1</span> Foundations: From Pixels to Financial Signals</h2>
<section id="image-representation" class="level3" data-number="45.1.1">
<h3 data-number="45.1.1" class="anchored" data-anchor-id="image-representation"><span class="header-section-number">45.1.1</span> Image Representation</h3>
<p>A digital image is a function <span class="math inline">\(I: \{1, \ldots, H\} \times \{1, \ldots, W\} \times \{1, \ldots, C\} \rightarrow [0, 255]\)</span> mapping spatial coordinates and color channels to intensity values. For an RGB image of height <span class="math inline">\(H\)</span> and width <span class="math inline">\(W\)</span>, the representation is a tensor <span class="math inline">\(\mathbf{I} \in \mathbb{R}^{H \times W \times 3}\)</span>. A single <span class="math inline">\(224 \times 224\)</span> RGB image (i.e., the standard input for modern CNNs) contains <span class="math inline">\(224 \times 224 \times 3 = 150{,}528\)</span> dimensions. This extreme dimensionality, combined with spatial structure (nearby pixels are correlated), makes images fundamentally different from tabular financial data and demands specialized architectures.</p>
<p>The key insight of convolutional neural networks is parameter sharing via local filters. A convolutional layer applies a kernel <span class="math inline">\(\mathbf{K} \in \mathbb{R}^{k \times k \times C_{\text{in}}}\)</span> to produce a feature map:</p>
<p><span id="eq-convolution"><span class="math display">\[
(\mathbf{I} * \mathbf{K})(i, j) = \sum_{m=0}^{k-1} \sum_{n=0}^{k-1} \sum_{c=1}^{C_{\text{in}}} I(i+m, j+n, c) \cdot K(m, n, c)
\tag{45.1}\]</span></span></p>
<p>By stacking convolutional layers with nonlinearities and pooling operations, the network builds a hierarchy of representations: early layers detect edges and textures; middle layers detect parts and patterns; deep layers detect objects and scenes. The final layer output <span class="math inline">\(\mathbf{z} \in \mathbb{R}^{d}\)</span> (with <span class="math inline">\(d\)</span> typically 512-2048) is a compact representation of the image’s semantic content, which can be used directly as a feature vector for financial prediction.</p>
</section>
<section id="transfer-learning-for-finance" class="level3" data-number="45.1.2">
<h3 data-number="45.1.2" class="anchored" data-anchor-id="transfer-learning-for-finance"><span class="header-section-number">45.1.2</span> Transfer Learning for Finance</h3>
<p>Training a CNN from scratch requires millions of labeled images, which is far more than any financial application can provide. Transfer learning solves this by using networks pre-trained on ImageNet (1.2 million images, 1,000 classes) as feature extractors. The pre-trained network has already learned generic visual representations (edges, textures, shapes, objects); we simply replace the final classification layer with a task-specific head.</p>
<p>Formally, let <span class="math inline">\(f_{\boldsymbol{\theta}}(\mathbf{I})\)</span> denote a pre-trained network with parameters <span class="math inline">\(\boldsymbol{\theta}\)</span> partitioned into feature extractor <span class="math inline">\(\boldsymbol{\theta}_{\text{feat}}\)</span> and classifier <span class="math inline">\(\boldsymbol{\theta}_{\text{cls}}\)</span>. For financial applications, we:</p>
<ol type="1">
<li><strong>Feature extraction</strong>: Freeze <span class="math inline">\(\boldsymbol{\theta}_{\text{feat}}\)</span>, extract <span class="math inline">\(\mathbf{z} = f_{\boldsymbol{\theta}_{\text{feat}}}(\mathbf{I})\)</span>, and train a simple model (linear regression, gradient boosting) on <span class="math inline">\(\mathbf{z}\)</span>.</li>
<li><strong>Fine-tuning</strong>: Initialize from <span class="math inline">\(\boldsymbol{\theta}\)</span> and train all parameters on the financial task with a small learning rate to avoid catastrophic forgetting.</li>
</ol>
<div id="feature-extractor" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_feature_extractor(model_name<span class="op">=</span><span class="st">"resnet50"</span>, device<span class="op">=</span><span class="st">"cpu"</span>):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Build a pre-trained CNN feature extractor.</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">        One of 'resnet50', 'efficientnet_b0', 'vit_b_16'.</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">    device : str</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co">        'cpu' or 'cuda'.</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co">    model : nn.Module</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Feature extraction model.</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">    transform : transforms.Compose</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">        Image preprocessing pipeline.</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">"resnet50"</span>:</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.ResNet50_Weights.IMAGENET1K_V2</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.resnet50(weights<span class="op">=</span>weights)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        model.fc <span class="op">=</span> nn.Identity()  <span class="co"># Remove classification head</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"efficientnet_b0"</span>:</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.EfficientNet_B0_Weights.IMAGENET1K_V1</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.efficientnet_b0(weights<span class="op">=</span>weights)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        model.classifier <span class="op">=</span> nn.Identity()</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">1280</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"vit_b_16"</span>:</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.ViT_B_16_Weights.IMAGENET1K_V1</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.vit_b_16(weights<span class="op">=</span>weights)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        model.heads <span class="op">=</span> nn.Identity()</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">768</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model.to(device).<span class="bu">eval</span>()</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        transforms.Resize(<span class="dv">256</span>),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        transforms.CenterCrop(<span class="dv">224</span>),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize(</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>            mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, transform, dim</span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_features(image_paths, model, transform, device<span class="op">=</span><span class="st">"cpu"</span>,</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>                     batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract deep features from a list of images.</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="co">    image_paths : list</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="co">        Paths to image files.</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="co">    model : nn.Module</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="co">        Feature extraction model.</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="co">    transform : transforms.Compose</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="co">        Preprocessing pipeline.</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="co">    np.ndarray : Feature matrix (n_images x feature_dim).</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> []</span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(image_paths), batch_size):</span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>        batch_paths <span class="op">=</span> image_paths[i:i <span class="op">+</span> batch_size]</span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>        batch_tensors <span class="op">=</span> []</span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> batch_paths:</span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> Image.<span class="bu">open</span>(path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a>                tensor <span class="op">=</span> transform(img)</span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a>                batch_tensors.append(tensor)</span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a>                batch_tensors.append(torch.zeros(<span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> torch.stack(batch_tensors).to(device)</span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a>            batch_features <span class="op">=</span> model(batch).cpu().numpy()</span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-91"><a href="#cb2-91" aria-hidden="true" tabindex="-1"></a>        features.append(batch_features)</span>
<span id="cb2-92"><a href="#cb2-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-93"><a href="#cb2-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.vstack(features)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="satellite-and-geospatial-imagery" class="level2" data-number="45.2">
<h2 data-number="45.2" class="anchored" data-anchor-id="satellite-and-geospatial-imagery"><span class="header-section-number">45.2</span> Satellite and Geospatial Imagery</h2>
<section id="economic-activity-from-space" class="level3" data-number="45.2.1">
<h3 data-number="45.2.1" class="anchored" data-anchor-id="economic-activity-from-space"><span class="header-section-number">45.2.1</span> Economic Activity from Space</h3>
<p>Satellite imagery provides high-frequency, spatially granular measurements of economic activity that are independent of and often lead official statistics. The foundational work of <span class="citation" data-cites="henderson2012measuring">Henderson, Storeygard, and Weil (<a href="references.html#ref-henderson2012measuring" role="doc-biblioref">2012</a>)</span> demonstrated that nighttime luminosity, measured by the Defense Meteorological Satellite Program (DMSP), is a reliable proxy for GDP, particularly in countries where official statistics are noisy or delayed. <span class="citation" data-cites="donaldson2018railroads">Donaldson (<a href="references.html#ref-donaldson2018railroads" role="doc-biblioref">2018</a>)</span> use satellite-derived agricultural output measures to study the welfare gains from railroads in colonial India. <span class="citation" data-cites="jean2016combining">Jean et al. (<a href="references.html#ref-jean2016combining" role="doc-biblioref">2016</a>)</span> combine daytime satellite imagery with CNNs to predict poverty from space with <span class="math inline">\(r^2 &gt; 0.7\)</span>.</p>
<p>For financial applications, the key insight is that satellite data arrives faster than corporate earnings or government statistics. A retailer’s quarterly revenue is reported 4-8 weeks after the quarter ends; satellite imagery of its parking lots is available within days. This temporal advantage creates a natural use case for nowcasting (i.e., estimating current economic conditions before official data arrives) and for constructing trading signals based on information that is public but costly to process.</p>
</section>
<section id="application-1-nighttime-luminosity-and-provincial-gdp" class="level3" data-number="45.2.2">
<h3 data-number="45.2.2" class="anchored" data-anchor-id="application-1-nighttime-luminosity-and-provincial-gdp"><span class="header-section-number">45.2.2</span> Application 1: Nighttime Luminosity and Provincial GDP</h3>
<p>Vietnam’s General Statistics Office (GSO) publishes provincial GDP with a lag of several months. Nighttime luminosity from the VIIRS (Visible Infrared Imaging Radiometer Suite) sensor provides a near-real-time alternative. We construct a firm-level exposure measure by linking each listed firm’s registered location to the luminosity of its province.</p>
<div id="nightlight-data" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load nighttime luminosity data (VIIRS monthly composites)</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: Earth Observation Group (EOG) / NOAA</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>nightlights <span class="op">=</span> dc.get_nightlight_data(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    resolution<span class="op">=</span><span class="st">"province"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm location data</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>firm_locations <span class="op">=</span> dc.get_firm_locations()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Provincial GDP from GSO</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>provincial_gdp <span class="op">=</span> dc.get_provincial_gdp(</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Nightlight observations: </span><span class="sc">{</span><span class="bu">len</span>(nightlights)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Provinces covered: </span><span class="sc">{</span>nightlights[<span class="st">'province'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms with location: </span><span class="sc">{</span>firm_locations[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="nightlight-gdp-validation" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate: does nightlight predict provincial GDP?</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>nl_gdp <span class="op">=</span> nightlights.merge(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    provincial_gdp,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>],</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-log specification (standard in the literature)</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>nl_gdp[<span class="st">"ln_luminosity"</span>] <span class="op">=</span> np.log(nl_gdp[<span class="st">"mean_radiance"</span>].clip(lower<span class="op">=</span><span class="fl">0.01</span>))</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>nl_gdp[<span class="st">"ln_gdp"</span>] <span class="op">=</span> np.log(nl_gdp[<span class="st">"provincial_gdp"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression by year</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>validation_results <span class="op">=</span> []</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> nl_gdp[<span class="st">"year"</span>].unique():</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> nl_gdp[nl_gdp[<span class="st">"year"</span>] <span class="op">==</span> year]</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> <span class="dv">20</span>:</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        subset[<span class="st">"ln_gdp"</span>],</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(subset[<span class="st">"ln_luminosity"</span>])</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    ).fit()</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    validation_results.append({</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>: year,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: model.params.iloc[<span class="dv">1</span>],</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_provinces"</span>: <span class="bu">int</span>(model.nobs)</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>validation_df <span class="op">=</span> pd.DataFrame(validation_results)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Avg R² (ln GDP ~ ln Luminosity): </span><span class="sc">{</span>validation_df[<span class="st">'r_squared'</span>]<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-nightlight-gdp" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nightlight-gdp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(nl_gdp[nl_gdp[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2023</span>],</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>              p9.aes(x<span class="op">=</span><span class="st">"ln_luminosity"</span>, y<span class="op">=</span><span class="st">"ln_gdp"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, size<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lm"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, se<span class="op">=</span><span class="va">True</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"ln(Mean Nighttime Radiance)"</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"ln(Provincial GDP)"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Nighttime Luminosity vs. Provincial GDP (2023)"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-nightlight-gdp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;45.1
</figcaption>
</figure>
</div>
<div id="nightlight-firm-signal" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct firm-level nightlight signal</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Logic: firms in provinces with accelerating luminosity</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># are experiencing positive local economic conditions</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>nl_growth <span class="op">=</span> nightlights.copy().sort_values([<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Year-over-year luminosity growth by province</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"ln_radiance"</span>] <span class="op">=</span> np.log(nl_growth[<span class="st">"mean_radiance"</span>].clip(lower<span class="op">=</span><span class="fl">0.01</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"ln_radiance_lag4"</span>] <span class="op">=</span> nl_growth.groupby(</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"province"</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"ln_radiance"</span>].shift(<span class="dv">4</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"nl_growth"</span>] <span class="op">=</span> nl_growth[<span class="st">"ln_radiance"</span>] <span class="op">-</span> nl_growth[<span class="st">"ln_radiance_lag4"</span>]</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with firms via province</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>firm_nl <span class="op">=</span> firm_locations[[<span class="st">"ticker"</span>, <span class="st">"province"</span>]].merge(</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    nl_growth[[<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>, <span class="st">"nl_growth"</span>]],</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"province"</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with stock returns</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> dc.get_monthly_returns(</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>monthly_returns[<span class="st">"year"</span>] <span class="op">=</span> monthly_returns[<span class="st">"date"</span>].dt.year</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>monthly_returns[<span class="st">"quarter"</span>] <span class="op">=</span> monthly_returns[<span class="st">"date"</span>].dt.quarter</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>returns_with_nl <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    firm_nl,</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>],</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="nightlight-portfolio" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolio sort: quintiles on provincial nightlight growth</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>returns_with_nl[<span class="st">"nl_quintile"</span>] <span class="op">=</span> returns_with_nl.groupby(<span class="st">"date"</span>)[</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nl_growth"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>nl_port_returns <span class="op">=</span> (</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    returns_with_nl.groupby([<span class="st">"date"</span>, <span class="st">"nl_quintile"</span>])</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    .agg(port_ret<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>nl_wide <span class="op">=</span> nl_port_returns.pivot(</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"nl_quintile"</span>, values<span class="op">=</span><span class="st">"port_ret"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>nl_wide[<span class="st">"L-S"</span>] <span class="op">=</span> nl_wide[<span class="dv">5</span>] <span class="op">-</span> nl_wide[<span class="dv">1</span>]  <span class="co"># High NL growth - Low</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-nightlight-portfolios" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="8">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-nightlight-portfolios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.1: Nighttime Luminosity Growth Quintile Portfolio Returns
</figcaption>
<div aria-describedby="tbl-nightlight-portfolios-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nl_summary <span class="op">=</span> nl_wide.describe().T[[<span class="st">"mean"</span>, <span class="st">"std"</span>]].copy()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>nl_summary[<span class="st">"mean_ann"</span>] <span class="op">=</span> nl_summary[<span class="st">"mean"</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>nl_summary[<span class="st">"sharpe"</span>] <span class="op">=</span> (</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    nl_summary[<span class="st">"mean_ann"</span>] <span class="op">/</span> (nl_summary[<span class="st">"std"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> nl_wide.columns:</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> nl_wide[col].mean() <span class="op">/</span> (</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        nl_wide[col].std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(nl_wide.dropna()))</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    nl_summary.loc[col, <span class="st">"t_stat"</span>] <span class="op">=</span> t_stat</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>nl_summary <span class="op">=</span> nl_summary[[<span class="st">"mean_ann"</span>, <span class="st">"sharpe"</span>, <span class="st">"t_stat"</span>]].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>nl_summary.columns <span class="op">=</span> [<span class="st">"Ann. Return"</span>, <span class="st">"Sharpe"</span>, <span class="st">"t-stat"</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>nl_summary</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
<section id="application-2-satellite-imagery-for-sector-nowcasting" class="level3" data-number="45.2.3">
<h3 data-number="45.2.3" class="anchored" data-anchor-id="application-2-satellite-imagery-for-sector-nowcasting"><span class="header-section-number">45.2.3</span> Application 2: Satellite Imagery for Sector Nowcasting</h3>
<p>Beyond luminosity, daytime satellite imagery provides sector-specific signals. We implement three channels relevant to the Vietnamese economy.</p>
<p><strong>Port activity.</strong> Vietnam is a major export-oriented economy. Satellite imagery of container ports (Cát Lái, Hải Phòng) captures trade throughput before customs statistics are released. Ship detection algorithms applied to synthetic aperture radar (SAR) imagery count vessels and estimate cargo volumes.</p>
<p><strong>Construction progress.</strong> Real estate and construction constitute a significant fraction of Vietnamese GDP and market capitalization. Change detection algorithms applied to high-resolution optical imagery identify construction starts, completion rates, and land-use conversion.</p>
<p><strong>Agricultural monitoring.</strong> Vietnam is a leading exporter of rice, coffee, rubber, and seafood. The Normalized Difference Vegetation Index (NDVI), computed from multispectral satellite data, provides crop health assessments:</p>
<p><span id="eq-ndvi"><span class="math display">\[
\text{NDVI} = \frac{\rho_{\text{NIR}} - \rho_{\text{Red}}}{\rho_{\text{NIR}} + \rho_{\text{Red}}}
\tag{45.2}\]</span></span></p>
<p>where <span class="math inline">\(\rho_{\text{NIR}}\)</span> and <span class="math inline">\(\rho_{\text{Red}}\)</span> are reflectance in the near-infrared and red bands. NDVI ranges from <span class="math inline">\(-1\)</span> to <span class="math inline">\(+1\)</span>, with values above 0.3 indicating healthy vegetation. Deviations from seasonal norms proxy for crop yield surprises.</p>
<div id="ndvi-agriculture" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load NDVI data for Vietnamese agricultural regions</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: MODIS/Terra (MOD13Q1, 250m resolution, 16-day composites)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>ndvi_data <span class="op">=</span> dc.get_ndvi_data(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    regions<span class="op">=</span>[<span class="st">"mekong_delta"</span>, <span class="st">"central_highlands"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>             <span class="st">"red_river_delta"</span>, <span class="st">"southeast"</span>]</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute NDVI anomaly: deviation from 5-year seasonal average</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ndvi_data[<span class="st">"month"</span>] <span class="op">=</span> ndvi_data[<span class="st">"date"</span>].dt.month</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>seasonal_mean <span class="op">=</span> (</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    ndvi_data.groupby([<span class="st">"region"</span>, <span class="st">"month"</span>])</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"mean_ndvi"</span>].transform(</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.rolling(<span class="dv">5</span> <span class="op">*</span> <span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span>).mean()</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>ndvi_data[<span class="st">"ndvi_anomaly"</span>] <span class="op">=</span> ndvi_data[<span class="st">"mean_ndvi"</span>] <span class="op">-</span> seasonal_mean</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Agricultural sector firms</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>agri_firms <span class="op">=</span> dc.get_firms_by_sector(sector<span class="op">=</span><span class="st">"agriculture"</span>)</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Link NDVI anomaly to agricultural firm returns</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>agri_returns <span class="op">=</span> monthly_returns[</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    monthly_returns[<span class="st">"ticker"</span>].isin(agri_firms[<span class="st">"ticker"</span>])</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>agri_returns[<span class="st">"month"</span>] <span class="op">=</span> agri_returns[<span class="st">"date"</span>].dt.month</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>agri_returns[<span class="st">"year"</span>] <span class="op">=</span> agri_returns[<span class="st">"date"</span>].dt.year</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Regional NDVI aggregation (Mekong Delta for rice firms, etc.)</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>mekong_ndvi <span class="op">=</span> ndvi_data[ndvi_data[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"mekong_delta"</span>].copy()</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>mekong_ndvi[<span class="st">"year"</span>] <span class="op">=</span> mekong_ndvi[<span class="st">"date"</span>].dt.year</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>mekong_ndvi[<span class="st">"month"</span>] <span class="op">=</span> mekong_ndvi[<span class="st">"date"</span>].dt.month</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>mekong_monthly <span class="op">=</span> (</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    mekong_ndvi.groupby([<span class="st">"year"</span>, <span class="st">"month"</span>])</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    .agg(ndvi_anomaly<span class="op">=</span>(<span class="st">"ndvi_anomaly"</span>, <span class="st">"mean"</span>))</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-ndvi-timeseries" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="10">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ndvi-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>ndvi_plot <span class="op">=</span> ndvi_data[ndvi_data[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"mekong_delta"</span>].copy()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(ndvi_plot, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"ndvi_anomaly"</span>))</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#27AE60"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"NDVI Anomaly"</span>,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Mekong Delta Vegetation Health: Deviation from Seasonal Norm"</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-ndvi-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;45.2
</figcaption>
</figure>
</div>
<div id="ndvi-return-prediction" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel regression: agricultural firm returns on NDVI anomaly</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>agri_panel <span class="op">=</span> agri_returns.merge(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    mekong_monthly,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"year"</span>, <span class="st">"month"</span>],</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Lagged NDVI anomaly (one month)</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>agri_panel <span class="op">=</span> agri_panel.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>agri_panel[<span class="st">"ndvi_lag1"</span>] <span class="op">=</span> agri_panel.groupby(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticker"</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"ndvi_anomaly"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>agri_clean <span class="op">=</span> agri_panel.dropna(</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"ndvi_lag1"</span>]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>).set_index([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>model_ndvi <span class="op">=</span> PanelOLS(</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    agri_clean[<span class="st">"ret"</span>],</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    agri_clean[[<span class="st">"ndvi_lag1"</span>]],</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    entity_effects<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    time_effects<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    check_rank<span class="op">=</span><span class="va">False</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"clustered"</span>, cluster_entity<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>agri_clean <span class="op">=</span> agri_clean.reset_index()</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"NDVI → Agricultural Returns:"</span>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  β(NDVI_lag): </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>params[<span class="st">'ndvi_lag1'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  t-stat: </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>tstats[<span class="st">'ndvi_lag1'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  R² (within): </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>rsquared_within<span class="sc">:.4f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="satellite-feature-extraction-with-cnns" class="level3" data-number="45.2.4">
<h3 data-number="45.2.4" class="anchored" data-anchor-id="satellite-feature-extraction-with-cnns"><span class="header-section-number">45.2.4</span> Satellite Feature Extraction with CNNs</h3>
<p>For raw satellite imagery (rather than pre-computed indices like NDVI), we use transfer learning from CNNs to extract spatial features. The approach follows <span class="citation" data-cites="jean2016combining">Jean et al. (<a href="references.html#ref-jean2016combining" role="doc-biblioref">2016</a>)</span>: use a CNN pre-trained on ImageNet to extract feature vectors from satellite tiles, then regress economic outcomes on these features.</p>
<div id="satellite-cnn-pipeline" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> satellite_feature_pipeline(image_dir, model_name<span class="op">=</span><span class="st">"resnet50"</span>):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract CNN features from satellite image tiles.</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">    image_dir : str or Path</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Directory containing satellite tiles (PNG/TIFF).</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Pre-trained model to use.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : image_id, feature vector columns.</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    image_dir <span class="op">=</span> Path(image_dir)</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    image_paths <span class="op">=</span> <span class="bu">sorted</span>(image_dir.glob(<span class="st">"*.png"</span>)) <span class="op">+</span> <span class="bu">sorted</span>(</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        image_dir.glob(<span class="st">"*.tif"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> image_paths:</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No images found."</span>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    model, transform, dim <span class="op">=</span> build_feature_extractor(model_name, device)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_features(image_paths, model, transform, device)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [<span class="ss">f"feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(dim)]</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(features, columns<span class="op">=</span>feature_cols)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"image_id"</span>] <span class="op">=</span> [p.stem <span class="cf">for</span> p <span class="kw">in</span> image_paths]</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_economic_activity(features_df, labels_df, label_col,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>                              n_components<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Predict economic activity from satellite image features.</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses PCA for dimensionality reduction, then ridge regression.</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="co">    features_df : DataFrame</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="co">        CNN features with image_id.</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="co">    labels_df : DataFrame</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="co">        Economic outcomes with image_id.</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a><span class="co">    label_col : str</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="co">        Target variable column name.</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="co">        PCA components to retain.</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : R², coefficients, cross-validated performance.</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.linear_model <span class="im">import</span> RidgeCV</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> features_df.merge(labels_df, on<span class="op">=</span><span class="st">"image_id"</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> features_df.columns <span class="cf">if</span> c.startswith(<span class="st">"feat_"</span>)]</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> merged[feature_cols].values</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> merged[label_col].values</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PCA</span></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    pca <span class="op">=</span> PCA(n_components<span class="op">=</span>n_components)</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    X_pca <span class="op">=</span> pca.fit_transform(X)</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    var_explained <span class="op">=</span> pca.explained_variance_ratio_.<span class="bu">sum</span>()</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression with cross-validation</span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    ridge <span class="op">=</span> RidgeCV(alphas<span class="op">=</span>np.logspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">20</span>), cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(ridge, X_pca, y, cv<span class="op">=</span><span class="dv">5</span>, scoring<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    ridge.fit(X_pca, y)</span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_cv_mean"</span>: cv_scores.mean(),</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_cv_std"</span>: cv_scores.std(),</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_train"</span>: ridge.score(X_pca, y),</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pca_var_explained"</span>: var_explained,</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">"optimal_alpha"</span>: ridge.alpha_,</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_images"</span>: <span class="bu">len</span>(merged)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="document-image-analysis" class="level2" data-number="45.3">
<h2 data-number="45.3" class="anchored" data-anchor-id="document-image-analysis"><span class="header-section-number">45.3</span> Document Image Analysis</h2>
<section id="the-vietnamese-filing-problem" class="level3" data-number="45.3.1">
<h3 data-number="45.3.1" class="anchored" data-anchor-id="the-vietnamese-filing-problem"><span class="header-section-number">45.3.1</span> The Vietnamese Filing Problem</h3>
<p>A substantial fraction of Vietnamese corporate disclosures (e.g., annual reports, financial statements, board resolutions, shareholder meeting minutes) are distributed as scanned PDF images rather than machine-readable text. This creates a data extraction bottleneck: the information exists but is trapped in pixel format. Unlike filings in more developed markets (where XBRL mandates ensure machine readability), Vietnamese filings require Optical Character Recognition (OCR) and layout analysis before any quantitative analysis can begin.</p>
<p>The document AI pipeline for Vietnamese financial filings involves four stages:</p>
<ol type="1">
<li><strong>Page classification</strong>: Identify which pages contain financial statements, management discussion, audit opinions, etc.</li>
<li><strong>Layout analysis</strong>: Detect the spatial structure such as headers, paragraphs, tables, figures, captions.</li>
<li><strong>OCR</strong>: Convert image regions to text, using Vietnamese-optimized models.</li>
<li><strong>Structured extraction</strong>: Parse the recognized text into structured data (e.g., revenue figures, balance sheet items).</li>
</ol>
</section>
<section id="ocr-for-vietnamese-financial-documents" class="level3" data-number="45.3.2">
<h3 data-number="45.3.2" class="anchored" data-anchor-id="ocr-for-vietnamese-financial-documents"><span class="header-section-number">45.3.2</span> OCR for Vietnamese Financial Documents</h3>
<p>Standard OCR engines (Tesseract, Google Cloud Vision) struggle with Vietnamese financial documents due to the combination of Vietnamese diacritics (ă, ơ, ư, ê, etc.), mixed Vietnamese-English content, and complex table layouts. We implement a pipeline using PaddleOCR (which has strong CJK and Southeast Asian language support) and VietOCR (a Vietnamese-specific model based on the transformer architecture of <span class="citation" data-cites="baek2019wrong">Baek et al. (<a href="references.html#ref-baek2019wrong" role="doc-biblioref">2019</a>)</span>).</p>
<div id="ocr-pipeline" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ocr_financial_document(pdf_path, language<span class="op">=</span><span class="st">"vi"</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                           engine<span class="op">=</span><span class="st">"paddleocr"</span>):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    OCR a Vietnamese financial document (scanned PDF).</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    pdf_path : str</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to PDF file.</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    language : str</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Language code.</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">    engine : str</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">        'paddleocr' or 'vietocr'.</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">    list[dict] : Per-page OCR results with bounding boxes.</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> pdf2image <span class="im">import</span> convert_from_path</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert PDF pages to images</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    pages <span class="op">=</span> convert_from_path(pdf_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> engine <span class="op">==</span> <span class="st">"paddleocr"</span>:</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> paddleocr <span class="im">import</span> PaddleOCR</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>        ocr <span class="op">=</span> PaddleOCR(use_angle_cls<span class="op">=</span><span class="va">True</span>, lang<span class="op">=</span><span class="st">"vi"</span>, use_gpu<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> page_num, page_img <span class="kw">in</span> <span class="bu">enumerate</span>(pages):</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert PIL to numpy</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>            img_array <span class="op">=</span> np.array(page_img)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>            ocr_result <span class="op">=</span> ocr.ocr(img_array, cls<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>            page_texts <span class="op">=</span> []</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> ocr_result[<span class="dv">0</span>]:</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>                bbox, (text, confidence) <span class="op">=</span> line</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>                page_texts.append({</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text"</span>: text,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"confidence"</span>: confidence,</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"bbox"</span>: bbox,</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"page"</span>: page_num <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>            results.extend(page_texts)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_page_type(ocr_results, page_num):</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">    Classify a document page by content type using keyword matching.</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns one of: 'balance_sheet', 'income_statement',</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co">    'cash_flow', 'notes', 'audit', 'management', 'other'.</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    page_text <span class="op">=</span> <span class="st">" "</span>.join(</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>        [r[<span class="st">"text"</span>] <span class="cf">for</span> r <span class="kw">in</span> ocr_results <span class="cf">if</span> r[<span class="st">"page"</span>] <span class="op">==</span> page_num]</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    ).lower()</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vietnamese financial statement keywords</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    keyword_map <span class="op">=</span> {</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">"balance_sheet"</span>: [</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bảng cân đối kế toán"</span>, <span class="st">"tài sản"</span>, <span class="st">"nguồn vốn"</span>,</span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nợ phải trả"</span>, <span class="st">"vốn chủ sở hữu"</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"income_statement"</span>: [</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kết quả hoạt động kinh doanh"</span>, <span class="st">"doanh thu"</span>,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lợi nhuận"</span>, <span class="st">"chi phí"</span>, <span class="st">"thu nhập"</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cash_flow"</span>: [</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lưu chuyển tiền tệ"</span>, <span class="st">"dòng tiền"</span>,</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hoạt động kinh doanh"</span>, <span class="st">"hoạt động đầu tư"</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"audit"</span>: [</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>            <span class="st">"báo cáo kiểm toán"</span>, <span class="st">"kiểm toán viên"</span>,</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ý kiến kiểm toán"</span>, <span class="st">"trung thực và hợp lý"</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">"management"</span>: [</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ban giám đốc"</span>, <span class="st">"hội đồng quản trị"</span>,</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>            <span class="st">"báo cáo thường niên"</span>, <span class="st">"tình hình hoạt động"</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> {}</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> page_type, keywords <span class="kw">in</span> keyword_map.items():</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>        scores[page_type] <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="cf">for</span> kw <span class="kw">in</span> keywords <span class="cf">if</span> kw <span class="kw">in</span> page_text</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">max</span>(scores.values()) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"other"</span></span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">max</span>(scores, key<span class="op">=</span>scores.get)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="table-extraction-from-financial-statements" class="level3" data-number="45.3.3">
<h3 data-number="45.3.3" class="anchored" data-anchor-id="table-extraction-from-financial-statements"><span class="header-section-number">45.3.3</span> Table Extraction from Financial Statements</h3>
<p>The highest-value extraction task is recovering structured tables from financial statements. We implement a two-stage approach: first detect table regions using a layout analysis model, then parse the detected regions into row-column structure.</p>
<div id="table-extraction" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_tables_from_page(page_image, ocr_results, page_num):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract structured tables from a document page.</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses spatial clustering of OCR bounding boxes to identify</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    table regions, then aligns text into rows and columns.</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">    page_image : PIL.Image</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">        Page image.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">    ocr_results : list[dict]</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">        OCR results for this page.</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">    page_num : int</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">        Page number.</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">    list[pd.DataFrame] : Extracted tables as DataFrames.</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    page_texts <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> ocr_results <span class="cf">if</span> r[<span class="st">"page"</span>] <span class="op">==</span> page_num]</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> page_texts:</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract bounding box centers</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>    centers <span class="op">=</span> []</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> page_texts:</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> item[<span class="st">"bbox"</span>]</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bbox is [[x1,y1],[x2,y2],[x3,y3],[x4,y4]]</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>        cx <span class="op">=</span> np.mean([p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox])</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>        cy <span class="op">=</span> np.mean([p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox])</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>        centers.append((cx, cy, item[<span class="st">"text"</span>]))</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> centers:</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>    centers_df <span class="op">=</span> pd.DataFrame(centers, columns<span class="op">=</span>[<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"text"</span>])</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cluster into rows by y-coordinate proximity</span></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    centers_df <span class="op">=</span> centers_df.sort_values(<span class="st">"y"</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>    row_threshold <span class="op">=</span> <span class="dv">15</span>  <span class="co"># pixels</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>    centers_df[<span class="st">"row_id"</span>] <span class="op">=</span> (</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>        centers_df[<span class="st">"y"</span>].diff().<span class="bu">abs</span>() <span class="op">&gt;</span> row_threshold</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    ).cumsum()</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Within each row, sort by x-coordinate</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    tables <span class="op">=</span> []</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> []</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row_id, row_group <span class="kw">in</span> centers_df.groupby(<span class="st">"row_id"</span>):</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>        row_sorted <span class="op">=</span> row_group.sort_values(<span class="st">"x"</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>        rows.append(row_sorted[<span class="st">"text"</span>].tolist())</span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(rows) <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attempt to construct DataFrame</span></span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>        max_cols <span class="op">=</span> <span class="bu">max</span>(<span class="bu">len</span>(r) <span class="cf">for</span> r <span class="kw">in</span> rows)</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pad shorter rows</span></span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>        padded <span class="op">=</span> [r <span class="op">+</span> [<span class="st">""</span>] <span class="op">*</span> (max_cols <span class="op">-</span> <span class="bu">len</span>(r)) <span class="cf">for</span> r <span class="kw">in</span> rows]</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame(padded[<span class="dv">1</span>:], columns<span class="op">=</span>padded[<span class="dv">0</span>])</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>            tables.append(df)</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>            tables.append(pd.DataFrame(padded))</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tables</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_financial_numbers(text):</span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse Vietnamese financial number formats.</span></span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese uses dots as thousands separators and commas as decimals.</span></span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a><span class="co">    E.g., '1.234.567' = 1234567, '1.234,56' = 1234.56</span></span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> re</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip().replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove parentheses (negative indicator)</span></span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>    negative <span class="op">=</span> text.startswith(<span class="st">"("</span>) <span class="kw">and</span> text.endswith(<span class="st">")"</span>)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip(<span class="st">"()"</span>)</span>
<span id="cb14-81"><a href="#cb14-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-82"><a href="#cb14-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle Vietnamese number format</span></span>
<span id="cb14-83"><a href="#cb14-83" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If comma is present, it's a decimal separator</span></span>
<span id="cb14-84"><a href="#cb14-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">","</span> <span class="kw">in</span> text:</span>
<span id="cb14-85"><a href="#cb14-85" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.replace(<span class="st">"."</span>, <span class="st">""</span>).replace(<span class="st">","</span>, <span class="st">"."</span>)</span>
<span id="cb14-86"><a href="#cb14-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb14-87"><a href="#cb14-87" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.replace(<span class="st">"."</span>, <span class="st">""</span>)</span>
<span id="cb14-88"><a href="#cb14-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-89"><a href="#cb14-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb14-90"><a href="#cb14-90" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> <span class="bu">float</span>(text)</span>
<span id="cb14-91"><a href="#cb14-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>value <span class="cf">if</span> negative <span class="cf">else</span> value</span>
<span id="cb14-92"><a href="#cb14-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb14-93"><a href="#cb14-93" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="layout-aware-document-understanding" class="level3" data-number="45.3.4">
<h3 data-number="45.3.4" class="anchored" data-anchor-id="layout-aware-document-understanding"><span class="header-section-number">45.3.4</span> Layout-Aware Document Understanding</h3>
<p>Modern document AI goes beyond OCR by jointly modeling text content and spatial layout. LayoutLM <span class="citation" data-cites="huang2022layoutlmv3">(<a href="references.html#ref-huang2022layoutlmv3" role="doc-biblioref">Huang et al. 2022</a>)</span> and its successors treat each token as having both a text embedding and a positional embedding derived from its bounding box coordinates. This allows the model to understand that a number positioned below a “Revenue” header and to the right of “2023” is the 2023 revenue figure, even without explicit table detection.</p>
<div id="layoutlm-extraction" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> layoutlm_extract(document_pages, model_name<span class="op">=</span><span class="st">"layoutlmv3"</span>):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract structured financial data using LayoutLM.</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">    This function uses the pre-trained LayoutLMv3 model for</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    document understanding with Vietnamese financial statements.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">    document_pages : list</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">        List of (page_image, ocr_results) tuples.</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">        Model variant.</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Extracted financial fields.</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> transformers <span class="im">import</span> (</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        LayoutLMv3ForTokenClassification,</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        LayoutLMv3Processor</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>    processor <span class="op">=</span> LayoutLMv3Processor.from_pretrained(</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"microsoft/layoutlmv3-base"</span>,</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>        apply_ocr<span class="op">=</span><span class="va">False</span>  <span class="co"># We provide our own OCR</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LayoutLMv3ForTokenClassification.from_pretrained(</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">"microsoft/layoutlmv3-base"</span>,</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        num_labels<span class="op">=</span><span class="dv">13</span>  <span class="co"># Financial statement field types</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define target fields for extraction</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>    field_labels <span class="op">=</span> [</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"O"</span>,  <span class="co"># Other</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-REVENUE"</span>, <span class="st">"I-REVENUE"</span>,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-COGS"</span>, <span class="st">"I-COGS"</span>,</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-NET_INCOME"</span>, <span class="st">"I-NET_INCOME"</span>,</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_ASSETS"</span>, <span class="st">"I-TOTAL_ASSETS"</span>,</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_EQUITY"</span>, <span class="st">"I-TOTAL_EQUITY"</span>,</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_DEBT"</span>, <span class="st">"I-TOTAL_DEBT"</span></span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>    extracted <span class="op">=</span> {}</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> page_img, ocr_results <span class="kw">in</span> document_pages:</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>        words <span class="op">=</span> [r[<span class="st">"text"</span>] <span class="cf">for</span> r <span class="kw">in</span> ocr_results]</span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> []</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> ocr_results:</span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            bbox <span class="op">=</span> r[<span class="st">"bbox"</span>]</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Normalize to 0-1000 range</span></span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> <span class="bu">min</span>(p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>            y0 <span class="op">=</span> <span class="bu">min</span>(p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>            x1 <span class="op">=</span> <span class="bu">max</span>(p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>            y1 <span class="op">=</span> <span class="bu">max</span>(p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb15-57"><a href="#cb15-57" aria-hidden="true" tabindex="-1"></a>            boxes.append([<span class="bu">int</span>(x0), <span class="bu">int</span>(y0), <span class="bu">int</span>(x1), <span class="bu">int</span>(y1)])</span>
<span id="cb15-58"><a href="#cb15-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-59"><a href="#cb15-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> words:</span>
<span id="cb15-60"><a href="#cb15-60" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb15-61"><a href="#cb15-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-62"><a href="#cb15-62" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process through LayoutLM</span></span>
<span id="cb15-63"><a href="#cb15-63" aria-hidden="true" tabindex="-1"></a>        encoding <span class="op">=</span> processor(</span>
<span id="cb15-64"><a href="#cb15-64" aria-hidden="true" tabindex="-1"></a>            page_img,</span>
<span id="cb15-65"><a href="#cb15-65" aria-hidden="true" tabindex="-1"></a>            words,</span>
<span id="cb15-66"><a href="#cb15-66" aria-hidden="true" tabindex="-1"></a>            boxes<span class="op">=</span>boxes,</span>
<span id="cb15-67"><a href="#cb15-67" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb15-68"><a href="#cb15-68" aria-hidden="true" tabindex="-1"></a>            truncation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb15-69"><a href="#cb15-69" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span><span class="dv">512</span></span>
<span id="cb15-70"><a href="#cb15-70" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-71"><a href="#cb15-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-72"><a href="#cb15-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb15-73"><a href="#cb15-73" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(<span class="op">**</span>encoding)</span>
<span id="cb15-74"><a href="#cb15-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-75"><a href="#cb15-75" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> outputs.logits.argmax(<span class="op">-</span><span class="dv">1</span>).squeeze().tolist()</span>
<span id="cb15-76"><a href="#cb15-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-77"><a href="#cb15-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract labeled entities</span></span>
<span id="cb15-78"><a href="#cb15-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, pred <span class="kw">in</span> <span class="bu">enumerate</span>(predictions):</span>
<span id="cb15-79"><a href="#cb15-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pred <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> idx <span class="op">&lt;</span> <span class="bu">len</span>(words):</span>
<span id="cb15-80"><a href="#cb15-80" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> field_labels[pred]</span>
<span id="cb15-81"><a href="#cb15-81" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> label.startswith(<span class="st">"B-"</span>):</span>
<span id="cb15-82"><a href="#cb15-82" aria-hidden="true" tabindex="-1"></a>                    field <span class="op">=</span> label[<span class="dv">2</span>:]</span>
<span id="cb15-83"><a href="#cb15-83" aria-hidden="true" tabindex="-1"></a>                    value <span class="op">=</span> parse_financial_numbers(words[idx])</span>
<span id="cb15-84"><a href="#cb15-84" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> np.isnan(value):</span>
<span id="cb15-85"><a href="#cb15-85" aria-hidden="true" tabindex="-1"></a>                        extracted[field] <span class="op">=</span> value</span>
<span id="cb15-86"><a href="#cb15-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-87"><a href="#cb15-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> extracted</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="chart-and-figure-digitization" class="level2" data-number="45.4">
<h2 data-number="45.4" class="anchored" data-anchor-id="chart-and-figure-digitization"><span class="header-section-number">45.4</span> Chart and Figure Digitization</h2>
<section id="motivation-unlocking-visual-financial-data" class="level3" data-number="45.4.1">
<h3 data-number="45.4.1" class="anchored" data-anchor-id="motivation-unlocking-visual-financial-data"><span class="header-section-number">45.4.1</span> Motivation: Unlocking Visual Financial Data</h3>
<p>Financial charts (e.g., price time series, bar charts of earnings, scatter plots of risk-return tradeoffs) embed information that analysts process visually. For systematic strategies, this information must be converted to numerical form. Three use cases motivate chart digitization:</p>
<ol type="1">
<li><strong>Historical data recovery.</strong> Pre-digital financial data often exists only in printed charts. Digitizing these charts extends historical time series beyond the electronic era.</li>
<li><strong>Broker report extraction.</strong> Sell-side research reports contain charts with projections and scenario analyses. Extracting these programmatically enables systematic aggregation of analyst views.</li>
<li><strong>Regulatory filings.</strong> Vietnamese regulatory filings sometimes embed data as images (charts, scanned tables) rather than as machine-readable values.</li>
</ol>
</section>
<section id="chart-type-classification" class="level3" data-number="45.4.2">
<h3 data-number="45.4.2" class="anchored" data-anchor-id="chart-type-classification"><span class="header-section-number">45.4.2</span> Chart Type Classification</h3>
<p>The first step is classifying the chart type (line, bar, scatter, pie, candlestick), which determines the appropriate digitization algorithm.</p>
<div id="chart-classification" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_chart_classifier(n_classes<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Build a CNN-based chart type classifier.</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Classes: line_chart, bar_chart, scatter_plot,</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">             candlestick, pie_chart.</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> models.resnet18(weights<span class="op">=</span>models.ResNet18_Weights.IMAGENET1K_V1)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace final layer for chart classification</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    model.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        nn.Linear(<span class="dv">512</span>, n_classes)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_chart(image_path, model, transform):</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Classify a chart image into one of 5 types."""</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">"line_chart"</span>, <span class="st">"bar_chart"</span>, <span class="st">"scatter_plot"</span>,</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"candlestick"</span>, <span class="st">"pie_chart"</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    tensor <span class="op">=</span> transform(img).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> model(tensor)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> torch.softmax(logits, dim<span class="op">=</span><span class="dv">1</span>).squeeze()</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    pred_idx <span class="op">=</span> probs.argmax().item()</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">"predicted_class"</span>: class_names[pred_idx],</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">"confidence"</span>: probs[pred_idx].item(),</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">"all_probs"</span>: {</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>            name: probs[i].item()</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="line-chart-digitization" class="level3" data-number="45.4.3">
<h3 data-number="45.4.3" class="anchored" data-anchor-id="line-chart-digitization"><span class="header-section-number">45.4.3</span> Line Chart Digitization</h3>
<p>For line charts, the digitization task is to recover the <span class="math inline">\((x, y)\)</span> data series from the image. The pipeline involves axis detection, scale calibration, and curve tracing.</p>
<div id="line-chart-digitizer" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> digitize_line_chart(image_path, x_range<span class="op">=</span><span class="va">None</span>, y_range<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Digitize a line chart image to recover the data series.</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">    image_path : str</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to chart image.</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="co">    x_range : tuple, optional</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co">        (x_min, x_max) if known.</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co">    y_range : tuple, optional</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="co">        (y_min, y_max) if known.</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Digitized data points (x, y).</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> cv2</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> cv2.imread(<span class="bu">str</span>(image_path))</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    gray <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    h, w <span class="op">=</span> gray.shape</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Detect plot area (largest rectangular region)</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    edges <span class="op">=</span> cv2.Canny(gray, <span class="dv">50</span>, <span class="dv">150</span>)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    contours, _ <span class="op">=</span> cv2.findContours(</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> contours:</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        largest <span class="op">=</span> <span class="bu">max</span>(contours, key<span class="op">=</span>cv2.contourArea)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        x_start, y_start, plot_w, plot_h <span class="op">=</span> cv2.boundingRect(largest)</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback: assume plot is central 80% of image</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        x_start, y_start <span class="op">=</span> <span class="bu">int</span>(w <span class="op">*</span> <span class="fl">0.1</span>), <span class="bu">int</span>(h <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        plot_w, plot_h <span class="op">=</span> <span class="bu">int</span>(w <span class="op">*</span> <span class="fl">0.8</span>), <span class="bu">int</span>(h <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Extract line pixels within plot area</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to HSV and isolate colored lines</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    hsv <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2HSV)</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>    plot_region <span class="op">=</span> hsv[y_start:y_start <span class="op">+</span> plot_h,</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>                      x_start:x_start <span class="op">+</span> plot_w]</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect non-white, non-gray pixels (likely the line)</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    saturation <span class="op">=</span> plot_region[:, :, <span class="dv">1</span>]</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    line_mask <span class="op">=</span> saturation <span class="op">&gt;</span> <span class="dv">30</span>  <span class="co"># Colored pixels</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Trace the line (column-wise median of colored pixels)</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    data_points <span class="op">=</span> []</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(plot_w):</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        col_pixels <span class="op">=</span> np.where(line_mask[:, col])[<span class="dv">0</span>]</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(col_pixels) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use median y-position</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>            y_pixel <span class="op">=</span> np.median(col_pixels)</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert pixel to data coordinates</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>            x_frac <span class="op">=</span> col <span class="op">/</span> plot_w</span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>            y_frac <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> y_pixel <span class="op">/</span> plot_h  <span class="co"># Invert y-axis</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>            x_val <span class="op">=</span> (x_range[<span class="dv">0</span>] <span class="op">+</span> x_frac <span class="op">*</span> (x_range[<span class="dv">1</span>] <span class="op">-</span> x_range[<span class="dv">0</span>])</span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> x_range <span class="cf">else</span> x_frac)</span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>            y_val <span class="op">=</span> (y_range[<span class="dv">0</span>] <span class="op">+</span> y_frac <span class="op">*</span> (y_range[<span class="dv">1</span>] <span class="op">-</span> y_range[<span class="dv">0</span>])</span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> y_range <span class="cf">else</span> y_frac)</span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>            data_points.append({<span class="st">"x"</span>: x_val, <span class="st">"y"</span>: y_val})</span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(data_points)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="visual-sentiment-analysis" class="level2" data-number="45.5">
<h2 data-number="45.5" class="anchored" data-anchor-id="visual-sentiment-analysis"><span class="header-section-number">45.5</span> Visual Sentiment Analysis</h2>
<section id="image-sentiment-in-financial-news" class="level3" data-number="45.5.1">
<h3 data-number="45.5.1" class="anchored" data-anchor-id="image-sentiment-in-financial-news"><span class="header-section-number">45.5.1</span> Image Sentiment in Financial News</h3>
<p>News articles are accompanied by images that carry sentiment independent of the text. A photograph of a CEO smiling at a press conference conveys different information than the same CEO facing protesters. <span class="citation" data-cites="obaid2022picture">Obaid and Pukthuanthong (<a href="references.html#ref-obaid2022picture" role="doc-biblioref">2022</a>)</span> demonstrate that the visual sentiment of Wall Street Journal photographs predicts market returns: days with more negative imagery precede lower returns.</p>
<p>We implement visual sentiment analysis using two approaches: a pre-trained sentiment classifier and a vision-language model that interprets images in financial context.</p>
</section>
<section id="cnn-based-visual-sentiment" class="level3" data-number="45.5.2">
<h3 data-number="45.5.2" class="anchored" data-anchor-id="cnn-based-visual-sentiment"><span class="header-section-number">45.5.2</span> CNN-Based Visual Sentiment</h3>
<div id="visual-sentiment" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_visual_sentiment(image_paths, model_name<span class="op">=</span><span class="st">"resnet50"</span>):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute visual sentiment scores using a fine-tuned CNN.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses features from a pre-trained CNN followed by a sentiment</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">    classifier trained on the Visual Sentiment Ontology (VSO)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    or similar dataset.</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">    image_paths : list</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Paths to news images.</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : image_path, positive_score, negative_score, sentiment.</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    model, transform, dim <span class="op">=</span> build_feature_extractor(model_name, device)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract features</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_features(image_paths, model, transform, device)</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple sentiment model: use mean activation as proxy</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (In practice, fine-tune on labeled financial images)</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Higher mean activation in certain feature channels</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correlates with positive/negative affect</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Positive channels (empirically determined via validation)</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    pos_channels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, dim <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    neg_channels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(dim <span class="op">//</span> <span class="dv">3</span>, <span class="dv">2</span> <span class="op">*</span> dim <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    pos_scores <span class="op">=</span> features[:, pos_channels].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    neg_scores <span class="op">=</span> features[:, neg_channels].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize to [0, 1]</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    pos_norm <span class="op">=</span> (pos_scores <span class="op">-</span> pos_scores.<span class="bu">min</span>()) <span class="op">/</span> (</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>        pos_scores.<span class="bu">max</span>() <span class="op">-</span> pos_scores.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    neg_norm <span class="op">=</span> (neg_scores <span class="op">-</span> neg_scores.<span class="bu">min</span>()) <span class="op">/</span> (</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        neg_scores.<span class="bu">max</span>() <span class="op">-</span> neg_scores.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    sentiment <span class="op">=</span> pos_norm <span class="op">-</span> neg_norm</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image_path"</span>: image_paths,</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"positive_score"</span>: pos_norm,</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"negative_score"</span>: neg_norm,</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net_sentiment"</span>: sentiment</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    })</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="vision-language-models-for-financial-image-understanding" class="level3" data-number="45.5.3">
<h3 data-number="45.5.3" class="anchored" data-anchor-id="vision-language-models-for-financial-image-understanding"><span class="header-section-number">45.5.3</span> Vision-Language Models for Financial Image Understanding</h3>
<p>The most powerful approach to financial image analysis uses vision-language models (VLMs), which jointly process images and text. Models such as CLIP <span class="citation" data-cites="radford2021learning">(<a href="references.html#ref-radford2021learning" role="doc-biblioref">Radford et al. 2021</a>)</span>, BLIP-2 <span class="citation" data-cites="li2023blip">(<a href="references.html#ref-li2023blip" role="doc-biblioref">Li et al. 2023</a>)</span>, and GPT-4V can be prompted to interpret financial images in context. For instance, given an aerial photograph of a factory, a VLM can answer “Is this factory operating at full capacity?” or “Is there visible construction of additional facilities?”</p>
<div id="vlm-analysis" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vlm_financial_analysis(image_path, prompt, model_name<span class="op">=</span><span class="st">"clip"</span>):</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Use a vision-language model to analyze a financial image.</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">    image_path : str</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to image.</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt : str</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Financial analysis prompt.</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">        'clip' for zero-shot classification,</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">        'blip2' for visual question answering.</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Model output (scores or text).</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">"clip"</span>:</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> transformers <span class="im">import</span> CLIPProcessor, CLIPModel</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        clip_model <span class="op">=</span> CLIPModel.from_pretrained(</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"openai/clip-vit-base-patch32"</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        processor <span class="op">=</span> CLIPProcessor.from_pretrained(</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">"openai/clip-vit-base-patch32"</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Zero-shot classification with financial labels</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>            <span class="st">"busy commercial area with many customers"</span>,</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>            <span class="st">"empty commercial area with few customers"</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>            <span class="st">"active construction site with workers"</span>,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            <span class="st">"idle construction site without activity"</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>            <span class="st">"healthy green crops in agricultural field"</span>,</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"damaged or dry crops in agricultural field"</span>,</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            <span class="st">"busy port with many ships and containers"</span>,</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">"quiet port with few ships"</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> processor(</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>labels,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>            images<span class="op">=</span>img,</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> clip_model(<span class="op">**</span>inputs)</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>            logits <span class="op">=</span> outputs.logits_per_image.squeeze()</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>            probs <span class="op">=</span> torch.softmax(logits, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> {</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>            label: prob.item()</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> label, prob <span class="kw">in</span> <span class="bu">zip</span>(labels, probs)</span>
<span id="cb19-58"><a href="#cb19-58" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb19-59"><a href="#cb19-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-60"><a href="#cb19-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"scores"</span>: results, <span class="st">"top_label"</span>: <span class="bu">max</span>(results, key<span class="op">=</span>results.get)}</span>
<span id="cb19-61"><a href="#cb19-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-62"><a href="#cb19-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"blip2"</span>:</span>
<span id="cb19-63"><a href="#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> transformers <span class="im">import</span> Blip2Processor, Blip2ForConditionalGeneration</span>
<span id="cb19-64"><a href="#cb19-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-65"><a href="#cb19-65" aria-hidden="true" tabindex="-1"></a>        processor <span class="op">=</span> Blip2Processor.from_pretrained(</span>
<span id="cb19-66"><a href="#cb19-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Salesforce/blip2-opt-2.7b"</span></span>
<span id="cb19-67"><a href="#cb19-67" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-68"><a href="#cb19-68" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Blip2ForConditionalGeneration.from_pretrained(</span>
<span id="cb19-69"><a href="#cb19-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Salesforce/blip2-opt-2.7b"</span>,</span>
<span id="cb19-70"><a href="#cb19-70" aria-hidden="true" tabindex="-1"></a>            torch_dtype<span class="op">=</span>torch.float16</span>
<span id="cb19-71"><a href="#cb19-71" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-72"><a href="#cb19-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-73"><a href="#cb19-73" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> processor(images<span class="op">=</span>img, text<span class="op">=</span>prompt, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb19-74"><a href="#cb19-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-75"><a href="#cb19-75" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb19-76"><a href="#cb19-76" aria-hidden="true" tabindex="-1"></a>            generated_ids <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_length<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb19-77"><a href="#cb19-77" aria-hidden="true" tabindex="-1"></a>            answer <span class="op">=</span> processor.decode(</span>
<span id="cb19-78"><a href="#cb19-78" aria-hidden="true" tabindex="-1"></a>                generated_ids[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span></span>
<span id="cb19-79"><a href="#cb19-79" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb19-80"><a href="#cb19-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-81"><a href="#cb19-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"answer"</span>: answer}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="visual-sentiment-market" class="cell" data-execution_count="20">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct daily visual sentiment index from news images</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: Vietnamese financial news sites (VnExpress, CafeF, etc.)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>news_images <span class="op">=</span> dc.get_news_images(</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>[<span class="st">"vnexpress_finance"</span>, <span class="st">"cafef"</span>]</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily visual sentiment</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>daily_sentiment <span class="op">=</span> (</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    news_images.groupby(<span class="st">"date"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>        visual_sentiment<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="st">"mean"</span>),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        n_images<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="st">"count"</span>),</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        pct_negative<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="kw">lambda</span> x: (x <span class="op">&lt;</span> <span class="dv">0</span>).mean())</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with market returns</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>sentiment_returns <span class="op">=</span> daily_sentiment.merge(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Lead-lag analysis: does visual sentiment predict next-day returns?</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>sentiment_returns <span class="op">=</span> sentiment_returns.sort_values(<span class="st">"date"</span>)</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>sentiment_returns[<span class="st">"mkt_ret_lead1"</span>] <span class="op">=</span> sentiment_returns[<span class="st">"mkt_ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="tbl-visual-sentiment-predictability" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="21">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-visual-sentiment-predictability-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.2: Visual Sentiment and Market Return Predictability
</figcaption>
<div aria-describedby="tbl-visual-sentiment-predictability-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression: next-day return on today's visual sentiment</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sr_clean <span class="op">=</span> sentiment_returns.dropna(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"mkt_ret_lead1"</span>, <span class="st">"visual_sentiment"</span>, <span class="st">"mkt_ret"</span>]</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>model_sent <span class="op">=</span> sm.OLS(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    sr_clean[<span class="st">"mkt_ret_lead1"</span>],</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    sm.add_constant(sr_clean[[<span class="st">"visual_sentiment"</span>, <span class="st">"mkt_ret"</span>]])</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">5</span>})</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>sent_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: model_sent.params.<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: model_sent.bse.<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: model_sent.tvalues.<span class="bu">round</span>(<span class="dv">3</span>),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: model_sent.pvalues.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>sent_results</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</figure>
</div>
</section>
</section>
<section id="multimodal-fusion-combining-image-and-text" class="level2" data-number="45.6">
<h2 data-number="45.6" class="anchored" data-anchor-id="multimodal-fusion-combining-image-and-text"><span class="header-section-number">45.6</span> Multimodal Fusion: Combining Image and Text</h2>
<section id="why-multimodal" class="level3" data-number="45.6.1">
<h3 data-number="45.6.1" class="anchored" data-anchor-id="why-multimodal"><span class="header-section-number">45.6.1</span> Why Multimodal?</h3>
<p>Text and images capture different dimensions of the same underlying economic reality. An earnings report describes financial performance in words and numbers; the accompanying photographs show factories, products, and management. A news article about a port describes trade volumes in text; the satellite image shows actual ship positions. Combining both modalities yields a richer representation than either alone.</p>
<p>The fusion architecture depends on the application:</p>
<p><strong>Early fusion.</strong> Concatenate image features <span class="math inline">\(\mathbf{z}^{\text{img}}\)</span> and text features <span class="math inline">\(\mathbf{z}^{\text{txt}}\)</span> into a single vector <span class="math inline">\([\mathbf{z}^{\text{img}}; \mathbf{z}^{\text{txt}}]\)</span> before prediction. Simple but ignores cross-modal interactions.</p>
<p><strong>Late fusion.</strong> Train separate models on each modality and combine predictions: <span class="math inline">\(\hat{y} = \alpha \hat{y}^{\text{img}} + (1-\alpha) \hat{y}^{\text{txt}}\)</span>. Robust but cannot learn cross-modal features.</p>
<p><strong>Cross-attention fusion.</strong> Use transformer cross-attention to let each modality attend to the other. Most powerful but requires more data and computation.</p>
<p><span id="eq-cross-attention"><span class="math display">\[
\mathbf{z}^{\text{fused}} = \text{CrossAttention}(\mathbf{z}^{\text{img}}, \mathbf{z}^{\text{txt}}) = \text{softmax}\left(\frac{\mathbf{Q}^{\text{img}} (\mathbf{K}^{\text{txt}})^\top}{\sqrt{d}}\right) \mathbf{V}^{\text{txt}}
\tag{45.3}\]</span></span></p>
<div id="multimodal-fusion" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultimodalFusionModel(nn.Module):</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Multimodal fusion model combining image and text features</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co">    for financial prediction.</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports early fusion, late fusion, and cross-attention.</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, img_dim<span class="op">=</span><span class="dv">2048</span>, txt_dim<span class="op">=</span><span class="dv">768</span>, hidden_dim<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>                 fusion<span class="op">=</span><span class="st">"early"</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fusion <span class="op">=</span> fusion</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Image projection</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_proj <span class="op">=</span> nn.Sequential(</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>            nn.Linear(img_dim, hidden_dim),</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Text projection</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.txt_proj <span class="op">=</span> nn.Sequential(</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>            nn.Linear(txt_dim, hidden_dim),</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fusion <span class="op">==</span> <span class="st">"early"</span>:</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, hidden_dim),</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(<span class="fl">0.2</span>),</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> fusion <span class="op">==</span> <span class="st">"late"</span>:</span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.img_head <span class="op">=</span> nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.txt_head <span class="op">=</span> nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha <span class="op">=</span> nn.Parameter(torch.tensor(<span class="fl">0.5</span>))</span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> fusion <span class="op">==</span> <span class="st">"cross_attention"</span>:</span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cross_attn <span class="op">=</span> nn.MultiheadAttention(</span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>                embed_dim<span class="op">=</span>hidden_dim,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>                num_heads<span class="op">=</span>n_heads,</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>                batch_first<span class="op">=</span><span class="va">True</span></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, hidden_dim <span class="op">//</span> <span class="dv">2</span>),</span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim <span class="op">//</span> <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, img_features, txt_features):</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a>        img_h <span class="op">=</span> <span class="va">self</span>.img_proj(img_features)</span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a>        txt_h <span class="op">=</span> <span class="va">self</span>.txt_proj(txt_features)</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"early"</span>:</span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>            combined <span class="op">=</span> torch.cat([img_h, txt_h], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.head(combined).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"late"</span>:</span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a>            img_pred <span class="op">=</span> <span class="va">self</span>.img_head(img_h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a>            txt_pred <span class="op">=</span> <span class="va">self</span>.txt_head(txt_h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> torch.sigmoid(<span class="va">self</span>.alpha)</span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> alpha <span class="op">*</span> img_pred <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> txt_pred</span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"cross_attention"</span>:</span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Image attends to text</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>            img_h_unsq <span class="op">=</span> img_h.unsqueeze(<span class="dv">1</span>)  <span class="co"># (B, 1, D)</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>            txt_h_unsq <span class="op">=</span> txt_h.unsqueeze(<span class="dv">1</span>)</span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>            attn_out, _ <span class="op">=</span> <span class="va">self</span>.cross_attn(</span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>                img_h_unsq, txt_h_unsq, txt_h_unsq</span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.head(attn_out.squeeze(<span class="dv">1</span>)).squeeze(<span class="op">-</span><span class="dv">1</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="multimodal-experiment" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_multimodal_experiment(image_features, text_features, returns,</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                               fusion_types<span class="op">=</span>[<span class="st">"early"</span>, <span class="st">"late"</span>,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"cross_attention"</span>]):</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare multimodal fusion strategies for return prediction.</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="co">    image_features : np.ndarray</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co">        Image feature matrix (N x img_dim).</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="co">    text_features : np.ndarray</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Text feature matrix (N x txt_dim).</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : np.ndarray</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co">        Target returns (N,).</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">    fusion_types : list</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">        Fusion strategies to compare.</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : R², MSE, Sharpe for each strategy.</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(returns)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fusion <span class="kw">in</span> fusion_types:</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        fold_r2s <span class="op">=</span> []</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> tscv.split(returns):</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to tensors</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>            X_img_train <span class="op">=</span> torch.tensor(</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>                image_features[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>            X_txt_train <span class="op">=</span> torch.tensor(</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>                text_features[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>            y_train <span class="op">=</span> torch.tensor(</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>                returns[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>            X_img_test <span class="op">=</span> torch.tensor(</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>                image_features[test_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>            X_txt_test <span class="op">=</span> torch.tensor(</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>                text_features[test_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>            y_test <span class="op">=</span> returns[test_idx]</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Build and train model</span></span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> MultimodalFusionModel(</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>                img_dim<span class="op">=</span>image_features.shape[<span class="dv">1</span>],</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>                txt_dim<span class="op">=</span>text_features.shape[<span class="dv">1</span>],</span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>                fusion<span class="op">=</span>fusion</span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>            optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>            loss_fn <span class="op">=</span> nn.MSELoss()</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>            model.train()</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">50</span>):</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>                optimizer.zero_grad()</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>                pred <span class="op">=</span> model(X_img_train, X_txt_train)</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss_fn(pred, y_train)</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>                loss.backward()</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>                optimizer.step()</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Evaluate</span></span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>                y_pred <span class="op">=</span> model(X_img_test, X_txt_test).numpy()</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>            ss_res <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_pred) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a>            ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_test.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot <span class="cf">if</span> ss_tot <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>            fold_r2s.append(r2)</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fusion"</span>: fusion,</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_mean"</span>: np.mean(fold_r2s),</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_std"</span>: np.std(fold_r2s)</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add unimodal baselines</span></span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> modality, features <span class="kw">in</span> [(<span class="st">"image_only"</span>, image_features),</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>                                (<span class="st">"text_only"</span>, text_features)]:</span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.linear_model <span class="im">import</span> RidgeCV</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>        fold_r2s <span class="op">=</span> []</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> tscv.split(returns):</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>            ridge <span class="op">=</span> RidgeCV(alphas<span class="op">=</span>np.logspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">10</span>))</span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>            ridge.fit(features[train_idx], returns[train_idx])</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> ridge.predict(features[test_idx])</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>            y_test <span class="op">=</span> returns[test_idx]</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>            ss_res <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_pred) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>            ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_test.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>            fold_r2s.append(<span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot <span class="cf">if</span> ss_tot <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fusion"</span>: modality,</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_mean"</span>: np.mean(fold_r2s),</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_std"</span>: np.std(fold_r2s)</span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="practical-considerations-for-vietnamese-markets" class="level3" data-number="45.6.2">
<h3 data-number="45.6.2" class="anchored" data-anchor-id="practical-considerations-for-vietnamese-markets"><span class="header-section-number">45.6.2</span> Practical Considerations for Vietnamese Markets</h3>
<p>Multimodal analysis in Vietnamese markets faces several practical considerations:</p>
<p><strong>Data alignment.</strong> Satellite images, news articles, and market data operate on different temporal frequencies and spatial resolutions. Satellite composites are available weekly or biweekly; news is daily; trading is intraday. Proper alignment requires specifying the information set available to an investor at the time of the trading decision to avoid look-ahead bias.</p>
<p><strong>Label scarcity.</strong> Supervised learning requires labeled data (e.g., images annotated with economic outcomes). In Vietnam, ground-truth labels (actual retail sales, actual crop yields, actual port throughput) arrive with significant lags and often lack the granularity to match satellite resolution. Semi-supervised and self-supervised approaches are therefore essential.</p>
<p><strong>Regulatory considerations.</strong> High-resolution satellite imagery of specific commercial or military installations may be restricted. Researchers should verify that their imagery sources comply with Vietnamese regulations on geospatial data.</p>
<p><strong>Computational cost.</strong> Processing satellite tiles through CNNs is computationally intensive. A single Sentinel-2 tile at 10m resolution covering Ho Chi Minh City contains approximately <span class="math inline">\(10{,}980 \times 10{,}980\)</span> pixels per band. Tiling into <span class="math inline">\(224 \times 224\)</span> patches for CNN input generates <span class="math inline">\(\sim 2{,}400\)</span> patches per tile, each requiring a forward pass through the network.</p>
<div id="tbl-image-sources" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-image-sources-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.3: Image Data Sources for Vietnamese Financial Applications
</figcaption>
<div aria-describedby="tbl-image-sources-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
<col style="width: 20%">
</colgroup>
<thead>
<tr class="header">
<th>Application</th>
<th>Image Source</th>
<th>Resolution</th>
<th>Frequency</th>
<th>Vietnamese Availability</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Nighttime luminosity</td>
<td>VIIRS/DMSP</td>
<td>500m</td>
<td>Monthly</td>
<td>Free (NOAA/EOG)</td>
</tr>
<tr class="even">
<td>Crop health</td>
<td>MODIS/Sentinel-2</td>
<td>250m/10m</td>
<td>16-day/5-day</td>
<td>Free (NASA/ESA)</td>
</tr>
<tr class="odd">
<td>Port/ship detection</td>
<td>Sentinel-1 (SAR)</td>
<td>10m</td>
<td>12-day</td>
<td>Free (ESA Copernicus)</td>
</tr>
<tr class="even">
<td>Construction monitoring</td>
<td>Commercial (Maxar)</td>
<td>30cm</td>
<td>On demand</td>
<td>Paid ($)</td>
</tr>
<tr class="odd">
<td>Urban density</td>
<td>Sentinel-2</td>
<td>10m</td>
<td>5-day</td>
<td>Free (ESA)</td>
</tr>
<tr class="even">
<td>Document OCR</td>
<td>Corporate filings</td>
<td>N/A</td>
<td>Event-driven</td>
<td>DataCore.vn</td>
</tr>
<tr class="odd">
<td>News images</td>
<td>Financial media</td>
<td>N/A</td>
<td>Daily</td>
<td>Web scraping</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<!-- ## Exercises

1.  **Nightlight and Firm Performance.** Extend the nightlight analysis by constructing a multi-province exposure measure for firms with geographically diversified operations (e.g., a retailer with stores across multiple provinces). Weight the nightlight signal by the estimated revenue share from each province. Test whether this weighted signal predicts quarterly earnings surprises better than the headquarters-only measure.

2.  **OCR Accuracy Benchmarking.** Collect a sample of 50 Vietnamese annual reports in scanned PDF format. Manually transcribe key financial figures (revenue, net income, total assets) from 5 reports to create ground truth. Compare OCR accuracy (character error rate, field-level exact match) across PaddleOCR, VietOCR, and Google Cloud Vision. Which engine performs best on Vietnamese financial tables? Does pre-processing (deskewing, contrast enhancement) significantly improve accuracy?

3.  **Satellite Nowcasting of Industrial Production.** Using Sentinel-2 imagery of industrial zones near Binh Duong, Dong Nai, and Bac Ninh, construct monthly indices of industrial activity based on CNN features. Specifically, train a model to predict the Industrial Production Index (IPI) published by the GSO using satellite features with a one-month lead. Report out-of-sample $R^2$ and compare with a baseline that uses only lagged IPI values (autoregressive benchmark).

4.  **Visual Sentiment and Earnings Announcements.** For a sample of Vietnamese firms, collect the photographs accompanying earnings-related news coverage on VnExpress and CafeF. Compute visual sentiment scores for each image using a pre-trained model. Test whether visual sentiment around earnings dates (5-day window) predicts post-earnings-announcement drift (PEAD), controlling for the textual sentiment of the same articles. Does the image add information beyond the text?

5.  **Multimodal Earnings Prediction.** For each firm-quarter observation, construct three feature sets: (a) tabular financial ratios, (b) textual features from the management discussion section of the annual report (using PhoBERT embeddings from the previous chapter), and (c) satellite features of the firm's headquarters region. Implement early, late, and cross-attention fusion and compare forecast accuracy for next-quarter earnings. Which modality contributes most? Does the multimodal model significantly outperform the best unimodal model?

6.  **Chart Digitization for Historical Vietnamese Market Data.** Obtain scanned charts of the VN-Index from pre-2005 sources (before electronic data was widely available). Digitize the index level time series using the line chart digitization algorithm. Cross-validate against any available electronic data for overlapping periods. Estimate the digitization error and assess whether the recovered time series is sufficiently accurate for computing return statistics (mean, volatility, maximum drawdown). -->
</section>
</section>
<section id="summary" class="level2" data-number="45.7">
<h2 data-number="45.7" class="anchored" data-anchor-id="summary"><span class="header-section-number">45.7</span> Summary</h2>
<p>This chapter extended the alternative data toolkit from text (the previous chapter) to images. We demonstrated five distinct application domains for visual data in Vietnamese financial markets.</p>
<p>First, satellite and geospatial imagery provides high-frequency, spatially granular economic signals that lead official statistics. Nighttime luminosity serves as a provincial GDP proxy with cross-sectional <span class="math inline">\(R^2\)</span> exceeding 0.7; NDVI crop health indices predict agricultural firm returns; and CNN features extracted from satellite tiles enable rich spatial representations of economic activity.</p>
<p>Second, document image analysis solves the practical problem of extracting structured data from Vietnamese financial filings that arrive as scanned images. The pipeline (e.g., OCR with Vietnamese-optimized engines, layout analysis, table extraction, and LayoutLM-based document understanding) converts unstructured pixels into the structured financial data that all downstream analyses require.</p>
<p>Third, chart digitization recovers numerical data series from visual representations, extending historical coverage and enabling systematic consumption of analyst outputs. Fourth, visual sentiment analysis from news imagery provides a signal dimension orthogonal to textual sentiment, with potential predictive power for market returns.</p>
<p>Fifth, multimodal fusion (combining image and text representations via early, late, or cross-attention architectures) yields richer predictive models than either modality alone. The practical benefit of multimodal approaches scales with the diversity and quality of available data, making it increasingly relevant as Vietnamese alternative data ecosystems mature.</p>
<p>The common thread across all applications is the transformation pipeline: raw pixel tensor <span class="math inline">\(\to\)</span> feature representation (via CNN, ViT, or VLM) <span class="math inline">\(\to\)</span> financial signal <span class="math inline">\(\to\)</span> economic interpretation. The choice of architecture and the quality of the domain adaptation determine whether the resulting signal has genuine predictive content or merely captures noise.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-baek2019wrong" class="csl-entry" role="listitem">
Baek, Jeonghun, Geewook Kim, Junyeop Lee, Sungrae Park, Dongyoon Han, Sangdoo Yun, Seong Joon Oh, and Hwalsuk Lee. 2019. <span>“What Is Wrong with Scene Text Recognition Model Comparisons? Dataset and Model Analysis.”</span> In <em>Proceedings of the IEEE/CVF International Conference on Computer Vision</em>, 4715–23.
</div>
<div id="ref-donaldson2018railroads" class="csl-entry" role="listitem">
Donaldson, Dave. 2018. <span>“Railroads of the Raj: Estimating the Impact of Transportation Infrastructure.”</span> <em>American Economic Review</em> 108 (4-5): 899–934.
</div>
<div id="ref-henderson2012measuring" class="csl-entry" role="listitem">
Henderson, J Vernon, Adam Storeygard, and David N Weil. 2012. <span>“Measuring Economic Growth from Outer Space.”</span> <em>American Economic Review</em> 102 (2): 994–1028.
</div>
<div id="ref-huang2022layoutlmv3" class="csl-entry" role="listitem">
Huang, Yupan, Tengchao Lv, Lei Cui, Yutong Lu, and Furu Wei. 2022. <span>“Layoutlmv3: Pre-Training for Document Ai with Unified Text and Image Masking.”</span> In <em>Proceedings of the 30th ACM International Conference on Multimedia</em>, 4083–91.
</div>
<div id="ref-jean2016combining" class="csl-entry" role="listitem">
Jean, Neal, Marshall Burke, Michael Xie, W Matthew Alampay Davis, David B Lobell, and Stefano Ermon. 2016. <span>“Combining Satellite Imagery and Machine Learning to Predict Poverty.”</span> <em>Science</em> 353 (6301): 790–94.
</div>
<div id="ref-li2023blip" class="csl-entry" role="listitem">
Li, Junnan, Dongxu Li, Silvio Savarese, and Steven Hoi. 2023. <span>“Blip-2: Bootstrapping Language-Image Pre-Training with Frozen Image Encoders and Large Language Models.”</span> In <em>International Conference on Machine Learning</em>, 19730–42. PMLR.
</div>
<div id="ref-obaid2022picture" class="csl-entry" role="listitem">
Obaid, Khaled, and Kuntara Pukthuanthong. 2022. <span>“A Picture Is Worth a Thousand Words: Measuring Investor Sentiment by Combining Machine Learning and Photos from News.”</span> <em>Journal of Financial Economics</em> 144 (1): 273–97.
</div>
<div id="ref-radford2021learning" class="csl-entry" role="listitem">
Radford, Alec, Jong Wook Kim, Chris Hallacy, Aditya Ramesh, Gabriel Goh, Sandhini Agarwal, Girish Sastry, et al. 2021. <span>“Learning Transferable Visual Models from Natural Language Supervision.”</span> In <em>International Conference on Machine Learning</em>, 8748–63. PmLR.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./70_textual.html" class="pagination-link" aria-label="Textual Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./99_conclusion.html" class="pagination-link" aria-label="Conclusion">
        <span class="nav-page-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Conclusion</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Image and Visual Data in Finance</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>The previous chapter demonstrated how unstructured text (e.g., earnings reports, news articles, business descriptions) can be transformed into structured signals for financial analysis. This chapter extends the alternative data toolkit to a second modality: images. Visual data is abundant in financial contexts yet systematically underexploited. Satellite photographs reveal real economic activity (e.g., parking lot occupancy at retail locations, construction progress at industrial sites, nighttime luminosity as a proxy for regional GDP, ship traffic at port terminals, crop health across agricultural zones). Corporate documents arrive as scanned PDFs whose tables and figures resist standard text extraction. Financial charts encode information that analysts interpret visually but that systematic strategies cannot consume without digitization. And the visual content of social media, advertising, and product imagery carries sentiment and brand signals that complement textual analysis.</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>The core challenge is representational: an image is a three-dimensional tensor of pixel intensities with no inherent semantic structure. Converting this raw array into a financial signal (i.e., a number that predicts returns, measures risk, or proxies for economic activity) requires either hand-crafted feature engineering or learned representations via deep convolutional neural networks (CNNs) and vision transformers (ViTs). This chapter covers both approaches.</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>We organize the material around five application domains, each with distinct data sources, modeling requirements, and economic motivations. First, satellite and geospatial imagery for nowcasting economic activity. Second, document image analysis for extracting structured data from Vietnamese financial filings. Third, chart and figure digitization for systematic backtesting. Fourth, visual sentiment analysis from social and news media. Fifth, multimodal fusion, combining image and text signals into joint predictive models.</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>Vietnamese markets present particular opportunities in this space. Satellite imagery is especially informative in an economy with large agricultural and manufacturing sectors where ground-truth data arrives with significant lags. Vietnamese financial filings are often distributed as scanned images rather than machine-readable formats, making document AI essential rather than optional. And the rapid urbanization visible in construction and infrastructure imagery provides high-frequency proxies for macroeconomic momentum that official statistics cannot match.</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Core image processing</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Deep learning</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn <span class="im">as</span> nn</span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.transforms <span class="im">as</span> transforms</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision.models <span class="im">as</span> models</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualization</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotnine <span class="im">as</span> p9</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mizani.formatters <span class="im">import</span> percent_format, comma_format</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Statistical analysis</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> linearmodels.panel <span class="im">import</span> PanelOLS</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## Foundations: From Pixels to Financial Signals</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a><span class="fu">### Image Representation</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>A digital image is a function $I: <span class="sc">\{</span>1, \ldots, H<span class="sc">\}</span> \times <span class="sc">\{</span>1, \ldots, W<span class="sc">\}</span> \times <span class="sc">\{</span>1, \ldots, C<span class="sc">\}</span> \rightarrow <span class="co">[</span><span class="ot">0, 255</span><span class="co">]</span>$ mapping spatial coordinates and color channels to intensity values. For an RGB image of height $H$ and width $W$, the representation is a tensor $\mathbf{I} \in \mathbb{R}^{H \times W \times 3}$. A single $224 \times 224$ RGB image (i.e., the standard input for modern CNNs) contains $224 \times 224 \times 3 = 150{,}528$ dimensions. This extreme dimensionality, combined with spatial structure (nearby pixels are correlated), makes images fundamentally different from tabular financial data and demands specialized architectures.</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a>The key insight of convolutional neural networks is parameter sharing via local filters. A convolutional layer applies a kernel $\mathbf{K} \in \mathbb{R}^{k \times k \times C_{\text{in}}}$ to produce a feature map:</span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>(\mathbf{I} * \mathbf{K})(i, j) = \sum_{m=0}^{k-1} \sum_{n=0}^{k-1} \sum_{c=1}^{C_{\text{in}}} I(i+m, j+n, c) \cdot K(m, n, c)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>$$ {#eq-convolution}</span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-57"><a href="#cb24-57" aria-hidden="true" tabindex="-1"></a>By stacking convolutional layers with nonlinearities and pooling operations, the network builds a hierarchy of representations: early layers detect edges and textures; middle layers detect parts and patterns; deep layers detect objects and scenes. The final layer output $\mathbf{z} \in \mathbb{R}^{d}$ (with $d$ typically 512-2048) is a compact representation of the image's semantic content, which can be used directly as a feature vector for financial prediction.</span>
<span id="cb24-58"><a href="#cb24-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transfer Learning for Finance</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a>Training a CNN from scratch requires millions of labeled images, which is far more than any financial application can provide. Transfer learning solves this by using networks pre-trained on ImageNet (1.2 million images, 1,000 classes) as feature extractors. The pre-trained network has already learned generic visual representations (edges, textures, shapes, objects); we simply replace the final classification layer with a task-specific head.</span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a>Formally, let $f_{\boldsymbol{\theta}}(\mathbf{I})$ denote a pre-trained network with parameters $\boldsymbol{\theta}$ partitioned into feature extractor $\boldsymbol{\theta}_{\text{feat}}$ and classifier $\boldsymbol{\theta}_{\text{cls}}$. For financial applications, we:</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Feature extraction**: Freeze $\boldsymbol{\theta}_{\text{feat}}$, extract $\mathbf{z} = f_{\boldsymbol{\theta}_{\text{feat}}}(\mathbf{I})$, and train a simple model (linear regression, gradient boosting) on $\mathbf{z}$.</span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Fine-tuning**: Initialize from $\boldsymbol{\theta}$ and train all parameters on the financial task with a small learning rate to avoid catastrophic forgetting.</span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: feature-extractor</span></span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="co"># DataCore.vn API</span></span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCore</span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> DataCore()</span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_feature_extractor(model_name<span class="op">=</span><span class="st">"resnet50"</span>, device<span class="op">=</span><span class="st">"cpu"</span>):</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="co">    Build a pre-trained CNN feature extractor.</span></span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="co">        One of 'resnet50', 'efficientnet_b0', 'vit_b_16'.</span></span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a><span class="co">    device : str</span></span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a><span class="co">        'cpu' or 'cuda'.</span></span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-89"><a href="#cb24-89" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-90"><a href="#cb24-90" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="co">    model : nn.Module</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="co">        Feature extraction model.</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a><span class="co">    transform : transforms.Compose</span></span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a><span class="co">        Image preprocessing pipeline.</span></span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">"resnet50"</span>:</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.ResNet50_Weights.IMAGENET1K_V2</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.resnet50(weights<span class="op">=</span>weights)</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>        model.fc <span class="op">=</span> nn.Identity()  <span class="co"># Remove classification head</span></span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">2048</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"efficientnet_b0"</span>:</span>
<span id="cb24-102"><a href="#cb24-102" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.EfficientNet_B0_Weights.IMAGENET1K_V1</span>
<span id="cb24-103"><a href="#cb24-103" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.efficientnet_b0(weights<span class="op">=</span>weights)</span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a>        model.classifier <span class="op">=</span> nn.Identity()</span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">1280</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"vit_b_16"</span>:</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> models.ViT_B_16_Weights.IMAGENET1K_V1</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> models.vit_b_16(weights<span class="op">=</span>weights)</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a>        model.heads <span class="op">=</span> nn.Identity()</span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a>        dim <span class="op">=</span> <span class="dv">768</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> model.to(device).<span class="bu">eval</span>()</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>    transform <span class="op">=</span> transforms.Compose([</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>        transforms.Resize(<span class="dv">256</span>),</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>        transforms.CenterCrop(<span class="dv">224</span>),</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a>        transforms.ToTensor(),</span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a>        transforms.Normalize(</span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>            mean<span class="op">=</span>[<span class="fl">0.485</span>, <span class="fl">0.456</span>, <span class="fl">0.406</span>],</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>            std<span class="op">=</span>[<span class="fl">0.229</span>, <span class="fl">0.224</span>, <span class="fl">0.225</span>]</span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a>    ])</span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-124"><a href="#cb24-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model, transform, dim</span>
<span id="cb24-125"><a href="#cb24-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_features(image_paths, model, transform, device<span class="op">=</span><span class="st">"cpu"</span>,</span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>                     batch_size<span class="op">=</span><span class="dv">32</span>):</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract deep features from a list of images.</span></span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a><span class="co">    image_paths : list</span></span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a><span class="co">        Paths to image files.</span></span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a><span class="co">    model : nn.Module</span></span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a><span class="co">        Feature extraction model.</span></span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a><span class="co">    transform : transforms.Compose</span></span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a><span class="co">        Preprocessing pipeline.</span></span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-143"><a href="#cb24-143" aria-hidden="true" tabindex="-1"></a><span class="co">    np.ndarray : Feature matrix (n_images x feature_dim).</span></span>
<span id="cb24-144"><a href="#cb24-144" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> []</span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">0</span>, <span class="bu">len</span>(image_paths), batch_size):</span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>        batch_paths <span class="op">=</span> image_paths[i:i <span class="op">+</span> batch_size]</span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>        batch_tensors <span class="op">=</span> []</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> path <span class="kw">in</span> batch_paths:</span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a>                img <span class="op">=</span> Image.<span class="bu">open</span>(path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a>                tensor <span class="op">=</span> transform(img)</span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>                batch_tensors.append(tensor)</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>                batch_tensors.append(torch.zeros(<span class="dv">3</span>, <span class="dv">224</span>, <span class="dv">224</span>))</span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>        batch <span class="op">=</span> torch.stack(batch_tensors).to(device)</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a>            batch_features <span class="op">=</span> model(batch).cpu().numpy()</span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a>        features.append(batch_features)</span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.vstack(features)</span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a><span class="fu">## Satellite and Geospatial Imagery</span></span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a><span class="fu">### Economic Activity from Space</span></span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a>Satellite imagery provides high-frequency, spatially granular measurements of economic activity that are independent of and often lead official statistics. The foundational work of @henderson2012measuring demonstrated that nighttime luminosity, measured by the Defense Meteorological Satellite Program (DMSP), is a reliable proxy for GDP, particularly in countries where official statistics are noisy or delayed. @donaldson2018railroads use satellite-derived agricultural output measures to study the welfare gains from railroads in colonial India. @jean2016combining combine daytime satellite imagery with CNNs to predict poverty from space with $r^2 &gt; 0.7$.</span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a>For financial applications, the key insight is that satellite data arrives faster than corporate earnings or government statistics. A retailer's quarterly revenue is reported 4-8 weeks after the quarter ends; satellite imagery of its parking lots is available within days. This temporal advantage creates a natural use case for nowcasting (i.e., estimating current economic conditions before official data arrives) and for constructing trading signals based on information that is public but costly to process.</span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a><span class="fu">### Application 1: Nighttime Luminosity and Provincial GDP</span></span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>Vietnam's General Statistics Office (GSO) publishes provincial GDP with a lag of several months. Nighttime luminosity from the VIIRS (Visible Infrared Imaging Radiometer Suite) sensor provides a near-real-time alternative. We construct a firm-level exposure measure by linking each listed firm's registered location to the luminosity of its province.</span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nightlight-data</span></span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-186"><a href="#cb24-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-187"><a href="#cb24-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Load nighttime luminosity data (VIIRS monthly composites)</span></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: Earth Observation Group (EOG) / NOAA</span></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a>nightlights <span class="op">=</span> dc.get_nightlight_data(</span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>    resolution<span class="op">=</span><span class="st">"province"</span></span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Load firm location data</span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>firm_locations <span class="op">=</span> dc.get_firm_locations()</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a><span class="co"># Provincial GDP from GSO</span></span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>provincial_gdp <span class="op">=</span> dc.get_provincial_gdp(</span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Nightlight observations: </span><span class="sc">{</span><span class="bu">len</span>(nightlights)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-205"><a href="#cb24-205" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Provinces covered: </span><span class="sc">{</span>nightlights[<span class="st">'province'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-206"><a href="#cb24-206" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Firms with location: </span><span class="sc">{</span>firm_locations[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nightlight-gdp-validation</span></span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate: does nightlight predict provincial GDP?</span></span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a>nl_gdp <span class="op">=</span> nightlights.merge(</span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a>    provincial_gdp,</span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>],</span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Log-log specification (standard in the literature)</span></span>
<span id="cb24-223"><a href="#cb24-223" aria-hidden="true" tabindex="-1"></a>nl_gdp[<span class="st">"ln_luminosity"</span>] <span class="op">=</span> np.log(nl_gdp[<span class="st">"mean_radiance"</span>].clip(lower<span class="op">=</span><span class="fl">0.01</span>))</span>
<span id="cb24-224"><a href="#cb24-224" aria-hidden="true" tabindex="-1"></a>nl_gdp[<span class="st">"ln_gdp"</span>] <span class="op">=</span> np.log(nl_gdp[<span class="st">"provincial_gdp"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="co"># Cross-sectional regression by year</span></span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>validation_results <span class="op">=</span> []</span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> nl_gdp[<span class="st">"year"</span>].unique():</span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> nl_gdp[nl_gdp[<span class="st">"year"</span>] <span class="op">==</span> year]</span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(subset) <span class="op">&lt;</span> <span class="dv">20</span>:</span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(</span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>        subset[<span class="st">"ln_gdp"</span>],</span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>        sm.add_constant(subset[<span class="st">"ln_luminosity"</span>])</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>    ).fit()</span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a>    validation_results.append({</span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a>        <span class="st">"year"</span>: year,</span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>        <span class="st">"beta"</span>: model.params.iloc[<span class="dv">1</span>],</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r_squared"</span>: model.rsquared,</span>
<span id="cb24-242"><a href="#cb24-242" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_provinces"</span>: <span class="bu">int</span>(model.nobs)</span>
<span id="cb24-243"><a href="#cb24-243" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>validation_df <span class="op">=</span> pd.DataFrame(validation_results)</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Avg R² (ln GDP ~ ln Luminosity): </span><span class="sc">{</span>validation_df[<span class="st">'r_squared'</span>]<span class="sc">.</span>mean()<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-nightlight-gdp</span></span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Nighttime Luminosity as a Predictor of Provincial GDP"</span></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(nl_gdp[nl_gdp[<span class="st">"year"</span>] <span class="op">==</span> <span class="dv">2023</span>],</span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>              p9.aes(x<span class="op">=</span><span class="st">"ln_luminosity"</span>, y<span class="op">=</span><span class="st">"ln_gdp"</span>))</span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_point(color<span class="op">=</span><span class="st">"#2E5090"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, size<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lm"</span>, color<span class="op">=</span><span class="st">"#C0392B"</span>, se<span class="op">=</span><span class="va">True</span>, size<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">"ln(Mean Nighttime Radiance)"</span>,</span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"ln(Provincial GDP)"</span>,</span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Nighttime Luminosity vs. Provincial GDP (2023)"</span></span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-273"><a href="#cb24-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nightlight-firm-signal</span></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct firm-level nightlight signal</span></span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a><span class="co"># Logic: firms in provinces with accelerating luminosity</span></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a><span class="co"># are experiencing positive local economic conditions</span></span>
<span id="cb24-280"><a href="#cb24-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-281"><a href="#cb24-281" aria-hidden="true" tabindex="-1"></a>nl_growth <span class="op">=</span> nightlights.copy().sort_values([<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>])</span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Year-over-year luminosity growth by province</span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"ln_radiance"</span>] <span class="op">=</span> np.log(nl_growth[<span class="st">"mean_radiance"</span>].clip(lower<span class="op">=</span><span class="fl">0.01</span>))</span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"ln_radiance_lag4"</span>] <span class="op">=</span> nl_growth.groupby(</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a>    <span class="st">"province"</span></span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"ln_radiance"</span>].shift(<span class="dv">4</span>)</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a>nl_growth[<span class="st">"nl_growth"</span>] <span class="op">=</span> nl_growth[<span class="st">"ln_radiance"</span>] <span class="op">-</span> nl_growth[<span class="st">"ln_radiance_lag4"</span>]</span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with firms via province</span></span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a>firm_nl <span class="op">=</span> firm_locations[[<span class="st">"ticker"</span>, <span class="st">"province"</span>]].merge(</span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a>    nl_growth[[<span class="st">"province"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>, <span class="st">"nl_growth"</span>]],</span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"province"</span>,</span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-298"><a href="#cb24-298" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with stock returns</span></span>
<span id="cb24-299"><a href="#cb24-299" aria-hidden="true" tabindex="-1"></a>monthly_returns <span class="op">=</span> dc.get_monthly_returns(</span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span></span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a>monthly_returns[<span class="st">"year"</span>] <span class="op">=</span> monthly_returns[<span class="st">"date"</span>].dt.year</span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a>monthly_returns[<span class="st">"quarter"</span>] <span class="op">=</span> monthly_returns[<span class="st">"date"</span>].dt.quarter</span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-306"><a href="#cb24-306" aria-hidden="true" tabindex="-1"></a>returns_with_nl <span class="op">=</span> monthly_returns.merge(</span>
<span id="cb24-307"><a href="#cb24-307" aria-hidden="true" tabindex="-1"></a>    firm_nl,</span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"ticker"</span>, <span class="st">"year"</span>, <span class="st">"quarter"</span>],</span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: nightlight-portfolio</span></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-318"><a href="#cb24-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-319"><a href="#cb24-319" aria-hidden="true" tabindex="-1"></a><span class="co"># Portfolio sort: quintiles on provincial nightlight growth</span></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a>returns_with_nl[<span class="st">"nl_quintile"</span>] <span class="op">=</span> returns_with_nl.groupby(<span class="st">"date"</span>)[</span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nl_growth"</span></span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a>].transform(<span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span>[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>],</span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a>                                duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a>nl_port_returns <span class="op">=</span> (</span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>    returns_with_nl.groupby([<span class="st">"date"</span>, <span class="st">"nl_quintile"</span>])</span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>    .agg(port_ret<span class="op">=</span>(<span class="st">"ret"</span>, <span class="st">"mean"</span>))</span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-331"><a href="#cb24-331" aria-hidden="true" tabindex="-1"></a>nl_wide <span class="op">=</span> nl_port_returns.pivot(</span>
<span id="cb24-332"><a href="#cb24-332" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"nl_quintile"</span>, values<span class="op">=</span><span class="st">"port_ret"</span></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a>nl_wide[<span class="st">"L-S"</span>] <span class="op">=</span> nl_wide[<span class="dv">5</span>] <span class="op">-</span> nl_wide[<span class="dv">1</span>]  <span class="co"># High NL growth - Low</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-nightlight-portfolios</span></span>
<span id="cb24-341"><a href="#cb24-341" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-342"><a href="#cb24-342" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Nighttime Luminosity Growth Quintile Portfolio Returns"</span></span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a>nl_summary <span class="op">=</span> nl_wide.describe().T[[<span class="st">"mean"</span>, <span class="st">"std"</span>]].copy()</span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a>nl_summary[<span class="st">"mean_ann"</span>] <span class="op">=</span> nl_summary[<span class="st">"mean"</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a>nl_summary[<span class="st">"sharpe"</span>] <span class="op">=</span> (</span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a>    nl_summary[<span class="st">"mean_ann"</span>] <span class="op">/</span> (nl_summary[<span class="st">"std"</span>] <span class="op">*</span> np.sqrt(<span class="dv">12</span>))</span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> nl_wide.columns:</span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a>    t_stat <span class="op">=</span> nl_wide[col].mean() <span class="op">/</span> (</span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a>        nl_wide[col].std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(nl_wide.dropna()))</span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>    nl_summary.loc[col, <span class="st">"t_stat"</span>] <span class="op">=</span> t_stat</span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>nl_summary <span class="op">=</span> nl_summary[[<span class="st">"mean_ann"</span>, <span class="st">"sharpe"</span>, <span class="st">"t_stat"</span>]].<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a>nl_summary.columns <span class="op">=</span> [<span class="st">"Ann. Return"</span>, <span class="st">"Sharpe"</span>, <span class="st">"t-stat"</span>]</span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a>nl_summary</span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a><span class="fu">### Application 2: Satellite Imagery for Sector Nowcasting</span></span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a>Beyond luminosity, daytime satellite imagery provides sector-specific signals. We implement three channels relevant to the Vietnamese economy.</span>
<span id="cb24-363"><a href="#cb24-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-364"><a href="#cb24-364" aria-hidden="true" tabindex="-1"></a>**Port activity.** Vietnam is a major export-oriented economy. Satellite imagery of container ports (Cát Lái, Hải Phòng) captures trade throughput before customs statistics are released. Ship detection algorithms applied to synthetic aperture radar (SAR) imagery count vessels and estimate cargo volumes.</span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a>**Construction progress.** Real estate and construction constitute a significant fraction of Vietnamese GDP and market capitalization. Change detection algorithms applied to high-resolution optical imagery identify construction starts, completion rates, and land-use conversion.</span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>**Agricultural monitoring.** Vietnam is a leading exporter of rice, coffee, rubber, and seafood. The Normalized Difference Vegetation Index (NDVI), computed from multispectral satellite data, provides crop health assessments:</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>\text{NDVI} = \frac{\rho_{\text{NIR}} - \rho_{\text{Red}}}{\rho_{\text{NIR}} + \rho_{\text{Red}}}</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ndvi}</span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a>where $\rho_{\text{NIR}}$ and $\rho_{\text{Red}}$ are reflectance in the near-infrared and red bands. NDVI ranges from $-1$ to $+1$, with values above 0.3 indicating healthy vegetation. Deviations from seasonal norms proxy for crop yield surprises.</span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ndvi-agriculture</span></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a><span class="co"># Load NDVI data for Vietnamese agricultural regions</span></span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: MODIS/Terra (MOD13Q1, 250m resolution, 16-day composites)</span></span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a>ndvi_data <span class="op">=</span> dc.get_ndvi_data(</span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>    regions<span class="op">=</span>[<span class="st">"mekong_delta"</span>, <span class="st">"central_highlands"</span>,</span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a>             <span class="st">"red_river_delta"</span>, <span class="st">"southeast"</span>]</span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute NDVI anomaly: deviation from 5-year seasonal average</span></span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a>ndvi_data[<span class="st">"month"</span>] <span class="op">=</span> ndvi_data[<span class="st">"date"</span>].dt.month</span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>seasonal_mean <span class="op">=</span> (</span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>    ndvi_data.groupby([<span class="st">"region"</span>, <span class="st">"month"</span>])</span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"mean_ndvi"</span>].transform(</span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.rolling(<span class="dv">5</span> <span class="op">*</span> <span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">12</span>).mean()</span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>ndvi_data[<span class="st">"ndvi_anomaly"</span>] <span class="op">=</span> ndvi_data[<span class="st">"mean_ndvi"</span>] <span class="op">-</span> seasonal_mean</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Agricultural sector firms</span></span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>agri_firms <span class="op">=</span> dc.get_firms_by_sector(sector<span class="op">=</span><span class="st">"agriculture"</span>)</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a><span class="co"># Link NDVI anomaly to agricultural firm returns</span></span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a>agri_returns <span class="op">=</span> monthly_returns[</span>
<span id="cb24-407"><a href="#cb24-407" aria-hidden="true" tabindex="-1"></a>    monthly_returns[<span class="st">"ticker"</span>].isin(agri_firms[<span class="st">"ticker"</span>])</span>
<span id="cb24-408"><a href="#cb24-408" aria-hidden="true" tabindex="-1"></a>].copy()</span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a>agri_returns[<span class="st">"month"</span>] <span class="op">=</span> agri_returns[<span class="st">"date"</span>].dt.month</span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a>agri_returns[<span class="st">"year"</span>] <span class="op">=</span> agri_returns[<span class="st">"date"</span>].dt.year</span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a><span class="co"># Regional NDVI aggregation (Mekong Delta for rice firms, etc.)</span></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a>mekong_ndvi <span class="op">=</span> ndvi_data[ndvi_data[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"mekong_delta"</span>].copy()</span>
<span id="cb24-415"><a href="#cb24-415" aria-hidden="true" tabindex="-1"></a>mekong_ndvi[<span class="st">"year"</span>] <span class="op">=</span> mekong_ndvi[<span class="st">"date"</span>].dt.year</span>
<span id="cb24-416"><a href="#cb24-416" aria-hidden="true" tabindex="-1"></a>mekong_ndvi[<span class="st">"month"</span>] <span class="op">=</span> mekong_ndvi[<span class="st">"date"</span>].dt.month</span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a>mekong_monthly <span class="op">=</span> (</span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a>    mekong_ndvi.groupby([<span class="st">"year"</span>, <span class="st">"month"</span>])</span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a>    .agg(ndvi_anomaly<span class="op">=</span>(<span class="st">"ndvi_anomaly"</span>, <span class="st">"mean"</span>))</span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ndvi-timeseries</span></span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "NDVI Anomaly in Mekong Delta: Crop Health Signal"</span></span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>ndvi_plot <span class="op">=</span> ndvi_data[ndvi_data[<span class="st">"region"</span>] <span class="op">==</span> <span class="st">"mekong_delta"</span>].copy()</span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-434"><a href="#cb24-434" aria-hidden="true" tabindex="-1"></a>(</span>
<span id="cb24-435"><a href="#cb24-435" aria-hidden="true" tabindex="-1"></a>    p9.ggplot(ndvi_plot, p9.aes(x<span class="op">=</span><span class="st">"date"</span>, y<span class="op">=</span><span class="st">"ndvi_anomaly"</span>))</span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_line(color<span class="op">=</span><span class="st">"#27AE60"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">0.4</span>)</span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_smooth(method<span class="op">=</span><span class="st">"lowess"</span>, color<span class="op">=</span><span class="st">"#2E5090"</span>, size<span class="op">=</span><span class="dv">1</span>, se<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.geom_hline(yintercept<span class="op">=</span><span class="dv">0</span>, linetype<span class="op">=</span><span class="st">"dashed"</span>, color<span class="op">=</span><span class="st">"gray"</span>)</span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.labs(</span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a>        x<span class="op">=</span><span class="st">""</span>,</span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a>        y<span class="op">=</span><span class="st">"NDVI Anomaly"</span>,</span>
<span id="cb24-442"><a href="#cb24-442" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Mekong Delta Vegetation Health: Deviation from Seasonal Norm"</span></span>
<span id="cb24-443"><a href="#cb24-443" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme_minimal()</span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> p9.theme(figure_size<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ndvi-return-prediction</span></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-454"><a href="#cb24-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-455"><a href="#cb24-455" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel regression: agricultural firm returns on NDVI anomaly</span></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a>agri_panel <span class="op">=</span> agri_returns.merge(</span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a>    mekong_monthly,</span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span>[<span class="st">"year"</span>, <span class="st">"month"</span>],</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a><span class="co"># Lagged NDVI anomaly (one month)</span></span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>agri_panel <span class="op">=</span> agri_panel.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a>agri_panel[<span class="st">"ndvi_lag1"</span>] <span class="op">=</span> agri_panel.groupby(</span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ticker"</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a>)[<span class="st">"ndvi_anomaly"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb24-467"><a href="#cb24-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-468"><a href="#cb24-468" aria-hidden="true" tabindex="-1"></a>agri_clean <span class="op">=</span> agri_panel.dropna(</span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"ret"</span>, <span class="st">"ndvi_lag1"</span>]</span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a>).set_index([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>model_ndvi <span class="op">=</span> PanelOLS(</span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a>    agri_clean[<span class="st">"ret"</span>],</span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a>    agri_clean[[<span class="st">"ndvi_lag1"</span>]],</span>
<span id="cb24-475"><a href="#cb24-475" aria-hidden="true" tabindex="-1"></a>    entity_effects<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-476"><a href="#cb24-476" aria-hidden="true" tabindex="-1"></a>    time_effects<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a>    check_rank<span class="op">=</span><span class="va">False</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"clustered"</span>, cluster_entity<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>agri_clean <span class="op">=</span> agri_clean.reset_index()</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"NDVI → Agricultural Returns:"</span>)</span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  β(NDVI_lag): </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>params[<span class="st">'ndvi_lag1'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  t-stat: </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>tstats[<span class="st">'ndvi_lag1'</span>]<span class="sc">:.3f}</span><span class="ss">"</span>)</span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  R² (within): </span><span class="sc">{</span>model_ndvi<span class="sc">.</span>rsquared_within<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a><span class="fu">### Satellite Feature Extraction with CNNs</span></span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>For raw satellite imagery (rather than pre-computed indices like NDVI), we use transfer learning from CNNs to extract spatial features. The approach follows @jean2016combining: use a CNN pre-trained on ImageNet to extract feature vectors from satellite tiles, then regress economic outcomes on these features.</span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: satellite-cnn-pipeline</span></span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> satellite_feature_pipeline(image_dir, model_name<span class="op">=</span><span class="st">"resnet50"</span>):</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract CNN features from satellite image tiles.</span></span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a><span class="co">    image_dir : str or Path</span></span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a><span class="co">        Directory containing satellite tiles (PNG/TIFF).</span></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a><span class="co">        Pre-trained model to use.</span></span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : image_id, feature vector columns.</span></span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>    image_dir <span class="op">=</span> Path(image_dir)</span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a>    image_paths <span class="op">=</span> <span class="bu">sorted</span>(image_dir.glob(<span class="st">"*.png"</span>)) <span class="op">+</span> <span class="bu">sorted</span>(</span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a>        image_dir.glob(<span class="st">"*.tif"</span>)</span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> image_paths:</span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"No images found."</span>)</span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.DataFrame()</span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>    model, transform, dim <span class="op">=</span> build_feature_extractor(model_name, device)</span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_features(image_paths, model, transform, device)</span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create DataFrame</span></span>
<span id="cb24-528"><a href="#cb24-528" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [<span class="ss">f"feat_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(dim)]</span>
<span id="cb24-529"><a href="#cb24-529" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(features, columns<span class="op">=</span>feature_cols)</span>
<span id="cb24-530"><a href="#cb24-530" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"image_id"</span>] <span class="op">=</span> [p.stem <span class="cf">for</span> p <span class="kw">in</span> image_paths]</span>
<span id="cb24-531"><a href="#cb24-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-532"><a href="#cb24-532" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb24-533"><a href="#cb24-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-534"><a href="#cb24-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-535"><a href="#cb24-535" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_economic_activity(features_df, labels_df, label_col,</span>
<span id="cb24-536"><a href="#cb24-536" aria-hidden="true" tabindex="-1"></a>                              n_components<span class="op">=</span><span class="dv">50</span>):</span>
<span id="cb24-537"><a href="#cb24-537" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-538"><a href="#cb24-538" aria-hidden="true" tabindex="-1"></a><span class="co">    Predict economic activity from satellite image features.</span></span>
<span id="cb24-539"><a href="#cb24-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-540"><a href="#cb24-540" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses PCA for dimensionality reduction, then ridge regression.</span></span>
<span id="cb24-541"><a href="#cb24-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-542"><a href="#cb24-542" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-543"><a href="#cb24-543" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-544"><a href="#cb24-544" aria-hidden="true" tabindex="-1"></a><span class="co">    features_df : DataFrame</span></span>
<span id="cb24-545"><a href="#cb24-545" aria-hidden="true" tabindex="-1"></a><span class="co">        CNN features with image_id.</span></span>
<span id="cb24-546"><a href="#cb24-546" aria-hidden="true" tabindex="-1"></a><span class="co">    labels_df : DataFrame</span></span>
<span id="cb24-547"><a href="#cb24-547" aria-hidden="true" tabindex="-1"></a><span class="co">        Economic outcomes with image_id.</span></span>
<span id="cb24-548"><a href="#cb24-548" aria-hidden="true" tabindex="-1"></a><span class="co">    label_col : str</span></span>
<span id="cb24-549"><a href="#cb24-549" aria-hidden="true" tabindex="-1"></a><span class="co">        Target variable column name.</span></span>
<span id="cb24-550"><a href="#cb24-550" aria-hidden="true" tabindex="-1"></a><span class="co">    n_components : int</span></span>
<span id="cb24-551"><a href="#cb24-551" aria-hidden="true" tabindex="-1"></a><span class="co">        PCA components to retain.</span></span>
<span id="cb24-552"><a href="#cb24-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-553"><a href="#cb24-553" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-554"><a href="#cb24-554" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-555"><a href="#cb24-555" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : R², coefficients, cross-validated performance.</span></span>
<span id="cb24-556"><a href="#cb24-556" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-557"><a href="#cb24-557" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.decomposition <span class="im">import</span> PCA</span>
<span id="cb24-558"><a href="#cb24-558" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.linear_model <span class="im">import</span> RidgeCV</span>
<span id="cb24-559"><a href="#cb24-559" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> cross_val_score</span>
<span id="cb24-560"><a href="#cb24-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-561"><a href="#cb24-561" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> features_df.merge(labels_df, on<span class="op">=</span><span class="st">"image_id"</span>)</span>
<span id="cb24-562"><a href="#cb24-562" aria-hidden="true" tabindex="-1"></a>    feature_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> features_df.columns <span class="cf">if</span> c.startswith(<span class="st">"feat_"</span>)]</span>
<span id="cb24-563"><a href="#cb24-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-564"><a href="#cb24-564" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> merged[feature_cols].values</span>
<span id="cb24-565"><a href="#cb24-565" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> merged[label_col].values</span>
<span id="cb24-566"><a href="#cb24-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-567"><a href="#cb24-567" aria-hidden="true" tabindex="-1"></a>    <span class="co"># PCA</span></span>
<span id="cb24-568"><a href="#cb24-568" aria-hidden="true" tabindex="-1"></a>    pca <span class="op">=</span> PCA(n_components<span class="op">=</span>n_components)</span>
<span id="cb24-569"><a href="#cb24-569" aria-hidden="true" tabindex="-1"></a>    X_pca <span class="op">=</span> pca.fit_transform(X)</span>
<span id="cb24-570"><a href="#cb24-570" aria-hidden="true" tabindex="-1"></a>    var_explained <span class="op">=</span> pca.explained_variance_ratio_.<span class="bu">sum</span>()</span>
<span id="cb24-571"><a href="#cb24-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-572"><a href="#cb24-572" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ridge regression with cross-validation</span></span>
<span id="cb24-573"><a href="#cb24-573" aria-hidden="true" tabindex="-1"></a>    ridge <span class="op">=</span> RidgeCV(alphas<span class="op">=</span>np.logspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">20</span>), cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb24-574"><a href="#cb24-574" aria-hidden="true" tabindex="-1"></a>    cv_scores <span class="op">=</span> cross_val_score(ridge, X_pca, y, cv<span class="op">=</span><span class="dv">5</span>, scoring<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb24-575"><a href="#cb24-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-576"><a href="#cb24-576" aria-hidden="true" tabindex="-1"></a>    ridge.fit(X_pca, y)</span>
<span id="cb24-577"><a href="#cb24-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-578"><a href="#cb24-578" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-579"><a href="#cb24-579" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_cv_mean"</span>: cv_scores.mean(),</span>
<span id="cb24-580"><a href="#cb24-580" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_cv_std"</span>: cv_scores.std(),</span>
<span id="cb24-581"><a href="#cb24-581" aria-hidden="true" tabindex="-1"></a>        <span class="st">"r2_train"</span>: ridge.score(X_pca, y),</span>
<span id="cb24-582"><a href="#cb24-582" aria-hidden="true" tabindex="-1"></a>        <span class="st">"pca_var_explained"</span>: var_explained,</span>
<span id="cb24-583"><a href="#cb24-583" aria-hidden="true" tabindex="-1"></a>        <span class="st">"optimal_alpha"</span>: ridge.alpha_,</span>
<span id="cb24-584"><a href="#cb24-584" aria-hidden="true" tabindex="-1"></a>        <span class="st">"n_images"</span>: <span class="bu">len</span>(merged)</span>
<span id="cb24-585"><a href="#cb24-585" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-586"><a href="#cb24-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-587"><a href="#cb24-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-588"><a href="#cb24-588" aria-hidden="true" tabindex="-1"></a><span class="fu">## Document Image Analysis</span></span>
<span id="cb24-589"><a href="#cb24-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-590"><a href="#cb24-590" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Vietnamese Filing Problem</span></span>
<span id="cb24-591"><a href="#cb24-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-592"><a href="#cb24-592" aria-hidden="true" tabindex="-1"></a>A substantial fraction of Vietnamese corporate disclosures (e.g., annual reports, financial statements, board resolutions, shareholder meeting minutes) are distributed as scanned PDF images rather than machine-readable text. This creates a data extraction bottleneck: the information exists but is trapped in pixel format. Unlike filings in more developed markets (where XBRL mandates ensure machine readability), Vietnamese filings require Optical Character Recognition (OCR) and layout analysis before any quantitative analysis can begin.</span>
<span id="cb24-593"><a href="#cb24-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-594"><a href="#cb24-594" aria-hidden="true" tabindex="-1"></a>The document AI pipeline for Vietnamese financial filings involves four stages:</span>
<span id="cb24-595"><a href="#cb24-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-596"><a href="#cb24-596" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Page classification**: Identify which pages contain financial statements, management discussion, audit opinions, etc.</span>
<span id="cb24-597"><a href="#cb24-597" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Layout analysis**: Detect the spatial structure such as headers, paragraphs, tables, figures, captions.</span>
<span id="cb24-598"><a href="#cb24-598" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**OCR**: Convert image regions to text, using Vietnamese-optimized models.</span>
<span id="cb24-599"><a href="#cb24-599" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Structured extraction**: Parse the recognized text into structured data (e.g., revenue figures, balance sheet items).</span>
<span id="cb24-600"><a href="#cb24-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-601"><a href="#cb24-601" aria-hidden="true" tabindex="-1"></a><span class="fu">### OCR for Vietnamese Financial Documents</span></span>
<span id="cb24-602"><a href="#cb24-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-603"><a href="#cb24-603" aria-hidden="true" tabindex="-1"></a>Standard OCR engines (Tesseract, Google Cloud Vision) struggle with Vietnamese financial documents due to the combination of Vietnamese diacritics (ă, ơ, ư, ê, etc.), mixed Vietnamese-English content, and complex table layouts. We implement a pipeline using PaddleOCR (which has strong CJK and Southeast Asian language support) and VietOCR (a Vietnamese-specific model based on the transformer architecture of @baek2019wrong).</span>
<span id="cb24-604"><a href="#cb24-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-607"><a href="#cb24-607" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-608"><a href="#cb24-608" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ocr-pipeline</span></span>
<span id="cb24-609"><a href="#cb24-609" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-610"><a href="#cb24-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-611"><a href="#cb24-611" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ocr_financial_document(pdf_path, language<span class="op">=</span><span class="st">"vi"</span>,</span>
<span id="cb24-612"><a href="#cb24-612" aria-hidden="true" tabindex="-1"></a>                           engine<span class="op">=</span><span class="st">"paddleocr"</span>):</span>
<span id="cb24-613"><a href="#cb24-613" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-614"><a href="#cb24-614" aria-hidden="true" tabindex="-1"></a><span class="co">    OCR a Vietnamese financial document (scanned PDF).</span></span>
<span id="cb24-615"><a href="#cb24-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-616"><a href="#cb24-616" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-617"><a href="#cb24-617" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-618"><a href="#cb24-618" aria-hidden="true" tabindex="-1"></a><span class="co">    pdf_path : str</span></span>
<span id="cb24-619"><a href="#cb24-619" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to PDF file.</span></span>
<span id="cb24-620"><a href="#cb24-620" aria-hidden="true" tabindex="-1"></a><span class="co">    language : str</span></span>
<span id="cb24-621"><a href="#cb24-621" aria-hidden="true" tabindex="-1"></a><span class="co">        Language code.</span></span>
<span id="cb24-622"><a href="#cb24-622" aria-hidden="true" tabindex="-1"></a><span class="co">    engine : str</span></span>
<span id="cb24-623"><a href="#cb24-623" aria-hidden="true" tabindex="-1"></a><span class="co">        'paddleocr' or 'vietocr'.</span></span>
<span id="cb24-624"><a href="#cb24-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-625"><a href="#cb24-625" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-626"><a href="#cb24-626" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-627"><a href="#cb24-627" aria-hidden="true" tabindex="-1"></a><span class="co">    list[dict] : Per-page OCR results with bounding boxes.</span></span>
<span id="cb24-628"><a href="#cb24-628" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-629"><a href="#cb24-629" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> pdf2image <span class="im">import</span> convert_from_path</span>
<span id="cb24-630"><a href="#cb24-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-631"><a href="#cb24-631" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert PDF pages to images</span></span>
<span id="cb24-632"><a href="#cb24-632" aria-hidden="true" tabindex="-1"></a>    pages <span class="op">=</span> convert_from_path(pdf_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb24-633"><a href="#cb24-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-634"><a href="#cb24-634" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb24-635"><a href="#cb24-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-636"><a href="#cb24-636" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> engine <span class="op">==</span> <span class="st">"paddleocr"</span>:</span>
<span id="cb24-637"><a href="#cb24-637" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> paddleocr <span class="im">import</span> PaddleOCR</span>
<span id="cb24-638"><a href="#cb24-638" aria-hidden="true" tabindex="-1"></a>        ocr <span class="op">=</span> PaddleOCR(use_angle_cls<span class="op">=</span><span class="va">True</span>, lang<span class="op">=</span><span class="st">"vi"</span>, use_gpu<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-639"><a href="#cb24-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-640"><a href="#cb24-640" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> page_num, page_img <span class="kw">in</span> <span class="bu">enumerate</span>(pages):</span>
<span id="cb24-641"><a href="#cb24-641" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert PIL to numpy</span></span>
<span id="cb24-642"><a href="#cb24-642" aria-hidden="true" tabindex="-1"></a>            img_array <span class="op">=</span> np.array(page_img)</span>
<span id="cb24-643"><a href="#cb24-643" aria-hidden="true" tabindex="-1"></a>            ocr_result <span class="op">=</span> ocr.ocr(img_array, cls<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-644"><a href="#cb24-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-645"><a href="#cb24-645" aria-hidden="true" tabindex="-1"></a>            page_texts <span class="op">=</span> []</span>
<span id="cb24-646"><a href="#cb24-646" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> line <span class="kw">in</span> ocr_result[<span class="dv">0</span>]:</span>
<span id="cb24-647"><a href="#cb24-647" aria-hidden="true" tabindex="-1"></a>                bbox, (text, confidence) <span class="op">=</span> line</span>
<span id="cb24-648"><a href="#cb24-648" aria-hidden="true" tabindex="-1"></a>                page_texts.append({</span>
<span id="cb24-649"><a href="#cb24-649" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text"</span>: text,</span>
<span id="cb24-650"><a href="#cb24-650" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"confidence"</span>: confidence,</span>
<span id="cb24-651"><a href="#cb24-651" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"bbox"</span>: bbox,</span>
<span id="cb24-652"><a href="#cb24-652" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"page"</span>: page_num <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb24-653"><a href="#cb24-653" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb24-654"><a href="#cb24-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-655"><a href="#cb24-655" aria-hidden="true" tabindex="-1"></a>            results.extend(page_texts)</span>
<span id="cb24-656"><a href="#cb24-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-657"><a href="#cb24-657" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb24-658"><a href="#cb24-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-659"><a href="#cb24-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-660"><a href="#cb24-660" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_page_type(ocr_results, page_num):</span>
<span id="cb24-661"><a href="#cb24-661" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-662"><a href="#cb24-662" aria-hidden="true" tabindex="-1"></a><span class="co">    Classify a document page by content type using keyword matching.</span></span>
<span id="cb24-663"><a href="#cb24-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-664"><a href="#cb24-664" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns one of: 'balance_sheet', 'income_statement',</span></span>
<span id="cb24-665"><a href="#cb24-665" aria-hidden="true" tabindex="-1"></a><span class="co">    'cash_flow', 'notes', 'audit', 'management', 'other'.</span></span>
<span id="cb24-666"><a href="#cb24-666" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-667"><a href="#cb24-667" aria-hidden="true" tabindex="-1"></a>    page_text <span class="op">=</span> <span class="st">" "</span>.join(</span>
<span id="cb24-668"><a href="#cb24-668" aria-hidden="true" tabindex="-1"></a>        [r[<span class="st">"text"</span>] <span class="cf">for</span> r <span class="kw">in</span> ocr_results <span class="cf">if</span> r[<span class="st">"page"</span>] <span class="op">==</span> page_num]</span>
<span id="cb24-669"><a href="#cb24-669" aria-hidden="true" tabindex="-1"></a>    ).lower()</span>
<span id="cb24-670"><a href="#cb24-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-671"><a href="#cb24-671" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Vietnamese financial statement keywords</span></span>
<span id="cb24-672"><a href="#cb24-672" aria-hidden="true" tabindex="-1"></a>    keyword_map <span class="op">=</span> {</span>
<span id="cb24-673"><a href="#cb24-673" aria-hidden="true" tabindex="-1"></a>        <span class="st">"balance_sheet"</span>: [</span>
<span id="cb24-674"><a href="#cb24-674" aria-hidden="true" tabindex="-1"></a>            <span class="st">"bảng cân đối kế toán"</span>, <span class="st">"tài sản"</span>, <span class="st">"nguồn vốn"</span>,</span>
<span id="cb24-675"><a href="#cb24-675" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nợ phải trả"</span>, <span class="st">"vốn chủ sở hữu"</span></span>
<span id="cb24-676"><a href="#cb24-676" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb24-677"><a href="#cb24-677" aria-hidden="true" tabindex="-1"></a>        <span class="st">"income_statement"</span>: [</span>
<span id="cb24-678"><a href="#cb24-678" aria-hidden="true" tabindex="-1"></a>            <span class="st">"kết quả hoạt động kinh doanh"</span>, <span class="st">"doanh thu"</span>,</span>
<span id="cb24-679"><a href="#cb24-679" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lợi nhuận"</span>, <span class="st">"chi phí"</span>, <span class="st">"thu nhập"</span></span>
<span id="cb24-680"><a href="#cb24-680" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb24-681"><a href="#cb24-681" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cash_flow"</span>: [</span>
<span id="cb24-682"><a href="#cb24-682" aria-hidden="true" tabindex="-1"></a>            <span class="st">"lưu chuyển tiền tệ"</span>, <span class="st">"dòng tiền"</span>,</span>
<span id="cb24-683"><a href="#cb24-683" aria-hidden="true" tabindex="-1"></a>            <span class="st">"hoạt động kinh doanh"</span>, <span class="st">"hoạt động đầu tư"</span></span>
<span id="cb24-684"><a href="#cb24-684" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb24-685"><a href="#cb24-685" aria-hidden="true" tabindex="-1"></a>        <span class="st">"audit"</span>: [</span>
<span id="cb24-686"><a href="#cb24-686" aria-hidden="true" tabindex="-1"></a>            <span class="st">"báo cáo kiểm toán"</span>, <span class="st">"kiểm toán viên"</span>,</span>
<span id="cb24-687"><a href="#cb24-687" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ý kiến kiểm toán"</span>, <span class="st">"trung thực và hợp lý"</span></span>
<span id="cb24-688"><a href="#cb24-688" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb24-689"><a href="#cb24-689" aria-hidden="true" tabindex="-1"></a>        <span class="st">"management"</span>: [</span>
<span id="cb24-690"><a href="#cb24-690" aria-hidden="true" tabindex="-1"></a>            <span class="st">"ban giám đốc"</span>, <span class="st">"hội đồng quản trị"</span>,</span>
<span id="cb24-691"><a href="#cb24-691" aria-hidden="true" tabindex="-1"></a>            <span class="st">"báo cáo thường niên"</span>, <span class="st">"tình hình hoạt động"</span></span>
<span id="cb24-692"><a href="#cb24-692" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb24-693"><a href="#cb24-693" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-694"><a href="#cb24-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-695"><a href="#cb24-695" aria-hidden="true" tabindex="-1"></a>    scores <span class="op">=</span> {}</span>
<span id="cb24-696"><a href="#cb24-696" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> page_type, keywords <span class="kw">in</span> keyword_map.items():</span>
<span id="cb24-697"><a href="#cb24-697" aria-hidden="true" tabindex="-1"></a>        scores[page_type] <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb24-698"><a href="#cb24-698" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1</span> <span class="cf">for</span> kw <span class="kw">in</span> keywords <span class="cf">if</span> kw <span class="kw">in</span> page_text</span>
<span id="cb24-699"><a href="#cb24-699" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-700"><a href="#cb24-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-701"><a href="#cb24-701" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">max</span>(scores.values()) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb24-702"><a href="#cb24-702" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"other"</span></span>
<span id="cb24-703"><a href="#cb24-703" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">max</span>(scores, key<span class="op">=</span>scores.get)</span>
<span id="cb24-704"><a href="#cb24-704" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-705"><a href="#cb24-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-706"><a href="#cb24-706" aria-hidden="true" tabindex="-1"></a><span class="fu">### Table Extraction from Financial Statements</span></span>
<span id="cb24-707"><a href="#cb24-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-708"><a href="#cb24-708" aria-hidden="true" tabindex="-1"></a>The highest-value extraction task is recovering structured tables from financial statements. We implement a two-stage approach: first detect table regions using a layout analysis model, then parse the detected regions into row-column structure.</span>
<span id="cb24-709"><a href="#cb24-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-712"><a href="#cb24-712" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-713"><a href="#cb24-713" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: table-extraction</span></span>
<span id="cb24-714"><a href="#cb24-714" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-715"><a href="#cb24-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-716"><a href="#cb24-716" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extract_tables_from_page(page_image, ocr_results, page_num):</span>
<span id="cb24-717"><a href="#cb24-717" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-718"><a href="#cb24-718" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract structured tables from a document page.</span></span>
<span id="cb24-719"><a href="#cb24-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-720"><a href="#cb24-720" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses spatial clustering of OCR bounding boxes to identify</span></span>
<span id="cb24-721"><a href="#cb24-721" aria-hidden="true" tabindex="-1"></a><span class="co">    table regions, then aligns text into rows and columns.</span></span>
<span id="cb24-722"><a href="#cb24-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-723"><a href="#cb24-723" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-724"><a href="#cb24-724" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-725"><a href="#cb24-725" aria-hidden="true" tabindex="-1"></a><span class="co">    page_image : PIL.Image</span></span>
<span id="cb24-726"><a href="#cb24-726" aria-hidden="true" tabindex="-1"></a><span class="co">        Page image.</span></span>
<span id="cb24-727"><a href="#cb24-727" aria-hidden="true" tabindex="-1"></a><span class="co">    ocr_results : list[dict]</span></span>
<span id="cb24-728"><a href="#cb24-728" aria-hidden="true" tabindex="-1"></a><span class="co">        OCR results for this page.</span></span>
<span id="cb24-729"><a href="#cb24-729" aria-hidden="true" tabindex="-1"></a><span class="co">    page_num : int</span></span>
<span id="cb24-730"><a href="#cb24-730" aria-hidden="true" tabindex="-1"></a><span class="co">        Page number.</span></span>
<span id="cb24-731"><a href="#cb24-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-732"><a href="#cb24-732" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-733"><a href="#cb24-733" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-734"><a href="#cb24-734" aria-hidden="true" tabindex="-1"></a><span class="co">    list[pd.DataFrame] : Extracted tables as DataFrames.</span></span>
<span id="cb24-735"><a href="#cb24-735" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-736"><a href="#cb24-736" aria-hidden="true" tabindex="-1"></a>    page_texts <span class="op">=</span> [r <span class="cf">for</span> r <span class="kw">in</span> ocr_results <span class="cf">if</span> r[<span class="st">"page"</span>] <span class="op">==</span> page_num]</span>
<span id="cb24-737"><a href="#cb24-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-738"><a href="#cb24-738" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> page_texts:</span>
<span id="cb24-739"><a href="#cb24-739" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb24-740"><a href="#cb24-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-741"><a href="#cb24-741" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract bounding box centers</span></span>
<span id="cb24-742"><a href="#cb24-742" aria-hidden="true" tabindex="-1"></a>    centers <span class="op">=</span> []</span>
<span id="cb24-743"><a href="#cb24-743" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> item <span class="kw">in</span> page_texts:</span>
<span id="cb24-744"><a href="#cb24-744" aria-hidden="true" tabindex="-1"></a>        bbox <span class="op">=</span> item[<span class="st">"bbox"</span>]</span>
<span id="cb24-745"><a href="#cb24-745" aria-hidden="true" tabindex="-1"></a>        <span class="co"># bbox is [[x1,y1],[x2,y2],[x3,y3],[x4,y4]]</span></span>
<span id="cb24-746"><a href="#cb24-746" aria-hidden="true" tabindex="-1"></a>        cx <span class="op">=</span> np.mean([p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox])</span>
<span id="cb24-747"><a href="#cb24-747" aria-hidden="true" tabindex="-1"></a>        cy <span class="op">=</span> np.mean([p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox])</span>
<span id="cb24-748"><a href="#cb24-748" aria-hidden="true" tabindex="-1"></a>        centers.append((cx, cy, item[<span class="st">"text"</span>]))</span>
<span id="cb24-749"><a href="#cb24-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-750"><a href="#cb24-750" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> centers:</span>
<span id="cb24-751"><a href="#cb24-751" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> []</span>
<span id="cb24-752"><a href="#cb24-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-753"><a href="#cb24-753" aria-hidden="true" tabindex="-1"></a>    centers_df <span class="op">=</span> pd.DataFrame(centers, columns<span class="op">=</span>[<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"text"</span>])</span>
<span id="cb24-754"><a href="#cb24-754" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-755"><a href="#cb24-755" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cluster into rows by y-coordinate proximity</span></span>
<span id="cb24-756"><a href="#cb24-756" aria-hidden="true" tabindex="-1"></a>    centers_df <span class="op">=</span> centers_df.sort_values(<span class="st">"y"</span>)</span>
<span id="cb24-757"><a href="#cb24-757" aria-hidden="true" tabindex="-1"></a>    row_threshold <span class="op">=</span> <span class="dv">15</span>  <span class="co"># pixels</span></span>
<span id="cb24-758"><a href="#cb24-758" aria-hidden="true" tabindex="-1"></a>    centers_df[<span class="st">"row_id"</span>] <span class="op">=</span> (</span>
<span id="cb24-759"><a href="#cb24-759" aria-hidden="true" tabindex="-1"></a>        centers_df[<span class="st">"y"</span>].diff().<span class="bu">abs</span>() <span class="op">&gt;</span> row_threshold</span>
<span id="cb24-760"><a href="#cb24-760" aria-hidden="true" tabindex="-1"></a>    ).cumsum()</span>
<span id="cb24-761"><a href="#cb24-761" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-762"><a href="#cb24-762" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Within each row, sort by x-coordinate</span></span>
<span id="cb24-763"><a href="#cb24-763" aria-hidden="true" tabindex="-1"></a>    tables <span class="op">=</span> []</span>
<span id="cb24-764"><a href="#cb24-764" aria-hidden="true" tabindex="-1"></a>    rows <span class="op">=</span> []</span>
<span id="cb24-765"><a href="#cb24-765" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> row_id, row_group <span class="kw">in</span> centers_df.groupby(<span class="st">"row_id"</span>):</span>
<span id="cb24-766"><a href="#cb24-766" aria-hidden="true" tabindex="-1"></a>        row_sorted <span class="op">=</span> row_group.sort_values(<span class="st">"x"</span>)</span>
<span id="cb24-767"><a href="#cb24-767" aria-hidden="true" tabindex="-1"></a>        rows.append(row_sorted[<span class="st">"text"</span>].tolist())</span>
<span id="cb24-768"><a href="#cb24-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-769"><a href="#cb24-769" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(rows) <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb24-770"><a href="#cb24-770" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attempt to construct DataFrame</span></span>
<span id="cb24-771"><a href="#cb24-771" aria-hidden="true" tabindex="-1"></a>        max_cols <span class="op">=</span> <span class="bu">max</span>(<span class="bu">len</span>(r) <span class="cf">for</span> r <span class="kw">in</span> rows)</span>
<span id="cb24-772"><a href="#cb24-772" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Pad shorter rows</span></span>
<span id="cb24-773"><a href="#cb24-773" aria-hidden="true" tabindex="-1"></a>        padded <span class="op">=</span> [r <span class="op">+</span> [<span class="st">""</span>] <span class="op">*</span> (max_cols <span class="op">-</span> <span class="bu">len</span>(r)) <span class="cf">for</span> r <span class="kw">in</span> rows]</span>
<span id="cb24-774"><a href="#cb24-774" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-775"><a href="#cb24-775" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb24-776"><a href="#cb24-776" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> pd.DataFrame(padded[<span class="dv">1</span>:], columns<span class="op">=</span>padded[<span class="dv">0</span>])</span>
<span id="cb24-777"><a href="#cb24-777" aria-hidden="true" tabindex="-1"></a>            tables.append(df)</span>
<span id="cb24-778"><a href="#cb24-778" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb24-779"><a href="#cb24-779" aria-hidden="true" tabindex="-1"></a>            tables.append(pd.DataFrame(padded))</span>
<span id="cb24-780"><a href="#cb24-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-781"><a href="#cb24-781" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tables</span>
<span id="cb24-782"><a href="#cb24-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-783"><a href="#cb24-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-784"><a href="#cb24-784" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_financial_numbers(text):</span>
<span id="cb24-785"><a href="#cb24-785" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-786"><a href="#cb24-786" aria-hidden="true" tabindex="-1"></a><span class="co">    Parse Vietnamese financial number formats.</span></span>
<span id="cb24-787"><a href="#cb24-787" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese uses dots as thousands separators and commas as decimals.</span></span>
<span id="cb24-788"><a href="#cb24-788" aria-hidden="true" tabindex="-1"></a><span class="co">    E.g., '1.234.567' = 1234567, '1.234,56' = 1234.56</span></span>
<span id="cb24-789"><a href="#cb24-789" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-790"><a href="#cb24-790" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> re</span>
<span id="cb24-791"><a href="#cb24-791" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip().replace(<span class="st">" "</span>, <span class="st">""</span>)</span>
<span id="cb24-792"><a href="#cb24-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-793"><a href="#cb24-793" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove parentheses (negative indicator)</span></span>
<span id="cb24-794"><a href="#cb24-794" aria-hidden="true" tabindex="-1"></a>    negative <span class="op">=</span> text.startswith(<span class="st">"("</span>) <span class="kw">and</span> text.endswith(<span class="st">")"</span>)</span>
<span id="cb24-795"><a href="#cb24-795" aria-hidden="true" tabindex="-1"></a>    text <span class="op">=</span> text.strip(<span class="st">"()"</span>)</span>
<span id="cb24-796"><a href="#cb24-796" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-797"><a href="#cb24-797" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Handle Vietnamese number format</span></span>
<span id="cb24-798"><a href="#cb24-798" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If comma is present, it's a decimal separator</span></span>
<span id="cb24-799"><a href="#cb24-799" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">","</span> <span class="kw">in</span> text:</span>
<span id="cb24-800"><a href="#cb24-800" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.replace(<span class="st">"."</span>, <span class="st">""</span>).replace(<span class="st">","</span>, <span class="st">"."</span>)</span>
<span id="cb24-801"><a href="#cb24-801" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-802"><a href="#cb24-802" aria-hidden="true" tabindex="-1"></a>        text <span class="op">=</span> text.replace(<span class="st">"."</span>, <span class="st">""</span>)</span>
<span id="cb24-803"><a href="#cb24-803" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-804"><a href="#cb24-804" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb24-805"><a href="#cb24-805" aria-hidden="true" tabindex="-1"></a>        value <span class="op">=</span> <span class="bu">float</span>(text)</span>
<span id="cb24-806"><a href="#cb24-806" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span>value <span class="cf">if</span> negative <span class="cf">else</span> value</span>
<span id="cb24-807"><a href="#cb24-807" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb24-808"><a href="#cb24-808" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.nan</span>
<span id="cb24-809"><a href="#cb24-809" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-810"><a href="#cb24-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-811"><a href="#cb24-811" aria-hidden="true" tabindex="-1"></a><span class="fu">### Layout-Aware Document Understanding</span></span>
<span id="cb24-812"><a href="#cb24-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-813"><a href="#cb24-813" aria-hidden="true" tabindex="-1"></a>Modern document AI goes beyond OCR by jointly modeling text content and spatial layout. LayoutLM <span class="co">[</span><span class="ot">@huang2022layoutlmv3</span><span class="co">]</span> and its successors treat each token as having both a text embedding and a positional embedding derived from its bounding box coordinates. This allows the model to understand that a number positioned below a "Revenue" header and to the right of "2023" is the 2023 revenue figure, even without explicit table detection.</span>
<span id="cb24-814"><a href="#cb24-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-817"><a href="#cb24-817" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-818"><a href="#cb24-818" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: layoutlm-extraction</span></span>
<span id="cb24-819"><a href="#cb24-819" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-820"><a href="#cb24-820" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-821"><a href="#cb24-821" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> layoutlm_extract(document_pages, model_name<span class="op">=</span><span class="st">"layoutlmv3"</span>):</span>
<span id="cb24-822"><a href="#cb24-822" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-823"><a href="#cb24-823" aria-hidden="true" tabindex="-1"></a><span class="co">    Extract structured financial data using LayoutLM.</span></span>
<span id="cb24-824"><a href="#cb24-824" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-825"><a href="#cb24-825" aria-hidden="true" tabindex="-1"></a><span class="co">    This function uses the pre-trained LayoutLMv3 model for</span></span>
<span id="cb24-826"><a href="#cb24-826" aria-hidden="true" tabindex="-1"></a><span class="co">    document understanding with Vietnamese financial statements.</span></span>
<span id="cb24-827"><a href="#cb24-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-828"><a href="#cb24-828" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-829"><a href="#cb24-829" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-830"><a href="#cb24-830" aria-hidden="true" tabindex="-1"></a><span class="co">    document_pages : list</span></span>
<span id="cb24-831"><a href="#cb24-831" aria-hidden="true" tabindex="-1"></a><span class="co">        List of (page_image, ocr_results) tuples.</span></span>
<span id="cb24-832"><a href="#cb24-832" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb24-833"><a href="#cb24-833" aria-hidden="true" tabindex="-1"></a><span class="co">        Model variant.</span></span>
<span id="cb24-834"><a href="#cb24-834" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-835"><a href="#cb24-835" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-836"><a href="#cb24-836" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-837"><a href="#cb24-837" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Extracted financial fields.</span></span>
<span id="cb24-838"><a href="#cb24-838" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-839"><a href="#cb24-839" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> transformers <span class="im">import</span> (</span>
<span id="cb24-840"><a href="#cb24-840" aria-hidden="true" tabindex="-1"></a>        LayoutLMv3ForTokenClassification,</span>
<span id="cb24-841"><a href="#cb24-841" aria-hidden="true" tabindex="-1"></a>        LayoutLMv3Processor</span>
<span id="cb24-842"><a href="#cb24-842" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-843"><a href="#cb24-843" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-844"><a href="#cb24-844" aria-hidden="true" tabindex="-1"></a>    processor <span class="op">=</span> LayoutLMv3Processor.from_pretrained(</span>
<span id="cb24-845"><a href="#cb24-845" aria-hidden="true" tabindex="-1"></a>        <span class="st">"microsoft/layoutlmv3-base"</span>,</span>
<span id="cb24-846"><a href="#cb24-846" aria-hidden="true" tabindex="-1"></a>        apply_ocr<span class="op">=</span><span class="va">False</span>  <span class="co"># We provide our own OCR</span></span>
<span id="cb24-847"><a href="#cb24-847" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-848"><a href="#cb24-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-849"><a href="#cb24-849" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LayoutLMv3ForTokenClassification.from_pretrained(</span>
<span id="cb24-850"><a href="#cb24-850" aria-hidden="true" tabindex="-1"></a>        <span class="st">"microsoft/layoutlmv3-base"</span>,</span>
<span id="cb24-851"><a href="#cb24-851" aria-hidden="true" tabindex="-1"></a>        num_labels<span class="op">=</span><span class="dv">13</span>  <span class="co"># Financial statement field types</span></span>
<span id="cb24-852"><a href="#cb24-852" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-853"><a href="#cb24-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-854"><a href="#cb24-854" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define target fields for extraction</span></span>
<span id="cb24-855"><a href="#cb24-855" aria-hidden="true" tabindex="-1"></a>    field_labels <span class="op">=</span> [</span>
<span id="cb24-856"><a href="#cb24-856" aria-hidden="true" tabindex="-1"></a>        <span class="st">"O"</span>,  <span class="co"># Other</span></span>
<span id="cb24-857"><a href="#cb24-857" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-REVENUE"</span>, <span class="st">"I-REVENUE"</span>,</span>
<span id="cb24-858"><a href="#cb24-858" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-COGS"</span>, <span class="st">"I-COGS"</span>,</span>
<span id="cb24-859"><a href="#cb24-859" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-NET_INCOME"</span>, <span class="st">"I-NET_INCOME"</span>,</span>
<span id="cb24-860"><a href="#cb24-860" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_ASSETS"</span>, <span class="st">"I-TOTAL_ASSETS"</span>,</span>
<span id="cb24-861"><a href="#cb24-861" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_EQUITY"</span>, <span class="st">"I-TOTAL_EQUITY"</span>,</span>
<span id="cb24-862"><a href="#cb24-862" aria-hidden="true" tabindex="-1"></a>        <span class="st">"B-TOTAL_DEBT"</span>, <span class="st">"I-TOTAL_DEBT"</span></span>
<span id="cb24-863"><a href="#cb24-863" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb24-864"><a href="#cb24-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-865"><a href="#cb24-865" aria-hidden="true" tabindex="-1"></a>    extracted <span class="op">=</span> {}</span>
<span id="cb24-866"><a href="#cb24-866" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-867"><a href="#cb24-867" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> page_img, ocr_results <span class="kw">in</span> document_pages:</span>
<span id="cb24-868"><a href="#cb24-868" aria-hidden="true" tabindex="-1"></a>        words <span class="op">=</span> [r[<span class="st">"text"</span>] <span class="cf">for</span> r <span class="kw">in</span> ocr_results]</span>
<span id="cb24-869"><a href="#cb24-869" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> []</span>
<span id="cb24-870"><a href="#cb24-870" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> ocr_results:</span>
<span id="cb24-871"><a href="#cb24-871" aria-hidden="true" tabindex="-1"></a>            bbox <span class="op">=</span> r[<span class="st">"bbox"</span>]</span>
<span id="cb24-872"><a href="#cb24-872" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Normalize to 0-1000 range</span></span>
<span id="cb24-873"><a href="#cb24-873" aria-hidden="true" tabindex="-1"></a>            x0 <span class="op">=</span> <span class="bu">min</span>(p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb24-874"><a href="#cb24-874" aria-hidden="true" tabindex="-1"></a>            y0 <span class="op">=</span> <span class="bu">min</span>(p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb24-875"><a href="#cb24-875" aria-hidden="true" tabindex="-1"></a>            x1 <span class="op">=</span> <span class="bu">max</span>(p[<span class="dv">0</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb24-876"><a href="#cb24-876" aria-hidden="true" tabindex="-1"></a>            y1 <span class="op">=</span> <span class="bu">max</span>(p[<span class="dv">1</span>] <span class="cf">for</span> p <span class="kw">in</span> bbox)</span>
<span id="cb24-877"><a href="#cb24-877" aria-hidden="true" tabindex="-1"></a>            boxes.append([<span class="bu">int</span>(x0), <span class="bu">int</span>(y0), <span class="bu">int</span>(x1), <span class="bu">int</span>(y1)])</span>
<span id="cb24-878"><a href="#cb24-878" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-879"><a href="#cb24-879" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> words:</span>
<span id="cb24-880"><a href="#cb24-880" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb24-881"><a href="#cb24-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-882"><a href="#cb24-882" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Process through LayoutLM</span></span>
<span id="cb24-883"><a href="#cb24-883" aria-hidden="true" tabindex="-1"></a>        encoding <span class="op">=</span> processor(</span>
<span id="cb24-884"><a href="#cb24-884" aria-hidden="true" tabindex="-1"></a>            page_img,</span>
<span id="cb24-885"><a href="#cb24-885" aria-hidden="true" tabindex="-1"></a>            words,</span>
<span id="cb24-886"><a href="#cb24-886" aria-hidden="true" tabindex="-1"></a>            boxes<span class="op">=</span>boxes,</span>
<span id="cb24-887"><a href="#cb24-887" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb24-888"><a href="#cb24-888" aria-hidden="true" tabindex="-1"></a>            truncation<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-889"><a href="#cb24-889" aria-hidden="true" tabindex="-1"></a>            max_length<span class="op">=</span><span class="dv">512</span></span>
<span id="cb24-890"><a href="#cb24-890" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-891"><a href="#cb24-891" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-892"><a href="#cb24-892" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-893"><a href="#cb24-893" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> model(<span class="op">**</span>encoding)</span>
<span id="cb24-894"><a href="#cb24-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-895"><a href="#cb24-895" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> outputs.logits.argmax(<span class="op">-</span><span class="dv">1</span>).squeeze().tolist()</span>
<span id="cb24-896"><a href="#cb24-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-897"><a href="#cb24-897" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract labeled entities</span></span>
<span id="cb24-898"><a href="#cb24-898" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx, pred <span class="kw">in</span> <span class="bu">enumerate</span>(predictions):</span>
<span id="cb24-899"><a href="#cb24-899" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> pred <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> idx <span class="op">&lt;</span> <span class="bu">len</span>(words):</span>
<span id="cb24-900"><a href="#cb24-900" aria-hidden="true" tabindex="-1"></a>                label <span class="op">=</span> field_labels[pred]</span>
<span id="cb24-901"><a href="#cb24-901" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> label.startswith(<span class="st">"B-"</span>):</span>
<span id="cb24-902"><a href="#cb24-902" aria-hidden="true" tabindex="-1"></a>                    field <span class="op">=</span> label[<span class="dv">2</span>:]</span>
<span id="cb24-903"><a href="#cb24-903" aria-hidden="true" tabindex="-1"></a>                    value <span class="op">=</span> parse_financial_numbers(words[idx])</span>
<span id="cb24-904"><a href="#cb24-904" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">not</span> np.isnan(value):</span>
<span id="cb24-905"><a href="#cb24-905" aria-hidden="true" tabindex="-1"></a>                        extracted[field] <span class="op">=</span> value</span>
<span id="cb24-906"><a href="#cb24-906" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-907"><a href="#cb24-907" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> extracted</span>
<span id="cb24-908"><a href="#cb24-908" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-909"><a href="#cb24-909" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-910"><a href="#cb24-910" aria-hidden="true" tabindex="-1"></a><span class="fu">## Chart and Figure Digitization</span></span>
<span id="cb24-911"><a href="#cb24-911" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-912"><a href="#cb24-912" aria-hidden="true" tabindex="-1"></a><span class="fu">### Motivation: Unlocking Visual Financial Data</span></span>
<span id="cb24-913"><a href="#cb24-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-914"><a href="#cb24-914" aria-hidden="true" tabindex="-1"></a>Financial charts (e.g., price time series, bar charts of earnings, scatter plots of risk-return tradeoffs) embed information that analysts process visually. For systematic strategies, this information must be converted to numerical form. Three use cases motivate chart digitization:</span>
<span id="cb24-915"><a href="#cb24-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-916"><a href="#cb24-916" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Historical data recovery.** Pre-digital financial data often exists only in printed charts. Digitizing these charts extends historical time series beyond the electronic era.</span>
<span id="cb24-917"><a href="#cb24-917" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Broker report extraction.** Sell-side research reports contain charts with projections and scenario analyses. Extracting these programmatically enables systematic aggregation of analyst views.</span>
<span id="cb24-918"><a href="#cb24-918" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Regulatory filings.** Vietnamese regulatory filings sometimes embed data as images (charts, scanned tables) rather than as machine-readable values.</span>
<span id="cb24-919"><a href="#cb24-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-920"><a href="#cb24-920" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chart Type Classification</span></span>
<span id="cb24-921"><a href="#cb24-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-922"><a href="#cb24-922" aria-hidden="true" tabindex="-1"></a>The first step is classifying the chart type (line, bar, scatter, pie, candlestick), which determines the appropriate digitization algorithm.</span>
<span id="cb24-923"><a href="#cb24-923" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-926"><a href="#cb24-926" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-927"><a href="#cb24-927" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: chart-classification</span></span>
<span id="cb24-928"><a href="#cb24-928" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-929"><a href="#cb24-929" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-930"><a href="#cb24-930" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> build_chart_classifier(n_classes<span class="op">=</span><span class="dv">5</span>):</span>
<span id="cb24-931"><a href="#cb24-931" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-932"><a href="#cb24-932" aria-hidden="true" tabindex="-1"></a><span class="co">    Build a CNN-based chart type classifier.</span></span>
<span id="cb24-933"><a href="#cb24-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-934"><a href="#cb24-934" aria-hidden="true" tabindex="-1"></a><span class="co">    Classes: line_chart, bar_chart, scatter_plot,</span></span>
<span id="cb24-935"><a href="#cb24-935" aria-hidden="true" tabindex="-1"></a><span class="co">             candlestick, pie_chart.</span></span>
<span id="cb24-936"><a href="#cb24-936" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-937"><a href="#cb24-937" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> models.resnet18(weights<span class="op">=</span>models.ResNet18_Weights.IMAGENET1K_V1)</span>
<span id="cb24-938"><a href="#cb24-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-939"><a href="#cb24-939" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace final layer for chart classification</span></span>
<span id="cb24-940"><a href="#cb24-940" aria-hidden="true" tabindex="-1"></a>    model.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-941"><a href="#cb24-941" aria-hidden="true" tabindex="-1"></a>        nn.Dropout(<span class="fl">0.3</span>),</span>
<span id="cb24-942"><a href="#cb24-942" aria-hidden="true" tabindex="-1"></a>        nn.Linear(<span class="dv">512</span>, n_classes)</span>
<span id="cb24-943"><a href="#cb24-943" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-944"><a href="#cb24-944" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-945"><a href="#cb24-945" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> model</span>
<span id="cb24-946"><a href="#cb24-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-947"><a href="#cb24-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-948"><a href="#cb24-948" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classify_chart(image_path, model, transform):</span>
<span id="cb24-949"><a href="#cb24-949" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Classify a chart image into one of 5 types."""</span></span>
<span id="cb24-950"><a href="#cb24-950" aria-hidden="true" tabindex="-1"></a>    class_names <span class="op">=</span> [</span>
<span id="cb24-951"><a href="#cb24-951" aria-hidden="true" tabindex="-1"></a>        <span class="st">"line_chart"</span>, <span class="st">"bar_chart"</span>, <span class="st">"scatter_plot"</span>,</span>
<span id="cb24-952"><a href="#cb24-952" aria-hidden="true" tabindex="-1"></a>        <span class="st">"candlestick"</span>, <span class="st">"pie_chart"</span></span>
<span id="cb24-953"><a href="#cb24-953" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb24-954"><a href="#cb24-954" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-955"><a href="#cb24-955" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb24-956"><a href="#cb24-956" aria-hidden="true" tabindex="-1"></a>    tensor <span class="op">=</span> transform(img).unsqueeze(<span class="dv">0</span>)</span>
<span id="cb24-957"><a href="#cb24-957" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-958"><a href="#cb24-958" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-959"><a href="#cb24-959" aria-hidden="true" tabindex="-1"></a>        logits <span class="op">=</span> model(tensor)</span>
<span id="cb24-960"><a href="#cb24-960" aria-hidden="true" tabindex="-1"></a>        probs <span class="op">=</span> torch.softmax(logits, dim<span class="op">=</span><span class="dv">1</span>).squeeze()</span>
<span id="cb24-961"><a href="#cb24-961" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-962"><a href="#cb24-962" aria-hidden="true" tabindex="-1"></a>    pred_idx <span class="op">=</span> probs.argmax().item()</span>
<span id="cb24-963"><a href="#cb24-963" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb24-964"><a href="#cb24-964" aria-hidden="true" tabindex="-1"></a>        <span class="st">"predicted_class"</span>: class_names[pred_idx],</span>
<span id="cb24-965"><a href="#cb24-965" aria-hidden="true" tabindex="-1"></a>        <span class="st">"confidence"</span>: probs[pred_idx].item(),</span>
<span id="cb24-966"><a href="#cb24-966" aria-hidden="true" tabindex="-1"></a>        <span class="st">"all_probs"</span>: {</span>
<span id="cb24-967"><a href="#cb24-967" aria-hidden="true" tabindex="-1"></a>            name: probs[i].item()</span>
<span id="cb24-968"><a href="#cb24-968" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i, name <span class="kw">in</span> <span class="bu">enumerate</span>(class_names)</span>
<span id="cb24-969"><a href="#cb24-969" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-970"><a href="#cb24-970" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb24-971"><a href="#cb24-971" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-972"><a href="#cb24-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-973"><a href="#cb24-973" aria-hidden="true" tabindex="-1"></a><span class="fu">### Line Chart Digitization</span></span>
<span id="cb24-974"><a href="#cb24-974" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-975"><a href="#cb24-975" aria-hidden="true" tabindex="-1"></a>For line charts, the digitization task is to recover the $(x, y)$ data series from the image. The pipeline involves axis detection, scale calibration, and curve tracing.</span>
<span id="cb24-976"><a href="#cb24-976" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-979"><a href="#cb24-979" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-980"><a href="#cb24-980" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: line-chart-digitizer</span></span>
<span id="cb24-981"><a href="#cb24-981" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-982"><a href="#cb24-982" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-983"><a href="#cb24-983" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> digitize_line_chart(image_path, x_range<span class="op">=</span><span class="va">None</span>, y_range<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-984"><a href="#cb24-984" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-985"><a href="#cb24-985" aria-hidden="true" tabindex="-1"></a><span class="co">    Digitize a line chart image to recover the data series.</span></span>
<span id="cb24-986"><a href="#cb24-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-987"><a href="#cb24-987" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-988"><a href="#cb24-988" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-989"><a href="#cb24-989" aria-hidden="true" tabindex="-1"></a><span class="co">    image_path : str</span></span>
<span id="cb24-990"><a href="#cb24-990" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to chart image.</span></span>
<span id="cb24-991"><a href="#cb24-991" aria-hidden="true" tabindex="-1"></a><span class="co">    x_range : tuple, optional</span></span>
<span id="cb24-992"><a href="#cb24-992" aria-hidden="true" tabindex="-1"></a><span class="co">        (x_min, x_max) if known.</span></span>
<span id="cb24-993"><a href="#cb24-993" aria-hidden="true" tabindex="-1"></a><span class="co">    y_range : tuple, optional</span></span>
<span id="cb24-994"><a href="#cb24-994" aria-hidden="true" tabindex="-1"></a><span class="co">        (y_min, y_max) if known.</span></span>
<span id="cb24-995"><a href="#cb24-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-996"><a href="#cb24-996" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-997"><a href="#cb24-997" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-998"><a href="#cb24-998" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : Digitized data points (x, y).</span></span>
<span id="cb24-999"><a href="#cb24-999" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1000"><a href="#cb24-1000" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> cv2</span>
<span id="cb24-1001"><a href="#cb24-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1002"><a href="#cb24-1002" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> cv2.imread(<span class="bu">str</span>(image_path))</span>
<span id="cb24-1003"><a href="#cb24-1003" aria-hidden="true" tabindex="-1"></a>    gray <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)</span>
<span id="cb24-1004"><a href="#cb24-1004" aria-hidden="true" tabindex="-1"></a>    h, w <span class="op">=</span> gray.shape</span>
<span id="cb24-1005"><a href="#cb24-1005" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1006"><a href="#cb24-1006" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Detect plot area (largest rectangular region)</span></span>
<span id="cb24-1007"><a href="#cb24-1007" aria-hidden="true" tabindex="-1"></a>    edges <span class="op">=</span> cv2.Canny(gray, <span class="dv">50</span>, <span class="dv">150</span>)</span>
<span id="cb24-1008"><a href="#cb24-1008" aria-hidden="true" tabindex="-1"></a>    contours, _ <span class="op">=</span> cv2.findContours(</span>
<span id="cb24-1009"><a href="#cb24-1009" aria-hidden="true" tabindex="-1"></a>        edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE</span>
<span id="cb24-1010"><a href="#cb24-1010" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-1011"><a href="#cb24-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1012"><a href="#cb24-1012" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> contours:</span>
<span id="cb24-1013"><a href="#cb24-1013" aria-hidden="true" tabindex="-1"></a>        largest <span class="op">=</span> <span class="bu">max</span>(contours, key<span class="op">=</span>cv2.contourArea)</span>
<span id="cb24-1014"><a href="#cb24-1014" aria-hidden="true" tabindex="-1"></a>        x_start, y_start, plot_w, plot_h <span class="op">=</span> cv2.boundingRect(largest)</span>
<span id="cb24-1015"><a href="#cb24-1015" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb24-1016"><a href="#cb24-1016" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback: assume plot is central 80% of image</span></span>
<span id="cb24-1017"><a href="#cb24-1017" aria-hidden="true" tabindex="-1"></a>        x_start, y_start <span class="op">=</span> <span class="bu">int</span>(w <span class="op">*</span> <span class="fl">0.1</span>), <span class="bu">int</span>(h <span class="op">*</span> <span class="fl">0.1</span>)</span>
<span id="cb24-1018"><a href="#cb24-1018" aria-hidden="true" tabindex="-1"></a>        plot_w, plot_h <span class="op">=</span> <span class="bu">int</span>(w <span class="op">*</span> <span class="fl">0.8</span>), <span class="bu">int</span>(h <span class="op">*</span> <span class="fl">0.8</span>)</span>
<span id="cb24-1019"><a href="#cb24-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1020"><a href="#cb24-1020" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Extract line pixels within plot area</span></span>
<span id="cb24-1021"><a href="#cb24-1021" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to HSV and isolate colored lines</span></span>
<span id="cb24-1022"><a href="#cb24-1022" aria-hidden="true" tabindex="-1"></a>    hsv <span class="op">=</span> cv2.cvtColor(img, cv2.COLOR_BGR2HSV)</span>
<span id="cb24-1023"><a href="#cb24-1023" aria-hidden="true" tabindex="-1"></a>    plot_region <span class="op">=</span> hsv[y_start:y_start <span class="op">+</span> plot_h,</span>
<span id="cb24-1024"><a href="#cb24-1024" aria-hidden="true" tabindex="-1"></a>                      x_start:x_start <span class="op">+</span> plot_w]</span>
<span id="cb24-1025"><a href="#cb24-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1026"><a href="#cb24-1026" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Detect non-white, non-gray pixels (likely the line)</span></span>
<span id="cb24-1027"><a href="#cb24-1027" aria-hidden="true" tabindex="-1"></a>    saturation <span class="op">=</span> plot_region[:, :, <span class="dv">1</span>]</span>
<span id="cb24-1028"><a href="#cb24-1028" aria-hidden="true" tabindex="-1"></a>    line_mask <span class="op">=</span> saturation <span class="op">&gt;</span> <span class="dv">30</span>  <span class="co"># Colored pixels</span></span>
<span id="cb24-1029"><a href="#cb24-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1030"><a href="#cb24-1030" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Trace the line (column-wise median of colored pixels)</span></span>
<span id="cb24-1031"><a href="#cb24-1031" aria-hidden="true" tabindex="-1"></a>    data_points <span class="op">=</span> []</span>
<span id="cb24-1032"><a href="#cb24-1032" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> <span class="bu">range</span>(plot_w):</span>
<span id="cb24-1033"><a href="#cb24-1033" aria-hidden="true" tabindex="-1"></a>        col_pixels <span class="op">=</span> np.where(line_mask[:, col])[<span class="dv">0</span>]</span>
<span id="cb24-1034"><a href="#cb24-1034" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(col_pixels) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb24-1035"><a href="#cb24-1035" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use median y-position</span></span>
<span id="cb24-1036"><a href="#cb24-1036" aria-hidden="true" tabindex="-1"></a>            y_pixel <span class="op">=</span> np.median(col_pixels)</span>
<span id="cb24-1037"><a href="#cb24-1037" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1038"><a href="#cb24-1038" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert pixel to data coordinates</span></span>
<span id="cb24-1039"><a href="#cb24-1039" aria-hidden="true" tabindex="-1"></a>            x_frac <span class="op">=</span> col <span class="op">/</span> plot_w</span>
<span id="cb24-1040"><a href="#cb24-1040" aria-hidden="true" tabindex="-1"></a>            y_frac <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> y_pixel <span class="op">/</span> plot_h  <span class="co"># Invert y-axis</span></span>
<span id="cb24-1041"><a href="#cb24-1041" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1042"><a href="#cb24-1042" aria-hidden="true" tabindex="-1"></a>            x_val <span class="op">=</span> (x_range[<span class="dv">0</span>] <span class="op">+</span> x_frac <span class="op">*</span> (x_range[<span class="dv">1</span>] <span class="op">-</span> x_range[<span class="dv">0</span>])</span>
<span id="cb24-1043"><a href="#cb24-1043" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> x_range <span class="cf">else</span> x_frac)</span>
<span id="cb24-1044"><a href="#cb24-1044" aria-hidden="true" tabindex="-1"></a>            y_val <span class="op">=</span> (y_range[<span class="dv">0</span>] <span class="op">+</span> y_frac <span class="op">*</span> (y_range[<span class="dv">1</span>] <span class="op">-</span> y_range[<span class="dv">0</span>])</span>
<span id="cb24-1045"><a href="#cb24-1045" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">if</span> y_range <span class="cf">else</span> y_frac)</span>
<span id="cb24-1046"><a href="#cb24-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1047"><a href="#cb24-1047" aria-hidden="true" tabindex="-1"></a>            data_points.append({<span class="st">"x"</span>: x_val, <span class="st">"y"</span>: y_val})</span>
<span id="cb24-1048"><a href="#cb24-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1049"><a href="#cb24-1049" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(data_points)</span>
<span id="cb24-1050"><a href="#cb24-1050" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1051"><a href="#cb24-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1052"><a href="#cb24-1052" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visual Sentiment Analysis</span></span>
<span id="cb24-1053"><a href="#cb24-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1054"><a href="#cb24-1054" aria-hidden="true" tabindex="-1"></a><span class="fu">### Image Sentiment in Financial News</span></span>
<span id="cb24-1055"><a href="#cb24-1055" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1056"><a href="#cb24-1056" aria-hidden="true" tabindex="-1"></a>News articles are accompanied by images that carry sentiment independent of the text. A photograph of a CEO smiling at a press conference conveys different information than the same CEO facing protesters. @obaid2022picture demonstrate that the visual sentiment of Wall Street Journal photographs predicts market returns: days with more negative imagery precede lower returns.</span>
<span id="cb24-1057"><a href="#cb24-1057" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1058"><a href="#cb24-1058" aria-hidden="true" tabindex="-1"></a>We implement visual sentiment analysis using two approaches: a pre-trained sentiment classifier and a vision-language model that interprets images in financial context.</span>
<span id="cb24-1059"><a href="#cb24-1059" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1060"><a href="#cb24-1060" aria-hidden="true" tabindex="-1"></a><span class="fu">### CNN-Based Visual Sentiment</span></span>
<span id="cb24-1061"><a href="#cb24-1061" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1064"><a href="#cb24-1064" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1065"><a href="#cb24-1065" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visual-sentiment</span></span>
<span id="cb24-1066"><a href="#cb24-1066" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1067"><a href="#cb24-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1068"><a href="#cb24-1068" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_visual_sentiment(image_paths, model_name<span class="op">=</span><span class="st">"resnet50"</span>):</span>
<span id="cb24-1069"><a href="#cb24-1069" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-1070"><a href="#cb24-1070" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute visual sentiment scores using a fine-tuned CNN.</span></span>
<span id="cb24-1071"><a href="#cb24-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1072"><a href="#cb24-1072" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses features from a pre-trained CNN followed by a sentiment</span></span>
<span id="cb24-1073"><a href="#cb24-1073" aria-hidden="true" tabindex="-1"></a><span class="co">    classifier trained on the Visual Sentiment Ontology (VSO)</span></span>
<span id="cb24-1074"><a href="#cb24-1074" aria-hidden="true" tabindex="-1"></a><span class="co">    or similar dataset.</span></span>
<span id="cb24-1075"><a href="#cb24-1075" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1076"><a href="#cb24-1076" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-1077"><a href="#cb24-1077" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-1078"><a href="#cb24-1078" aria-hidden="true" tabindex="-1"></a><span class="co">    image_paths : list</span></span>
<span id="cb24-1079"><a href="#cb24-1079" aria-hidden="true" tabindex="-1"></a><span class="co">        Paths to news images.</span></span>
<span id="cb24-1080"><a href="#cb24-1080" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1081"><a href="#cb24-1081" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-1082"><a href="#cb24-1082" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-1083"><a href="#cb24-1083" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : image_path, positive_score, negative_score, sentiment.</span></span>
<span id="cb24-1084"><a href="#cb24-1084" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1085"><a href="#cb24-1085" aria-hidden="true" tabindex="-1"></a>    device <span class="op">=</span> <span class="st">"cuda"</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">"cpu"</span></span>
<span id="cb24-1086"><a href="#cb24-1086" aria-hidden="true" tabindex="-1"></a>    model, transform, dim <span class="op">=</span> build_feature_extractor(model_name, device)</span>
<span id="cb24-1087"><a href="#cb24-1087" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1088"><a href="#cb24-1088" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract features</span></span>
<span id="cb24-1089"><a href="#cb24-1089" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> extract_features(image_paths, model, transform, device)</span>
<span id="cb24-1090"><a href="#cb24-1090" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1091"><a href="#cb24-1091" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Simple sentiment model: use mean activation as proxy</span></span>
<span id="cb24-1092"><a href="#cb24-1092" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (In practice, fine-tune on labeled financial images)</span></span>
<span id="cb24-1093"><a href="#cb24-1093" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Higher mean activation in certain feature channels</span></span>
<span id="cb24-1094"><a href="#cb24-1094" aria-hidden="true" tabindex="-1"></a>    <span class="co"># correlates with positive/negative affect</span></span>
<span id="cb24-1095"><a href="#cb24-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1096"><a href="#cb24-1096" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Positive channels (empirically determined via validation)</span></span>
<span id="cb24-1097"><a href="#cb24-1097" aria-hidden="true" tabindex="-1"></a>    pos_channels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">0</span>, dim <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb24-1098"><a href="#cb24-1098" aria-hidden="true" tabindex="-1"></a>    neg_channels <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(dim <span class="op">//</span> <span class="dv">3</span>, <span class="dv">2</span> <span class="op">*</span> dim <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb24-1099"><a href="#cb24-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1100"><a href="#cb24-1100" aria-hidden="true" tabindex="-1"></a>    pos_scores <span class="op">=</span> features[:, pos_channels].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-1101"><a href="#cb24-1101" aria-hidden="true" tabindex="-1"></a>    neg_scores <span class="op">=</span> features[:, neg_channels].mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb24-1102"><a href="#cb24-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1103"><a href="#cb24-1103" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize to [0, 1]</span></span>
<span id="cb24-1104"><a href="#cb24-1104" aria-hidden="true" tabindex="-1"></a>    pos_norm <span class="op">=</span> (pos_scores <span class="op">-</span> pos_scores.<span class="bu">min</span>()) <span class="op">/</span> (</span>
<span id="cb24-1105"><a href="#cb24-1105" aria-hidden="true" tabindex="-1"></a>        pos_scores.<span class="bu">max</span>() <span class="op">-</span> pos_scores.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span></span>
<span id="cb24-1106"><a href="#cb24-1106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-1107"><a href="#cb24-1107" aria-hidden="true" tabindex="-1"></a>    neg_norm <span class="op">=</span> (neg_scores <span class="op">-</span> neg_scores.<span class="bu">min</span>()) <span class="op">/</span> (</span>
<span id="cb24-1108"><a href="#cb24-1108" aria-hidden="true" tabindex="-1"></a>        neg_scores.<span class="bu">max</span>() <span class="op">-</span> neg_scores.<span class="bu">min</span>() <span class="op">+</span> <span class="fl">1e-8</span></span>
<span id="cb24-1109"><a href="#cb24-1109" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-1110"><a href="#cb24-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1111"><a href="#cb24-1111" aria-hidden="true" tabindex="-1"></a>    sentiment <span class="op">=</span> pos_norm <span class="op">-</span> neg_norm</span>
<span id="cb24-1112"><a href="#cb24-1112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1113"><a href="#cb24-1113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({</span>
<span id="cb24-1114"><a href="#cb24-1114" aria-hidden="true" tabindex="-1"></a>        <span class="st">"image_path"</span>: image_paths,</span>
<span id="cb24-1115"><a href="#cb24-1115" aria-hidden="true" tabindex="-1"></a>        <span class="st">"positive_score"</span>: pos_norm,</span>
<span id="cb24-1116"><a href="#cb24-1116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"negative_score"</span>: neg_norm,</span>
<span id="cb24-1117"><a href="#cb24-1117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"net_sentiment"</span>: sentiment</span>
<span id="cb24-1118"><a href="#cb24-1118" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb24-1119"><a href="#cb24-1119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1120"><a href="#cb24-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1121"><a href="#cb24-1121" aria-hidden="true" tabindex="-1"></a><span class="fu">### Vision-Language Models for Financial Image Understanding</span></span>
<span id="cb24-1122"><a href="#cb24-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1123"><a href="#cb24-1123" aria-hidden="true" tabindex="-1"></a>The most powerful approach to financial image analysis uses vision-language models (VLMs), which jointly process images and text. Models such as CLIP <span class="co">[</span><span class="ot">@radford2021learning</span><span class="co">]</span>, BLIP-2 <span class="co">[</span><span class="ot">@li2023blip</span><span class="co">]</span>, and GPT-4V can be prompted to interpret financial images in context. For instance, given an aerial photograph of a factory, a VLM can answer "Is this factory operating at full capacity?" or "Is there visible construction of additional facilities?"</span>
<span id="cb24-1124"><a href="#cb24-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1127"><a href="#cb24-1127" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1128"><a href="#cb24-1128" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vlm-analysis</span></span>
<span id="cb24-1129"><a href="#cb24-1129" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1130"><a href="#cb24-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1131"><a href="#cb24-1131" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> vlm_financial_analysis(image_path, prompt, model_name<span class="op">=</span><span class="st">"clip"</span>):</span>
<span id="cb24-1132"><a href="#cb24-1132" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-1133"><a href="#cb24-1133" aria-hidden="true" tabindex="-1"></a><span class="co">    Use a vision-language model to analyze a financial image.</span></span>
<span id="cb24-1134"><a href="#cb24-1134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1135"><a href="#cb24-1135" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-1136"><a href="#cb24-1136" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-1137"><a href="#cb24-1137" aria-hidden="true" tabindex="-1"></a><span class="co">    image_path : str</span></span>
<span id="cb24-1138"><a href="#cb24-1138" aria-hidden="true" tabindex="-1"></a><span class="co">        Path to image.</span></span>
<span id="cb24-1139"><a href="#cb24-1139" aria-hidden="true" tabindex="-1"></a><span class="co">    prompt : str</span></span>
<span id="cb24-1140"><a href="#cb24-1140" aria-hidden="true" tabindex="-1"></a><span class="co">        Financial analysis prompt.</span></span>
<span id="cb24-1141"><a href="#cb24-1141" aria-hidden="true" tabindex="-1"></a><span class="co">    model_name : str</span></span>
<span id="cb24-1142"><a href="#cb24-1142" aria-hidden="true" tabindex="-1"></a><span class="co">        'clip' for zero-shot classification,</span></span>
<span id="cb24-1143"><a href="#cb24-1143" aria-hidden="true" tabindex="-1"></a><span class="co">        'blip2' for visual question answering.</span></span>
<span id="cb24-1144"><a href="#cb24-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1145"><a href="#cb24-1145" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-1146"><a href="#cb24-1146" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-1147"><a href="#cb24-1147" aria-hidden="true" tabindex="-1"></a><span class="co">    dict : Model output (scores or text).</span></span>
<span id="cb24-1148"><a href="#cb24-1148" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1149"><a href="#cb24-1149" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> Image.<span class="bu">open</span>(image_path).convert(<span class="st">"RGB"</span>)</span>
<span id="cb24-1150"><a href="#cb24-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1151"><a href="#cb24-1151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model_name <span class="op">==</span> <span class="st">"clip"</span>:</span>
<span id="cb24-1152"><a href="#cb24-1152" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> transformers <span class="im">import</span> CLIPProcessor, CLIPModel</span>
<span id="cb24-1153"><a href="#cb24-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1154"><a href="#cb24-1154" aria-hidden="true" tabindex="-1"></a>        clip_model <span class="op">=</span> CLIPModel.from_pretrained(</span>
<span id="cb24-1155"><a href="#cb24-1155" aria-hidden="true" tabindex="-1"></a>            <span class="st">"openai/clip-vit-base-patch32"</span></span>
<span id="cb24-1156"><a href="#cb24-1156" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1157"><a href="#cb24-1157" aria-hidden="true" tabindex="-1"></a>        processor <span class="op">=</span> CLIPProcessor.from_pretrained(</span>
<span id="cb24-1158"><a href="#cb24-1158" aria-hidden="true" tabindex="-1"></a>            <span class="st">"openai/clip-vit-base-patch32"</span></span>
<span id="cb24-1159"><a href="#cb24-1159" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1160"><a href="#cb24-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1161"><a href="#cb24-1161" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Zero-shot classification with financial labels</span></span>
<span id="cb24-1162"><a href="#cb24-1162" aria-hidden="true" tabindex="-1"></a>        labels <span class="op">=</span> [</span>
<span id="cb24-1163"><a href="#cb24-1163" aria-hidden="true" tabindex="-1"></a>            <span class="st">"busy commercial area with many customers"</span>,</span>
<span id="cb24-1164"><a href="#cb24-1164" aria-hidden="true" tabindex="-1"></a>            <span class="st">"empty commercial area with few customers"</span>,</span>
<span id="cb24-1165"><a href="#cb24-1165" aria-hidden="true" tabindex="-1"></a>            <span class="st">"active construction site with workers"</span>,</span>
<span id="cb24-1166"><a href="#cb24-1166" aria-hidden="true" tabindex="-1"></a>            <span class="st">"idle construction site without activity"</span>,</span>
<span id="cb24-1167"><a href="#cb24-1167" aria-hidden="true" tabindex="-1"></a>            <span class="st">"healthy green crops in agricultural field"</span>,</span>
<span id="cb24-1168"><a href="#cb24-1168" aria-hidden="true" tabindex="-1"></a>            <span class="st">"damaged or dry crops in agricultural field"</span>,</span>
<span id="cb24-1169"><a href="#cb24-1169" aria-hidden="true" tabindex="-1"></a>            <span class="st">"busy port with many ships and containers"</span>,</span>
<span id="cb24-1170"><a href="#cb24-1170" aria-hidden="true" tabindex="-1"></a>            <span class="st">"quiet port with few ships"</span></span>
<span id="cb24-1171"><a href="#cb24-1171" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb24-1172"><a href="#cb24-1172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1173"><a href="#cb24-1173" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> processor(</span>
<span id="cb24-1174"><a href="#cb24-1174" aria-hidden="true" tabindex="-1"></a>            text<span class="op">=</span>labels,</span>
<span id="cb24-1175"><a href="#cb24-1175" aria-hidden="true" tabindex="-1"></a>            images<span class="op">=</span>img,</span>
<span id="cb24-1176"><a href="#cb24-1176" aria-hidden="true" tabindex="-1"></a>            return_tensors<span class="op">=</span><span class="st">"pt"</span>,</span>
<span id="cb24-1177"><a href="#cb24-1177" aria-hidden="true" tabindex="-1"></a>            padding<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-1178"><a href="#cb24-1178" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1179"><a href="#cb24-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1180"><a href="#cb24-1180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-1181"><a href="#cb24-1181" aria-hidden="true" tabindex="-1"></a>            outputs <span class="op">=</span> clip_model(<span class="op">**</span>inputs)</span>
<span id="cb24-1182"><a href="#cb24-1182" aria-hidden="true" tabindex="-1"></a>            logits <span class="op">=</span> outputs.logits_per_image.squeeze()</span>
<span id="cb24-1183"><a href="#cb24-1183" aria-hidden="true" tabindex="-1"></a>            probs <span class="op">=</span> torch.softmax(logits, dim<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb24-1184"><a href="#cb24-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1185"><a href="#cb24-1185" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> {</span>
<span id="cb24-1186"><a href="#cb24-1186" aria-hidden="true" tabindex="-1"></a>            label: prob.item()</span>
<span id="cb24-1187"><a href="#cb24-1187" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> label, prob <span class="kw">in</span> <span class="bu">zip</span>(labels, probs)</span>
<span id="cb24-1188"><a href="#cb24-1188" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb24-1189"><a href="#cb24-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1190"><a href="#cb24-1190" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"scores"</span>: results, <span class="st">"top_label"</span>: <span class="bu">max</span>(results, key<span class="op">=</span>results.get)}</span>
<span id="cb24-1191"><a href="#cb24-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1192"><a href="#cb24-1192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> model_name <span class="op">==</span> <span class="st">"blip2"</span>:</span>
<span id="cb24-1193"><a href="#cb24-1193" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> transformers <span class="im">import</span> Blip2Processor, Blip2ForConditionalGeneration</span>
<span id="cb24-1194"><a href="#cb24-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1195"><a href="#cb24-1195" aria-hidden="true" tabindex="-1"></a>        processor <span class="op">=</span> Blip2Processor.from_pretrained(</span>
<span id="cb24-1196"><a href="#cb24-1196" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Salesforce/blip2-opt-2.7b"</span></span>
<span id="cb24-1197"><a href="#cb24-1197" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1198"><a href="#cb24-1198" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> Blip2ForConditionalGeneration.from_pretrained(</span>
<span id="cb24-1199"><a href="#cb24-1199" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Salesforce/blip2-opt-2.7b"</span>,</span>
<span id="cb24-1200"><a href="#cb24-1200" aria-hidden="true" tabindex="-1"></a>            torch_dtype<span class="op">=</span>torch.float16</span>
<span id="cb24-1201"><a href="#cb24-1201" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1202"><a href="#cb24-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1203"><a href="#cb24-1203" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> processor(images<span class="op">=</span>img, text<span class="op">=</span>prompt, return_tensors<span class="op">=</span><span class="st">"pt"</span>)</span>
<span id="cb24-1204"><a href="#cb24-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1205"><a href="#cb24-1205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-1206"><a href="#cb24-1206" aria-hidden="true" tabindex="-1"></a>            generated_ids <span class="op">=</span> model.generate(<span class="op">**</span>inputs, max_length<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb24-1207"><a href="#cb24-1207" aria-hidden="true" tabindex="-1"></a>            answer <span class="op">=</span> processor.decode(</span>
<span id="cb24-1208"><a href="#cb24-1208" aria-hidden="true" tabindex="-1"></a>                generated_ids[<span class="dv">0</span>], skip_special_tokens<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-1209"><a href="#cb24-1209" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1210"><a href="#cb24-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1211"><a href="#cb24-1211" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"answer"</span>: answer}</span>
<span id="cb24-1212"><a href="#cb24-1212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1213"><a href="#cb24-1213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1216"><a href="#cb24-1216" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1217"><a href="#cb24-1217" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visual-sentiment-market</span></span>
<span id="cb24-1218"><a href="#cb24-1218" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1219"><a href="#cb24-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1220"><a href="#cb24-1220" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct daily visual sentiment index from news images</span></span>
<span id="cb24-1221"><a href="#cb24-1221" aria-hidden="true" tabindex="-1"></a><span class="co"># Source: Vietnamese financial news sites (VnExpress, CafeF, etc.)</span></span>
<span id="cb24-1222"><a href="#cb24-1222" aria-hidden="true" tabindex="-1"></a>news_images <span class="op">=</span> dc.get_news_images(</span>
<span id="cb24-1223"><a href="#cb24-1223" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb24-1224"><a href="#cb24-1224" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb24-1225"><a href="#cb24-1225" aria-hidden="true" tabindex="-1"></a>    source<span class="op">=</span>[<span class="st">"vnexpress_finance"</span>, <span class="st">"cafef"</span>]</span>
<span id="cb24-1226"><a href="#cb24-1226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1227"><a href="#cb24-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1228"><a href="#cb24-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily visual sentiment</span></span>
<span id="cb24-1229"><a href="#cb24-1229" aria-hidden="true" tabindex="-1"></a>daily_sentiment <span class="op">=</span> (</span>
<span id="cb24-1230"><a href="#cb24-1230" aria-hidden="true" tabindex="-1"></a>    news_images.groupby(<span class="st">"date"</span>)</span>
<span id="cb24-1231"><a href="#cb24-1231" aria-hidden="true" tabindex="-1"></a>    .agg(</span>
<span id="cb24-1232"><a href="#cb24-1232" aria-hidden="true" tabindex="-1"></a>        visual_sentiment<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="st">"mean"</span>),</span>
<span id="cb24-1233"><a href="#cb24-1233" aria-hidden="true" tabindex="-1"></a>        n_images<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="st">"count"</span>),</span>
<span id="cb24-1234"><a href="#cb24-1234" aria-hidden="true" tabindex="-1"></a>        pct_negative<span class="op">=</span>(<span class="st">"net_sentiment"</span>, <span class="kw">lambda</span> x: (x <span class="op">&lt;</span> <span class="dv">0</span>).mean())</span>
<span id="cb24-1235"><a href="#cb24-1235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb24-1236"><a href="#cb24-1236" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb24-1237"><a href="#cb24-1237" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1238"><a href="#cb24-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1239"><a href="#cb24-1239" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with market returns</span></span>
<span id="cb24-1240"><a href="#cb24-1240" aria-hidden="true" tabindex="-1"></a>market_returns <span class="op">=</span> dc.get_market_returns(</span>
<span id="cb24-1241"><a href="#cb24-1241" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">"2018-01-01"</span>,</span>
<span id="cb24-1242"><a href="#cb24-1242" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">"2024-12-31"</span>,</span>
<span id="cb24-1243"><a href="#cb24-1243" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">"daily"</span></span>
<span id="cb24-1244"><a href="#cb24-1244" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1245"><a href="#cb24-1245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1246"><a href="#cb24-1246" aria-hidden="true" tabindex="-1"></a>sentiment_returns <span class="op">=</span> daily_sentiment.merge(</span>
<span id="cb24-1247"><a href="#cb24-1247" aria-hidden="true" tabindex="-1"></a>    market_returns[[<span class="st">"date"</span>, <span class="st">"mkt_ret"</span>]],</span>
<span id="cb24-1248"><a href="#cb24-1248" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">"date"</span>,</span>
<span id="cb24-1249"><a href="#cb24-1249" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">"inner"</span></span>
<span id="cb24-1250"><a href="#cb24-1250" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1251"><a href="#cb24-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1252"><a href="#cb24-1252" aria-hidden="true" tabindex="-1"></a><span class="co"># Lead-lag analysis: does visual sentiment predict next-day returns?</span></span>
<span id="cb24-1253"><a href="#cb24-1253" aria-hidden="true" tabindex="-1"></a>sentiment_returns <span class="op">=</span> sentiment_returns.sort_values(<span class="st">"date"</span>)</span>
<span id="cb24-1254"><a href="#cb24-1254" aria-hidden="true" tabindex="-1"></a>sentiment_returns[<span class="st">"mkt_ret_lead1"</span>] <span class="op">=</span> sentiment_returns[<span class="st">"mkt_ret"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-1255"><a href="#cb24-1255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1256"><a href="#cb24-1256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1259"><a href="#cb24-1259" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1260"><a href="#cb24-1260" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-visual-sentiment-predictability</span></span>
<span id="cb24-1261"><a href="#cb24-1261" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1262"><a href="#cb24-1262" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Visual Sentiment and Market Return Predictability"</span></span>
<span id="cb24-1263"><a href="#cb24-1263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1264"><a href="#cb24-1264" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression: next-day return on today's visual sentiment</span></span>
<span id="cb24-1265"><a href="#cb24-1265" aria-hidden="true" tabindex="-1"></a>sr_clean <span class="op">=</span> sentiment_returns.dropna(</span>
<span id="cb24-1266"><a href="#cb24-1266" aria-hidden="true" tabindex="-1"></a>    subset<span class="op">=</span>[<span class="st">"mkt_ret_lead1"</span>, <span class="st">"visual_sentiment"</span>, <span class="st">"mkt_ret"</span>]</span>
<span id="cb24-1267"><a href="#cb24-1267" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-1268"><a href="#cb24-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1269"><a href="#cb24-1269" aria-hidden="true" tabindex="-1"></a>model_sent <span class="op">=</span> sm.OLS(</span>
<span id="cb24-1270"><a href="#cb24-1270" aria-hidden="true" tabindex="-1"></a>    sr_clean[<span class="st">"mkt_ret_lead1"</span>],</span>
<span id="cb24-1271"><a href="#cb24-1271" aria-hidden="true" tabindex="-1"></a>    sm.add_constant(sr_clean[[<span class="st">"visual_sentiment"</span>, <span class="st">"mkt_ret"</span>]])</span>
<span id="cb24-1272"><a href="#cb24-1272" aria-hidden="true" tabindex="-1"></a>).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">5</span>})</span>
<span id="cb24-1273"><a href="#cb24-1273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1274"><a href="#cb24-1274" aria-hidden="true" tabindex="-1"></a>sent_results <span class="op">=</span> pd.DataFrame({</span>
<span id="cb24-1275"><a href="#cb24-1275" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Coefficient"</span>: model_sent.params.<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb24-1276"><a href="#cb24-1276" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Std Error"</span>: model_sent.bse.<span class="bu">round</span>(<span class="dv">6</span>),</span>
<span id="cb24-1277"><a href="#cb24-1277" aria-hidden="true" tabindex="-1"></a>    <span class="st">"t-stat"</span>: model_sent.tvalues.<span class="bu">round</span>(<span class="dv">3</span>),</span>
<span id="cb24-1278"><a href="#cb24-1278" aria-hidden="true" tabindex="-1"></a>    <span class="st">"p-value"</span>: model_sent.pvalues.<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb24-1279"><a href="#cb24-1279" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb24-1280"><a href="#cb24-1280" aria-hidden="true" tabindex="-1"></a>sent_results</span>
<span id="cb24-1281"><a href="#cb24-1281" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1282"><a href="#cb24-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1283"><a href="#cb24-1283" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multimodal Fusion: Combining Image and Text</span></span>
<span id="cb24-1284"><a href="#cb24-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1285"><a href="#cb24-1285" aria-hidden="true" tabindex="-1"></a><span class="fu">### Why Multimodal?</span></span>
<span id="cb24-1286"><a href="#cb24-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1287"><a href="#cb24-1287" aria-hidden="true" tabindex="-1"></a>Text and images capture different dimensions of the same underlying economic reality. An earnings report describes financial performance in words and numbers; the accompanying photographs show factories, products, and management. A news article about a port describes trade volumes in text; the satellite image shows actual ship positions. Combining both modalities yields a richer representation than either alone.</span>
<span id="cb24-1288"><a href="#cb24-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1289"><a href="#cb24-1289" aria-hidden="true" tabindex="-1"></a>The fusion architecture depends on the application:</span>
<span id="cb24-1290"><a href="#cb24-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1291"><a href="#cb24-1291" aria-hidden="true" tabindex="-1"></a>**Early fusion.** Concatenate image features $\mathbf{z}^{\text{img}}$ and text features $\mathbf{z}^{\text{txt}}$ into a single vector $<span class="co">[</span><span class="ot">\mathbf{z}^{\text{img}}; \mathbf{z}^{\text{txt}}</span><span class="co">]</span>$ before prediction. Simple but ignores cross-modal interactions.</span>
<span id="cb24-1292"><a href="#cb24-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1293"><a href="#cb24-1293" aria-hidden="true" tabindex="-1"></a>**Late fusion.** Train separate models on each modality and combine predictions: $\hat{y} = \alpha \hat{y}^{\text{img}} + (1-\alpha) \hat{y}^{\text{txt}}$. Robust but cannot learn cross-modal features.</span>
<span id="cb24-1294"><a href="#cb24-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1295"><a href="#cb24-1295" aria-hidden="true" tabindex="-1"></a>**Cross-attention fusion.** Use transformer cross-attention to let each modality attend to the other. Most powerful but requires more data and computation.</span>
<span id="cb24-1296"><a href="#cb24-1296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1297"><a href="#cb24-1297" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb24-1298"><a href="#cb24-1298" aria-hidden="true" tabindex="-1"></a>\mathbf{z}^{\text{fused}} = \text{CrossAttention}(\mathbf{z}^{\text{img}}, \mathbf{z}^{\text{txt}}) = \text{softmax}\left(\frac{\mathbf{Q}^{\text{img}} (\mathbf{K}^{\text{txt}})^\top}{\sqrt{d}}\right) \mathbf{V}^{\text{txt}}</span>
<span id="cb24-1299"><a href="#cb24-1299" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cross-attention}</span>
<span id="cb24-1300"><a href="#cb24-1300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1303"><a href="#cb24-1303" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1304"><a href="#cb24-1304" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multimodal-fusion</span></span>
<span id="cb24-1305"><a href="#cb24-1305" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1306"><a href="#cb24-1306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1307"><a href="#cb24-1307" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MultimodalFusionModel(nn.Module):</span>
<span id="cb24-1308"><a href="#cb24-1308" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-1309"><a href="#cb24-1309" aria-hidden="true" tabindex="-1"></a><span class="co">    Multimodal fusion model combining image and text features</span></span>
<span id="cb24-1310"><a href="#cb24-1310" aria-hidden="true" tabindex="-1"></a><span class="co">    for financial prediction.</span></span>
<span id="cb24-1311"><a href="#cb24-1311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1312"><a href="#cb24-1312" aria-hidden="true" tabindex="-1"></a><span class="co">    Supports early fusion, late fusion, and cross-attention.</span></span>
<span id="cb24-1313"><a href="#cb24-1313" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1314"><a href="#cb24-1314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1315"><a href="#cb24-1315" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, img_dim<span class="op">=</span><span class="dv">2048</span>, txt_dim<span class="op">=</span><span class="dv">768</span>, hidden_dim<span class="op">=</span><span class="dv">256</span>,</span>
<span id="cb24-1316"><a href="#cb24-1316" aria-hidden="true" tabindex="-1"></a>                 fusion<span class="op">=</span><span class="st">"early"</span>, n_heads<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb24-1317"><a href="#cb24-1317" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb24-1318"><a href="#cb24-1318" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fusion <span class="op">=</span> fusion</span>
<span id="cb24-1319"><a href="#cb24-1319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1320"><a href="#cb24-1320" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Image projection</span></span>
<span id="cb24-1321"><a href="#cb24-1321" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_proj <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-1322"><a href="#cb24-1322" aria-hidden="true" tabindex="-1"></a>            nn.Linear(img_dim, hidden_dim),</span>
<span id="cb24-1323"><a href="#cb24-1323" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb24-1324"><a href="#cb24-1324" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb24-1325"><a href="#cb24-1325" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1326"><a href="#cb24-1326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1327"><a href="#cb24-1327" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Text projection</span></span>
<span id="cb24-1328"><a href="#cb24-1328" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.txt_proj <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-1329"><a href="#cb24-1329" aria-hidden="true" tabindex="-1"></a>            nn.Linear(txt_dim, hidden_dim),</span>
<span id="cb24-1330"><a href="#cb24-1330" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb24-1331"><a href="#cb24-1331" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.2</span>)</span>
<span id="cb24-1332"><a href="#cb24-1332" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb24-1333"><a href="#cb24-1333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1334"><a href="#cb24-1334" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> fusion <span class="op">==</span> <span class="st">"early"</span>:</span>
<span id="cb24-1335"><a href="#cb24-1335" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-1336"><a href="#cb24-1336" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, hidden_dim),</span>
<span id="cb24-1337"><a href="#cb24-1337" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb24-1338"><a href="#cb24-1338" aria-hidden="true" tabindex="-1"></a>                nn.Dropout(<span class="fl">0.2</span>),</span>
<span id="cb24-1339"><a href="#cb24-1339" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb24-1340"><a href="#cb24-1340" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1341"><a href="#cb24-1341" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> fusion <span class="op">==</span> <span class="st">"late"</span>:</span>
<span id="cb24-1342"><a href="#cb24-1342" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.img_head <span class="op">=</span> nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb24-1343"><a href="#cb24-1343" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.txt_head <span class="op">=</span> nn.Linear(hidden_dim, <span class="dv">1</span>)</span>
<span id="cb24-1344"><a href="#cb24-1344" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.alpha <span class="op">=</span> nn.Parameter(torch.tensor(<span class="fl">0.5</span>))</span>
<span id="cb24-1345"><a href="#cb24-1345" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> fusion <span class="op">==</span> <span class="st">"cross_attention"</span>:</span>
<span id="cb24-1346"><a href="#cb24-1346" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.cross_attn <span class="op">=</span> nn.MultiheadAttention(</span>
<span id="cb24-1347"><a href="#cb24-1347" aria-hidden="true" tabindex="-1"></a>                embed_dim<span class="op">=</span>hidden_dim,</span>
<span id="cb24-1348"><a href="#cb24-1348" aria-hidden="true" tabindex="-1"></a>                num_heads<span class="op">=</span>n_heads,</span>
<span id="cb24-1349"><a href="#cb24-1349" aria-hidden="true" tabindex="-1"></a>                batch_first<span class="op">=</span><span class="va">True</span></span>
<span id="cb24-1350"><a href="#cb24-1350" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1351"><a href="#cb24-1351" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.head <span class="op">=</span> nn.Sequential(</span>
<span id="cb24-1352"><a href="#cb24-1352" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim, hidden_dim <span class="op">//</span> <span class="dv">2</span>),</span>
<span id="cb24-1353"><a href="#cb24-1353" aria-hidden="true" tabindex="-1"></a>                nn.ReLU(),</span>
<span id="cb24-1354"><a href="#cb24-1354" aria-hidden="true" tabindex="-1"></a>                nn.Linear(hidden_dim <span class="op">//</span> <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb24-1355"><a href="#cb24-1355" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1356"><a href="#cb24-1356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1357"><a href="#cb24-1357" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, img_features, txt_features):</span>
<span id="cb24-1358"><a href="#cb24-1358" aria-hidden="true" tabindex="-1"></a>        img_h <span class="op">=</span> <span class="va">self</span>.img_proj(img_features)</span>
<span id="cb24-1359"><a href="#cb24-1359" aria-hidden="true" tabindex="-1"></a>        txt_h <span class="op">=</span> <span class="va">self</span>.txt_proj(txt_features)</span>
<span id="cb24-1360"><a href="#cb24-1360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1361"><a href="#cb24-1361" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"early"</span>:</span>
<span id="cb24-1362"><a href="#cb24-1362" aria-hidden="true" tabindex="-1"></a>            combined <span class="op">=</span> torch.cat([img_h, txt_h], dim<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb24-1363"><a href="#cb24-1363" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.head(combined).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-1364"><a href="#cb24-1364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1365"><a href="#cb24-1365" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"late"</span>:</span>
<span id="cb24-1366"><a href="#cb24-1366" aria-hidden="true" tabindex="-1"></a>            img_pred <span class="op">=</span> <span class="va">self</span>.img_head(img_h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-1367"><a href="#cb24-1367" aria-hidden="true" tabindex="-1"></a>            txt_pred <span class="op">=</span> <span class="va">self</span>.txt_head(txt_h).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-1368"><a href="#cb24-1368" aria-hidden="true" tabindex="-1"></a>            alpha <span class="op">=</span> torch.sigmoid(<span class="va">self</span>.alpha)</span>
<span id="cb24-1369"><a href="#cb24-1369" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> alpha <span class="op">*</span> img_pred <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> txt_pred</span>
<span id="cb24-1370"><a href="#cb24-1370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1371"><a href="#cb24-1371" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="va">self</span>.fusion <span class="op">==</span> <span class="st">"cross_attention"</span>:</span>
<span id="cb24-1372"><a href="#cb24-1372" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Image attends to text</span></span>
<span id="cb24-1373"><a href="#cb24-1373" aria-hidden="true" tabindex="-1"></a>            img_h_unsq <span class="op">=</span> img_h.unsqueeze(<span class="dv">1</span>)  <span class="co"># (B, 1, D)</span></span>
<span id="cb24-1374"><a href="#cb24-1374" aria-hidden="true" tabindex="-1"></a>            txt_h_unsq <span class="op">=</span> txt_h.unsqueeze(<span class="dv">1</span>)</span>
<span id="cb24-1375"><a href="#cb24-1375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1376"><a href="#cb24-1376" aria-hidden="true" tabindex="-1"></a>            attn_out, _ <span class="op">=</span> <span class="va">self</span>.cross_attn(</span>
<span id="cb24-1377"><a href="#cb24-1377" aria-hidden="true" tabindex="-1"></a>                img_h_unsq, txt_h_unsq, txt_h_unsq</span>
<span id="cb24-1378"><a href="#cb24-1378" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1379"><a href="#cb24-1379" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="va">self</span>.head(attn_out.squeeze(<span class="dv">1</span>)).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb24-1380"><a href="#cb24-1380" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1381"><a href="#cb24-1381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1384"><a href="#cb24-1384" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-1385"><a href="#cb24-1385" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: multimodal-experiment</span></span>
<span id="cb24-1386"><a href="#cb24-1386" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb24-1387"><a href="#cb24-1387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1388"><a href="#cb24-1388" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_multimodal_experiment(image_features, text_features, returns,</span>
<span id="cb24-1389"><a href="#cb24-1389" aria-hidden="true" tabindex="-1"></a>                               fusion_types<span class="op">=</span>[<span class="st">"early"</span>, <span class="st">"late"</span>,</span>
<span id="cb24-1390"><a href="#cb24-1390" aria-hidden="true" tabindex="-1"></a>                                             <span class="st">"cross_attention"</span>]):</span>
<span id="cb24-1391"><a href="#cb24-1391" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb24-1392"><a href="#cb24-1392" aria-hidden="true" tabindex="-1"></a><span class="co">    Compare multimodal fusion strategies for return prediction.</span></span>
<span id="cb24-1393"><a href="#cb24-1393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1394"><a href="#cb24-1394" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb24-1395"><a href="#cb24-1395" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb24-1396"><a href="#cb24-1396" aria-hidden="true" tabindex="-1"></a><span class="co">    image_features : np.ndarray</span></span>
<span id="cb24-1397"><a href="#cb24-1397" aria-hidden="true" tabindex="-1"></a><span class="co">        Image feature matrix (N x img_dim).</span></span>
<span id="cb24-1398"><a href="#cb24-1398" aria-hidden="true" tabindex="-1"></a><span class="co">    text_features : np.ndarray</span></span>
<span id="cb24-1399"><a href="#cb24-1399" aria-hidden="true" tabindex="-1"></a><span class="co">        Text feature matrix (N x txt_dim).</span></span>
<span id="cb24-1400"><a href="#cb24-1400" aria-hidden="true" tabindex="-1"></a><span class="co">    returns : np.ndarray</span></span>
<span id="cb24-1401"><a href="#cb24-1401" aria-hidden="true" tabindex="-1"></a><span class="co">        Target returns (N,).</span></span>
<span id="cb24-1402"><a href="#cb24-1402" aria-hidden="true" tabindex="-1"></a><span class="co">    fusion_types : list</span></span>
<span id="cb24-1403"><a href="#cb24-1403" aria-hidden="true" tabindex="-1"></a><span class="co">        Fusion strategies to compare.</span></span>
<span id="cb24-1404"><a href="#cb24-1404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1405"><a href="#cb24-1405" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb24-1406"><a href="#cb24-1406" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb24-1407"><a href="#cb24-1407" aria-hidden="true" tabindex="-1"></a><span class="co">    DataFrame : R², MSE, Sharpe for each strategy.</span></span>
<span id="cb24-1408"><a href="#cb24-1408" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb24-1409"><a href="#cb24-1409" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb24-1410"><a href="#cb24-1410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1411"><a href="#cb24-1411" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(returns)</span>
<span id="cb24-1412"><a href="#cb24-1412" aria-hidden="true" tabindex="-1"></a>    tscv <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb24-1413"><a href="#cb24-1413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1414"><a href="#cb24-1414" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb24-1415"><a href="#cb24-1415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1416"><a href="#cb24-1416" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fusion <span class="kw">in</span> fusion_types:</span>
<span id="cb24-1417"><a href="#cb24-1417" aria-hidden="true" tabindex="-1"></a>        fold_r2s <span class="op">=</span> []</span>
<span id="cb24-1418"><a href="#cb24-1418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1419"><a href="#cb24-1419" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> tscv.split(returns):</span>
<span id="cb24-1420"><a href="#cb24-1420" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Convert to tensors</span></span>
<span id="cb24-1421"><a href="#cb24-1421" aria-hidden="true" tabindex="-1"></a>            X_img_train <span class="op">=</span> torch.tensor(</span>
<span id="cb24-1422"><a href="#cb24-1422" aria-hidden="true" tabindex="-1"></a>                image_features[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb24-1423"><a href="#cb24-1423" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1424"><a href="#cb24-1424" aria-hidden="true" tabindex="-1"></a>            X_txt_train <span class="op">=</span> torch.tensor(</span>
<span id="cb24-1425"><a href="#cb24-1425" aria-hidden="true" tabindex="-1"></a>                text_features[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb24-1426"><a href="#cb24-1426" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1427"><a href="#cb24-1427" aria-hidden="true" tabindex="-1"></a>            y_train <span class="op">=</span> torch.tensor(</span>
<span id="cb24-1428"><a href="#cb24-1428" aria-hidden="true" tabindex="-1"></a>                returns[train_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb24-1429"><a href="#cb24-1429" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1430"><a href="#cb24-1430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1431"><a href="#cb24-1431" aria-hidden="true" tabindex="-1"></a>            X_img_test <span class="op">=</span> torch.tensor(</span>
<span id="cb24-1432"><a href="#cb24-1432" aria-hidden="true" tabindex="-1"></a>                image_features[test_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb24-1433"><a href="#cb24-1433" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1434"><a href="#cb24-1434" aria-hidden="true" tabindex="-1"></a>            X_txt_test <span class="op">=</span> torch.tensor(</span>
<span id="cb24-1435"><a href="#cb24-1435" aria-hidden="true" tabindex="-1"></a>                text_features[test_idx], dtype<span class="op">=</span>torch.float32</span>
<span id="cb24-1436"><a href="#cb24-1436" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1437"><a href="#cb24-1437" aria-hidden="true" tabindex="-1"></a>            y_test <span class="op">=</span> returns[test_idx]</span>
<span id="cb24-1438"><a href="#cb24-1438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1439"><a href="#cb24-1439" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Build and train model</span></span>
<span id="cb24-1440"><a href="#cb24-1440" aria-hidden="true" tabindex="-1"></a>            model <span class="op">=</span> MultimodalFusionModel(</span>
<span id="cb24-1441"><a href="#cb24-1441" aria-hidden="true" tabindex="-1"></a>                img_dim<span class="op">=</span>image_features.shape[<span class="dv">1</span>],</span>
<span id="cb24-1442"><a href="#cb24-1442" aria-hidden="true" tabindex="-1"></a>                txt_dim<span class="op">=</span>text_features.shape[<span class="dv">1</span>],</span>
<span id="cb24-1443"><a href="#cb24-1443" aria-hidden="true" tabindex="-1"></a>                fusion<span class="op">=</span>fusion</span>
<span id="cb24-1444"><a href="#cb24-1444" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb24-1445"><a href="#cb24-1445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1446"><a href="#cb24-1446" aria-hidden="true" tabindex="-1"></a>            optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-3</span>)</span>
<span id="cb24-1447"><a href="#cb24-1447" aria-hidden="true" tabindex="-1"></a>            loss_fn <span class="op">=</span> nn.MSELoss()</span>
<span id="cb24-1448"><a href="#cb24-1448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1449"><a href="#cb24-1449" aria-hidden="true" tabindex="-1"></a>            model.train()</span>
<span id="cb24-1450"><a href="#cb24-1450" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">50</span>):</span>
<span id="cb24-1451"><a href="#cb24-1451" aria-hidden="true" tabindex="-1"></a>                optimizer.zero_grad()</span>
<span id="cb24-1452"><a href="#cb24-1452" aria-hidden="true" tabindex="-1"></a>                pred <span class="op">=</span> model(X_img_train, X_txt_train)</span>
<span id="cb24-1453"><a href="#cb24-1453" aria-hidden="true" tabindex="-1"></a>                loss <span class="op">=</span> loss_fn(pred, y_train)</span>
<span id="cb24-1454"><a href="#cb24-1454" aria-hidden="true" tabindex="-1"></a>                loss.backward()</span>
<span id="cb24-1455"><a href="#cb24-1455" aria-hidden="true" tabindex="-1"></a>                optimizer.step()</span>
<span id="cb24-1456"><a href="#cb24-1456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1457"><a href="#cb24-1457" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Evaluate</span></span>
<span id="cb24-1458"><a href="#cb24-1458" aria-hidden="true" tabindex="-1"></a>            model.<span class="bu">eval</span>()</span>
<span id="cb24-1459"><a href="#cb24-1459" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():</span>
<span id="cb24-1460"><a href="#cb24-1460" aria-hidden="true" tabindex="-1"></a>                y_pred <span class="op">=</span> model(X_img_test, X_txt_test).numpy()</span>
<span id="cb24-1461"><a href="#cb24-1461" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1462"><a href="#cb24-1462" aria-hidden="true" tabindex="-1"></a>            ss_res <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_pred) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb24-1463"><a href="#cb24-1463" aria-hidden="true" tabindex="-1"></a>            ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_test.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb24-1464"><a href="#cb24-1464" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot <span class="cf">if</span> ss_tot <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb24-1465"><a href="#cb24-1465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1466"><a href="#cb24-1466" aria-hidden="true" tabindex="-1"></a>            fold_r2s.append(r2)</span>
<span id="cb24-1467"><a href="#cb24-1467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1468"><a href="#cb24-1468" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb24-1469"><a href="#cb24-1469" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fusion"</span>: fusion,</span>
<span id="cb24-1470"><a href="#cb24-1470" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_mean"</span>: np.mean(fold_r2s),</span>
<span id="cb24-1471"><a href="#cb24-1471" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_std"</span>: np.std(fold_r2s)</span>
<span id="cb24-1472"><a href="#cb24-1472" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb24-1473"><a href="#cb24-1473" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1474"><a href="#cb24-1474" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add unimodal baselines</span></span>
<span id="cb24-1475"><a href="#cb24-1475" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> modality, features <span class="kw">in</span> [(<span class="st">"image_only"</span>, image_features),</span>
<span id="cb24-1476"><a href="#cb24-1476" aria-hidden="true" tabindex="-1"></a>                                (<span class="st">"text_only"</span>, text_features)]:</span>
<span id="cb24-1477"><a href="#cb24-1477" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> sklearn.linear_model <span class="im">import</span> RidgeCV</span>
<span id="cb24-1478"><a href="#cb24-1478" aria-hidden="true" tabindex="-1"></a>        fold_r2s <span class="op">=</span> []</span>
<span id="cb24-1479"><a href="#cb24-1479" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> train_idx, test_idx <span class="kw">in</span> tscv.split(returns):</span>
<span id="cb24-1480"><a href="#cb24-1480" aria-hidden="true" tabindex="-1"></a>            ridge <span class="op">=</span> RidgeCV(alphas<span class="op">=</span>np.logspace(<span class="op">-</span><span class="dv">3</span>, <span class="dv">3</span>, <span class="dv">10</span>))</span>
<span id="cb24-1481"><a href="#cb24-1481" aria-hidden="true" tabindex="-1"></a>            ridge.fit(features[train_idx], returns[train_idx])</span>
<span id="cb24-1482"><a href="#cb24-1482" aria-hidden="true" tabindex="-1"></a>            y_pred <span class="op">=</span> ridge.predict(features[test_idx])</span>
<span id="cb24-1483"><a href="#cb24-1483" aria-hidden="true" tabindex="-1"></a>            y_test <span class="op">=</span> returns[test_idx]</span>
<span id="cb24-1484"><a href="#cb24-1484" aria-hidden="true" tabindex="-1"></a>            ss_res <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_pred) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb24-1485"><a href="#cb24-1485" aria-hidden="true" tabindex="-1"></a>            ss_tot <span class="op">=</span> np.<span class="bu">sum</span>((y_test <span class="op">-</span> y_test.mean()) <span class="op">**</span> <span class="dv">2</span>)</span>
<span id="cb24-1486"><a href="#cb24-1486" aria-hidden="true" tabindex="-1"></a>            fold_r2s.append(<span class="dv">1</span> <span class="op">-</span> ss_res <span class="op">/</span> ss_tot <span class="cf">if</span> ss_tot <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb24-1487"><a href="#cb24-1487" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1488"><a href="#cb24-1488" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb24-1489"><a href="#cb24-1489" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fusion"</span>: modality,</span>
<span id="cb24-1490"><a href="#cb24-1490" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_mean"</span>: np.mean(fold_r2s),</span>
<span id="cb24-1491"><a href="#cb24-1491" aria-hidden="true" tabindex="-1"></a>            <span class="st">"r2_std"</span>: np.std(fold_r2s)</span>
<span id="cb24-1492"><a href="#cb24-1492" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb24-1493"><a href="#cb24-1493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1494"><a href="#cb24-1494" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb24-1495"><a href="#cb24-1495" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-1496"><a href="#cb24-1496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1497"><a href="#cb24-1497" aria-hidden="true" tabindex="-1"></a><span class="fu">### Practical Considerations for Vietnamese Markets</span></span>
<span id="cb24-1498"><a href="#cb24-1498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1499"><a href="#cb24-1499" aria-hidden="true" tabindex="-1"></a>Multimodal analysis in Vietnamese markets faces several practical considerations:</span>
<span id="cb24-1500"><a href="#cb24-1500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1501"><a href="#cb24-1501" aria-hidden="true" tabindex="-1"></a>**Data alignment.** Satellite images, news articles, and market data operate on different temporal frequencies and spatial resolutions. Satellite composites are available weekly or biweekly; news is daily; trading is intraday. Proper alignment requires specifying the information set available to an investor at the time of the trading decision to avoid look-ahead bias.</span>
<span id="cb24-1502"><a href="#cb24-1502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1503"><a href="#cb24-1503" aria-hidden="true" tabindex="-1"></a>**Label scarcity.** Supervised learning requires labeled data (e.g., images annotated with economic outcomes). In Vietnam, ground-truth labels (actual retail sales, actual crop yields, actual port throughput) arrive with significant lags and often lack the granularity to match satellite resolution. Semi-supervised and self-supervised approaches are therefore essential.</span>
<span id="cb24-1504"><a href="#cb24-1504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1505"><a href="#cb24-1505" aria-hidden="true" tabindex="-1"></a>**Regulatory considerations.** High-resolution satellite imagery of specific commercial or military installations may be restricted. Researchers should verify that their imagery sources comply with Vietnamese regulations on geospatial data.</span>
<span id="cb24-1506"><a href="#cb24-1506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1507"><a href="#cb24-1507" aria-hidden="true" tabindex="-1"></a>**Computational cost.** Processing satellite tiles through CNNs is computationally intensive. A single Sentinel-2 tile at 10m resolution covering Ho Chi Minh City contains approximately $10{,}980 \times 10{,}980$ pixels per band. Tiling into $224 \times 224$ patches for CNN input generates $\sim 2{,}400$ patches per tile, each requiring a forward pass through the network.</span>
<span id="cb24-1508"><a href="#cb24-1508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1509"><a href="#cb24-1509" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Application <span class="pp">|</span> Image Source <span class="pp">|</span> Resolution <span class="pp">|</span> Frequency <span class="pp">|</span> Vietnamese Availability <span class="pp">|</span></span>
<span id="cb24-1510"><a href="#cb24-1510" aria-hidden="true" tabindex="-1"></a><span class="pp">|---------------|---------------|---------------|---------------|---------------|</span></span>
<span id="cb24-1511"><a href="#cb24-1511" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Nighttime luminosity <span class="pp">|</span> VIIRS/DMSP <span class="pp">|</span> 500m <span class="pp">|</span> Monthly <span class="pp">|</span> Free (NOAA/EOG) <span class="pp">|</span></span>
<span id="cb24-1512"><a href="#cb24-1512" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Crop health <span class="pp">|</span> MODIS/Sentinel-2 <span class="pp">|</span> 250m/10m <span class="pp">|</span> 16-day/5-day <span class="pp">|</span> Free (NASA/ESA) <span class="pp">|</span></span>
<span id="cb24-1513"><a href="#cb24-1513" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Port/ship detection <span class="pp">|</span> Sentinel-1 (SAR) <span class="pp">|</span> 10m <span class="pp">|</span> 12-day <span class="pp">|</span> Free (ESA Copernicus) <span class="pp">|</span></span>
<span id="cb24-1514"><a href="#cb24-1514" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Construction monitoring <span class="pp">|</span> Commercial (Maxar) <span class="pp">|</span> 30cm <span class="pp">|</span> On demand <span class="pp">|</span> Paid (\$) <span class="pp">|</span></span>
<span id="cb24-1515"><a href="#cb24-1515" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Urban density <span class="pp">|</span> Sentinel-2 <span class="pp">|</span> 10m <span class="pp">|</span> 5-day <span class="pp">|</span> Free (ESA) <span class="pp">|</span></span>
<span id="cb24-1516"><a href="#cb24-1516" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Document OCR <span class="pp">|</span> Corporate filings <span class="pp">|</span> N/A <span class="pp">|</span> Event-driven <span class="pp">|</span> DataCore.vn <span class="pp">|</span></span>
<span id="cb24-1517"><a href="#cb24-1517" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> News images <span class="pp">|</span> Financial media <span class="pp">|</span> N/A <span class="pp">|</span> Daily <span class="pp">|</span> Web scraping <span class="pp">|</span></span>
<span id="cb24-1518"><a href="#cb24-1518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1519"><a href="#cb24-1519" aria-hidden="true" tabindex="-1"></a>: Image Data Sources for Vietnamese Financial Applications {#tbl-image-sources}</span>
<span id="cb24-1520"><a href="#cb24-1520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1521"><a href="#cb24-1521" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises</span></span>
<span id="cb24-1522"><a href="#cb24-1522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1523"><a href="#cb24-1523" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Nightlight and Firm Performance.** Extend the nightlight analysis by constructing a multi-province exposure measure for firms with geographically diversified operations (e.g., a retailer with stores across multiple provinces). Weight the nightlight signal by the estimated revenue share from each province. Test whether this weighted signal predicts quarterly earnings surprises better than the headquarters-only measure.</span></span>
<span id="cb24-1524"><a href="#cb24-1524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1525"><a href="#cb24-1525" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **OCR Accuracy Benchmarking.** Collect a sample of 50 Vietnamese annual reports in scanned PDF format. Manually transcribe key financial figures (revenue, net income, total assets) from 5 reports to create ground truth. Compare OCR accuracy (character error rate, field-level exact match) across PaddleOCR, VietOCR, and Google Cloud Vision. Which engine performs best on Vietnamese financial tables? Does pre-processing (deskewing, contrast enhancement) significantly improve accuracy?</span></span>
<span id="cb24-1526"><a href="#cb24-1526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1527"><a href="#cb24-1527" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Satellite Nowcasting of Industrial Production.** Using Sentinel-2 imagery of industrial zones near Binh Duong, Dong Nai, and Bac Ninh, construct monthly indices of industrial activity based on CNN features. Specifically, train a model to predict the Industrial Production Index (IPI) published by the GSO using satellite features with a one-month lead. Report out-of-sample $R^2$ and compare with a baseline that uses only lagged IPI values (autoregressive benchmark).</span></span>
<span id="cb24-1528"><a href="#cb24-1528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1529"><a href="#cb24-1529" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Visual Sentiment and Earnings Announcements.** For a sample of Vietnamese firms, collect the photographs accompanying earnings-related news coverage on VnExpress and CafeF. Compute visual sentiment scores for each image using a pre-trained model. Test whether visual sentiment around earnings dates (5-day window) predicts post-earnings-announcement drift (PEAD), controlling for the textual sentiment of the same articles. Does the image add information beyond the text?</span></span>
<span id="cb24-1530"><a href="#cb24-1530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1531"><a href="#cb24-1531" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Multimodal Earnings Prediction.** For each firm-quarter observation, construct three feature sets: (a) tabular financial ratios, (b) textual features from the management discussion section of the annual report (using PhoBERT embeddings from the previous chapter), and (c) satellite features of the firm's headquarters region. Implement early, late, and cross-attention fusion and compare forecast accuracy for next-quarter earnings. Which modality contributes most? Does the multimodal model significantly outperform the best unimodal model?</span></span>
<span id="cb24-1532"><a href="#cb24-1532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1533"><a href="#cb24-1533" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Chart Digitization for Historical Vietnamese Market Data.** Obtain scanned charts of the VN-Index from pre-2005 sources (before electronic data was widely available). Digitize the index level time series using the line chart digitization algorithm. Cross-validate against any available electronic data for overlapping periods. Estimate the digitization error and assess whether the recovered time series is sufficiently accurate for computing return statistics (mean, volatility, maximum drawdown). --&gt;</span></span>
<span id="cb24-1534"><a href="#cb24-1534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1535"><a href="#cb24-1535" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb24-1536"><a href="#cb24-1536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1537"><a href="#cb24-1537" aria-hidden="true" tabindex="-1"></a>This chapter extended the alternative data toolkit from text (the previous chapter) to images. We demonstrated five distinct application domains for visual data in Vietnamese financial markets.</span>
<span id="cb24-1538"><a href="#cb24-1538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1539"><a href="#cb24-1539" aria-hidden="true" tabindex="-1"></a>First, satellite and geospatial imagery provides high-frequency, spatially granular economic signals that lead official statistics. Nighttime luminosity serves as a provincial GDP proxy with cross-sectional $R^2$ exceeding 0.7; NDVI crop health indices predict agricultural firm returns; and CNN features extracted from satellite tiles enable rich spatial representations of economic activity.</span>
<span id="cb24-1540"><a href="#cb24-1540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1541"><a href="#cb24-1541" aria-hidden="true" tabindex="-1"></a>Second, document image analysis solves the practical problem of extracting structured data from Vietnamese financial filings that arrive as scanned images. The pipeline (e.g., OCR with Vietnamese-optimized engines, layout analysis, table extraction, and LayoutLM-based document understanding) converts unstructured pixels into the structured financial data that all downstream analyses require.</span>
<span id="cb24-1542"><a href="#cb24-1542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1543"><a href="#cb24-1543" aria-hidden="true" tabindex="-1"></a>Third, chart digitization recovers numerical data series from visual representations, extending historical coverage and enabling systematic consumption of analyst outputs. Fourth, visual sentiment analysis from news imagery provides a signal dimension orthogonal to textual sentiment, with potential predictive power for market returns.</span>
<span id="cb24-1544"><a href="#cb24-1544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1545"><a href="#cb24-1545" aria-hidden="true" tabindex="-1"></a>Fifth, multimodal fusion (combining image and text representations via early, late, or cross-attention architectures) yields richer predictive models than either modality alone. The practical benefit of multimodal approaches scales with the diversity and quality of available data, making it increasingly relevant as Vietnamese alternative data ecosystems mature.</span>
<span id="cb24-1546"><a href="#cb24-1546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-1547"><a href="#cb24-1547" aria-hidden="true" tabindex="-1"></a>The common thread across all applications is the transformation pipeline: raw pixel tensor $\to$ feature representation (via CNN, ViT, or VLM) $\to$ financial signal $\to$ economic interpretation. The choice of architecture and the quality of the domain adaptation determine whether the resulting signal has genuine predictive content or merely captures noise.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/71_image.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>