<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>19&nbsp; Factor Construction Principles – Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./24_fama_macbeth.html" rel="next">
<link href="./22_momentum.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-d8431037eefe704a1e7a103aa5b75ea7.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-50a4fa9e9ef121803c2355a2deb1af4d.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="19&nbsp; Factor Construction Principles – Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:title" content="19&nbsp; Factor Construction Principles – Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">Asset Pricing Models and Cross-Sectional Tests</a></li><li class="breadcrumb-item"><a href="./23_factor_construction_principles.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Applying Tidy Finance with Python to Vietnam</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnam’s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Data, Research Design, and Frontiers</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./65_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./66_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./67_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-factor-con-pipeline" id="toc-sec-factor-con-pipeline" class="nav-link active" data-scroll-target="#sec-factor-con-pipeline"><span class="header-section-number">19.1</span> The Factor Construction Pipeline</a></li>
  <li><a href="#sec-factor-con-data" id="toc-sec-factor-con-data" class="nav-link" data-scroll-target="#sec-factor-con-data"><span class="header-section-number">19.2</span> Data Construction</a></li>
  <li><a href="#sec-factor-con-universe" id="toc-sec-factor-con-universe" class="nav-link" data-scroll-target="#sec-factor-con-universe"><span class="header-section-number">19.3</span> Step 1: Universe Definition</a>
  <ul class="collapse">
  <li><a href="#the-universe-problem-in-vietnam" id="toc-the-universe-problem-in-vietnam" class="nav-link" data-scroll-target="#the-universe-problem-in-vietnam"><span class="header-section-number">19.3.1</span> The Universe Problem in Vietnam</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-signals" id="toc-sec-factor-con-signals" class="nav-link" data-scroll-target="#sec-factor-con-signals"><span class="header-section-number">19.4</span> Step 2: Signal Construction</a>
  <ul class="collapse">
  <li><a href="#point-in-time-accounting-data" id="toc-point-in-time-accounting-data" class="nav-link" data-scroll-target="#point-in-time-accounting-data"><span class="header-section-number">19.4.1</span> Point-in-Time Accounting Data</a></li>
  <li><a href="#momentum-and-volatility-signals" id="toc-momentum-and-volatility-signals" class="nav-link" data-scroll-target="#momentum-and-volatility-signals"><span class="header-section-number">19.4.2</span> Momentum and Volatility Signals</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-breakpoints" id="toc-sec-factor-con-breakpoints" class="nav-link" data-scroll-target="#sec-factor-con-breakpoints"><span class="header-section-number">19.5</span> Step 3: Breakpoint Computation</a>
  <ul class="collapse">
  <li><a href="#the-breakpoint-decision" id="toc-the-breakpoint-decision" class="nav-link" data-scroll-target="#the-breakpoint-decision"><span class="header-section-number">19.5.1</span> The Breakpoint Decision</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-formation" id="toc-sec-factor-con-formation" class="nav-link" data-scroll-target="#sec-factor-con-formation"><span class="header-section-number">19.6</span> Step 4: Portfolio Formation</a>
  <ul class="collapse">
  <li><a href="#the-generic-factor-engine" id="toc-the-generic-factor-engine" class="nav-link" data-scroll-target="#the-generic-factor-engine"><span class="header-section-number">19.6.1</span> The Generic Factor Engine</a></li>
  <li><a href="#building-the-core-factors" id="toc-building-the-core-factors" class="nav-link" data-scroll-target="#building-the-core-factors"><span class="header-section-number">19.6.2</span> Building the Core Factors</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-sensitivity" id="toc-sec-factor-con-sensitivity" class="nav-link" data-scroll-target="#sec-factor-con-sensitivity"><span class="header-section-number">19.7</span> Step 5: Sensitivity to Construction Choices</a>
  <ul class="collapse">
  <li><a href="#weighting-value-weighted-vs.-equal-weighted" id="toc-weighting-value-weighted-vs.-equal-weighted" class="nav-link" data-scroll-target="#weighting-value-weighted-vs.-equal-weighted"><span class="header-section-number">19.7.1</span> Weighting: Value-Weighted vs.&nbsp;Equal-Weighted</a></li>
  <li><a href="#breakpoint-universe-hose-vs.-all-stocks" id="toc-breakpoint-universe-hose-vs.-all-stocks" class="nav-link" data-scroll-target="#breakpoint-universe-hose-vs.-all-stocks"><span class="header-section-number">19.7.2</span> Breakpoint Universe: HOSE vs.&nbsp;All Stocks</a></li>
  <li><a href="#number-of-groups-23-vs.-55-vs.-deciles" id="toc-number-of-groups-23-vs.-55-vs.-deciles" class="nav-link" data-scroll-target="#number-of-groups-23-vs.-55-vs.-deciles"><span class="header-section-number">19.7.3</span> Number of Groups: 2×3 vs.&nbsp;5×5 vs.&nbsp;Deciles</a></li>
  <li><a href="#rebalancing-frequency" id="toc-rebalancing-frequency" class="nav-link" data-scroll-target="#rebalancing-frequency"><span class="header-section-number">19.7.4</span> Rebalancing Frequency</a></li>
  <li><a href="#comprehensive-sensitivity-summary" id="toc-comprehensive-sensitivity-summary" class="nav-link" data-scroll-target="#comprehensive-sensitivity-summary"><span class="header-section-number">19.7.5</span> Comprehensive Sensitivity Summary</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-correlation" id="toc-sec-factor-con-correlation" class="nav-link" data-scroll-target="#sec-factor-con-correlation"><span class="header-section-number">19.8</span> Factor Correlation Structure</a></li>
  <li><a href="#sec-factor-con-validation" id="toc-sec-factor-con-validation" class="nav-link" data-scroll-target="#sec-factor-con-validation"><span class="header-section-number">19.9</span> Factor Validation</a>
  <ul class="collapse">
  <li><a href="#diagnostic-checklist" id="toc-diagnostic-checklist" class="nav-link" data-scroll-target="#diagnostic-checklist"><span class="header-section-number">19.9.1</span> Diagnostic Checklist</a></li>
  <li><a href="#monotonicity-test" id="toc-monotonicity-test" class="nav-link" data-scroll-target="#monotonicity-test"><span class="header-section-number">19.9.2</span> Monotonicity Test</a></li>
  <li><a href="#spanning-tests" id="toc-spanning-tests" class="nav-link" data-scroll-target="#spanning-tests"><span class="header-section-number">19.9.3</span> Spanning Tests</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-vietnam" id="toc-sec-factor-con-vietnam" class="nav-link" data-scroll-target="#sec-factor-con-vietnam"><span class="header-section-number">19.10</span> Vietnamese-Specific Considerations</a>
  <ul class="collapse">
  <li><a href="#state-owned-enterprise-classification" id="toc-state-owned-enterprise-classification" class="nav-link" data-scroll-target="#state-owned-enterprise-classification"><span class="header-section-number">19.10.1</span> State-Owned Enterprise Classification</a></li>
  <li><a href="#foreign-ownership-limits" id="toc-foreign-ownership-limits" class="nav-link" data-scroll-target="#foreign-ownership-limits"><span class="header-section-number">19.10.2</span> Foreign Ownership Limits</a></li>
  </ul></li>
  <li><a href="#sec-factor-con-recommendations" id="toc-sec-factor-con-recommendations" class="nav-link" data-scroll-target="#sec-factor-con-recommendations"><span class="header-section-number">19.11</span> Recommended Factor Specifications for Vietnam</a></li>
  <li><a href="#sec-factor-con-summary" id="toc-sec-factor-con-summary" class="nav-link" data-scroll-target="#sec-factor-con-summary"><span class="header-section-number">19.12</span> Summary</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/23_factor_construction_principles.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./20_capm.html">Asset Pricing Models and Cross-Sectional Tests</a></li><li class="breadcrumb-item"><a href="./23_factor_construction_principles.html"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we develop a general-purpose factor construction engine for the Vietnamese equity market. We cover every methodological decision in the pipeline, including universe definition, breakpoint computation, portfolio formation, weighting, rebalancing, and factor return calculation, and demonstrate how each choice affects the resulting factor.</p>
</div>
</div>
<p>The previous chapters introduced specific asset pricing models, including the CAPM, the Fama-French three-factor model, and momentum. Each of those chapters presented its factor as given. This chapter steps behind the curtain and addresses the engineering question: <em>how exactly do you build a factor?</em> The question matters because seemingly minor methodological decisions, such as where to set breakpoints, whether to value-weight or equal-weight, how to handle missing accounting data, which stocks to exclude, can alter the magnitude, statistical significance, and even the sign of a factor premium.</p>
<p>In the U.S. context, <span class="citation" data-cites="fama1993common">Fama and French (<a href="references.html#ref-fama1993common" role="doc-biblioref">1993</a>)</span> established a canonical procedure: sort stocks independently on size and a characteristic, form six value-weighted portfolios from 2×3 intersections, and define the factor as the average return of the two high-characteristic portfolios minus the average return of the two low-characteristic portfolios. This procedure has been replicated thousands of times. But it was designed for the U.S. market circa 1990, with its deep liquidity, broad cross-section, and CRSP/Compustat data infrastructure. Applying it mechanically to Vietnam, a market with 700 listed stocks, extreme illiquidity in the bottom tercile, high concentration in the top decile, and accounting data that arrives with variable lags, requires careful adaptation.</p>
<p><span class="citation" data-cites="hou2020replicating">Hou, Xue, and Zhang (<a href="references.html#ref-hou2020replicating" role="doc-biblioref">2020</a>)</span> replicated 452 anomalies from the U.S. literature and found that over half fail to replicate even in U.S. data with minor methodological variations. The replication crisis in empirical asset pricing makes it essential that researchers understand and document every construction choice. This chapter provides the tools to do so transparently.</p>
<section id="sec-factor-con-pipeline" class="level2" data-number="19.1">
<h2 data-number="19.1" class="anchored" data-anchor-id="sec-factor-con-pipeline"><span class="header-section-number">19.1</span> The Factor Construction Pipeline</h2>
<p>Every tradeable factor follows the same logical pipeline:</p>
<ol type="1">
<li>Define the universe: Select the eligible securities (e.g., common stocks with liquidity and size filters).</li>
<li>Compute the signal: Calculate the characteristic of interest (e.g., value, momentum, profitability).</li>
<li>Set breakpoints: Determine how stocks will be sorted (e.g., median, quintiles, deciles).</li>
<li>Assign portfolios: Group stocks into high and low (or multiple) portfolios based on the signal.</li>
<li>Compute returns: Calculate portfolio returns (equal- or value-weighted).</li>
<li>Construct the factor: Take Long (high) - Short (low).</li>
<li>Validate: Test performance, significance, and robustness.</li>
</ol>
<p>Each step involves choices that interact with each other. A breakpoint that works well for a liquid universe may be inappropriate for the full cross-section. A weighting scheme that reduces noise in the U.S. may amplify it in Vietnam. We address each step systematically.</p>
</section>
<section id="sec-factor-con-data" class="level2" data-number="19.2">
<h2 data-number="19.2" class="anchored" data-anchor-id="sec-factor-con-data"><span class="header-section-number">19.2</span> Data Construction</h2>
<div id="setup" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="data-load" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (survivorship-bias-free)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_outstanding'</span>, <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_zero_volume_days'</span>, <span class="st">'exchange'</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Annual accounting data</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>accounting <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2006-01-01'</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_assets'</span>, <span class="st">'total_equity'</span>, <span class="st">'book_equity'</span>,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">'net_income'</span>, <span class="st">'revenue'</span>, <span class="st">'gross_profit'</span>,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">'operating_profit'</span>, <span class="st">'total_debt'</span>, <span class="st">'retained_earnings'</span>,</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">'dividends_paid'</span>, <span class="st">'capex'</span>, <span class="st">'depreciation'</span>,</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_outstanding_fy'</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily prices for momentum and volatility signals</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>daily <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>, <span class="st">'turnover_value'</span>]</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>monthly[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(monthly[<span class="st">'month_end'</span>])</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> monthly.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(monthly)<span class="sc">:,}</span><span class="ss"> firm-months"</span>)</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accounting: </span><span class="sc">{</span><span class="bu">len</span>(accounting)<span class="sc">:,}</span><span class="ss"> firm-years"</span>)</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique tickers: </span><span class="sc">{</span>monthly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-factor-con-universe" class="level2" data-number="19.3">
<h2 data-number="19.3" class="anchored" data-anchor-id="sec-factor-con-universe"><span class="header-section-number">19.3</span> Step 1: Universe Definition</h2>
<p>The first and most consequential choice is which stocks enter the factor construction universe. The universe definition determines what population the factor premium describes and whether it is implementable.</p>
<section id="the-universe-problem-in-vietnam" class="level3" data-number="19.3.1">
<h3 data-number="19.3.1" class="anchored" data-anchor-id="the-universe-problem-in-vietnam"><span class="header-section-number">19.3.1</span> The Universe Problem in Vietnam</h3>
<p>Vietnam presents a specific challenge: the cross-section is small (600-800 stocks on HOSE and HNX combined), and the size distribution is extremely skewed. The top 10 stocks by market capitalization account for roughly 50% of the total market cap on HOSE. The bottom tercile consists of micro-cap stocks that often trade fewer than 5 days per month. Including these stocks inflates apparent factor premia because their prices are noisy and stale, but excluding them shrinks the already small cross-section.</p>
<div id="universe-filters" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_universe_filters(df, filters<span class="op">=</span><span class="st">'standard'</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply universe filters to the monthly return panel.</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">    filters : str</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">        'none': all stocks</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">        'minimal': exclude zero market cap and extreme returns</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'standard': + minimum listing age + positive volume</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">        'strict': + minimum market cap + minimum turnover</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Filtered DataFrame with 'in_universe' column</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> df.copy()</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    d[<span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Always: remove missing returns and market cap</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    d.loc[d[<span class="st">'monthly_return'</span>].isna(), <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    d.loc[d[<span class="st">'market_cap'</span>].isna() <span class="op">|</span> (d[<span class="st">'market_cap'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>), <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Minimal: winsorize extreme returns (likely data errors)</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="kw">in</span> [<span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'monthly_return'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.0</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standard: listing age &gt;= 6 months</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="kw">in</span> [<span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>        d[<span class="st">'listing_age'</span>] <span class="op">=</span> (</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>            d.groupby(<span class="st">'ticker'</span>).cumcount() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'listing_age'</span>] <span class="op">&lt;</span> <span class="dv">6</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Require at least 10 positive-volume days in the month</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'n_zero_volume_days'</span>] <span class="op">&gt;</span> <span class="dv">12</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Strict: minimum market cap (20th percentile of HOSE)</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="op">==</span> <span class="st">'strict'</span>:</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>        mcap_threshold <span class="op">=</span> (</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>            d[d[<span class="st">'exchange'</span>] <span class="op">==</span> <span class="st">'HOSE'</span>]</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.quantile(<span class="fl">0.20</span>))</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply HOSE threshold to all stocks</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>        d[<span class="st">'mcap_threshold'</span>] <span class="op">=</span> (</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>            d.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.quantile(<span class="fl">0.20</span>))</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'market_cap'</span>] <span class="op">&lt;</span> d[<span class="st">'mcap_threshold'</span>], <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Minimum average daily turnover (VND 200 million)</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'turnover_value_avg_20d'</span>] <span class="op">&lt;</span> <span class="fl">2e8</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply all filter levels and compare</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>filter_summary <span class="op">=</span> {}</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'none'</span>, <span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    in_univ <span class="op">=</span> filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    filter_summary[level] <span class="op">=</span> {</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Firm-months'</span>: <span class="bu">len</span>(in_univ),</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg stocks/month'</span>: in_univ.groupby(<span class="st">'month_end'</span>)[<span class="st">'ticker'</span>].nunique().mean(),</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg MCap coverage (%)'</span>: (</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>            in_univ.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> filtered.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>        ).mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>filter_df <span class="op">=</span> pd.DataFrame(filter_summary).T</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Universe Filter Effects:"</span>)</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filter_df.<span class="bu">round</span>(<span class="dv">1</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-universe-size" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="5">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-universe-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>colors_filter <span class="op">=</span> {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'none'</span>: <span class="st">'#BDC3C7'</span>, <span class="st">'minimal'</span>: <span class="st">'#3498DB'</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'standard'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'strict'</span>: <span class="st">'#C0392B'</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'none'</span>, <span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> (</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'ticker'</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(counts.index, counts.values,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>colors_filter[level], linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span>level)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Stocks'</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Universe Size'</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Market cap coverage</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    total_mcap <span class="op">=</span> filtered.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    filtered_mcap <span class="op">=</span> (</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    coverage <span class="op">=</span> (filtered_mcap <span class="op">/</span> total_mcap <span class="op">*</span> <span class="dv">100</span>).dropna()</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(coverage.index, coverage.values,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>colors_filter[level], linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span>level)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Market Cap Coverage (%)'</span>)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Market Capitalization Coverage'</span>)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim([<span class="dv">60</span>, <span class="dv">102</span>])</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-universe-size-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.1
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-con-signals" class="level2" data-number="19.4">
<h2 data-number="19.4" class="anchored" data-anchor-id="sec-factor-con-signals"><span class="header-section-number">19.4</span> Step 2: Signal Construction</h2>
<section id="point-in-time-accounting-data" class="level3" data-number="19.4.1">
<h3 data-number="19.4.1" class="anchored" data-anchor-id="point-in-time-accounting-data"><span class="header-section-number">19.4.1</span> Point-in-Time Accounting Data</h3>
<p>As discussed in the missing data chapter, accounting signals must be aligned with their public availability date to avoid look-ahead bias. We implement a general-purpose point-in-time merge:</p>
<div id="pit-merge" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pit_merge_accounting(monthly_df, accounting_df, lag_months<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge accounting data with monthly returns respecting</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    the point-in-time availability constraint.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese annual reports are due within 90 days of fiscal</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    year-end. We use a conservative 4-month lag.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">    lag_months : int</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of months after fiscal year-end before data</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">        are assumed to be publicly available.</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> accounting_df.copy()</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accounting data becomes available lag_months after FY end</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If filing_date is available, use it; otherwise use FY-end + lag</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'filing_date'</span> <span class="kw">in</span> acc.columns:</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'filing_date'</span>] <span class="op">=</span> pd.to_datetime(acc[<span class="st">'filing_date'</span>])</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> acc[<span class="st">'filing_date'</span>]</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback for missing filing dates</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'fy_end'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> acc[<span class="st">'available_date'</span>].fillna(</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fy_end'</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each firm-month, find the most recent available accounting data</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> monthly_df.copy()</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Efficient approach: for June rebalancing, use FY t-1 data</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is available by April of year t (4-month lag)</span></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'year'</span>] <span class="op">=</span> merged[<span class="st">'month_end'</span>].dt.year</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'month'</span>] <span class="op">=</span> merged[<span class="st">'month_end'</span>].dt.month</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map: if month &gt;= (lag_months + 1), use current year's FY-1 data</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Otherwise, use FY-2 data</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'data_fy'</span>] <span class="op">=</span> np.where(</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'month'</span>] <span class="op">&gt;=</span> lag_months <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'year'</span>] <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'year'</span>] <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>    acc_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> acc.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>                [<span class="st">'filing_date'</span>, <span class="st">'available_date'</span>, <span class="st">'fy_end'</span>]]</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        acc[acc_cols].rename(columns<span class="op">=</span>{<span class="st">'fiscal_year'</span>: <span class="st">'data_fy'</span>}),</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'data_fy'</span>],</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply point-in-time merge</span></span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> pit_merge_accounting(monthly, accounting, lag_months<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct common signals</span></span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'market_cap'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a><span class="co"># Book-to-market</span></span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'bm'</span>] <span class="op">=</span> panel[<span class="st">'book_equity'</span>] <span class="op">/</span> panel[<span class="st">'market_cap'</span>]</span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a>panel.loc[panel[<span class="st">'bm'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">'bm'</span>] <span class="op">=</span> np.nan  <span class="co"># Negative BE firms</span></span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Gross profitability (Novy-Marx 2013)</span></span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'gp_at'</span>] <span class="op">=</span> panel[<span class="st">'gross_profit'</span>] <span class="op">/</span> panel[<span class="st">'total_assets'</span>]</span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Operating profitability (Fama-French 2015)</span></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'op'</span>] <span class="op">=</span> panel[<span class="st">'operating_profit'</span>] <span class="op">/</span> panel[<span class="st">'book_equity'</span>]</span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Investment (asset growth)</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'investment'</span>] <span class="op">=</span> (</span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a>    panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'total_assets'</span>]</span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a>    .pct_change(periods<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="co"># Leverage</span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'leverage'</span>] <span class="op">=</span> panel[<span class="st">'total_debt'</span>] <span class="op">/</span> panel[<span class="st">'total_assets'</span>]</span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Signal Coverage:"</span>)</span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> [<span class="st">'bm'</span>, <span class="st">'gp_at'</span>, <span class="st">'op'</span>, <span class="st">'investment'</span>, <span class="st">'leverage'</span>]:</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>sig<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>pct<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="momentum-and-volatility-signals" class="level3" data-number="19.4.2">
<h3 data-number="19.4.2" class="anchored" data-anchor-id="momentum-and-volatility-signals"><span class="header-section-number">19.4.2</span> Momentum and Volatility Signals</h3>
<p>Price-based signals require return history, not accounting data, so they have different timing requirements.</p>
<div id="price-signals" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Past returns for momentum signals</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Momentum: cumulative return from month t-12 to t-2 (skip most recent month)</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'ret_12_2'</span>] <span class="op">=</span> (</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    .transform(<span class="kw">lambda</span> x: x.shift(<span class="dv">2</span>).rolling(<span class="dv">11</span>).<span class="bu">apply</span>(</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (<span class="dv">1</span> <span class="op">+</span> r).prod() <span class="op">-</span> <span class="dv">1</span>, raw<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Short-term reversal: month t-1 return</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'ret_1'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Idiosyncratic volatility (from daily data, rolling 60 days)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>daily[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(daily[<span class="st">'date'</span>])</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>daily[<span class="st">'daily_return'</span>] <span class="op">=</span> daily.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>].pct_change()</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>ivol <span class="op">=</span> (</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    daily.groupby(<span class="st">'ticker'</span>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: g.set_index(<span class="st">'date'</span>)[<span class="st">'daily_return'</span>]</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>           .rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">40</span>).std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>))</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'ivol'</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>ivol[<span class="st">'month_end'</span>] <span class="op">=</span> ivol[<span class="st">'date'</span>].dt.to_period(<span class="st">'M'</span>).dt.to_timestamp(<span class="st">'M'</span>)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>ivol_monthly <span class="op">=</span> (</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    ivol.groupby([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])[<span class="st">'ivol'</span>]</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    .last()</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.merge(ivol_monthly, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Price Signal Coverage:"</span>)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> [<span class="st">'ret_12_2'</span>, <span class="st">'ret_1'</span>, <span class="st">'ivol'</span>]:</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>sig<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>pct<span class="sc">:.1%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-con-breakpoints" class="level2" data-number="19.5">
<h2 data-number="19.5" class="anchored" data-anchor-id="sec-factor-con-breakpoints"><span class="header-section-number">19.5</span> Step 3: Breakpoint Computation</h2>
<section id="the-breakpoint-decision" class="level3" data-number="19.5.1">
<h3 data-number="19.5.1" class="anchored" data-anchor-id="the-breakpoint-decision"><span class="header-section-number">19.5.1</span> The Breakpoint Decision</h3>
<p>Breakpoints determine which stocks are “high” versus “low” on a given characteristic. The two key choices are:</p>
<ol type="1">
<li><strong>Breakpoint universe:</strong> Should breakpoints be computed from all stocks or from a subset (e.g., HOSE only)?</li>
<li><strong>Number of groups:</strong> 2×3 (Fama-French standard), 5×5 (for finer sorts), or independent terciles/quintiles?</li>
</ol>
<p><span class="citation" data-cites="fama1993common">Fama and French (<a href="references.html#ref-fama1993common" role="doc-biblioref">1993</a>)</span> use NYSE breakpoints for U.S. sorts because this prevents the large number of small Nasdaq/AMEX stocks from dominating the breakpoint distribution. The analog in Vietnam is to use HOSE breakpoints, since HOSE lists the larger, more liquid firms and HNX lists smaller firms. Using all-stock breakpoints would place most HOSE stocks in the upper size groups and most HNX stocks in the lower groups, producing mechanically different results.</p>
<div id="breakpoints" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_breakpoints(df, signal_col, n_groups, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                          exchange_col<span class="op">=</span><span class="st">'exchange'</span>):</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute cross-sectional breakpoints for portfolio sorting.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co">    bp_universe : str</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">        'all': use all stocks in universe</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co">        'hose': use only HOSE stocks (analogous to NYSE breakpoints)</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">    n_groups : int</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of groups (2, 3, 5, or 10)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Series of breakpoints (quantiles)</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    signal <span class="op">=</span> df[signal_col].dropna()</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bp_universe <span class="op">==</span> <span class="st">'hose'</span>:</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df[exchange_col] <span class="op">==</span> <span class="st">'HOSE'</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> df.loc[mask, signal_col].dropna()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    quantiles <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, n_groups <span class="op">+</span> <span class="dv">1</span>)[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    breakpoints <span class="op">=</span> signal.quantile(quantiles)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> breakpoints</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: compare HOSE vs all-stock breakpoints for book-to-market</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>example_month <span class="op">=</span> panel[panel[<span class="st">'month_end'</span>] <span class="op">==</span> <span class="st">'2023-06-30'</span>].copy()</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>example_month <span class="op">=</span> example_month[example_month[<span class="st">'bm'</span>].notna()]</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>bp_hose <span class="op">=</span> compute_breakpoints(example_month, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>bp_all <span class="op">=</span> compute_breakpoints(example_month, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BM Tercile Breakpoints (June 2023):"</span>)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  HOSE-only: </span><span class="sc">{</span>bp_hose<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  All stocks: </span><span class="sc">{</span>bp_all<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Difference: HOSE breakpoints are "</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'higher'</span> <span class="cf">if</span> bp_hose<span class="sc">.</span>values[<span class="dv">0</span>] <span class="op">&gt;</span> bp_all<span class="sc">.</span>values[<span class="dv">0</span>] <span class="cf">else</span> <span class="st">'lower'</span><span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"than all-stock breakpoints"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-breakpoints" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="9">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-breakpoints-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute breakpoints for every month</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>bp_comparison <span class="op">=</span> []</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> month, group <span class="kw">in</span> panel.dropna(subset<span class="op">=</span>[<span class="st">'bm'</span>]).groupby(<span class="st">'month_end'</span>):</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    bp_h <span class="op">=</span> compute_breakpoints(group, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    bp_a <span class="op">=</span> compute_breakpoints(group, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count stocks in each tercile under each rule</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bp_name, bp_vals <span class="kw">in</span> [(<span class="st">'HOSE'</span>, bp_h), (<span class="st">'All'</span>, bp_a)]:</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        low <span class="op">=</span> (group[<span class="st">'bm'</span>] <span class="op">&lt;=</span> bp_vals.iloc[<span class="dv">0</span>]).<span class="bu">sum</span>()</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>        mid <span class="op">=</span> ((group[<span class="st">'bm'</span>] <span class="op">&gt;</span> bp_vals.iloc[<span class="dv">0</span>]) <span class="op">&amp;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>               (group[<span class="st">'bm'</span>] <span class="op">&lt;=</span> bp_vals.iloc[<span class="dv">1</span>])).<span class="bu">sum</span>()</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        high <span class="op">=</span> (group[<span class="st">'bm'</span>] <span class="op">&gt;</span> bp_vals.iloc[<span class="dv">1</span>]).<span class="bu">sum</span>()</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        bp_comparison.append({</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month, <span class="st">'bp_rule'</span>: bp_name,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_bp'</span>: bp_vals.iloc[<span class="dv">0</span>],</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_low'</span>: low, <span class="st">'n_mid'</span>: mid, <span class="st">'n_high'</span>: high</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>bp_df <span class="op">=</span> pd.DataFrame(bp_comparison)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Median breakpoint over time</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rule, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'All'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> bp_df[bp_df[<span class="st">'bp_rule'</span>] <span class="op">==</span> rule]</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(subset[<span class="st">'month_end'</span>], subset[<span class="st">'median_bp'</span>],</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>rule<span class="sc">}</span><span class="ss"> breakpoints'</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Lower Tercile Breakpoint (BM)'</span>)</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Breakpoint Time Series'</span>)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of stocks in high BM group</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rule, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'All'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> bp_df[bp_df[<span class="st">'bp_rule'</span>] <span class="op">==</span> rule]</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(subset[<span class="st">'month_end'</span>], subset[<span class="st">'n_high'</span>],</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>rule<span class="sc">}</span><span class="ss"> breakpoints'</span>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Stocks in High BM Group'</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: High BM Portfolio Size'</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-breakpoints-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.2
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-con-formation" class="level2" data-number="19.6">
<h2 data-number="19.6" class="anchored" data-anchor-id="sec-factor-con-formation"><span class="header-section-number">19.6</span> Step 4: Portfolio Formation</h2>
<section id="the-generic-factor-engine" class="level3" data-number="19.6.1">
<h3 data-number="19.6.1" class="anchored" data-anchor-id="the-generic-factor-engine"><span class="header-section-number">19.6.1</span> The Generic Factor Engine</h3>
<p>We implement a general-purpose factor construction function that takes any signal column and produces a long-short factor return series. The function encapsulates all methodological choices as parameters, making it easy to test sensitivity.</p>
<div id="factor-engine" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_factor(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    panel_df,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    signal_col,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    size_col<span class="op">=</span><span class="st">'market_cap'</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    return_col<span class="op">=</span><span class="st">'monthly_return'</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    date_col<span class="op">=</span><span class="st">'month_end'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    exchange_col<span class="op">=</span><span class="st">'exchange'</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    independent_sorts<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    min_stocks_per_portfolio<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    signal_lag<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    universe_filter<span class="op">=</span><span class="st">'standard'</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct a tradeable factor following the Fama-French methodology.</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="co">    signal_col : str</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Column with the sorting variable.</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="co">    formation_month : int</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co">        Month of year for portfolio formation (6 = June for FF).</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">    rebalance_freq : str</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">        'annual' (FF standard), 'semi', 'quarterly', 'monthly'.</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">    n_signal_groups : int</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of signal groups (3 for FF standard, 5 for quintiles).</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">    n_size_groups : int</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of size groups (2 for FF standard).</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co">    weighting : str</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co">        'value' (VW) or 'equal' (EW).</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="co">    bp_universe : str</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="co">        'hose' or 'all' for breakpoint computation.</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="co">    independent_sorts : bool</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co">        True for independent double sorts (FF standard).</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="co">    long_group : str</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="co">        'high' or 'low'—which signal group is the long leg.</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="co">    signal_lag : int</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="co">        Additional months to lag the signal beyond the</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="co">        standard point-in-time alignment.</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a><span class="co">    Dictionary with 'factor_returns', 'portfolio_returns',</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co">    'diagnostics'.</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> panel_df.copy()</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply universe filter</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> apply_universe_filters(df, filters<span class="op">=</span>universe_filter)</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'in_universe'</span>]].copy()</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the signal if requested</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> signal_lag <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        df[signal_col] <span class="op">=</span> (</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>            df.groupby(<span class="st">'ticker'</span>)[signal_col].shift(signal_lag)</span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine formation dates</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rebalance_freq <span class="op">==</span> <span class="st">'annual'</span>:</span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form portfolios in formation_month, hold for 12 months</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col].<span class="bu">apply</span>(</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> d: pd.Timestamp(</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>                year<span class="op">=</span>d.year <span class="cf">if</span> d.month <span class="op">&gt;=</span> formation_month <span class="cf">else</span> d.year <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>                month<span class="op">=</span>formation_month, day<span class="op">=</span><span class="dv">30</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebalance_freq <span class="op">==</span> <span class="st">'monthly'</span>:</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col] <span class="op">-</span> pd.DateOffset(months<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebalance_freq <span class="op">==</span> <span class="st">'quarterly'</span>:</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col].<span class="bu">apply</span>(</span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> d: pd.Timestamp(</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>                year<span class="op">=</span>d.year,</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>                month<span class="op">=</span>((d.month <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">3</span>) <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>                day<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>            ) <span class="op">-</span> pd.DateOffset(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign signal and size groups at each formation date</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> []</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    formation_dates <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">'formation_date'</span>].unique())</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f_date <span class="kw">in</span> formation_dates:</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stocks available at formation</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>        formation_data <span class="op">=</span> df[df[<span class="st">'formation_date'</span>] <span class="op">==</span> f_date].copy()</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get signal values at formation</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> formation_data.dropna(subset<span class="op">=</span>[signal_col, size_col])</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> min_stocks_per_portfolio <span class="op">*</span> n_signal_groups <span class="op">*</span> n_size_groups:</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute breakpoints</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        size_bp <span class="op">=</span> compute_breakpoints(</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>            available, size_col, n_size_groups, bp_universe</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        signal_bp <span class="op">=</span> compute_breakpoints(</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>            available, signal_col, n_signal_groups, bp_universe</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign groups</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        available[<span class="st">'size_group'</span>] <span class="op">=</span> np.searchsorted(</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>            size_bp.values, available[size_col].values</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>        available[<span class="st">'signal_group'</span>] <span class="op">=</span> np.searchsorted(</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>            signal_bp.values, available[signal_col].values</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        all_portfolios.append(available)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> all_portfolios:</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> pd.concat(all_portfolios, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute portfolio returns</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> weighted_return(group):</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weighting <span class="op">==</span> <span class="st">'value'</span>:</span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> group[size_col].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.average(group[return_col], weights<span class="op">=</span>group[size_col])</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> group[return_col].mean()</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> group[return_col].mean()</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    port_returns <span class="op">=</span> (</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>        portfolios</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>        .groupby([date_col, <span class="st">'size_group'</span>, <span class="st">'signal_group'</span>])</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(weighted_return)</span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">'port_return'</span>)</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct factor: average of high-signal portfolios minus</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average of low-signal portfolios (across size groups)</span></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>    high_label <span class="op">=</span> n_signal_groups <span class="op">-</span> <span class="dv">1</span> <span class="cf">if</span> long_group <span class="op">==</span> <span class="st">'high'</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>    low_label <span class="op">=</span> <span class="dv">0</span> <span class="cf">if</span> long_group <span class="op">==</span> <span class="st">'high'</span> <span class="cf">else</span> n_signal_groups <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>    high_ports <span class="op">=</span> port_returns[port_returns[<span class="st">'signal_group'</span>] <span class="op">==</span> high_label]</span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>    low_ports <span class="op">=</span> port_returns[port_returns[<span class="st">'signal_group'</span>] <span class="op">==</span> low_label]</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    high_avg <span class="op">=</span> high_ports.groupby(date_col)[<span class="st">'port_return'</span>].mean()</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>    low_avg <span class="op">=</span> low_ports.groupby(date_col)[<span class="st">'port_return'</span>].mean()</span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>    factor_returns <span class="op">=</span> (high_avg <span class="op">-</span> low_avg).to_frame(<span class="st">'factor_return'</span>)</span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Diagnostics</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>    port_counts <span class="op">=</span> (</span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>        portfolios</span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>        .groupby([date_col, <span class="st">'size_group'</span>, <span class="st">'signal_group'</span>])[<span class="st">'ticker'</span>]</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">'n_stocks'</span>)</span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>    diagnostics <span class="op">=</span> {</span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_stocks_per_portfolio'</span>: port_counts[<span class="st">'n_stocks'</span>].mean(),</span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_stocks_per_portfolio'</span>: port_counts[<span class="st">'n_stocks'</span>].<span class="bu">min</span>(),</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ann_return'</span>: factor_returns[<span class="st">'factor_return'</span>].mean() <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ann_vol'</span>: factor_returns[<span class="st">'factor_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>),</span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sharpe'</span>: (factor_returns[<span class="st">'factor_return'</span>].mean()</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>                   <span class="op">/</span> factor_returns[<span class="st">'factor_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)),</span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat'</span>: (factor_returns[<span class="st">'factor_return'</span>].mean()</span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>                   <span class="op">/</span> (factor_returns[<span class="st">'factor_return'</span>].std()</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>                      <span class="op">/</span> np.sqrt(<span class="bu">len</span>(factor_returns)))),</span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_months'</span>: <span class="bu">len</span>(factor_returns)</span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor_returns'</span>: factor_returns,</span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>        <span class="st">'portfolio_returns'</span>: port_returns,</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>        <span class="st">'portfolios'</span>: portfolios,</span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>        <span class="st">'diagnostics'</span>: diagnostics</span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>    }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="building-the-core-factors" class="level3" data-number="19.6.2">
<h3 data-number="19.6.2" class="anchored" data-anchor-id="building-the-core-factors"><span class="header-section-number">19.6.2</span> Building the Core Factors</h3>
<p>We now use the engine to construct the standard Fama-French factors for Vietnam:</p>
<div id="core-factors" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># SMB (Size): small minus big</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Signal = market cap; long_group = 'low' (small stocks)</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>smb_result <span class="op">=</span> construct_factor(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'log_mcap'</span>, long_group<span class="op">=</span><span class="st">'low'</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">2</span>, n_size_groups<span class="op">=</span><span class="dv">1</span>,  <span class="co"># No double sort for size itself</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># HML (Value): high BM minus low BM</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>hml_result <span class="op">=</span> construct_factor(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># RMW (Profitability): robust minus weak</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>rmw_result <span class="op">=</span> construct_factor(</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'op'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># CMA (Investment): conservative minus aggressive</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>cma_result <span class="op">=</span> construct_factor(</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'investment'</span>, long_group<span class="op">=</span><span class="st">'low'</span>,</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co"># WML (Momentum): winners minus losers</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>wml_result <span class="op">=</span> construct_factor(</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'ret_12_2'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'monthly'</span>,</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary table</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Vietnamese Factor Summary:"</span>)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ann. Ret'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ann. Vol'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Sharpe'</span><span class="sc">:&gt;8}</span><span class="ss"> "</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'t-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Avg N'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">54</span>)</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'ann_return'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'ann_vol'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>d[<span class="st">'sharpe'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'t_stat'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> "</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>d[<span class="st">'avg_stocks_per_portfolio'</span>]<span class="sc">:&gt;8.1f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="fig-factor-cumulative" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="12">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-factor-cumulative-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>factor_colors <span class="op">=</span> {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SMB'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'HML'</span>: <span class="st">'#C0392B'</span>, <span class="st">'RMW'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CMA'</span>: <span class="st">'#E67E22'</span>, <span class="st">'WML'</span>: <span class="st">'#8E44AD'</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> result[<span class="st">'factor_returns'</span>]</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> fr[<span class="st">'factor_return'</span>]).cumprod()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum.index, cum.values, color<span class="op">=</span>factor_colors[name],</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span>name)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Cumulative Return'</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Vietnamese Factor Cumulative Returns (2×3 VW, HOSE Breakpoints)'</span>)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>ax.legend(ncol<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-factor-cumulative-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.3
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-con-sensitivity" class="level2" data-number="19.7">
<h2 data-number="19.7" class="anchored" data-anchor-id="sec-factor-con-sensitivity"><span class="header-section-number">19.7</span> Step 5: Sensitivity to Construction Choices</h2>
<p>The most important lesson in factor construction is that the resulting factor premium is <em>not</em> uniquely determined by the economic hypothesis; it depends substantially on implementation choices. We systematically vary each choice and examine how the factor changes.</p>
<section id="weighting-value-weighted-vs.-equal-weighted" class="level3" data-number="19.7.1">
<h3 data-number="19.7.1" class="anchored" data-anchor-id="weighting-value-weighted-vs.-equal-weighted"><span class="header-section-number">19.7.1</span> Weighting: Value-Weighted vs.&nbsp;Equal-Weighted</h3>
<div id="vw-vs-ew" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>sensitivity_results <span class="op">=</span> {}</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, signal, long_grp <span class="kw">in</span> [</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'HML'</span>, <span class="st">'bm'</span>, <span class="st">'high'</span>), (<span class="st">'RMW'</span>, <span class="st">'op'</span>, <span class="st">'high'</span>), (<span class="st">'WML'</span>, <span class="st">'ret_12_2'</span>, <span class="st">'high'</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> wt <span class="kw">in</span> [<span class="st">'value'</span>, <span class="st">'equal'</span>]:</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> construct_factor(</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>            panel, signal_col<span class="op">=</span>signal, long_group<span class="op">=</span>long_grp,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>            weighting<span class="op">=</span>wt, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> name <span class="op">!=</span> <span class="st">'WML'</span> <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result:</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>            d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>            sensitivity_results[<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>wt<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> {</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Factor'</span>: name, <span class="st">'Weighting'</span>: wt,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>sens_df <span class="op">=</span> pd.DataFrame(sensitivity_results).T</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VW vs EW Factor Returns:"</span>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sens_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="breakpoint-universe-hose-vs.-all-stocks" class="level3" data-number="19.7.2">
<h3 data-number="19.7.2" class="anchored" data-anchor-id="breakpoint-universe-hose-vs.-all-stocks"><span class="header-section-number">19.7.2</span> Breakpoint Universe: HOSE vs.&nbsp;All Stocks</h3>
<div id="bp-sensitivity" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, signal, long_grp <span class="kw">in</span> [</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'HML'</span>, <span class="st">'bm'</span>, <span class="st">'high'</span>), (<span class="st">'WML'</span>, <span class="st">'ret_12_2'</span>, <span class="st">'high'</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bp <span class="kw">in</span> [<span class="st">'hose'</span>, <span class="st">'all'</span>]:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> construct_factor(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            panel, signal_col<span class="op">=</span>signal, long_group<span class="op">=</span>long_grp,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>            bp_universe<span class="op">=</span>bp, weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>            rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> name <span class="op">!=</span> <span class="st">'WML'</span> <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>            d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>            sensitivity_results[<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_bp_</span><span class="sc">{</span>bp<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> {</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Factor'</span>: name, <span class="st">'Breakpoints'</span>: bp,</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>],</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Avg N'</span>: d[<span class="st">'avg_stocks_per_portfolio'</span>]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>bp_sens <span class="op">=</span> pd.DataFrame({k: v <span class="cf">for</span> k, v <span class="kw">in</span> sensitivity_results.items()</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>                          <span class="cf">if</span> <span class="st">'bp_'</span> <span class="kw">in</span> k}).T</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Breakpoint Universe Sensitivity:"</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bp_sens.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="number-of-groups-23-vs.-55-vs.-deciles" class="level3" data-number="19.7.3">
<h3 data-number="19.7.3" class="anchored" data-anchor-id="number-of-groups-23-vs.-55-vs.-deciles"><span class="header-section-number">19.7.3</span> Number of Groups: 2×3 vs.&nbsp;5×5 vs.&nbsp;Deciles</h3>
<div id="group-sensitivity" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>group_configs <span class="op">=</span> [</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">3</span>, <span class="st">'2x3 (FF standard)'</span>),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">5</span>, <span class="st">'2x5 (quintiles)'</span>),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">10</span>, <span class="st">'1x10 (deciles)'</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>group_results <span class="op">=</span> {}</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_size, n_signal, label <span class="kw">in</span> group_configs:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span>n_size, n_signal_groups<span class="op">=</span>n_signal,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        group_results[label] <span class="op">=</span> {</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>],</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Avg N per port'</span>: d[<span class="st">'avg_stocks_per_portfolio'</span>],</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Min N per port'</span>: d[<span class="st">'min_stocks_per_portfolio'</span>]</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML: Sorting Granularity Sensitivity:"</span>)</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(group_results).T.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="rebalancing-frequency" class="level3" data-number="19.7.4">
<h3 data-number="19.7.4" class="anchored" data-anchor-id="rebalancing-frequency"><span class="header-section-number">19.7.4</span> Rebalancing Frequency</h3>
<div id="rebalance-sensitivity" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>rebal_results <span class="op">=</span> {}</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> freq <span class="kw">in</span> [<span class="st">'annual'</span>, <span class="st">'quarterly'</span>, <span class="st">'monthly'</span>]:</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span>freq, weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>        rebal_results[freq] <span class="op">=</span> {</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Vol'</span>: d[<span class="st">'ann_vol'</span>],</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML: Rebalancing Frequency Sensitivity:"</span>)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(rebal_results).T.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="comprehensive-sensitivity-summary" class="level3" data-number="19.7.5">
<h3 data-number="19.7.5" class="anchored" data-anchor-id="comprehensive-sensitivity-summary"><span class="header-section-number">19.7.5</span> Comprehensive Sensitivity Summary</h3>
<div id="fig-sensitivity-heatmap" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="17">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-sensitivity-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Systematic grid search for HML</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>configs <span class="op">=</span> <span class="bu">list</span>(product(</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'value'</span>, <span class="st">'equal'</span>],        <span class="co"># Weighting</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'hose'</span>, <span class="st">'all'</span>],           <span class="co"># Breakpoint universe</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    [(<span class="dv">2</span>, <span class="dv">3</span>), (<span class="dv">2</span>, <span class="dv">5</span>), (<span class="dv">1</span>, <span class="dv">10</span>)]  <span class="co"># (n_size, n_signal)</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>grid_results <span class="op">=</span> []</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> wt, bp, (ns, nsig) <span class="kw">in</span> configs:</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span>wt, bp_universe<span class="op">=</span>bp,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span>ns, n_signal_groups<span class="op">=</span>nsig,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>        grid_results.append({</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Weighting'</span>: <span class="st">'VW'</span> <span class="cf">if</span> wt <span class="op">==</span> <span class="st">'value'</span> <span class="cf">else</span> <span class="st">'EW'</span>,</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Breakpoints'</span>: bp.upper(),</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Sort'</span>: <span class="ss">f'</span><span class="sc">{</span>ns<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>nsig<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> pd.DataFrame(grid_results)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML Factor: Full Sensitivity Grid:"</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(grid_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot for heatmap</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> grid_df.pivot_table(</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span><span class="st">'Ann. Return'</span>, index<span class="op">=</span>[<span class="st">'Weighting'</span>, <span class="st">'Breakpoints'</span>],</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">'Sort'</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>sns.heatmap(pivot <span class="op">*</span> <span class="dv">100</span>, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'.1f'</span>, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>,</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>, linewidths<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax,</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Ann. Return (%)'</span>})</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'HML Premium: Sensitivity to Construction Choices'</span>)</span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-sensitivity-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.4
</figcaption>
</figure>
</div>
</section>
</section>
<section id="sec-factor-con-correlation" class="level2" data-number="19.8">
<h2 data-number="19.8" class="anchored" data-anchor-id="sec-factor-con-correlation"><span class="header-section-number">19.8</span> Factor Correlation Structure</h2>
<div id="fig-factor-correlations" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="18">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-factor-correlations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all factor return series</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>factor_panel <span class="op">=</span> pd.DataFrame()</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> result[<span class="st">'factor_returns'</span>].rename(columns<span class="op">=</span>{<span class="st">'factor_return'</span>: name})</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> factor_panel.empty:</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        factor_panel <span class="op">=</span> fr</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>        factor_panel <span class="op">=</span> factor_panel.merge(fr, left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>                                           right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> factor_panel.corr()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">6</span>))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.triu(np.ones_like(corr, dtype<span class="op">=</span><span class="bu">bool</span>), k<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>sns.heatmap(corr, mask<span class="op">=</span>mask, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'.2f'</span>, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>,</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>, square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>            linewidths<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Factor Return Correlations'</span>)</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-factor-correlations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.5
</figcaption>
</figure>
</div>
</section>
<section id="sec-factor-con-validation" class="level2" data-number="19.9">
<h2 data-number="19.9" class="anchored" data-anchor-id="sec-factor-con-validation"><span class="header-section-number">19.9</span> Factor Validation</h2>
<p>A well-constructed factor should pass several diagnostic tests before being used in asset pricing research.</p>
<section id="diagnostic-checklist" class="level3" data-number="19.9.1">
<h3 data-number="19.9.1" class="anchored" data-anchor-id="diagnostic-checklist"><span class="header-section-number">19.9.1</span> Diagnostic Checklist</h3>
<div id="validation" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_factor(factor_result, name):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Run standard diagnostic tests on a constructed factor.</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> factor_result[<span class="st">'factor_returns'</span>][<span class="st">'factor_return'</span>]</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    diag <span class="op">=</span> factor_result[<span class="st">'diagnostics'</span>]</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    ports <span class="op">=</span> factor_result[<span class="st">'portfolios'</span>]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    tests <span class="op">=</span> {}</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Statistical significance (t &gt; 2)</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'t-stat'</span>] <span class="op">=</span> diag[<span class="st">'t_stat'</span>]</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'t &gt; 2'</span>] <span class="op">=</span> <span class="bu">abs</span>(diag[<span class="st">'t_stat'</span>]) <span class="op">&gt;</span> <span class="fl">2.0</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Economic magnitude</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Ann. Return'</span>] <span class="op">=</span> diag[<span class="st">'ann_return'</span>]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Ann. Vol'</span>] <span class="op">=</span> diag[<span class="st">'ann_vol'</span>]</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Sharpe'</span>] <span class="op">=</span> diag[<span class="st">'sharpe'</span>]</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Adequate portfolio diversification</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Avg N per portfolio'</span>] <span class="op">=</span> diag[<span class="st">'avg_stocks_per_portfolio'</span>]</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min N per portfolio'</span>] <span class="op">=</span> diag[<span class="st">'min_stocks_per_portfolio'</span>]</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min N &gt;= 5'</span>] <span class="op">=</span> diag[<span class="st">'min_stocks_per_portfolio'</span>] <span class="op">&gt;=</span> <span class="dv">5</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Not dominated by a single month</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Max monthly return'</span>] <span class="op">=</span> fr.<span class="bu">max</span>()</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min monthly return'</span>] <span class="op">=</span> fr.<span class="bu">min</span>()</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Fraction &gt; 0'</span>] <span class="op">=</span> (fr <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Persistence (ACF at lag 1)</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(fr) <span class="op">&gt;</span> <span class="dv">12</span>:</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>        tests[<span class="st">'ACF(1)'</span>] <span class="op">=</span> fr.autocorr(lag<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Consistency across subperiods</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    mid <span class="op">=</span> <span class="bu">len</span>(fr) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    first_half <span class="op">=</span> fr.iloc[:mid]</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    second_half <span class="op">=</span> fr.iloc[mid:]</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Return (1st half)'</span>] <span class="op">=</span> first_half.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Return (2nd half)'</span>] <span class="op">=</span> second_half.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Same sign both halves'</span>] <span class="op">=</span> (</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>        np.sign(first_half.mean()) <span class="op">==</span> np.sign(second_half.mean())</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tests</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor Validation Summary:"</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>    tests <span class="op">=</span> validate_factor(result, name)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> test, value <span class="kw">in</span> tests.items():</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">bool</span>):</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> <span class="st">'PASS'</span> <span class="cf">if</span> value <span class="cf">else</span> <span class="st">'FAIL'</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(value, <span class="bu">float</span>):</span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="monotonicity-test" class="level3" data-number="19.9.2">
<h3 data-number="19.9.2" class="anchored" data-anchor-id="monotonicity-test"><span class="header-section-number">19.9.2</span> Monotonicity Test</h3>
<p>A factor built from a characteristic sort should produce monotonically increasing (or decreasing) average returns across quantiles. Violations of monotonicity suggest the signal-return relationship is nonlinear or absent.</p>
<div id="fig-monotonicity" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="20">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-monotonicity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">10</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>signals <span class="op">=</span> [</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'bm'</span>, <span class="st">'Book-to-Market'</span>, <span class="st">'high'</span>),</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'op'</span>, <span class="st">'Operating Profit.'</span>, <span class="st">'high'</span>),</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'investment'</span>, <span class="st">'Investment'</span>, <span class="st">'low'</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'ret_12_2'</span>, <span class="st">'Momentum (12-2)'</span>, <span class="st">'high'</span>),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'ivol'</span>, <span class="st">'Idio. Volatility'</span>, <span class="st">'low'</span>),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (sig, label, long_grp) <span class="kw">in</span> <span class="bu">enumerate</span>(signals):</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span>sig, long_group<span class="op">=</span>long_grp,</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span><span class="dv">1</span>, n_signal_groups<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> sig <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'ret_12_2'</span>] <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> result[<span class="st">'portfolio_returns'</span>]</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>    decile_means <span class="op">=</span> (</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        port_ret.groupby(<span class="st">'signal_group'</span>)[<span class="st">'port_return'</span>]</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>        .mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    colors_mono <span class="op">=</span> plt.cm.RdYlGn_r(np.linspace(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="bu">len</span>(decile_means)))</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    axes[i].bar(<span class="bu">range</span>(<span class="bu">len</span>(decile_means)), decile_means.values,</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>colors_mono, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(decile_means)))</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xticklabels([<span class="ss">f'D</span><span class="sc">{</span>d<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(decile_means))],</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>                             fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Ann. Return (%)'</span>)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(label)</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    axes[i].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">5</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Decile Portfolio Returns by Signal'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-monotonicity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;19.6
</figcaption>
</figure>
</div>
</section>
<section id="spanning-tests" class="level3" data-number="19.9.3">
<h3 data-number="19.9.3" class="anchored" data-anchor-id="spanning-tests"><span class="header-section-number">19.9.3</span> Spanning Tests</h3>
<p>Does a new factor add information beyond existing factors? We test this by regressing each factor on all other factors and examining the intercept (alpha). A significant alpha means the factor captures return variation not spanned by the others:</p>
<div id="spanning" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>factor_names <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> factor_panel.columns <span class="cf">if</span> factor_panel[c].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">24</span>]</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>spanning_data <span class="op">=</span> factor_panel[factor_names].dropna()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Spanning Tests (alpha = intercept when regressed on other factors):"</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Alpha (ann.)'</span><span class="sc">:&gt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R²'</span><span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">36</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> target <span class="kw">in</span> factor_names:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> factor_names <span class="cf">if</span> f <span class="op">!=</span> target]</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> spanning_data[target]</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(spanning_data[others])</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>})</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    alpha_ann <span class="op">=</span> model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    alpha_t <span class="op">=</span> model.tvalues[<span class="st">'const'</span>]</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> model.rsquared</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>target<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>alpha_ann<span class="sc">:&gt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>alpha_t<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>r2<span class="sc">:&gt;6.3f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-con-vietnam" class="level2" data-number="19.10">
<h2 data-number="19.10" class="anchored" data-anchor-id="sec-factor-con-vietnam"><span class="header-section-number">19.10</span> Vietnamese-Specific Considerations</h2>
<section id="state-owned-enterprise-classification" class="level3" data-number="19.10.1">
<h3 data-number="19.10.1" class="anchored" data-anchor-id="state-owned-enterprise-classification"><span class="header-section-number">19.10.1</span> State-Owned Enterprise Classification</h3>
<p>A unique feature of Vietnamese equities is the high proportion of state-owned enterprises (SOEs). The state retains majority or significant minority stakes in many listed firms, which affects governance, information environment, and trading dynamics. Factors may behave differently within SOE and non-SOE subsamples:</p>
<div id="soe-split" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get SOE classification</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>firm_info <span class="op">=</span> client.get_firm_info(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'state_ownership_pct'</span>, <span class="st">'is_soe'</span>]</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>panel_soe <span class="op">=</span> panel.merge(firm_info[[<span class="st">'ticker'</span>, <span class="st">'is_soe'</span>]], on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, subset <span class="kw">in</span> [(<span class="st">'SOE'</span>, panel_soe[panel_soe[<span class="st">'is_soe'</span>] <span class="op">==</span> <span class="va">True</span>]),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                        (<span class="st">'Non-SOE'</span>, panel_soe[panel_soe[<span class="st">'is_soe'</span>] <span class="op">==</span> <span class="va">False</span>])]:</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    hml <span class="op">=</span> construct_factor(</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        subset, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> hml:</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> hml[<span class="st">'diagnostics'</span>]</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"HML (</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">): Ann = </span><span class="sc">{</span>d[<span class="st">'ann_return'</span>]<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"t = </span><span class="sc">{</span>d[<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">, N = </span><span class="sc">{</span>d[<span class="st">'avg_stocks_per_portfolio'</span>]<span class="sc">:.0f}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="foreign-ownership-limits" class="level3" data-number="19.10.2">
<h3 data-number="19.10.2" class="anchored" data-anchor-id="foreign-ownership-limits"><span class="header-section-number">19.10.2</span> Foreign Ownership Limits</h3>
<p>Foreign ownership caps (49% for most sectors, 30% for banking) affect the investable universe for international investors. Factors constructed from the full universe may not be achievable by foreign investors if the long leg concentrates in stocks at the foreign ownership limit:</p>
<div id="foreign-ownership" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>fol <span class="op">=</span> client.get_foreign_ownership(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'foreign_pct'</span>, <span class="st">'foreign_limit_pct'</span>]</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with HML portfolios</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> hml_result:</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    hml_ports <span class="op">=</span> hml_result[<span class="st">'portfolios'</span>].merge(</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>        fol, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    hml_ports[<span class="st">'near_limit'</span>] <span class="op">=</span> (</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>        (hml_ports[<span class="st">'foreign_limit_pct'</span>] <span class="op">-</span> hml_ports[<span class="st">'foreign_pct'</span>]) <span class="op">&lt;</span> <span class="dv">5</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    fol_by_group <span class="op">=</span> (</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>        hml_ports.groupby(<span class="st">'signal_group'</span>)</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>            avg_foreign_pct<span class="op">=</span>(<span class="st">'foreign_pct'</span>, <span class="st">'mean'</span>),</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>            pct_near_limit<span class="op">=</span>(<span class="st">'near_limit'</span>, <span class="st">'mean'</span>)</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Foreign Ownership in HML Portfolios:"</span>)</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(fol_by_group.<span class="bu">round</span>(<span class="dv">3</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
</section>
<section id="sec-factor-con-recommendations" class="level2" data-number="19.11">
<h2 data-number="19.11" class="anchored" data-anchor-id="sec-factor-con-recommendations"><span class="header-section-number">19.11</span> Recommended Factor Specifications for Vietnam</h2>
<p>Based on the sensitivity analysis, we recommend the following baseline specifications (<a href="#tbl-factor-con-recommendations" class="quarto-xref">Table&nbsp;<span>19.1</span></a>).</p>
<div id="tbl-factor-con-recommendations" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-factor-con-recommendations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;19.1: Recommended factor construction parameters for Vietnamese equities.
</figcaption>
<div aria-describedby="tbl-factor-con-recommendations-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th>Choice</th>
<th>Recommendation</th>
<th>Rationale</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Universe</td>
<td>Standard filter (listing age ≥ 6m, volume &gt; 0)</td>
<td>Excludes shell firms without losing too much breadth</td>
</tr>
<tr class="even">
<td>Breakpoints</td>
<td>HOSE stocks only</td>
<td>Prevents HNX micro-caps from dominating breakpoints</td>
</tr>
<tr class="odd">
<td>Size groups</td>
<td>2 (median split)</td>
<td>Sufficient control with limited cross-section</td>
</tr>
<tr class="even">
<td>Signal groups</td>
<td>3 (terciles) for factor construction; 5 or 10 for portfolio analysis</td>
<td>2×3 = adequate diversification per portfolio</td>
</tr>
<tr class="odd">
<td>Weighting</td>
<td>Value-weighted</td>
<td>Investable; less noisy than EW</td>
</tr>
<tr class="even">
<td>Rebalancing</td>
<td>Annual (June) for accounting signals; monthly for momentum</td>
<td>Standard; consistent with Fama-French</td>
</tr>
<tr class="odd">
<td>Accounting lag</td>
<td>4 months (available by April for Dec FY)</td>
<td>Conservative PIT alignment</td>
</tr>
<tr class="even">
<td>Minimum stocks</td>
<td>≥ 5 per portfolio per month</td>
<td>Below this, single-stock idiosyncratic risk dominates</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>Always report results under the baseline and at least one alternative specification (e.g., EW, all-stock breakpoints) to demonstrate robustness.</p>
</section>
<section id="sec-factor-con-summary" class="level2" data-number="19.12">
<h2 data-number="19.12" class="anchored" data-anchor-id="sec-factor-con-summary"><span class="header-section-number">19.12</span> Summary</h2>
<p>This chapter has developed a modular, transparent factor construction framework for Vietnamese equities. The key insights are:</p>
<ul>
<li><p>The <span class="citation" data-cites="fama1993common">Fama and French (<a href="references.html#ref-fama1993common" role="doc-biblioref">1993</a>)</span> 2×3 methodology translates well to Vietnam with one critical adaptation: breakpoints should be computed from HOSE stocks only. Using all-stock breakpoints allows HNX micro-caps to dominate the small-stock groups, inflating apparent premia with economically untradeable returns.</p></li>
<li><p>Value weighting produces more conservative (and more implementable) factor premia than equal weighting. The difference is particularly large for signals correlated with size (BM, investment), where EW overweights the smallest stocks that contribute most to the premium but least to investable returns.</p></li>
<li><p>No single construction choice determines whether a factor “exists.” A factor premium that appears only under one specific combination of breakpoints, weighting, and rebalancing frequency is fragile and should be treated with skepticism. Robust factors survive a grid of specifications. The sensitivity analysis framework developed here (e.g., varying weighting, breakpoints, sort granularity, and rebalancing simultaneously) should be standard practice.</p></li>
</ul>
<p>The <code>construct_factor()</code> function developed in this chapter is designed for reuse throughout the book. Any anomaly variable can be fed through the same pipeline, producing a tradeable factor with full diagnostics. This ensures methodological consistency across chapters and makes it easy to compare premia on an apples-to-apples basis.</p>
<!-- ## Exercises {#sec-factor-con-exercises}

1.  **Conditional sorts.** Implement conditional (sequential) double sorts as an alternative to the independent sorts used by @fama1993common. First sort on size, then within each size group sort on BM. Compare the resulting HML to the independent-sort HML. When do conditional sorts produce meaningfully different results?

2.  **Winsorization sensitivity.** Construct HML with and without winsorizing the book-to-market ratio at the 1st and 99th percentiles each month. How sensitive is the factor premium to extreme BM values? Investigate whether the extreme BM firms are concentrated in specific industries.

3.  **Lagged accounting data.** Reconstruct all five factors using a 6-month accounting lag instead of 4 months. How much does the additional lag reduce the premium? This tests how much of the apparent premium comes from stale data that was not yet publicly available.

4.  **Industry-neutral factors.** Construct an industry-neutral HML by sorting on BM within each ICB sector (rather than across the entire market). Does the within-industry value premium differ from the cross-industry premium? Which component is larger in Vietnam?

5.  **Liquidity-controlled factors.** Add a third independent sort on Amihud illiquidity (2×3×3 = 18 portfolios). Does the HML premium survive after controlling for liquidity? This tests whether the apparent value premium is actually a liquidity premium in disguise.

6.  **Small-sample bootstrap.** The Vietnamese cross-section is small enough that portfolio sorts may produce noisy estimates. Implement a bootstrap procedure: resample the cross-section with replacement 1,000 times at each formation date, reconstruct the factor each time, and report the 90% confidence interval for the annualized premium. How wide is the interval?

7.  **Factor timing.** Test whether factor premia are predictable using lagged aggregate variables (market volatility, credit spread, aggregate turnover, SBV policy rate). Estimate a predictive regression of next-month factor returns on these variables. Can you build a factor timing strategy that improves on the unconditional buy-and-hold factor?

8.  **Replication of @hou2020replicating for Vietnam.** Select 10 well-known anomalies from the international literature (e.g., gross profitability, asset growth, accruals, share issuance, ROE, beta, idiosyncratic volatility, earnings momentum, investment-to-assets, net share issues). Construct each as a long-short factor using the engine from this chapter. How many survive with t \> 2.0? How does this replication rate compare to the \~50% rate reported by @hou2020replicating for U.S. data? -->


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-fama1993common" class="csl-entry" role="listitem">
Fama, Eugene F., and Kenneth R. French. 1993. <span>“<span class="nocase">Common risk factors in the returns on stocks and bonds</span>.”</span> <em><span>Journal of Financial Economics</span></em> 33 (1): 3–56. <a href="https://doi.org/10.1016/0304-405X(93)90023-5">https://doi.org/10.1016/0304-405X(93)90023-5</a>.
</div>
<div id="ref-hou2020replicating" class="csl-entry" role="listitem">
Hou, Kewei, Chen Xue, and Lu Zhang. 2020. <span>“Replicating Anomalies.”</span> <em>The Review of Financial Studies</em> 33 (5): 2019–2133.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./22_momentum.html" class="pagination-link" aria-label="Momentum Strategies">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./24_fama_macbeth.html" class="pagination-link" aria-label="Fama-MacBeth Regressions">
        <span class="nav-page-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Factor Construction Principles</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>In this chapter, we develop a general-purpose factor construction engine for the Vietnamese equity market. We cover every methodological decision in the pipeline, including universe definition, breakpoint computation, portfolio formation, weighting, rebalancing, and factor return calculation, and demonstrate how each choice affects the resulting factor.</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>The previous chapters introduced specific asset pricing models, including the CAPM, the Fama-French three-factor model, and momentum. Each of those chapters presented its factor as given. This chapter steps behind the curtain and addresses the engineering question: *how exactly do you build a factor?* The question matters because seemingly minor methodological decisions, such as where to set breakpoints, whether to value-weight or equal-weight, how to handle missing accounting data, which stocks to exclude, can alter the magnitude, statistical significance, and even the sign of a factor premium.</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>In the U.S. context, @fama1993common established a canonical procedure: sort stocks independently on size and a characteristic, form six value-weighted portfolios from 2×3 intersections, and define the factor as the average return of the two high-characteristic portfolios minus the average return of the two low-characteristic portfolios. This procedure has been replicated thousands of times. But it was designed for the U.S. market circa 1990, with its deep liquidity, broad cross-section, and CRSP/Compustat data infrastructure. Applying it mechanically to Vietnam, a market with 700 listed stocks, extreme illiquidity in the bottom tercile, high concentration in the top decile, and accounting data that arrives with variable lags, requires careful adaptation.</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>@hou2020replicating replicated 452 anomalies from the U.S. literature and found that over half fail to replicate even in U.S. data with minor methodological variations. The replication crisis in empirical asset pricing makes it essential that researchers understand and document every construction choice. This chapter provides the tools to do so transparently.</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Factor Construction Pipeline {#sec-factor-con-pipeline}</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>Every tradeable factor follows the same logical pipeline:</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Define the universe: Select the eligible securities (e.g., common stocks with liquidity and size filters).</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Compute the signal: Calculate the characteristic of interest (e.g., value, momentum, profitability).</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Set breakpoints: Determine how stocks will be sorted (e.g., median, quintiles, deciles).</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Assign portfolios: Group stocks into high and low (or multiple) portfolios based on the signal.</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Compute returns: Calculate portfolio returns (equal- or value-weighted).</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>Construct the factor: Take Long (high) - Short (low).</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>Validate: Test performance, significance, and robustness.</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>Each step involves choices that interact with each other. A breakpoint that works well for a liquid universe may be inappropriate for the full cross-section. A weighting scheme that reduces noise in the U.S. may amplify it in Vietnam. We address each step systematically.</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Construction {#sec-factor-con-data}</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup</span></span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure environment"</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> itertools <span class="im">import</span> product</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.figsize'</span>: (<span class="dv">12</span>, <span class="dv">6</span>),</span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'figure.dpi'</span>: <span class="dv">150</span>,</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'font.size'</span>: <span class="dv">11</span>,</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.top'</span>: <span class="va">False</span>,</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'axes.spines.right'</span>: <span class="va">False</span></span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: data-load</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load returns, characteristics, and accounting data"</span></span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datacore <span class="im">import</span> DataCoreClient</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> DataCoreClient()</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly returns (survivorship-bias-free)</span></span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> client.get_monthly_returns(</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'monthly_return'</span>, <span class="st">'market_cap'</span>,</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_outstanding'</span>, <span class="st">'volume_avg_20d'</span>, <span class="st">'turnover_value_avg_20d'</span>,</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_zero_volume_days'</span>, <span class="st">'exchange'</span></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Annual accounting data</span></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>accounting <span class="op">=</span> client.get_fundamentals(</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2006-01-01'</span>,</span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a>    frequency<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ticker'</span>, <span class="st">'fiscal_year'</span>, <span class="st">'filing_date'</span>,</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">'total_assets'</span>, <span class="st">'total_equity'</span>, <span class="st">'book_equity'</span>,</span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">'net_income'</span>, <span class="st">'revenue'</span>, <span class="st">'gross_profit'</span>,</span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">'operating_profit'</span>, <span class="st">'total_debt'</span>, <span class="st">'retained_earnings'</span>,</span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">'dividends_paid'</span>, <span class="st">'capex'</span>, <span class="st">'depreciation'</span>,</span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">'shares_outstanding_fy'</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily prices for momentum and volatility signals</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>daily <span class="op">=</span> client.get_daily_prices(</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>    start_date<span class="op">=</span><span class="st">'2008-01-01'</span>,</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>    end_date<span class="op">=</span><span class="st">'2024-12-31'</span>,</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>    include_delisted<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-99"><a href="#cb23-99" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'date'</span>, <span class="st">'adjusted_close'</span>, <span class="st">'volume'</span>, <span class="st">'turnover_value'</span>]</span>
<span id="cb23-100"><a href="#cb23-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-101"><a href="#cb23-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-102"><a href="#cb23-102" aria-hidden="true" tabindex="-1"></a>monthly[<span class="st">'month_end'</span>] <span class="op">=</span> pd.to_datetime(monthly[<span class="st">'month_end'</span>])</span>
<span id="cb23-103"><a href="#cb23-103" aria-hidden="true" tabindex="-1"></a>monthly <span class="op">=</span> monthly.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb23-104"><a href="#cb23-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-105"><a href="#cb23-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Monthly returns: </span><span class="sc">{</span><span class="bu">len</span>(monthly)<span class="sc">:,}</span><span class="ss"> firm-months"</span>)</span>
<span id="cb23-106"><a href="#cb23-106" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Accounting: </span><span class="sc">{</span><span class="bu">len</span>(accounting)<span class="sc">:,}</span><span class="ss"> firm-years"</span>)</span>
<span id="cb23-107"><a href="#cb23-107" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique tickers: </span><span class="sc">{</span>monthly[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-108"><a href="#cb23-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-109"><a href="#cb23-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-110"><a href="#cb23-110" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Universe Definition {#sec-factor-con-universe}</span></span>
<span id="cb23-111"><a href="#cb23-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-112"><a href="#cb23-112" aria-hidden="true" tabindex="-1"></a>The first and most consequential choice is which stocks enter the factor construction universe. The universe definition determines what population the factor premium describes and whether it is implementable.</span>
<span id="cb23-113"><a href="#cb23-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-114"><a href="#cb23-114" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Universe Problem in Vietnam</span></span>
<span id="cb23-115"><a href="#cb23-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-116"><a href="#cb23-116" aria-hidden="true" tabindex="-1"></a>Vietnam presents a specific challenge: the cross-section is small (600-800 stocks on HOSE and HNX combined), and the size distribution is extremely skewed. The top 10 stocks by market capitalization account for roughly 50% of the total market cap on HOSE. The bottom tercile consists of micro-cap stocks that often trade fewer than 5 days per month. Including these stocks inflates apparent factor premia because their prices are noisy and stale, but excluding them shrinks the already small cross-section.</span>
<span id="cb23-117"><a href="#cb23-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-120"><a href="#cb23-120" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-121"><a href="#cb23-121" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: universe-filters</span></span>
<span id="cb23-122"><a href="#cb23-122" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-123"><a href="#cb23-123" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Define universe filters and document their effects"</span></span>
<span id="cb23-124"><a href="#cb23-124" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> apply_universe_filters(df, filters<span class="op">=</span><span class="st">'standard'</span>):</span>
<span id="cb23-125"><a href="#cb23-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-126"><a href="#cb23-126" aria-hidden="true" tabindex="-1"></a><span class="co">    Apply universe filters to the monthly return panel.</span></span>
<span id="cb23-127"><a href="#cb23-127" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-128"><a href="#cb23-128" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-129"><a href="#cb23-129" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-130"><a href="#cb23-130" aria-hidden="true" tabindex="-1"></a><span class="co">    filters : str</span></span>
<span id="cb23-131"><a href="#cb23-131" aria-hidden="true" tabindex="-1"></a><span class="co">        'none': all stocks</span></span>
<span id="cb23-132"><a href="#cb23-132" aria-hidden="true" tabindex="-1"></a><span class="co">        'minimal': exclude zero market cap and extreme returns</span></span>
<span id="cb23-133"><a href="#cb23-133" aria-hidden="true" tabindex="-1"></a><span class="co">        'standard': + minimum listing age + positive volume</span></span>
<span id="cb23-134"><a href="#cb23-134" aria-hidden="true" tabindex="-1"></a><span class="co">        'strict': + minimum market cap + minimum turnover</span></span>
<span id="cb23-135"><a href="#cb23-135" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-136"><a href="#cb23-136" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-137"><a href="#cb23-137" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-138"><a href="#cb23-138" aria-hidden="true" tabindex="-1"></a><span class="co">    Filtered DataFrame with 'in_universe' column</span></span>
<span id="cb23-139"><a href="#cb23-139" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-140"><a href="#cb23-140" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> df.copy()</span>
<span id="cb23-141"><a href="#cb23-141" aria-hidden="true" tabindex="-1"></a>    d[<span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">True</span></span>
<span id="cb23-142"><a href="#cb23-142" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-143"><a href="#cb23-143" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Always: remove missing returns and market cap</span></span>
<span id="cb23-144"><a href="#cb23-144" aria-hidden="true" tabindex="-1"></a>    d.loc[d[<span class="st">'monthly_return'</span>].isna(), <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-145"><a href="#cb23-145" aria-hidden="true" tabindex="-1"></a>    d.loc[d[<span class="st">'market_cap'</span>].isna() <span class="op">|</span> (d[<span class="st">'market_cap'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>), <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-146"><a href="#cb23-146" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-147"><a href="#cb23-147" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Minimal: winsorize extreme returns (likely data errors)</span></span>
<span id="cb23-148"><a href="#cb23-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="kw">in</span> [<span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb23-149"><a href="#cb23-149" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'monthly_return'</span>].<span class="bu">abs</span>() <span class="op">&gt;</span> <span class="fl">1.0</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-150"><a href="#cb23-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-151"><a href="#cb23-151" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standard: listing age &gt;= 6 months</span></span>
<span id="cb23-152"><a href="#cb23-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="kw">in</span> [<span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb23-153"><a href="#cb23-153" aria-hidden="true" tabindex="-1"></a>        d[<span class="st">'listing_age'</span>] <span class="op">=</span> (</span>
<span id="cb23-154"><a href="#cb23-154" aria-hidden="true" tabindex="-1"></a>            d.groupby(<span class="st">'ticker'</span>).cumcount() <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb23-155"><a href="#cb23-155" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-156"><a href="#cb23-156" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'listing_age'</span>] <span class="op">&lt;</span> <span class="dv">6</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-157"><a href="#cb23-157" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-158"><a href="#cb23-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Require at least 10 positive-volume days in the month</span></span>
<span id="cb23-159"><a href="#cb23-159" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'n_zero_volume_days'</span>] <span class="op">&gt;</span> <span class="dv">12</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-160"><a href="#cb23-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-161"><a href="#cb23-161" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Strict: minimum market cap (20th percentile of HOSE)</span></span>
<span id="cb23-162"><a href="#cb23-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> filters <span class="op">==</span> <span class="st">'strict'</span>:</span>
<span id="cb23-163"><a href="#cb23-163" aria-hidden="true" tabindex="-1"></a>        mcap_threshold <span class="op">=</span> (</span>
<span id="cb23-164"><a href="#cb23-164" aria-hidden="true" tabindex="-1"></a>            d[d[<span class="st">'exchange'</span>] <span class="op">==</span> <span class="st">'HOSE'</span>]</span>
<span id="cb23-165"><a href="#cb23-165" aria-hidden="true" tabindex="-1"></a>            .groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb23-166"><a href="#cb23-166" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.quantile(<span class="fl">0.20</span>))</span>
<span id="cb23-167"><a href="#cb23-167" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-168"><a href="#cb23-168" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply HOSE threshold to all stocks</span></span>
<span id="cb23-169"><a href="#cb23-169" aria-hidden="true" tabindex="-1"></a>        d[<span class="st">'mcap_threshold'</span>] <span class="op">=</span> (</span>
<span id="cb23-170"><a href="#cb23-170" aria-hidden="true" tabindex="-1"></a>            d.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb23-171"><a href="#cb23-171" aria-hidden="true" tabindex="-1"></a>            .transform(<span class="kw">lambda</span> x: x.quantile(<span class="fl">0.20</span>))</span>
<span id="cb23-172"><a href="#cb23-172" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-173"><a href="#cb23-173" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'market_cap'</span>] <span class="op">&lt;</span> d[<span class="st">'mcap_threshold'</span>], <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-174"><a href="#cb23-174" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-175"><a href="#cb23-175" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Minimum average daily turnover (VND 200 million)</span></span>
<span id="cb23-176"><a href="#cb23-176" aria-hidden="true" tabindex="-1"></a>        d.loc[d[<span class="st">'turnover_value_avg_20d'</span>] <span class="op">&lt;</span> <span class="fl">2e8</span>, <span class="st">'in_universe'</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb23-177"><a href="#cb23-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-178"><a href="#cb23-178" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> d</span>
<span id="cb23-179"><a href="#cb23-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-180"><a href="#cb23-180" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply all filter levels and compare</span></span>
<span id="cb23-181"><a href="#cb23-181" aria-hidden="true" tabindex="-1"></a>filter_summary <span class="op">=</span> {}</span>
<span id="cb23-182"><a href="#cb23-182" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'none'</span>, <span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb23-183"><a href="#cb23-183" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb23-184"><a href="#cb23-184" aria-hidden="true" tabindex="-1"></a>    in_univ <span class="op">=</span> filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb23-185"><a href="#cb23-185" aria-hidden="true" tabindex="-1"></a>    filter_summary[level] <span class="op">=</span> {</span>
<span id="cb23-186"><a href="#cb23-186" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Firm-months'</span>: <span class="bu">len</span>(in_univ),</span>
<span id="cb23-187"><a href="#cb23-187" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg stocks/month'</span>: in_univ.groupby(<span class="st">'month_end'</span>)[<span class="st">'ticker'</span>].nunique().mean(),</span>
<span id="cb23-188"><a href="#cb23-188" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Avg MCap coverage (%)'</span>: (</span>
<span id="cb23-189"><a href="#cb23-189" aria-hidden="true" tabindex="-1"></a>            in_univ.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-190"><a href="#cb23-190" aria-hidden="true" tabindex="-1"></a>            <span class="op">/</span> filtered.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-191"><a href="#cb23-191" aria-hidden="true" tabindex="-1"></a>        ).mean() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-192"><a href="#cb23-192" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-193"><a href="#cb23-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-194"><a href="#cb23-194" aria-hidden="true" tabindex="-1"></a>filter_df <span class="op">=</span> pd.DataFrame(filter_summary).T</span>
<span id="cb23-195"><a href="#cb23-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Universe Filter Effects:"</span>)</span>
<span id="cb23-196"><a href="#cb23-196" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(filter_df.<span class="bu">round</span>(<span class="dv">1</span>).to_string())</span>
<span id="cb23-197"><a href="#cb23-197" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-198"><a href="#cb23-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-201"><a href="#cb23-201" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-202"><a href="#cb23-202" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-universe-size</span></span>
<span id="cb23-203"><a href="#cb23-203" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-204"><a href="#cb23-204" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Number of stocks in the investable universe under different filter definitions. The 'strict' filter reduces the cross-section by roughly 30-40% but retains over 90% of total market capitalization. The trade-off is between cross-sectional breadth (more breakpoint precision) and data quality (less noise from illiquid micro-caps)."</span></span>
<span id="cb23-205"><a href="#cb23-205" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot universe size under different filters over time"</span></span>
<span id="cb23-206"><a href="#cb23-206" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb23-207"><a href="#cb23-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-208"><a href="#cb23-208" aria-hidden="true" tabindex="-1"></a>colors_filter <span class="op">=</span> {</span>
<span id="cb23-209"><a href="#cb23-209" aria-hidden="true" tabindex="-1"></a>    <span class="st">'none'</span>: <span class="st">'#BDC3C7'</span>, <span class="st">'minimal'</span>: <span class="st">'#3498DB'</span>,</span>
<span id="cb23-210"><a href="#cb23-210" aria-hidden="true" tabindex="-1"></a>    <span class="st">'standard'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'strict'</span>: <span class="st">'#C0392B'</span></span>
<span id="cb23-211"><a href="#cb23-211" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-212"><a href="#cb23-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-213"><a href="#cb23-213" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'none'</span>, <span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb23-214"><a href="#cb23-214" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb23-215"><a href="#cb23-215" aria-hidden="true" tabindex="-1"></a>    counts <span class="op">=</span> (</span>
<span id="cb23-216"><a href="#cb23-216" aria-hidden="true" tabindex="-1"></a>        filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb23-217"><a href="#cb23-217" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'ticker'</span>]</span>
<span id="cb23-218"><a href="#cb23-218" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb23-219"><a href="#cb23-219" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-220"><a href="#cb23-220" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(counts.index, counts.values,</span>
<span id="cb23-221"><a href="#cb23-221" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>colors_filter[level], linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span>level)</span>
<span id="cb23-222"><a href="#cb23-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-223"><a href="#cb23-223" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Number of Stocks'</span>)</span>
<span id="cb23-224"><a href="#cb23-224" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Universe Size'</span>)</span>
<span id="cb23-225"><a href="#cb23-225" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb23-226"><a href="#cb23-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-227"><a href="#cb23-227" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Market cap coverage</span></span>
<span id="cb23-228"><a href="#cb23-228" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> level <span class="kw">in</span> [<span class="st">'minimal'</span>, <span class="st">'standard'</span>, <span class="st">'strict'</span>]:</span>
<span id="cb23-229"><a href="#cb23-229" aria-hidden="true" tabindex="-1"></a>    filtered <span class="op">=</span> apply_universe_filters(monthly, filters<span class="op">=</span>level)</span>
<span id="cb23-230"><a href="#cb23-230" aria-hidden="true" tabindex="-1"></a>    total_mcap <span class="op">=</span> filtered.groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>].<span class="bu">sum</span>()</span>
<span id="cb23-231"><a href="#cb23-231" aria-hidden="true" tabindex="-1"></a>    filtered_mcap <span class="op">=</span> (</span>
<span id="cb23-232"><a href="#cb23-232" aria-hidden="true" tabindex="-1"></a>        filtered[filtered[<span class="st">'in_universe'</span>]]</span>
<span id="cb23-233"><a href="#cb23-233" aria-hidden="true" tabindex="-1"></a>        .groupby(<span class="st">'month_end'</span>)[<span class="st">'market_cap'</span>]</span>
<span id="cb23-234"><a href="#cb23-234" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">sum</span>()</span>
<span id="cb23-235"><a href="#cb23-235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-236"><a href="#cb23-236" aria-hidden="true" tabindex="-1"></a>    coverage <span class="op">=</span> (filtered_mcap <span class="op">/</span> total_mcap <span class="op">*</span> <span class="dv">100</span>).dropna()</span>
<span id="cb23-237"><a href="#cb23-237" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(coverage.index, coverage.values,</span>
<span id="cb23-238"><a href="#cb23-238" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>colors_filter[level], linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span>level)</span>
<span id="cb23-239"><a href="#cb23-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-240"><a href="#cb23-240" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Market Cap Coverage (%)'</span>)</span>
<span id="cb23-241"><a href="#cb23-241" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: Market Capitalization Coverage'</span>)</span>
<span id="cb23-242"><a href="#cb23-242" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb23-243"><a href="#cb23-243" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim([<span class="dv">60</span>, <span class="dv">102</span>])</span>
<span id="cb23-244"><a href="#cb23-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-245"><a href="#cb23-245" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-246"><a href="#cb23-246" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-247"><a href="#cb23-247" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-248"><a href="#cb23-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-249"><a href="#cb23-249" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Signal Construction {#sec-factor-con-signals}</span></span>
<span id="cb23-250"><a href="#cb23-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-251"><a href="#cb23-251" aria-hidden="true" tabindex="-1"></a><span class="fu">### Point-in-Time Accounting Data</span></span>
<span id="cb23-252"><a href="#cb23-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-253"><a href="#cb23-253" aria-hidden="true" tabindex="-1"></a>As discussed in the missing data chapter, accounting signals must be aligned with their public availability date to avoid look-ahead bias. We implement a general-purpose point-in-time merge:</span>
<span id="cb23-254"><a href="#cb23-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-257"><a href="#cb23-257" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-258"><a href="#cb23-258" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: pit-merge</span></span>
<span id="cb23-259"><a href="#cb23-259" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-260"><a href="#cb23-260" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Point-in-time alignment of accounting data with monthly returns"</span></span>
<span id="cb23-261"><a href="#cb23-261" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pit_merge_accounting(monthly_df, accounting_df, lag_months<span class="op">=</span><span class="dv">4</span>):</span>
<span id="cb23-262"><a href="#cb23-262" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-263"><a href="#cb23-263" aria-hidden="true" tabindex="-1"></a><span class="co">    Merge accounting data with monthly returns respecting</span></span>
<span id="cb23-264"><a href="#cb23-264" aria-hidden="true" tabindex="-1"></a><span class="co">    the point-in-time availability constraint.</span></span>
<span id="cb23-265"><a href="#cb23-265" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-266"><a href="#cb23-266" aria-hidden="true" tabindex="-1"></a><span class="co">    Vietnamese annual reports are due within 90 days of fiscal</span></span>
<span id="cb23-267"><a href="#cb23-267" aria-hidden="true" tabindex="-1"></a><span class="co">    year-end. We use a conservative 4-month lag.</span></span>
<span id="cb23-268"><a href="#cb23-268" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-269"><a href="#cb23-269" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-270"><a href="#cb23-270" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-271"><a href="#cb23-271" aria-hidden="true" tabindex="-1"></a><span class="co">    lag_months : int</span></span>
<span id="cb23-272"><a href="#cb23-272" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of months after fiscal year-end before data</span></span>
<span id="cb23-273"><a href="#cb23-273" aria-hidden="true" tabindex="-1"></a><span class="co">        are assumed to be publicly available.</span></span>
<span id="cb23-274"><a href="#cb23-274" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-275"><a href="#cb23-275" aria-hidden="true" tabindex="-1"></a>    acc <span class="op">=</span> accounting_df.copy()</span>
<span id="cb23-276"><a href="#cb23-276" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-277"><a href="#cb23-277" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Accounting data becomes available lag_months after FY end</span></span>
<span id="cb23-278"><a href="#cb23-278" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If filing_date is available, use it; otherwise use FY-end + lag</span></span>
<span id="cb23-279"><a href="#cb23-279" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'filing_date'</span> <span class="kw">in</span> acc.columns:</span>
<span id="cb23-280"><a href="#cb23-280" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'filing_date'</span>] <span class="op">=</span> pd.to_datetime(acc[<span class="st">'filing_date'</span>])</span>
<span id="cb23-281"><a href="#cb23-281" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> acc[<span class="st">'filing_date'</span>]</span>
<span id="cb23-282"><a href="#cb23-282" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fallback for missing filing dates</span></span>
<span id="cb23-283"><a href="#cb23-283" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'fy_end'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb23-284"><a href="#cb23-284" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb23-285"><a href="#cb23-285" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-286"><a href="#cb23-286" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> acc[<span class="st">'available_date'</span>].fillna(</span>
<span id="cb23-287"><a href="#cb23-287" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fy_end'</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb23-288"><a href="#cb23-288" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-289"><a href="#cb23-289" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-290"><a href="#cb23-290" aria-hidden="true" tabindex="-1"></a>        acc[<span class="st">'available_date'</span>] <span class="op">=</span> pd.to_datetime(</span>
<span id="cb23-291"><a href="#cb23-291" aria-hidden="true" tabindex="-1"></a>            acc[<span class="st">'fiscal_year'</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">'-12-31'</span></span>
<span id="cb23-292"><a href="#cb23-292" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>lag_months)</span>
<span id="cb23-293"><a href="#cb23-293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-294"><a href="#cb23-294" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each firm-month, find the most recent available accounting data</span></span>
<span id="cb23-295"><a href="#cb23-295" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> monthly_df.copy()</span>
<span id="cb23-296"><a href="#cb23-296" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-297"><a href="#cb23-297" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Efficient approach: for June rebalancing, use FY t-1 data</span></span>
<span id="cb23-298"><a href="#cb23-298" aria-hidden="true" tabindex="-1"></a>    <span class="co"># which is available by April of year t (4-month lag)</span></span>
<span id="cb23-299"><a href="#cb23-299" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'year'</span>] <span class="op">=</span> merged[<span class="st">'month_end'</span>].dt.year</span>
<span id="cb23-300"><a href="#cb23-300" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'month'</span>] <span class="op">=</span> merged[<span class="st">'month_end'</span>].dt.month</span>
<span id="cb23-301"><a href="#cb23-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-302"><a href="#cb23-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Map: if month &gt;= (lag_months + 1), use current year's FY-1 data</span></span>
<span id="cb23-303"><a href="#cb23-303" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Otherwise, use FY-2 data</span></span>
<span id="cb23-304"><a href="#cb23-304" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">'data_fy'</span>] <span class="op">=</span> np.where(</span>
<span id="cb23-305"><a href="#cb23-305" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'month'</span>] <span class="op">&gt;=</span> lag_months <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb23-306"><a href="#cb23-306" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'year'</span>] <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb23-307"><a href="#cb23-307" aria-hidden="true" tabindex="-1"></a>        merged[<span class="st">'year'</span>] <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb23-308"><a href="#cb23-308" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-309"><a href="#cb23-309" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-310"><a href="#cb23-310" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Merge</span></span>
<span id="cb23-311"><a href="#cb23-311" aria-hidden="true" tabindex="-1"></a>    acc_cols <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> acc.columns <span class="cf">if</span> c <span class="kw">not</span> <span class="kw">in</span></span>
<span id="cb23-312"><a href="#cb23-312" aria-hidden="true" tabindex="-1"></a>                [<span class="st">'filing_date'</span>, <span class="st">'available_date'</span>, <span class="st">'fy_end'</span>]]</span>
<span id="cb23-313"><a href="#cb23-313" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.merge(</span>
<span id="cb23-314"><a href="#cb23-314" aria-hidden="true" tabindex="-1"></a>        acc[acc_cols].rename(columns<span class="op">=</span>{<span class="st">'fiscal_year'</span>: <span class="st">'data_fy'</span>}),</span>
<span id="cb23-315"><a href="#cb23-315" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'data_fy'</span>],</span>
<span id="cb23-316"><a href="#cb23-316" aria-hidden="true" tabindex="-1"></a>        how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb23-317"><a href="#cb23-317" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-318"><a href="#cb23-318" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-319"><a href="#cb23-319" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb23-320"><a href="#cb23-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-321"><a href="#cb23-321" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply point-in-time merge</span></span>
<span id="cb23-322"><a href="#cb23-322" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> pit_merge_accounting(monthly, accounting, lag_months<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb23-323"><a href="#cb23-323" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-324"><a href="#cb23-324" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct common signals</span></span>
<span id="cb23-325"><a href="#cb23-325" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'log_mcap'</span>] <span class="op">=</span> np.log(panel[<span class="st">'market_cap'</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb23-326"><a href="#cb23-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-327"><a href="#cb23-327" aria-hidden="true" tabindex="-1"></a><span class="co"># Book-to-market</span></span>
<span id="cb23-328"><a href="#cb23-328" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'bm'</span>] <span class="op">=</span> panel[<span class="st">'book_equity'</span>] <span class="op">/</span> panel[<span class="st">'market_cap'</span>]</span>
<span id="cb23-329"><a href="#cb23-329" aria-hidden="true" tabindex="-1"></a>panel.loc[panel[<span class="st">'bm'</span>] <span class="op">&lt;=</span> <span class="dv">0</span>, <span class="st">'bm'</span>] <span class="op">=</span> np.nan  <span class="co"># Negative BE firms</span></span>
<span id="cb23-330"><a href="#cb23-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-331"><a href="#cb23-331" aria-hidden="true" tabindex="-1"></a><span class="co"># Gross profitability (Novy-Marx 2013)</span></span>
<span id="cb23-332"><a href="#cb23-332" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'gp_at'</span>] <span class="op">=</span> panel[<span class="st">'gross_profit'</span>] <span class="op">/</span> panel[<span class="st">'total_assets'</span>]</span>
<span id="cb23-333"><a href="#cb23-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-334"><a href="#cb23-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Operating profitability (Fama-French 2015)</span></span>
<span id="cb23-335"><a href="#cb23-335" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'op'</span>] <span class="op">=</span> panel[<span class="st">'operating_profit'</span>] <span class="op">/</span> panel[<span class="st">'book_equity'</span>]</span>
<span id="cb23-336"><a href="#cb23-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-337"><a href="#cb23-337" aria-hidden="true" tabindex="-1"></a><span class="co"># Investment (asset growth)</span></span>
<span id="cb23-338"><a href="#cb23-338" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'investment'</span>] <span class="op">=</span> (</span>
<span id="cb23-339"><a href="#cb23-339" aria-hidden="true" tabindex="-1"></a>    panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'total_assets'</span>]</span>
<span id="cb23-340"><a href="#cb23-340" aria-hidden="true" tabindex="-1"></a>    .pct_change(periods<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-341"><a href="#cb23-341" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-342"><a href="#cb23-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-343"><a href="#cb23-343" aria-hidden="true" tabindex="-1"></a><span class="co"># Leverage</span></span>
<span id="cb23-344"><a href="#cb23-344" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'leverage'</span>] <span class="op">=</span> panel[<span class="st">'total_debt'</span>] <span class="op">/</span> panel[<span class="st">'total_assets'</span>]</span>
<span id="cb23-345"><a href="#cb23-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-346"><a href="#cb23-346" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Signal Coverage:"</span>)</span>
<span id="cb23-347"><a href="#cb23-347" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> [<span class="st">'bm'</span>, <span class="st">'gp_at'</span>, <span class="st">'op'</span>, <span class="st">'investment'</span>, <span class="st">'leverage'</span>]:</span>
<span id="cb23-348"><a href="#cb23-348" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb23-349"><a href="#cb23-349" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>sig<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>pct<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-350"><a href="#cb23-350" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-351"><a href="#cb23-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-352"><a href="#cb23-352" aria-hidden="true" tabindex="-1"></a><span class="fu">### Momentum and Volatility Signals</span></span>
<span id="cb23-353"><a href="#cb23-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-354"><a href="#cb23-354" aria-hidden="true" tabindex="-1"></a>Price-based signals require return history, not accounting data, so they have different timing requirements.</span>
<span id="cb23-355"><a href="#cb23-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-358"><a href="#cb23-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-359"><a href="#cb23-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: price-signals</span></span>
<span id="cb23-360"><a href="#cb23-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-361"><a href="#cb23-361" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Construct momentum, reversal, and volatility signals"</span></span>
<span id="cb23-362"><a href="#cb23-362" aria-hidden="true" tabindex="-1"></a><span class="co"># Past returns for momentum signals</span></span>
<span id="cb23-363"><a href="#cb23-363" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.sort_values([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])</span>
<span id="cb23-364"><a href="#cb23-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-365"><a href="#cb23-365" aria-hidden="true" tabindex="-1"></a><span class="co"># Momentum: cumulative return from month t-12 to t-2 (skip most recent month)</span></span>
<span id="cb23-366"><a href="#cb23-366" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'ret_12_2'</span>] <span class="op">=</span> (</span>
<span id="cb23-367"><a href="#cb23-367" aria-hidden="true" tabindex="-1"></a>    panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>]</span>
<span id="cb23-368"><a href="#cb23-368" aria-hidden="true" tabindex="-1"></a>    .transform(<span class="kw">lambda</span> x: x.shift(<span class="dv">2</span>).rolling(<span class="dv">11</span>).<span class="bu">apply</span>(</span>
<span id="cb23-369"><a href="#cb23-369" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> r: (<span class="dv">1</span> <span class="op">+</span> r).prod() <span class="op">-</span> <span class="dv">1</span>, raw<span class="op">=</span><span class="va">True</span>))</span>
<span id="cb23-370"><a href="#cb23-370" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-371"><a href="#cb23-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-372"><a href="#cb23-372" aria-hidden="true" tabindex="-1"></a><span class="co"># Short-term reversal: month t-1 return</span></span>
<span id="cb23-373"><a href="#cb23-373" aria-hidden="true" tabindex="-1"></a>panel[<span class="st">'ret_1'</span>] <span class="op">=</span> panel.groupby(<span class="st">'ticker'</span>)[<span class="st">'monthly_return'</span>].shift(<span class="dv">1</span>)</span>
<span id="cb23-374"><a href="#cb23-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-375"><a href="#cb23-375" aria-hidden="true" tabindex="-1"></a><span class="co"># Idiosyncratic volatility (from daily data, rolling 60 days)</span></span>
<span id="cb23-376"><a href="#cb23-376" aria-hidden="true" tabindex="-1"></a>daily[<span class="st">'date'</span>] <span class="op">=</span> pd.to_datetime(daily[<span class="st">'date'</span>])</span>
<span id="cb23-377"><a href="#cb23-377" aria-hidden="true" tabindex="-1"></a>daily[<span class="st">'daily_return'</span>] <span class="op">=</span> daily.groupby(<span class="st">'ticker'</span>)[<span class="st">'adjusted_close'</span>].pct_change()</span>
<span id="cb23-378"><a href="#cb23-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-379"><a href="#cb23-379" aria-hidden="true" tabindex="-1"></a>ivol <span class="op">=</span> (</span>
<span id="cb23-380"><a href="#cb23-380" aria-hidden="true" tabindex="-1"></a>    daily.groupby(<span class="st">'ticker'</span>)</span>
<span id="cb23-381"><a href="#cb23-381" aria-hidden="true" tabindex="-1"></a>    .<span class="bu">apply</span>(<span class="kw">lambda</span> g: g.set_index(<span class="st">'date'</span>)[<span class="st">'daily_return'</span>]</span>
<span id="cb23-382"><a href="#cb23-382" aria-hidden="true" tabindex="-1"></a>           .rolling(<span class="dv">60</span>, min_periods<span class="op">=</span><span class="dv">40</span>).std() <span class="op">*</span> np.sqrt(<span class="dv">252</span>))</span>
<span id="cb23-383"><a href="#cb23-383" aria-hidden="true" tabindex="-1"></a>    .reset_index(name<span class="op">=</span><span class="st">'ivol'</span>)</span>
<span id="cb23-384"><a href="#cb23-384" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-385"><a href="#cb23-385" aria-hidden="true" tabindex="-1"></a>ivol[<span class="st">'month_end'</span>] <span class="op">=</span> ivol[<span class="st">'date'</span>].dt.to_period(<span class="st">'M'</span>).dt.to_timestamp(<span class="st">'M'</span>)</span>
<span id="cb23-386"><a href="#cb23-386" aria-hidden="true" tabindex="-1"></a>ivol_monthly <span class="op">=</span> (</span>
<span id="cb23-387"><a href="#cb23-387" aria-hidden="true" tabindex="-1"></a>    ivol.groupby([<span class="st">'ticker'</span>, <span class="st">'month_end'</span>])[<span class="st">'ivol'</span>]</span>
<span id="cb23-388"><a href="#cb23-388" aria-hidden="true" tabindex="-1"></a>    .last()</span>
<span id="cb23-389"><a href="#cb23-389" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb23-390"><a href="#cb23-390" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-391"><a href="#cb23-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-392"><a href="#cb23-392" aria-hidden="true" tabindex="-1"></a>panel <span class="op">=</span> panel.merge(ivol_monthly, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-393"><a href="#cb23-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-394"><a href="#cb23-394" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Price Signal Coverage:"</span>)</span>
<span id="cb23-395"><a href="#cb23-395" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> sig <span class="kw">in</span> [<span class="st">'ret_12_2'</span>, <span class="st">'ret_1'</span>, <span class="st">'ivol'</span>]:</span>
<span id="cb23-396"><a href="#cb23-396" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> panel[sig].notna().mean()</span>
<span id="cb23-397"><a href="#cb23-397" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>sig<span class="sc">:&lt;15}</span><span class="ss">: </span><span class="sc">{</span>pct<span class="sc">:.1%}</span><span class="ss">"</span>)</span>
<span id="cb23-398"><a href="#cb23-398" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-399"><a href="#cb23-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-400"><a href="#cb23-400" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Breakpoint Computation {#sec-factor-con-breakpoints}</span></span>
<span id="cb23-401"><a href="#cb23-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-402"><a href="#cb23-402" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Breakpoint Decision</span></span>
<span id="cb23-403"><a href="#cb23-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-404"><a href="#cb23-404" aria-hidden="true" tabindex="-1"></a>Breakpoints determine which stocks are "high" versus "low" on a given characteristic. The two key choices are:</span>
<span id="cb23-405"><a href="#cb23-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-406"><a href="#cb23-406" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Breakpoint universe:** Should breakpoints be computed from all stocks or from a subset (e.g., HOSE only)?</span>
<span id="cb23-407"><a href="#cb23-407" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Number of groups:** 2×3 (Fama-French standard), 5×5 (for finer sorts), or independent terciles/quintiles?</span>
<span id="cb23-408"><a href="#cb23-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-409"><a href="#cb23-409" aria-hidden="true" tabindex="-1"></a>@fama1993common use NYSE breakpoints for U.S. sorts because this prevents the large number of small Nasdaq/AMEX stocks from dominating the breakpoint distribution. The analog in Vietnam is to use HOSE breakpoints, since HOSE lists the larger, more liquid firms and HNX lists smaller firms. Using all-stock breakpoints would place most HOSE stocks in the upper size groups and most HNX stocks in the lower groups, producing mechanically different results.</span>
<span id="cb23-410"><a href="#cb23-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-413"><a href="#cb23-413" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-414"><a href="#cb23-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: breakpoints</span></span>
<span id="cb23-415"><a href="#cb23-415" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-416"><a href="#cb23-416" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare breakpoint choices and their effects on portfolio composition"</span></span>
<span id="cb23-417"><a href="#cb23-417" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_breakpoints(df, signal_col, n_groups, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb23-418"><a href="#cb23-418" aria-hidden="true" tabindex="-1"></a>                          exchange_col<span class="op">=</span><span class="st">'exchange'</span>):</span>
<span id="cb23-419"><a href="#cb23-419" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-420"><a href="#cb23-420" aria-hidden="true" tabindex="-1"></a><span class="co">    Compute cross-sectional breakpoints for portfolio sorting.</span></span>
<span id="cb23-421"><a href="#cb23-421" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-422"><a href="#cb23-422" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-423"><a href="#cb23-423" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-424"><a href="#cb23-424" aria-hidden="true" tabindex="-1"></a><span class="co">    bp_universe : str</span></span>
<span id="cb23-425"><a href="#cb23-425" aria-hidden="true" tabindex="-1"></a><span class="co">        'all': use all stocks in universe</span></span>
<span id="cb23-426"><a href="#cb23-426" aria-hidden="true" tabindex="-1"></a><span class="co">        'hose': use only HOSE stocks (analogous to NYSE breakpoints)</span></span>
<span id="cb23-427"><a href="#cb23-427" aria-hidden="true" tabindex="-1"></a><span class="co">    n_groups : int</span></span>
<span id="cb23-428"><a href="#cb23-428" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of groups (2, 3, 5, or 10)</span></span>
<span id="cb23-429"><a href="#cb23-429" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-430"><a href="#cb23-430" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-431"><a href="#cb23-431" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-432"><a href="#cb23-432" aria-hidden="true" tabindex="-1"></a><span class="co">    Series of breakpoints (quantiles)</span></span>
<span id="cb23-433"><a href="#cb23-433" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-434"><a href="#cb23-434" aria-hidden="true" tabindex="-1"></a>    signal <span class="op">=</span> df[signal_col].dropna()</span>
<span id="cb23-435"><a href="#cb23-435" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-436"><a href="#cb23-436" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bp_universe <span class="op">==</span> <span class="st">'hose'</span>:</span>
<span id="cb23-437"><a href="#cb23-437" aria-hidden="true" tabindex="-1"></a>        mask <span class="op">=</span> df[exchange_col] <span class="op">==</span> <span class="st">'HOSE'</span></span>
<span id="cb23-438"><a href="#cb23-438" aria-hidden="true" tabindex="-1"></a>        signal <span class="op">=</span> df.loc[mask, signal_col].dropna()</span>
<span id="cb23-439"><a href="#cb23-439" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-440"><a href="#cb23-440" aria-hidden="true" tabindex="-1"></a>    quantiles <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, n_groups <span class="op">+</span> <span class="dv">1</span>)[<span class="dv">1</span>:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb23-441"><a href="#cb23-441" aria-hidden="true" tabindex="-1"></a>    breakpoints <span class="op">=</span> signal.quantile(quantiles)</span>
<span id="cb23-442"><a href="#cb23-442" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-443"><a href="#cb23-443" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> breakpoints</span>
<span id="cb23-444"><a href="#cb23-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-445"><a href="#cb23-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: compare HOSE vs all-stock breakpoints for book-to-market</span></span>
<span id="cb23-446"><a href="#cb23-446" aria-hidden="true" tabindex="-1"></a>example_month <span class="op">=</span> panel[panel[<span class="st">'month_end'</span>] <span class="op">==</span> <span class="st">'2023-06-30'</span>].copy()</span>
<span id="cb23-447"><a href="#cb23-447" aria-hidden="true" tabindex="-1"></a>example_month <span class="op">=</span> example_month[example_month[<span class="st">'bm'</span>].notna()]</span>
<span id="cb23-448"><a href="#cb23-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-449"><a href="#cb23-449" aria-hidden="true" tabindex="-1"></a>bp_hose <span class="op">=</span> compute_breakpoints(example_month, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>)</span>
<span id="cb23-450"><a href="#cb23-450" aria-hidden="true" tabindex="-1"></a>bp_all <span class="op">=</span> compute_breakpoints(example_month, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb23-451"><a href="#cb23-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-452"><a href="#cb23-452" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BM Tercile Breakpoints (June 2023):"</span>)</span>
<span id="cb23-453"><a href="#cb23-453" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  HOSE-only: </span><span class="sc">{</span>bp_hose<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-454"><a href="#cb23-454" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  All stocks: </span><span class="sc">{</span>bp_all<span class="sc">.</span>values<span class="sc">.</span><span class="bu">round</span>(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-455"><a href="#cb23-455" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">  Difference: HOSE breakpoints are "</span></span>
<span id="cb23-456"><a href="#cb23-456" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'higher'</span> <span class="cf">if</span> bp_hose<span class="sc">.</span>values[<span class="dv">0</span>] <span class="op">&gt;</span> bp_all<span class="sc">.</span>values[<span class="dv">0</span>] <span class="cf">else</span> <span class="st">'lower'</span><span class="sc">}</span><span class="ss"> "</span></span>
<span id="cb23-457"><a href="#cb23-457" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"than all-stock breakpoints"</span>)</span>
<span id="cb23-458"><a href="#cb23-458" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-459"><a href="#cb23-459" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-462"><a href="#cb23-462" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-463"><a href="#cb23-463" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-breakpoints</span></span>
<span id="cb23-464"><a href="#cb23-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-465"><a href="#cb23-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Effect of breakpoint universe on portfolio composition. Panel A shows the time series of the median BM breakpoint under HOSE-only versus all-stock computation. Panel B shows the resulting number of stocks in each tercile. Using HOSE breakpoints places more HNX stocks in the growth (low BM) group, reflecting the size-value correlation."</span></span>
<span id="cb23-466"><a href="#cb23-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Visualize breakpoint effects over time"</span></span>
<span id="cb23-467"><a href="#cb23-467" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute breakpoints for every month</span></span>
<span id="cb23-468"><a href="#cb23-468" aria-hidden="true" tabindex="-1"></a>bp_comparison <span class="op">=</span> []</span>
<span id="cb23-469"><a href="#cb23-469" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> month, group <span class="kw">in</span> panel.dropna(subset<span class="op">=</span>[<span class="st">'bm'</span>]).groupby(<span class="st">'month_end'</span>):</span>
<span id="cb23-470"><a href="#cb23-470" aria-hidden="true" tabindex="-1"></a>    bp_h <span class="op">=</span> compute_breakpoints(group, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>)</span>
<span id="cb23-471"><a href="#cb23-471" aria-hidden="true" tabindex="-1"></a>    bp_a <span class="op">=</span> compute_breakpoints(group, <span class="st">'bm'</span>, <span class="dv">3</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>)</span>
<span id="cb23-472"><a href="#cb23-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-473"><a href="#cb23-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Count stocks in each tercile under each rule</span></span>
<span id="cb23-474"><a href="#cb23-474" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bp_name, bp_vals <span class="kw">in</span> [(<span class="st">'HOSE'</span>, bp_h), (<span class="st">'All'</span>, bp_a)]:</span>
<span id="cb23-475"><a href="#cb23-475" aria-hidden="true" tabindex="-1"></a>        low <span class="op">=</span> (group[<span class="st">'bm'</span>] <span class="op">&lt;=</span> bp_vals.iloc[<span class="dv">0</span>]).<span class="bu">sum</span>()</span>
<span id="cb23-476"><a href="#cb23-476" aria-hidden="true" tabindex="-1"></a>        mid <span class="op">=</span> ((group[<span class="st">'bm'</span>] <span class="op">&gt;</span> bp_vals.iloc[<span class="dv">0</span>]) <span class="op">&amp;</span></span>
<span id="cb23-477"><a href="#cb23-477" aria-hidden="true" tabindex="-1"></a>               (group[<span class="st">'bm'</span>] <span class="op">&lt;=</span> bp_vals.iloc[<span class="dv">1</span>])).<span class="bu">sum</span>()</span>
<span id="cb23-478"><a href="#cb23-478" aria-hidden="true" tabindex="-1"></a>        high <span class="op">=</span> (group[<span class="st">'bm'</span>] <span class="op">&gt;</span> bp_vals.iloc[<span class="dv">1</span>]).<span class="bu">sum</span>()</span>
<span id="cb23-479"><a href="#cb23-479" aria-hidden="true" tabindex="-1"></a>        bp_comparison.append({</span>
<span id="cb23-480"><a href="#cb23-480" aria-hidden="true" tabindex="-1"></a>            <span class="st">'month_end'</span>: month, <span class="st">'bp_rule'</span>: bp_name,</span>
<span id="cb23-481"><a href="#cb23-481" aria-hidden="true" tabindex="-1"></a>            <span class="st">'median_bp'</span>: bp_vals.iloc[<span class="dv">0</span>],</span>
<span id="cb23-482"><a href="#cb23-482" aria-hidden="true" tabindex="-1"></a>            <span class="st">'n_low'</span>: low, <span class="st">'n_mid'</span>: mid, <span class="st">'n_high'</span>: high</span>
<span id="cb23-483"><a href="#cb23-483" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-484"><a href="#cb23-484" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-485"><a href="#cb23-485" aria-hidden="true" tabindex="-1"></a>bp_df <span class="op">=</span> pd.DataFrame(bp_comparison)</span>
<span id="cb23-486"><a href="#cb23-486" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-487"><a href="#cb23-487" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb23-488"><a href="#cb23-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-489"><a href="#cb23-489" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel A: Median breakpoint over time</span></span>
<span id="cb23-490"><a href="#cb23-490" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rule, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'All'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb23-491"><a href="#cb23-491" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> bp_df[bp_df[<span class="st">'bp_rule'</span>] <span class="op">==</span> rule]</span>
<span id="cb23-492"><a href="#cb23-492" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(subset[<span class="st">'month_end'</span>], subset[<span class="st">'median_bp'</span>],</span>
<span id="cb23-493"><a href="#cb23-493" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>rule<span class="sc">}</span><span class="ss"> breakpoints'</span>)</span>
<span id="cb23-494"><a href="#cb23-494" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Lower Tercile Breakpoint (BM)'</span>)</span>
<span id="cb23-495"><a href="#cb23-495" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">'Panel A: Breakpoint Time Series'</span>)</span>
<span id="cb23-496"><a href="#cb23-496" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb23-497"><a href="#cb23-497" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-498"><a href="#cb23-498" aria-hidden="true" tabindex="-1"></a><span class="co"># Panel B: Number of stocks in high BM group</span></span>
<span id="cb23-499"><a href="#cb23-499" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> rule, color <span class="kw">in</span> [(<span class="st">'HOSE'</span>, <span class="st">'#2C5F8A'</span>), (<span class="st">'All'</span>, <span class="st">'#C0392B'</span>)]:</span>
<span id="cb23-500"><a href="#cb23-500" aria-hidden="true" tabindex="-1"></a>    subset <span class="op">=</span> bp_df[bp_df[<span class="st">'bp_rule'</span>] <span class="op">==</span> rule]</span>
<span id="cb23-501"><a href="#cb23-501" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].plot(subset[<span class="st">'month_end'</span>], subset[<span class="st">'n_high'</span>],</span>
<span id="cb23-502"><a href="#cb23-502" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>rule<span class="sc">}</span><span class="ss"> breakpoints'</span>)</span>
<span id="cb23-503"><a href="#cb23-503" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Stocks in High BM Group'</span>)</span>
<span id="cb23-504"><a href="#cb23-504" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">'Panel B: High BM Portfolio Size'</span>)</span>
<span id="cb23-505"><a href="#cb23-505" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend()</span>
<span id="cb23-506"><a href="#cb23-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-507"><a href="#cb23-507" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-508"><a href="#cb23-508" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-509"><a href="#cb23-509" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-510"><a href="#cb23-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-511"><a href="#cb23-511" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Portfolio Formation {#sec-factor-con-formation}</span></span>
<span id="cb23-512"><a href="#cb23-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-513"><a href="#cb23-513" aria-hidden="true" tabindex="-1"></a><span class="fu">### The Generic Factor Engine</span></span>
<span id="cb23-514"><a href="#cb23-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-515"><a href="#cb23-515" aria-hidden="true" tabindex="-1"></a>We implement a general-purpose factor construction function that takes any signal column and produces a long-short factor return series. The function encapsulates all methodological choices as parameters, making it easy to test sensitivity.</span>
<span id="cb23-516"><a href="#cb23-516" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-519"><a href="#cb23-519" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-520"><a href="#cb23-520" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: factor-engine</span></span>
<span id="cb23-521"><a href="#cb23-521" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-522"><a href="#cb23-522" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "General-purpose factor construction engine"</span></span>
<span id="cb23-523"><a href="#cb23-523" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> construct_factor(</span>
<span id="cb23-524"><a href="#cb23-524" aria-hidden="true" tabindex="-1"></a>    panel_df,</span>
<span id="cb23-525"><a href="#cb23-525" aria-hidden="true" tabindex="-1"></a>    signal_col,</span>
<span id="cb23-526"><a href="#cb23-526" aria-hidden="true" tabindex="-1"></a>    size_col<span class="op">=</span><span class="st">'market_cap'</span>,</span>
<span id="cb23-527"><a href="#cb23-527" aria-hidden="true" tabindex="-1"></a>    return_col<span class="op">=</span><span class="st">'monthly_return'</span>,</span>
<span id="cb23-528"><a href="#cb23-528" aria-hidden="true" tabindex="-1"></a>    date_col<span class="op">=</span><span class="st">'month_end'</span>,</span>
<span id="cb23-529"><a href="#cb23-529" aria-hidden="true" tabindex="-1"></a>    exchange_col<span class="op">=</span><span class="st">'exchange'</span>,</span>
<span id="cb23-530"><a href="#cb23-530" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>,</span>
<span id="cb23-531"><a href="#cb23-531" aria-hidden="true" tabindex="-1"></a>    rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-532"><a href="#cb23-532" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb23-533"><a href="#cb23-533" aria-hidden="true" tabindex="-1"></a>    n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-534"><a href="#cb23-534" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb23-535"><a href="#cb23-535" aria-hidden="true" tabindex="-1"></a>    bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb23-536"><a href="#cb23-536" aria-hidden="true" tabindex="-1"></a>    independent_sorts<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-537"><a href="#cb23-537" aria-hidden="true" tabindex="-1"></a>    long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-538"><a href="#cb23-538" aria-hidden="true" tabindex="-1"></a>    min_stocks_per_portfolio<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb23-539"><a href="#cb23-539" aria-hidden="true" tabindex="-1"></a>    signal_lag<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb23-540"><a href="#cb23-540" aria-hidden="true" tabindex="-1"></a>    universe_filter<span class="op">=</span><span class="st">'standard'</span></span>
<span id="cb23-541"><a href="#cb23-541" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb23-542"><a href="#cb23-542" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-543"><a href="#cb23-543" aria-hidden="true" tabindex="-1"></a><span class="co">    Construct a tradeable factor following the Fama-French methodology.</span></span>
<span id="cb23-544"><a href="#cb23-544" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-545"><a href="#cb23-545" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters</span></span>
<span id="cb23-546"><a href="#cb23-546" aria-hidden="true" tabindex="-1"></a><span class="co">    ----------</span></span>
<span id="cb23-547"><a href="#cb23-547" aria-hidden="true" tabindex="-1"></a><span class="co">    signal_col : str</span></span>
<span id="cb23-548"><a href="#cb23-548" aria-hidden="true" tabindex="-1"></a><span class="co">        Column with the sorting variable.</span></span>
<span id="cb23-549"><a href="#cb23-549" aria-hidden="true" tabindex="-1"></a><span class="co">    formation_month : int</span></span>
<span id="cb23-550"><a href="#cb23-550" aria-hidden="true" tabindex="-1"></a><span class="co">        Month of year for portfolio formation (6 = June for FF).</span></span>
<span id="cb23-551"><a href="#cb23-551" aria-hidden="true" tabindex="-1"></a><span class="co">    rebalance_freq : str</span></span>
<span id="cb23-552"><a href="#cb23-552" aria-hidden="true" tabindex="-1"></a><span class="co">        'annual' (FF standard), 'semi', 'quarterly', 'monthly'.</span></span>
<span id="cb23-553"><a href="#cb23-553" aria-hidden="true" tabindex="-1"></a><span class="co">    n_signal_groups : int</span></span>
<span id="cb23-554"><a href="#cb23-554" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of signal groups (3 for FF standard, 5 for quintiles).</span></span>
<span id="cb23-555"><a href="#cb23-555" aria-hidden="true" tabindex="-1"></a><span class="co">    n_size_groups : int</span></span>
<span id="cb23-556"><a href="#cb23-556" aria-hidden="true" tabindex="-1"></a><span class="co">        Number of size groups (2 for FF standard).</span></span>
<span id="cb23-557"><a href="#cb23-557" aria-hidden="true" tabindex="-1"></a><span class="co">    weighting : str</span></span>
<span id="cb23-558"><a href="#cb23-558" aria-hidden="true" tabindex="-1"></a><span class="co">        'value' (VW) or 'equal' (EW).</span></span>
<span id="cb23-559"><a href="#cb23-559" aria-hidden="true" tabindex="-1"></a><span class="co">    bp_universe : str</span></span>
<span id="cb23-560"><a href="#cb23-560" aria-hidden="true" tabindex="-1"></a><span class="co">        'hose' or 'all' for breakpoint computation.</span></span>
<span id="cb23-561"><a href="#cb23-561" aria-hidden="true" tabindex="-1"></a><span class="co">    independent_sorts : bool</span></span>
<span id="cb23-562"><a href="#cb23-562" aria-hidden="true" tabindex="-1"></a><span class="co">        True for independent double sorts (FF standard).</span></span>
<span id="cb23-563"><a href="#cb23-563" aria-hidden="true" tabindex="-1"></a><span class="co">    long_group : str</span></span>
<span id="cb23-564"><a href="#cb23-564" aria-hidden="true" tabindex="-1"></a><span class="co">        'high' or 'low'—which signal group is the long leg.</span></span>
<span id="cb23-565"><a href="#cb23-565" aria-hidden="true" tabindex="-1"></a><span class="co">    signal_lag : int</span></span>
<span id="cb23-566"><a href="#cb23-566" aria-hidden="true" tabindex="-1"></a><span class="co">        Additional months to lag the signal beyond the</span></span>
<span id="cb23-567"><a href="#cb23-567" aria-hidden="true" tabindex="-1"></a><span class="co">        standard point-in-time alignment.</span></span>
<span id="cb23-568"><a href="#cb23-568" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb23-569"><a href="#cb23-569" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns</span></span>
<span id="cb23-570"><a href="#cb23-570" aria-hidden="true" tabindex="-1"></a><span class="co">    -------</span></span>
<span id="cb23-571"><a href="#cb23-571" aria-hidden="true" tabindex="-1"></a><span class="co">    Dictionary with 'factor_returns', 'portfolio_returns',</span></span>
<span id="cb23-572"><a href="#cb23-572" aria-hidden="true" tabindex="-1"></a><span class="co">    'diagnostics'.</span></span>
<span id="cb23-573"><a href="#cb23-573" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-574"><a href="#cb23-574" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> panel_df.copy()</span>
<span id="cb23-575"><a href="#cb23-575" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-576"><a href="#cb23-576" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Apply universe filter</span></span>
<span id="cb23-577"><a href="#cb23-577" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> apply_universe_filters(df, filters<span class="op">=</span>universe_filter)</span>
<span id="cb23-578"><a href="#cb23-578" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df[df[<span class="st">'in_universe'</span>]].copy()</span>
<span id="cb23-579"><a href="#cb23-579" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-580"><a href="#cb23-580" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Lag the signal if requested</span></span>
<span id="cb23-581"><a href="#cb23-581" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> signal_lag <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-582"><a href="#cb23-582" aria-hidden="true" tabindex="-1"></a>        df[signal_col] <span class="op">=</span> (</span>
<span id="cb23-583"><a href="#cb23-583" aria-hidden="true" tabindex="-1"></a>            df.groupby(<span class="st">'ticker'</span>)[signal_col].shift(signal_lag)</span>
<span id="cb23-584"><a href="#cb23-584" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-585"><a href="#cb23-585" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-586"><a href="#cb23-586" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine formation dates</span></span>
<span id="cb23-587"><a href="#cb23-587" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> rebalance_freq <span class="op">==</span> <span class="st">'annual'</span>:</span>
<span id="cb23-588"><a href="#cb23-588" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Form portfolios in formation_month, hold for 12 months</span></span>
<span id="cb23-589"><a href="#cb23-589" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col].<span class="bu">apply</span>(</span>
<span id="cb23-590"><a href="#cb23-590" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> d: pd.Timestamp(</span>
<span id="cb23-591"><a href="#cb23-591" aria-hidden="true" tabindex="-1"></a>                year<span class="op">=</span>d.year <span class="cf">if</span> d.month <span class="op">&gt;=</span> formation_month <span class="cf">else</span> d.year <span class="op">-</span> <span class="dv">1</span>,</span>
<span id="cb23-592"><a href="#cb23-592" aria-hidden="true" tabindex="-1"></a>                month<span class="op">=</span>formation_month, day<span class="op">=</span><span class="dv">30</span></span>
<span id="cb23-593"><a href="#cb23-593" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb23-594"><a href="#cb23-594" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-595"><a href="#cb23-595" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebalance_freq <span class="op">==</span> <span class="st">'monthly'</span>:</span>
<span id="cb23-596"><a href="#cb23-596" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col] <span class="op">-</span> pd.DateOffset(months<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-597"><a href="#cb23-597" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> rebalance_freq <span class="op">==</span> <span class="st">'quarterly'</span>:</span>
<span id="cb23-598"><a href="#cb23-598" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">'formation_date'</span>] <span class="op">=</span> df[date_col].<span class="bu">apply</span>(</span>
<span id="cb23-599"><a href="#cb23-599" aria-hidden="true" tabindex="-1"></a>            <span class="kw">lambda</span> d: pd.Timestamp(</span>
<span id="cb23-600"><a href="#cb23-600" aria-hidden="true" tabindex="-1"></a>                year<span class="op">=</span>d.year,</span>
<span id="cb23-601"><a href="#cb23-601" aria-hidden="true" tabindex="-1"></a>                month<span class="op">=</span>((d.month <span class="op">-</span> <span class="dv">1</span>) <span class="op">//</span> <span class="dv">3</span>) <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span>,</span>
<span id="cb23-602"><a href="#cb23-602" aria-hidden="true" tabindex="-1"></a>                day<span class="op">=</span><span class="dv">1</span></span>
<span id="cb23-603"><a href="#cb23-603" aria-hidden="true" tabindex="-1"></a>            ) <span class="op">-</span> pd.DateOffset(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-604"><a href="#cb23-604" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-605"><a href="#cb23-605" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-606"><a href="#cb23-606" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assign signal and size groups at each formation date</span></span>
<span id="cb23-607"><a href="#cb23-607" aria-hidden="true" tabindex="-1"></a>    all_portfolios <span class="op">=</span> []</span>
<span id="cb23-608"><a href="#cb23-608" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-609"><a href="#cb23-609" aria-hidden="true" tabindex="-1"></a>    formation_dates <span class="op">=</span> <span class="bu">sorted</span>(df[<span class="st">'formation_date'</span>].unique())</span>
<span id="cb23-610"><a href="#cb23-610" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-611"><a href="#cb23-611" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f_date <span class="kw">in</span> formation_dates:</span>
<span id="cb23-612"><a href="#cb23-612" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Stocks available at formation</span></span>
<span id="cb23-613"><a href="#cb23-613" aria-hidden="true" tabindex="-1"></a>        formation_data <span class="op">=</span> df[df[<span class="st">'formation_date'</span>] <span class="op">==</span> f_date].copy()</span>
<span id="cb23-614"><a href="#cb23-614" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-615"><a href="#cb23-615" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get signal values at formation</span></span>
<span id="cb23-616"><a href="#cb23-616" aria-hidden="true" tabindex="-1"></a>        available <span class="op">=</span> formation_data.dropna(subset<span class="op">=</span>[signal_col, size_col])</span>
<span id="cb23-617"><a href="#cb23-617" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(available) <span class="op">&lt;</span> min_stocks_per_portfolio <span class="op">*</span> n_signal_groups <span class="op">*</span> n_size_groups:</span>
<span id="cb23-618"><a href="#cb23-618" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span></span>
<span id="cb23-619"><a href="#cb23-619" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-620"><a href="#cb23-620" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute breakpoints</span></span>
<span id="cb23-621"><a href="#cb23-621" aria-hidden="true" tabindex="-1"></a>        size_bp <span class="op">=</span> compute_breakpoints(</span>
<span id="cb23-622"><a href="#cb23-622" aria-hidden="true" tabindex="-1"></a>            available, size_col, n_size_groups, bp_universe</span>
<span id="cb23-623"><a href="#cb23-623" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-624"><a href="#cb23-624" aria-hidden="true" tabindex="-1"></a>        signal_bp <span class="op">=</span> compute_breakpoints(</span>
<span id="cb23-625"><a href="#cb23-625" aria-hidden="true" tabindex="-1"></a>            available, signal_col, n_signal_groups, bp_universe</span>
<span id="cb23-626"><a href="#cb23-626" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-627"><a href="#cb23-627" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-628"><a href="#cb23-628" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Assign groups</span></span>
<span id="cb23-629"><a href="#cb23-629" aria-hidden="true" tabindex="-1"></a>        available[<span class="st">'size_group'</span>] <span class="op">=</span> np.searchsorted(</span>
<span id="cb23-630"><a href="#cb23-630" aria-hidden="true" tabindex="-1"></a>            size_bp.values, available[size_col].values</span>
<span id="cb23-631"><a href="#cb23-631" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-632"><a href="#cb23-632" aria-hidden="true" tabindex="-1"></a>        available[<span class="st">'signal_group'</span>] <span class="op">=</span> np.searchsorted(</span>
<span id="cb23-633"><a href="#cb23-633" aria-hidden="true" tabindex="-1"></a>            signal_bp.values, available[signal_col].values</span>
<span id="cb23-634"><a href="#cb23-634" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-635"><a href="#cb23-635" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb23-636"><a href="#cb23-636" aria-hidden="true" tabindex="-1"></a>        all_portfolios.append(available)</span>
<span id="cb23-637"><a href="#cb23-637" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-638"><a href="#cb23-638" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> all_portfolios:</span>
<span id="cb23-639"><a href="#cb23-639" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb23-640"><a href="#cb23-640" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-641"><a href="#cb23-641" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> pd.concat(all_portfolios, ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb23-642"><a href="#cb23-642" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-643"><a href="#cb23-643" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute portfolio returns</span></span>
<span id="cb23-644"><a href="#cb23-644" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> weighted_return(group):</span>
<span id="cb23-645"><a href="#cb23-645" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> weighting <span class="op">==</span> <span class="st">'value'</span>:</span>
<span id="cb23-646"><a href="#cb23-646" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> group[size_col].<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb23-647"><a href="#cb23-647" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> np.average(group[return_col], weights<span class="op">=</span>group[size_col])</span>
<span id="cb23-648"><a href="#cb23-648" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb23-649"><a href="#cb23-649" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> group[return_col].mean()</span>
<span id="cb23-650"><a href="#cb23-650" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-651"><a href="#cb23-651" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> group[return_col].mean()</span>
<span id="cb23-652"><a href="#cb23-652" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-653"><a href="#cb23-653" aria-hidden="true" tabindex="-1"></a>    port_returns <span class="op">=</span> (</span>
<span id="cb23-654"><a href="#cb23-654" aria-hidden="true" tabindex="-1"></a>        portfolios</span>
<span id="cb23-655"><a href="#cb23-655" aria-hidden="true" tabindex="-1"></a>        .groupby([date_col, <span class="st">'size_group'</span>, <span class="st">'signal_group'</span>])</span>
<span id="cb23-656"><a href="#cb23-656" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(weighted_return)</span>
<span id="cb23-657"><a href="#cb23-657" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">'port_return'</span>)</span>
<span id="cb23-658"><a href="#cb23-658" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-659"><a href="#cb23-659" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-660"><a href="#cb23-660" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct factor: average of high-signal portfolios minus</span></span>
<span id="cb23-661"><a href="#cb23-661" aria-hidden="true" tabindex="-1"></a>    <span class="co"># average of low-signal portfolios (across size groups)</span></span>
<span id="cb23-662"><a href="#cb23-662" aria-hidden="true" tabindex="-1"></a>    high_label <span class="op">=</span> n_signal_groups <span class="op">-</span> <span class="dv">1</span> <span class="cf">if</span> long_group <span class="op">==</span> <span class="st">'high'</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb23-663"><a href="#cb23-663" aria-hidden="true" tabindex="-1"></a>    low_label <span class="op">=</span> <span class="dv">0</span> <span class="cf">if</span> long_group <span class="op">==</span> <span class="st">'high'</span> <span class="cf">else</span> n_signal_groups <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb23-664"><a href="#cb23-664" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-665"><a href="#cb23-665" aria-hidden="true" tabindex="-1"></a>    high_ports <span class="op">=</span> port_returns[port_returns[<span class="st">'signal_group'</span>] <span class="op">==</span> high_label]</span>
<span id="cb23-666"><a href="#cb23-666" aria-hidden="true" tabindex="-1"></a>    low_ports <span class="op">=</span> port_returns[port_returns[<span class="st">'signal_group'</span>] <span class="op">==</span> low_label]</span>
<span id="cb23-667"><a href="#cb23-667" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-668"><a href="#cb23-668" aria-hidden="true" tabindex="-1"></a>    high_avg <span class="op">=</span> high_ports.groupby(date_col)[<span class="st">'port_return'</span>].mean()</span>
<span id="cb23-669"><a href="#cb23-669" aria-hidden="true" tabindex="-1"></a>    low_avg <span class="op">=</span> low_ports.groupby(date_col)[<span class="st">'port_return'</span>].mean()</span>
<span id="cb23-670"><a href="#cb23-670" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-671"><a href="#cb23-671" aria-hidden="true" tabindex="-1"></a>    factor_returns <span class="op">=</span> (high_avg <span class="op">-</span> low_avg).to_frame(<span class="st">'factor_return'</span>)</span>
<span id="cb23-672"><a href="#cb23-672" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-673"><a href="#cb23-673" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Diagnostics</span></span>
<span id="cb23-674"><a href="#cb23-674" aria-hidden="true" tabindex="-1"></a>    port_counts <span class="op">=</span> (</span>
<span id="cb23-675"><a href="#cb23-675" aria-hidden="true" tabindex="-1"></a>        portfolios</span>
<span id="cb23-676"><a href="#cb23-676" aria-hidden="true" tabindex="-1"></a>        .groupby([date_col, <span class="st">'size_group'</span>, <span class="st">'signal_group'</span>])[<span class="st">'ticker'</span>]</span>
<span id="cb23-677"><a href="#cb23-677" aria-hidden="true" tabindex="-1"></a>        .nunique()</span>
<span id="cb23-678"><a href="#cb23-678" aria-hidden="true" tabindex="-1"></a>        .reset_index(name<span class="op">=</span><span class="st">'n_stocks'</span>)</span>
<span id="cb23-679"><a href="#cb23-679" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-680"><a href="#cb23-680" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-681"><a href="#cb23-681" aria-hidden="true" tabindex="-1"></a>    diagnostics <span class="op">=</span> {</span>
<span id="cb23-682"><a href="#cb23-682" aria-hidden="true" tabindex="-1"></a>        <span class="st">'avg_stocks_per_portfolio'</span>: port_counts[<span class="st">'n_stocks'</span>].mean(),</span>
<span id="cb23-683"><a href="#cb23-683" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_stocks_per_portfolio'</span>: port_counts[<span class="st">'n_stocks'</span>].<span class="bu">min</span>(),</span>
<span id="cb23-684"><a href="#cb23-684" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ann_return'</span>: factor_returns[<span class="st">'factor_return'</span>].mean() <span class="op">*</span> <span class="dv">12</span>,</span>
<span id="cb23-685"><a href="#cb23-685" aria-hidden="true" tabindex="-1"></a>        <span class="st">'ann_vol'</span>: factor_returns[<span class="st">'factor_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>),</span>
<span id="cb23-686"><a href="#cb23-686" aria-hidden="true" tabindex="-1"></a>        <span class="st">'sharpe'</span>: (factor_returns[<span class="st">'factor_return'</span>].mean()</span>
<span id="cb23-687"><a href="#cb23-687" aria-hidden="true" tabindex="-1"></a>                   <span class="op">/</span> factor_returns[<span class="st">'factor_return'</span>].std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)),</span>
<span id="cb23-688"><a href="#cb23-688" aria-hidden="true" tabindex="-1"></a>        <span class="st">'t_stat'</span>: (factor_returns[<span class="st">'factor_return'</span>].mean()</span>
<span id="cb23-689"><a href="#cb23-689" aria-hidden="true" tabindex="-1"></a>                   <span class="op">/</span> (factor_returns[<span class="st">'factor_return'</span>].std()</span>
<span id="cb23-690"><a href="#cb23-690" aria-hidden="true" tabindex="-1"></a>                      <span class="op">/</span> np.sqrt(<span class="bu">len</span>(factor_returns)))),</span>
<span id="cb23-691"><a href="#cb23-691" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_months'</span>: <span class="bu">len</span>(factor_returns)</span>
<span id="cb23-692"><a href="#cb23-692" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-693"><a href="#cb23-693" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-694"><a href="#cb23-694" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb23-695"><a href="#cb23-695" aria-hidden="true" tabindex="-1"></a>        <span class="st">'factor_returns'</span>: factor_returns,</span>
<span id="cb23-696"><a href="#cb23-696" aria-hidden="true" tabindex="-1"></a>        <span class="st">'portfolio_returns'</span>: port_returns,</span>
<span id="cb23-697"><a href="#cb23-697" aria-hidden="true" tabindex="-1"></a>        <span class="st">'portfolios'</span>: portfolios,</span>
<span id="cb23-698"><a href="#cb23-698" aria-hidden="true" tabindex="-1"></a>        <span class="st">'diagnostics'</span>: diagnostics</span>
<span id="cb23-699"><a href="#cb23-699" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-700"><a href="#cb23-700" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-701"><a href="#cb23-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-702"><a href="#cb23-702" aria-hidden="true" tabindex="-1"></a><span class="fu">### Building the Core Factors</span></span>
<span id="cb23-703"><a href="#cb23-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-704"><a href="#cb23-704" aria-hidden="true" tabindex="-1"></a>We now use the engine to construct the standard Fama-French factors for Vietnam:</span>
<span id="cb23-705"><a href="#cb23-705" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-708"><a href="#cb23-708" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-709"><a href="#cb23-709" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: core-factors</span></span>
<span id="cb23-710"><a href="#cb23-710" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-711"><a href="#cb23-711" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Construct SMB, HML, RMW, CMA, and WML for Vietnam"</span></span>
<span id="cb23-712"><a href="#cb23-712" aria-hidden="true" tabindex="-1"></a><span class="co"># SMB (Size): small minus big</span></span>
<span id="cb23-713"><a href="#cb23-713" aria-hidden="true" tabindex="-1"></a><span class="co"># Signal = market cap; long_group = 'low' (small stocks)</span></span>
<span id="cb23-714"><a href="#cb23-714" aria-hidden="true" tabindex="-1"></a>smb_result <span class="op">=</span> construct_factor(</span>
<span id="cb23-715"><a href="#cb23-715" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'log_mcap'</span>, long_group<span class="op">=</span><span class="st">'low'</span>,</span>
<span id="cb23-716"><a href="#cb23-716" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-717"><a href="#cb23-717" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">2</span>, n_size_groups<span class="op">=</span><span class="dv">1</span>,  <span class="co"># No double sort for size itself</span></span>
<span id="cb23-718"><a href="#cb23-718" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-719"><a href="#cb23-719" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-720"><a href="#cb23-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-721"><a href="#cb23-721" aria-hidden="true" tabindex="-1"></a><span class="co"># HML (Value): high BM minus low BM</span></span>
<span id="cb23-722"><a href="#cb23-722" aria-hidden="true" tabindex="-1"></a>hml_result <span class="op">=</span> construct_factor(</span>
<span id="cb23-723"><a href="#cb23-723" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-724"><a href="#cb23-724" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-725"><a href="#cb23-725" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-726"><a href="#cb23-726" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-727"><a href="#cb23-727" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-728"><a href="#cb23-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-729"><a href="#cb23-729" aria-hidden="true" tabindex="-1"></a><span class="co"># RMW (Profitability): robust minus weak</span></span>
<span id="cb23-730"><a href="#cb23-730" aria-hidden="true" tabindex="-1"></a>rmw_result <span class="op">=</span> construct_factor(</span>
<span id="cb23-731"><a href="#cb23-731" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'op'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-732"><a href="#cb23-732" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-733"><a href="#cb23-733" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-734"><a href="#cb23-734" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-735"><a href="#cb23-735" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-736"><a href="#cb23-736" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-737"><a href="#cb23-737" aria-hidden="true" tabindex="-1"></a><span class="co"># CMA (Investment): conservative minus aggressive</span></span>
<span id="cb23-738"><a href="#cb23-738" aria-hidden="true" tabindex="-1"></a>cma_result <span class="op">=</span> construct_factor(</span>
<span id="cb23-739"><a href="#cb23-739" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'investment'</span>, long_group<span class="op">=</span><span class="st">'low'</span>,</span>
<span id="cb23-740"><a href="#cb23-740" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'annual'</span>,</span>
<span id="cb23-741"><a href="#cb23-741" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-742"><a href="#cb23-742" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-743"><a href="#cb23-743" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-744"><a href="#cb23-744" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-745"><a href="#cb23-745" aria-hidden="true" tabindex="-1"></a><span class="co"># WML (Momentum): winners minus losers</span></span>
<span id="cb23-746"><a href="#cb23-746" aria-hidden="true" tabindex="-1"></a>wml_result <span class="op">=</span> construct_factor(</span>
<span id="cb23-747"><a href="#cb23-747" aria-hidden="true" tabindex="-1"></a>    panel, signal_col<span class="op">=</span><span class="st">'ret_12_2'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-748"><a href="#cb23-748" aria-hidden="true" tabindex="-1"></a>    formation_month<span class="op">=</span><span class="dv">6</span>, rebalance_freq<span class="op">=</span><span class="st">'monthly'</span>,</span>
<span id="cb23-749"><a href="#cb23-749" aria-hidden="true" tabindex="-1"></a>    n_signal_groups<span class="op">=</span><span class="dv">3</span>, n_size_groups<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb23-750"><a href="#cb23-750" aria-hidden="true" tabindex="-1"></a>    weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-751"><a href="#cb23-751" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-752"><a href="#cb23-752" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-753"><a href="#cb23-753" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary table</span></span>
<span id="cb23-754"><a href="#cb23-754" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Vietnamese Factor Summary:"</span>)</span>
<span id="cb23-755"><a href="#cb23-755" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ann. Ret'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Ann. Vol'</span><span class="sc">:&gt;10}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Sharpe'</span><span class="sc">:&gt;8}</span><span class="ss"> "</span></span>
<span id="cb23-756"><a href="#cb23-756" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span><span class="st">'t-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Avg N'</span><span class="sc">:&gt;8}</span><span class="ss">"</span>)</span>
<span id="cb23-757"><a href="#cb23-757" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">54</span>)</span>
<span id="cb23-758"><a href="#cb23-758" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb23-759"><a href="#cb23-759" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb23-760"><a href="#cb23-760" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb23-761"><a href="#cb23-761" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-762"><a href="#cb23-762" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-763"><a href="#cb23-763" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-764"><a href="#cb23-764" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'ann_return'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'ann_vol'</span>]<span class="sc">:&gt;10.4f}</span><span class="ss"> "</span></span>
<span id="cb23-765"><a href="#cb23-765" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>d[<span class="st">'sharpe'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>d[<span class="st">'t_stat'</span>]<span class="sc">:&gt;8.2f}</span><span class="ss"> "</span></span>
<span id="cb23-766"><a href="#cb23-766" aria-hidden="true" tabindex="-1"></a>          <span class="ss">f"</span><span class="sc">{</span>d[<span class="st">'avg_stocks_per_portfolio'</span>]<span class="sc">:&gt;8.1f}</span><span class="ss">"</span>)</span>
<span id="cb23-767"><a href="#cb23-767" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-768"><a href="#cb23-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-771"><a href="#cb23-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-772"><a href="#cb23-772" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-factor-cumulative</span></span>
<span id="cb23-773"><a href="#cb23-773" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-774"><a href="#cb23-774" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of the five Vietnamese factors (SMB, HML, RMW, CMA, WML) constructed using the Fama-French 2×3 methodology with HOSE breakpoints and value weighting. Factor behavior reflects Vietnamese market characteristics: the strong HML premium reflects the value tilt of the market, while momentum (WML) shows the characteristic crash-and-recovery pattern."</span></span>
<span id="cb23-775"><a href="#cb23-775" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Plot cumulative factor returns"</span></span>
<span id="cb23-776"><a href="#cb23-776" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">6</span>))</span>
<span id="cb23-777"><a href="#cb23-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-778"><a href="#cb23-778" aria-hidden="true" tabindex="-1"></a>factor_colors <span class="op">=</span> {</span>
<span id="cb23-779"><a href="#cb23-779" aria-hidden="true" tabindex="-1"></a>    <span class="st">'SMB'</span>: <span class="st">'#2C5F8A'</span>, <span class="st">'HML'</span>: <span class="st">'#C0392B'</span>, <span class="st">'RMW'</span>: <span class="st">'#27AE60'</span>,</span>
<span id="cb23-780"><a href="#cb23-780" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CMA'</span>: <span class="st">'#E67E22'</span>, <span class="st">'WML'</span>: <span class="st">'#8E44AD'</span></span>
<span id="cb23-781"><a href="#cb23-781" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-782"><a href="#cb23-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-783"><a href="#cb23-783" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb23-784"><a href="#cb23-784" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb23-785"><a href="#cb23-785" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb23-786"><a href="#cb23-786" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-787"><a href="#cb23-787" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-788"><a href="#cb23-788" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> result[<span class="st">'factor_returns'</span>]</span>
<span id="cb23-789"><a href="#cb23-789" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> fr[<span class="st">'factor_return'</span>]).cumprod()</span>
<span id="cb23-790"><a href="#cb23-790" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum.index, cum.values, color<span class="op">=</span>factor_colors[name],</span>
<span id="cb23-791"><a href="#cb23-791" aria-hidden="true" tabindex="-1"></a>            linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span>name)</span>
<span id="cb23-792"><a href="#cb23-792" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-793"><a href="#cb23-793" aria-hidden="true" tabindex="-1"></a>ax.axhline(y<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-794"><a href="#cb23-794" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Cumulative Return'</span>)</span>
<span id="cb23-795"><a href="#cb23-795" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">'Date'</span>)</span>
<span id="cb23-796"><a href="#cb23-796" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Vietnamese Factor Cumulative Returns (2×3 VW, HOSE Breakpoints)'</span>)</span>
<span id="cb23-797"><a href="#cb23-797" aria-hidden="true" tabindex="-1"></a>ax.legend(ncol<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb23-798"><a href="#cb23-798" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">'log'</span>)</span>
<span id="cb23-799"><a href="#cb23-799" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-800"><a href="#cb23-800" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-801"><a href="#cb23-801" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-802"><a href="#cb23-802" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-803"><a href="#cb23-803" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Sensitivity to Construction Choices {#sec-factor-con-sensitivity}</span></span>
<span id="cb23-804"><a href="#cb23-804" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-805"><a href="#cb23-805" aria-hidden="true" tabindex="-1"></a>The most important lesson in factor construction is that the resulting factor premium is *not* uniquely determined by the economic hypothesis; it depends substantially on implementation choices. We systematically vary each choice and examine how the factor changes.</span>
<span id="cb23-806"><a href="#cb23-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-807"><a href="#cb23-807" aria-hidden="true" tabindex="-1"></a><span class="fu">### Weighting: Value-Weighted vs. Equal-Weighted</span></span>
<span id="cb23-808"><a href="#cb23-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-811"><a href="#cb23-811" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-812"><a href="#cb23-812" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: vw-vs-ew</span></span>
<span id="cb23-813"><a href="#cb23-813" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-814"><a href="#cb23-814" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare VW and EW factor construction"</span></span>
<span id="cb23-815"><a href="#cb23-815" aria-hidden="true" tabindex="-1"></a>sensitivity_results <span class="op">=</span> {}</span>
<span id="cb23-816"><a href="#cb23-816" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-817"><a href="#cb23-817" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, signal, long_grp <span class="kw">in</span> [</span>
<span id="cb23-818"><a href="#cb23-818" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'HML'</span>, <span class="st">'bm'</span>, <span class="st">'high'</span>), (<span class="st">'RMW'</span>, <span class="st">'op'</span>, <span class="st">'high'</span>), (<span class="st">'WML'</span>, <span class="st">'ret_12_2'</span>, <span class="st">'high'</span>)</span>
<span id="cb23-819"><a href="#cb23-819" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb23-820"><a href="#cb23-820" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> wt <span class="kw">in</span> [<span class="st">'value'</span>, <span class="st">'equal'</span>]:</span>
<span id="cb23-821"><a href="#cb23-821" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> construct_factor(</span>
<span id="cb23-822"><a href="#cb23-822" aria-hidden="true" tabindex="-1"></a>            panel, signal_col<span class="op">=</span>signal, long_group<span class="op">=</span>long_grp,</span>
<span id="cb23-823"><a href="#cb23-823" aria-hidden="true" tabindex="-1"></a>            weighting<span class="op">=</span>wt, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb23-824"><a href="#cb23-824" aria-hidden="true" tabindex="-1"></a>            rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> name <span class="op">!=</span> <span class="st">'WML'</span> <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb23-825"><a href="#cb23-825" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-826"><a href="#cb23-826" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result:</span>
<span id="cb23-827"><a href="#cb23-827" aria-hidden="true" tabindex="-1"></a>            d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-828"><a href="#cb23-828" aria-hidden="true" tabindex="-1"></a>            sensitivity_results[<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_</span><span class="sc">{</span>wt<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> {</span>
<span id="cb23-829"><a href="#cb23-829" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Factor'</span>: name, <span class="st">'Weighting'</span>: wt,</span>
<span id="cb23-830"><a href="#cb23-830" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb23-831"><a href="#cb23-831" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb23-832"><a href="#cb23-832" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb23-833"><a href="#cb23-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-834"><a href="#cb23-834" aria-hidden="true" tabindex="-1"></a>sens_df <span class="op">=</span> pd.DataFrame(sensitivity_results).T</span>
<span id="cb23-835"><a href="#cb23-835" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"VW vs EW Factor Returns:"</span>)</span>
<span id="cb23-836"><a href="#cb23-836" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sens_df.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb23-837"><a href="#cb23-837" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-838"><a href="#cb23-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-839"><a href="#cb23-839" aria-hidden="true" tabindex="-1"></a><span class="fu">### Breakpoint Universe: HOSE vs. All Stocks</span></span>
<span id="cb23-840"><a href="#cb23-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-843"><a href="#cb23-843" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-844"><a href="#cb23-844" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: bp-sensitivity</span></span>
<span id="cb23-845"><a href="#cb23-845" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-846"><a href="#cb23-846" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare HOSE vs all-stock breakpoints"</span></span>
<span id="cb23-847"><a href="#cb23-847" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, signal, long_grp <span class="kw">in</span> [</span>
<span id="cb23-848"><a href="#cb23-848" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'HML'</span>, <span class="st">'bm'</span>, <span class="st">'high'</span>), (<span class="st">'WML'</span>, <span class="st">'ret_12_2'</span>, <span class="st">'high'</span>)</span>
<span id="cb23-849"><a href="#cb23-849" aria-hidden="true" tabindex="-1"></a>]:</span>
<span id="cb23-850"><a href="#cb23-850" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> bp <span class="kw">in</span> [<span class="st">'hose'</span>, <span class="st">'all'</span>]:</span>
<span id="cb23-851"><a href="#cb23-851" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> construct_factor(</span>
<span id="cb23-852"><a href="#cb23-852" aria-hidden="true" tabindex="-1"></a>            panel, signal_col<span class="op">=</span>signal, long_group<span class="op">=</span>long_grp,</span>
<span id="cb23-853"><a href="#cb23-853" aria-hidden="true" tabindex="-1"></a>            bp_universe<span class="op">=</span>bp, weighting<span class="op">=</span><span class="st">'value'</span>,</span>
<span id="cb23-854"><a href="#cb23-854" aria-hidden="true" tabindex="-1"></a>            rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> name <span class="op">!=</span> <span class="st">'WML'</span> <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb23-855"><a href="#cb23-855" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-856"><a href="#cb23-856" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> result:</span>
<span id="cb23-857"><a href="#cb23-857" aria-hidden="true" tabindex="-1"></a>            d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-858"><a href="#cb23-858" aria-hidden="true" tabindex="-1"></a>            sensitivity_results[<span class="ss">f"</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">_bp_</span><span class="sc">{</span>bp<span class="sc">}</span><span class="ss">"</span>] <span class="op">=</span> {</span>
<span id="cb23-859"><a href="#cb23-859" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Factor'</span>: name, <span class="st">'Breakpoints'</span>: bp,</span>
<span id="cb23-860"><a href="#cb23-860" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb23-861"><a href="#cb23-861" aria-hidden="true" tabindex="-1"></a>                <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>],</span>
<span id="cb23-862"><a href="#cb23-862" aria-hidden="true" tabindex="-1"></a>                <span class="st">'Avg N'</span>: d[<span class="st">'avg_stocks_per_portfolio'</span>]</span>
<span id="cb23-863"><a href="#cb23-863" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb23-864"><a href="#cb23-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-865"><a href="#cb23-865" aria-hidden="true" tabindex="-1"></a>bp_sens <span class="op">=</span> pd.DataFrame({k: v <span class="cf">for</span> k, v <span class="kw">in</span> sensitivity_results.items()</span>
<span id="cb23-866"><a href="#cb23-866" aria-hidden="true" tabindex="-1"></a>                          <span class="cf">if</span> <span class="st">'bp_'</span> <span class="kw">in</span> k}).T</span>
<span id="cb23-867"><a href="#cb23-867" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Breakpoint Universe Sensitivity:"</span>)</span>
<span id="cb23-868"><a href="#cb23-868" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(bp_sens.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb23-869"><a href="#cb23-869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-870"><a href="#cb23-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-871"><a href="#cb23-871" aria-hidden="true" tabindex="-1"></a><span class="fu">### Number of Groups: 2×3 vs. 5×5 vs. Deciles</span></span>
<span id="cb23-872"><a href="#cb23-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-875"><a href="#cb23-875" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-876"><a href="#cb23-876" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: group-sensitivity</span></span>
<span id="cb23-877"><a href="#cb23-877" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-878"><a href="#cb23-878" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare different sorting granularities"</span></span>
<span id="cb23-879"><a href="#cb23-879" aria-hidden="true" tabindex="-1"></a>group_configs <span class="op">=</span> [</span>
<span id="cb23-880"><a href="#cb23-880" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">3</span>, <span class="st">'2x3 (FF standard)'</span>),</span>
<span id="cb23-881"><a href="#cb23-881" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">2</span>, <span class="dv">5</span>, <span class="st">'2x5 (quintiles)'</span>),</span>
<span id="cb23-882"><a href="#cb23-882" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span>, <span class="dv">10</span>, <span class="st">'1x10 (deciles)'</span>)</span>
<span id="cb23-883"><a href="#cb23-883" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb23-884"><a href="#cb23-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-885"><a href="#cb23-885" aria-hidden="true" tabindex="-1"></a>group_results <span class="op">=</span> {}</span>
<span id="cb23-886"><a href="#cb23-886" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> n_size, n_signal, label <span class="kw">in</span> group_configs:</span>
<span id="cb23-887"><a href="#cb23-887" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb23-888"><a href="#cb23-888" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-889"><a href="#cb23-889" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span>n_size, n_signal_groups<span class="op">=</span>n_signal,</span>
<span id="cb23-890"><a href="#cb23-890" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb23-891"><a href="#cb23-891" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb23-892"><a href="#cb23-892" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-893"><a href="#cb23-893" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb23-894"><a href="#cb23-894" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-895"><a href="#cb23-895" aria-hidden="true" tabindex="-1"></a>        group_results[label] <span class="op">=</span> {</span>
<span id="cb23-896"><a href="#cb23-896" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb23-897"><a href="#cb23-897" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>],</span>
<span id="cb23-898"><a href="#cb23-898" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Avg N per port'</span>: d[<span class="st">'avg_stocks_per_portfolio'</span>],</span>
<span id="cb23-899"><a href="#cb23-899" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Min N per port'</span>: d[<span class="st">'min_stocks_per_portfolio'</span>]</span>
<span id="cb23-900"><a href="#cb23-900" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-901"><a href="#cb23-901" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-902"><a href="#cb23-902" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML: Sorting Granularity Sensitivity:"</span>)</span>
<span id="cb23-903"><a href="#cb23-903" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(group_results).T.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb23-904"><a href="#cb23-904" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-905"><a href="#cb23-905" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-906"><a href="#cb23-906" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rebalancing Frequency</span></span>
<span id="cb23-907"><a href="#cb23-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-910"><a href="#cb23-910" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-911"><a href="#cb23-911" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: rebalance-sensitivity</span></span>
<span id="cb23-912"><a href="#cb23-912" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-913"><a href="#cb23-913" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare annual vs quarterly vs monthly rebalancing"</span></span>
<span id="cb23-914"><a href="#cb23-914" aria-hidden="true" tabindex="-1"></a>rebal_results <span class="op">=</span> {}</span>
<span id="cb23-915"><a href="#cb23-915" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> freq <span class="kw">in</span> [<span class="st">'annual'</span>, <span class="st">'quarterly'</span>, <span class="st">'monthly'</span>]:</span>
<span id="cb23-916"><a href="#cb23-916" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb23-917"><a href="#cb23-917" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-918"><a href="#cb23-918" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span>freq, weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span></span>
<span id="cb23-919"><a href="#cb23-919" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-920"><a href="#cb23-920" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb23-921"><a href="#cb23-921" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-922"><a href="#cb23-922" aria-hidden="true" tabindex="-1"></a>        rebal_results[freq] <span class="op">=</span> {</span>
<span id="cb23-923"><a href="#cb23-923" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb23-924"><a href="#cb23-924" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Vol'</span>: d[<span class="st">'ann_vol'</span>],</span>
<span id="cb23-925"><a href="#cb23-925" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb23-926"><a href="#cb23-926" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-927"><a href="#cb23-927" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-928"><a href="#cb23-928" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML: Rebalancing Frequency Sensitivity:"</span>)</span>
<span id="cb23-929"><a href="#cb23-929" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(rebal_results).T.<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb23-930"><a href="#cb23-930" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-931"><a href="#cb23-931" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-932"><a href="#cb23-932" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comprehensive Sensitivity Summary</span></span>
<span id="cb23-933"><a href="#cb23-933" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-936"><a href="#cb23-936" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-937"><a href="#cb23-937" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-sensitivity-heatmap</span></span>
<span id="cb23-938"><a href="#cb23-938" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-939"><a href="#cb23-939" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Sensitivity of factor premia to construction choices. Each cell shows the annualized long-short return under a specific combination of weighting (VW vs EW), breakpoint universe (HOSE vs all), and number of groups. Cells are shaded by t-statistic magnitude: darker = more statistically significant. Results that are robust across all cells are more credible."</span></span>
<span id="cb23-940"><a href="#cb23-940" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Heatmap of factor premium sensitivity"</span></span>
<span id="cb23-941"><a href="#cb23-941" aria-hidden="true" tabindex="-1"></a><span class="co"># Systematic grid search for HML</span></span>
<span id="cb23-942"><a href="#cb23-942" aria-hidden="true" tabindex="-1"></a>configs <span class="op">=</span> <span class="bu">list</span>(product(</span>
<span id="cb23-943"><a href="#cb23-943" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'value'</span>, <span class="st">'equal'</span>],        <span class="co"># Weighting</span></span>
<span id="cb23-944"><a href="#cb23-944" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'hose'</span>, <span class="st">'all'</span>],           <span class="co"># Breakpoint universe</span></span>
<span id="cb23-945"><a href="#cb23-945" aria-hidden="true" tabindex="-1"></a>    [(<span class="dv">2</span>, <span class="dv">3</span>), (<span class="dv">2</span>, <span class="dv">5</span>), (<span class="dv">1</span>, <span class="dv">10</span>)]  <span class="co"># (n_size, n_signal)</span></span>
<span id="cb23-946"><a href="#cb23-946" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb23-947"><a href="#cb23-947" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-948"><a href="#cb23-948" aria-hidden="true" tabindex="-1"></a>grid_results <span class="op">=</span> []</span>
<span id="cb23-949"><a href="#cb23-949" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> wt, bp, (ns, nsig) <span class="kw">in</span> configs:</span>
<span id="cb23-950"><a href="#cb23-950" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb23-951"><a href="#cb23-951" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-952"><a href="#cb23-952" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span>wt, bp_universe<span class="op">=</span>bp,</span>
<span id="cb23-953"><a href="#cb23-953" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span>ns, n_signal_groups<span class="op">=</span>nsig,</span>
<span id="cb23-954"><a href="#cb23-954" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb23-955"><a href="#cb23-955" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-956"><a href="#cb23-956" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result:</span>
<span id="cb23-957"><a href="#cb23-957" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-958"><a href="#cb23-958" aria-hidden="true" tabindex="-1"></a>        grid_results.append({</span>
<span id="cb23-959"><a href="#cb23-959" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Weighting'</span>: <span class="st">'VW'</span> <span class="cf">if</span> wt <span class="op">==</span> <span class="st">'value'</span> <span class="cf">else</span> <span class="st">'EW'</span>,</span>
<span id="cb23-960"><a href="#cb23-960" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Breakpoints'</span>: bp.upper(),</span>
<span id="cb23-961"><a href="#cb23-961" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Sort'</span>: <span class="ss">f'</span><span class="sc">{</span>ns<span class="sc">}</span><span class="ss">x</span><span class="sc">{</span>nsig<span class="sc">}</span><span class="ss">'</span>,</span>
<span id="cb23-962"><a href="#cb23-962" aria-hidden="true" tabindex="-1"></a>            <span class="st">'Ann. Return'</span>: d[<span class="st">'ann_return'</span>],</span>
<span id="cb23-963"><a href="#cb23-963" aria-hidden="true" tabindex="-1"></a>            <span class="st">'t-stat'</span>: d[<span class="st">'t_stat'</span>]</span>
<span id="cb23-964"><a href="#cb23-964" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb23-965"><a href="#cb23-965" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-966"><a href="#cb23-966" aria-hidden="true" tabindex="-1"></a>grid_df <span class="op">=</span> pd.DataFrame(grid_results)</span>
<span id="cb23-967"><a href="#cb23-967" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"HML Factor: Full Sensitivity Grid:"</span>)</span>
<span id="cb23-968"><a href="#cb23-968" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(grid_df.to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb23-969"><a href="#cb23-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-970"><a href="#cb23-970" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot for heatmap</span></span>
<span id="cb23-971"><a href="#cb23-971" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> grid_df.pivot_table(</span>
<span id="cb23-972"><a href="#cb23-972" aria-hidden="true" tabindex="-1"></a>    values<span class="op">=</span><span class="st">'Ann. Return'</span>, index<span class="op">=</span>[<span class="st">'Weighting'</span>, <span class="st">'Breakpoints'</span>],</span>
<span id="cb23-973"><a href="#cb23-973" aria-hidden="true" tabindex="-1"></a>    columns<span class="op">=</span><span class="st">'Sort'</span></span>
<span id="cb23-974"><a href="#cb23-974" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-975"><a href="#cb23-975" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-976"><a href="#cb23-976" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">5</span>))</span>
<span id="cb23-977"><a href="#cb23-977" aria-hidden="true" tabindex="-1"></a>sns.heatmap(pivot <span class="op">*</span> <span class="dv">100</span>, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'.1f'</span>, cmap<span class="op">=</span><span class="st">'RdYlGn'</span>,</span>
<span id="cb23-978"><a href="#cb23-978" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>, linewidths<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax,</span>
<span id="cb23-979"><a href="#cb23-979" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">'label'</span>: <span class="st">'Ann. Return (%)'</span>})</span>
<span id="cb23-980"><a href="#cb23-980" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'HML Premium: Sensitivity to Construction Choices'</span>)</span>
<span id="cb23-981"><a href="#cb23-981" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-982"><a href="#cb23-982" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-983"><a href="#cb23-983" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-984"><a href="#cb23-984" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-985"><a href="#cb23-985" aria-hidden="true" tabindex="-1"></a><span class="fu">## Factor Correlation Structure {#sec-factor-con-correlation}</span></span>
<span id="cb23-986"><a href="#cb23-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-989"><a href="#cb23-989" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-990"><a href="#cb23-990" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-factor-correlations</span></span>
<span id="cb23-991"><a href="#cb23-991" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-992"><a href="#cb23-992" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Correlation matrix of Vietnamese factor returns. SMB and HML are near-zero correlated (by construction in the 2×3 methodology, which controls for size within each signal sort). WML shows low correlation with accounting-based factors. The correlation structure reveals the degree of independent information in each factor."</span></span>
<span id="cb23-993"><a href="#cb23-993" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute and plot factor return correlation matrix"</span></span>
<span id="cb23-994"><a href="#cb23-994" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all factor return series</span></span>
<span id="cb23-995"><a href="#cb23-995" aria-hidden="true" tabindex="-1"></a>factor_panel <span class="op">=</span> pd.DataFrame()</span>
<span id="cb23-996"><a href="#cb23-996" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb23-997"><a href="#cb23-997" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb23-998"><a href="#cb23-998" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb23-999"><a href="#cb23-999" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-1000"><a href="#cb23-1000" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-1001"><a href="#cb23-1001" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> result[<span class="st">'factor_returns'</span>].rename(columns<span class="op">=</span>{<span class="st">'factor_return'</span>: name})</span>
<span id="cb23-1002"><a href="#cb23-1002" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> factor_panel.empty:</span>
<span id="cb23-1003"><a href="#cb23-1003" aria-hidden="true" tabindex="-1"></a>        factor_panel <span class="op">=</span> fr</span>
<span id="cb23-1004"><a href="#cb23-1004" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb23-1005"><a href="#cb23-1005" aria-hidden="true" tabindex="-1"></a>        factor_panel <span class="op">=</span> factor_panel.merge(fr, left_index<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-1006"><a href="#cb23-1006" aria-hidden="true" tabindex="-1"></a>                                           right_index<span class="op">=</span><span class="va">True</span>, how<span class="op">=</span><span class="st">'outer'</span>)</span>
<span id="cb23-1007"><a href="#cb23-1007" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1008"><a href="#cb23-1008" aria-hidden="true" tabindex="-1"></a>corr <span class="op">=</span> factor_panel.corr()</span>
<span id="cb23-1009"><a href="#cb23-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1010"><a href="#cb23-1010" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">6</span>))</span>
<span id="cb23-1011"><a href="#cb23-1011" aria-hidden="true" tabindex="-1"></a>mask <span class="op">=</span> np.triu(np.ones_like(corr, dtype<span class="op">=</span><span class="bu">bool</span>), k<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-1012"><a href="#cb23-1012" aria-hidden="true" tabindex="-1"></a>sns.heatmap(corr, mask<span class="op">=</span>mask, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'.2f'</span>, cmap<span class="op">=</span><span class="st">'RdBu_r'</span>,</span>
<span id="cb23-1013"><a href="#cb23-1013" aria-hidden="true" tabindex="-1"></a>            center<span class="op">=</span><span class="dv">0</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>, square<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb23-1014"><a href="#cb23-1014" aria-hidden="true" tabindex="-1"></a>            linewidths<span class="op">=</span><span class="fl">0.5</span>, ax<span class="op">=</span>ax)</span>
<span id="cb23-1015"><a href="#cb23-1015" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">'Factor Return Correlations'</span>)</span>
<span id="cb23-1016"><a href="#cb23-1016" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-1017"><a href="#cb23-1017" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-1018"><a href="#cb23-1018" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1019"><a href="#cb23-1019" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1020"><a href="#cb23-1020" aria-hidden="true" tabindex="-1"></a><span class="fu">## Factor Validation {#sec-factor-con-validation}</span></span>
<span id="cb23-1021"><a href="#cb23-1021" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1022"><a href="#cb23-1022" aria-hidden="true" tabindex="-1"></a>A well-constructed factor should pass several diagnostic tests before being used in asset pricing research.</span>
<span id="cb23-1023"><a href="#cb23-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1024"><a href="#cb23-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">### Diagnostic Checklist</span></span>
<span id="cb23-1025"><a href="#cb23-1025" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1028"><a href="#cb23-1028" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1029"><a href="#cb23-1029" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: validation</span></span>
<span id="cb23-1030"><a href="#cb23-1030" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1031"><a href="#cb23-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Run diagnostic tests on each factor"</span></span>
<span id="cb23-1032"><a href="#cb23-1032" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> validate_factor(factor_result, name):</span>
<span id="cb23-1033"><a href="#cb23-1033" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb23-1034"><a href="#cb23-1034" aria-hidden="true" tabindex="-1"></a><span class="co">    Run standard diagnostic tests on a constructed factor.</span></span>
<span id="cb23-1035"><a href="#cb23-1035" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb23-1036"><a href="#cb23-1036" aria-hidden="true" tabindex="-1"></a>    fr <span class="op">=</span> factor_result[<span class="st">'factor_returns'</span>][<span class="st">'factor_return'</span>]</span>
<span id="cb23-1037"><a href="#cb23-1037" aria-hidden="true" tabindex="-1"></a>    diag <span class="op">=</span> factor_result[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-1038"><a href="#cb23-1038" aria-hidden="true" tabindex="-1"></a>    ports <span class="op">=</span> factor_result[<span class="st">'portfolios'</span>]</span>
<span id="cb23-1039"><a href="#cb23-1039" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1040"><a href="#cb23-1040" aria-hidden="true" tabindex="-1"></a>    tests <span class="op">=</span> {}</span>
<span id="cb23-1041"><a href="#cb23-1041" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1042"><a href="#cb23-1042" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1. Statistical significance (t &gt; 2)</span></span>
<span id="cb23-1043"><a href="#cb23-1043" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'t-stat'</span>] <span class="op">=</span> diag[<span class="st">'t_stat'</span>]</span>
<span id="cb23-1044"><a href="#cb23-1044" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'t &gt; 2'</span>] <span class="op">=</span> <span class="bu">abs</span>(diag[<span class="st">'t_stat'</span>]) <span class="op">&gt;</span> <span class="fl">2.0</span></span>
<span id="cb23-1045"><a href="#cb23-1045" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1046"><a href="#cb23-1046" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2. Economic magnitude</span></span>
<span id="cb23-1047"><a href="#cb23-1047" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Ann. Return'</span>] <span class="op">=</span> diag[<span class="st">'ann_return'</span>]</span>
<span id="cb23-1048"><a href="#cb23-1048" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Ann. Vol'</span>] <span class="op">=</span> diag[<span class="st">'ann_vol'</span>]</span>
<span id="cb23-1049"><a href="#cb23-1049" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Sharpe'</span>] <span class="op">=</span> diag[<span class="st">'sharpe'</span>]</span>
<span id="cb23-1050"><a href="#cb23-1050" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1051"><a href="#cb23-1051" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3. Adequate portfolio diversification</span></span>
<span id="cb23-1052"><a href="#cb23-1052" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Avg N per portfolio'</span>] <span class="op">=</span> diag[<span class="st">'avg_stocks_per_portfolio'</span>]</span>
<span id="cb23-1053"><a href="#cb23-1053" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min N per portfolio'</span>] <span class="op">=</span> diag[<span class="st">'min_stocks_per_portfolio'</span>]</span>
<span id="cb23-1054"><a href="#cb23-1054" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min N &gt;= 5'</span>] <span class="op">=</span> diag[<span class="st">'min_stocks_per_portfolio'</span>] <span class="op">&gt;=</span> <span class="dv">5</span></span>
<span id="cb23-1055"><a href="#cb23-1055" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1056"><a href="#cb23-1056" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4. Not dominated by a single month</span></span>
<span id="cb23-1057"><a href="#cb23-1057" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Max monthly return'</span>] <span class="op">=</span> fr.<span class="bu">max</span>()</span>
<span id="cb23-1058"><a href="#cb23-1058" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Min monthly return'</span>] <span class="op">=</span> fr.<span class="bu">min</span>()</span>
<span id="cb23-1059"><a href="#cb23-1059" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Fraction &gt; 0'</span>] <span class="op">=</span> (fr <span class="op">&gt;</span> <span class="dv">0</span>).mean()</span>
<span id="cb23-1060"><a href="#cb23-1060" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1061"><a href="#cb23-1061" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 5. Persistence (ACF at lag 1)</span></span>
<span id="cb23-1062"><a href="#cb23-1062" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(fr) <span class="op">&gt;</span> <span class="dv">12</span>:</span>
<span id="cb23-1063"><a href="#cb23-1063" aria-hidden="true" tabindex="-1"></a>        tests[<span class="st">'ACF(1)'</span>] <span class="op">=</span> fr.autocorr(lag<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-1064"><a href="#cb23-1064" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1065"><a href="#cb23-1065" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 6. Consistency across subperiods</span></span>
<span id="cb23-1066"><a href="#cb23-1066" aria-hidden="true" tabindex="-1"></a>    mid <span class="op">=</span> <span class="bu">len</span>(fr) <span class="op">//</span> <span class="dv">2</span></span>
<span id="cb23-1067"><a href="#cb23-1067" aria-hidden="true" tabindex="-1"></a>    first_half <span class="op">=</span> fr.iloc[:mid]</span>
<span id="cb23-1068"><a href="#cb23-1068" aria-hidden="true" tabindex="-1"></a>    second_half <span class="op">=</span> fr.iloc[mid:]</span>
<span id="cb23-1069"><a href="#cb23-1069" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Return (1st half)'</span>] <span class="op">=</span> first_half.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb23-1070"><a href="#cb23-1070" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Return (2nd half)'</span>] <span class="op">=</span> second_half.mean() <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb23-1071"><a href="#cb23-1071" aria-hidden="true" tabindex="-1"></a>    tests[<span class="st">'Same sign both halves'</span>] <span class="op">=</span> (</span>
<span id="cb23-1072"><a href="#cb23-1072" aria-hidden="true" tabindex="-1"></a>        np.sign(first_half.mean()) <span class="op">==</span> np.sign(second_half.mean())</span>
<span id="cb23-1073"><a href="#cb23-1073" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1074"><a href="#cb23-1074" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1075"><a href="#cb23-1075" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tests</span>
<span id="cb23-1076"><a href="#cb23-1076" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1077"><a href="#cb23-1077" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor Validation Summary:"</span>)</span>
<span id="cb23-1078"><a href="#cb23-1078" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">70</span>)</span>
<span id="cb23-1079"><a href="#cb23-1079" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> name, result <span class="kw">in</span> [(<span class="st">'SMB'</span>, smb_result), (<span class="st">'HML'</span>, hml_result),</span>
<span id="cb23-1080"><a href="#cb23-1080" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'RMW'</span>, rmw_result), (<span class="st">'CMA'</span>, cma_result),</span>
<span id="cb23-1081"><a href="#cb23-1081" aria-hidden="true" tabindex="-1"></a>                       (<span class="st">'WML'</span>, wml_result)]:</span>
<span id="cb23-1082"><a href="#cb23-1082" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-1083"><a href="#cb23-1083" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-1084"><a href="#cb23-1084" aria-hidden="true" tabindex="-1"></a>    tests <span class="op">=</span> validate_factor(result, name)</span>
<span id="cb23-1085"><a href="#cb23-1085" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb23-1086"><a href="#cb23-1086" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> test, value <span class="kw">in</span> tests.items():</span>
<span id="cb23-1087"><a href="#cb23-1087" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">bool</span>):</span>
<span id="cb23-1088"><a href="#cb23-1088" aria-hidden="true" tabindex="-1"></a>            status <span class="op">=</span> <span class="st">'PASS'</span> <span class="cf">if</span> value <span class="cf">else</span> <span class="st">'FAIL'</span></span>
<span id="cb23-1089"><a href="#cb23-1089" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>status<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-1090"><a href="#cb23-1090" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> <span class="bu">isinstance</span>(value, <span class="bu">float</span>):</span>
<span id="cb23-1091"><a href="#cb23-1091" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb23-1092"><a href="#cb23-1092" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb23-1093"><a href="#cb23-1093" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"  </span><span class="sc">{</span>test<span class="sc">:&lt;30}</span><span class="ss">: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb23-1094"><a href="#cb23-1094" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1095"><a href="#cb23-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1096"><a href="#cb23-1096" aria-hidden="true" tabindex="-1"></a><span class="fu">### Monotonicity Test</span></span>
<span id="cb23-1097"><a href="#cb23-1097" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1098"><a href="#cb23-1098" aria-hidden="true" tabindex="-1"></a>A factor built from a characteristic sort should produce monotonically increasing (or decreasing) average returns across quantiles. Violations of monotonicity suggest the signal-return relationship is nonlinear or absent.</span>
<span id="cb23-1099"><a href="#cb23-1099" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1102"><a href="#cb23-1102" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1103"><a href="#cb23-1103" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-monotonicity</span></span>
<span id="cb23-1104"><a href="#cb23-1104" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1105"><a href="#cb23-1105" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Decile portfolio returns sorted on each signal (independent of size). Monotonicity—a steady increase from the low-signal to the high-signal decile—validates the signal-return relationship. Violations (e.g., a U-shaped pattern) suggest nonlinearity or construction artifacts."</span></span>
<span id="cb23-1106"><a href="#cb23-1106" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Test monotonicity of returns across signal deciles"</span></span>
<span id="cb23-1107"><a href="#cb23-1107" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">3</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">10</span>))</span>
<span id="cb23-1108"><a href="#cb23-1108" aria-hidden="true" tabindex="-1"></a>axes <span class="op">=</span> axes.flatten()</span>
<span id="cb23-1109"><a href="#cb23-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1110"><a href="#cb23-1110" aria-hidden="true" tabindex="-1"></a>signals <span class="op">=</span> [</span>
<span id="cb23-1111"><a href="#cb23-1111" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'bm'</span>, <span class="st">'Book-to-Market'</span>, <span class="st">'high'</span>),</span>
<span id="cb23-1112"><a href="#cb23-1112" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'op'</span>, <span class="st">'Operating Profit.'</span>, <span class="st">'high'</span>),</span>
<span id="cb23-1113"><a href="#cb23-1113" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'investment'</span>, <span class="st">'Investment'</span>, <span class="st">'low'</span>),</span>
<span id="cb23-1114"><a href="#cb23-1114" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'ret_12_2'</span>, <span class="st">'Momentum (12-2)'</span>, <span class="st">'high'</span>),</span>
<span id="cb23-1115"><a href="#cb23-1115" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'ivol'</span>, <span class="st">'Idio. Volatility'</span>, <span class="st">'low'</span>),</span>
<span id="cb23-1116"><a href="#cb23-1116" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb23-1117"><a href="#cb23-1117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1118"><a href="#cb23-1118" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, (sig, label, long_grp) <span class="kw">in</span> <span class="bu">enumerate</span>(signals):</span>
<span id="cb23-1119"><a href="#cb23-1119" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> construct_factor(</span>
<span id="cb23-1120"><a href="#cb23-1120" aria-hidden="true" tabindex="-1"></a>        panel, signal_col<span class="op">=</span>sig, long_group<span class="op">=</span>long_grp,</span>
<span id="cb23-1121"><a href="#cb23-1121" aria-hidden="true" tabindex="-1"></a>        n_size_groups<span class="op">=</span><span class="dv">1</span>, n_signal_groups<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb23-1122"><a href="#cb23-1122" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'hose'</span>,</span>
<span id="cb23-1123"><a href="#cb23-1123" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span> <span class="cf">if</span> sig <span class="kw">not</span> <span class="kw">in</span> [<span class="st">'ret_12_2'</span>] <span class="cf">else</span> <span class="st">'monthly'</span></span>
<span id="cb23-1124"><a href="#cb23-1124" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1125"><a href="#cb23-1125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> result <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb23-1126"><a href="#cb23-1126" aria-hidden="true" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb23-1127"><a href="#cb23-1127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1128"><a href="#cb23-1128" aria-hidden="true" tabindex="-1"></a>    port_ret <span class="op">=</span> result[<span class="st">'portfolio_returns'</span>]</span>
<span id="cb23-1129"><a href="#cb23-1129" aria-hidden="true" tabindex="-1"></a>    decile_means <span class="op">=</span> (</span>
<span id="cb23-1130"><a href="#cb23-1130" aria-hidden="true" tabindex="-1"></a>        port_ret.groupby(<span class="st">'signal_group'</span>)[<span class="st">'port_return'</span>]</span>
<span id="cb23-1131"><a href="#cb23-1131" aria-hidden="true" tabindex="-1"></a>        .mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-1132"><a href="#cb23-1132" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1133"><a href="#cb23-1133" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1134"><a href="#cb23-1134" aria-hidden="true" tabindex="-1"></a>    colors_mono <span class="op">=</span> plt.cm.RdYlGn_r(np.linspace(<span class="fl">0.1</span>, <span class="fl">0.9</span>, <span class="bu">len</span>(decile_means)))</span>
<span id="cb23-1135"><a href="#cb23-1135" aria-hidden="true" tabindex="-1"></a>    axes[i].bar(<span class="bu">range</span>(<span class="bu">len</span>(decile_means)), decile_means.values,</span>
<span id="cb23-1136"><a href="#cb23-1136" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span>colors_mono, edgecolor<span class="op">=</span><span class="st">'white'</span>)</span>
<span id="cb23-1137"><a href="#cb23-1137" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xticks(<span class="bu">range</span>(<span class="bu">len</span>(decile_means)))</span>
<span id="cb23-1138"><a href="#cb23-1138" aria-hidden="true" tabindex="-1"></a>    axes[i].set_xticklabels([<span class="ss">f'D</span><span class="sc">{</span>d<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span> <span class="cf">for</span> d <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(decile_means))],</span>
<span id="cb23-1139"><a href="#cb23-1139" aria-hidden="true" tabindex="-1"></a>                             fontsize<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb23-1140"><a href="#cb23-1140" aria-hidden="true" tabindex="-1"></a>    axes[i].set_ylabel(<span class="st">'Ann. Return (%)'</span>)</span>
<span id="cb23-1141"><a href="#cb23-1141" aria-hidden="true" tabindex="-1"></a>    axes[i].set_title(label)</span>
<span id="cb23-1142"><a href="#cb23-1142" aria-hidden="true" tabindex="-1"></a>    axes[i].axhline(y<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">'gray'</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-1143"><a href="#cb23-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1144"><a href="#cb23-1144" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">5</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb23-1145"><a href="#cb23-1145" aria-hidden="true" tabindex="-1"></a>plt.suptitle(<span class="st">'Decile Portfolio Returns by Signal'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb23-1146"><a href="#cb23-1146" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb23-1147"><a href="#cb23-1147" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb23-1148"><a href="#cb23-1148" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1149"><a href="#cb23-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1150"><a href="#cb23-1150" aria-hidden="true" tabindex="-1"></a><span class="fu">### Spanning Tests</span></span>
<span id="cb23-1151"><a href="#cb23-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1152"><a href="#cb23-1152" aria-hidden="true" tabindex="-1"></a>Does a new factor add information beyond existing factors? We test this by regressing each factor on all other factors and examining the intercept (alpha). A significant alpha means the factor captures return variation not spanned by the others:</span>
<span id="cb23-1153"><a href="#cb23-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1156"><a href="#cb23-1156" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1157"><a href="#cb23-1157" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: spanning</span></span>
<span id="cb23-1158"><a href="#cb23-1158" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1159"><a href="#cb23-1159" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Run spanning tests: regress each factor on remaining factors"</span></span>
<span id="cb23-1160"><a href="#cb23-1160" aria-hidden="true" tabindex="-1"></a>factor_names <span class="op">=</span> [c <span class="cf">for</span> c <span class="kw">in</span> factor_panel.columns <span class="cf">if</span> factor_panel[c].notna().<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">24</span>]</span>
<span id="cb23-1161"><a href="#cb23-1161" aria-hidden="true" tabindex="-1"></a>spanning_data <span class="op">=</span> factor_panel[factor_names].dropna()</span>
<span id="cb23-1162"><a href="#cb23-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1163"><a href="#cb23-1163" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Spanning Tests (alpha = intercept when regressed on other factors):"</span>)</span>
<span id="cb23-1164"><a href="#cb23-1164" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span><span class="st">'Factor'</span><span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'Alpha (ann.)'</span><span class="sc">:&gt;12}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'t-stat'</span><span class="sc">:&gt;8}</span><span class="ss"> </span><span class="sc">{</span><span class="st">'R²'</span><span class="sc">:&gt;6}</span><span class="ss">"</span>)</span>
<span id="cb23-1165"><a href="#cb23-1165" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"-"</span> <span class="op">*</span> <span class="dv">36</span>)</span>
<span id="cb23-1166"><a href="#cb23-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1167"><a href="#cb23-1167" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> target <span class="kw">in</span> factor_names:</span>
<span id="cb23-1168"><a href="#cb23-1168" aria-hidden="true" tabindex="-1"></a>    others <span class="op">=</span> [f <span class="cf">for</span> f <span class="kw">in</span> factor_names <span class="cf">if</span> f <span class="op">!=</span> target]</span>
<span id="cb23-1169"><a href="#cb23-1169" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> spanning_data[target]</span>
<span id="cb23-1170"><a href="#cb23-1170" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> sm.add_constant(spanning_data[others])</span>
<span id="cb23-1171"><a href="#cb23-1171" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> sm.OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">'HAC'</span>, cov_kwds<span class="op">=</span>{<span class="st">'maxlags'</span>: <span class="dv">6</span>})</span>
<span id="cb23-1172"><a href="#cb23-1172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1173"><a href="#cb23-1173" aria-hidden="true" tabindex="-1"></a>    alpha_ann <span class="op">=</span> model.params[<span class="st">'const'</span>] <span class="op">*</span> <span class="dv">12</span></span>
<span id="cb23-1174"><a href="#cb23-1174" aria-hidden="true" tabindex="-1"></a>    alpha_t <span class="op">=</span> model.tvalues[<span class="st">'const'</span>]</span>
<span id="cb23-1175"><a href="#cb23-1175" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> model.rsquared</span>
<span id="cb23-1176"><a href="#cb23-1176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1177"><a href="#cb23-1177" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="sc">{</span>target<span class="sc">:&lt;8}</span><span class="ss"> </span><span class="sc">{</span>alpha_ann<span class="sc">:&gt;12.4f}</span><span class="ss"> </span><span class="sc">{</span>alpha_t<span class="sc">:&gt;8.2f}</span><span class="ss"> </span><span class="sc">{</span>r2<span class="sc">:&gt;6.3f}</span><span class="ss">"</span>)</span>
<span id="cb23-1178"><a href="#cb23-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1179"><a href="#cb23-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1180"><a href="#cb23-1180" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vietnamese-Specific Considerations {#sec-factor-con-vietnam}</span></span>
<span id="cb23-1181"><a href="#cb23-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1182"><a href="#cb23-1182" aria-hidden="true" tabindex="-1"></a><span class="fu">### State-Owned Enterprise Classification</span></span>
<span id="cb23-1183"><a href="#cb23-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1184"><a href="#cb23-1184" aria-hidden="true" tabindex="-1"></a>A unique feature of Vietnamese equities is the high proportion of state-owned enterprises (SOEs). The state retains majority or significant minority stakes in many listed firms, which affects governance, information environment, and trading dynamics. Factors may behave differently within SOE and non-SOE subsamples:</span>
<span id="cb23-1185"><a href="#cb23-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1188"><a href="#cb23-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1189"><a href="#cb23-1189" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: soe-split</span></span>
<span id="cb23-1190"><a href="#cb23-1190" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1191"><a href="#cb23-1191" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compare factor premia within SOE and non-SOE subsamples"</span></span>
<span id="cb23-1192"><a href="#cb23-1192" aria-hidden="true" tabindex="-1"></a><span class="co"># Get SOE classification</span></span>
<span id="cb23-1193"><a href="#cb23-1193" aria-hidden="true" tabindex="-1"></a>firm_info <span class="op">=</span> client.get_firm_info(</span>
<span id="cb23-1194"><a href="#cb23-1194" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb23-1195"><a href="#cb23-1195" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'state_ownership_pct'</span>, <span class="st">'is_soe'</span>]</span>
<span id="cb23-1196"><a href="#cb23-1196" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-1197"><a href="#cb23-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1198"><a href="#cb23-1198" aria-hidden="true" tabindex="-1"></a>panel_soe <span class="op">=</span> panel.merge(firm_info[[<span class="st">'ticker'</span>, <span class="st">'is_soe'</span>]], on<span class="op">=</span><span class="st">'ticker'</span>, how<span class="op">=</span><span class="st">'left'</span>)</span>
<span id="cb23-1199"><a href="#cb23-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1200"><a href="#cb23-1200" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> label, subset <span class="kw">in</span> [(<span class="st">'SOE'</span>, panel_soe[panel_soe[<span class="st">'is_soe'</span>] <span class="op">==</span> <span class="va">True</span>]),</span>
<span id="cb23-1201"><a href="#cb23-1201" aria-hidden="true" tabindex="-1"></a>                        (<span class="st">'Non-SOE'</span>, panel_soe[panel_soe[<span class="st">'is_soe'</span>] <span class="op">==</span> <span class="va">False</span>])]:</span>
<span id="cb23-1202"><a href="#cb23-1202" aria-hidden="true" tabindex="-1"></a>    hml <span class="op">=</span> construct_factor(</span>
<span id="cb23-1203"><a href="#cb23-1203" aria-hidden="true" tabindex="-1"></a>        subset, signal_col<span class="op">=</span><span class="st">'bm'</span>, long_group<span class="op">=</span><span class="st">'high'</span>,</span>
<span id="cb23-1204"><a href="#cb23-1204" aria-hidden="true" tabindex="-1"></a>        weighting<span class="op">=</span><span class="st">'value'</span>, bp_universe<span class="op">=</span><span class="st">'all'</span>,</span>
<span id="cb23-1205"><a href="#cb23-1205" aria-hidden="true" tabindex="-1"></a>        rebalance_freq<span class="op">=</span><span class="st">'annual'</span></span>
<span id="cb23-1206"><a href="#cb23-1206" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1207"><a href="#cb23-1207" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> hml:</span>
<span id="cb23-1208"><a href="#cb23-1208" aria-hidden="true" tabindex="-1"></a>        d <span class="op">=</span> hml[<span class="st">'diagnostics'</span>]</span>
<span id="cb23-1209"><a href="#cb23-1209" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"HML (</span><span class="sc">{</span>label<span class="sc">}</span><span class="ss">): Ann = </span><span class="sc">{</span>d[<span class="st">'ann_return'</span>]<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb23-1210"><a href="#cb23-1210" aria-hidden="true" tabindex="-1"></a>              <span class="ss">f"t = </span><span class="sc">{</span>d[<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">, N = </span><span class="sc">{</span>d[<span class="st">'avg_stocks_per_portfolio'</span>]<span class="sc">:.0f}</span><span class="ss">"</span>)</span>
<span id="cb23-1211"><a href="#cb23-1211" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1212"><a href="#cb23-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1213"><a href="#cb23-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">### Foreign Ownership Limits</span></span>
<span id="cb23-1214"><a href="#cb23-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1215"><a href="#cb23-1215" aria-hidden="true" tabindex="-1"></a>Foreign ownership caps (49% for most sectors, 30% for banking) affect the investable universe for international investors. Factors constructed from the full universe may not be achievable by foreign investors if the long leg concentrates in stocks at the foreign ownership limit:</span>
<span id="cb23-1216"><a href="#cb23-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1219"><a href="#cb23-1219" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb23-1220"><a href="#cb23-1220" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: foreign-ownership</span></span>
<span id="cb23-1221"><a href="#cb23-1221" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb23-1222"><a href="#cb23-1222" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Check foreign ownership proximity in factor portfolios"</span></span>
<span id="cb23-1223"><a href="#cb23-1223" aria-hidden="true" tabindex="-1"></a>fol <span class="op">=</span> client.get_foreign_ownership(</span>
<span id="cb23-1224"><a href="#cb23-1224" aria-hidden="true" tabindex="-1"></a>    exchanges<span class="op">=</span>[<span class="st">'HOSE'</span>, <span class="st">'HNX'</span>],</span>
<span id="cb23-1225"><a href="#cb23-1225" aria-hidden="true" tabindex="-1"></a>    fields<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>, <span class="st">'foreign_pct'</span>, <span class="st">'foreign_limit_pct'</span>]</span>
<span id="cb23-1226"><a href="#cb23-1226" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-1227"><a href="#cb23-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1228"><a href="#cb23-1228" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge with HML portfolios</span></span>
<span id="cb23-1229"><a href="#cb23-1229" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> hml_result:</span>
<span id="cb23-1230"><a href="#cb23-1230" aria-hidden="true" tabindex="-1"></a>    hml_ports <span class="op">=</span> hml_result[<span class="st">'portfolios'</span>].merge(</span>
<span id="cb23-1231"><a href="#cb23-1231" aria-hidden="true" tabindex="-1"></a>        fol, on<span class="op">=</span>[<span class="st">'ticker'</span>, <span class="st">'month_end'</span>], how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb23-1232"><a href="#cb23-1232" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1233"><a href="#cb23-1233" aria-hidden="true" tabindex="-1"></a>    hml_ports[<span class="st">'near_limit'</span>] <span class="op">=</span> (</span>
<span id="cb23-1234"><a href="#cb23-1234" aria-hidden="true" tabindex="-1"></a>        (hml_ports[<span class="st">'foreign_limit_pct'</span>] <span class="op">-</span> hml_ports[<span class="st">'foreign_pct'</span>]) <span class="op">&lt;</span> <span class="dv">5</span></span>
<span id="cb23-1235"><a href="#cb23-1235" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1236"><a href="#cb23-1236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-1237"><a href="#cb23-1237" aria-hidden="true" tabindex="-1"></a>    fol_by_group <span class="op">=</span> (</span>
<span id="cb23-1238"><a href="#cb23-1238" aria-hidden="true" tabindex="-1"></a>        hml_ports.groupby(<span class="st">'signal_group'</span>)</span>
<span id="cb23-1239"><a href="#cb23-1239" aria-hidden="true" tabindex="-1"></a>        .agg(</span>
<span id="cb23-1240"><a href="#cb23-1240" aria-hidden="true" tabindex="-1"></a>            avg_foreign_pct<span class="op">=</span>(<span class="st">'foreign_pct'</span>, <span class="st">'mean'</span>),</span>
<span id="cb23-1241"><a href="#cb23-1241" aria-hidden="true" tabindex="-1"></a>            pct_near_limit<span class="op">=</span>(<span class="st">'near_limit'</span>, <span class="st">'mean'</span>)</span>
<span id="cb23-1242"><a href="#cb23-1242" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb23-1243"><a href="#cb23-1243" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb23-1244"><a href="#cb23-1244" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Foreign Ownership in HML Portfolios:"</span>)</span>
<span id="cb23-1245"><a href="#cb23-1245" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(fol_by_group.<span class="bu">round</span>(<span class="dv">3</span>))</span>
<span id="cb23-1246"><a href="#cb23-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb23-1247"><a href="#cb23-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1248"><a href="#cb23-1248" aria-hidden="true" tabindex="-1"></a><span class="fu">## Recommended Factor Specifications for Vietnam {#sec-factor-con-recommendations}</span></span>
<span id="cb23-1249"><a href="#cb23-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1250"><a href="#cb23-1250" aria-hidden="true" tabindex="-1"></a>Based on the sensitivity analysis, we recommend the following baseline specifications (@tbl-factor-con-recommendations).</span>
<span id="cb23-1251"><a href="#cb23-1251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1252"><a href="#cb23-1252" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Choice <span class="pp">|</span> Recommendation <span class="pp">|</span> Rationale <span class="pp">|</span></span>
<span id="cb23-1253"><a href="#cb23-1253" aria-hidden="true" tabindex="-1"></a><span class="pp">|------------------------|------------------------|------------------------|</span></span>
<span id="cb23-1254"><a href="#cb23-1254" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Universe <span class="pp">|</span> Standard filter (listing age ≥ 6m, volume <span class="sc">\&gt;</span> 0) <span class="pp">|</span> Excludes shell firms without losing too much breadth <span class="pp">|</span></span>
<span id="cb23-1255"><a href="#cb23-1255" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Breakpoints <span class="pp">|</span> HOSE stocks only <span class="pp">|</span> Prevents HNX micro-caps from dominating breakpoints <span class="pp">|</span></span>
<span id="cb23-1256"><a href="#cb23-1256" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Size groups <span class="pp">|</span> 2 (median split) <span class="pp">|</span> Sufficient control with limited cross-section <span class="pp">|</span></span>
<span id="cb23-1257"><a href="#cb23-1257" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Signal groups <span class="pp">|</span> 3 (terciles) for factor construction; 5 or 10 for portfolio analysis <span class="pp">|</span> 2×3 = adequate diversification per portfolio <span class="pp">|</span></span>
<span id="cb23-1258"><a href="#cb23-1258" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Weighting <span class="pp">|</span> Value-weighted <span class="pp">|</span> Investable; less noisy than EW <span class="pp">|</span></span>
<span id="cb23-1259"><a href="#cb23-1259" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Rebalancing <span class="pp">|</span> Annual (June) for accounting signals; monthly for momentum <span class="pp">|</span> Standard; consistent with Fama-French <span class="pp">|</span></span>
<span id="cb23-1260"><a href="#cb23-1260" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Accounting lag <span class="pp">|</span> 4 months (available by April for Dec FY) <span class="pp">|</span> Conservative PIT alignment <span class="pp">|</span></span>
<span id="cb23-1261"><a href="#cb23-1261" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Minimum stocks <span class="pp">|</span> ≥ 5 per portfolio per month <span class="pp">|</span> Below this, single-stock idiosyncratic risk dominates <span class="pp">|</span></span>
<span id="cb23-1262"><a href="#cb23-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1263"><a href="#cb23-1263" aria-hidden="true" tabindex="-1"></a>: Recommended factor construction parameters for Vietnamese equities. {#tbl-factor-con-recommendations}</span>
<span id="cb23-1264"><a href="#cb23-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1265"><a href="#cb23-1265" aria-hidden="true" tabindex="-1"></a>Always report results under the baseline and at least one alternative specification (e.g., EW, all-stock breakpoints) to demonstrate robustness.</span>
<span id="cb23-1266"><a href="#cb23-1266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1267"><a href="#cb23-1267" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary {#sec-factor-con-summary}</span></span>
<span id="cb23-1268"><a href="#cb23-1268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1269"><a href="#cb23-1269" aria-hidden="true" tabindex="-1"></a>This chapter has developed a modular, transparent factor construction framework for Vietnamese equities. The key insights are:</span>
<span id="cb23-1270"><a href="#cb23-1270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1271"><a href="#cb23-1271" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The @fama1993common 2×3 methodology translates well to Vietnam with one critical adaptation: breakpoints should be computed from HOSE stocks only. Using all-stock breakpoints allows HNX micro-caps to dominate the small-stock groups, inflating apparent premia with economically untradeable returns.</span>
<span id="cb23-1272"><a href="#cb23-1272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1273"><a href="#cb23-1273" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Value weighting produces more conservative (and more implementable) factor premia than equal weighting. The difference is particularly large for signals correlated with size (BM, investment), where EW overweights the smallest stocks that contribute most to the premium but least to investable returns.</span>
<span id="cb23-1274"><a href="#cb23-1274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1275"><a href="#cb23-1275" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>No single construction choice determines whether a factor "exists." A factor premium that appears only under one specific combination of breakpoints, weighting, and rebalancing frequency is fragile and should be treated with skepticism. Robust factors survive a grid of specifications. The sensitivity analysis framework developed here (e.g., varying weighting, breakpoints, sort granularity, and rebalancing simultaneously) should be standard practice.</span>
<span id="cb23-1276"><a href="#cb23-1276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1277"><a href="#cb23-1277" aria-hidden="true" tabindex="-1"></a>The <span class="in">`construct_factor()`</span> function developed in this chapter is designed for reuse throughout the book. Any anomaly variable can be fed through the same pipeline, producing a tradeable factor with full diagnostics. This ensures methodological consistency across chapters and makes it easy to compare premia on an apples-to-apples basis.</span>
<span id="cb23-1278"><a href="#cb23-1278" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1279"><a href="#cb23-1279" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ## Exercises {#sec-factor-con-exercises}</span></span>
<span id="cb23-1280"><a href="#cb23-1280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1281"><a href="#cb23-1281" aria-hidden="true" tabindex="-1"></a><span class="co">1.  **Conditional sorts.** Implement conditional (sequential) double sorts as an alternative to the independent sorts used by @fama1993common. First sort on size, then within each size group sort on BM. Compare the resulting HML to the independent-sort HML. When do conditional sorts produce meaningfully different results?</span></span>
<span id="cb23-1282"><a href="#cb23-1282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1283"><a href="#cb23-1283" aria-hidden="true" tabindex="-1"></a><span class="co">2.  **Winsorization sensitivity.** Construct HML with and without winsorizing the book-to-market ratio at the 1st and 99th percentiles each month. How sensitive is the factor premium to extreme BM values? Investigate whether the extreme BM firms are concentrated in specific industries.</span></span>
<span id="cb23-1284"><a href="#cb23-1284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1285"><a href="#cb23-1285" aria-hidden="true" tabindex="-1"></a><span class="co">3.  **Lagged accounting data.** Reconstruct all five factors using a 6-month accounting lag instead of 4 months. How much does the additional lag reduce the premium? This tests how much of the apparent premium comes from stale data that was not yet publicly available.</span></span>
<span id="cb23-1286"><a href="#cb23-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1287"><a href="#cb23-1287" aria-hidden="true" tabindex="-1"></a><span class="co">4.  **Industry-neutral factors.** Construct an industry-neutral HML by sorting on BM within each ICB sector (rather than across the entire market). Does the within-industry value premium differ from the cross-industry premium? Which component is larger in Vietnam?</span></span>
<span id="cb23-1288"><a href="#cb23-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1289"><a href="#cb23-1289" aria-hidden="true" tabindex="-1"></a><span class="co">5.  **Liquidity-controlled factors.** Add a third independent sort on Amihud illiquidity (2×3×3 = 18 portfolios). Does the HML premium survive after controlling for liquidity? This tests whether the apparent value premium is actually a liquidity premium in disguise.</span></span>
<span id="cb23-1290"><a href="#cb23-1290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1291"><a href="#cb23-1291" aria-hidden="true" tabindex="-1"></a><span class="co">6.  **Small-sample bootstrap.** The Vietnamese cross-section is small enough that portfolio sorts may produce noisy estimates. Implement a bootstrap procedure: resample the cross-section with replacement 1,000 times at each formation date, reconstruct the factor each time, and report the 90% confidence interval for the annualized premium. How wide is the interval?</span></span>
<span id="cb23-1292"><a href="#cb23-1292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1293"><a href="#cb23-1293" aria-hidden="true" tabindex="-1"></a><span class="co">7.  **Factor timing.** Test whether factor premia are predictable using lagged aggregate variables (market volatility, credit spread, aggregate turnover, SBV policy rate). Estimate a predictive regression of next-month factor returns on these variables. Can you build a factor timing strategy that improves on the unconditional buy-and-hold factor?</span></span>
<span id="cb23-1294"><a href="#cb23-1294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-1295"><a href="#cb23-1295" aria-hidden="true" tabindex="-1"></a><span class="co">8.  **Replication of @hou2020replicating for Vietnam.** Select 10 well-known anomalies from the international literature (e.g., gross profitability, asset growth, accruals, share issuance, ROE, beta, idiosyncratic volatility, earnings momentum, investment-to-assets, net share issues). Construct each as a long-short factor using the engine from this chapter. How many survive with t \&gt; 2.0? How does this replication rate compare to the \~50% rate reported by @hou2020replicating for U.S. data? --&gt;</span></span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/23_factor_construction_principles.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>