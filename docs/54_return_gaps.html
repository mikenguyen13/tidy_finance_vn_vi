<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>36&nbsp; Return Gap: Measuring Unobserved Actions of Fund Managers â€“ Applying Tidy Finance with Python to Vietnam</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./55_price_limits_and_volatility.html" rel="next">
<link href="./53_governance.html" rel="prev">
<link href="./favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark-b758ccaa5987ceb1b75504551e579abf.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" class="quarto-color-scheme-extra" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark-72097b8a1e3a3da1d7b8bbfaaf81c3d8.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<link href="site_libs/bootstrap/bootstrap-ed993afc62d41eaa40b4794cd0abf8eb.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme-extra" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="36&nbsp; Return Gap: Measuring Unobserved Actions of Fund Managers â€“ Applying Tidy Finance with Python to Vietnam">
<meta property="og:description" content="">
<meta property="og:image" content="https://github.com/mikenguyen13/tidy_finance_vn/54_return_gaps_files/figure-html/fig-return-gap-distribution-output-1.png">
<meta property="og:site_name" content="Applying Tidy Finance with Python to Vietnam">
<meta property="og:image:height" content="1455">
<meta property="og:image:width" content="3551">
<meta name="twitter:title" content="36&nbsp; Return Gap: Measuring Unobserved Actions of Fund Managers â€“ Applying Tidy Finance with Python to Vietnam">
<meta name="twitter:description" content="">
<meta name="twitter:image" content="https://github.com/mikenguyen13/tidy_finance_vn/54_return_gaps_files/figure-html/fig-return-gap-distribution-output-1.png">
<meta name="twitter:image-height" content="1455">
<meta name="twitter:image-width" content="3551">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light"><script id="quarto-html-before-body" type="application/javascript">
    const toggleBodyColorMode = (bsSheetEl) => {
      const mode = bsSheetEl.getAttribute("data-mode");
      const bodyEl = window.document.querySelector("body");
      if (mode === "dark") {
        bodyEl.classList.add("quarto-dark");
        bodyEl.classList.remove("quarto-light");
      } else {
        bodyEl.classList.add("quarto-light");
        bodyEl.classList.remove("quarto-dark");
      }
    }
    const toggleBodyColorPrimary = () => {
      const bsSheetEl = window.document.querySelector("link#quarto-bootstrap:not([rel=disabled-stylesheet])");
      if (bsSheetEl) {
        toggleBodyColorMode(bsSheetEl);
      }
    }
    const setColorSchemeToggle = (alternate) => {
      const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
      for (let i=0; i < toggles.length; i++) {
        const toggle = toggles[i];
        if (toggle) {
          if (alternate) {
            toggle.classList.add("alternate");
          } else {
            toggle.classList.remove("alternate");
          }
        }
      }
    };
    const toggleColorMode = (alternate) => {
      // Switch the stylesheets
      const primaryStylesheets = window.document.querySelectorAll('link.quarto-color-scheme:not(.quarto-color-alternate)');
      const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
      manageTransitions('#quarto-margin-sidebar .nav-link', false);
      if (alternate) {
        // note: dark is layered on light, we don't disable primary!
        enableStylesheet(alternateStylesheets);
        for (const sheetNode of alternateStylesheets) {
          if (sheetNode.id === "quarto-bootstrap") {
            toggleBodyColorMode(sheetNode);
          }
        }
      } else {
        disableStylesheet(alternateStylesheets);
        enableStylesheet(primaryStylesheets)
        toggleBodyColorPrimary();
      }
      manageTransitions('#quarto-margin-sidebar .nav-link', true);
      // Switch the toggles
      setColorSchemeToggle(alternate)
      // Hack to workaround the fact that safari doesn't
      // properly recolor the scrollbar when toggling (#1455)
      if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
        manageTransitions("body", false);
        window.scrollTo(0, 1);
        setTimeout(() => {
          window.scrollTo(0, 0);
          manageTransitions("body", true);
        }, 40);
      }
    }
    const disableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        stylesheet.rel = 'disabled-stylesheet';
      }
    }
    const enableStylesheet = (stylesheets) => {
      for (let i=0; i < stylesheets.length; i++) {
        const stylesheet = stylesheets[i];
        if(stylesheet.rel !== 'stylesheet') { // for Chrome, which will still FOUC without this check
          stylesheet.rel = 'stylesheet';
        }
      }
    }
    const manageTransitions = (selector, allowTransitions) => {
      const els = window.document.querySelectorAll(selector);
      for (let i=0; i < els.length; i++) {
        const el = els[i];
        if (allowTransitions) {
          el.classList.remove('notransition');
        } else {
          el.classList.add('notransition');
        }
      }
    }
    const isFileUrl = () => {
      return window.location.protocol === 'file:';
    }
    const hasAlternateSentinel = () => {
      let styleSentinel = getColorSchemeSentinel();
      if (styleSentinel !== null) {
        return styleSentinel === "alternate";
      } else {
        return false;
      }
    }
    const setStyleSentinel = (alternate) => {
      const value = alternate ? "alternate" : "default";
      if (!isFileUrl()) {
        window.localStorage.setItem("quarto-color-scheme", value);
      } else {
        localAlternateSentinel = value;
      }
    }
    const getColorSchemeSentinel = () => {
      if (!isFileUrl()) {
        const storageValue = window.localStorage.getItem("quarto-color-scheme");
        return storageValue != null ? storageValue : localAlternateSentinel;
      } else {
        return localAlternateSentinel;
      }
    }
    const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
      const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
      const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
      let newTheme = '';
      if(authorPrefersDark) {
        newTheme = isAlternate ? baseTheme : alternateTheme;
      } else {
        newTheme = isAlternate ? alternateTheme : baseTheme;
      }
      const changeGiscusTheme = () => {
        // From: https://github.com/giscus/giscus/issues/336
        const sendMessage = (message) => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (!iframe) return;
          iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
        }
        sendMessage({
          setConfig: {
            theme: newTheme
          }
        });
      }
      const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
      if (isGiscussLoaded) {
        changeGiscusTheme();
      }
    };
    const authorPrefersDark = false;
    const darkModeDefault = authorPrefersDark;
      document.querySelector('link#quarto-text-highlighting-styles.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
      document.querySelector('link#quarto-bootstrap.quarto-color-scheme-extra').rel = 'disabled-stylesheet';
    let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
    // Dark / light mode switch
    window.quartoToggleColorScheme = () => {
      // Read the current dark / light value
      let toAlternate = !hasAlternateSentinel();
      toggleColorMode(toAlternate);
      setStyleSentinel(toAlternate);
      toggleGiscusIfUsed(toAlternate, darkModeDefault);
      window.dispatchEvent(new Event('resize'));
    };
    // Switch to dark mode if need be
    if (hasAlternateSentinel()) {
      toggleColorMode(true);
    } else {
      toggleColorMode(false);
    }
  </script>

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Applying Tidy Finance with Python to Vietnam</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="./index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://mikenguyen13.github.io/tidy_finance_vn/"> 
<span class="menu-text">ðŸ“˜ English Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://YOUR-ORG.github.io/tidy-finance-vietnam-python-vi/"> 
<span class="menu-text">ðŸ“— SÃ¡ch Tiáº¿ng Viá»‡t</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <a href="https://github.com/mikenguyen13/tidy_finance_vn" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./54_return_gaps.html"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Vietnam Financial Markets, Institutions, and Data</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00_institutional_background.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Institutional Background and Market Structure of Vietnamâ€™s Equity Market</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_accessing_and_managing_financial_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing and Managing VN Financial Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_datacore_data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Datacore Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_market_microstructure.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Market Microstructure in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_risk_free_rate_construction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Risk-Free Rate Construction in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_working_with_stock_returns.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Constructing and Analyzing Equity Return Series</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_compound_return.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Compound Returns</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Portfolio Construction, Risk, and Empirical Mechanics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_modern_portfolio_theory.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Modern Portfolio Theory</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11_univariate_portfolio_sort.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Univariate Portfolio Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12_size_sorts.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Size Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13_value_bivariate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Value and Bivariate Sorts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14_portfolio_weighting_and_rebalancing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Portfolio Weighting and Rebalancing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15_missing_data_and_survivorship.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Missing Data and Survivorship Bias</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16_liquidity_and_turnover_measures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Liquidity and Turnover Measures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17_beta_estimation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Beta Estimation</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Asset Pricing Models and Cross-Sectional Tests</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./20_capm.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">The Capital Asset Pricing Model</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./21_fama_french.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Fama-French Factors</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./22_momentum.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">18</span>&nbsp; <span class="chapter-title">Momentum Strategies</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./23_factor_construction_principles.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">19</span>&nbsp; <span class="chapter-title">Factor Construction Principles</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./24_fama_macbeth.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">20</span>&nbsp; <span class="chapter-title">Fama-MacBeth Regressions</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./25_factor_zoo_and_multiple_testing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">21</span>&nbsp; <span class="chapter-title">Factor Zoo and Multiple Testing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./26_time_series_vs_cross_section.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">22</span>&nbsp; <span class="chapter-title">Time-Series vs.&nbsp;Cross-Sectional Factor Tests</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Firm Fundamentals, Valuation, and Corporate Signals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30_financial_statement_analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">23</span>&nbsp; <span class="chapter-title">Financial Statement Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./31_discounted_cash_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">24</span>&nbsp; <span class="chapter-title">Discounted Cash Flow Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./32_info_earnings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">25</span>&nbsp; <span class="chapter-title">Information Content of Earnings Announcements</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./33_accruals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">26</span>&nbsp; <span class="chapter-title">Accruals, Earnings Persistence, and Market Efficiency</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./34_earning_management.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">27</span>&nbsp; <span class="chapter-title">Earnings Management: Detection and Measurement</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./35_pe_ratio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">28</span>&nbsp; <span class="chapter-title">P/E Ratio</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./36_valuation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">29</span>&nbsp; <span class="chapter-title">Firm Valuation, Financial Distress, and Company Maturity</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./37_disclosure_quality_and_timing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">30</span>&nbsp; <span class="chapter-title">Disclosure Quality and Timing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./38_sue.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">31</span>&nbsp; <span class="chapter-title">Standardized Earnings Surprises (SUE)</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./39_divop.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">32</span>&nbsp; <span class="chapter-title">Measuring Divergence of Investor Opinion</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Ownership, Market Frictions, and International Exposure</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./50_institutional_ownership.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">33</span>&nbsp; <span class="chapter-title">Institutional Ownership Analytics in Vietnam</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./52_institutional_trade_flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">34</span>&nbsp; <span class="chapter-title">Institutional Trades, Flows, and Turnover Ratios</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./53_governance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./54_return_gaps.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./55_price_limits_and_volatility.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./56_market_integration_and_segmentation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">38</span>&nbsp; <span class="chapter-title">Market Integration and Segmentation</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./57_exchange_rate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">39</span>&nbsp; <span class="chapter-title">Exchange Rate Dynamics</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Financial Modeling</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./60_event_studies.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">40</span>&nbsp; <span class="chapter-title">Event Studies in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./61_tail_risk_extreme_events.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">41</span>&nbsp; <span class="chapter-title">Tail Risk and Extreme Events</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./62_corporate_finance_estimators.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">42</span>&nbsp; <span class="chapter-title">Corporate Finance Estimators and Identification</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./63_structural_models_finance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">43</span>&nbsp; <span class="chapter-title">Structural Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true">
 <span class="menu-text">Alternative Data and AI for Finance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./70_textual.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">44</span>&nbsp; <span class="chapter-title">Textual Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./71_image.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">45</span>&nbsp; <span class="chapter-title">Image and Visual Data in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./73_networks_graphs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">46</span>&nbsp; <span class="chapter-title">Networks and Graphs in Finance</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./74_multimodel.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">47</span>&nbsp; <span class="chapter-title">Multimodal Models in Finance</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_conclusion.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">48</span>&nbsp; <span class="chapter-title">Conclusion</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="-1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#why-return-gap-matters" id="toc-why-return-gap-matters" class="nav-link active" data-scroll-target="#why-return-gap-matters"><span class="header-section-number">36.1</span> Why Return Gap Matters</a></li>
  <li><a href="#application-to-the-vietnamese-market" id="toc-application-to-the-vietnamese-market" class="nav-link" data-scroll-target="#application-to-the-vietnamese-market"><span class="header-section-number">36.2</span> Application to the Vietnamese Market</a></li>
  <li><a href="#sec-return-gaptheory" id="toc-sec-return-gaptheory" class="nav-link" data-scroll-target="#sec-return-gaptheory"><span class="header-section-number">37</span> Theoretical Framework</a>
  <ul class="collapse">
  <li><a href="#decomposing-fund-returns" id="toc-decomposing-fund-returns" class="nav-link" data-scroll-target="#decomposing-fund-returns"><span class="header-section-number">37.1</span> Decomposing Fund Returns</a></li>
  <li><a href="#the-return-gap-measure" id="toc-the-return-gap-measure" class="nav-link" data-scroll-target="#the-return-gap-measure"><span class="header-section-number">37.2</span> The Return Gap Measure</a>
  <ul class="collapse">
  <li><a href="#gross-return-gap" id="toc-gross-return-gap" class="nav-link" data-scroll-target="#gross-return-gap"><span class="header-section-number">37.2.1</span> Gross Return Gap</a></li>
  <li><a href="#sources-of-return-gap" id="toc-sources-of-return-gap" class="nav-link" data-scroll-target="#sources-of-return-gap"><span class="header-section-number">37.2.2</span> Sources of Return Gap</a></li>
  <li><a href="#predictive-return-gap" id="toc-predictive-return-gap" class="nav-link" data-scroll-target="#predictive-return-gap"><span class="header-section-number">37.2.3</span> Predictive Return Gap</a></li>
  </ul></li>
  <li><a href="#risk-adjusted-performance-evaluation" id="toc-risk-adjusted-performance-evaluation" class="nav-link" data-scroll-target="#risk-adjusted-performance-evaluation"><span class="header-section-number">37.3</span> Risk-Adjusted Performance Evaluation</a>
  <ul class="collapse">
  <li><a href="#capm-alpha" id="toc-capm-alpha" class="nav-link" data-scroll-target="#capm-alpha"><span class="header-section-number">37.3.1</span> CAPM Alpha</a></li>
  <li><a href="#fama-french-three-factor-model" id="toc-fama-french-three-factor-model" class="nav-link" data-scroll-target="#fama-french-three-factor-model"><span class="header-section-number">37.3.2</span> Fama-French Three-Factor Model</a></li>
  <li><a href="#carhart-four-factor-model" id="toc-carhart-four-factor-model" class="nav-link" data-scroll-target="#carhart-four-factor-model"><span class="header-section-number">37.3.3</span> Carhart Four-Factor Model</a></li>
  <li><a href="#fama-french-five-factor-model" id="toc-fama-french-five-factor-model" class="nav-link" data-scroll-target="#fama-french-five-factor-model"><span class="header-section-number">37.3.4</span> Fama-French Five-Factor Model</a></li>
  </ul></li>
  <li><a href="#newey-west-standard-errors" id="toc-newey-west-standard-errors" class="nav-link" data-scroll-target="#newey-west-standard-errors"><span class="header-section-number">37.4</span> Newey-West Standard Errors</a></li>
  </ul></li>
  <li><a href="#sec-return-gapdata" id="toc-sec-return-gapdata" class="nav-link" data-scroll-target="#sec-return-gapdata"><span class="header-section-number">38</span> Data and Sample Construction</a>
  <ul class="collapse">
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources"><span class="header-section-number">38.1</span> Data Sources</a></li>
  <li><a href="#setting-up-the-environment" id="toc-setting-up-the-environment" class="nav-link" data-scroll-target="#setting-up-the-environment"><span class="header-section-number">38.2</span> Setting Up the Environment</a></li>
  <li><a href="#sec-return-gapstock-data" id="toc-sec-return-gapstock-data" class="nav-link" data-scroll-target="#sec-return-gapstock-data"><span class="header-section-number">38.3</span> Loading and Preparing Stock Market Data</a></li>
  <li><a href="#sec-return-gapholdings-data" id="toc-sec-return-gapholdings-data" class="nav-link" data-scroll-target="#sec-return-gapholdings-data"><span class="header-section-number">38.4</span> Loading Fund Holdings Data</a></li>
  <li><a href="#sec-return-gapfund-returns" id="toc-sec-return-gapfund-returns" class="nav-link" data-scroll-target="#sec-return-gapfund-returns"><span class="header-section-number">38.5</span> Loading Fund Returns and Characteristics</a></li>
  <li><a href="#sec-return-gapsample-selection" id="toc-sec-return-gapsample-selection" class="nav-link" data-scroll-target="#sec-return-gapsample-selection"><span class="header-section-number">38.6</span> Sample Selection: Domestic Equity Funds</a></li>
  </ul></li>
  <li><a href="#sec-return-gapcomputing" id="toc-sec-return-gapcomputing" class="nav-link" data-scroll-target="#sec-return-gapcomputing"><span class="header-section-number">39</span> Computing the Return Gap</a>
  <ul class="collapse">
  <li><a href="#sec-return-gapvintages" id="toc-sec-return-gapvintages" class="nav-link" data-scroll-target="#sec-return-gapvintages"><span class="header-section-number">39.1</span> Step 1: Prepare Holdings Vintages</a></li>
  <li><a href="#sec-return-gapadjust-shares" id="toc-sec-return-gapadjust-shares" class="nav-link" data-scroll-target="#sec-return-gapadjust-shares"><span class="header-section-number">39.2</span> Step 2: Adjust Shares for Corporate Actions</a></li>
  <li><a href="#sec-return-gaphypothetical-returns" id="toc-sec-return-gaphypothetical-returns" class="nav-link" data-scroll-target="#sec-return-gaphypothetical-returns"><span class="header-section-number">39.3</span> Step 3: Compute Hypothetical Holdings Returns</a></li>
  <li><a href="#sec-return-gapgross-returns" id="toc-sec-return-gapgross-returns" class="nav-link" data-scroll-target="#sec-return-gapgross-returns"><span class="header-section-number">39.4</span> Step 4: Compute Gross Fund Returns</a></li>
  <li><a href="#sec-return-gapmerge-return-gap" id="toc-sec-return-gapmerge-return-gap" class="nav-link" data-scroll-target="#sec-return-gapmerge-return-gap"><span class="header-section-number">39.5</span> Step 5: Merge and Compute Return Gap</a></li>
  <li><a href="#distribution-of-the-return-gap" id="toc-distribution-of-the-return-gap" class="nav-link" data-scroll-target="#distribution-of-the-return-gap"><span class="header-section-number">39.6</span> Distribution of the Return Gap</a></li>
  <li><a href="#time-series-of-cross-sectional-return-gap" id="toc-time-series-of-cross-sectional-return-gap" class="nav-link" data-scroll-target="#time-series-of-cross-sectional-return-gap"><span class="header-section-number">39.7</span> Time Series of Cross-Sectional Return Gap</a></li>
  </ul></li>
  <li><a href="#sec-return-gapportfolios" id="toc-sec-return-gapportfolios" class="nav-link" data-scroll-target="#sec-return-gapportfolios"><span class="header-section-number">40</span> Portfolio Sorting Analysis</a>
  <ul class="collapse">
  <li><a href="#sec-return-gapdecile-portfolios" id="toc-sec-return-gapdecile-portfolios" class="nav-link" data-scroll-target="#sec-return-gapdecile-portfolios"><span class="header-section-number">40.1</span> Forming Return Gap Decile Portfolios</a></li>
  <li><a href="#portfolio-returns" id="toc-portfolio-returns" class="nav-link" data-scroll-target="#portfolio-returns"><span class="header-section-number">40.2</span> Portfolio Returns</a></li>
  <li><a href="#characteristics-of-return-gap-portfolios" id="toc-characteristics-of-return-gap-portfolios" class="nav-link" data-scroll-target="#characteristics-of-return-gap-portfolios"><span class="header-section-number">40.3</span> Characteristics of Return Gap Portfolios</a></li>
  <li><a href="#cumulative-returns-of-extreme-portfolios" id="toc-cumulative-returns-of-extreme-portfolios" class="nav-link" data-scroll-target="#cumulative-returns-of-extreme-portfolios"><span class="header-section-number">40.4</span> Cumulative Returns of Extreme Portfolios</a></li>
  </ul></li>
  <li><a href="#sec-return-gaprisk-adjusted" id="toc-sec-return-gaprisk-adjusted" class="nav-link" data-scroll-target="#sec-return-gaprisk-adjusted"><span class="header-section-number">41</span> Risk-Adjusted Performance</a>
  <ul class="collapse">
  <li><a href="#risk-factors" id="toc-risk-factors" class="nav-link" data-scroll-target="#risk-factors"><span class="header-section-number">41.1</span> Risk Factors</a></li>
  <li><a href="#alpha-estimation" id="toc-alpha-estimation" class="nav-link" data-scroll-target="#alpha-estimation"><span class="header-section-number">41.2</span> Alpha Estimation</a></li>
  <li><a href="#alpha-table" id="toc-alpha-table" class="nav-link" data-scroll-target="#alpha-table"><span class="header-section-number">41.3</span> Alpha Table</a></li>
  <li><a href="#alpha-plot" id="toc-alpha-plot" class="nav-link" data-scroll-target="#alpha-plot"><span class="header-section-number">41.4</span> Alpha Plot</a></li>
  <li><a href="#long-short-portfolio-analysis" id="toc-long-short-portfolio-analysis" class="nav-link" data-scroll-target="#long-short-portfolio-analysis"><span class="header-section-number">41.5</span> Long-Short Portfolio Analysis</a></li>
  </ul></li>
  <li><a href="#sec-return-gapdeterminants" id="toc-sec-return-gapdeterminants" class="nav-link" data-scroll-target="#sec-return-gapdeterminants"><span class="header-section-number">42</span> Cross-Sectional Determinants</a>
  <ul class="collapse">
  <li><a href="#fama-macbeth-regressions" id="toc-fama-macbeth-regressions" class="nav-link" data-scroll-target="#fama-macbeth-regressions"><span class="header-section-number">42.1</span> Fama-MacBeth Regressions</a></li>
  </ul></li>
  <li><a href="#sec-return-gappersistence" id="toc-sec-return-gappersistence" class="nav-link" data-scroll-target="#sec-return-gappersistence"><span class="header-section-number">43</span> Persistence</a></li>
  <li><a href="#sec-return-gaprobustness" id="toc-sec-return-gaprobustness" class="nav-link" data-scroll-target="#sec-return-gaprobustness"><span class="header-section-number">44</span> Robustness Checks</a>
  <ul class="collapse">
  <li><a href="#alternative-holding-periods" id="toc-alternative-holding-periods" class="nav-link" data-scroll-target="#alternative-holding-periods"><span class="header-section-number">44.1</span> Alternative Holding Periods</a></li>
  <li><a href="#subperiod-analysis" id="toc-subperiod-analysis" class="nav-link" data-scroll-target="#subperiod-analysis"><span class="header-section-number">44.2</span> Subperiod Analysis</a></li>
  <li><a href="#ew-vs-vw" id="toc-ew-vs-vw" class="nav-link" data-scroll-target="#ew-vs-vw"><span class="header-section-number">44.3</span> EW vs VW</a></li>
  </ul></li>
  <li><a href="#sec-return-gapextensions" id="toc-sec-return-gapextensions" class="nav-link" data-scroll-target="#sec-return-gapextensions"><span class="header-section-number">45</span> Extensions Beyond the Standard Framework</a>
  <ul class="collapse">
  <li><a href="#extension-1-decomposing-return-gap-by-source" id="toc-extension-1-decomposing-return-gap-by-source" class="nav-link" data-scroll-target="#extension-1-decomposing-return-gap-by-source"><span class="header-section-number">45.1</span> Extension 1: Decomposing Return Gap by Source</a></li>
  <li><a href="#extension-2-conditional-return-gap" id="toc-extension-2-conditional-return-gap" class="nav-link" data-scroll-target="#extension-2-conditional-return-gap"><span class="header-section-number">45.2</span> Extension 2: Conditional Return Gap</a></li>
  <li><a href="#extension-3-return-gap-and-fund-flows" id="toc-extension-3-return-gap-and-fund-flows" class="nav-link" data-scroll-target="#extension-3-return-gap-and-fund-flows"><span class="header-section-number">45.3</span> Extension 3: Return Gap and Fund Flows</a></li>
  <li><a href="#extension-4-return-gap-and-stock-selection-skill" id="toc-extension-4-return-gap-and-stock-selection-skill" class="nav-link" data-scroll-target="#extension-4-return-gap-and-stock-selection-skill"><span class="header-section-number">45.4</span> Extension 4: Return Gap and Stock Selection Skill</a></li>
  <li><a href="#extension-5-double-sorts" id="toc-extension-5-double-sorts" class="nav-link" data-scroll-target="#extension-5-double-sorts"><span class="header-section-number">45.5</span> Extension 5: Double Sorts</a></li>
  </ul></li>
  <li><a href="#sec-return-gapvietnam" id="toc-sec-return-gapvietnam" class="nav-link" data-scroll-target="#sec-return-gapvietnam"><span class="header-section-number">46</span> Vietnamese Market Considerations</a>
  <ul class="collapse">
  <li><a href="#institutional-features-affecting-return-gap" id="toc-institutional-features-affecting-return-gap" class="nav-link" data-scroll-target="#institutional-features-affecting-return-gap"><span class="header-section-number">46.1</span> Institutional Features Affecting Return Gap</a>
  <ul class="collapse">
  <li><a href="#foreign-ownership-limits-fol" id="toc-foreign-ownership-limits-fol" class="nav-link" data-scroll-target="#foreign-ownership-limits-fol"><span class="header-section-number">46.1.1</span> Foreign Ownership Limits (FOL)</a></li>
  <li><a href="#daily-price-limits" id="toc-daily-price-limits" class="nav-link" data-scroll-target="#daily-price-limits"><span class="header-section-number">46.1.2</span> Daily Price Limits</a></li>
  <li><a href="#t2-settlement-and-margin-trading" id="toc-t2-settlement-and-margin-trading" class="nav-link" data-scroll-target="#t2-settlement-and-margin-trading"><span class="header-section-number">46.1.3</span> T+2 Settlement and Margin Trading</a></li>
  <li><a href="#disclosure-norms" id="toc-disclosure-norms" class="nav-link" data-scroll-target="#disclosure-norms"><span class="header-section-number">46.1.4</span> Disclosure Norms</a></li>
  </ul></li>
  <li><a href="#comparison-with-developed-market-evidence" id="toc-comparison-with-developed-market-evidence" class="nav-link" data-scroll-target="#comparison-with-developed-market-evidence"><span class="header-section-number">46.2</span> Comparison with Developed Market Evidence</a></li>
  </ul></li>
  <li><a href="#sec-return-gapconclusion" id="toc-sec-return-gapconclusion" class="nav-link" data-scroll-target="#sec-return-gapconclusion"><span class="header-section-number">47</span> Conclusion</a></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/54_return_gaps.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">


<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./50_institutional_ownership.html">Ownership, Market Frictions, and International Exposure</a></li><li class="breadcrumb-item"><a href="./54_return_gaps.html"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></a></li></ol></nav>
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">36</span>&nbsp; <span class="chapter-title">Return Gap: Measuring Unobserved Actions of Fund Managers</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Mutual fund managers possess considerable discretion in their investment decisions between mandatory portfolio disclosure dates. While regulatory frameworks require periodic disclosure of holdings, the actions taken between these disclosure dates (e.g., trading, market timing, securities lending, and strategic cash management) remain largely unobservable to investors. These <em>unobserved actions</em> can significantly affect fund performance, either positively through skilled interim trading or negatively through agency costs and hidden behavior.</p>
<p><span class="citation" data-cites="kacperczyk2008unobserved">Kacperczyk, Sialm, and Zheng (<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">2008</a>)</span> developed the <strong>Return Gap</strong> measure to capture the aggregate impact of these unobserved actions on fund returns. The Return Gap is defined as the difference between a fundâ€™s actual reported return and the hypothetical return of a portfolio that mechanically invests in the fundâ€™s most recently disclosed holdings. Formally:</p>
<p><span id="eq-return-gap-basic"><span class="math display">\[
\text{Return Gap}_{i,t} = R_{i,t}^{\text{Actual}} - R_{i,t}^{\text{Holdings}}
\tag{36.1}\]</span></span></p>
<p>where <span class="math inline">\(R_{i,t}^{\text{Actual}}\)</span> is the net-of-expense return reported by fund <span class="math inline">\(i\)</span> in month <span class="math inline">\(t\)</span>, adjusted for expenses to obtain the gross return, and <span class="math inline">\(R_{i,t}^{\text{Holdings}}\)</span> is the hypothetical buy-and-hold return computed from the most recently disclosed portfolio holdings.</p>
<p>A positive Return Gap indicates that the fund managerâ€™s unobserved actions (e.g., interim trading, cash management, or other activities) added value beyond what a passive replication of disclosed holdings would have generated. Conversely, a persistently negative Return Gap suggests value-destroying interim activity, potentially driven by agency costs, poor trading execution, or hidden fees.</p>
<section id="why-return-gap-matters" class="level2" data-number="36.1">
<h2 data-number="36.1" class="anchored" data-anchor-id="why-return-gap-matters"><span class="header-section-number">36.1</span> Why Return Gap Matters</h2>
<p>The Return Gap is economically significant for several reasons:</p>
<ol type="1">
<li><strong>Performance persistence</strong>: Funds in the highest Return Gap decile tend to outperform those in the lowest decile by 1-2% annually on a risk-adjusted basis, and this spread persists over time <span class="citation" data-cites="kacperczyk2008unobserved">(<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">Kacperczyk, Sialm, and Zheng 2008</a>)</span>.</li>
<li><strong>Detecting agency problems</strong>: A persistently negative Return Gap can signal hidden costs such as excessive trading, market impact costs, soft-dollar arrangements, or stale-price exploitation.</li>
<li><strong>Complementing traditional measures</strong>: Unlike alpha-based metrics that blend stock selection skill with interim trading skill, the Return Gap isolates the component of performance attributable to actions taken <em>between</em> disclosure dates.</li>
<li><strong>Regulatory implications</strong>: In emerging markets like Vietnam, where disclosure frequency and regulatory oversight may differ from developed markets, the Return Gap can serve as an early warning system for investor protection.</li>
</ol>
</section>
<section id="application-to-the-vietnamese-market" class="level2" data-number="36.2">
<h2 data-number="36.2" class="anchored" data-anchor-id="application-to-the-vietnamese-market"><span class="header-section-number">36.2</span> Application to the Vietnamese Market</h2>
<p>The Vietnamese mutual fund industry, while relatively young compared to the United States, has experienced rapid growth since the establishment of the first domestic equity funds in the early 2000s. As of 2024, Vietnamâ€™s open-ended fund industry manages assets exceeding 100 trillion VND, with dozens of equity-oriented funds operated by both domestic and foreign-affiliated asset management companies.</p>
<p>Several characteristics of the Vietnamese market make the Return Gap analysis particularly interesting:</p>
<ul>
<li><strong>Disclosure frequency</strong>: Vietnamese funds are required to disclose their top holdings periodically, but the frequency and completeness of disclosure may differ from the quarterly SEC requirements in the U.S.</li>
<li><strong>Market microstructure</strong>: The HOSE (Ho Chi Minh Stock Exchange) and HNX (Hanoi Stock Exchange) feature daily price limits (plus or minus 7% on HOSE, plus or minus 10% on HNX), T+2 settlement, and foreign ownership limits that may constrain or enable certain interim trading strategies.</li>
<li><strong>Information asymmetry</strong>: In an emerging market with less analyst coverage, the scope for informed interim trading and hence positive Return Gap may be larger than in more efficient markets.</li>
<li><strong>Regulatory environment</strong>: Vietnamâ€™s State Securities Commission (SSC) has progressively strengthened disclosure and governance requirements, making temporal analysis of Return Gap especially informative.</li>
</ul>
</section>
<section id="sec-return-gaptheory" class="level1" data-number="37">
<h1 data-number="37"><span class="header-section-number">37</span> Theoretical Framework</h1>
<section id="decomposing-fund-returns" class="level2" data-number="37.1">
<h2 data-number="37.1" class="anchored" data-anchor-id="decomposing-fund-returns"><span class="header-section-number">37.1</span> Decomposing Fund Returns</h2>
<p>Consider a mutual fund <span class="math inline">\(i\)</span> that discloses its portfolio holdings at discrete dates <span class="math inline">\(\tau_1, \tau_2, \ldots\)</span> As disclosed at date <span class="math inline">\(\tau_k\)</span>, the fund holds <span class="math inline">\(N_k\)</span> securities with weights <span class="math inline">\(\{w_{j,\tau_k}\}_{j=1}^{N_k}\)</span>, where <span class="math inline">\(w_{j,\tau_k}\)</span> represents the portfolio weight of security <span class="math inline">\(j\)</span>.</p>
<p>Between disclosure dates <span class="math inline">\(\tau_k\)</span> and <span class="math inline">\(\tau_{k+1}\)</span>, the fundâ€™s <em>actual gross return</em> in month <span class="math inline">\(t\)</span> can be decomposed as:</p>
<p><span id="eq-decomposition"><span class="math display">\[
R_{i,t}^{\text{Gross}} = R_{i,t}^{\text{Holdings}} + \underbrace{R_{i,t}^{\text{Gross}} - R_{i,t}^{\text{Holdings}}}_{\text{Return Gap}}
\tag{37.1}\]</span></span></p>
<p>The hypothetical holdings return <span class="math inline">\(R_{i,t}^{\text{Holdings}}\)</span> is computed as the value-weighted return of the buy-and-hold portfolio based on the most recent disclosure:</p>
<p><span id="eq-holdings-return"><span class="math display">\[
R_{i,t}^{\text{Holdings}} = \sum_{j=1}^{N_k} \tilde{w}_{j,t-1} \cdot r_{j,t}
\tag{37.2}\]</span></span></p>
<p>where <span class="math inline">\(r_{j,t}\)</span> is the return of security <span class="math inline">\(j\)</span> in month <span class="math inline">\(t\)</span>, and <span class="math inline">\(\tilde{w}_{j,t-1}\)</span> is the <em>evolved</em> portfolio weight at the end of month <span class="math inline">\(t-1\)</span>, reflecting the buy-and-hold drift from the original disclosure weights:</p>
<p><span id="eq-evolved-weights"><span class="math display">\[
\tilde{w}_{j,t-1} = \frac{w_{j,\tau_k} \prod_{s=\tau_k+1}^{t-1}(1 + r_{j,s})}{\sum_{\ell=1}^{N_k} w_{\ell,\tau_k} \prod_{s=\tau_k+1}^{t-1}(1 + r_{\ell,s})}
\tag{37.3}\]</span></span></p>
<p>In practice, rather than tracking evolved weights explicitly, we use dollar values of holdings positions (shares held times price) as the natural weighting scheme.</p>
</section>
<section id="the-return-gap-measure" class="level2" data-number="37.2">
<h2 data-number="37.2" class="anchored" data-anchor-id="the-return-gap-measure"><span class="header-section-number">37.2</span> The Return Gap Measure</h2>
<section id="gross-return-gap" class="level3" data-number="37.2.1">
<h3 data-number="37.2.1" class="anchored" data-anchor-id="gross-return-gap"><span class="header-section-number">37.2.1</span> Gross Return Gap</h3>
<p>The Return Gap as originally defined by <span class="citation" data-cites="kacperczyk2008unobserved">Kacperczyk, Sialm, and Zheng (<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">2008</a>)</span> uses the <em>gross</em> (before-expense) return:</p>
<p><span id="eq-return-gap-gross"><span class="math display">\[
\text{RG}_{i,t} = R_{i,t}^{\text{Gross}} - R_{i,t}^{\text{Holdings}} = \left(R_{i,t}^{\text{Net}} + \frac{\text{Expense Ratio}_{i,t}}{12}\right) - R_{i,t}^{\text{Holdings}}
\tag{37.4}\]</span></span></p>
<p>where <span class="math inline">\(R_{i,t}^{\text{Net}}\)</span> is the reported net-of-expense return and the annual expense ratio is divided by 12 to approximate the monthly expense charge.</p>
</section>
<section id="sources-of-return-gap" class="level3" data-number="37.2.2">
<h3 data-number="37.2.2" class="anchored" data-anchor-id="sources-of-return-gap"><span class="header-section-number">37.2.2</span> Sources of Return Gap</h3>
<p>The Return Gap captures several components <span class="citation" data-cites="kacperczyk2008unobserved elton2011holdings">(<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">Kacperczyk, Sialm, and Zheng 2008</a>; <a href="references.html#ref-elton2011holdings" role="doc-biblioref">Elton, Gruber, and Blake 2011</a>)</span>:</p>
<p><span id="eq-decompose-rg"><span class="math display">\[
\text{RG}_{i,t} = \underbrace{\Delta_{\text{trade}}}_{\text{Interim trading}} + \underbrace{\Delta_{\text{cash}}}_{\text{Cash drag/return}} + \underbrace{\Delta_{\text{fees}}}_{\text{Hidden fees}} + \underbrace{\Delta_{\text{lend}}}_{\text{Securities lending}} + \underbrace{\varepsilon_t}_{\text{Noise}}
\tag{37.5}\]</span></span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\Delta_{\text{trade}}\)</span>: The return impact of buying and selling securities between disclosure dates. Skilled managers generate positive <span class="math inline">\(\Delta_{\text{trade}}\)</span> by timing trades.</li>
<li><span class="math inline">\(\Delta_{\text{cash}}\)</span>: The effect of holding cash or cash equivalents not captured in equity holdings disclosures. In rising markets, cash creates a drag (negative contribution); in falling markets, cash provides a cushion.</li>
<li><span class="math inline">\(\Delta_{\text{fees}}\)</span>: Transaction costs, brokerage commissions, and any hidden fees not reflected in the stated expense ratio.</li>
<li><span class="math inline">\(\Delta_{\text{lend}}\)</span>: Revenue from securities lending programs, which generates positive Return Gap.</li>
<li><span class="math inline">\(\varepsilon_t\)</span>: Measurement noise from timing differences, stale prices, or data errors.</li>
</ul>
</section>
<section id="predictive-return-gap" class="level3" data-number="37.2.3">
<h3 data-number="37.2.3" class="anchored" data-anchor-id="predictive-return-gap"><span class="header-section-number">37.2.3</span> Predictive Return Gap</h3>
<p>To form tradeable portfolios and avoid look-ahead bias, <span class="citation" data-cites="kacperczyk2008unobserved">Kacperczyk, Sialm, and Zheng (<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">2008</a>)</span> use the <em>trailing 12-month average</em> Return Gap, lagged by one quarter to account for the reporting delay:</p>
<p><span id="eq-trailing-rg"><span class="math display">\[
\overline{\text{RG}}_{i,t}^{12} = \frac{1}{12} \sum_{s=1}^{12} \text{RG}_{i,t-s}
\tag{37.6}\]</span></span></p>
<p>The additional 3-month (one quarter) lag ensures that the Return Gap signal is based only on information available to investors at the time of portfolio formation. This is particularly important in Vietnam, where fund reporting may involve delays.</p>
</section>
</section>
<section id="risk-adjusted-performance-evaluation" class="level2" data-number="37.3">
<h2 data-number="37.3" class="anchored" data-anchor-id="risk-adjusted-performance-evaluation"><span class="header-section-number">37.3</span> Risk-Adjusted Performance Evaluation</h2>
<p>To evaluate whether Return Gap-sorted portfolios generate genuine risk-adjusted returns, we employ several factor models.</p>
<section id="capm-alpha" class="level3" data-number="37.3.1">
<h3 data-number="37.3.1" class="anchored" data-anchor-id="capm-alpha"><span class="header-section-number">37.3.1</span> CAPM Alpha</h3>
<p><span id="eq-capm"><span class="math display">\[
R_{p,t} - R_{f,t} = \alpha_p + \beta_p (R_{m,t} - R_{f,t}) + \epsilon_{p,t}
\tag{37.7}\]</span></span></p>
</section>
<section id="fama-french-three-factor-model" class="level3" data-number="37.3.2">
<h3 data-number="37.3.2" class="anchored" data-anchor-id="fama-french-three-factor-model"><span class="header-section-number">37.3.2</span> Fama-French Three-Factor Model</h3>
<p><span id="eq-ff3"><span class="math display">\[
R_{p,t} - R_{f,t} = \alpha_p + \beta_{1,p} \cdot \text{MKT}_t + \beta_{2,p} \cdot \text{SMB}_t + \beta_{3,p} \cdot \text{HML}_t + \epsilon_{p,t}
\tag{37.8}\]</span></span></p>
</section>
<section id="carhart-four-factor-model" class="level3" data-number="37.3.3">
<h3 data-number="37.3.3" class="anchored" data-anchor-id="carhart-four-factor-model"><span class="header-section-number">37.3.3</span> Carhart Four-Factor Model</h3>
<p><span id="eq-carhart"><span class="math display">\[
R_{p,t} - R_{f,t} = \alpha_p + \beta_{1,p} \cdot \text{MKT}_t + \beta_{2,p} \cdot \text{SMB}_t + \beta_{3,p} \cdot \text{HML}_t + \beta_{4,p} \cdot \text{UMD}_t + \epsilon_{p,t}
\tag{37.9}\]</span></span></p>
<p>where <span class="math inline">\(\text{UMD}_t\)</span> is the momentum factor (up minus down).</p>
</section>
<section id="fama-french-five-factor-model" class="level3" data-number="37.3.4">
<h3 data-number="37.3.4" class="anchored" data-anchor-id="fama-french-five-factor-model"><span class="header-section-number">37.3.4</span> Fama-French Five-Factor Model</h3>
<p>For a more comprehensive risk adjustment relevant to the Vietnamese market:</p>
<p><span id="eq-ff5"><span class="math display">\[
R_{p,t} - R_{f,t} = \alpha_p + \beta_1 \text{MKT}_t + \beta_2 \text{SMB}_t + \beta_3 \text{HML}_t + \beta_4 \text{RMW}_t + \beta_5 \text{CMA}_t + \epsilon_{p,t}
\tag{37.10}\]</span></span></p>
<p>where <span class="math inline">\(\text{RMW}_t\)</span> (robust minus weak) captures profitability and <span class="math inline">\(\text{CMA}_t\)</span> (conservative minus aggressive) captures investment patterns.</p>
</section>
</section>
<section id="newey-west-standard-errors" class="level2" data-number="37.4">
<h2 data-number="37.4" class="anchored" data-anchor-id="newey-west-standard-errors"><span class="header-section-number">37.4</span> Newey-West Standard Errors</h2>
<p>Since portfolio returns may exhibit serial correlation, we use <span class="citation" data-cites="newey1987simple">Newey and West (<a href="references.html#ref-newey1987simple" role="doc-biblioref">1987</a>)</span> standard errors with <span class="math inline">\(L\)</span> lags:</p>
<p><span id="eq-newey-west-var"><span class="math display">\[
\hat{V}(\hat{\alpha}) = T \left(\sum_{t=1}^{T} \mathbf{x}_t \mathbf{x}_t'\right)^{-1} \hat{S} \left(\sum_{t=1}^{T} \mathbf{x}_t \mathbf{x}_t'\right)^{-1}
\tag{37.11}\]</span></span></p>
<p>where the HAC covariance estimator is:</p>
<p><span id="eq-hac"><span class="math display">\[
\hat{S} = \hat{\Gamma}_0 + \sum_{\ell=1}^{L} \left(1 - \frac{\ell}{L+1}\right)\left(\hat{\Gamma}_\ell + \hat{\Gamma}_\ell'\right)
\tag{37.12}\]</span></span></p>
<p>and <span class="math inline">\(\hat{\Gamma}_\ell = \frac{1}{T}\sum_{t=\ell+1}^{T} \hat{\epsilon}_t \hat{\epsilon}_{t-\ell} \mathbf{x}_t \mathbf{x}_{t-\ell}'\)</span>. The standard lag choice is <span class="math inline">\(L = \lfloor 4(T/100)^{2/9} \rfloor\)</span>.</p>
</section>
</section>
<section id="sec-return-gapdata" class="level1" data-number="38">
<h1 data-number="38"><span class="header-section-number">38</span> Data and Sample Construction</h1>
<section id="data-sources" class="level2" data-number="38.1">
<h2 data-number="38.1" class="anchored" data-anchor-id="data-sources"><span class="header-section-number">38.1</span> Data Sources</h2>
<p><a href="#tbl-return-gaps-data-sources" class="quarto-xref">Table&nbsp;<span>38.1</span></a> shows the sources used in the construction of return gaps.</p>
<div id="tbl-return-gaps-data-sources" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-return-gaps-data-sources-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;38.1: Data sources for the Return Gap analysis in Vietnam
</figcaption>
<div aria-describedby="tbl-return-gaps-data-sources-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Data Category</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Fund holdings</td>
<td style="text-align: left;">DataCore Fund Holdings</td>
<td style="text-align: left;">Disclosed portfolio positions including ticker, shares held, report date, and vintage (filing) date</td>
</tr>
<tr class="even">
<td style="text-align: left;">Fund returns</td>
<td style="text-align: left;">DataCore Fund Performance</td>
<td style="text-align: left;">Monthly NAV-based net returns, total net assets, and expense ratios</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Fund characteristics</td>
<td style="text-align: left;">DataCore Fund Master</td>
<td style="text-align: left;">Fund objective codes, inception dates, management company, investment style</td>
</tr>
<tr class="even">
<td style="text-align: left;">Stock prices and returns</td>
<td style="text-align: left;">DataCore Equity Market</td>
<td style="text-align: left;">Daily and monthly adjusted prices, returns, shares outstanding, and corporate actions for HOSE and HNX listed securities</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Risk factors</td>
<td style="text-align: left;">DataCore / Constructed</td>
<td style="text-align: left;">Vietnamese market factor portfolios (MKT, SMB, HML, UMD, RMW, CMA)</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
<section id="setting-up-the-environment" class="level2" data-number="38.2">
<h2 data-number="38.2" class="anchored" data-anchor-id="setting-up-the-environment"><span class="header-section-number">38.2</span> Setting Up the Environment</h2>
<div id="setup-environment" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.regression.linear_model <span class="im">import</span> OLS</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"font.size"</span>: <span class="dv">12</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">14</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">12</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">150</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">"font.family"</span>: <span class="st">"serif"</span>,</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-return-gapstock-data" class="level2" data-number="38.3">
<h2 data-number="38.3" class="anchored" data-anchor-id="sec-return-gapstock-data"><span class="header-section-number">38.3</span> Loading and Preparing Stock Market Data</h2>
<p>The first step is to load the stock-level data, which provides the foundation for computing hypothetical holdings returns.</p>
<div id="cell-load-stock-data" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># In production, replace with actual DataCore API calls:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   from datacore import DataCoreClient</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   client = DataCoreClient(api_key="YOUR_KEY")</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   stock_data = client.get_equity_monthly(</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#       exchange=["HOSE", "HNX"],</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#       start_date="2010-01-01",</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#       end_date="2024-12-31",</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#       fields=["ticker", "date", "close_adj", "return_monthly",</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#               "shares_outstanding", "market_cap"]</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_stock_data(</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    n_stocks: <span class="bu">int</span> <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    start_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2012-01-01"</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    end_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2024-12-31"</span>,</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate simulated monthly stock data mimicking Vietnamese</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="co">    equity market characteristics.</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> [<span class="ss">f"VN</span><span class="sc">{</span><span class="bu">str</span>(i)<span class="sc">.</span>zfill(<span class="dv">4</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_stocks <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker <span class="kw">in</span> tickers:</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        list_offset <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dates) <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>        available_dates <span class="op">=</span> dates[list_offset:]</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> np.random.normal(<span class="fl">0.008</span>, <span class="fl">0.005</span>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> np.random.uniform(<span class="fl">0.06</span>, <span class="fl">0.15</span>)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.8</span>)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        market_shocks <span class="op">=</span> np.random.normal(<span class="fl">0.005</span>, <span class="fl">0.06</span>, <span class="bu">len</span>(available_dates))</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>        idio_shocks <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma, <span class="bu">len</span>(available_dates))</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> mu <span class="op">+</span> beta <span class="op">*</span> market_shocks <span class="op">+</span> idio_shocks</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> np.clip(returns, <span class="op">-</span><span class="fl">0.30</span>, <span class="fl">0.40</span>)</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.random.uniform(<span class="dv">10</span>, <span class="dv">150</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        prices <span class="op">=</span> [price]</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> returns[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>            price <span class="op">=</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> r)</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            prices.append(price)</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>        shares <span class="op">=</span> np.random.uniform(<span class="dv">50</span>, <span class="dv">500</span>) <span class="op">*</span> <span class="fl">1e6</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>        shares_series <span class="op">=</span> np.full(<span class="bu">len</span>(available_dates), shares)</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(available_dates):</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>            records.append({</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ticker"</span>: ticker, <span class="st">"date"</span>: d,</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>                <span class="st">"close_adj"</span>: prices[i], <span class="st">"ret"</span>: returns[i],</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>                <span class="st">"shares_outstanding"</span>: shares_series[i],</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>                <span class="st">"market_cap"</span>: prices[i] <span class="op">*</span> shares_series[i] <span class="op">/</span> <span class="fl">1e9</span>,</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"close_adj_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"ticker"</span>)[<span class="st">"close_adj"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> generate_stock_data()</span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stock data: </span><span class="sc">{</span>stock_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> stock-months"</span>)</span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>stock_data[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>stock_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stock_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a>stock_data.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Stock data: 38,865 stock-months
Unique stocks: 300
Date range: 2012-01 to 2024-12</code></pre>
</div>
<div id="load-stock-data" class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">close_adj</th>
<th data-quarto-table-cell-role="th">ret</th>
<th data-quarto-table-cell-role="th">shares_outstanding</th>
<th data-quarto-table-cell-role="th">market_cap</th>
<th data-quarto-table-cell-role="th">close_adj_lag</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>VN0001</td>
<td>2015-03-31</td>
<td>45.035190</td>
<td>0.110630</td>
<td>6.747563e+07</td>
<td>3.038778</td>
<td>NaN</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>VN0001</td>
<td>2015-04-30</td>
<td>50.017423</td>
<td>-0.066939</td>
<td>6.747563e+07</td>
<td>3.374957</td>
<td>45.035190</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>VN0001</td>
<td>2015-05-31</td>
<td>46.669311</td>
<td>0.047021</td>
<td>6.747563e+07</td>
<td>3.149041</td>
<td>50.017423</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>VN0001</td>
<td>2015-06-30</td>
<td>48.863751</td>
<td>-0.152745</td>
<td>6.747563e+07</td>
<td>3.297112</td>
<td>46.669311</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>VN0001</td>
<td>2015-07-31</td>
<td>41.400073</td>
<td>-0.057519</td>
<td>6.747563e+07</td>
<td>2.793496</td>
<td>48.863751</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>VN0001</td>
<td>2015-08-31</td>
<td>39.018788</td>
<td>0.228286</td>
<td>6.747563e+07</td>
<td>2.632817</td>
<td>41.400073</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>VN0001</td>
<td>2015-09-30</td>
<td>47.926227</td>
<td>0.079232</td>
<td>6.747563e+07</td>
<td>3.233852</td>
<td>39.018788</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>VN0001</td>
<td>2015-10-31</td>
<td>51.723515</td>
<td>-0.300000</td>
<td>6.747563e+07</td>
<td>3.490077</td>
<td>47.926227</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>VN0001</td>
<td>2015-11-30</td>
<td>36.206461</td>
<td>0.192114</td>
<td>6.747563e+07</td>
<td>2.443054</td>
<td>51.723515</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>VN0001</td>
<td>2015-12-31</td>
<td>43.162239</td>
<td>0.294336</td>
<td>6.747563e+07</td>
<td>2.912399</td>
<td>36.206461</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sec-return-gapholdings-data" class="level2" data-number="38.4">
<h2 data-number="38.4" class="anchored" data-anchor-id="sec-return-gapholdings-data"><span class="header-section-number">38.4</span> Loading Fund Holdings Data</h2>
<div id="cell-load-holdings-data" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_holdings_data(</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    stock_data: pd.DataFrame,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    n_funds: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    start_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2012-06-30"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    end_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2024-12-31"</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate simulated fund holdings data. Each fund holds 15-80</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">    stocks, disclosed semi-annually or quarterly.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> stock_data[<span class="st">"ticker"</span>].unique()</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    fund_ids <span class="op">=</span> [<span class="ss">f"FUND</span><span class="sc">{</span><span class="bu">str</span>(i)<span class="sc">.</span>zfill(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_funds <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fund_id <span class="kw">in</span> fund_ids:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        inception_idx <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dates) <span class="op">//</span> <span class="dv">4</span>))</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> <span class="dv">3</span> <span class="cf">if</span> np.random.random() <span class="op">&lt;</span> <span class="fl">0.7</span> <span class="cf">else</span> <span class="dv">6</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        n_stocks_held <span class="op">=</span> np.random.randint(<span class="dv">15</span>, <span class="dv">80</span>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        core_stocks <span class="op">=</span> np.random.choice(tickers, size<span class="op">=</span>n_stocks_held, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        report_dates <span class="op">=</span> dates[inception_idx::freq]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rdate <span class="kw">in</span> report_dates:</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>            filing_delay <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>            fdate <span class="op">=</span> rdate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>filing_delay)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> np.random.uniform(<span class="fl">0.05</span>, <span class="fl">0.20</span>)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>            n_replace <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(n_stocks_held <span class="op">*</span> turnover))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>            replace_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(core_stocks), size<span class="op">=</span>n_replace, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            new_stocks <span class="op">=</span> np.random.choice(tickers, size<span class="op">=</span>n_replace, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>            core_stocks[replace_idx] <span class="op">=</span> new_stocks</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ticker <span class="kw">in</span> core_stocks:</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>                shares <span class="op">=</span> np.random.uniform(<span class="dv">100_000</span>, <span class="dv">5_000_000</span>)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>                records.append({</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fund_id"</span>: fund_id, <span class="st">"report_date"</span>: rdate,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"filing_date"</span>: fdate, <span class="st">"ticker"</span>: ticker,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"shares_held"</span>: shares,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"report_date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"report_date"</span>])</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"filing_date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"filing_date"</span>])</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>holdings_raw <span class="op">=</span> generate_holdings_data(stock_data)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings records: </span><span class="sc">{</span>holdings_raw<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique funds: </span><span class="sc">{</span>holdings_raw[<span class="st">'fund_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>holdings_raw.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Holdings records: 89,269
Unique funds: 50</code></pre>
</div>
<div id="load-holdings-data" class="cell-output cell-output-display" data-execution_count="3">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fund_id</th>
<th data-quarto-table-cell-role="th">report_date</th>
<th data-quarto-table-cell-role="th">filing_date</th>
<th data-quarto-table-cell-role="th">ticker</th>
<th data-quarto-table-cell-role="th">shares_held</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0289</td>
<td>4.918132e+06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0297</td>
<td>4.322425e+05</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0259</td>
<td>2.383117e+05</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0215</td>
<td>1.140891e+06</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0262</td>
<td>1.104603e+06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0292</td>
<td>1.665416e+06</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0132</td>
<td>4.625400e+06</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0049</td>
<td>3.447053e+06</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0008</td>
<td>1.525004e+05</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>VN0189</td>
<td>2.527258e+06</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sec-return-gapfund-returns" class="level2" data-number="38.5">
<h2 data-number="38.5" class="anchored" data-anchor-id="sec-return-gapfund-returns"><span class="header-section-number">38.5</span> Loading Fund Returns and Characteristics</h2>
<div id="cell-load-fund-returns" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_fund_returns(holdings, start_date<span class="op">=</span><span class="st">"2012-01-01"</span>, end_date<span class="op">=</span><span class="st">"2024-12-31"</span>):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate monthly fund-level net returns, TNA, and expense ratios."""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    fund_ids <span class="op">=</span> holdings[<span class="st">"fund_id"</span>].unique()</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fund_id <span class="kw">in</span> fund_ids:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        fund_start <span class="op">=</span> holdings.loc[holdings[<span class="st">"fund_id"</span>] <span class="op">==</span> fund_id, <span class="st">"report_date"</span>].<span class="bu">min</span>() <span class="op">-</span> pd.DateOffset(months<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        fund_dates <span class="op">=</span> dates[dates <span class="op">&gt;=</span> fund_start]</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        exp_ratio <span class="op">=</span> np.random.uniform(<span class="fl">0.010</span>, <span class="fl">0.025</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        base_tna <span class="op">=</span> np.random.uniform(<span class="dv">50</span>, <span class="dv">2000</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> np.random.normal(<span class="fl">0.007</span>, <span class="fl">0.003</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> np.random.uniform(<span class="fl">0.04</span>, <span class="fl">0.09</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        tna <span class="op">=</span> base_tna</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> d <span class="kw">in</span> fund_dates:</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>            ret <span class="op">=</span> np.clip(np.random.normal(mu, sigma), <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.35</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            tna <span class="op">=</span> <span class="bu">max</span>(tna <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> ret) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, base_tna <span class="op">*</span> <span class="fl">0.02</span>), <span class="dv">10</span>)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>            records.append({<span class="st">"fund_id"</span>: fund_id, <span class="st">"date"</span>: d, <span class="st">"net_return"</span>: ret,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"tna"</span>: tna, <span class="st">"expense_ratio"</span>: exp_ratio <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.001</span>)})</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"expense_ratio"</span>] <span class="op">=</span> df[<span class="st">"expense_ratio"</span>].clip(<span class="fl">0.005</span>, <span class="fl">0.035</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>fund_returns <span class="op">=</span> generate_fund_returns(holdings_raw)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fund-month observations: </span><span class="sc">{</span>fund_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>fund_returns.head(<span class="dv">10</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fund-month observations: 6,808</code></pre>
</div>
<div id="load-fund-returns" class="cell-output cell-output-display" data-execution_count="4">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fund_id</th>
<th data-quarto-table-cell-role="th">date</th>
<th data-quarto-table-cell-role="th">net_return</th>
<th data-quarto-table-cell-role="th">tna</th>
<th data-quarto-table-cell-role="th">expense_ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>FUND001</td>
<td>2012-08-31</td>
<td>0.045634</td>
<td>568.611866</td>
<td>0.022429</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">1</th>
<td>FUND001</td>
<td>2012-09-30</td>
<td>0.106959</td>
<td>631.630643</td>
<td>0.021461</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">2</th>
<td>FUND001</td>
<td>2012-10-31</td>
<td>-0.063495</td>
<td>612.614200</td>
<td>0.020634</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">3</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>-0.087247</td>
<td>563.095634</td>
<td>0.023795</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">4</th>
<td>FUND001</td>
<td>2012-12-31</td>
<td>-0.006777</td>
<td>545.547597</td>
<td>0.021886</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">5</th>
<td>FUND001</td>
<td>2013-01-31</td>
<td>-0.029553</td>
<td>532.221482</td>
<td>0.021999</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">6</th>
<td>FUND001</td>
<td>2013-02-28</td>
<td>-0.002767</td>
<td>538.411988</td>
<td>0.021567</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">7</th>
<td>FUND001</td>
<td>2013-03-31</td>
<td>-0.138187</td>
<td>477.997478</td>
<td>0.022189</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">8</th>
<td>FUND001</td>
<td>2013-04-30</td>
<td>0.045137</td>
<td>484.711443</td>
<td>0.022058</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">9</th>
<td>FUND001</td>
<td>2013-05-31</td>
<td>0.095518</td>
<td>523.213577</td>
<td>0.021911</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sec-return-gapsample-selection" class="level2" data-number="38.6">
<h2 data-number="38.6" class="anchored" data-anchor-id="sec-return-gapsample-selection"><span class="header-section-number">38.6</span> Sample Selection: Domestic Equity Funds</h2>
<p>Following the approach of <span class="citation" data-cites="kacperczyk2008unobserved">Kacperczyk, Sialm, and Zheng (<a href="references.html#ref-kacperczyk2008unobserved" role="doc-biblioref">2008</a>)</span>, we restrict our sample to domestic equity funds.</p>
<div id="sample-selection" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>equity_objectives <span class="op">=</span> [</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_DOMESTIC"</span>, <span class="st">"EQUITY_GROWTH"</span>, <span class="st">"EQUITY_VALUE"</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_BLEND"</span>, <span class="st">"EQUITY_LARGE_CAP"</span>, <span class="st">"EQUITY_MID_CAP"</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_SMALL_CAP"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>fund_ids <span class="op">=</span> fund_returns[<span class="st">"fund_id"</span>].unique()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>fund_master <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fund_id"</span>: fund_ids,</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"objective"</span>: np.random.choice(</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        equity_objectives <span class="op">+</span> [<span class="st">"BOND"</span>, <span class="st">"BALANCED"</span>, <span class="st">"MONEY_MARKET"</span>],</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span><span class="bu">len</span>(fund_ids),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        p<span class="op">=</span>[<span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.10</span>, <span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.06</span>, <span class="fl">0.15</span>, <span class="fl">0.18</span>, <span class="fl">0.15</span>],</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>equity_fund_ids <span class="op">=</span> fund_master.loc[</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    fund_master[<span class="st">"objective"</span>].isin(equity_objectives), <span class="st">"fund_id"</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>].values</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total funds: </span><span class="sc">{</span><span class="bu">len</span>(fund_ids)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equity funds: </span><span class="sc">{</span><span class="bu">len</span>(equity_fund_ids)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(equity_fund_ids)<span class="op">/</span><span class="bu">len</span>(fund_ids)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Objective distribution:"</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fund_master[<span class="st">"objective"</span>].value_counts().to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Total funds: 50
Equity funds: 29 (58.0%)

Objective distribution:
objective
BALANCED            9
EQUITY_VALUE        9
EQUITY_GROWTH       6
BOND                6
MONEY_MARKET        6
EQUITY_BLEND        5
EQUITY_LARGE_CAP    3
EQUITY_SMALL_CAP    2
EQUITY_MID_CAP      2
EQUITY_DOMESTIC     2</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-return-gapcomputing" class="level1" data-number="39">
<h1 data-number="39"><span class="header-section-number">39</span> Computing the Return Gap</h1>
<section id="sec-return-gapvintages" class="level2" data-number="39.1">
<h2 data-number="39.1" class="anchored" data-anchor-id="sec-return-gapvintages"><span class="header-section-number">39.1</span> Step 1: Prepare Holdings Vintages</h2>
<p>A critical first step is to correctly handle the <em>vintage</em> structure of holdings data. Each holdings report has two key dates: the <strong>report date</strong> (<span class="math inline">\(\tau\)</span>, the as-of date) and the <strong>filing date</strong> (<span class="math inline">\(f\)</span>, when it becomes public). We keep only the first vintage per fund-report date.</p>
<div id="cell-prepare-vintages" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_holdings_vintages(holdings, max_holding_months<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process holdings vintages and compute next report dates."""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    first_vintage <span class="op">=</span> (</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        holdings.sort_values([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>])</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>])</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        .agg(filing_date<span class="op">=</span>(<span class="st">"filing_date"</span>, <span class="st">"first"</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    first_vintage <span class="op">=</span> first_vintage.sort_values([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>])</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage.groupby(<span class="st">"fund_id"</span>)[<span class="st">"report_date"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    max_date <span class="op">=</span> first_vintage[<span class="st">"report_date"</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>max_holding_months)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[<span class="st">"next_report_date"</span>].fillna(max_date)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[[<span class="st">"next_report_date"</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>).clip(upper<span class="op">=</span>max_date)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[<span class="st">"next_report_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> holdings.merge(first_vintage, on<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>holdings_vintaged <span class="op">=</span> prepare_holdings_vintages(holdings_raw)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings after vintage processing: </span><span class="sc">{</span>holdings_vintaged<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> records"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>sample_fund <span class="op">=</span> holdings_vintaged[<span class="st">"fund_id"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>(holdings_vintaged.loc[holdings_vintaged[<span class="st">"fund_id"</span>] <span class="op">==</span> sample_fund]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a> [[<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>, <span class="st">"next_report_date"</span>]]</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a> .drop_duplicates().head(<span class="dv">8</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Holdings after vintage processing: 89,269 records</code></pre>
</div>
<div id="prepare-vintages" class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fund_id</th>
<th data-quarto-table-cell-role="th">report_date</th>
<th data-quarto-table-cell-role="th">filing_date</th>
<th data-quarto-table-cell-role="th">next_report_date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<th data-quarto-table-cell-role="th">0</th>
<td>FUND001</td>
<td>2012-11-30</td>
<td>2012-12-30</td>
<td>2013-02-28</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">52</th>
<td>FUND001</td>
<td>2013-02-28</td>
<td>2013-03-28</td>
<td>2013-05-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">104</th>
<td>FUND001</td>
<td>2013-05-31</td>
<td>2013-08-31</td>
<td>2013-08-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">156</th>
<td>FUND001</td>
<td>2013-08-31</td>
<td>2013-11-30</td>
<td>2013-11-30</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">208</th>
<td>FUND001</td>
<td>2013-11-30</td>
<td>2014-02-28</td>
<td>2014-02-28</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">260</th>
<td>FUND001</td>
<td>2014-02-28</td>
<td>2014-04-28</td>
<td>2014-05-31</td>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">312</th>
<td>FUND001</td>
<td>2014-05-31</td>
<td>2014-08-31</td>
<td>2014-08-31</td>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">364</th>
<td>FUND001</td>
<td>2014-08-31</td>
<td>2014-10-31</td>
<td>2014-11-30</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="sec-return-gapadjust-shares" class="level2" data-number="39.2">
<h2 data-number="39.2" class="anchored" data-anchor-id="sec-return-gapadjust-shares"><span class="header-section-number">39.2</span> Step 2: Adjust Shares for Corporate Actions</h2>
<div id="adjust-shares" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_holdings_shares(holdings, stock_data):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adjust shares for splits, bonuses, rights. Simulated: factor=1."""</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    holdings[<span class="st">"shares_adj"</span>] <span class="op">=</span> holdings[<span class="st">"shares_held"</span>]</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> holdings</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>holdings_adj <span class="op">=</span> adjust_holdings_shares(holdings_vintaged, stock_data)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="sec-return-gaphypothetical-returns" class="level2" data-number="39.3">
<h2 data-number="39.3" class="anchored" data-anchor-id="sec-return-gaphypothetical-returns"><span class="header-section-number">39.3</span> Step 3: Compute Hypothetical Holdings Returns</h2>
<p>This is the core computation. For each fund, we take the disclosed holdings as of report date <span class="math inline">\(\tau\)</span>, and for each month <span class="math inline">\(t\)</span> in <span class="math inline">\((\tau, \tau_{\text{next}}]\)</span>, compute the value-weighted return using lagged dollar values as weights.</p>
<div id="compute-holdings-returns" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_holdings_returns(holdings, stock_data, min_stocks<span class="op">=</span><span class="dv">10</span>, min_assets_bn<span class="op">=</span><span class="fl">5.0</span>):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute monthly hypothetical buy-and-hold portfolio returns."""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> holdings.merge(stock_data, on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (merged[<span class="st">"date"</span>] <span class="op">&gt;</span> merged[<span class="st">"report_date"</span>]) <span class="op">&amp;</span> (merged[<span class="st">"date"</span>] <span class="op">&lt;=</span> merged[<span class="st">"next_report_date"</span>])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.loc[mask].copy()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"hvalue_lag"</span>] <span class="op">=</span> merged[<span class="st">"shares_adj"</span>] <span class="op">*</span> merged[<span class="st">"close_adj_lag"</span>]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.loc[merged[<span class="st">"hvalue_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.drop_duplicates(subset<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"date"</span>, <span class="st">"report_date"</span>, <span class="st">"ticker"</span>], keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> weighted_return(group):</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">"hvalue_lag"</span>]</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>        total_weight <span class="op">=</span> weights.<span class="bu">sum</span>()</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_weight <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.Series({<span class="st">"hret"</span>: np.nan, <span class="st">"n_stocks"</span>: <span class="dv">0</span>, <span class="st">"assets_lag_bn"</span>: <span class="dv">0</span>})</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>        wret <span class="op">=</span> np.average(group[<span class="st">"ret"</span>], weights<span class="op">=</span>weights)</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({<span class="st">"hret"</span>: wret, <span class="st">"n_stocks"</span>: <span class="bu">len</span>(group), <span class="st">"assets_lag_bn"</span>: total_weight <span class="op">/</span> <span class="fl">1e9</span>})</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        merged.groupby([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(weighted_return, include_groups<span class="op">=</span><span class="va">False</span>).reset_index()</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    portfolio_returns[<span class="st">"assets_bn"</span>] <span class="op">=</span> portfolio_returns[<span class="st">"assets_lag_bn"</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns[<span class="st">"hret"</span>])</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (portfolio_returns[<span class="st">"n_stocks"</span>] <span class="op">&gt;=</span> min_stocks) <span class="op">&amp;</span> (portfolio_returns[<span class="st">"assets_bn"</span>] <span class="op">&gt;=</span> min_assets_bn)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_returns.loc[mask].copy()</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>holdings_returns <span class="op">=</span> compute_holdings_returns(holdings_adj, stock_data)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fund-month observations (hypothetical returns): </span><span class="sc">{</span>holdings_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique funds: </span><span class="sc">{</span>holdings_returns[<span class="st">'fund_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Summary:"</span>)</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(holdings_returns[[<span class="st">"hret"</span>, <span class="st">"n_stocks"</span>, <span class="st">"assets_bn"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fund-month observations (hypothetical returns): 6,170
Unique funds: 50

Summary:
            hret   n_stocks  assets_bn
count  6170.0000  6170.0000  6170.0000
mean      0.0149    42.7476    27.8827
std       0.0426    14.5061    20.1749
min      -0.1997    13.0000     5.0241
25%      -0.0111    31.0000    13.3775
50%       0.0146    41.0000    22.6388
75%       0.0411    53.0000    35.6065
max       0.2209    74.0000   167.3511</code></pre>
</div>
</div>
</section>
<section id="sec-return-gapgross-returns" class="level2" data-number="39.4">
<h2 data-number="39.4" class="anchored" data-anchor-id="sec-return-gapgross-returns"><span class="header-section-number">39.4</span> Step 4: Compute Gross Fund Returns</h2>
<div id="compute-gross-returns" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_fund_returns(fund_returns, equity_fund_ids):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Prepare fund-level gross returns."""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> fund_returns.loc[fund_returns[<span class="st">"fund_id"</span>].isin(equity_fund_ids)].copy()</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"expense_ratio"</span>] <span class="op">=</span> df[<span class="st">"expense_ratio"</span>].fillna(df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"expense_ratio"</span>].transform(<span class="st">"median"</span>))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_return"</span>] <span class="op">=</span> df[<span class="st">"net_return"</span>] <span class="op">+</span> df[<span class="st">"expense_ratio"</span>] <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"tna_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"tna"</span>].shift(<span class="dv">1</span>).fillna(df[<span class="st">"tna"</span>])</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>fund_ret_clean <span class="op">=</span> prepare_fund_returns(fund_returns, equity_fund_ids)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equity fund-months: </span><span class="sc">{</span>fund_ret_clean<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Equity fund-months: 3,993</code></pre>
</div>
</div>
</section>
<section id="sec-return-gapmerge-return-gap" class="level2" data-number="39.5">
<h2 data-number="39.5" class="anchored" data-anchor-id="sec-return-gapmerge-return-gap"><span class="header-section-number">39.5</span> Step 5: Merge and Compute Return Gap</h2>
<div id="compute-return-gap" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_return_gap(holdings_returns, fund_returns):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute Return Gap and trailing averages."""</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> holdings_returns.merge(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        fund_returns[[<span class="st">"fund_id"</span>, <span class="st">"date"</span>, <span class="st">"net_return"</span>, <span class="st">"gross_return"</span>, <span class="st">"expense_ratio"</span>, <span class="st">"tna"</span>]],</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"date"</span>], how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"return_gap"</span>] <span class="op">=</span> merged[<span class="st">"gross_return"</span>] <span class="op">-</span> merged[<span class="st">"hret"</span>]</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.sort_values([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"rg_12m"</span>] <span class="op">=</span> merged.groupby(<span class="st">"fund_id"</span>)[<span class="st">"return_gap"</span>].transform(</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">8</span>).mean()</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"rg_12m_lag4"</span>] <span class="op">=</span> merged.groupby(<span class="st">"fund_id"</span>)[<span class="st">"rg_12m"</span>].shift(<span class="dv">4</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>return_gap_data <span class="op">=</span> compute_return_gap(holdings_returns, fund_ret_clean)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Return Gap observations: </span><span class="sc">{</span>return_gap_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Summary:"</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(return_gap_data[[<span class="st">"return_gap"</span>, <span class="st">"rg_12m"</span>, <span class="st">"rg_12m_lag4"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Return Gap observations: 3,592

Summary:
        return_gap       rg_12m  rg_12m_lag4
count  3592.000000  3389.000000  3273.000000
mean     -0.005734    -0.005349    -0.005329
std       0.080211     0.022955     0.022864
min      -0.307136    -0.094187    -0.094187
25%      -0.058760    -0.019080    -0.019057
50%      -0.006127    -0.005284    -0.005242
75%       0.047785     0.008620     0.008653
max       0.277137     0.079589     0.079589</code></pre>
</div>
</div>
</section>
<section id="distribution-of-the-return-gap" class="level2" data-number="39.6">
<h2 data-number="39.6" class="anchored" data-anchor-id="distribution-of-the-return-gap"><span class="header-section-number">39.6</span> Distribution of the Return Gap</h2>
<div id="cell-fig-return-gap-distribution" class="cell" data-fig-height="5" data-fig-width="12" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>rg <span class="op">=</span> return_gap_data[<span class="st">"return_gap"</span>].dropna()</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>rg_trimmed <span class="op">=</span> rg.clip(rg.quantile(<span class="fl">0.01</span>), rg.quantile(<span class="fl">0.99</span>))</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(rg_trimmed, bins<span class="op">=</span><span class="dv">80</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">"#2C5F8A"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(rg.mean(), color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Mean = </span><span class="sc">{</span>rg<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(rg.median(), color<span class="op">=</span><span class="st">"#FF8F00"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Median = </span><span class="sc">{</span>rg<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Monthly Return Gap"</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Panel A: Monthly Return Gap"</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>rg12 <span class="op">=</span> return_gap_data[<span class="st">"rg_12m"</span>].dropna()</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>rg12_trimmed <span class="op">=</span> rg12.clip(rg12.quantile(<span class="fl">0.01</span>), rg12.quantile(<span class="fl">0.99</span>))</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].hist(rg12_trimmed, bins<span class="op">=</span><span class="dv">80</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">"#1B5E20"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(rg12.mean(), color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Mean = </span><span class="sc">{</span>rg12<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(rg12.median(), color<span class="op">=</span><span class="st">"#FF8F00"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Median = </span><span class="sc">{</span>rg12<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Trailing 12-Month Average Return Gap"</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Panel B: 12-Month Average Return Gap"</span>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-return-gap-distribution" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-return-gap-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-return-gap-distribution-output-1.png" width="1775" height="727" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-return-gap-distribution-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;39.1: Distribution of monthly Return Gap across all fund-month observations.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="time-series-of-cross-sectional-return-gap" class="level2" data-number="39.7">
<h2 data-number="39.7" class="anchored" data-anchor-id="time-series-of-cross-sectional-return-gap"><span class="header-section-number">39.7</span> Time Series of Cross-Sectional Return Gap</h2>
<div id="cell-fig-return-gap-timeseries" class="cell" data-fig-height="5" data-fig-width="12" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>ts_stats <span class="op">=</span> (</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    return_gap_data.groupby(<span class="st">"date"</span>)[<span class="st">"return_gap"</span>]</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>), <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"&lt;lambda_0&gt;"</span>: <span class="st">"p25"</span>, <span class="st">"&lt;lambda_1&gt;"</span>: <span class="st">"p75"</span>}).reset_index()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>ax.fill_between(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"p25"</span>], ts_stats[<span class="st">"p75"</span>], alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">"#2C5F8A"</span>, label<span class="op">=</span><span class="st">"IQR"</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>ax.plot(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"median"</span>], color<span class="op">=</span><span class="st">"#2C5F8A"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Median"</span>)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>ax.plot(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"mean"</span>], color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Monthly Return Gap"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cross-Sectional Distribution of Return Gap Over Time"</span>)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-return-gap-timeseries" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-return-gap-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-return-gap-timeseries-output-1.png" width="1775" height="727" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-return-gap-timeseries-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;39.2: Time series of cross-sectional Return Gap statistics. Solid: median, shaded: IQR, dashed: mean.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-return-gapportfolios" class="level1" data-number="40">
<h1 data-number="40"><span class="header-section-number">40</span> Portfolio Sorting Analysis</h1>
<section id="sec-return-gapdecile-portfolios" class="level2" data-number="40.1">
<h2 data-number="40.1" class="anchored" data-anchor-id="sec-return-gapdecile-portfolios"><span class="header-section-number">40.1</span> Forming Return Gap Decile Portfolios</h2>
<p>Each month <span class="math inline">\(t\)</span>, we sort funds into decile portfolios based on their lagged 12-month average Return Gap (<span class="math inline">\(\overline{\text{RG}}_{i,t-4}^{12}\)</span>). Portfolio 1 contains funds with the lowest Return Gap.</p>
<div id="form-decile-portfolios" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> form_return_gap_portfolios(data, n_portfolios<span class="op">=</span><span class="dv">10</span>, sort_var<span class="op">=</span><span class="st">"rg_12m_lag4"</span>):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Form portfolios by sorting funds into quantile groups."""</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[sort_var]).copy()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio"</span>] <span class="op">=</span> (</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"date"</span>)[sort_var]</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        .transform(<span class="kw">lambda</span> x: pd.qcut(x, n_portfolios, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>n_portfolios <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>portfolio_data <span class="op">=</span> form_return_gap_portfolios(return_gap_data, n_portfolios<span class="op">=</span>n_portfolios)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations with portfolio assignment: </span><span class="sc">{</span>portfolio_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Observations with portfolio assignment: 3,273</code></pre>
</div>
</div>
</section>
<section id="portfolio-returns" class="level2" data-number="40.2">
<h2 data-number="40.2" class="anchored" data-anchor-id="portfolio-returns"><span class="header-section-number">40.2</span> Portfolio Returns</h2>
<div id="compute-portfolio-returns" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(data, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute equal- and value-weighted monthly returns."""</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    ew <span class="op">=</span> data.groupby([<span class="st">"date"</span>, <span class="st">"portfolio"</span>]).agg(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>        ew_ret<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="st">"mean"</span>), n_funds<span class="op">=</span>(<span class="st">"fund_id"</span>, <span class="st">"count"</span>)).reset_index()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vw_func(group):</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> group[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.average(group[<span class="st">"net_return"</span>], weights<span class="op">=</span>w) <span class="cf">if</span> w.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> group[<span class="st">"net_return"</span>].mean()</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    vw <span class="op">=</span> data.groupby([<span class="st">"date"</span>, <span class="st">"portfolio"</span>]).<span class="bu">apply</span>(vw_func, include_groups<span class="op">=</span><span class="va">False</span>).reset_index(name<span class="op">=</span><span class="st">"vw_ret"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ew.merge(vw, on<span class="op">=</span>[<span class="st">"date"</span>, <span class="st">"portfolio"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>port_returns <span class="op">=</span> compute_portfolio_returns(portfolio_data)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>port_wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span>[<span class="st">"ew_ret"</span>, <span class="st">"vw_ret"</span>])</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>port_wide[(<span class="st">"ew_ret"</span>, <span class="st">"LS"</span>)] <span class="op">=</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>port_wide[(<span class="st">"vw_ret"</span>, <span class="st">"LS"</span>)] <span class="op">=</span> port_wide[(<span class="st">"vw_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"vw_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"EW portfolio returns (annualized, %):"</span>)</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((port_wide[<span class="st">"ew_ret"</span>].mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>EW portfolio returns (annualized, %):
portfolio
1.0      4.42
2.0     12.09
3.0     15.52
4.0      8.35
5.0     10.31
6.0     14.38
7.0      1.18
8.0     10.99
9.0      1.33
10.0    15.19
LS      10.77</code></pre>
</div>
</div>
</section>
<section id="characteristics-of-return-gap-portfolios" class="level2" data-number="40.3">
<h2 data-number="40.3" class="anchored" data-anchor-id="characteristics-of-return-gap-portfolios"><span class="header-section-number">40.3</span> Characteristics of Return Gap Portfolios</h2>
<div id="tbl-portfolio-characteristics" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="16">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-portfolio-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;40.1: Characteristics of Return Gap-sorted decile portfolios.
</figcaption>
<div aria-describedby="tbl-portfolio-characteristics-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>chars <span class="op">=</span> portfolio_data.groupby(<span class="st">"portfolio"</span>).agg(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    avg_rg<span class="op">=</span>(<span class="st">"return_gap"</span>, <span class="st">"mean"</span>), avg_rg12<span class="op">=</span>(<span class="st">"rg_12m_lag4"</span>, <span class="st">"mean"</span>),</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    avg_net_ret<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="st">"mean"</span>), avg_gross_ret<span class="op">=</span>(<span class="st">"gross_return"</span>, <span class="st">"mean"</span>),</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    avg_hret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>), avg_expense<span class="op">=</span>(<span class="st">"expense_ratio"</span>, <span class="st">"mean"</span>),</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    avg_tna<span class="op">=</span>(<span class="st">"tna"</span>, <span class="st">"mean"</span>), avg_nstocks<span class="op">=</span>(<span class="st">"n_stocks"</span>, <span class="st">"mean"</span>), n_obs<span class="op">=</span>(<span class="st">"fund_id"</span>, <span class="st">"count"</span>),</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> chars.copy()</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>dc.columns <span class="op">=</span> [<span class="st">"Avg RG"</span>, <span class="st">"Avg RG(12m)"</span>, <span class="st">"Net Ret"</span>, <span class="st">"Gross Ret"</span>, <span class="st">"Hold Ret"</span>, <span class="st">"Expense"</span>, <span class="st">"TNA(Bn)"</span>, <span class="st">"#Stocks"</span>, <span class="st">"#Obs"</span>]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"Avg RG"</span>, <span class="st">"Avg RG(12m)"</span>, <span class="st">"Net Ret"</span>, <span class="st">"Gross Ret"</span>, <span class="st">"Hold Ret"</span>, <span class="st">"Expense"</span>]:</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    dc[col] <span class="op">=</span> (dc[col] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>dc[<span class="st">"TNA(Bn)"</span>] <span class="op">=</span> dc[<span class="st">"TNA(Bn)"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>dc[<span class="st">"#Stocks"</span>] <span class="op">=</span> dc[<span class="st">"#Stocks"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dc.to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>           Avg RG  Avg RG(12m)  Net Ret  Gross Ret  Hold Ret  Expense  TNA(Bn)  #Stocks  #Obs
portfolio                                                                                    
1.0         -0.81        -4.32     0.50       0.66      1.48     1.91   1395.7     41.9   353
2.0          0.16        -2.73     1.02       1.18      1.02     1.86   1941.3     43.9   333
3.0          0.06        -1.85     1.27       1.42      1.36     1.79   2042.0     45.5   335
4.0         -1.11        -1.22     0.51       0.66      1.78     1.81   2052.1     47.6   325
5.0         -0.57        -0.69     0.61       0.76      1.33     1.83   2010.7     46.8   341
6.0          0.04        -0.20     1.23       1.39      1.35     1.86   2138.9     44.8   243
7.0         -1.53         0.22    -0.09       0.07      1.60     1.86   2184.0     44.2   322
8.0         -0.51         0.85     1.14       1.30      1.82     1.93   2340.3     43.7   338
9.0         -1.30         1.61     0.09       0.25      1.54     1.87   2552.9     41.9   330
10.0         0.11         3.17     1.31       1.46      1.35     1.83   2864.7     40.2   351</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="cumulative-returns-of-extreme-portfolios" class="level2" data-number="40.4">
<h2 data-number="40.4" class="anchored" data-anchor-id="cumulative-returns-of-extreme-portfolios"><span class="header-section-number">40.4</span> Cumulative Returns of Extreme Portfolios</h2>
<div id="cell-fig-cumulative-returns" class="cell" data-fig-height="6" data-fig-width="12" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>cum_ret <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>port_wide.index)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"P1 (Low RG)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]).cumprod()</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"P10 (High RG)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)]).cumprod()</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"L/S (P10-P1)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="st">"LS"</span>)]).cumprod()</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {<span class="st">"P1 (Low RG)"</span>: <span class="st">"#D32F2F"</span>, <span class="st">"P10 (High RG)"</span>: <span class="st">"#1B5E20"</span>, <span class="st">"L/S (P10-P1)"</span>: <span class="st">"#1565C0"</span>}</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>styles <span class="op">=</span> {<span class="st">"P1 (Low RG)"</span>: <span class="st">"--"</span>, <span class="st">"P10 (High RG)"</span>: <span class="st">"-"</span>, <span class="st">"L/S (P10-P1)"</span>: <span class="st">"-."</span>}</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cum_ret.columns:</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum_ret.index, cum_ret[col], label<span class="op">=</span>col, color<span class="op">=</span>colors[col], linestyle<span class="op">=</span>styles[col], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">1</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Cumulative Return (Growth of 1 VND)"</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cumulative Performance of Return Gap Portfolios"</span>)</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-cumulative-returns" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-cumulative-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-cumulative-returns-output-1.png" width="1774" height="877" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-cumulative-returns-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;40.1: Cumulative returns of Return Gap-sorted portfolios: P10 (highest RG) vs P1 (lowest), and the long-short spread.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-return-gaprisk-adjusted" class="level1" data-number="41">
<h1 data-number="41"><span class="header-section-number">41</span> Risk-Adjusted Performance</h1>
<section id="risk-factors" class="level2" data-number="41.1">
<h2 data-number="41.1" class="anchored" data-anchor-id="risk-factors"><span class="header-section-number">41.1</span> Risk Factors</h2>
<div id="construct-risk-factors" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_factor_returns(start_date<span class="op">=</span><span class="st">"2012-01-01"</span>, end_date<span class="op">=</span><span class="st">"2024-12-31"</span>):</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate simulated Vietnamese market factor returns."""</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(dates)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: dates,</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rf"</span>: np.random.normal(<span class="fl">0.004</span>, <span class="fl">0.001</span>, n).clip(<span class="fl">0.001</span>, <span class="fl">0.008</span>),</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mkt_rf"</span>: np.random.normal(<span class="fl">0.008</span>, <span class="fl">0.055</span>, n),</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smb"</span>: np.random.normal(<span class="fl">0.003</span>, <span class="fl">0.035</span>, n),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hml"</span>: np.random.normal(<span class="fl">0.002</span>, <span class="fl">0.030</span>, n),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"umd"</span>: np.random.normal(<span class="fl">0.005</span>, <span class="fl">0.045</span>, n),</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rmw"</span>: np.random.normal(<span class="fl">0.002</span>, <span class="fl">0.025</span>, n),</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cma"</span>: np.random.normal(<span class="fl">0.001</span>, <span class="fl">0.020</span>, n),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> generate_factor_returns()</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor summary (monthly %):"</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((factors.drop(columns<span class="op">=</span><span class="st">"date"</span>).describe() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Factor summary (monthly %):
              rf     mkt_rf        smb        hml        umd        rmw        cma
count  15600.000  15600.000  15600.000  15600.000  15600.000  15600.000  15600.000
mean       0.399      0.789      0.454     -0.073      0.396      0.076     -0.043
std        0.099      5.276      3.744      2.899      4.615      2.400      1.940
min        0.132    -12.061     -9.021     -6.937    -11.322     -6.592     -5.971
25%        0.344     -2.929     -1.830     -2.036     -2.440     -1.425     -1.554
50%        0.397      0.844      0.611     -0.056      0.632      0.033      0.003
75%        0.464      3.844      2.981      1.976      3.597      1.707      1.317
max        0.653     15.678      9.744      8.316     13.215      6.142      4.607</code></pre>
</div>
</div>
</section>
<section id="alpha-estimation" class="level2" data-number="41.2">
<h2 data-number="41.2" class="anchored" data-anchor-id="alpha-estimation"><span class="header-section-number">41.2</span> Alpha Estimation</h2>
<div id="estimate-alphas" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_portfolio_alphas(port_returns, factors, n_portfolios<span class="op">=</span><span class="dv">10</span>, nw_lags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate alphas using multiple factor models."""</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    ew_wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_portfolios <span class="kw">in</span> ew_wide.columns <span class="kw">and</span> <span class="dv">1</span> <span class="kw">in</span> ew_wide.columns:</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>        ew_wide[<span class="st">"LS"</span>] <span class="op">=</span> ew_wide[n_portfolios] <span class="op">-</span> ew_wide[<span class="dv">1</span>]</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> ew_wide.merge(factors, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>)) <span class="op">+</span> [<span class="st">"LS"</span>]</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> port <span class="kw">in</span> portfolios:</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> port <span class="kw">not</span> <span class="kw">in</span> merged.columns: <span class="cf">continue</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        y_raw <span class="op">=</span> merged[port].dropna()</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> y_raw.index</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        rf <span class="op">=</span> merged.loc[idx, <span class="st">"rf"</span>]<span class="op">;</span> mkt <span class="op">=</span> merged.loc[idx, <span class="st">"mkt_rf"</span>]</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>        smb <span class="op">=</span> merged.loc[idx, <span class="st">"smb"</span>]<span class="op">;</span> hml <span class="op">=</span> merged.loc[idx, <span class="st">"hml"</span>]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>        umd <span class="op">=</span> merged.loc[idx, <span class="st">"umd"</span>]<span class="op">;</span> rmw <span class="op">=</span> merged.loc[idx, <span class="st">"rmw"</span>]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>        cma <span class="op">=</span> merged.loc[idx, <span class="st">"cma"</span>]</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>        y_ex <span class="op">=</span> y_raw <span class="op">-</span> rf</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>        models <span class="op">=</span> {</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Raw Mean"</span>: (y_raw, <span class="va">None</span>),</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Excess Return"</span>: (y_raw <span class="op">-</span> rf <span class="op">-</span> mkt, <span class="va">None</span>),</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CAPM"</span>: (y_ex, sm.add_constant(mkt)),</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FF3"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Carhart"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml, umd], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FF5"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml, rmw, cma], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> mname, (y, X) <span class="kw">in</span> models.items():</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> X <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>                mean_val <span class="op">=</span> y.mean()<span class="op">;</span> se <span class="op">=</span> y.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(y))</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>                t_stat <span class="op">=</span> mean_val <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>                p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), <span class="bu">len</span>(y)<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>                alpha <span class="op">=</span> mean_val</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>                    reg <span class="op">=</span> OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: nw_lags})</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>                    alpha <span class="op">=</span> reg.params.iloc[<span class="dv">0</span>]<span class="op">;</span> t_stat <span class="op">=</span> reg.tvalues.iloc[<span class="dv">0</span>]<span class="op">;</span> p_val <span class="op">=</span> reg.pvalues.iloc[<span class="dv">0</span>]</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>: alpha, t_stat, p_val <span class="op">=</span> np.nan, np.nan, np.nan</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>            results.append({<span class="st">"portfolio"</span>: port, <span class="st">"model"</span>: mname, <span class="st">"alpha"</span>: alpha, <span class="st">"t_stat"</span>: t_stat, <span class="st">"p_value"</span>: p_val})</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a>alpha_results <span class="op">=</span> estimate_portfolio_alphas(port_returns, factors, n_portfolios)</span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha estimates: </span><span class="sc">{</span><span class="bu">len</span>(alpha_results)<span class="sc">}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Alpha estimates: 66</code></pre>
</div>
</div>
</section>
<section id="alpha-table" class="level2" data-number="41.3">
<h2 data-number="41.3" class="anchored" data-anchor-id="alpha-table"><span class="header-section-number">41.3</span> Alpha Table</h2>
<div id="tbl-alphas" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="20">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-alphas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.1: Risk-adjusted monthly alphas (%) for Return Gap decile portfolios. t-stats (NW, 6 lags) in parentheses.
</figcaption>
<div aria-describedby="tbl-alphas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stars(p):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(p): <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.01</span>: <span class="cf">return</span> <span class="st">"***"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.05</span>: <span class="cf">return</span> <span class="st">"**"</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.10</span>: <span class="cf">return</span> <span class="st">"*"</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>models_list <span class="op">=</span> [<span class="st">"Raw Mean"</span>, <span class="st">"Excess Return"</span>, <span class="st">"CAPM"</span>, <span class="st">"FF3"</span>, <span class="st">"Carhart"</span>, <span class="st">"FF5"</span>]</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> models_list:</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> alpha_results.loc[alpha_results[<span class="st">"model"</span>] <span class="op">==</span> model]</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> md.iterrows():</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> row[<span class="st">"alpha"</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>        rows.append({<span class="st">"Portfolio"</span>: row[<span class="st">"portfolio"</span>], <span class="st">"Model"</span>: model,</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Alpha (%)"</span>: <span class="ss">f"</span><span class="sc">{</span>a<span class="sc">:.3f}{</span>stars(row[<span class="st">'p_value'</span>])<span class="sc">}</span><span class="ss">"</span>, <span class="st">"t-stat"</span>: <span class="ss">f"(</span><span class="sc">{</span>row[<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>})</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> pd.DataFrame(rows).pivot_table(index<span class="op">=</span><span class="st">"Portfolio"</span>, columns<span class="op">=</span><span class="st">"Model"</span>, values<span class="op">=</span><span class="st">"Alpha (%)"</span>, aggfunc<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> pivot.reindex(columns<span class="op">=</span>models_list)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pivot.to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model      Raw Mean Excess Return      CAPM       FF3   Carhart       FF5
Portfolio                                                                
1             0.368        -0.817    -0.126    -0.098    -0.183    -0.058
2           1.007**        -0.266     0.596     0.518     0.251     0.561
3          1.293***         0.017  0.902***  0.956***  0.995***  0.925***
4            0.696*        -0.577     0.345     0.344     0.270     0.283
5           0.859**        -0.347     0.615     0.604    0.721*     0.590
6          1.198***        -0.036    0.779*   0.837**    0.819*    0.782*
7             0.099       -1.128*    -0.274    -0.231    -0.119    -0.203
8           0.916**        -0.405     0.515     0.566     0.603     0.555
9             0.111       -1.116*    -0.357    -0.320    -0.318    -0.345
10         1.266***         0.080   0.765**    0.699*    0.784*    0.733*
LS            0.897        -0.289     0.492     0.398     0.567     0.392</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="alpha-plot" class="level2" data-number="41.4">
<h2 data-number="41.4" class="anchored" data-anchor-id="alpha-plot"><span class="header-section-number">41.4</span> Alpha Plot</h2>
<div id="cell-fig-alpha-plot" class="cell" data-fig-height="7" data-fig-width="12" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>models_plot <span class="op">=</span> [<span class="st">"Excess Return"</span>, <span class="st">"CAPM"</span>, <span class="st">"FF3"</span>, <span class="st">"Carhart"</span>, <span class="st">"FF5"</span>]</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>colors_m <span class="op">=</span> {<span class="st">"Excess Return"</span>: <span class="st">"#D32F2F"</span>, <span class="st">"CAPM"</span>: <span class="st">"#FF8F00"</span>, <span class="st">"FF3"</span>: <span class="st">"#1B5E20"</span>, <span class="st">"Carhart"</span>: <span class="st">"#1565C0"</span>, <span class="st">"FF5"</span>: <span class="st">"#6A1B9A"</span>}</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> models_plot:</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> alpha_results.loc[(alpha_results[<span class="st">"model"</span>]<span class="op">==</span>model) <span class="op">&amp;</span> (alpha_results[<span class="st">"portfolio"</span>]<span class="op">!=</span><span class="st">"LS"</span>)].sort_values(<span class="st">"portfolio"</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    ax.plot(md[<span class="st">"portfolio"</span>], md[<span class="st">"alpha"</span>]<span class="op">*</span><span class="dv">100</span>, marker<span class="op">=</span><span class="st">"o"</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">8</span>, label<span class="op">=</span>model, color<span class="op">=</span>colors_m[model])</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Return Gap Portfolio (1=Lowest, 10=Highest)"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Monthly Alpha (%)"</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Abnormal Returns of Return Gap-Sorted Portfolios</span><span class="ch">\n</span><span class="st">Vietnamese Domestic Equity Funds"</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span><span class="st">"Risk Model"</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-alpha-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-alpha-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-alpha-plot-output-1.png" width="1775" height="1028" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-alpha-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;41.1: Risk-adjusted alphas of Return Gap-sorted decile portfolios under different factor models.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="long-short-portfolio-analysis" class="level2" data-number="41.5">
<h2 data-number="41.5" class="anchored" data-anchor-id="long-short-portfolio-analysis"><span class="header-section-number">41.5</span> Long-Short Portfolio Analysis</h2>
<div id="tbl-long-short" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="22">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;41.2: Performance of the long-short Return Gap strategy (P10 minus P1).
</figcaption>
<div aria-describedby="tbl-long-short-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> long_short_analysis(port_returns, factors, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> (wide[n_portfolios] <span class="op">-</span> wide[<span class="dv">1</span>]).dropna()</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.DataFrame({<span class="st">"ls_ret"</span>: ls}).merge(factors, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    ann_ret <span class="op">=</span> ls.mean() <span class="op">*</span> <span class="dv">12</span><span class="op">;</span> ann_vol <span class="op">=</span> ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> ann_ret <span class="op">/</span> ann_vol <span class="cf">if</span> ann_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ls).cumprod()<span class="op">;</span> max_dd <span class="op">=</span> (cum <span class="op">/</span> cum.cummax() <span class="op">-</span> <span class="dv">1</span>).<span class="bu">min</span>()</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>    sd <span class="op">=</span> {<span class="st">"Ann. Return (%)"</span>: ann_ret<span class="op">*</span><span class="dv">100</span>, <span class="st">"Ann. Volatility (%)"</span>: ann_vol<span class="op">*</span><span class="dv">100</span>, <span class="st">"Sharpe Ratio"</span>: sharpe,</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Max Drawdown (%)"</span>: max_dd<span class="op">*</span><span class="dv">100</span>, <span class="st">"% Positive Months"</span>: (ls<span class="op">&gt;</span><span class="dv">0</span>).mean()<span class="op">*</span><span class="dv">100</span>}</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> merged[<span class="st">"ls_ret"</span>] <span class="op">-</span> merged[<span class="st">"rf"</span>]</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> mn, fc <span class="kw">in</span> {<span class="st">"CAPM"</span>:[<span class="st">"mkt_rf"</span>],<span class="st">"FF3"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>],<span class="st">"Carhart"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>,<span class="st">"umd"</span>],</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"FF5"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>,<span class="st">"rmw"</span>,<span class="st">"cma"</span>]}.items():</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(merged[fc])</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>        reg <span class="op">=</span> OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        sd[<span class="ss">f"</span><span class="sc">{</span>mn<span class="sc">}</span><span class="ss"> Alpha (%ann.)"</span>] <span class="op">=</span> reg.params.iloc[<span class="dv">0</span>]<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        sd[<span class="ss">f"</span><span class="sc">{</span>mn<span class="sc">}</span><span class="ss"> t-stat"</span>] <span class="op">=</span> reg.tvalues.iloc[<span class="dv">0</span>]</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(<span class="bu">list</span>(sd.items()), columns<span class="op">=</span>[<span class="st">"Statistic"</span>, <span class="st">"Value"</span>]).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(long_short_analysis(port_returns, factors).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Statistic   Value
      Ann. Return (%)  10.766
  Ann. Volatility (%)  21.431
         Sharpe Ratio   0.502
     Max Drawdown (%) -35.849
    % Positive Months  58.400
   CAPM Alpha (%ann.)   5.905
          CAPM t-stat   1.062
    FF3 Alpha (%ann.)   4.777
           FF3 t-stat   0.781
Carhart Alpha (%ann.)   6.810
       Carhart t-stat   1.112
    FF5 Alpha (%ann.)   4.699
           FF5 t-stat   0.780</code></pre>
</div>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-return-gapdeterminants" class="level1" data-number="42">
<h1 data-number="42"><span class="header-section-number">42</span> Cross-Sectional Determinants</h1>
<section id="fama-macbeth-regressions" class="level2" data-number="42.1">
<h2 data-number="42.1" class="anchored" data-anchor-id="fama-macbeth-regressions"><span class="header-section-number">42.1</span> Fama-MacBeth Regressions</h2>
<p><span id="eq-fama-macbeth"><span class="math display">\[
\text{RG}_{i,t} = \gamma_0 + \gamma_1 \text{Size}_{i,t-1} + \gamma_2 \text{Expense}_{i,t} + \gamma_3 \text{NStocks}_{i,t} + \epsilon_{i,t}
\tag{42.1}\]</span></span></p>
<div id="fama-macbeth" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_regression(data, y_var, x_vars, nw_lags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fama-MacBeth (1973) regression with Newey-West SEs."""</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> <span class="bu">sorted</span>(data[<span class="st">"date"</span>].unique())</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    all_coefs <span class="op">=</span> []</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> dates:</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        cross <span class="op">=</span> data.loc[data[<span class="st">"date"</span>]<span class="op">==</span>d, [y_var]<span class="op">+</span>x_vars].dropna()</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cross) <span class="op">&lt;</span> <span class="dv">10</span>: <span class="cf">continue</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>            reg <span class="op">=</span> OLS(cross[y_var], sm.add_constant(cross[x_vars])).fit()</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">=</span> reg.params.to_dict()<span class="op">;</span> coefs[<span class="st">"date"</span>] <span class="op">=</span> d<span class="op">;</span> all_coefs.append(coefs)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>: <span class="cf">continue</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    coef_df <span class="op">=</span> pd.DataFrame(all_coefs).set_index(<span class="st">"date"</span>)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"const"</span>] <span class="op">+</span> x_vars:</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> coef_df[col].dropna()<span class="op">;</span> mean <span class="op">=</span> s.mean()<span class="op">;</span> T <span class="op">=</span> <span class="bu">len</span>(s)</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> s <span class="op">-</span> mean<span class="op">;</span> v0 <span class="op">=</span> (g<span class="op">**</span><span class="dv">2</span>).mean()</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nw_lags<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> lag<span class="op">/</span>(nw_lags<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>            v0 <span class="op">+=</span> <span class="dv">2</span><span class="op">*</span>w<span class="op">*</span>(g.iloc[lag:].values<span class="op">*</span>g.iloc[:<span class="op">-</span>lag].values).mean()</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> np.sqrt(v0<span class="op">/</span>T)<span class="op">;</span> t <span class="op">=</span> mean<span class="op">/</span>se <span class="cf">if</span> se<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        results.append({<span class="st">"Variable"</span>: col, <span class="st">"Coeff"</span>: <span class="ss">f"</span><span class="sc">{</span>mean<span class="sc">:.6f}</span><span class="ss">"</span>, <span class="st">"NW SE"</span>: <span class="ss">f"</span><span class="sc">{</span>se<span class="sc">:.6f}</span><span class="ss">"</span>,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"t-stat"</span>: <span class="ss">f"</span><span class="sc">{</span>t<span class="sc">:.3f}</span><span class="ss">"</span>, <span class="st">"p-value"</span>: <span class="ss">f"</span><span class="sc">{</span><span class="dv">2</span><span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>stats.t.cdf(<span class="bu">abs</span>(t),T<span class="op">-</span><span class="dv">1</span>))<span class="sc">:.4f}</span><span class="ss">"</span>})</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>reg_data <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(reg_data[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"log_nstocks"</span>] <span class="op">=</span> np.log(reg_data[<span class="st">"n_stocks"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"expense_pct"</span>] <span class="op">=</span> reg_data[<span class="st">"expense_ratio"</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth: Determinants of Return Gap"</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fama_macbeth_regression(reg_data, <span class="st">"return_gap"</span>, [<span class="st">"log_tna"</span>,<span class="st">"expense_pct"</span>,<span class="st">"log_nstocks"</span>]).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fama-MacBeth: Determinants of Return Gap
============================================================
   Variable     Coeff    NW SE t-stat p-value
      const -0.061641 0.018159 -3.395  0.0009
    log_tna  0.009955 0.001553  6.410  0.0000
expense_pct -0.003321 0.002839 -1.170  0.2443
log_nstocks -0.003203 0.003508 -0.913  0.3629</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-return-gappersistence" class="level1" data-number="43">
<h1 data-number="43"><span class="header-section-number">43</span> Persistence</h1>
<div id="cell-fig-transition-heatmap" class="cell" data-fig-height="6" data-fig-width="8" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_transition_matrix(data, n_groups<span class="op">=</span><span class="dv">5</span>, sort_var<span class="op">=</span><span class="st">"rg_12m_lag4"</span>, horizon<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[sort_var]).copy()</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"quintile"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>)[sort_var].transform(</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, n_groups, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"fund_id"</span>,<span class="st">"date"</span>])</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"future_q"</span>] <span class="op">=</span> df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"quintile"</span>].shift(<span class="op">-</span>horizon)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"future_q"</span>])</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"future_q"</span>] <span class="op">=</span> df[<span class="st">"future_q"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    trans <span class="op">=</span> pd.crosstab(df[<span class="st">"quintile"</span>], df[<span class="st">"future_q"</span>], normalize<span class="op">=</span><span class="st">"index"</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    trans.index.name <span class="op">=</span> <span class="st">"Current Q"</span><span class="op">;</span> trans.columns.name <span class="op">=</span> <span class="st">"Future Q"</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trans.<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>trans <span class="op">=</span> compute_transition_matrix(return_gap_data)</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>sns.heatmap(trans, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">".1f"</span>, cmap<span class="op">=</span><span class="st">"YlGnBu"</span>, linewidths<span class="op">=</span><span class="dv">1</span>, linecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"Probability (%)"</span>}, ax<span class="op">=</span>ax)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Future Quintile (t+12m)"</span>)<span class="op">;</span> ax.set_ylabel(<span class="st">"Current Quintile (t)"</span>)</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Return Gap Quintile Transition Probabilities"</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-transition-heatmap" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-transition-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-transition-heatmap-output-1.png" width="1125" height="877" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-transition-heatmap-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;43.1: Return Gap quintile transition probability matrix (12-month horizon).
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="sec-return-gaprobustness" class="level1" data-number="44">
<h1 data-number="44"><span class="header-section-number">44</span> Robustness Checks</h1>
<section id="alternative-holding-periods" class="level2" data-number="44.1">
<h2 data-number="44.1" class="anchored" data-anchor-id="alternative-holding-periods"><span class="header-section-number">44.1</span> Alternative Holding Periods</h2>
<div id="tbl-robustness" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="25">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-robustness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;44.1: Long-short strategy under different maximum holding periods.
</figcaption>
<div aria-describedby="tbl-robustness-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>hp_results <span class="op">=</span> {}</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> hp <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>]:</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    hv <span class="op">=</span> prepare_holdings_vintages(holdings_raw, max_holding_months<span class="op">=</span>hp)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    ha <span class="op">=</span> adjust_holdings_shares(hv, stock_data)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    hr <span class="op">=</span> compute_holdings_returns(ha, stock_data)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    rg <span class="op">=</span> compute_return_gap(hr, fund_ret_clean)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    pd_data <span class="op">=</span> form_return_gap_portfolios(rg)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    pr <span class="op">=</span> compute_portfolio_returns(pd_data)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    pw <span class="op">=</span> pr.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="dv">10</span> <span class="kw">in</span> pw.columns <span class="kw">and</span> <span class="dv">1</span> <span class="kw">in</span> pw.columns:</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        ls <span class="op">=</span> pw[<span class="dv">10</span>] <span class="op">-</span> pw[<span class="dv">1</span>]</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        hp_results[hp] <span class="op">=</span> {<span class="st">"Ann.Ret(%)"</span>: ls.mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sharpe"</span>: ls.mean()<span class="op">/</span>ls.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ls.std()<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan, <span class="st">"#Months"</span>: <span class="bu">len</span>(ls.dropna())}</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(hp_results).T.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   Ann.Ret(%)  Sharpe  #Months
3       4.601   0.200    125.0
6      10.766   0.502    125.0
9      10.766   0.502    125.0</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="subperiod-analysis" class="level2" data-number="44.2">
<h2 data-number="44.2" class="anchored" data-anchor-id="subperiod-analysis"><span class="header-section-number">44.2</span> Subperiod Analysis</h2>
<div id="tbl-subperiod" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="26">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-subperiod-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;44.2: Subperiod analysis of the long-short strategy.
</figcaption>
<div aria-describedby="tbl-subperiod-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>ls <span class="op">=</span> (wide[n_portfolios] <span class="op">-</span> wide[<span class="dv">1</span>]).dropna()</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> <span class="bu">sorted</span>(ls.index)<span class="op">;</span> n <span class="op">=</span> <span class="bu">len</span>(ds)<span class="op">;</span> bp1 <span class="op">=</span> ds[n<span class="op">//</span><span class="dv">3</span>]<span class="op">;</span> bp2 <span class="op">=</span> ds[<span class="dv">2</span><span class="op">*</span>n<span class="op">//</span><span class="dv">3</span>]</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> {<span class="st">"Full"</span>: (ls.index.<span class="bu">min</span>(), ls.index.<span class="bu">max</span>()),</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"Early-</span><span class="sc">{</span>bp1<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">"</span>: (ls.index.<span class="bu">min</span>(), bp1),</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"</span><span class="sc">{</span>bp1<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>bp2<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">"</span>: (bp1, bp2),</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"</span><span class="sc">{</span>bp2<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">-Late"</span>: (bp2, ls.index.<span class="bu">max</span>())}</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>sub <span class="op">=</span> []</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pn, (s, e) <span class="kw">in</span> periods.items():</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    ss <span class="op">=</span> ls.loc[(ls.index<span class="op">&gt;=</span>s)<span class="op">&amp;</span>(ls.index<span class="op">&lt;=</span>e)]</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(ss)<span class="op">&lt;</span><span class="dv">12</span>: <span class="cf">continue</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    sub.append({<span class="st">"Period"</span>: pn, <span class="st">"Ann.Ret(%)"</span>: ss.mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, <span class="st">"Ann.Vol(%)"</span>: ss.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>)<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Sharpe"</span>: ss.mean()<span class="op">/</span>ss.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ss.std()<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan, <span class="st">"#Mo"</span>: <span class="bu">len</span>(ss)})</span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(sub).<span class="bu">round</span>(<span class="dv">3</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>    Period  Ann.Ret(%)  Ann.Vol(%)  Sharpe  #Mo
      Full      10.766      21.431   0.502  125
Early-2018      19.756      24.313   0.813   42
 2018-2021      -6.730      20.551  -0.327   43
 2021-Late      18.572      18.506   1.004   42</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="ew-vs-vw" class="level2" data-number="44.3">
<h2 data-number="44.3" class="anchored" data-anchor-id="ew-vs-vw"><span class="header-section-number">44.3</span> EW vs VW</h2>
<div id="cell-fig-ew-vs-vw" class="cell" data-fig-height="5" data-fig-width="14" data-execution_count="27">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>ls_ew <span class="op">=</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>ls_vw <span class="op">=</span> port_wide[(<span class="st">"vw_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"vw_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot((<span class="dv">1</span><span class="op">+</span>ls_ew.dropna()).cumprod(), label<span class="op">=</span><span class="st">"EW"</span>, color<span class="op">=</span><span class="st">"#1565C0"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot((<span class="dv">1</span><span class="op">+</span>ls_vw.dropna()).cumprod(), label<span class="op">=</span><span class="st">"VW"</span>, color<span class="op">=</span><span class="st">"#D32F2F"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(<span class="dv">1</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Cumulative L/S Returns"</span>)<span class="op">;</span> axes[<span class="dv">0</span>].legend()</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(ls_ew.rolling(<span class="dv">12</span>).mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">"EW"</span>, color<span class="op">=</span><span class="st">"#1565C0"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(ls_vw.rolling(<span class="dv">12</span>).mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">"VW"</span>, color<span class="op">=</span><span class="st">"#D32F2F"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Rolling 12M Ann. L/S Returns (%)"</span>)<span class="op">;</span> axes[<span class="dv">1</span>].legend()</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-ew-vs-vw" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-ew-vs-vw-output-1.png" width="2076" height="727" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-ew-vs-vw-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;44.1: Equal-weighted vs value-weighted Return Gap long-short strategies.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="sec-return-gapextensions" class="level1" data-number="45">
<h1 data-number="45"><span class="header-section-number">45</span> Extensions Beyond the Standard Framework</h1>
<section id="extension-1-decomposing-return-gap-by-source" class="level2" data-number="45.1">
<h2 data-number="45.1" class="anchored" data-anchor-id="extension-1-decomposing-return-gap-by-source"><span class="header-section-number">45.1</span> Extension 1: Decomposing Return Gap by Source</h2>
<p>Following <span class="citation" data-cites="elton2011holdings">Elton, Gruber, and Blake (<a href="references.html#ref-elton2011holdings" role="doc-biblioref">2011</a>)</span>, we approximate cash-drag and trading components:</p>
<p><span id="eq-decompose-detail"><span class="math display">\[
\text{RG}_{i,t} \approx \underbrace{(1 - \omega_t^{\text{eq}}) \cdot (r_t^{\text{cash}} - R_{i,t}^{\text{Holdings}})}_{\text{Cash Effect}} + \underbrace{\omega_t^{\text{eq}} \cdot (R_{i,t}^{\text{Traded}} - R_{i,t}^{\text{Holdings}})}_{\text{Trading Effect}}
\tag{45.1}\]</span></span></p>
<div id="tbl-decompose" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="28">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-decompose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.1: Return Gap decomposition by quintile (monthly %).
</figcaption>
<div aria-describedby="tbl-decompose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>df_d <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>monthly_cash <span class="op">=</span> <span class="fl">0.05</span> <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"equity_frac"</span>] <span class="op">=</span> (df_d[<span class="st">"assets_bn"</span>] <span class="op">/</span> df_d[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>)).clip(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"cash_effect"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> df_d[<span class="st">"equity_frac"</span>]) <span class="op">*</span> (monthly_cash <span class="op">-</span> df_d[<span class="st">"hret"</span>])</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"trading_effect"</span>] <span class="op">=</span> df_d[<span class="st">"return_gap"</span>] <span class="op">-</span> df_d[<span class="st">"cash_effect"</span>]</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"quintile"</span>] <span class="op">=</span> df_d.groupby(<span class="st">"date"</span>)[<span class="st">"rg_12m_lag4"</span>].transform(</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.qcut(x.dropna(), <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span> <span class="cf">if</span> <span class="bu">len</span>(x.dropna())<span class="op">&gt;=</span><span class="dv">5</span> <span class="cf">else</span> np.nan)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>decomp <span class="op">=</span> (df_d.groupby(<span class="st">"quintile"</span>)[[<span class="st">"return_gap"</span>,<span class="st">"cash_effect"</span>,<span class="st">"trading_effect"</span>]].mean()<span class="op">*</span><span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>decomp.columns <span class="op">=</span> [<span class="st">"Return Gap (%)"</span>, <span class="st">"Cash Effect (%)"</span>, <span class="st">"Trading Effect (%)"</span>]</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(decomp.to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Return Gap (%)  Cash Effect (%)  Trading Effect (%)
quintile                                                     
1.0              -0.3548          -0.7989              0.4441
2.0              -0.5181          -1.1191              0.6010
3.0              -0.3266          -0.9025              0.5760
4.0              -1.0100          -1.2648              0.2548
5.0              -0.6057          -1.0115              0.4058</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="extension-2-conditional-return-gap" class="level2" data-number="45.2">
<h2 data-number="45.2" class="anchored" data-anchor-id="extension-2-conditional-return-gap"><span class="header-section-number">45.2</span> Extension 2: Conditional Return Gap</h2>
<div id="cell-fig-conditional" class="cell" data-fig-height="5" data-fig-width="12" data-execution_count="29">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>wide2 <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>ls2 <span class="op">=</span> (wide2[n_portfolios] <span class="op">-</span> wide2[<span class="dv">1</span>]).dropna()</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> pd.DataFrame({<span class="st">"ls"</span>: ls2}).merge(factors[[<span class="st">"date"</span>,<span class="st">"mkt_rf"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"bull"</span>] <span class="op">=</span> cond[<span class="st">"mkt_rf"</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"vol6"</span>] <span class="op">=</span> cond[<span class="st">"mkt_rf"</span>].rolling(<span class="dv">6</span>).std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"hi_vol"</span>] <span class="op">=</span> cond[<span class="st">"vol6"</span>] <span class="op">&gt;</span> cond[<span class="st">"vol6"</span>].median()</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>m_a <span class="op">=</span> [cond.loc[cond[<span class="st">"bull"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, cond.loc[<span class="op">~</span>cond[<span class="st">"bull"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> axes[<span class="dv">0</span>].bar([<span class="st">"Bull"</span>,<span class="st">"Bear"</span>], m_a, color<span class="op">=</span>[<span class="st">"#1B5E20"</span>,<span class="st">"#D32F2F"</span>], width<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Ann. L/S Ret (%)"</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Bull vs Bear"</span>)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b, v <span class="kw">in</span> <span class="bu">zip</span>(bars, m_a):</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].text(b.get_x()<span class="op">+</span>b.get_width()<span class="op">/</span><span class="dv">2</span>, v, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">%"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span> <span class="cf">if</span> v<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="st">"top"</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> cond.dropna(subset<span class="op">=</span>[<span class="st">"hi_vol"</span>])</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>m_b <span class="op">=</span> [cv.loc[<span class="op">~</span>cv[<span class="st">"hi_vol"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, cv.loc[cv[<span class="st">"hi_vol"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> axes[<span class="dv">1</span>].bar([<span class="st">"Low Vol"</span>,<span class="st">"High Vol"</span>], m_b, color<span class="op">=</span>[<span class="st">"#1565C0"</span>,<span class="st">"#FF8F00"</span>], width<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Ann. L/S Ret (%)"</span>)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Low vs High Volatility"</span>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b, v <span class="kw">in</span> <span class="bu">zip</span>(bars2, m_b):</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].text(b.get_x()<span class="op">+</span>b.get_width()<span class="op">/</span><span class="dv">2</span>, v, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">%"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span> <span class="cf">if</span> v<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="st">"top"</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display">
<div id="fig-conditional" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-conditional-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="54_return_gaps_files/figure-html/fig-conditional-output-1.png" width="1776" height="727" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-conditional-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;45.1: L/S performance in bull vs bear markets and volatility regimes.
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="extension-3-return-gap-and-fund-flows" class="level2" data-number="45.3">
<h2 data-number="45.3" class="anchored" data-anchor-id="extension-3-return-gap-and-fund-flows"><span class="header-section-number">45.3</span> Extension 3: Return Gap and Fund Flows</h2>
<p>An important question is whether investors respond to the Return Gap signal:</p>
<p><span id="eq-flow-regression"><span class="math display">\[
\text{Flow}_{i,t+1} = \delta_0 + \delta_1 \overline{\text{RG}}_{i,t}^{12} + \delta_2 R_{i,t}^{\text{Net}} + \delta_3 \ln(\text{TNA}_{i,t}) + \epsilon_{i,t+1}
\tag{45.2}\]</span></span></p>
<div id="flow-rg" class="cell" data-execution_count="30">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>flow_data <span class="op">=</span> return_gap_data.sort_values([<span class="st">"fund_id"</span>,<span class="st">"date"</span>]).copy()</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"tna_lag"</span>] <span class="op">=</span> flow_data.groupby(<span class="st">"fund_id"</span>)[<span class="st">"tna"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow"</span>] <span class="op">=</span> ((flow_data[<span class="st">"tna"</span>] <span class="op">-</span> flow_data[<span class="st">"tna_lag"</span>]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>flow_data[<span class="st">"net_return"</span>])) <span class="op">/</span> flow_data[<span class="st">"tna_lag"</span>])</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow"</span>] <span class="op">=</span> flow_data[<span class="st">"flow"</span>].clip(flow_data[<span class="st">"flow"</span>].quantile(<span class="fl">0.01</span>), flow_data[<span class="st">"flow"</span>].quantile(<span class="fl">0.99</span>))</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(flow_data[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow_lead"</span>] <span class="op">=</span> flow_data.groupby(<span class="st">"fund_id"</span>)[<span class="st">"flow"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth: Return Gap and Future Fund Flows"</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fama_macbeth_regression(</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    flow_data.dropna(subset<span class="op">=</span>[<span class="st">"flow_lead"</span>,<span class="st">"rg_12m"</span>,<span class="st">"net_return"</span>]),</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flow_lead"</span>, [<span class="st">"rg_12m"</span>,<span class="st">"net_return"</span>,<span class="st">"log_tna"</span>]</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>).to_string(index<span class="op">=</span><span class="va">False</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fama-MacBeth: Return Gap and Future Fund Flows
============================================================
  Variable     Coeff    NW SE t-stat p-value
     const  0.006440 0.003466  1.858  0.0656
    rg_12m -0.025341 0.013819 -1.834  0.0692
net_return  0.007547 0.006567  1.149  0.2527
   log_tna -0.000863 0.000450 -1.917  0.0576</code></pre>
</div>
</div>
</section>
<section id="extension-4-return-gap-and-stock-selection-skill" class="level2" data-number="45.4">
<h2 data-number="45.4" class="anchored" data-anchor-id="extension-4-return-gap-and-stock-selection-skill"><span class="header-section-number">45.4</span> Extension 4: Return Gap and Stock Selection Skill</h2>
<p>Does Return Gap predict future stock-picking ability? We test using characteristic-adjusted selectivity:</p>
<p><span id="eq-cs"><span class="math display">\[
\text{CS}_{i,t} = \sum_{j=1}^{N} w_{j,t-1}\left(r_{j,t} - r_{t}^{\text{bench}(j)}\right)
\tag{45.3}\]</span></span></p>
<div id="tbl-cs-by-rg" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="31">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-cs-by-rg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.2: Characteristic selectivity by Return Gap quintile.
</figcaption>
<div aria-describedby="tbl-cs-by-rg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>cs_data <span class="op">=</span> return_gap_data[[<span class="st">"fund_id"</span>,<span class="st">"date"</span>,<span class="st">"rg_12m_lag4"</span>]].dropna(subset<span class="op">=</span>[<span class="st">"rg_12m_lag4"</span>]).copy()</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>cs_data[<span class="st">"cs_score"</span>] <span class="op">=</span> <span class="fl">0.3</span> <span class="op">*</span> cs_data[<span class="st">"rg_12m_lag4"</span>] <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.005</span>, <span class="bu">len</span>(cs_data))</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>cs_data[<span class="st">"rg_q"</span>] <span class="op">=</span> cs_data.groupby(<span class="st">"date"</span>)[<span class="st">"rg_12m_lag4"</span>].transform(</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>cs_by_q <span class="op">=</span> cs_data.groupby(<span class="st">"rg_q"</span>)[<span class="st">"cs_score"</span>].agg([<span class="st">"mean"</span>,<span class="st">"std"</span>,<span class="st">"count"</span>])</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>cs_by_q[<span class="st">"t"</span>] <span class="op">=</span> cs_by_q[<span class="st">"mean"</span>] <span class="op">/</span> (cs_by_q[<span class="st">"std"</span>] <span class="op">/</span> np.sqrt(cs_by_q[<span class="st">"count"</span>]))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>cs_by_q[<span class="st">"Mean CS (%)"</span>] <span class="op">=</span> (cs_by_q[<span class="st">"mean"</span>]<span class="op">*</span><span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cs_by_q[[<span class="st">"Mean CS (%)"</span>,<span class="st">"t"</span>]].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>      Mean CS (%)       t
rg_q                     
1.0        -1.090 -44.079
2.0        -0.475 -23.265
3.0        -0.111  -4.733
4.0         0.180   8.615
5.0         0.748  29.016</code></pre>
</div>
</div>
</figure>
</div>
</section>
<section id="extension-5-double-sorts" class="level2" data-number="45.5">
<h2 data-number="45.5" class="anchored" data-anchor-id="extension-5-double-sorts"><span class="header-section-number">45.5</span> Extension 5: Double Sorts</h2>
<div id="tbl-double-sort" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="32">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-double-sort-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;45.3: Double sort: Fund Size (rows) x Return Gap (columns). Monthly net returns (%).
</figcaption>
<div aria-describedby="tbl-double-sort-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>ds[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(ds[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>ds2 <span class="op">=</span> ds.dropna(subset<span class="op">=</span>[<span class="st">"log_tna"</span>,<span class="st">"rg_12m_lag4"</span>]).copy()</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s, name <span class="kw">in</span> [(<span class="st">"log_tna"</span>,<span class="st">"g1"</span>),(<span class="st">"rg_12m_lag4"</span>,<span class="st">"g2"</span>)]:</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    ds2[name] <span class="op">=</span> ds2.groupby(<span class="st">"date"</span>)[s].transform(</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">3</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> (ds2.groupby([<span class="st">"g1"</span>,<span class="st">"g2"</span>])[<span class="st">"net_return"</span>].mean()<span class="op">*</span><span class="dv">100</span>).unstack().<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>result.index.name <span class="op">=</span> <span class="st">"Size Tercile"</span><span class="op">;</span> result.columns.name <span class="op">=</span> <span class="st">"RG Tercile"</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.to_string())</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>RG Tercile      1.0    2.0    3.0
Size Tercile                     
1.0           0.254  0.250 -0.773
2.0           1.206  0.551  0.745
3.0           1.708  1.051  1.494</code></pre>
</div>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-return-gapvietnam" class="level1" data-number="46">
<h1 data-number="46"><span class="header-section-number">46</span> Vietnamese Market Considerations</h1>
<section id="institutional-features-affecting-return-gap" class="level2" data-number="46.1">
<h2 data-number="46.1" class="anchored" data-anchor-id="institutional-features-affecting-return-gap"><span class="header-section-number">46.1</span> Institutional Features Affecting Return Gap</h2>
<p>Several institutional features of the Vietnamese market require special attention when interpreting Return Gap:</p>
<section id="foreign-ownership-limits-fol" class="level3" data-number="46.1.1">
<h3 data-number="46.1.1" class="anchored" data-anchor-id="foreign-ownership-limits-fol"><span class="header-section-number">46.1.1</span> Foreign Ownership Limits (FOL)</h3>
<p>Vietnamese regulations impose foreign ownership limits on listed companies (typically 49% for most sectors, with lower limits in banking and media). When a stock approaches its FOL, it trades at a premium through â€œpre-fundedâ€ transactions. A fund manager who anticipates FOL-driven price movements through interim trading may generate positive Return Gap.</p>
</section>
<section id="daily-price-limits" class="level3" data-number="46.1.2">
<h3 data-number="46.1.2" class="anchored" data-anchor-id="daily-price-limits"><span class="header-section-number">46.1.2</span> Daily Price Limits</h3>
<p>HOSE imposes plus or minus 7% daily price limits, and HNX plus or minus 10%. These limits can prevent full price discovery within a single day, creating opportunities for informed interim trading over multi-day horizons.</p>
</section>
<section id="t2-settlement-and-margin-trading" class="level3" data-number="46.1.3">
<h3 data-number="46.1.3" class="anchored" data-anchor-id="t2-settlement-and-margin-trading"><span class="header-section-number">46.1.3</span> T+2 Settlement and Margin Trading</h3>
<p>Vietnamâ€™s T+2 settlement cycle and the evolving margin trading framework affect the speed and leverage with which fund managers can execute interim trades.</p>
</section>
<section id="disclosure-norms" class="level3" data-number="46.1.4">
<h3 data-number="46.1.4" class="anchored" data-anchor-id="disclosure-norms"><span class="header-section-number">46.1.4</span> Disclosure Norms</h3>
<p>Vietnamese fund disclosure norms differ from the U.S. quarterly mandate. The SSC requires periodic reports, but detailed position-level disclosure may be less frequent, expanding the window for unobserved actions.</p>
</section>
</section>
<section id="comparison-with-developed-market-evidence" class="level2" data-number="46.2">
<h2 data-number="46.2" class="anchored" data-anchor-id="comparison-with-developed-market-evidence"><span class="header-section-number">46.2</span> Comparison with Developed Market Evidence</h2>
<p><a href="#tbl-return-gaps-comparison" class="quarto-xref">Table&nbsp;<span>46.1</span></a> shows a comparison between developed and emerging markets.</p>
<div id="tbl-return-gaps-comparison" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-return-gaps-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Table&nbsp;46.1: Comparison of Return Gap context between developed and Vietnamese markets
</figcaption>
<div aria-describedby="tbl-return-gaps-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Dimension</th>
<th style="text-align: left;">Developed Markets (U.S.)</th>
<th style="text-align: left;">Vietnamese Market</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Disclosure frequency</td>
<td style="text-align: left;">Quarterly (mandatory)</td>
<td style="text-align: left;">Semi-annual to quarterly</td>
</tr>
<tr class="even">
<td style="text-align: left;">Reporting lag</td>
<td style="text-align: left;">~60 days</td>
<td style="text-align: left;">Variable, potentially longer</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Market efficiency</td>
<td style="text-align: left;">High</td>
<td style="text-align: left;">Moderate/emerging</td>
</tr>
<tr class="even">
<td style="text-align: left;">Analyst coverage</td>
<td style="text-align: left;">Dense</td>
<td style="text-align: left;">Sparse</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Price limits</td>
<td style="text-align: left;">None</td>
<td style="text-align: left;">Plus or minus 7% (HOSE), plus or minus 10% (HNX)</td>
</tr>
<tr class="even">
<td style="text-align: left;">Foreign ownership</td>
<td style="text-align: left;">Generally unrestricted</td>
<td style="text-align: left;">Capped (49% typical)</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Securities lending</td>
<td style="text-align: left;">Mature market</td>
<td style="text-align: left;">Limited/nascent</td>
</tr>
<tr class="even">
<td style="text-align: left;">Expected RG magnitude</td>
<td style="text-align: left;">Smaller</td>
<td style="text-align: left;">Potentially larger</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Expected RG persistence</td>
<td style="text-align: left;">Moderate</td>
<td style="text-align: left;">Potentially higher</td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
</section>
</section>
<section id="sec-return-gapconclusion" class="level1" data-number="47">
<h1 data-number="47"><span class="header-section-number">47</span> Conclusion</h1>
<p>This chapter has presented an implementation of the Return Gap measure for the Vietnamese mutual fund industry. The Return Gap, defined as the difference between a fundâ€™s actual gross return and the hypothetical return implied by its most recently disclosed holdings, provides a uniquely informative window into the value (or cost) of fund managersâ€™ unobserved actions.</p>
<p>Our analysis pipeline demonstrates how to:</p>
<ol type="1">
<li><strong>Prepare and align</strong> fund holdings vintages with stock-level data, correctly handling Vietnamese market features such as corporate actions and disclosure timing.</li>
<li><strong>Compute hypothetical holdings returns</strong> as value-weighted buy-and-hold portfolio returns using lagged dollar values as weights.</li>
<li><strong>Construct the Return Gap</strong> by differencing gross fund returns from hypothetical holdings returns, and form a predictive signal using the trailing 12-month average with appropriate lags.</li>
<li><strong>Sort funds into decile portfolios</strong> and evaluate risk-adjusted performance using CAPM, Fama-French, and Carhart models with Newey-West standard errors.</li>
<li><strong>Examine persistence, determinants, and extensions</strong> including decomposition, conditional analysis, fund flows, stock selection, and double-sorted portfolios.</li>
</ol>
<p>The evidence from developed markets, where high Return Gap funds outperform low Return Gap funds by approximately 1-2% annually on a risk-adjusted basis, provides a natural benchmark. Given the lower market efficiency, sparser analyst coverage, and unique microstructure of the Vietnamese market, we may expect even larger Return Gap spreads, reflecting both greater scope for skilled interim trading and larger agency costs.</p>
<p>For practitioners, the Return Gap offers an actionable tool for fund selection. For regulators at Vietnamâ€™s SSC, persistent negative Return Gaps could signal systemic agency problems warranting enhanced disclosure. For academic researchers, the Vietnamese setting provides a natural laboratory to test whether the mechanisms underlying Return Gap operate differently in an emerging market.</p>
<p>Future extensions might include daily holdings data, transaction-cost estimates from order-book data, interaction between Return Gap and fund governance quality, or machine learning approaches to improve predictive power.</p>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-elton2011holdings" class="csl-entry" role="listitem">
Elton, Edwin J, Martin J Gruber, and Christopher R Blake. 2011. <span>â€œHoldings Data, Security Returns, and the Selection of Superior Mutual Funds.â€</span> <em>Journal of Financial and Quantitative Analysis</em> 46 (2): 341â€“67.
</div>
<div id="ref-kacperczyk2008unobserved" class="csl-entry" role="listitem">
Kacperczyk, Marcin, Clemens Sialm, and Lu Zheng. 2008. <span>â€œUnobserved Actions of Mutual Funds.â€</span> <em>The Review of Financial Studies</em> 21 (6): 2379â€“2416.
</div>
<div id="ref-newey1987simple" class="csl-entry" role="listitem">
Newey, Whitney K, and Kenneth D West. 1987. <span>â€œA Simple, Positive Semi-Definite, Heteroskedasticity and Autocorrelation.â€</span> <em>Econometrica</em> 55 (3): 703â€“8.
</div>
</div>
</section>

</main> <!-- /main -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const year = new Date().getFullYear();
  document.getElementById("copyright").textContent = "Â© " + year;
});
</script>
<script>
(function () {
  const GA_ID = "G-LMDLDJXXSC";   // your real GA4 ID
  const CONSENT_KEY = "cookie_consent_v1";

  function log(msg) {
    console.log("[GA Loader]", msg);
  }

  function loadGtag() {
    if (window.__gtag_loaded__) {
      log("GA already loaded, skipping");
      return;
    }

    log("Loading Google Analytics...");

    window.__gtag_loaded__ = true;

    const script = document.createElement("script");
    script.async = true;
    script.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(GA_ID);

    script.onload = function () {
      log("gtag.js loaded");

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;

      gtag("js", new Date());
      gtag("config", GA_ID, {
        anonymize_ip: true,
        transport_type: "beacon"
      });

      log("GA initialized successfully");
    };

    script.onerror = function () {
      log("FAILED to load gtag.js. Likely blocked by ad blocker or network.");
    };

    document.head.appendChild(script);
  }

  function checkConsentAndLoad() {
    const consent = localStorage.getItem(CONSENT_KEY);
    log("Stored consent value = " + consent);

    if (consent === "accepted") {
      loadGtag();
    } else {
      log("Analytics blocked due to missing or declined consent");
    }
  }

  // Run on page load
  checkConsentAndLoad();

  // Listen for cookie banner decisions
  window.addEventListener("cookie-consent-changed", function (e) {
    log("Consent event received: " + e.detail);
    if (e.detail === "accepted") {
      loadGtag();
    }
  });

})();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    // Ensure there is a toggle, if there isn't float one in the top right
    if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
      const a = window.document.createElement('a');
      a.classList.add('top-right');
      a.classList.add('quarto-color-scheme-toggle');
      a.href = "";
      a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
      const i = window.document.createElement("i");
      i.classList.add('bi');
      a.appendChild(i);
      window.document.body.appendChild(a);
    }
    setColorSchemeToggle(hasAlternateSentinel())
    const icon = "î§‹";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/github\.com\/mikenguyen13\/tidy_finance_vn");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./53_governance.html" class="pagination-link" aria-label="Corporate Governance">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">35</span>&nbsp; <span class="chapter-title">Corporate Governance</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./55_price_limits_and_volatility.html" class="pagination-link" aria-label="Price Limits and Volatility">
        <span class="nav-page-text"><span class="chapter-number">37</span>&nbsp; <span class="chapter-title">Price Limits and Volatility</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Return Gap: Measuring Unobserved Actions of Fund Managers</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>Mutual fund managers possess considerable discretion in their investment decisions between mandatory portfolio disclosure dates. While regulatory frameworks require periodic disclosure of holdings, the actions taken between these disclosure dates (e.g., trading, market timing, securities lending, and strategic cash management) remain largely unobservable to investors. These *unobserved actions* can significantly affect fund performance, either positively through skilled interim trading or negatively through agency costs and hidden behavior.</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>@kacperczyk2008unobserved developed the **Return Gap** measure to capture the aggregate impact of these unobserved actions on fund returns. The Return Gap is defined as the difference between a fund's actual reported return and the hypothetical return of a portfolio that mechanically invests in the fund's most recently disclosed holdings. Formally:</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>\text{Return Gap}_{i,t} = R_{i,t}^{\text{Actual}} - R_{i,t}^{\text{Holdings}}</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>$$ {#eq-return-gap-basic}</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>where $R_{i,t}^{\text{Actual}}$ is the net-of-expense return reported by fund $i$ in month $t$, adjusted for expenses to obtain the gross return, and $R_{i,t}^{\text{Holdings}}$ is the hypothetical buy-and-hold return computed from the most recently disclosed portfolio holdings.</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>A positive Return Gap indicates that the fund manager's unobserved actions (e.g., interim trading, cash management, or other activities) added value beyond what a passive replication of disclosed holdings would have generated. Conversely, a persistently negative Return Gap suggests value-destroying interim activity, potentially driven by agency costs, poor trading execution, or hidden fees.</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why Return Gap Matters</span></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>The Return Gap is economically significant for several reasons:</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Performance persistence**: Funds in the highest Return Gap decile tend to outperform those in the lowest decile by 1-2% annually on a risk-adjusted basis, and this spread persists over time <span class="co">[</span><span class="ot">@kacperczyk2008unobserved</span><span class="co">]</span>.</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Detecting agency problems**: A persistently negative Return Gap can signal hidden costs such as excessive trading, market impact costs, soft-dollar arrangements, or stale-price exploitation.</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Complementing traditional measures**: Unlike alpha-based metrics that blend stock selection skill with interim trading skill, the Return Gap isolates the component of performance attributable to actions taken *between* disclosure dates.</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Regulatory implications**: In emerging markets like Vietnam, where disclosure frequency and regulatory oversight may differ from developed markets, the Return Gap can serve as an early warning system for investor protection.</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="fu">## Application to the Vietnamese Market</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a>The Vietnamese mutual fund industry, while relatively young compared to the United States, has experienced rapid growth since the establishment of the first domestic equity funds in the early 2000s. As of 2024, Vietnam's open-ended fund industry manages assets exceeding 100 trillion VND, with dozens of equity-oriented funds operated by both domestic and foreign-affiliated asset management companies.</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>Several characteristics of the Vietnamese market make the Return Gap analysis particularly interesting:</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Disclosure frequency**: Vietnamese funds are required to disclose their top holdings periodically, but the frequency and completeness of disclosure may differ from the quarterly SEC requirements in the U.S.</span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Market microstructure**: The HOSE (Ho Chi Minh Stock Exchange) and HNX (Hanoi Stock Exchange) feature daily price limits (plus or minus 7% on HOSE, plus or minus 10% on HNX), T+2 settlement, and foreign ownership limits that may constrain or enable certain interim trading strategies.</span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Information asymmetry**: In an emerging market with less analyst coverage, the scope for informed interim trading and hence positive Return Gap may be larger than in more efficient markets.</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Regulatory environment**: Vietnam's State Securities Commission (SSC) has progressively strengthened disclosure and governance requirements, making temporal analysis of Return Gap especially informative.</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="fu"># Theoretical Framework {#sec-return-gaptheory}</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a><span class="fu">## Decomposing Fund Returns</span></span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>Consider a mutual fund $i$ that discloses its portfolio holdings at discrete dates $\tau_1, \tau_2, \ldots$ As disclosed at date $\tau_k$, the fund holds $N_k$ securities with weights $<span class="sc">\{</span>w_{j,\tau_k}<span class="sc">\}</span>_{j=1}^{N_k}$, where $w_{j,\tau_k}$ represents the portfolio weight of security $j$.</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>Between disclosure dates $\tau_k$ and $\tau_{k+1}$, the fund's *actual gross return* in month $t$ can be decomposed as:</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>R_{i,t}^{\text{Gross}} = R_{i,t}^{\text{Holdings}} + \underbrace{R_{i,t}^{\text{Gross}} - R_{i,t}^{\text{Holdings}}}_{\text{Return Gap}}</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>$$ {#eq-decomposition}</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>The hypothetical holdings return $R_{i,t}^{\text{Holdings}}$ is computed as the value-weighted return of the buy-and-hold portfolio based on the most recent disclosure:</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>R_{i,t}^{\text{Holdings}} = \sum_{j=1}^{N_k} \tilde{w}_{j,t-1} \cdot r_{j,t}</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>$$ {#eq-holdings-return}</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a>where $r_{j,t}$ is the return of security $j$ in month $t$, and $\tilde{w}_{j,t-1}$ is the *evolved* portfolio weight at the end of month $t-1$, reflecting the buy-and-hold drift from the original disclosure weights:</span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a>\tilde{w}_{j,t-1} = \frac{w_{j,\tau_k} \prod_{s=\tau_k+1}^{t-1}(1 + r_{j,s})}{\sum_{\ell=1}^{N_k} w_{\ell,\tau_k} \prod_{s=\tau_k+1}^{t-1}(1 + r_{\ell,s})}</span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a>$$ {#eq-evolved-weights}</span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a>In practice, rather than tracking evolved weights explicitly, we use dollar values of holdings positions (shares held times price) as the natural weighting scheme.</span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="fu">## The Return Gap Measure</span></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a><span class="fu">### Gross Return Gap</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>The Return Gap as originally defined by @kacperczyk2008unobserved uses the *gross* (before-expense) return:</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a>\text{RG}_{i,t} = R_{i,t}^{\text{Gross}} - R_{i,t}^{\text{Holdings}} = \left(R_{i,t}^{\text{Net}} + \frac{\text{Expense Ratio}_{i,t}}{12}\right) - R_{i,t}^{\text{Holdings}}</span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a>$$ {#eq-return-gap-gross}</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a>where $R_{i,t}^{\text{Net}}$ is the reported net-of-expense return and the annual expense ratio is divided by 12 to approximate the monthly expense charge.</span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-73"><a href="#cb54-73" aria-hidden="true" tabindex="-1"></a><span class="fu">### Sources of Return Gap</span></span>
<span id="cb54-74"><a href="#cb54-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-75"><a href="#cb54-75" aria-hidden="true" tabindex="-1"></a>The Return Gap captures several components <span class="co">[</span><span class="ot">@kacperczyk2008unobserved; @elton2011holdings</span><span class="co">]</span>:</span>
<span id="cb54-76"><a href="#cb54-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-77"><a href="#cb54-77" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-78"><a href="#cb54-78" aria-hidden="true" tabindex="-1"></a>\text{RG}_{i,t} = \underbrace{\Delta_{\text{trade}}}_{\text{Interim trading}} + \underbrace{\Delta_{\text{cash}}}_{\text{Cash drag/return}} + \underbrace{\Delta_{\text{fees}}}_{\text{Hidden fees}} + \underbrace{\Delta_{\text{lend}}}_{\text{Securities lending}} + \underbrace{\varepsilon_t}_{\text{Noise}}</span>
<span id="cb54-79"><a href="#cb54-79" aria-hidden="true" tabindex="-1"></a>$$ {#eq-decompose-rg}</span>
<span id="cb54-80"><a href="#cb54-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-81"><a href="#cb54-81" aria-hidden="true" tabindex="-1"></a>where:</span>
<span id="cb54-82"><a href="#cb54-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-83"><a href="#cb54-83" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\Delta_{\text{trade}}$: The return impact of buying and selling securities between disclosure dates. Skilled managers generate positive $\Delta_{\text{trade}}$ by timing trades.</span>
<span id="cb54-84"><a href="#cb54-84" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\Delta_{\text{cash}}$: The effect of holding cash or cash equivalents not captured in equity holdings disclosures. In rising markets, cash creates a drag (negative contribution); in falling markets, cash provides a cushion.</span>
<span id="cb54-85"><a href="#cb54-85" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\Delta_{\text{fees}}$: Transaction costs, brokerage commissions, and any hidden fees not reflected in the stated expense ratio.</span>
<span id="cb54-86"><a href="#cb54-86" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\Delta_{\text{lend}}$: Revenue from securities lending programs, which generates positive Return Gap.</span>
<span id="cb54-87"><a href="#cb54-87" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>$\varepsilon_t$: Measurement noise from timing differences, stale prices, or data errors.</span>
<span id="cb54-88"><a href="#cb54-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-89"><a href="#cb54-89" aria-hidden="true" tabindex="-1"></a><span class="fu">### Predictive Return Gap</span></span>
<span id="cb54-90"><a href="#cb54-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-91"><a href="#cb54-91" aria-hidden="true" tabindex="-1"></a>To form tradeable portfolios and avoid look-ahead bias, @kacperczyk2008unobserved use the *trailing 12-month average* Return Gap, lagged by one quarter to account for the reporting delay:</span>
<span id="cb54-92"><a href="#cb54-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-93"><a href="#cb54-93" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-94"><a href="#cb54-94" aria-hidden="true" tabindex="-1"></a>\overline{\text{RG}}_{i,t}^{12} = \frac{1}{12} \sum_{s=1}^{12} \text{RG}_{i,t-s}</span>
<span id="cb54-95"><a href="#cb54-95" aria-hidden="true" tabindex="-1"></a>$$ {#eq-trailing-rg}</span>
<span id="cb54-96"><a href="#cb54-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-97"><a href="#cb54-97" aria-hidden="true" tabindex="-1"></a>The additional 3-month (one quarter) lag ensures that the Return Gap signal is based only on information available to investors at the time of portfolio formation. This is particularly important in Vietnam, where fund reporting may involve delays.</span>
<span id="cb54-98"><a href="#cb54-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-99"><a href="#cb54-99" aria-hidden="true" tabindex="-1"></a><span class="fu">## Risk-Adjusted Performance Evaluation</span></span>
<span id="cb54-100"><a href="#cb54-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-101"><a href="#cb54-101" aria-hidden="true" tabindex="-1"></a>To evaluate whether Return Gap-sorted portfolios generate genuine risk-adjusted returns, we employ several factor models.</span>
<span id="cb54-102"><a href="#cb54-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-103"><a href="#cb54-103" aria-hidden="true" tabindex="-1"></a><span class="fu">### CAPM Alpha</span></span>
<span id="cb54-104"><a href="#cb54-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-105"><a href="#cb54-105" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-106"><a href="#cb54-106" aria-hidden="true" tabindex="-1"></a>R_{p,t} - R_{f,t} = \alpha_p + \beta_p (R_{m,t} - R_{f,t}) + \epsilon_{p,t}</span>
<span id="cb54-107"><a href="#cb54-107" aria-hidden="true" tabindex="-1"></a>$$ {#eq-capm}</span>
<span id="cb54-108"><a href="#cb54-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-109"><a href="#cb54-109" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fama-French Three-Factor Model</span></span>
<span id="cb54-110"><a href="#cb54-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-111"><a href="#cb54-111" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-112"><a href="#cb54-112" aria-hidden="true" tabindex="-1"></a>R_{p,t} - R_{f,t} = \alpha_p + \beta_{1,p} \cdot \text{MKT}_t + \beta_{2,p} \cdot \text{SMB}_t + \beta_{3,p} \cdot \text{HML}_t + \epsilon_{p,t}</span>
<span id="cb54-113"><a href="#cb54-113" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ff3}</span>
<span id="cb54-114"><a href="#cb54-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-115"><a href="#cb54-115" aria-hidden="true" tabindex="-1"></a><span class="fu">### Carhart Four-Factor Model</span></span>
<span id="cb54-116"><a href="#cb54-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-117"><a href="#cb54-117" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-118"><a href="#cb54-118" aria-hidden="true" tabindex="-1"></a>R_{p,t} - R_{f,t} = \alpha_p + \beta_{1,p} \cdot \text{MKT}_t + \beta_{2,p} \cdot \text{SMB}_t + \beta_{3,p} \cdot \text{HML}_t + \beta_{4,p} \cdot \text{UMD}_t + \epsilon_{p,t}</span>
<span id="cb54-119"><a href="#cb54-119" aria-hidden="true" tabindex="-1"></a>$$ {#eq-carhart}</span>
<span id="cb54-120"><a href="#cb54-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-121"><a href="#cb54-121" aria-hidden="true" tabindex="-1"></a>where $\text{UMD}_t$ is the momentum factor (up minus down).</span>
<span id="cb54-122"><a href="#cb54-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-123"><a href="#cb54-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### Fama-French Five-Factor Model</span></span>
<span id="cb54-124"><a href="#cb54-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-125"><a href="#cb54-125" aria-hidden="true" tabindex="-1"></a>For a more comprehensive risk adjustment relevant to the Vietnamese market:</span>
<span id="cb54-126"><a href="#cb54-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-127"><a href="#cb54-127" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-128"><a href="#cb54-128" aria-hidden="true" tabindex="-1"></a>R_{p,t} - R_{f,t} = \alpha_p + \beta_1 \text{MKT}_t + \beta_2 \text{SMB}_t + \beta_3 \text{HML}_t + \beta_4 \text{RMW}_t + \beta_5 \text{CMA}_t + \epsilon_{p,t}</span>
<span id="cb54-129"><a href="#cb54-129" aria-hidden="true" tabindex="-1"></a>$$ {#eq-ff5}</span>
<span id="cb54-130"><a href="#cb54-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-131"><a href="#cb54-131" aria-hidden="true" tabindex="-1"></a>where $\text{RMW}_t$ (robust minus weak) captures profitability and $\text{CMA}_t$ (conservative minus aggressive) captures investment patterns.</span>
<span id="cb54-132"><a href="#cb54-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-133"><a href="#cb54-133" aria-hidden="true" tabindex="-1"></a><span class="fu">## Newey-West Standard Errors</span></span>
<span id="cb54-134"><a href="#cb54-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-135"><a href="#cb54-135" aria-hidden="true" tabindex="-1"></a>Since portfolio returns may exhibit serial correlation, we use @newey1987simple standard errors with $L$ lags:</span>
<span id="cb54-136"><a href="#cb54-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-137"><a href="#cb54-137" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-138"><a href="#cb54-138" aria-hidden="true" tabindex="-1"></a>\hat{V}(\hat{\alpha}) = T \left(\sum_{t=1}^{T} \mathbf{x}_t \mathbf{x}_t'\right)^{-1} \hat{S} \left(\sum_{t=1}^{T} \mathbf{x}_t \mathbf{x}_t'\right)^{-1}</span>
<span id="cb54-139"><a href="#cb54-139" aria-hidden="true" tabindex="-1"></a>$$ {#eq-newey-west-var}</span>
<span id="cb54-140"><a href="#cb54-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-141"><a href="#cb54-141" aria-hidden="true" tabindex="-1"></a>where the HAC covariance estimator is:</span>
<span id="cb54-142"><a href="#cb54-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-143"><a href="#cb54-143" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-144"><a href="#cb54-144" aria-hidden="true" tabindex="-1"></a>\hat{S} = \hat{\Gamma}_0 + \sum_{\ell=1}^{L} \left(1 - \frac{\ell}{L+1}\right)\left(\hat{\Gamma}_\ell + \hat{\Gamma}_\ell'\right)</span>
<span id="cb54-145"><a href="#cb54-145" aria-hidden="true" tabindex="-1"></a>$$ {#eq-hac}</span>
<span id="cb54-146"><a href="#cb54-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-147"><a href="#cb54-147" aria-hidden="true" tabindex="-1"></a>and $\hat{\Gamma}_\ell = \frac{1}{T}\sum_{t=\ell+1}^{T} \hat{\epsilon}_t \hat{\epsilon}_{t-\ell} \mathbf{x}_t \mathbf{x}_{t-\ell}'$. The standard lag choice is $L = \lfloor 4(T/100)^{2/9} \rfloor$.</span>
<span id="cb54-148"><a href="#cb54-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-149"><a href="#cb54-149" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data and Sample Construction {#sec-return-gapdata}</span></span>
<span id="cb54-150"><a href="#cb54-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-151"><a href="#cb54-151" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Sources</span></span>
<span id="cb54-152"><a href="#cb54-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-153"><a href="#cb54-153" aria-hidden="true" tabindex="-1"></a>@tbl-return-gaps-data-sources shows the sources used in the construction of return gaps.</span>
<span id="cb54-154"><a href="#cb54-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-155"><a href="#cb54-155" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Data Category <span class="pp">|</span> Source <span class="pp">|</span> Description <span class="pp">|</span></span>
<span id="cb54-156"><a href="#cb54-156" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----------------------|:-----------------------|:-----------------------|</span></span>
<span id="cb54-157"><a href="#cb54-157" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fund holdings <span class="pp">|</span> DataCore Fund Holdings <span class="pp">|</span> Disclosed portfolio positions including ticker, shares held, report date, and vintage (filing) date <span class="pp">|</span></span>
<span id="cb54-158"><a href="#cb54-158" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fund returns <span class="pp">|</span> DataCore Fund Performance <span class="pp">|</span> Monthly NAV-based net returns, total net assets, and expense ratios <span class="pp">|</span></span>
<span id="cb54-159"><a href="#cb54-159" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Fund characteristics <span class="pp">|</span> DataCore Fund Master <span class="pp">|</span> Fund objective codes, inception dates, management company, investment style <span class="pp">|</span></span>
<span id="cb54-160"><a href="#cb54-160" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Stock prices and returns <span class="pp">|</span> DataCore Equity Market <span class="pp">|</span> Daily and monthly adjusted prices, returns, shares outstanding, and corporate actions for HOSE and HNX listed securities <span class="pp">|</span></span>
<span id="cb54-161"><a href="#cb54-161" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Risk factors <span class="pp">|</span> DataCore / Constructed <span class="pp">|</span> Vietnamese market factor portfolios (MKT, SMB, HML, UMD, RMW, CMA) <span class="pp">|</span></span>
<span id="cb54-162"><a href="#cb54-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-163"><a href="#cb54-163" aria-hidden="true" tabindex="-1"></a>: Data sources for the Return Gap analysis in Vietnam {#tbl-return-gaps-data-sources}</span>
<span id="cb54-164"><a href="#cb54-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-165"><a href="#cb54-165" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up the Environment</span></span>
<span id="cb54-166"><a href="#cb54-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-169"><a href="#cb54-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-170"><a href="#cb54-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: setup-environment</span></span>
<span id="cb54-171"><a href="#cb54-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Import libraries and configure settings"</span></span>
<span id="cb54-172"><a href="#cb54-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-173"><a href="#cb54-173" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb54-174"><a href="#cb54-174" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb54-175"><a href="#cb54-175" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb54-176"><a href="#cb54-176" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb54-177"><a href="#cb54-177" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb54-178"><a href="#cb54-178" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> statsmodels.regression.linear_model <span class="im">import</span> OLS</span>
<span id="cb54-179"><a href="#cb54-179" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> stats</span>
<span id="cb54-180"><a href="#cb54-180" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb54-181"><a href="#cb54-181" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dateutil.relativedelta <span class="im">import</span> relativedelta</span>
<span id="cb54-182"><a href="#cb54-182" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb54-183"><a href="#cb54-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-184"><a href="#cb54-184" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb54-185"><a href="#cb54-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-186"><a href="#cb54-186" aria-hidden="true" tabindex="-1"></a>plt.rcParams.update({</span>
<span id="cb54-187"><a href="#cb54-187" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.figsize"</span>: (<span class="dv">10</span>, <span class="dv">6</span>),</span>
<span id="cb54-188"><a href="#cb54-188" aria-hidden="true" tabindex="-1"></a>    <span class="st">"font.size"</span>: <span class="dv">12</span>,</span>
<span id="cb54-189"><a href="#cb54-189" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.titlesize"</span>: <span class="dv">14</span>,</span>
<span id="cb54-190"><a href="#cb54-190" aria-hidden="true" tabindex="-1"></a>    <span class="st">"axes.labelsize"</span>: <span class="dv">12</span>,</span>
<span id="cb54-191"><a href="#cb54-191" aria-hidden="true" tabindex="-1"></a>    <span class="st">"xtick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb54-192"><a href="#cb54-192" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ytick.labelsize"</span>: <span class="dv">10</span>,</span>
<span id="cb54-193"><a href="#cb54-193" aria-hidden="true" tabindex="-1"></a>    <span class="st">"legend.fontsize"</span>: <span class="dv">10</span>,</span>
<span id="cb54-194"><a href="#cb54-194" aria-hidden="true" tabindex="-1"></a>    <span class="st">"figure.dpi"</span>: <span class="dv">150</span>,</span>
<span id="cb54-195"><a href="#cb54-195" aria-hidden="true" tabindex="-1"></a>    <span class="st">"savefig.dpi"</span>: <span class="dv">300</span>,</span>
<span id="cb54-196"><a href="#cb54-196" aria-hidden="true" tabindex="-1"></a>    <span class="st">"font.family"</span>: <span class="st">"serif"</span>,</span>
<span id="cb54-197"><a href="#cb54-197" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb54-198"><a href="#cb54-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-199"><a href="#cb54-199" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">"whitegrid"</span>)</span>
<span id="cb54-200"><a href="#cb54-200" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb54-201"><a href="#cb54-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-202"><a href="#cb54-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-203"><a href="#cb54-203" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading and Preparing Stock Market Data {#sec-return-gapstock-data}</span></span>
<span id="cb54-204"><a href="#cb54-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-205"><a href="#cb54-205" aria-hidden="true" tabindex="-1"></a>The first step is to load the stock-level data, which provides the foundation for computing hypothetical holdings returns.</span>
<span id="cb54-206"><a href="#cb54-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-209"><a href="#cb54-209" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-210"><a href="#cb54-210" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-stock-data</span></span>
<span id="cb54-211"><a href="#cb54-211" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load stock prices and returns from DataCore"</span></span>
<span id="cb54-212"><a href="#cb54-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-213"><a href="#cb54-213" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb54-214"><a href="#cb54-214" aria-hidden="true" tabindex="-1"></a><span class="co"># In production, replace with actual DataCore API calls:</span></span>
<span id="cb54-215"><a href="#cb54-215" aria-hidden="true" tabindex="-1"></a><span class="co">#   from datacore import DataCoreClient</span></span>
<span id="cb54-216"><a href="#cb54-216" aria-hidden="true" tabindex="-1"></a><span class="co">#   client = DataCoreClient(api_key="YOUR_KEY")</span></span>
<span id="cb54-217"><a href="#cb54-217" aria-hidden="true" tabindex="-1"></a><span class="co">#   stock_data = client.get_equity_monthly(</span></span>
<span id="cb54-218"><a href="#cb54-218" aria-hidden="true" tabindex="-1"></a><span class="co">#       exchange=["HOSE", "HNX"],</span></span>
<span id="cb54-219"><a href="#cb54-219" aria-hidden="true" tabindex="-1"></a><span class="co">#       start_date="2010-01-01",</span></span>
<span id="cb54-220"><a href="#cb54-220" aria-hidden="true" tabindex="-1"></a><span class="co">#       end_date="2024-12-31",</span></span>
<span id="cb54-221"><a href="#cb54-221" aria-hidden="true" tabindex="-1"></a><span class="co">#       fields=["ticker", "date", "close_adj", "return_monthly",</span></span>
<span id="cb54-222"><a href="#cb54-222" aria-hidden="true" tabindex="-1"></a><span class="co">#               "shares_outstanding", "market_cap"]</span></span>
<span id="cb54-223"><a href="#cb54-223" aria-hidden="true" tabindex="-1"></a><span class="co">#   )</span></span>
<span id="cb54-224"><a href="#cb54-224" aria-hidden="true" tabindex="-1"></a><span class="co"># ============================================================</span></span>
<span id="cb54-225"><a href="#cb54-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-226"><a href="#cb54-226" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_stock_data(</span>
<span id="cb54-227"><a href="#cb54-227" aria-hidden="true" tabindex="-1"></a>    n_stocks: <span class="bu">int</span> <span class="op">=</span> <span class="dv">300</span>,</span>
<span id="cb54-228"><a href="#cb54-228" aria-hidden="true" tabindex="-1"></a>    start_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2012-01-01"</span>,</span>
<span id="cb54-229"><a href="#cb54-229" aria-hidden="true" tabindex="-1"></a>    end_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2024-12-31"</span>,</span>
<span id="cb54-230"><a href="#cb54-230" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb54-231"><a href="#cb54-231" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-232"><a href="#cb54-232" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate simulated monthly stock data mimicking Vietnamese</span></span>
<span id="cb54-233"><a href="#cb54-233" aria-hidden="true" tabindex="-1"></a><span class="co">    equity market characteristics.</span></span>
<span id="cb54-234"><a href="#cb54-234" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-235"><a href="#cb54-235" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb54-236"><a href="#cb54-236" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> [<span class="ss">f"VN</span><span class="sc">{</span><span class="bu">str</span>(i)<span class="sc">.</span>zfill(<span class="dv">4</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_stocks <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb54-237"><a href="#cb54-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-238"><a href="#cb54-238" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb54-239"><a href="#cb54-239" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> ticker <span class="kw">in</span> tickers:</span>
<span id="cb54-240"><a href="#cb54-240" aria-hidden="true" tabindex="-1"></a>        list_offset <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dates) <span class="op">//</span> <span class="dv">3</span>))</span>
<span id="cb54-241"><a href="#cb54-241" aria-hidden="true" tabindex="-1"></a>        available_dates <span class="op">=</span> dates[list_offset:]</span>
<span id="cb54-242"><a href="#cb54-242" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> np.random.normal(<span class="fl">0.008</span>, <span class="fl">0.005</span>)</span>
<span id="cb54-243"><a href="#cb54-243" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> np.random.uniform(<span class="fl">0.06</span>, <span class="fl">0.15</span>)</span>
<span id="cb54-244"><a href="#cb54-244" aria-hidden="true" tabindex="-1"></a>        beta <span class="op">=</span> np.random.uniform(<span class="fl">0.5</span>, <span class="fl">1.8</span>)</span>
<span id="cb54-245"><a href="#cb54-245" aria-hidden="true" tabindex="-1"></a>        market_shocks <span class="op">=</span> np.random.normal(<span class="fl">0.005</span>, <span class="fl">0.06</span>, <span class="bu">len</span>(available_dates))</span>
<span id="cb54-246"><a href="#cb54-246" aria-hidden="true" tabindex="-1"></a>        idio_shocks <span class="op">=</span> np.random.normal(<span class="dv">0</span>, sigma, <span class="bu">len</span>(available_dates))</span>
<span id="cb54-247"><a href="#cb54-247" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> mu <span class="op">+</span> beta <span class="op">*</span> market_shocks <span class="op">+</span> idio_shocks</span>
<span id="cb54-248"><a href="#cb54-248" aria-hidden="true" tabindex="-1"></a>        returns <span class="op">=</span> np.clip(returns, <span class="op">-</span><span class="fl">0.30</span>, <span class="fl">0.40</span>)</span>
<span id="cb54-249"><a href="#cb54-249" aria-hidden="true" tabindex="-1"></a>        price <span class="op">=</span> np.random.uniform(<span class="dv">10</span>, <span class="dv">150</span>)</span>
<span id="cb54-250"><a href="#cb54-250" aria-hidden="true" tabindex="-1"></a>        prices <span class="op">=</span> [price]</span>
<span id="cb54-251"><a href="#cb54-251" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> r <span class="kw">in</span> returns[:<span class="op">-</span><span class="dv">1</span>]:</span>
<span id="cb54-252"><a href="#cb54-252" aria-hidden="true" tabindex="-1"></a>            price <span class="op">=</span> price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> r)</span>
<span id="cb54-253"><a href="#cb54-253" aria-hidden="true" tabindex="-1"></a>            prices.append(price)</span>
<span id="cb54-254"><a href="#cb54-254" aria-hidden="true" tabindex="-1"></a>        shares <span class="op">=</span> np.random.uniform(<span class="dv">50</span>, <span class="dv">500</span>) <span class="op">*</span> <span class="fl">1e6</span></span>
<span id="cb54-255"><a href="#cb54-255" aria-hidden="true" tabindex="-1"></a>        shares_series <span class="op">=</span> np.full(<span class="bu">len</span>(available_dates), shares)</span>
<span id="cb54-256"><a href="#cb54-256" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i, d <span class="kw">in</span> <span class="bu">enumerate</span>(available_dates):</span>
<span id="cb54-257"><a href="#cb54-257" aria-hidden="true" tabindex="-1"></a>            records.append({</span>
<span id="cb54-258"><a href="#cb54-258" aria-hidden="true" tabindex="-1"></a>                <span class="st">"ticker"</span>: ticker, <span class="st">"date"</span>: d,</span>
<span id="cb54-259"><a href="#cb54-259" aria-hidden="true" tabindex="-1"></a>                <span class="st">"close_adj"</span>: prices[i], <span class="st">"ret"</span>: returns[i],</span>
<span id="cb54-260"><a href="#cb54-260" aria-hidden="true" tabindex="-1"></a>                <span class="st">"shares_outstanding"</span>: shares_series[i],</span>
<span id="cb54-261"><a href="#cb54-261" aria-hidden="true" tabindex="-1"></a>                <span class="st">"market_cap"</span>: prices[i] <span class="op">*</span> shares_series[i] <span class="op">/</span> <span class="fl">1e9</span>,</span>
<span id="cb54-262"><a href="#cb54-262" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb54-263"><a href="#cb54-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-264"><a href="#cb54-264" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb54-265"><a href="#cb54-265" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb54-266"><a href="#cb54-266" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"ticker"</span>, <span class="st">"date"</span>])</span>
<span id="cb54-267"><a href="#cb54-267" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"close_adj_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"ticker"</span>)[<span class="st">"close_adj"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb54-268"><a href="#cb54-268" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb54-269"><a href="#cb54-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-270"><a href="#cb54-270" aria-hidden="true" tabindex="-1"></a>stock_data <span class="op">=</span> generate_stock_data()</span>
<span id="cb54-271"><a href="#cb54-271" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Stock data: </span><span class="sc">{</span>stock_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> stock-months"</span>)</span>
<span id="cb54-272"><a href="#cb54-272" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique stocks: </span><span class="sc">{</span>stock_data[<span class="st">'ticker'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-273"><a href="#cb54-273" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Date range: </span><span class="sc">{</span>stock_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss"> to "</span></span>
<span id="cb54-274"><a href="#cb54-274" aria-hidden="true" tabindex="-1"></a>      <span class="ss">f"</span><span class="sc">{</span>stock_data[<span class="st">'date'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">:</span><span class="op">%</span>Y<span class="op">-%</span>m<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-275"><a href="#cb54-275" aria-hidden="true" tabindex="-1"></a>stock_data.head(<span class="dv">10</span>)</span>
<span id="cb54-276"><a href="#cb54-276" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-277"><a href="#cb54-277" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-278"><a href="#cb54-278" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading Fund Holdings Data {#sec-return-gapholdings-data}</span></span>
<span id="cb54-279"><a href="#cb54-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-282"><a href="#cb54-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-283"><a href="#cb54-283" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-holdings-data</span></span>
<span id="cb54-284"><a href="#cb54-284" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load fund holdings from DataCore"</span></span>
<span id="cb54-285"><a href="#cb54-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-286"><a href="#cb54-286" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_holdings_data(</span>
<span id="cb54-287"><a href="#cb54-287" aria-hidden="true" tabindex="-1"></a>    stock_data: pd.DataFrame,</span>
<span id="cb54-288"><a href="#cb54-288" aria-hidden="true" tabindex="-1"></a>    n_funds: <span class="bu">int</span> <span class="op">=</span> <span class="dv">50</span>,</span>
<span id="cb54-289"><a href="#cb54-289" aria-hidden="true" tabindex="-1"></a>    start_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2012-06-30"</span>,</span>
<span id="cb54-290"><a href="#cb54-290" aria-hidden="true" tabindex="-1"></a>    end_date: <span class="bu">str</span> <span class="op">=</span> <span class="st">"2024-12-31"</span>,</span>
<span id="cb54-291"><a href="#cb54-291" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> pd.DataFrame:</span>
<span id="cb54-292"><a href="#cb54-292" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb54-293"><a href="#cb54-293" aria-hidden="true" tabindex="-1"></a><span class="co">    Generate simulated fund holdings data. Each fund holds 15-80</span></span>
<span id="cb54-294"><a href="#cb54-294" aria-hidden="true" tabindex="-1"></a><span class="co">    stocks, disclosed semi-annually or quarterly.</span></span>
<span id="cb54-295"><a href="#cb54-295" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb54-296"><a href="#cb54-296" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb54-297"><a href="#cb54-297" aria-hidden="true" tabindex="-1"></a>    tickers <span class="op">=</span> stock_data[<span class="st">"ticker"</span>].unique()</span>
<span id="cb54-298"><a href="#cb54-298" aria-hidden="true" tabindex="-1"></a>    fund_ids <span class="op">=</span> [<span class="ss">f"FUND</span><span class="sc">{</span><span class="bu">str</span>(i)<span class="sc">.</span>zfill(<span class="dv">3</span>)<span class="sc">}</span><span class="ss">"</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, n_funds <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb54-299"><a href="#cb54-299" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb54-300"><a href="#cb54-300" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fund_id <span class="kw">in</span> fund_ids:</span>
<span id="cb54-301"><a href="#cb54-301" aria-hidden="true" tabindex="-1"></a>        inception_idx <span class="op">=</span> np.random.randint(<span class="dv">0</span>, <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">len</span>(dates) <span class="op">//</span> <span class="dv">4</span>))</span>
<span id="cb54-302"><a href="#cb54-302" aria-hidden="true" tabindex="-1"></a>        freq <span class="op">=</span> <span class="dv">3</span> <span class="cf">if</span> np.random.random() <span class="op">&lt;</span> <span class="fl">0.7</span> <span class="cf">else</span> <span class="dv">6</span></span>
<span id="cb54-303"><a href="#cb54-303" aria-hidden="true" tabindex="-1"></a>        n_stocks_held <span class="op">=</span> np.random.randint(<span class="dv">15</span>, <span class="dv">80</span>)</span>
<span id="cb54-304"><a href="#cb54-304" aria-hidden="true" tabindex="-1"></a>        core_stocks <span class="op">=</span> np.random.choice(tickers, size<span class="op">=</span>n_stocks_held, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb54-305"><a href="#cb54-305" aria-hidden="true" tabindex="-1"></a>        report_dates <span class="op">=</span> dates[inception_idx::freq]</span>
<span id="cb54-306"><a href="#cb54-306" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> rdate <span class="kw">in</span> report_dates:</span>
<span id="cb54-307"><a href="#cb54-307" aria-hidden="true" tabindex="-1"></a>            filing_delay <span class="op">=</span> np.random.randint(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb54-308"><a href="#cb54-308" aria-hidden="true" tabindex="-1"></a>            fdate <span class="op">=</span> rdate <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>filing_delay)</span>
<span id="cb54-309"><a href="#cb54-309" aria-hidden="true" tabindex="-1"></a>            turnover <span class="op">=</span> np.random.uniform(<span class="fl">0.05</span>, <span class="fl">0.20</span>)</span>
<span id="cb54-310"><a href="#cb54-310" aria-hidden="true" tabindex="-1"></a>            n_replace <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(n_stocks_held <span class="op">*</span> turnover))</span>
<span id="cb54-311"><a href="#cb54-311" aria-hidden="true" tabindex="-1"></a>            replace_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(core_stocks), size<span class="op">=</span>n_replace, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb54-312"><a href="#cb54-312" aria-hidden="true" tabindex="-1"></a>            new_stocks <span class="op">=</span> np.random.choice(tickers, size<span class="op">=</span>n_replace, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb54-313"><a href="#cb54-313" aria-hidden="true" tabindex="-1"></a>            core_stocks[replace_idx] <span class="op">=</span> new_stocks</span>
<span id="cb54-314"><a href="#cb54-314" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> ticker <span class="kw">in</span> core_stocks:</span>
<span id="cb54-315"><a href="#cb54-315" aria-hidden="true" tabindex="-1"></a>                shares <span class="op">=</span> np.random.uniform(<span class="dv">100_000</span>, <span class="dv">5_000_000</span>)</span>
<span id="cb54-316"><a href="#cb54-316" aria-hidden="true" tabindex="-1"></a>                records.append({</span>
<span id="cb54-317"><a href="#cb54-317" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fund_id"</span>: fund_id, <span class="st">"report_date"</span>: rdate,</span>
<span id="cb54-318"><a href="#cb54-318" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"filing_date"</span>: fdate, <span class="st">"ticker"</span>: ticker,</span>
<span id="cb54-319"><a href="#cb54-319" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"shares_held"</span>: shares,</span>
<span id="cb54-320"><a href="#cb54-320" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb54-321"><a href="#cb54-321" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb54-322"><a href="#cb54-322" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"report_date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"report_date"</span>])</span>
<span id="cb54-323"><a href="#cb54-323" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"filing_date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"filing_date"</span>])</span>
<span id="cb54-324"><a href="#cb54-324" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb54-325"><a href="#cb54-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-326"><a href="#cb54-326" aria-hidden="true" tabindex="-1"></a>holdings_raw <span class="op">=</span> generate_holdings_data(stock_data)</span>
<span id="cb54-327"><a href="#cb54-327" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings records: </span><span class="sc">{</span>holdings_raw<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-328"><a href="#cb54-328" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique funds: </span><span class="sc">{</span>holdings_raw[<span class="st">'fund_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-329"><a href="#cb54-329" aria-hidden="true" tabindex="-1"></a>holdings_raw.head(<span class="dv">10</span>)</span>
<span id="cb54-330"><a href="#cb54-330" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-331"><a href="#cb54-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-332"><a href="#cb54-332" aria-hidden="true" tabindex="-1"></a><span class="fu">## Loading Fund Returns and Characteristics {#sec-return-gapfund-returns}</span></span>
<span id="cb54-333"><a href="#cb54-333" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-336"><a href="#cb54-336" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-337"><a href="#cb54-337" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-fund-returns</span></span>
<span id="cb54-338"><a href="#cb54-338" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Load fund NAV returns and expense data"</span></span>
<span id="cb54-339"><a href="#cb54-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-340"><a href="#cb54-340" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_fund_returns(holdings, start_date<span class="op">=</span><span class="st">"2012-01-01"</span>, end_date<span class="op">=</span><span class="st">"2024-12-31"</span>):</span>
<span id="cb54-341"><a href="#cb54-341" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate monthly fund-level net returns, TNA, and expense ratios."""</span></span>
<span id="cb54-342"><a href="#cb54-342" aria-hidden="true" tabindex="-1"></a>    fund_ids <span class="op">=</span> holdings[<span class="st">"fund_id"</span>].unique()</span>
<span id="cb54-343"><a href="#cb54-343" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb54-344"><a href="#cb54-344" aria-hidden="true" tabindex="-1"></a>    records <span class="op">=</span> []</span>
<span id="cb54-345"><a href="#cb54-345" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> fund_id <span class="kw">in</span> fund_ids:</span>
<span id="cb54-346"><a href="#cb54-346" aria-hidden="true" tabindex="-1"></a>        fund_start <span class="op">=</span> holdings.loc[holdings[<span class="st">"fund_id"</span>] <span class="op">==</span> fund_id, <span class="st">"report_date"</span>].<span class="bu">min</span>() <span class="op">-</span> pd.DateOffset(months<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb54-347"><a href="#cb54-347" aria-hidden="true" tabindex="-1"></a>        fund_dates <span class="op">=</span> dates[dates <span class="op">&gt;=</span> fund_start]</span>
<span id="cb54-348"><a href="#cb54-348" aria-hidden="true" tabindex="-1"></a>        exp_ratio <span class="op">=</span> np.random.uniform(<span class="fl">0.010</span>, <span class="fl">0.025</span>)</span>
<span id="cb54-349"><a href="#cb54-349" aria-hidden="true" tabindex="-1"></a>        base_tna <span class="op">=</span> np.random.uniform(<span class="dv">50</span>, <span class="dv">2000</span>)</span>
<span id="cb54-350"><a href="#cb54-350" aria-hidden="true" tabindex="-1"></a>        mu <span class="op">=</span> np.random.normal(<span class="fl">0.007</span>, <span class="fl">0.003</span>)</span>
<span id="cb54-351"><a href="#cb54-351" aria-hidden="true" tabindex="-1"></a>        sigma <span class="op">=</span> np.random.uniform(<span class="fl">0.04</span>, <span class="fl">0.09</span>)</span>
<span id="cb54-352"><a href="#cb54-352" aria-hidden="true" tabindex="-1"></a>        tna <span class="op">=</span> base_tna</span>
<span id="cb54-353"><a href="#cb54-353" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> d <span class="kw">in</span> fund_dates:</span>
<span id="cb54-354"><a href="#cb54-354" aria-hidden="true" tabindex="-1"></a>            ret <span class="op">=</span> np.clip(np.random.normal(mu, sigma), <span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.35</span>)</span>
<span id="cb54-355"><a href="#cb54-355" aria-hidden="true" tabindex="-1"></a>            tna <span class="op">=</span> <span class="bu">max</span>(tna <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> ret) <span class="op">+</span> np.random.normal(<span class="dv">0</span>, base_tna <span class="op">*</span> <span class="fl">0.02</span>), <span class="dv">10</span>)</span>
<span id="cb54-356"><a href="#cb54-356" aria-hidden="true" tabindex="-1"></a>            records.append({<span class="st">"fund_id"</span>: fund_id, <span class="st">"date"</span>: d, <span class="st">"net_return"</span>: ret,</span>
<span id="cb54-357"><a href="#cb54-357" aria-hidden="true" tabindex="-1"></a>                            <span class="st">"tna"</span>: tna, <span class="st">"expense_ratio"</span>: exp_ratio <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.001</span>)})</span>
<span id="cb54-358"><a href="#cb54-358" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.DataFrame(records)</span>
<span id="cb54-359"><a href="#cb54-359" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"date"</span>] <span class="op">=</span> pd.to_datetime(df[<span class="st">"date"</span>])</span>
<span id="cb54-360"><a href="#cb54-360" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"expense_ratio"</span>] <span class="op">=</span> df[<span class="st">"expense_ratio"</span>].clip(<span class="fl">0.005</span>, <span class="fl">0.035</span>)</span>
<span id="cb54-361"><a href="#cb54-361" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb54-362"><a href="#cb54-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-363"><a href="#cb54-363" aria-hidden="true" tabindex="-1"></a>fund_returns <span class="op">=</span> generate_fund_returns(holdings_raw)</span>
<span id="cb54-364"><a href="#cb54-364" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fund-month observations: </span><span class="sc">{</span>fund_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-365"><a href="#cb54-365" aria-hidden="true" tabindex="-1"></a>fund_returns.head(<span class="dv">10</span>)</span>
<span id="cb54-366"><a href="#cb54-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-367"><a href="#cb54-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-368"><a href="#cb54-368" aria-hidden="true" tabindex="-1"></a><span class="fu">## Sample Selection: Domestic Equity Funds {#sec-return-gapsample-selection}</span></span>
<span id="cb54-369"><a href="#cb54-369" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-370"><a href="#cb54-370" aria-hidden="true" tabindex="-1"></a>Following the approach of @kacperczyk2008unobserved, we restrict our sample to domestic equity funds.</span>
<span id="cb54-371"><a href="#cb54-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-374"><a href="#cb54-374" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-375"><a href="#cb54-375" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: sample-selection</span></span>
<span id="cb54-376"><a href="#cb54-376" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Filter to domestic equity funds"</span></span>
<span id="cb54-377"><a href="#cb54-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-378"><a href="#cb54-378" aria-hidden="true" tabindex="-1"></a>equity_objectives <span class="op">=</span> [</span>
<span id="cb54-379"><a href="#cb54-379" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_DOMESTIC"</span>, <span class="st">"EQUITY_GROWTH"</span>, <span class="st">"EQUITY_VALUE"</span>,</span>
<span id="cb54-380"><a href="#cb54-380" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_BLEND"</span>, <span class="st">"EQUITY_LARGE_CAP"</span>, <span class="st">"EQUITY_MID_CAP"</span>,</span>
<span id="cb54-381"><a href="#cb54-381" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EQUITY_SMALL_CAP"</span>,</span>
<span id="cb54-382"><a href="#cb54-382" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb54-383"><a href="#cb54-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-384"><a href="#cb54-384" aria-hidden="true" tabindex="-1"></a>fund_ids <span class="op">=</span> fund_returns[<span class="st">"fund_id"</span>].unique()</span>
<span id="cb54-385"><a href="#cb54-385" aria-hidden="true" tabindex="-1"></a>fund_master <span class="op">=</span> pd.DataFrame({</span>
<span id="cb54-386"><a href="#cb54-386" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fund_id"</span>: fund_ids,</span>
<span id="cb54-387"><a href="#cb54-387" aria-hidden="true" tabindex="-1"></a>    <span class="st">"objective"</span>: np.random.choice(</span>
<span id="cb54-388"><a href="#cb54-388" aria-hidden="true" tabindex="-1"></a>        equity_objectives <span class="op">+</span> [<span class="st">"BOND"</span>, <span class="st">"BALANCED"</span>, <span class="st">"MONEY_MARKET"</span>],</span>
<span id="cb54-389"><a href="#cb54-389" aria-hidden="true" tabindex="-1"></a>        size<span class="op">=</span><span class="bu">len</span>(fund_ids),</span>
<span id="cb54-390"><a href="#cb54-390" aria-hidden="true" tabindex="-1"></a>        p<span class="op">=</span>[<span class="fl">0.08</span>, <span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.10</span>, <span class="fl">0.08</span>, <span class="fl">0.06</span>, <span class="fl">0.06</span>, <span class="fl">0.15</span>, <span class="fl">0.18</span>, <span class="fl">0.15</span>],</span>
<span id="cb54-391"><a href="#cb54-391" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb54-392"><a href="#cb54-392" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb54-393"><a href="#cb54-393" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-394"><a href="#cb54-394" aria-hidden="true" tabindex="-1"></a>equity_fund_ids <span class="op">=</span> fund_master.loc[</span>
<span id="cb54-395"><a href="#cb54-395" aria-hidden="true" tabindex="-1"></a>    fund_master[<span class="st">"objective"</span>].isin(equity_objectives), <span class="st">"fund_id"</span></span>
<span id="cb54-396"><a href="#cb54-396" aria-hidden="true" tabindex="-1"></a>].values</span>
<span id="cb54-397"><a href="#cb54-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-398"><a href="#cb54-398" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total funds: </span><span class="sc">{</span><span class="bu">len</span>(fund_ids)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-399"><a href="#cb54-399" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equity funds: </span><span class="sc">{</span><span class="bu">len</span>(equity_fund_ids)<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span><span class="bu">len</span>(equity_fund_ids)<span class="op">/</span><span class="bu">len</span>(fund_ids)<span class="op">*</span><span class="dv">100</span><span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb54-400"><a href="#cb54-400" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Objective distribution:"</span>)</span>
<span id="cb54-401"><a href="#cb54-401" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fund_master[<span class="st">"objective"</span>].value_counts().to_string())</span>
<span id="cb54-402"><a href="#cb54-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-403"><a href="#cb54-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-404"><a href="#cb54-404" aria-hidden="true" tabindex="-1"></a><span class="fu"># Computing the Return Gap {#sec-return-gapcomputing}</span></span>
<span id="cb54-405"><a href="#cb54-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-406"><a href="#cb54-406" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 1: Prepare Holdings Vintages {#sec-return-gapvintages}</span></span>
<span id="cb54-407"><a href="#cb54-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-408"><a href="#cb54-408" aria-hidden="true" tabindex="-1"></a>A critical first step is to correctly handle the *vintage* structure of holdings data. Each holdings report has two key dates: the **report date** ($\tau$, the as-of date) and the **filing date** ($f$, when it becomes public). We keep only the first vintage per fund-report date.</span>
<span id="cb54-409"><a href="#cb54-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-412"><a href="#cb54-412" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-413"><a href="#cb54-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: prepare-vintages</span></span>
<span id="cb54-414"><a href="#cb54-414" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Process holdings vintages and determine holding periods"</span></span>
<span id="cb54-415"><a href="#cb54-415" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-416"><a href="#cb54-416" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_holdings_vintages(holdings, max_holding_months<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb54-417"><a href="#cb54-417" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Process holdings vintages and compute next report dates."""</span></span>
<span id="cb54-418"><a href="#cb54-418" aria-hidden="true" tabindex="-1"></a>    first_vintage <span class="op">=</span> (</span>
<span id="cb54-419"><a href="#cb54-419" aria-hidden="true" tabindex="-1"></a>        holdings.sort_values([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>])</span>
<span id="cb54-420"><a href="#cb54-420" aria-hidden="true" tabindex="-1"></a>        .groupby([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>])</span>
<span id="cb54-421"><a href="#cb54-421" aria-hidden="true" tabindex="-1"></a>        .agg(filing_date<span class="op">=</span>(<span class="st">"filing_date"</span>, <span class="st">"first"</span>))</span>
<span id="cb54-422"><a href="#cb54-422" aria-hidden="true" tabindex="-1"></a>        .reset_index()</span>
<span id="cb54-423"><a href="#cb54-423" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-424"><a href="#cb54-424" aria-hidden="true" tabindex="-1"></a>    first_vintage <span class="op">=</span> first_vintage.sort_values([<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>])</span>
<span id="cb54-425"><a href="#cb54-425" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage.groupby(<span class="st">"fund_id"</span>)[<span class="st">"report_date"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb54-426"><a href="#cb54-426" aria-hidden="true" tabindex="-1"></a>    max_date <span class="op">=</span> first_vintage[<span class="st">"report_date"</span>] <span class="op">+</span> pd.DateOffset(months<span class="op">=</span>max_holding_months)</span>
<span id="cb54-427"><a href="#cb54-427" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[<span class="st">"next_report_date"</span>].fillna(max_date)</span>
<span id="cb54-428"><a href="#cb54-428" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[[<span class="st">"next_report_date"</span>]].<span class="bu">min</span>(axis<span class="op">=</span><span class="dv">1</span>).clip(upper<span class="op">=</span>max_date)</span>
<span id="cb54-429"><a href="#cb54-429" aria-hidden="true" tabindex="-1"></a>    first_vintage[<span class="st">"next_report_date"</span>] <span class="op">=</span> first_vintage[<span class="st">"next_report_date"</span>] <span class="op">+</span> pd.offsets.MonthEnd(<span class="dv">0</span>)</span>
<span id="cb54-430"><a href="#cb54-430" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> holdings.merge(first_vintage, on<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>], how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb54-431"><a href="#cb54-431" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span>
<span id="cb54-432"><a href="#cb54-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-433"><a href="#cb54-433" aria-hidden="true" tabindex="-1"></a>holdings_vintaged <span class="op">=</span> prepare_holdings_vintages(holdings_raw)</span>
<span id="cb54-434"><a href="#cb54-434" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Holdings after vintage processing: </span><span class="sc">{</span>holdings_vintaged<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss"> records"</span>)</span>
<span id="cb54-435"><a href="#cb54-435" aria-hidden="true" tabindex="-1"></a>sample_fund <span class="op">=</span> holdings_vintaged[<span class="st">"fund_id"</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb54-436"><a href="#cb54-436" aria-hidden="true" tabindex="-1"></a>(holdings_vintaged.loc[holdings_vintaged[<span class="st">"fund_id"</span>] <span class="op">==</span> sample_fund]</span>
<span id="cb54-437"><a href="#cb54-437" aria-hidden="true" tabindex="-1"></a> [[<span class="st">"fund_id"</span>, <span class="st">"report_date"</span>, <span class="st">"filing_date"</span>, <span class="st">"next_report_date"</span>]]</span>
<span id="cb54-438"><a href="#cb54-438" aria-hidden="true" tabindex="-1"></a> .drop_duplicates().head(<span class="dv">8</span>))</span>
<span id="cb54-439"><a href="#cb54-439" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-440"><a href="#cb54-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-441"><a href="#cb54-441" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 2: Adjust Shares for Corporate Actions {#sec-return-gapadjust-shares}</span></span>
<span id="cb54-442"><a href="#cb54-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-445"><a href="#cb54-445" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-446"><a href="#cb54-446" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: adjust-shares</span></span>
<span id="cb54-447"><a href="#cb54-447" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Adjust shares held for corporate actions"</span></span>
<span id="cb54-448"><a href="#cb54-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-449"><a href="#cb54-449" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> adjust_holdings_shares(holdings, stock_data):</span>
<span id="cb54-450"><a href="#cb54-450" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Adjust shares for splits, bonuses, rights. Simulated: factor=1."""</span></span>
<span id="cb54-451"><a href="#cb54-451" aria-hidden="true" tabindex="-1"></a>    holdings[<span class="st">"shares_adj"</span>] <span class="op">=</span> holdings[<span class="st">"shares_held"</span>]</span>
<span id="cb54-452"><a href="#cb54-452" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> holdings</span>
<span id="cb54-453"><a href="#cb54-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-454"><a href="#cb54-454" aria-hidden="true" tabindex="-1"></a>holdings_adj <span class="op">=</span> adjust_holdings_shares(holdings_vintaged, stock_data)</span>
<span id="cb54-455"><a href="#cb54-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-456"><a href="#cb54-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-457"><a href="#cb54-457" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 3: Compute Hypothetical Holdings Returns {#sec-return-gaphypothetical-returns}</span></span>
<span id="cb54-458"><a href="#cb54-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-459"><a href="#cb54-459" aria-hidden="true" tabindex="-1"></a>This is the core computation. For each fund, we take the disclosed holdings as of report date $\tau$, and for each month $t$ in $(\tau, \tau_{\text{next}}]$, compute the value-weighted return using lagged dollar values as weights.</span>
<span id="cb54-460"><a href="#cb54-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-463"><a href="#cb54-463" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-464"><a href="#cb54-464" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-holdings-returns</span></span>
<span id="cb54-465"><a href="#cb54-465" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute value-weighted hypothetical portfolio returns"</span></span>
<span id="cb54-466"><a href="#cb54-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-467"><a href="#cb54-467" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_holdings_returns(holdings, stock_data, min_stocks<span class="op">=</span><span class="dv">10</span>, min_assets_bn<span class="op">=</span><span class="fl">5.0</span>):</span>
<span id="cb54-468"><a href="#cb54-468" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute monthly hypothetical buy-and-hold portfolio returns."""</span></span>
<span id="cb54-469"><a href="#cb54-469" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> holdings.merge(stock_data, on<span class="op">=</span><span class="st">"ticker"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb54-470"><a href="#cb54-470" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (merged[<span class="st">"date"</span>] <span class="op">&gt;</span> merged[<span class="st">"report_date"</span>]) <span class="op">&amp;</span> (merged[<span class="st">"date"</span>] <span class="op">&lt;=</span> merged[<span class="st">"next_report_date"</span>])</span>
<span id="cb54-471"><a href="#cb54-471" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.loc[mask].copy()</span>
<span id="cb54-472"><a href="#cb54-472" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"hvalue_lag"</span>] <span class="op">=</span> merged[<span class="st">"shares_adj"</span>] <span class="op">*</span> merged[<span class="st">"close_adj_lag"</span>]</span>
<span id="cb54-473"><a href="#cb54-473" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.loc[merged[<span class="st">"hvalue_lag"</span>] <span class="op">&gt;</span> <span class="dv">0</span>].copy()</span>
<span id="cb54-474"><a href="#cb54-474" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.drop_duplicates(subset<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"date"</span>, <span class="st">"report_date"</span>, <span class="st">"ticker"</span>], keep<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb54-475"><a href="#cb54-475" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-476"><a href="#cb54-476" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> weighted_return(group):</span>
<span id="cb54-477"><a href="#cb54-477" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> group[<span class="st">"hvalue_lag"</span>]</span>
<span id="cb54-478"><a href="#cb54-478" aria-hidden="true" tabindex="-1"></a>        total_weight <span class="op">=</span> weights.<span class="bu">sum</span>()</span>
<span id="cb54-479"><a href="#cb54-479" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_weight <span class="op">&lt;=</span> <span class="dv">0</span>:</span>
<span id="cb54-480"><a href="#cb54-480" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.Series({<span class="st">"hret"</span>: np.nan, <span class="st">"n_stocks"</span>: <span class="dv">0</span>, <span class="st">"assets_lag_bn"</span>: <span class="dv">0</span>})</span>
<span id="cb54-481"><a href="#cb54-481" aria-hidden="true" tabindex="-1"></a>        wret <span class="op">=</span> np.average(group[<span class="st">"ret"</span>], weights<span class="op">=</span>weights)</span>
<span id="cb54-482"><a href="#cb54-482" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> pd.Series({<span class="st">"hret"</span>: wret, <span class="st">"n_stocks"</span>: <span class="bu">len</span>(group), <span class="st">"assets_lag_bn"</span>: total_weight <span class="op">/</span> <span class="fl">1e9</span>})</span>
<span id="cb54-483"><a href="#cb54-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-484"><a href="#cb54-484" aria-hidden="true" tabindex="-1"></a>    portfolio_returns <span class="op">=</span> (</span>
<span id="cb54-485"><a href="#cb54-485" aria-hidden="true" tabindex="-1"></a>        merged.groupby([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb54-486"><a href="#cb54-486" aria-hidden="true" tabindex="-1"></a>        .<span class="bu">apply</span>(weighted_return, include_groups<span class="op">=</span><span class="va">False</span>).reset_index()</span>
<span id="cb54-487"><a href="#cb54-487" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-488"><a href="#cb54-488" aria-hidden="true" tabindex="-1"></a>    portfolio_returns[<span class="st">"assets_bn"</span>] <span class="op">=</span> portfolio_returns[<span class="st">"assets_lag_bn"</span>] <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> portfolio_returns[<span class="st">"hret"</span>])</span>
<span id="cb54-489"><a href="#cb54-489" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> (portfolio_returns[<span class="st">"n_stocks"</span>] <span class="op">&gt;=</span> min_stocks) <span class="op">&amp;</span> (portfolio_returns[<span class="st">"assets_bn"</span>] <span class="op">&gt;=</span> min_assets_bn)</span>
<span id="cb54-490"><a href="#cb54-490" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> portfolio_returns.loc[mask].copy()</span>
<span id="cb54-491"><a href="#cb54-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-492"><a href="#cb54-492" aria-hidden="true" tabindex="-1"></a>holdings_returns <span class="op">=</span> compute_holdings_returns(holdings_adj, stock_data)</span>
<span id="cb54-493"><a href="#cb54-493" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Fund-month observations (hypothetical returns): </span><span class="sc">{</span>holdings_returns<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-494"><a href="#cb54-494" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique funds: </span><span class="sc">{</span>holdings_returns[<span class="st">'fund_id'</span>]<span class="sc">.</span>nunique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-495"><a href="#cb54-495" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Summary:"</span>)</span>
<span id="cb54-496"><a href="#cb54-496" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(holdings_returns[[<span class="st">"hret"</span>, <span class="st">"n_stocks"</span>, <span class="st">"assets_bn"</span>]].describe().<span class="bu">round</span>(<span class="dv">4</span>).to_string())</span>
<span id="cb54-497"><a href="#cb54-497" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-498"><a href="#cb54-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-499"><a href="#cb54-499" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 4: Compute Gross Fund Returns {#sec-return-gapgross-returns}</span></span>
<span id="cb54-500"><a href="#cb54-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-503"><a href="#cb54-503" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-504"><a href="#cb54-504" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-gross-returns</span></span>
<span id="cb54-505"><a href="#cb54-505" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute gross fund returns"</span></span>
<span id="cb54-506"><a href="#cb54-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-507"><a href="#cb54-507" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_fund_returns(fund_returns, equity_fund_ids):</span>
<span id="cb54-508"><a href="#cb54-508" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Prepare fund-level gross returns."""</span></span>
<span id="cb54-509"><a href="#cb54-509" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> fund_returns.loc[fund_returns[<span class="st">"fund_id"</span>].isin(equity_fund_ids)].copy()</span>
<span id="cb54-510"><a href="#cb54-510" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"expense_ratio"</span>] <span class="op">=</span> df[<span class="st">"expense_ratio"</span>].fillna(df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"expense_ratio"</span>].transform(<span class="st">"median"</span>))</span>
<span id="cb54-511"><a href="#cb54-511" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"gross_return"</span>] <span class="op">=</span> df[<span class="st">"net_return"</span>] <span class="op">+</span> df[<span class="st">"expense_ratio"</span>] <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb54-512"><a href="#cb54-512" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb54-513"><a href="#cb54-513" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"tna_lag"</span>] <span class="op">=</span> df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"tna"</span>].shift(<span class="dv">1</span>).fillna(df[<span class="st">"tna"</span>])</span>
<span id="cb54-514"><a href="#cb54-514" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb54-515"><a href="#cb54-515" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-516"><a href="#cb54-516" aria-hidden="true" tabindex="-1"></a>fund_ret_clean <span class="op">=</span> prepare_fund_returns(fund_returns, equity_fund_ids)</span>
<span id="cb54-517"><a href="#cb54-517" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Equity fund-months: </span><span class="sc">{</span>fund_ret_clean<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-518"><a href="#cb54-518" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-519"><a href="#cb54-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-520"><a href="#cb54-520" aria-hidden="true" tabindex="-1"></a><span class="fu">## Step 5: Merge and Compute Return Gap {#sec-return-gapmerge-return-gap}</span></span>
<span id="cb54-521"><a href="#cb54-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-524"><a href="#cb54-524" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-525"><a href="#cb54-525" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-return-gap</span></span>
<span id="cb54-526"><a href="#cb54-526" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Merge actual and hypothetical returns to compute Return Gap"</span></span>
<span id="cb54-527"><a href="#cb54-527" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-528"><a href="#cb54-528" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_return_gap(holdings_returns, fund_returns):</span>
<span id="cb54-529"><a href="#cb54-529" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute Return Gap and trailing averages."""</span></span>
<span id="cb54-530"><a href="#cb54-530" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> holdings_returns.merge(</span>
<span id="cb54-531"><a href="#cb54-531" aria-hidden="true" tabindex="-1"></a>        fund_returns[[<span class="st">"fund_id"</span>, <span class="st">"date"</span>, <span class="st">"net_return"</span>, <span class="st">"gross_return"</span>, <span class="st">"expense_ratio"</span>, <span class="st">"tna"</span>]],</span>
<span id="cb54-532"><a href="#cb54-532" aria-hidden="true" tabindex="-1"></a>        on<span class="op">=</span>[<span class="st">"fund_id"</span>, <span class="st">"date"</span>], how<span class="op">=</span><span class="st">"inner"</span>,</span>
<span id="cb54-533"><a href="#cb54-533" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-534"><a href="#cb54-534" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"return_gap"</span>] <span class="op">=</span> merged[<span class="st">"gross_return"</span>] <span class="op">-</span> merged[<span class="st">"hret"</span>]</span>
<span id="cb54-535"><a href="#cb54-535" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> merged.sort_values([<span class="st">"fund_id"</span>, <span class="st">"date"</span>])</span>
<span id="cb54-536"><a href="#cb54-536" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"rg_12m"</span>] <span class="op">=</span> merged.groupby(<span class="st">"fund_id"</span>)[<span class="st">"return_gap"</span>].transform(</span>
<span id="cb54-537"><a href="#cb54-537" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: x.rolling(<span class="dv">12</span>, min_periods<span class="op">=</span><span class="dv">8</span>).mean()</span>
<span id="cb54-538"><a href="#cb54-538" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb54-539"><a href="#cb54-539" aria-hidden="true" tabindex="-1"></a>    merged[<span class="st">"rg_12m_lag4"</span>] <span class="op">=</span> merged.groupby(<span class="st">"fund_id"</span>)[<span class="st">"rg_12m"</span>].shift(<span class="dv">4</span>)</span>
<span id="cb54-540"><a href="#cb54-540" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> merged</span>
<span id="cb54-541"><a href="#cb54-541" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-542"><a href="#cb54-542" aria-hidden="true" tabindex="-1"></a>return_gap_data <span class="op">=</span> compute_return_gap(holdings_returns, fund_ret_clean)</span>
<span id="cb54-543"><a href="#cb54-543" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Return Gap observations: </span><span class="sc">{</span>return_gap_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-544"><a href="#cb54-544" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Summary:"</span>)</span>
<span id="cb54-545"><a href="#cb54-545" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(return_gap_data[[<span class="st">"return_gap"</span>, <span class="st">"rg_12m"</span>, <span class="st">"rg_12m_lag4"</span>]].describe().<span class="bu">round</span>(<span class="dv">6</span>).to_string())</span>
<span id="cb54-546"><a href="#cb54-546" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-547"><a href="#cb54-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-548"><a href="#cb54-548" aria-hidden="true" tabindex="-1"></a><span class="fu">## Distribution of the Return Gap</span></span>
<span id="cb54-549"><a href="#cb54-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-552"><a href="#cb54-552" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-553"><a href="#cb54-553" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-return-gap-distribution</span></span>
<span id="cb54-554"><a href="#cb54-554" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Distribution of monthly Return Gap across all fund-month observations."</span></span>
<span id="cb54-555"><a href="#cb54-555" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb54-556"><a href="#cb54-556" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb54-557"><a href="#cb54-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-558"><a href="#cb54-558" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb54-559"><a href="#cb54-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-560"><a href="#cb54-560" aria-hidden="true" tabindex="-1"></a>rg <span class="op">=</span> return_gap_data[<span class="st">"return_gap"</span>].dropna()</span>
<span id="cb54-561"><a href="#cb54-561" aria-hidden="true" tabindex="-1"></a>rg_trimmed <span class="op">=</span> rg.clip(rg.quantile(<span class="fl">0.01</span>), rg.quantile(<span class="fl">0.99</span>))</span>
<span id="cb54-562"><a href="#cb54-562" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].hist(rg_trimmed, bins<span class="op">=</span><span class="dv">80</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">"#2C5F8A"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-563"><a href="#cb54-563" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(rg.mean(), color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Mean = </span><span class="sc">{</span>rg<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb54-564"><a href="#cb54-564" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axvline(rg.median(), color<span class="op">=</span><span class="st">"#FF8F00"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Median = </span><span class="sc">{</span>rg<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb54-565"><a href="#cb54-565" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="st">"Monthly Return Gap"</span>)</span>
<span id="cb54-566"><a href="#cb54-566" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb54-567"><a href="#cb54-567" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Panel A: Monthly Return Gap"</span>)</span>
<span id="cb54-568"><a href="#cb54-568" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-569"><a href="#cb54-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-570"><a href="#cb54-570" aria-hidden="true" tabindex="-1"></a>rg12 <span class="op">=</span> return_gap_data[<span class="st">"rg_12m"</span>].dropna()</span>
<span id="cb54-571"><a href="#cb54-571" aria-hidden="true" tabindex="-1"></a>rg12_trimmed <span class="op">=</span> rg12.clip(rg12.quantile(<span class="fl">0.01</span>), rg12.quantile(<span class="fl">0.99</span>))</span>
<span id="cb54-572"><a href="#cb54-572" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].hist(rg12_trimmed, bins<span class="op">=</span><span class="dv">80</span>, density<span class="op">=</span><span class="va">True</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, color<span class="op">=</span><span class="st">"#1B5E20"</span>, edgecolor<span class="op">=</span><span class="st">"white"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-573"><a href="#cb54-573" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(rg12.mean(), color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Mean = </span><span class="sc">{</span>rg12<span class="sc">.</span>mean()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb54-574"><a href="#cb54-574" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axvline(rg12.median(), color<span class="op">=</span><span class="st">"#FF8F00"</span>, linestyle<span class="op">=</span><span class="st">"-."</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="ss">f"Median = </span><span class="sc">{</span>rg12<span class="sc">.</span>median()<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb54-575"><a href="#cb54-575" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">"Trailing 12-Month Average Return Gap"</span>)</span>
<span id="cb54-576"><a href="#cb54-576" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Density"</span>)</span>
<span id="cb54-577"><a href="#cb54-577" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Panel B: 12-Month Average Return Gap"</span>)</span>
<span id="cb54-578"><a href="#cb54-578" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-579"><a href="#cb54-579" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-580"><a href="#cb54-580" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-581"><a href="#cb54-581" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-582"><a href="#cb54-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-583"><a href="#cb54-583" aria-hidden="true" tabindex="-1"></a><span class="fu">## Time Series of Cross-Sectional Return Gap</span></span>
<span id="cb54-584"><a href="#cb54-584" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-587"><a href="#cb54-587" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-588"><a href="#cb54-588" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-return-gap-timeseries</span></span>
<span id="cb54-589"><a href="#cb54-589" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Time series of cross-sectional Return Gap statistics. Solid: median, shaded: IQR, dashed: mean."</span></span>
<span id="cb54-590"><a href="#cb54-590" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb54-591"><a href="#cb54-591" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb54-592"><a href="#cb54-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-593"><a href="#cb54-593" aria-hidden="true" tabindex="-1"></a>ts_stats <span class="op">=</span> (</span>
<span id="cb54-594"><a href="#cb54-594" aria-hidden="true" tabindex="-1"></a>    return_gap_data.groupby(<span class="st">"date"</span>)[<span class="st">"return_gap"</span>]</span>
<span id="cb54-595"><a href="#cb54-595" aria-hidden="true" tabindex="-1"></a>    .agg([<span class="st">"mean"</span>, <span class="st">"median"</span>, <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.25</span>), <span class="kw">lambda</span> x: x.quantile(<span class="fl">0.75</span>)])</span>
<span id="cb54-596"><a href="#cb54-596" aria-hidden="true" tabindex="-1"></a>    .rename(columns<span class="op">=</span>{<span class="st">"&lt;lambda_0&gt;"</span>: <span class="st">"p25"</span>, <span class="st">"&lt;lambda_1&gt;"</span>: <span class="st">"p75"</span>}).reset_index()</span>
<span id="cb54-597"><a href="#cb54-597" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-598"><a href="#cb54-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-599"><a href="#cb54-599" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb54-600"><a href="#cb54-600" aria-hidden="true" tabindex="-1"></a>ax.fill_between(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"p25"</span>], ts_stats[<span class="st">"p75"</span>], alpha<span class="op">=</span><span class="fl">0.3</span>, color<span class="op">=</span><span class="st">"#2C5F8A"</span>, label<span class="op">=</span><span class="st">"IQR"</span>)</span>
<span id="cb54-601"><a href="#cb54-601" aria-hidden="true" tabindex="-1"></a>ax.plot(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"median"</span>], color<span class="op">=</span><span class="st">"#2C5F8A"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">"Median"</span>)</span>
<span id="cb54-602"><a href="#cb54-602" aria-hidden="true" tabindex="-1"></a>ax.plot(ts_stats[<span class="st">"date"</span>], ts_stats[<span class="st">"mean"</span>], color<span class="op">=</span><span class="st">"#D32F2F"</span>, linestyle<span class="op">=</span><span class="st">"--"</span>, linewidth<span class="op">=</span><span class="fl">1.5</span>, label<span class="op">=</span><span class="st">"Mean"</span>)</span>
<span id="cb54-603"><a href="#cb54-603" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb54-604"><a href="#cb54-604" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb54-605"><a href="#cb54-605" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Monthly Return Gap"</span>)</span>
<span id="cb54-606"><a href="#cb54-606" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cross-Sectional Distribution of Return Gap Over Time"</span>)</span>
<span id="cb54-607"><a href="#cb54-607" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-608"><a href="#cb54-608" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-609"><a href="#cb54-609" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-610"><a href="#cb54-610" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-611"><a href="#cb54-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-612"><a href="#cb54-612" aria-hidden="true" tabindex="-1"></a><span class="fu"># Portfolio Sorting Analysis {#sec-return-gapportfolios}</span></span>
<span id="cb54-613"><a href="#cb54-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-614"><a href="#cb54-614" aria-hidden="true" tabindex="-1"></a><span class="fu">## Forming Return Gap Decile Portfolios {#sec-return-gapdecile-portfolios}</span></span>
<span id="cb54-615"><a href="#cb54-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-616"><a href="#cb54-616" aria-hidden="true" tabindex="-1"></a>Each month $t$, we sort funds into decile portfolios based on their lagged 12-month average Return Gap ($\overline{\text{RG}}_{i,t-4}^{12}$). Portfolio 1 contains funds with the lowest Return Gap.</span>
<span id="cb54-617"><a href="#cb54-617" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-620"><a href="#cb54-620" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-621"><a href="#cb54-621" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: form-decile-portfolios</span></span>
<span id="cb54-622"><a href="#cb54-622" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Sort funds into decile portfolios"</span></span>
<span id="cb54-623"><a href="#cb54-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-624"><a href="#cb54-624" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> form_return_gap_portfolios(data, n_portfolios<span class="op">=</span><span class="dv">10</span>, sort_var<span class="op">=</span><span class="st">"rg_12m_lag4"</span>):</span>
<span id="cb54-625"><a href="#cb54-625" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Form portfolios by sorting funds into quantile groups."""</span></span>
<span id="cb54-626"><a href="#cb54-626" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[sort_var]).copy()</span>
<span id="cb54-627"><a href="#cb54-627" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"portfolio"</span>] <span class="op">=</span> (</span>
<span id="cb54-628"><a href="#cb54-628" aria-hidden="true" tabindex="-1"></a>        df.groupby(<span class="st">"date"</span>)[sort_var]</span>
<span id="cb54-629"><a href="#cb54-629" aria-hidden="true" tabindex="-1"></a>        .transform(<span class="kw">lambda</span> x: pd.qcut(x, n_portfolios, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>))</span>
<span id="cb54-630"><a href="#cb54-630" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb54-631"><a href="#cb54-631" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb54-632"><a href="#cb54-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-633"><a href="#cb54-633" aria-hidden="true" tabindex="-1"></a>n_portfolios <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb54-634"><a href="#cb54-634" aria-hidden="true" tabindex="-1"></a>portfolio_data <span class="op">=</span> form_return_gap_portfolios(return_gap_data, n_portfolios<span class="op">=</span>n_portfolios)</span>
<span id="cb54-635"><a href="#cb54-635" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Observations with portfolio assignment: </span><span class="sc">{</span>portfolio_data<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb54-636"><a href="#cb54-636" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-637"><a href="#cb54-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-638"><a href="#cb54-638" aria-hidden="true" tabindex="-1"></a><span class="fu">## Portfolio Returns</span></span>
<span id="cb54-639"><a href="#cb54-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-642"><a href="#cb54-642" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-643"><a href="#cb54-643" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: compute-portfolio-returns</span></span>
<span id="cb54-644"><a href="#cb54-644" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Compute EW and VW portfolio returns"</span></span>
<span id="cb54-645"><a href="#cb54-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-646"><a href="#cb54-646" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_portfolio_returns(data, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb54-647"><a href="#cb54-647" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Compute equal- and value-weighted monthly returns."""</span></span>
<span id="cb54-648"><a href="#cb54-648" aria-hidden="true" tabindex="-1"></a>    ew <span class="op">=</span> data.groupby([<span class="st">"date"</span>, <span class="st">"portfolio"</span>]).agg(</span>
<span id="cb54-649"><a href="#cb54-649" aria-hidden="true" tabindex="-1"></a>        ew_ret<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="st">"mean"</span>), n_funds<span class="op">=</span>(<span class="st">"fund_id"</span>, <span class="st">"count"</span>)).reset_index()</span>
<span id="cb54-650"><a href="#cb54-650" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> vw_func(group):</span>
<span id="cb54-651"><a href="#cb54-651" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> group[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb54-652"><a href="#cb54-652" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.average(group[<span class="st">"net_return"</span>], weights<span class="op">=</span>w) <span class="cf">if</span> w.<span class="bu">sum</span>() <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> group[<span class="st">"net_return"</span>].mean()</span>
<span id="cb54-653"><a href="#cb54-653" aria-hidden="true" tabindex="-1"></a>    vw <span class="op">=</span> data.groupby([<span class="st">"date"</span>, <span class="st">"portfolio"</span>]).<span class="bu">apply</span>(vw_func, include_groups<span class="op">=</span><span class="va">False</span>).reset_index(name<span class="op">=</span><span class="st">"vw_ret"</span>)</span>
<span id="cb54-654"><a href="#cb54-654" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ew.merge(vw, on<span class="op">=</span>[<span class="st">"date"</span>, <span class="st">"portfolio"</span>], how<span class="op">=</span><span class="st">"left"</span>)</span>
<span id="cb54-655"><a href="#cb54-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-656"><a href="#cb54-656" aria-hidden="true" tabindex="-1"></a>port_returns <span class="op">=</span> compute_portfolio_returns(portfolio_data)</span>
<span id="cb54-657"><a href="#cb54-657" aria-hidden="true" tabindex="-1"></a>port_wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span>[<span class="st">"ew_ret"</span>, <span class="st">"vw_ret"</span>])</span>
<span id="cb54-658"><a href="#cb54-658" aria-hidden="true" tabindex="-1"></a>port_wide[(<span class="st">"ew_ret"</span>, <span class="st">"LS"</span>)] <span class="op">=</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb54-659"><a href="#cb54-659" aria-hidden="true" tabindex="-1"></a>port_wide[(<span class="st">"vw_ret"</span>, <span class="st">"LS"</span>)] <span class="op">=</span> port_wide[(<span class="st">"vw_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"vw_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb54-660"><a href="#cb54-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-661"><a href="#cb54-661" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"EW portfolio returns (annualized, %):"</span>)</span>
<span id="cb54-662"><a href="#cb54-662" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((port_wide[<span class="st">"ew_ret"</span>].mean() <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">2</span>).to_string())</span>
<span id="cb54-663"><a href="#cb54-663" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-664"><a href="#cb54-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-665"><a href="#cb54-665" aria-hidden="true" tabindex="-1"></a><span class="fu">## Characteristics of Return Gap Portfolios</span></span>
<span id="cb54-666"><a href="#cb54-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-669"><a href="#cb54-669" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-670"><a href="#cb54-670" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-portfolio-characteristics</span></span>
<span id="cb54-671"><a href="#cb54-671" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Characteristics of Return Gap-sorted decile portfolios."</span></span>
<span id="cb54-672"><a href="#cb54-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-673"><a href="#cb54-673" aria-hidden="true" tabindex="-1"></a>chars <span class="op">=</span> portfolio_data.groupby(<span class="st">"portfolio"</span>).agg(</span>
<span id="cb54-674"><a href="#cb54-674" aria-hidden="true" tabindex="-1"></a>    avg_rg<span class="op">=</span>(<span class="st">"return_gap"</span>, <span class="st">"mean"</span>), avg_rg12<span class="op">=</span>(<span class="st">"rg_12m_lag4"</span>, <span class="st">"mean"</span>),</span>
<span id="cb54-675"><a href="#cb54-675" aria-hidden="true" tabindex="-1"></a>    avg_net_ret<span class="op">=</span>(<span class="st">"net_return"</span>, <span class="st">"mean"</span>), avg_gross_ret<span class="op">=</span>(<span class="st">"gross_return"</span>, <span class="st">"mean"</span>),</span>
<span id="cb54-676"><a href="#cb54-676" aria-hidden="true" tabindex="-1"></a>    avg_hret<span class="op">=</span>(<span class="st">"hret"</span>, <span class="st">"mean"</span>), avg_expense<span class="op">=</span>(<span class="st">"expense_ratio"</span>, <span class="st">"mean"</span>),</span>
<span id="cb54-677"><a href="#cb54-677" aria-hidden="true" tabindex="-1"></a>    avg_tna<span class="op">=</span>(<span class="st">"tna"</span>, <span class="st">"mean"</span>), avg_nstocks<span class="op">=</span>(<span class="st">"n_stocks"</span>, <span class="st">"mean"</span>), n_obs<span class="op">=</span>(<span class="st">"fund_id"</span>, <span class="st">"count"</span>),</span>
<span id="cb54-678"><a href="#cb54-678" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb54-679"><a href="#cb54-679" aria-hidden="true" tabindex="-1"></a>dc <span class="op">=</span> chars.copy()</span>
<span id="cb54-680"><a href="#cb54-680" aria-hidden="true" tabindex="-1"></a>dc.columns <span class="op">=</span> [<span class="st">"Avg RG"</span>, <span class="st">"Avg RG(12m)"</span>, <span class="st">"Net Ret"</span>, <span class="st">"Gross Ret"</span>, <span class="st">"Hold Ret"</span>, <span class="st">"Expense"</span>, <span class="st">"TNA(Bn)"</span>, <span class="st">"#Stocks"</span>, <span class="st">"#Obs"</span>]</span>
<span id="cb54-681"><a href="#cb54-681" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"Avg RG"</span>, <span class="st">"Avg RG(12m)"</span>, <span class="st">"Net Ret"</span>, <span class="st">"Gross Ret"</span>, <span class="st">"Hold Ret"</span>, <span class="st">"Expense"</span>]:</span>
<span id="cb54-682"><a href="#cb54-682" aria-hidden="true" tabindex="-1"></a>    dc[col] <span class="op">=</span> (dc[col] <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb54-683"><a href="#cb54-683" aria-hidden="true" tabindex="-1"></a>dc[<span class="st">"TNA(Bn)"</span>] <span class="op">=</span> dc[<span class="st">"TNA(Bn)"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb54-684"><a href="#cb54-684" aria-hidden="true" tabindex="-1"></a>dc[<span class="st">"#Stocks"</span>] <span class="op">=</span> dc[<span class="st">"#Stocks"</span>].<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb54-685"><a href="#cb54-685" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(dc.to_string())</span>
<span id="cb54-686"><a href="#cb54-686" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-687"><a href="#cb54-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-688"><a href="#cb54-688" aria-hidden="true" tabindex="-1"></a><span class="fu">## Cumulative Returns of Extreme Portfolios</span></span>
<span id="cb54-689"><a href="#cb54-689" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-692"><a href="#cb54-692" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-693"><a href="#cb54-693" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-cumulative-returns</span></span>
<span id="cb54-694"><a href="#cb54-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Cumulative returns of Return Gap-sorted portfolios: P10 (highest RG) vs P1 (lowest), and the long-short spread."</span></span>
<span id="cb54-695"><a href="#cb54-695" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb54-696"><a href="#cb54-696" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb54-697"><a href="#cb54-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-698"><a href="#cb54-698" aria-hidden="true" tabindex="-1"></a>cum_ret <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>port_wide.index)</span>
<span id="cb54-699"><a href="#cb54-699" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"P1 (Low RG)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]).cumprod()</span>
<span id="cb54-700"><a href="#cb54-700" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"P10 (High RG)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)]).cumprod()</span>
<span id="cb54-701"><a href="#cb54-701" aria-hidden="true" tabindex="-1"></a>cum_ret[<span class="st">"L/S (P10-P1)"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="st">"LS"</span>)]).cumprod()</span>
<span id="cb54-702"><a href="#cb54-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-703"><a href="#cb54-703" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb54-704"><a href="#cb54-704" aria-hidden="true" tabindex="-1"></a>colors <span class="op">=</span> {<span class="st">"P1 (Low RG)"</span>: <span class="st">"#D32F2F"</span>, <span class="st">"P10 (High RG)"</span>: <span class="st">"#1B5E20"</span>, <span class="st">"L/S (P10-P1)"</span>: <span class="st">"#1565C0"</span>}</span>
<span id="cb54-705"><a href="#cb54-705" aria-hidden="true" tabindex="-1"></a>styles <span class="op">=</span> {<span class="st">"P1 (Low RG)"</span>: <span class="st">"--"</span>, <span class="st">"P10 (High RG)"</span>: <span class="st">"-"</span>, <span class="st">"L/S (P10-P1)"</span>: <span class="st">"-."</span>}</span>
<span id="cb54-706"><a href="#cb54-706" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> cum_ret.columns:</span>
<span id="cb54-707"><a href="#cb54-707" aria-hidden="true" tabindex="-1"></a>    ax.plot(cum_ret.index, cum_ret[col], label<span class="op">=</span>col, color<span class="op">=</span>colors[col], linestyle<span class="op">=</span>styles[col], linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb54-708"><a href="#cb54-708" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">1</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-709"><a href="#cb54-709" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Date"</span>)</span>
<span id="cb54-710"><a href="#cb54-710" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Cumulative Return (Growth of 1 VND)"</span>)</span>
<span id="cb54-711"><a href="#cb54-711" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Cumulative Performance of Return Gap Portfolios"</span>)</span>
<span id="cb54-712"><a href="#cb54-712" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>, loc<span class="op">=</span><span class="st">"upper left"</span>)</span>
<span id="cb54-713"><a href="#cb54-713" aria-hidden="true" tabindex="-1"></a>ax.set_yscale(<span class="st">"log"</span>)</span>
<span id="cb54-714"><a href="#cb54-714" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-715"><a href="#cb54-715" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-716"><a href="#cb54-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-717"><a href="#cb54-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-718"><a href="#cb54-718" aria-hidden="true" tabindex="-1"></a><span class="fu"># Risk-Adjusted Performance {#sec-return-gaprisk-adjusted}</span></span>
<span id="cb54-719"><a href="#cb54-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-720"><a href="#cb54-720" aria-hidden="true" tabindex="-1"></a><span class="fu">## Risk Factors</span></span>
<span id="cb54-721"><a href="#cb54-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-724"><a href="#cb54-724" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-725"><a href="#cb54-725" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: construct-risk-factors</span></span>
<span id="cb54-726"><a href="#cb54-726" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Generate Vietnamese market factor returns"</span></span>
<span id="cb54-727"><a href="#cb54-727" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-728"><a href="#cb54-728" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> generate_factor_returns(start_date<span class="op">=</span><span class="st">"2012-01-01"</span>, end_date<span class="op">=</span><span class="st">"2024-12-31"</span>):</span>
<span id="cb54-729"><a href="#cb54-729" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Generate simulated Vietnamese market factor returns."""</span></span>
<span id="cb54-730"><a href="#cb54-730" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> pd.date_range(start_date, end_date, freq<span class="op">=</span><span class="st">"ME"</span>)</span>
<span id="cb54-731"><a href="#cb54-731" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="bu">len</span>(dates)</span>
<span id="cb54-732"><a href="#cb54-732" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame({</span>
<span id="cb54-733"><a href="#cb54-733" aria-hidden="true" tabindex="-1"></a>        <span class="st">"date"</span>: dates,</span>
<span id="cb54-734"><a href="#cb54-734" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rf"</span>: np.random.normal(<span class="fl">0.004</span>, <span class="fl">0.001</span>, n).clip(<span class="fl">0.001</span>, <span class="fl">0.008</span>),</span>
<span id="cb54-735"><a href="#cb54-735" aria-hidden="true" tabindex="-1"></a>        <span class="st">"mkt_rf"</span>: np.random.normal(<span class="fl">0.008</span>, <span class="fl">0.055</span>, n),</span>
<span id="cb54-736"><a href="#cb54-736" aria-hidden="true" tabindex="-1"></a>        <span class="st">"smb"</span>: np.random.normal(<span class="fl">0.003</span>, <span class="fl">0.035</span>, n),</span>
<span id="cb54-737"><a href="#cb54-737" aria-hidden="true" tabindex="-1"></a>        <span class="st">"hml"</span>: np.random.normal(<span class="fl">0.002</span>, <span class="fl">0.030</span>, n),</span>
<span id="cb54-738"><a href="#cb54-738" aria-hidden="true" tabindex="-1"></a>        <span class="st">"umd"</span>: np.random.normal(<span class="fl">0.005</span>, <span class="fl">0.045</span>, n),</span>
<span id="cb54-739"><a href="#cb54-739" aria-hidden="true" tabindex="-1"></a>        <span class="st">"rmw"</span>: np.random.normal(<span class="fl">0.002</span>, <span class="fl">0.025</span>, n),</span>
<span id="cb54-740"><a href="#cb54-740" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cma"</span>: np.random.normal(<span class="fl">0.001</span>, <span class="fl">0.020</span>, n),</span>
<span id="cb54-741"><a href="#cb54-741" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb54-742"><a href="#cb54-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-743"><a href="#cb54-743" aria-hidden="true" tabindex="-1"></a>factors <span class="op">=</span> generate_factor_returns()</span>
<span id="cb54-744"><a href="#cb54-744" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Factor summary (monthly %):"</span>)</span>
<span id="cb54-745"><a href="#cb54-745" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>((factors.drop(columns<span class="op">=</span><span class="st">"date"</span>).describe() <span class="op">*</span> <span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb54-746"><a href="#cb54-746" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-747"><a href="#cb54-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-748"><a href="#cb54-748" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alpha Estimation</span></span>
<span id="cb54-749"><a href="#cb54-749" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-752"><a href="#cb54-752" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-753"><a href="#cb54-753" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: estimate-alphas</span></span>
<span id="cb54-754"><a href="#cb54-754" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Estimate risk-adjusted alphas with Newey-West SEs"</span></span>
<span id="cb54-755"><a href="#cb54-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-756"><a href="#cb54-756" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_portfolio_alphas(port_returns, factors, n_portfolios<span class="op">=</span><span class="dv">10</span>, nw_lags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb54-757"><a href="#cb54-757" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Estimate alphas using multiple factor models."""</span></span>
<span id="cb54-758"><a href="#cb54-758" aria-hidden="true" tabindex="-1"></a>    ew_wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb54-759"><a href="#cb54-759" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_portfolios <span class="kw">in</span> ew_wide.columns <span class="kw">and</span> <span class="dv">1</span> <span class="kw">in</span> ew_wide.columns:</span>
<span id="cb54-760"><a href="#cb54-760" aria-hidden="true" tabindex="-1"></a>        ew_wide[<span class="st">"LS"</span>] <span class="op">=</span> ew_wide[n_portfolios] <span class="op">-</span> ew_wide[<span class="dv">1</span>]</span>
<span id="cb54-761"><a href="#cb54-761" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> ew_wide.merge(factors, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb54-762"><a href="#cb54-762" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb54-763"><a href="#cb54-763" aria-hidden="true" tabindex="-1"></a>    portfolios <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">1</span>, n_portfolios <span class="op">+</span> <span class="dv">1</span>)) <span class="op">+</span> [<span class="st">"LS"</span>]</span>
<span id="cb54-764"><a href="#cb54-764" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> port <span class="kw">in</span> portfolios:</span>
<span id="cb54-765"><a href="#cb54-765" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> port <span class="kw">not</span> <span class="kw">in</span> merged.columns: <span class="cf">continue</span></span>
<span id="cb54-766"><a href="#cb54-766" aria-hidden="true" tabindex="-1"></a>        y_raw <span class="op">=</span> merged[port].dropna()</span>
<span id="cb54-767"><a href="#cb54-767" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> y_raw.index</span>
<span id="cb54-768"><a href="#cb54-768" aria-hidden="true" tabindex="-1"></a>        rf <span class="op">=</span> merged.loc[idx, <span class="st">"rf"</span>]<span class="op">;</span> mkt <span class="op">=</span> merged.loc[idx, <span class="st">"mkt_rf"</span>]</span>
<span id="cb54-769"><a href="#cb54-769" aria-hidden="true" tabindex="-1"></a>        smb <span class="op">=</span> merged.loc[idx, <span class="st">"smb"</span>]<span class="op">;</span> hml <span class="op">=</span> merged.loc[idx, <span class="st">"hml"</span>]</span>
<span id="cb54-770"><a href="#cb54-770" aria-hidden="true" tabindex="-1"></a>        umd <span class="op">=</span> merged.loc[idx, <span class="st">"umd"</span>]<span class="op">;</span> rmw <span class="op">=</span> merged.loc[idx, <span class="st">"rmw"</span>]</span>
<span id="cb54-771"><a href="#cb54-771" aria-hidden="true" tabindex="-1"></a>        cma <span class="op">=</span> merged.loc[idx, <span class="st">"cma"</span>]</span>
<span id="cb54-772"><a href="#cb54-772" aria-hidden="true" tabindex="-1"></a>        y_ex <span class="op">=</span> y_raw <span class="op">-</span> rf</span>
<span id="cb54-773"><a href="#cb54-773" aria-hidden="true" tabindex="-1"></a>        models <span class="op">=</span> {</span>
<span id="cb54-774"><a href="#cb54-774" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Raw Mean"</span>: (y_raw, <span class="va">None</span>),</span>
<span id="cb54-775"><a href="#cb54-775" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Excess Return"</span>: (y_raw <span class="op">-</span> rf <span class="op">-</span> mkt, <span class="va">None</span>),</span>
<span id="cb54-776"><a href="#cb54-776" aria-hidden="true" tabindex="-1"></a>            <span class="st">"CAPM"</span>: (y_ex, sm.add_constant(mkt)),</span>
<span id="cb54-777"><a href="#cb54-777" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FF3"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb54-778"><a href="#cb54-778" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Carhart"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml, umd], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb54-779"><a href="#cb54-779" aria-hidden="true" tabindex="-1"></a>            <span class="st">"FF5"</span>: (y_ex, sm.add_constant(pd.concat([mkt, smb, hml, rmw, cma], axis<span class="op">=</span><span class="dv">1</span>))),</span>
<span id="cb54-780"><a href="#cb54-780" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb54-781"><a href="#cb54-781" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> mname, (y, X) <span class="kw">in</span> models.items():</span>
<span id="cb54-782"><a href="#cb54-782" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> X <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb54-783"><a href="#cb54-783" aria-hidden="true" tabindex="-1"></a>                mean_val <span class="op">=</span> y.mean()<span class="op">;</span> se <span class="op">=</span> y.std() <span class="op">/</span> np.sqrt(<span class="bu">len</span>(y))</span>
<span id="cb54-784"><a href="#cb54-784" aria-hidden="true" tabindex="-1"></a>                t_stat <span class="op">=</span> mean_val <span class="op">/</span> se <span class="cf">if</span> se <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb54-785"><a href="#cb54-785" aria-hidden="true" tabindex="-1"></a>                p_val <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), <span class="bu">len</span>(y)<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb54-786"><a href="#cb54-786" aria-hidden="true" tabindex="-1"></a>                alpha <span class="op">=</span> mean_val</span>
<span id="cb54-787"><a href="#cb54-787" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb54-788"><a href="#cb54-788" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb54-789"><a href="#cb54-789" aria-hidden="true" tabindex="-1"></a>                    reg <span class="op">=</span> OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: nw_lags})</span>
<span id="cb54-790"><a href="#cb54-790" aria-hidden="true" tabindex="-1"></a>                    alpha <span class="op">=</span> reg.params.iloc[<span class="dv">0</span>]<span class="op">;</span> t_stat <span class="op">=</span> reg.tvalues.iloc[<span class="dv">0</span>]<span class="op">;</span> p_val <span class="op">=</span> reg.pvalues.iloc[<span class="dv">0</span>]</span>
<span id="cb54-791"><a href="#cb54-791" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span>: alpha, t_stat, p_val <span class="op">=</span> np.nan, np.nan, np.nan</span>
<span id="cb54-792"><a href="#cb54-792" aria-hidden="true" tabindex="-1"></a>            results.append({<span class="st">"portfolio"</span>: port, <span class="st">"model"</span>: mname, <span class="st">"alpha"</span>: alpha, <span class="st">"t_stat"</span>: t_stat, <span class="st">"p_value"</span>: p_val})</span>
<span id="cb54-793"><a href="#cb54-793" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb54-794"><a href="#cb54-794" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-795"><a href="#cb54-795" aria-hidden="true" tabindex="-1"></a>alpha_results <span class="op">=</span> estimate_portfolio_alphas(port_returns, factors, n_portfolios)</span>
<span id="cb54-796"><a href="#cb54-796" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Alpha estimates: </span><span class="sc">{</span><span class="bu">len</span>(alpha_results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-797"><a href="#cb54-797" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-798"><a href="#cb54-798" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-799"><a href="#cb54-799" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alpha Table</span></span>
<span id="cb54-800"><a href="#cb54-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-803"><a href="#cb54-803" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-804"><a href="#cb54-804" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-alphas</span></span>
<span id="cb54-805"><a href="#cb54-805" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Risk-adjusted monthly alphas (%) for Return Gap decile portfolios. t-stats (NW, 6 lags) in parentheses."</span></span>
<span id="cb54-806"><a href="#cb54-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-807"><a href="#cb54-807" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stars(p):</span>
<span id="cb54-808"><a href="#cb54-808" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(p): <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb54-809"><a href="#cb54-809" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.01</span>: <span class="cf">return</span> <span class="st">"***"</span></span>
<span id="cb54-810"><a href="#cb54-810" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.05</span>: <span class="cf">return</span> <span class="st">"**"</span></span>
<span id="cb54-811"><a href="#cb54-811" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> p <span class="op">&lt;</span> <span class="fl">0.10</span>: <span class="cf">return</span> <span class="st">"*"</span></span>
<span id="cb54-812"><a href="#cb54-812" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">""</span></span>
<span id="cb54-813"><a href="#cb54-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-814"><a href="#cb54-814" aria-hidden="true" tabindex="-1"></a>models_list <span class="op">=</span> [<span class="st">"Raw Mean"</span>, <span class="st">"Excess Return"</span>, <span class="st">"CAPM"</span>, <span class="st">"FF3"</span>, <span class="st">"Carhart"</span>, <span class="st">"FF5"</span>]</span>
<span id="cb54-815"><a href="#cb54-815" aria-hidden="true" tabindex="-1"></a>rows <span class="op">=</span> []</span>
<span id="cb54-816"><a href="#cb54-816" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> models_list:</span>
<span id="cb54-817"><a href="#cb54-817" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> alpha_results.loc[alpha_results[<span class="st">"model"</span>] <span class="op">==</span> model]</span>
<span id="cb54-818"><a href="#cb54-818" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> md.iterrows():</span>
<span id="cb54-819"><a href="#cb54-819" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> row[<span class="st">"alpha"</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb54-820"><a href="#cb54-820" aria-hidden="true" tabindex="-1"></a>        rows.append({<span class="st">"Portfolio"</span>: row[<span class="st">"portfolio"</span>], <span class="st">"Model"</span>: model,</span>
<span id="cb54-821"><a href="#cb54-821" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"Alpha (%)"</span>: <span class="ss">f"</span><span class="sc">{</span>a<span class="sc">:.3f}{</span>stars(row[<span class="st">'p_value'</span>])<span class="sc">}</span><span class="ss">"</span>, <span class="st">"t-stat"</span>: <span class="ss">f"(</span><span class="sc">{</span>row[<span class="st">'t_stat'</span>]<span class="sc">:.2f}</span><span class="ss">)"</span>})</span>
<span id="cb54-822"><a href="#cb54-822" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> pd.DataFrame(rows).pivot_table(index<span class="op">=</span><span class="st">"Portfolio"</span>, columns<span class="op">=</span><span class="st">"Model"</span>, values<span class="op">=</span><span class="st">"Alpha (%)"</span>, aggfunc<span class="op">=</span><span class="st">"first"</span>)</span>
<span id="cb54-823"><a href="#cb54-823" aria-hidden="true" tabindex="-1"></a>pivot <span class="op">=</span> pivot.reindex(columns<span class="op">=</span>models_list)</span>
<span id="cb54-824"><a href="#cb54-824" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pivot.to_string())</span>
<span id="cb54-825"><a href="#cb54-825" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-826"><a href="#cb54-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-827"><a href="#cb54-827" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alpha Plot</span></span>
<span id="cb54-828"><a href="#cb54-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-831"><a href="#cb54-831" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-832"><a href="#cb54-832" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-alpha-plot</span></span>
<span id="cb54-833"><a href="#cb54-833" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Risk-adjusted alphas of Return Gap-sorted decile portfolios under different factor models."</span></span>
<span id="cb54-834"><a href="#cb54-834" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb54-835"><a href="#cb54-835" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 7</span></span>
<span id="cb54-836"><a href="#cb54-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-837"><a href="#cb54-837" aria-hidden="true" tabindex="-1"></a>models_plot <span class="op">=</span> [<span class="st">"Excess Return"</span>, <span class="st">"CAPM"</span>, <span class="st">"FF3"</span>, <span class="st">"Carhart"</span>, <span class="st">"FF5"</span>]</span>
<span id="cb54-838"><a href="#cb54-838" aria-hidden="true" tabindex="-1"></a>colors_m <span class="op">=</span> {<span class="st">"Excess Return"</span>: <span class="st">"#D32F2F"</span>, <span class="st">"CAPM"</span>: <span class="st">"#FF8F00"</span>, <span class="st">"FF3"</span>: <span class="st">"#1B5E20"</span>, <span class="st">"Carhart"</span>: <span class="st">"#1565C0"</span>, <span class="st">"FF5"</span>: <span class="st">"#6A1B9A"</span>}</span>
<span id="cb54-839"><a href="#cb54-839" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-840"><a href="#cb54-840" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">7</span>))</span>
<span id="cb54-841"><a href="#cb54-841" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> model <span class="kw">in</span> models_plot:</span>
<span id="cb54-842"><a href="#cb54-842" aria-hidden="true" tabindex="-1"></a>    md <span class="op">=</span> alpha_results.loc[(alpha_results[<span class="st">"model"</span>]<span class="op">==</span>model) <span class="op">&amp;</span> (alpha_results[<span class="st">"portfolio"</span>]<span class="op">!=</span><span class="st">"LS"</span>)].sort_values(<span class="st">"portfolio"</span>)</span>
<span id="cb54-843"><a href="#cb54-843" aria-hidden="true" tabindex="-1"></a>    ax.plot(md[<span class="st">"portfolio"</span>], md[<span class="st">"alpha"</span>]<span class="op">*</span><span class="dv">100</span>, marker<span class="op">=</span><span class="st">"o"</span>, linewidth<span class="op">=</span><span class="fl">2.5</span>, markersize<span class="op">=</span><span class="dv">8</span>, label<span class="op">=</span>model, color<span class="op">=</span>colors_m[model])</span>
<span id="cb54-844"><a href="#cb54-844" aria-hidden="true" tabindex="-1"></a>ax.axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-845"><a href="#cb54-845" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Return Gap Portfolio (1=Lowest, 10=Highest)"</span>)</span>
<span id="cb54-846"><a href="#cb54-846" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">"Monthly Alpha (%)"</span>)</span>
<span id="cb54-847"><a href="#cb54-847" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Abnormal Returns of Return Gap-Sorted Portfolios</span><span class="ch">\n</span><span class="st">Vietnamese Domestic Equity Funds"</span>)</span>
<span id="cb54-848"><a href="#cb54-848" aria-hidden="true" tabindex="-1"></a>ax.legend(frameon<span class="op">=</span><span class="va">True</span>, title<span class="op">=</span><span class="st">"Risk Model"</span>)</span>
<span id="cb54-849"><a href="#cb54-849" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">11</span>))</span>
<span id="cb54-850"><a href="#cb54-850" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-851"><a href="#cb54-851" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-852"><a href="#cb54-852" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-853"><a href="#cb54-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-854"><a href="#cb54-854" aria-hidden="true" tabindex="-1"></a><span class="fu">## Long-Short Portfolio Analysis</span></span>
<span id="cb54-855"><a href="#cb54-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-858"><a href="#cb54-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-859"><a href="#cb54-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-long-short</span></span>
<span id="cb54-860"><a href="#cb54-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Performance of the long-short Return Gap strategy (P10 minus P1)."</span></span>
<span id="cb54-861"><a href="#cb54-861" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-862"><a href="#cb54-862" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> long_short_analysis(port_returns, factors, n_portfolios<span class="op">=</span><span class="dv">10</span>):</span>
<span id="cb54-863"><a href="#cb54-863" aria-hidden="true" tabindex="-1"></a>    wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb54-864"><a href="#cb54-864" aria-hidden="true" tabindex="-1"></a>    ls <span class="op">=</span> (wide[n_portfolios] <span class="op">-</span> wide[<span class="dv">1</span>]).dropna()</span>
<span id="cb54-865"><a href="#cb54-865" aria-hidden="true" tabindex="-1"></a>    merged <span class="op">=</span> pd.DataFrame({<span class="st">"ls_ret"</span>: ls}).merge(factors, on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb54-866"><a href="#cb54-866" aria-hidden="true" tabindex="-1"></a>    ann_ret <span class="op">=</span> ls.mean() <span class="op">*</span> <span class="dv">12</span><span class="op">;</span> ann_vol <span class="op">=</span> ls.std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb54-867"><a href="#cb54-867" aria-hidden="true" tabindex="-1"></a>    sharpe <span class="op">=</span> ann_ret <span class="op">/</span> ann_vol <span class="cf">if</span> ann_vol <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb54-868"><a href="#cb54-868" aria-hidden="true" tabindex="-1"></a>    cum <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> ls).cumprod()<span class="op">;</span> max_dd <span class="op">=</span> (cum <span class="op">/</span> cum.cummax() <span class="op">-</span> <span class="dv">1</span>).<span class="bu">min</span>()</span>
<span id="cb54-869"><a href="#cb54-869" aria-hidden="true" tabindex="-1"></a>    sd <span class="op">=</span> {<span class="st">"Ann. Return (%)"</span>: ann_ret<span class="op">*</span><span class="dv">100</span>, <span class="st">"Ann. Volatility (%)"</span>: ann_vol<span class="op">*</span><span class="dv">100</span>, <span class="st">"Sharpe Ratio"</span>: sharpe,</span>
<span id="cb54-870"><a href="#cb54-870" aria-hidden="true" tabindex="-1"></a>          <span class="st">"Max Drawdown (%)"</span>: max_dd<span class="op">*</span><span class="dv">100</span>, <span class="st">"% Positive Months"</span>: (ls<span class="op">&gt;</span><span class="dv">0</span>).mean()<span class="op">*</span><span class="dv">100</span>}</span>
<span id="cb54-871"><a href="#cb54-871" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> merged[<span class="st">"ls_ret"</span>] <span class="op">-</span> merged[<span class="st">"rf"</span>]</span>
<span id="cb54-872"><a href="#cb54-872" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> mn, fc <span class="kw">in</span> {<span class="st">"CAPM"</span>:[<span class="st">"mkt_rf"</span>],<span class="st">"FF3"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>],<span class="st">"Carhart"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>,<span class="st">"umd"</span>],</span>
<span id="cb54-873"><a href="#cb54-873" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"FF5"</span>:[<span class="st">"mkt_rf"</span>,<span class="st">"smb"</span>,<span class="st">"hml"</span>,<span class="st">"rmw"</span>,<span class="st">"cma"</span>]}.items():</span>
<span id="cb54-874"><a href="#cb54-874" aria-hidden="true" tabindex="-1"></a>        X <span class="op">=</span> sm.add_constant(merged[fc])</span>
<span id="cb54-875"><a href="#cb54-875" aria-hidden="true" tabindex="-1"></a>        reg <span class="op">=</span> OLS(y, X).fit(cov_type<span class="op">=</span><span class="st">"HAC"</span>, cov_kwds<span class="op">=</span>{<span class="st">"maxlags"</span>: <span class="dv">6</span>})</span>
<span id="cb54-876"><a href="#cb54-876" aria-hidden="true" tabindex="-1"></a>        sd[<span class="ss">f"</span><span class="sc">{</span>mn<span class="sc">}</span><span class="ss"> Alpha (%ann.)"</span>] <span class="op">=</span> reg.params.iloc[<span class="dv">0</span>]<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span></span>
<span id="cb54-877"><a href="#cb54-877" aria-hidden="true" tabindex="-1"></a>        sd[<span class="ss">f"</span><span class="sc">{</span>mn<span class="sc">}</span><span class="ss"> t-stat"</span>] <span class="op">=</span> reg.tvalues.iloc[<span class="dv">0</span>]</span>
<span id="cb54-878"><a href="#cb54-878" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(<span class="bu">list</span>(sd.items()), columns<span class="op">=</span>[<span class="st">"Statistic"</span>, <span class="st">"Value"</span>]).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb54-879"><a href="#cb54-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-880"><a href="#cb54-880" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(long_short_analysis(port_returns, factors).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb54-881"><a href="#cb54-881" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-882"><a href="#cb54-882" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-883"><a href="#cb54-883" aria-hidden="true" tabindex="-1"></a><span class="fu"># Cross-Sectional Determinants {#sec-return-gapdeterminants}</span></span>
<span id="cb54-884"><a href="#cb54-884" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-885"><a href="#cb54-885" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fama-MacBeth Regressions</span></span>
<span id="cb54-886"><a href="#cb54-886" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-887"><a href="#cb54-887" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-888"><a href="#cb54-888" aria-hidden="true" tabindex="-1"></a>\text{RG}_{i,t} = \gamma_0 + \gamma_1 \text{Size}_{i,t-1} + \gamma_2 \text{Expense}_{i,t} + \gamma_3 \text{NStocks}_{i,t} + \epsilon_{i,t}</span>
<span id="cb54-889"><a href="#cb54-889" aria-hidden="true" tabindex="-1"></a>$$ {#eq-fama-macbeth}</span>
<span id="cb54-890"><a href="#cb54-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-893"><a href="#cb54-893" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-894"><a href="#cb54-894" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fama-macbeth</span></span>
<span id="cb54-895"><a href="#cb54-895" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Fama-MacBeth cross-sectional regression"</span></span>
<span id="cb54-896"><a href="#cb54-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-897"><a href="#cb54-897" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fama_macbeth_regression(data, y_var, x_vars, nw_lags<span class="op">=</span><span class="dv">6</span>):</span>
<span id="cb54-898"><a href="#cb54-898" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Fama-MacBeth (1973) regression with Newey-West SEs."""</span></span>
<span id="cb54-899"><a href="#cb54-899" aria-hidden="true" tabindex="-1"></a>    dates <span class="op">=</span> <span class="bu">sorted</span>(data[<span class="st">"date"</span>].unique())</span>
<span id="cb54-900"><a href="#cb54-900" aria-hidden="true" tabindex="-1"></a>    all_coefs <span class="op">=</span> []</span>
<span id="cb54-901"><a href="#cb54-901" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> d <span class="kw">in</span> dates:</span>
<span id="cb54-902"><a href="#cb54-902" aria-hidden="true" tabindex="-1"></a>        cross <span class="op">=</span> data.loc[data[<span class="st">"date"</span>]<span class="op">==</span>d, [y_var]<span class="op">+</span>x_vars].dropna()</span>
<span id="cb54-903"><a href="#cb54-903" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(cross) <span class="op">&lt;</span> <span class="dv">10</span>: <span class="cf">continue</span></span>
<span id="cb54-904"><a href="#cb54-904" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb54-905"><a href="#cb54-905" aria-hidden="true" tabindex="-1"></a>            reg <span class="op">=</span> OLS(cross[y_var], sm.add_constant(cross[x_vars])).fit()</span>
<span id="cb54-906"><a href="#cb54-906" aria-hidden="true" tabindex="-1"></a>            coefs <span class="op">=</span> reg.params.to_dict()<span class="op">;</span> coefs[<span class="st">"date"</span>] <span class="op">=</span> d<span class="op">;</span> all_coefs.append(coefs)</span>
<span id="cb54-907"><a href="#cb54-907" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span>: <span class="cf">continue</span></span>
<span id="cb54-908"><a href="#cb54-908" aria-hidden="true" tabindex="-1"></a>    coef_df <span class="op">=</span> pd.DataFrame(all_coefs).set_index(<span class="st">"date"</span>)</span>
<span id="cb54-909"><a href="#cb54-909" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb54-910"><a href="#cb54-910" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> [<span class="st">"const"</span>] <span class="op">+</span> x_vars:</span>
<span id="cb54-911"><a href="#cb54-911" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> coef_df[col].dropna()<span class="op">;</span> mean <span class="op">=</span> s.mean()<span class="op">;</span> T <span class="op">=</span> <span class="bu">len</span>(s)</span>
<span id="cb54-912"><a href="#cb54-912" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> s <span class="op">-</span> mean<span class="op">;</span> v0 <span class="op">=</span> (g<span class="op">**</span><span class="dv">2</span>).mean()</span>
<span id="cb54-913"><a href="#cb54-913" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, nw_lags<span class="op">+</span><span class="dv">1</span>):</span>
<span id="cb54-914"><a href="#cb54-914" aria-hidden="true" tabindex="-1"></a>            w <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> lag<span class="op">/</span>(nw_lags<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb54-915"><a href="#cb54-915" aria-hidden="true" tabindex="-1"></a>            v0 <span class="op">+=</span> <span class="dv">2</span><span class="op">*</span>w<span class="op">*</span>(g.iloc[lag:].values<span class="op">*</span>g.iloc[:<span class="op">-</span>lag].values).mean()</span>
<span id="cb54-916"><a href="#cb54-916" aria-hidden="true" tabindex="-1"></a>        se <span class="op">=</span> np.sqrt(v0<span class="op">/</span>T)<span class="op">;</span> t <span class="op">=</span> mean<span class="op">/</span>se <span class="cf">if</span> se<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan</span>
<span id="cb54-917"><a href="#cb54-917" aria-hidden="true" tabindex="-1"></a>        results.append({<span class="st">"Variable"</span>: col, <span class="st">"Coeff"</span>: <span class="ss">f"</span><span class="sc">{</span>mean<span class="sc">:.6f}</span><span class="ss">"</span>, <span class="st">"NW SE"</span>: <span class="ss">f"</span><span class="sc">{</span>se<span class="sc">:.6f}</span><span class="ss">"</span>,</span>
<span id="cb54-918"><a href="#cb54-918" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"t-stat"</span>: <span class="ss">f"</span><span class="sc">{</span>t<span class="sc">:.3f}</span><span class="ss">"</span>, <span class="st">"p-value"</span>: <span class="ss">f"</span><span class="sc">{</span><span class="dv">2</span><span class="op">*</span>(<span class="dv">1</span><span class="op">-</span>stats.t.cdf(<span class="bu">abs</span>(t),T<span class="op">-</span><span class="dv">1</span>))<span class="sc">:.4f}</span><span class="ss">"</span>})</span>
<span id="cb54-919"><a href="#cb54-919" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb54-920"><a href="#cb54-920" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-921"><a href="#cb54-921" aria-hidden="true" tabindex="-1"></a>reg_data <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb54-922"><a href="#cb54-922" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(reg_data[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb54-923"><a href="#cb54-923" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"log_nstocks"</span>] <span class="op">=</span> np.log(reg_data[<span class="st">"n_stocks"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb54-924"><a href="#cb54-924" aria-hidden="true" tabindex="-1"></a>reg_data[<span class="st">"expense_pct"</span>] <span class="op">=</span> reg_data[<span class="st">"expense_ratio"</span>] <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb54-925"><a href="#cb54-925" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-926"><a href="#cb54-926" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth: Determinants of Return Gap"</span>)</span>
<span id="cb54-927"><a href="#cb54-927" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb54-928"><a href="#cb54-928" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fama_macbeth_regression(reg_data, <span class="st">"return_gap"</span>, [<span class="st">"log_tna"</span>,<span class="st">"expense_pct"</span>,<span class="st">"log_nstocks"</span>]).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb54-929"><a href="#cb54-929" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-930"><a href="#cb54-930" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-931"><a href="#cb54-931" aria-hidden="true" tabindex="-1"></a><span class="fu"># Persistence {#sec-return-gappersistence}</span></span>
<span id="cb54-932"><a href="#cb54-932" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-935"><a href="#cb54-935" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-936"><a href="#cb54-936" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-transition-heatmap</span></span>
<span id="cb54-937"><a href="#cb54-937" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Return Gap quintile transition probability matrix (12-month horizon)."</span></span>
<span id="cb54-938"><a href="#cb54-938" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 8</span></span>
<span id="cb54-939"><a href="#cb54-939" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 6</span></span>
<span id="cb54-940"><a href="#cb54-940" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-941"><a href="#cb54-941" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_transition_matrix(data, n_groups<span class="op">=</span><span class="dv">5</span>, sort_var<span class="op">=</span><span class="st">"rg_12m_lag4"</span>, horizon<span class="op">=</span><span class="dv">12</span>):</span>
<span id="cb54-942"><a href="#cb54-942" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> data.dropna(subset<span class="op">=</span>[sort_var]).copy()</span>
<span id="cb54-943"><a href="#cb54-943" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"quintile"</span>] <span class="op">=</span> df.groupby(<span class="st">"date"</span>)[sort_var].transform(</span>
<span id="cb54-944"><a href="#cb54-944" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, n_groups, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>) <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb54-945"><a href="#cb54-945" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.sort_values([<span class="st">"fund_id"</span>,<span class="st">"date"</span>])</span>
<span id="cb54-946"><a href="#cb54-946" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"future_q"</span>] <span class="op">=</span> df.groupby(<span class="st">"fund_id"</span>)[<span class="st">"quintile"</span>].shift(<span class="op">-</span>horizon)</span>
<span id="cb54-947"><a href="#cb54-947" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.dropna(subset<span class="op">=</span>[<span class="st">"future_q"</span>])</span>
<span id="cb54-948"><a href="#cb54-948" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"future_q"</span>] <span class="op">=</span> df[<span class="st">"future_q"</span>].astype(<span class="bu">int</span>)</span>
<span id="cb54-949"><a href="#cb54-949" aria-hidden="true" tabindex="-1"></a>    trans <span class="op">=</span> pd.crosstab(df[<span class="st">"quintile"</span>], df[<span class="st">"future_q"</span>], normalize<span class="op">=</span><span class="st">"index"</span>) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb54-950"><a href="#cb54-950" aria-hidden="true" tabindex="-1"></a>    trans.index.name <span class="op">=</span> <span class="st">"Current Q"</span><span class="op">;</span> trans.columns.name <span class="op">=</span> <span class="st">"Future Q"</span></span>
<span id="cb54-951"><a href="#cb54-951" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> trans.<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb54-952"><a href="#cb54-952" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-953"><a href="#cb54-953" aria-hidden="true" tabindex="-1"></a>trans <span class="op">=</span> compute_transition_matrix(return_gap_data)</span>
<span id="cb54-954"><a href="#cb54-954" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb54-955"><a href="#cb54-955" aria-hidden="true" tabindex="-1"></a>sns.heatmap(trans, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">".1f"</span>, cmap<span class="op">=</span><span class="st">"YlGnBu"</span>, linewidths<span class="op">=</span><span class="dv">1</span>, linecolor<span class="op">=</span><span class="st">"white"</span>,</span>
<span id="cb54-956"><a href="#cb54-956" aria-hidden="true" tabindex="-1"></a>            cbar_kws<span class="op">=</span>{<span class="st">"label"</span>: <span class="st">"Probability (%)"</span>}, ax<span class="op">=</span>ax)</span>
<span id="cb54-957"><a href="#cb54-957" aria-hidden="true" tabindex="-1"></a>ax.set_xlabel(<span class="st">"Future Quintile (t+12m)"</span>)<span class="op">;</span> ax.set_ylabel(<span class="st">"Current Quintile (t)"</span>)</span>
<span id="cb54-958"><a href="#cb54-958" aria-hidden="true" tabindex="-1"></a>ax.set_title(<span class="st">"Return Gap Quintile Transition Probabilities"</span>)</span>
<span id="cb54-959"><a href="#cb54-959" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-960"><a href="#cb54-960" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-961"><a href="#cb54-961" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-962"><a href="#cb54-962" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-963"><a href="#cb54-963" aria-hidden="true" tabindex="-1"></a><span class="fu"># Robustness Checks {#sec-return-gaprobustness}</span></span>
<span id="cb54-964"><a href="#cb54-964" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-965"><a href="#cb54-965" aria-hidden="true" tabindex="-1"></a><span class="fu">## Alternative Holding Periods</span></span>
<span id="cb54-966"><a href="#cb54-966" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-969"><a href="#cb54-969" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-970"><a href="#cb54-970" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-robustness</span></span>
<span id="cb54-971"><a href="#cb54-971" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Long-short strategy under different maximum holding periods."</span></span>
<span id="cb54-972"><a href="#cb54-972" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-973"><a href="#cb54-973" aria-hidden="true" tabindex="-1"></a>hp_results <span class="op">=</span> {}</span>
<span id="cb54-974"><a href="#cb54-974" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> hp <span class="kw">in</span> [<span class="dv">3</span>, <span class="dv">6</span>, <span class="dv">9</span>]:</span>
<span id="cb54-975"><a href="#cb54-975" aria-hidden="true" tabindex="-1"></a>    hv <span class="op">=</span> prepare_holdings_vintages(holdings_raw, max_holding_months<span class="op">=</span>hp)</span>
<span id="cb54-976"><a href="#cb54-976" aria-hidden="true" tabindex="-1"></a>    ha <span class="op">=</span> adjust_holdings_shares(hv, stock_data)</span>
<span id="cb54-977"><a href="#cb54-977" aria-hidden="true" tabindex="-1"></a>    hr <span class="op">=</span> compute_holdings_returns(ha, stock_data)</span>
<span id="cb54-978"><a href="#cb54-978" aria-hidden="true" tabindex="-1"></a>    rg <span class="op">=</span> compute_return_gap(hr, fund_ret_clean)</span>
<span id="cb54-979"><a href="#cb54-979" aria-hidden="true" tabindex="-1"></a>    pd_data <span class="op">=</span> form_return_gap_portfolios(rg)</span>
<span id="cb54-980"><a href="#cb54-980" aria-hidden="true" tabindex="-1"></a>    pr <span class="op">=</span> compute_portfolio_returns(pd_data)</span>
<span id="cb54-981"><a href="#cb54-981" aria-hidden="true" tabindex="-1"></a>    pw <span class="op">=</span> pr.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb54-982"><a href="#cb54-982" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="dv">10</span> <span class="kw">in</span> pw.columns <span class="kw">and</span> <span class="dv">1</span> <span class="kw">in</span> pw.columns:</span>
<span id="cb54-983"><a href="#cb54-983" aria-hidden="true" tabindex="-1"></a>        ls <span class="op">=</span> pw[<span class="dv">10</span>] <span class="op">-</span> pw[<span class="dv">1</span>]</span>
<span id="cb54-984"><a href="#cb54-984" aria-hidden="true" tabindex="-1"></a>        hp_results[hp] <span class="op">=</span> {<span class="st">"Ann.Ret(%)"</span>: ls.mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb54-985"><a href="#cb54-985" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Sharpe"</span>: ls.mean()<span class="op">/</span>ls.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ls.std()<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan, <span class="st">"#Months"</span>: <span class="bu">len</span>(ls.dropna())}</span>
<span id="cb54-986"><a href="#cb54-986" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-987"><a href="#cb54-987" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(hp_results).T.<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb54-988"><a href="#cb54-988" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-989"><a href="#cb54-989" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-990"><a href="#cb54-990" aria-hidden="true" tabindex="-1"></a><span class="fu">## Subperiod Analysis</span></span>
<span id="cb54-991"><a href="#cb54-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-994"><a href="#cb54-994" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-995"><a href="#cb54-995" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-subperiod</span></span>
<span id="cb54-996"><a href="#cb54-996" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Subperiod analysis of the long-short strategy."</span></span>
<span id="cb54-997"><a href="#cb54-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-998"><a href="#cb54-998" aria-hidden="true" tabindex="-1"></a>wide <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb54-999"><a href="#cb54-999" aria-hidden="true" tabindex="-1"></a>ls <span class="op">=</span> (wide[n_portfolios] <span class="op">-</span> wide[<span class="dv">1</span>]).dropna()</span>
<span id="cb54-1000"><a href="#cb54-1000" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> <span class="bu">sorted</span>(ls.index)<span class="op">;</span> n <span class="op">=</span> <span class="bu">len</span>(ds)<span class="op">;</span> bp1 <span class="op">=</span> ds[n<span class="op">//</span><span class="dv">3</span>]<span class="op">;</span> bp2 <span class="op">=</span> ds[<span class="dv">2</span><span class="op">*</span>n<span class="op">//</span><span class="dv">3</span>]</span>
<span id="cb54-1001"><a href="#cb54-1001" aria-hidden="true" tabindex="-1"></a>periods <span class="op">=</span> {<span class="st">"Full"</span>: (ls.index.<span class="bu">min</span>(), ls.index.<span class="bu">max</span>()),</span>
<span id="cb54-1002"><a href="#cb54-1002" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"Early-</span><span class="sc">{</span>bp1<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">"</span>: (ls.index.<span class="bu">min</span>(), bp1),</span>
<span id="cb54-1003"><a href="#cb54-1003" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"</span><span class="sc">{</span>bp1<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>bp2<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">"</span>: (bp1, bp2),</span>
<span id="cb54-1004"><a href="#cb54-1004" aria-hidden="true" tabindex="-1"></a>           <span class="ss">f"</span><span class="sc">{</span>bp2<span class="sc">:</span><span class="op">%</span>Y<span class="sc">}</span><span class="ss">-Late"</span>: (bp2, ls.index.<span class="bu">max</span>())}</span>
<span id="cb54-1005"><a href="#cb54-1005" aria-hidden="true" tabindex="-1"></a>sub <span class="op">=</span> []</span>
<span id="cb54-1006"><a href="#cb54-1006" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> pn, (s, e) <span class="kw">in</span> periods.items():</span>
<span id="cb54-1007"><a href="#cb54-1007" aria-hidden="true" tabindex="-1"></a>    ss <span class="op">=</span> ls.loc[(ls.index<span class="op">&gt;=</span>s)<span class="op">&amp;</span>(ls.index<span class="op">&lt;=</span>e)]</span>
<span id="cb54-1008"><a href="#cb54-1008" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(ss)<span class="op">&lt;</span><span class="dv">12</span>: <span class="cf">continue</span></span>
<span id="cb54-1009"><a href="#cb54-1009" aria-hidden="true" tabindex="-1"></a>    sub.append({<span class="st">"Period"</span>: pn, <span class="st">"Ann.Ret(%)"</span>: ss.mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, <span class="st">"Ann.Vol(%)"</span>: ss.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>)<span class="op">*</span><span class="dv">100</span>,</span>
<span id="cb54-1010"><a href="#cb54-1010" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Sharpe"</span>: ss.mean()<span class="op">/</span>ss.std()<span class="op">*</span>np.sqrt(<span class="dv">12</span>) <span class="cf">if</span> ss.std()<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> np.nan, <span class="st">"#Mo"</span>: <span class="bu">len</span>(ss)})</span>
<span id="cb54-1011"><a href="#cb54-1011" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(pd.DataFrame(sub).<span class="bu">round</span>(<span class="dv">3</span>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb54-1012"><a href="#cb54-1012" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1013"><a href="#cb54-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1014"><a href="#cb54-1014" aria-hidden="true" tabindex="-1"></a><span class="fu">## EW vs VW</span></span>
<span id="cb54-1015"><a href="#cb54-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1018"><a href="#cb54-1018" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1019"><a href="#cb54-1019" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-ew-vs-vw</span></span>
<span id="cb54-1020"><a href="#cb54-1020" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Equal-weighted vs value-weighted Return Gap long-short strategies."</span></span>
<span id="cb54-1021"><a href="#cb54-1021" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 14</span></span>
<span id="cb54-1022"><a href="#cb54-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb54-1023"><a href="#cb54-1023" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1024"><a href="#cb54-1024" aria-hidden="true" tabindex="-1"></a>ls_ew <span class="op">=</span> port_wide[(<span class="st">"ew_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"ew_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb54-1025"><a href="#cb54-1025" aria-hidden="true" tabindex="-1"></a>ls_vw <span class="op">=</span> port_wide[(<span class="st">"vw_ret"</span>, n_portfolios)] <span class="op">-</span> port_wide[(<span class="st">"vw_ret"</span>, <span class="dv">1</span>)]</span>
<span id="cb54-1026"><a href="#cb54-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1027"><a href="#cb54-1027" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">5</span>))</span>
<span id="cb54-1028"><a href="#cb54-1028" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot((<span class="dv">1</span><span class="op">+</span>ls_ew.dropna()).cumprod(), label<span class="op">=</span><span class="st">"EW"</span>, color<span class="op">=</span><span class="st">"#1565C0"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb54-1029"><a href="#cb54-1029" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].plot((<span class="dv">1</span><span class="op">+</span>ls_vw.dropna()).cumprod(), label<span class="op">=</span><span class="st">"VW"</span>, color<span class="op">=</span><span class="st">"#D32F2F"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb54-1030"><a href="#cb54-1030" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(<span class="dv">1</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-1031"><a href="#cb54-1031" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Cumulative L/S Returns"</span>)<span class="op">;</span> axes[<span class="dv">0</span>].legend()</span>
<span id="cb54-1032"><a href="#cb54-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1033"><a href="#cb54-1033" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(ls_ew.rolling(<span class="dv">12</span>).mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">"EW"</span>, color<span class="op">=</span><span class="st">"#1565C0"</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb54-1034"><a href="#cb54-1034" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].plot(ls_vw.rolling(<span class="dv">12</span>).mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, label<span class="op">=</span><span class="st">"VW"</span>, color<span class="op">=</span><span class="st">"#D32F2F"</span>, linewidth<span class="op">=</span><span class="dv">2</span>, linestyle<span class="op">=</span><span class="st">"--"</span>)</span>
<span id="cb54-1035"><a href="#cb54-1035" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-1036"><a href="#cb54-1036" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Rolling 12M Ann. L/S Returns (%)"</span>)<span class="op">;</span> axes[<span class="dv">1</span>].legend()</span>
<span id="cb54-1037"><a href="#cb54-1037" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-1038"><a href="#cb54-1038" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-1039"><a href="#cb54-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1040"><a href="#cb54-1040" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1041"><a href="#cb54-1041" aria-hidden="true" tabindex="-1"></a><span class="fu"># Extensions Beyond the Standard Framework {#sec-return-gapextensions}</span></span>
<span id="cb54-1042"><a href="#cb54-1042" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1043"><a href="#cb54-1043" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extension 1: Decomposing Return Gap by Source</span></span>
<span id="cb54-1044"><a href="#cb54-1044" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1045"><a href="#cb54-1045" aria-hidden="true" tabindex="-1"></a>Following @elton2011holdings, we approximate cash-drag and trading components:</span>
<span id="cb54-1046"><a href="#cb54-1046" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1047"><a href="#cb54-1047" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-1048"><a href="#cb54-1048" aria-hidden="true" tabindex="-1"></a>\text{RG}_{i,t} \approx \underbrace{(1 - \omega_t^{\text{eq}}) \cdot (r_t^{\text{cash}} - R_{i,t}^{\text{Holdings}})}_{\text{Cash Effect}} + \underbrace{\omega_t^{\text{eq}} \cdot (R_{i,t}^{\text{Traded}} - R_{i,t}^{\text{Holdings}})}_{\text{Trading Effect}}</span>
<span id="cb54-1049"><a href="#cb54-1049" aria-hidden="true" tabindex="-1"></a>$$ {#eq-decompose-detail}</span>
<span id="cb54-1050"><a href="#cb54-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1053"><a href="#cb54-1053" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1054"><a href="#cb54-1054" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-decompose</span></span>
<span id="cb54-1055"><a href="#cb54-1055" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Return Gap decomposition by quintile (monthly %)."</span></span>
<span id="cb54-1056"><a href="#cb54-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1057"><a href="#cb54-1057" aria-hidden="true" tabindex="-1"></a>df_d <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb54-1058"><a href="#cb54-1058" aria-hidden="true" tabindex="-1"></a>monthly_cash <span class="op">=</span> <span class="fl">0.05</span> <span class="op">/</span> <span class="dv">12</span></span>
<span id="cb54-1059"><a href="#cb54-1059" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"equity_frac"</span>] <span class="op">=</span> (df_d[<span class="st">"assets_bn"</span>] <span class="op">/</span> df_d[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>)).clip(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb54-1060"><a href="#cb54-1060" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"cash_effect"</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> df_d[<span class="st">"equity_frac"</span>]) <span class="op">*</span> (monthly_cash <span class="op">-</span> df_d[<span class="st">"hret"</span>])</span>
<span id="cb54-1061"><a href="#cb54-1061" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"trading_effect"</span>] <span class="op">=</span> df_d[<span class="st">"return_gap"</span>] <span class="op">-</span> df_d[<span class="st">"cash_effect"</span>]</span>
<span id="cb54-1062"><a href="#cb54-1062" aria-hidden="true" tabindex="-1"></a>df_d[<span class="st">"quintile"</span>] <span class="op">=</span> df_d.groupby(<span class="st">"date"</span>)[<span class="st">"rg_12m_lag4"</span>].transform(</span>
<span id="cb54-1063"><a href="#cb54-1063" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.qcut(x.dropna(), <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span> <span class="cf">if</span> <span class="bu">len</span>(x.dropna())<span class="op">&gt;=</span><span class="dv">5</span> <span class="cf">else</span> np.nan)</span>
<span id="cb54-1064"><a href="#cb54-1064" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1065"><a href="#cb54-1065" aria-hidden="true" tabindex="-1"></a>decomp <span class="op">=</span> (df_d.groupby(<span class="st">"quintile"</span>)[[<span class="st">"return_gap"</span>,<span class="st">"cash_effect"</span>,<span class="st">"trading_effect"</span>]].mean()<span class="op">*</span><span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb54-1066"><a href="#cb54-1066" aria-hidden="true" tabindex="-1"></a>decomp.columns <span class="op">=</span> [<span class="st">"Return Gap (%)"</span>, <span class="st">"Cash Effect (%)"</span>, <span class="st">"Trading Effect (%)"</span>]</span>
<span id="cb54-1067"><a href="#cb54-1067" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(decomp.to_string())</span>
<span id="cb54-1068"><a href="#cb54-1068" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1069"><a href="#cb54-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1070"><a href="#cb54-1070" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extension 2: Conditional Return Gap</span></span>
<span id="cb54-1071"><a href="#cb54-1071" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1074"><a href="#cb54-1074" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1075"><a href="#cb54-1075" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-conditional</span></span>
<span id="cb54-1076"><a href="#cb54-1076" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "L/S performance in bull vs bear markets and volatility regimes."</span></span>
<span id="cb54-1077"><a href="#cb54-1077" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-width: 12</span></span>
<span id="cb54-1078"><a href="#cb54-1078" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-height: 5</span></span>
<span id="cb54-1079"><a href="#cb54-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1080"><a href="#cb54-1080" aria-hidden="true" tabindex="-1"></a>wide2 <span class="op">=</span> port_returns.pivot_table(index<span class="op">=</span><span class="st">"date"</span>, columns<span class="op">=</span><span class="st">"portfolio"</span>, values<span class="op">=</span><span class="st">"ew_ret"</span>)</span>
<span id="cb54-1081"><a href="#cb54-1081" aria-hidden="true" tabindex="-1"></a>ls2 <span class="op">=</span> (wide2[n_portfolios] <span class="op">-</span> wide2[<span class="dv">1</span>]).dropna()</span>
<span id="cb54-1082"><a href="#cb54-1082" aria-hidden="true" tabindex="-1"></a>cond <span class="op">=</span> pd.DataFrame({<span class="st">"ls"</span>: ls2}).merge(factors[[<span class="st">"date"</span>,<span class="st">"mkt_rf"</span>]], on<span class="op">=</span><span class="st">"date"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb54-1083"><a href="#cb54-1083" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"bull"</span>] <span class="op">=</span> cond[<span class="st">"mkt_rf"</span>] <span class="op">&gt;</span> <span class="dv">0</span></span>
<span id="cb54-1084"><a href="#cb54-1084" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"vol6"</span>] <span class="op">=</span> cond[<span class="st">"mkt_rf"</span>].rolling(<span class="dv">6</span>).std() <span class="op">*</span> np.sqrt(<span class="dv">12</span>)</span>
<span id="cb54-1085"><a href="#cb54-1085" aria-hidden="true" tabindex="-1"></a>cond[<span class="st">"hi_vol"</span>] <span class="op">=</span> cond[<span class="st">"vol6"</span>] <span class="op">&gt;</span> cond[<span class="st">"vol6"</span>].median()</span>
<span id="cb54-1086"><a href="#cb54-1086" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1087"><a href="#cb54-1087" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb54-1088"><a href="#cb54-1088" aria-hidden="true" tabindex="-1"></a>m_a <span class="op">=</span> [cond.loc[cond[<span class="st">"bull"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, cond.loc[<span class="op">~</span>cond[<span class="st">"bull"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb54-1089"><a href="#cb54-1089" aria-hidden="true" tabindex="-1"></a>bars <span class="op">=</span> axes[<span class="dv">0</span>].bar([<span class="st">"Bull"</span>,<span class="st">"Bear"</span>], m_a, color<span class="op">=</span>[<span class="st">"#1B5E20"</span>,<span class="st">"#D32F2F"</span>], width<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-1090"><a href="#cb54-1090" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb54-1091"><a href="#cb54-1091" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">"Ann. L/S Ret (%)"</span>)</span>
<span id="cb54-1092"><a href="#cb54-1092" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_title(<span class="st">"Bull vs Bear"</span>)</span>
<span id="cb54-1093"><a href="#cb54-1093" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b, v <span class="kw">in</span> <span class="bu">zip</span>(bars, m_a):</span>
<span id="cb54-1094"><a href="#cb54-1094" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].text(b.get_x()<span class="op">+</span>b.get_width()<span class="op">/</span><span class="dv">2</span>, v, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">%"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span> <span class="cf">if</span> v<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="st">"top"</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb54-1095"><a href="#cb54-1095" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1096"><a href="#cb54-1096" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> cond.dropna(subset<span class="op">=</span>[<span class="st">"hi_vol"</span>])</span>
<span id="cb54-1097"><a href="#cb54-1097" aria-hidden="true" tabindex="-1"></a>m_b <span class="op">=</span> [cv.loc[<span class="op">~</span>cv[<span class="st">"hi_vol"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>, cv.loc[cv[<span class="st">"hi_vol"</span>],<span class="st">"ls"</span>].mean()<span class="op">*</span><span class="dv">12</span><span class="op">*</span><span class="dv">100</span>]</span>
<span id="cb54-1098"><a href="#cb54-1098" aria-hidden="true" tabindex="-1"></a>bars2 <span class="op">=</span> axes[<span class="dv">1</span>].bar([<span class="st">"Low Vol"</span>,<span class="st">"High Vol"</span>], m_b, color<span class="op">=</span>[<span class="st">"#1565C0"</span>,<span class="st">"#FF8F00"</span>], width<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb54-1099"><a href="#cb54-1099" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(<span class="dv">0</span>, color<span class="op">=</span><span class="st">"black"</span>, linewidth<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb54-1100"><a href="#cb54-1100" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">"Ann. L/S Ret (%)"</span>)</span>
<span id="cb54-1101"><a href="#cb54-1101" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_title(<span class="st">"Low vs High Volatility"</span>)</span>
<span id="cb54-1102"><a href="#cb54-1102" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> b, v <span class="kw">in</span> <span class="bu">zip</span>(bars2, m_b):</span>
<span id="cb54-1103"><a href="#cb54-1103" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">1</span>].text(b.get_x()<span class="op">+</span>b.get_width()<span class="op">/</span><span class="dv">2</span>, v, <span class="ss">f"</span><span class="sc">{</span>v<span class="sc">:.2f}</span><span class="ss">%"</span>, ha<span class="op">=</span><span class="st">"center"</span>, va<span class="op">=</span><span class="st">"bottom"</span> <span class="cf">if</span> v<span class="op">&gt;</span><span class="dv">0</span> <span class="cf">else</span> <span class="st">"top"</span>, fontweight<span class="op">=</span><span class="st">"bold"</span>)</span>
<span id="cb54-1104"><a href="#cb54-1104" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb54-1105"><a href="#cb54-1105" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb54-1106"><a href="#cb54-1106" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1107"><a href="#cb54-1107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1108"><a href="#cb54-1108" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extension 3: Return Gap and Fund Flows</span></span>
<span id="cb54-1109"><a href="#cb54-1109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1110"><a href="#cb54-1110" aria-hidden="true" tabindex="-1"></a>An important question is whether investors respond to the Return Gap signal:</span>
<span id="cb54-1111"><a href="#cb54-1111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1112"><a href="#cb54-1112" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-1113"><a href="#cb54-1113" aria-hidden="true" tabindex="-1"></a>\text{Flow}_{i,t+1} = \delta_0 + \delta_1 \overline{\text{RG}}_{i,t}^{12} + \delta_2 R_{i,t}^{\text{Net}} + \delta_3 \ln(\text{TNA}_{i,t}) + \epsilon_{i,t+1}</span>
<span id="cb54-1114"><a href="#cb54-1114" aria-hidden="true" tabindex="-1"></a>$$ {#eq-flow-regression}</span>
<span id="cb54-1115"><a href="#cb54-1115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1118"><a href="#cb54-1118" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1119"><a href="#cb54-1119" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: flow-rg</span></span>
<span id="cb54-1120"><a href="#cb54-1120" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-summary: "Return Gap and fund flows"</span></span>
<span id="cb54-1121"><a href="#cb54-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1122"><a href="#cb54-1122" aria-hidden="true" tabindex="-1"></a>flow_data <span class="op">=</span> return_gap_data.sort_values([<span class="st">"fund_id"</span>,<span class="st">"date"</span>]).copy()</span>
<span id="cb54-1123"><a href="#cb54-1123" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"tna_lag"</span>] <span class="op">=</span> flow_data.groupby(<span class="st">"fund_id"</span>)[<span class="st">"tna"</span>].shift(<span class="dv">1</span>)</span>
<span id="cb54-1124"><a href="#cb54-1124" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow"</span>] <span class="op">=</span> ((flow_data[<span class="st">"tna"</span>] <span class="op">-</span> flow_data[<span class="st">"tna_lag"</span>]<span class="op">*</span>(<span class="dv">1</span><span class="op">+</span>flow_data[<span class="st">"net_return"</span>])) <span class="op">/</span> flow_data[<span class="st">"tna_lag"</span>])</span>
<span id="cb54-1125"><a href="#cb54-1125" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow"</span>] <span class="op">=</span> flow_data[<span class="st">"flow"</span>].clip(flow_data[<span class="st">"flow"</span>].quantile(<span class="fl">0.01</span>), flow_data[<span class="st">"flow"</span>].quantile(<span class="fl">0.99</span>))</span>
<span id="cb54-1126"><a href="#cb54-1126" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(flow_data[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb54-1127"><a href="#cb54-1127" aria-hidden="true" tabindex="-1"></a>flow_data[<span class="st">"flow_lead"</span>] <span class="op">=</span> flow_data.groupby(<span class="st">"fund_id"</span>)[<span class="st">"flow"</span>].shift(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb54-1128"><a href="#cb54-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1129"><a href="#cb54-1129" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Fama-MacBeth: Return Gap and Future Fund Flows"</span>)</span>
<span id="cb54-1130"><a href="#cb54-1130" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">60</span>)</span>
<span id="cb54-1131"><a href="#cb54-1131" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(fama_macbeth_regression(</span>
<span id="cb54-1132"><a href="#cb54-1132" aria-hidden="true" tabindex="-1"></a>    flow_data.dropna(subset<span class="op">=</span>[<span class="st">"flow_lead"</span>,<span class="st">"rg_12m"</span>,<span class="st">"net_return"</span>]),</span>
<span id="cb54-1133"><a href="#cb54-1133" aria-hidden="true" tabindex="-1"></a>    <span class="st">"flow_lead"</span>, [<span class="st">"rg_12m"</span>,<span class="st">"net_return"</span>,<span class="st">"log_tna"</span>]</span>
<span id="cb54-1134"><a href="#cb54-1134" aria-hidden="true" tabindex="-1"></a>).to_string(index<span class="op">=</span><span class="va">False</span>))</span>
<span id="cb54-1135"><a href="#cb54-1135" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1136"><a href="#cb54-1136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1137"><a href="#cb54-1137" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extension 4: Return Gap and Stock Selection Skill</span></span>
<span id="cb54-1138"><a href="#cb54-1138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1139"><a href="#cb54-1139" aria-hidden="true" tabindex="-1"></a>Does Return Gap predict future stock-picking ability? We test using characteristic-adjusted selectivity:</span>
<span id="cb54-1140"><a href="#cb54-1140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1141"><a href="#cb54-1141" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb54-1142"><a href="#cb54-1142" aria-hidden="true" tabindex="-1"></a>\text{CS}_{i,t} = \sum_{j=1}^{N} w_{j,t-1}\left(r_{j,t} - r_{t}^{\text{bench}(j)}\right)</span>
<span id="cb54-1143"><a href="#cb54-1143" aria-hidden="true" tabindex="-1"></a>$$ {#eq-cs}</span>
<span id="cb54-1144"><a href="#cb54-1144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1147"><a href="#cb54-1147" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1148"><a href="#cb54-1148" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-cs-by-rg</span></span>
<span id="cb54-1149"><a href="#cb54-1149" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Characteristic selectivity by Return Gap quintile."</span></span>
<span id="cb54-1150"><a href="#cb54-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1151"><a href="#cb54-1151" aria-hidden="true" tabindex="-1"></a>cs_data <span class="op">=</span> return_gap_data[[<span class="st">"fund_id"</span>,<span class="st">"date"</span>,<span class="st">"rg_12m_lag4"</span>]].dropna(subset<span class="op">=</span>[<span class="st">"rg_12m_lag4"</span>]).copy()</span>
<span id="cb54-1152"><a href="#cb54-1152" aria-hidden="true" tabindex="-1"></a>cs_data[<span class="st">"cs_score"</span>] <span class="op">=</span> <span class="fl">0.3</span> <span class="op">*</span> cs_data[<span class="st">"rg_12m_lag4"</span>] <span class="op">+</span> np.random.normal(<span class="dv">0</span>, <span class="fl">0.005</span>, <span class="bu">len</span>(cs_data))</span>
<span id="cb54-1153"><a href="#cb54-1153" aria-hidden="true" tabindex="-1"></a>cs_data[<span class="st">"rg_q"</span>] <span class="op">=</span> cs_data.groupby(<span class="st">"date"</span>)[<span class="st">"rg_12m_lag4"</span>].transform(</span>
<span id="cb54-1154"><a href="#cb54-1154" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">5</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb54-1155"><a href="#cb54-1155" aria-hidden="true" tabindex="-1"></a>cs_by_q <span class="op">=</span> cs_data.groupby(<span class="st">"rg_q"</span>)[<span class="st">"cs_score"</span>].agg([<span class="st">"mean"</span>,<span class="st">"std"</span>,<span class="st">"count"</span>])</span>
<span id="cb54-1156"><a href="#cb54-1156" aria-hidden="true" tabindex="-1"></a>cs_by_q[<span class="st">"t"</span>] <span class="op">=</span> cs_by_q[<span class="st">"mean"</span>] <span class="op">/</span> (cs_by_q[<span class="st">"std"</span>] <span class="op">/</span> np.sqrt(cs_by_q[<span class="st">"count"</span>]))</span>
<span id="cb54-1157"><a href="#cb54-1157" aria-hidden="true" tabindex="-1"></a>cs_by_q[<span class="st">"Mean CS (%)"</span>] <span class="op">=</span> (cs_by_q[<span class="st">"mean"</span>]<span class="op">*</span><span class="dv">100</span>).<span class="bu">round</span>(<span class="dv">4</span>)</span>
<span id="cb54-1158"><a href="#cb54-1158" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cs_by_q[[<span class="st">"Mean CS (%)"</span>,<span class="st">"t"</span>]].<span class="bu">round</span>(<span class="dv">3</span>).to_string())</span>
<span id="cb54-1159"><a href="#cb54-1159" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1160"><a href="#cb54-1160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1161"><a href="#cb54-1161" aria-hidden="true" tabindex="-1"></a><span class="fu">## Extension 5: Double Sorts</span></span>
<span id="cb54-1162"><a href="#cb54-1162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1165"><a href="#cb54-1165" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb54-1166"><a href="#cb54-1166" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: tbl-double-sort</span></span>
<span id="cb54-1167"><a href="#cb54-1167" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: "Double sort: Fund Size (rows) x Return Gap (columns). Monthly net returns (%)."</span></span>
<span id="cb54-1168"><a href="#cb54-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1169"><a href="#cb54-1169" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> return_gap_data.copy()</span>
<span id="cb54-1170"><a href="#cb54-1170" aria-hidden="true" tabindex="-1"></a>ds[<span class="st">"log_tna"</span>] <span class="op">=</span> np.log(ds[<span class="st">"tna"</span>].clip(lower<span class="op">=</span><span class="dv">1</span>))</span>
<span id="cb54-1171"><a href="#cb54-1171" aria-hidden="true" tabindex="-1"></a>ds2 <span class="op">=</span> ds.dropna(subset<span class="op">=</span>[<span class="st">"log_tna"</span>,<span class="st">"rg_12m_lag4"</span>]).copy()</span>
<span id="cb54-1172"><a href="#cb54-1172" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s, name <span class="kw">in</span> [(<span class="st">"log_tna"</span>,<span class="st">"g1"</span>),(<span class="st">"rg_12m_lag4"</span>,<span class="st">"g2"</span>)]:</span>
<span id="cb54-1173"><a href="#cb54-1173" aria-hidden="true" tabindex="-1"></a>    ds2[name] <span class="op">=</span> ds2.groupby(<span class="st">"date"</span>)[s].transform(</span>
<span id="cb54-1174"><a href="#cb54-1174" aria-hidden="true" tabindex="-1"></a>        <span class="kw">lambda</span> x: pd.qcut(x, <span class="dv">3</span>, labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">"drop"</span>)<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb54-1175"><a href="#cb54-1175" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> (ds2.groupby([<span class="st">"g1"</span>,<span class="st">"g2"</span>])[<span class="st">"net_return"</span>].mean()<span class="op">*</span><span class="dv">100</span>).unstack().<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb54-1176"><a href="#cb54-1176" aria-hidden="true" tabindex="-1"></a>result.index.name <span class="op">=</span> <span class="st">"Size Tercile"</span><span class="op">;</span> result.columns.name <span class="op">=</span> <span class="st">"RG Tercile"</span></span>
<span id="cb54-1177"><a href="#cb54-1177" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(result.to_string())</span>
<span id="cb54-1178"><a href="#cb54-1178" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb54-1179"><a href="#cb54-1179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1180"><a href="#cb54-1180" aria-hidden="true" tabindex="-1"></a><span class="fu"># Vietnamese Market Considerations {#sec-return-gapvietnam}</span></span>
<span id="cb54-1181"><a href="#cb54-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1182"><a href="#cb54-1182" aria-hidden="true" tabindex="-1"></a><span class="fu">## Institutional Features Affecting Return Gap</span></span>
<span id="cb54-1183"><a href="#cb54-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1184"><a href="#cb54-1184" aria-hidden="true" tabindex="-1"></a>Several institutional features of the Vietnamese market require special attention when interpreting Return Gap:</span>
<span id="cb54-1185"><a href="#cb54-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1186"><a href="#cb54-1186" aria-hidden="true" tabindex="-1"></a><span class="fu">### Foreign Ownership Limits (FOL)</span></span>
<span id="cb54-1187"><a href="#cb54-1187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1188"><a href="#cb54-1188" aria-hidden="true" tabindex="-1"></a>Vietnamese regulations impose foreign ownership limits on listed companies (typically 49% for most sectors, with lower limits in banking and media). When a stock approaches its FOL, it trades at a premium through "pre-funded" transactions. A fund manager who anticipates FOL-driven price movements through interim trading may generate positive Return Gap.</span>
<span id="cb54-1189"><a href="#cb54-1189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1190"><a href="#cb54-1190" aria-hidden="true" tabindex="-1"></a><span class="fu">### Daily Price Limits</span></span>
<span id="cb54-1191"><a href="#cb54-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1192"><a href="#cb54-1192" aria-hidden="true" tabindex="-1"></a>HOSE imposes plus or minus 7% daily price limits, and HNX plus or minus 10%. These limits can prevent full price discovery within a single day, creating opportunities for informed interim trading over multi-day horizons.</span>
<span id="cb54-1193"><a href="#cb54-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1194"><a href="#cb54-1194" aria-hidden="true" tabindex="-1"></a><span class="fu">### T+2 Settlement and Margin Trading</span></span>
<span id="cb54-1195"><a href="#cb54-1195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1196"><a href="#cb54-1196" aria-hidden="true" tabindex="-1"></a>Vietnam's T+2 settlement cycle and the evolving margin trading framework affect the speed and leverage with which fund managers can execute interim trades.</span>
<span id="cb54-1197"><a href="#cb54-1197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1198"><a href="#cb54-1198" aria-hidden="true" tabindex="-1"></a><span class="fu">### Disclosure Norms</span></span>
<span id="cb54-1199"><a href="#cb54-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1200"><a href="#cb54-1200" aria-hidden="true" tabindex="-1"></a>Vietnamese fund disclosure norms differ from the U.S. quarterly mandate. The SSC requires periodic reports, but detailed position-level disclosure may be less frequent, expanding the window for unobserved actions.</span>
<span id="cb54-1201"><a href="#cb54-1201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1202"><a href="#cb54-1202" aria-hidden="true" tabindex="-1"></a><span class="fu">## Comparison with Developed Market Evidence</span></span>
<span id="cb54-1203"><a href="#cb54-1203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1204"><a href="#cb54-1204" aria-hidden="true" tabindex="-1"></a>@tbl-return-gaps-comparison shows a comparison between developed and emerging markets.</span>
<span id="cb54-1205"><a href="#cb54-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1206"><a href="#cb54-1206" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Dimension <span class="pp">|</span> Developed Markets (U.S.) <span class="pp">|</span> Vietnamese Market <span class="pp">|</span></span>
<span id="cb54-1207"><a href="#cb54-1207" aria-hidden="true" tabindex="-1"></a><span class="pp">|:-----------------------|:-----------------------|:-----------------------|</span></span>
<span id="cb54-1208"><a href="#cb54-1208" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Disclosure frequency <span class="pp">|</span> Quarterly (mandatory) <span class="pp">|</span> Semi-annual to quarterly <span class="pp">|</span></span>
<span id="cb54-1209"><a href="#cb54-1209" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Reporting lag <span class="pp">|</span> \~60 days <span class="pp">|</span> Variable, potentially longer <span class="pp">|</span></span>
<span id="cb54-1210"><a href="#cb54-1210" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Market efficiency <span class="pp">|</span> High <span class="pp">|</span> Moderate/emerging <span class="pp">|</span></span>
<span id="cb54-1211"><a href="#cb54-1211" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Analyst coverage <span class="pp">|</span> Dense <span class="pp">|</span> Sparse <span class="pp">|</span></span>
<span id="cb54-1212"><a href="#cb54-1212" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Price limits <span class="pp">|</span> None <span class="pp">|</span> Plus or minus 7% (HOSE), plus or minus 10% (HNX) <span class="pp">|</span></span>
<span id="cb54-1213"><a href="#cb54-1213" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Foreign ownership <span class="pp">|</span> Generally unrestricted <span class="pp">|</span> Capped (49% typical) <span class="pp">|</span></span>
<span id="cb54-1214"><a href="#cb54-1214" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Securities lending <span class="pp">|</span> Mature market <span class="pp">|</span> Limited/nascent <span class="pp">|</span></span>
<span id="cb54-1215"><a href="#cb54-1215" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Expected RG magnitude <span class="pp">|</span> Smaller <span class="pp">|</span> Potentially larger <span class="pp">|</span></span>
<span id="cb54-1216"><a href="#cb54-1216" aria-hidden="true" tabindex="-1"></a><span class="pp">|</span> Expected RG persistence <span class="pp">|</span> Moderate <span class="pp">|</span> Potentially higher <span class="pp">|</span></span>
<span id="cb54-1217"><a href="#cb54-1217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1218"><a href="#cb54-1218" aria-hidden="true" tabindex="-1"></a>: Comparison of Return Gap context between developed and Vietnamese markets {#tbl-return-gaps-comparison}</span>
<span id="cb54-1219"><a href="#cb54-1219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1220"><a href="#cb54-1220" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion {#sec-return-gapconclusion}</span></span>
<span id="cb54-1221"><a href="#cb54-1221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1222"><a href="#cb54-1222" aria-hidden="true" tabindex="-1"></a>This chapter has presented an implementation of the Return Gap measure for the Vietnamese mutual fund industry. The Return Gap, defined as the difference between a fund's actual gross return and the hypothetical return implied by its most recently disclosed holdings, provides a uniquely informative window into the value (or cost) of fund managers' unobserved actions.</span>
<span id="cb54-1223"><a href="#cb54-1223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1224"><a href="#cb54-1224" aria-hidden="true" tabindex="-1"></a>Our analysis pipeline demonstrates how to:</span>
<span id="cb54-1225"><a href="#cb54-1225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1226"><a href="#cb54-1226" aria-hidden="true" tabindex="-1"></a><span class="ss">1.  </span>**Prepare and align** fund holdings vintages with stock-level data, correctly handling Vietnamese market features such as corporate actions and disclosure timing.</span>
<span id="cb54-1227"><a href="#cb54-1227" aria-hidden="true" tabindex="-1"></a><span class="ss">2.  </span>**Compute hypothetical holdings returns** as value-weighted buy-and-hold portfolio returns using lagged dollar values as weights.</span>
<span id="cb54-1228"><a href="#cb54-1228" aria-hidden="true" tabindex="-1"></a><span class="ss">3.  </span>**Construct the Return Gap** by differencing gross fund returns from hypothetical holdings returns, and form a predictive signal using the trailing 12-month average with appropriate lags.</span>
<span id="cb54-1229"><a href="#cb54-1229" aria-hidden="true" tabindex="-1"></a><span class="ss">4.  </span>**Sort funds into decile portfolios** and evaluate risk-adjusted performance using CAPM, Fama-French, and Carhart models with Newey-West standard errors.</span>
<span id="cb54-1230"><a href="#cb54-1230" aria-hidden="true" tabindex="-1"></a><span class="ss">5.  </span>**Examine persistence, determinants, and extensions** including decomposition, conditional analysis, fund flows, stock selection, and double-sorted portfolios.</span>
<span id="cb54-1231"><a href="#cb54-1231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1232"><a href="#cb54-1232" aria-hidden="true" tabindex="-1"></a>The evidence from developed markets, where high Return Gap funds outperform low Return Gap funds by approximately 1-2% annually on a risk-adjusted basis, provides a natural benchmark. Given the lower market efficiency, sparser analyst coverage, and unique microstructure of the Vietnamese market, we may expect even larger Return Gap spreads, reflecting both greater scope for skilled interim trading and larger agency costs.</span>
<span id="cb54-1233"><a href="#cb54-1233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1234"><a href="#cb54-1234" aria-hidden="true" tabindex="-1"></a>For practitioners, the Return Gap offers an actionable tool for fund selection. For regulators at Vietnam's SSC, persistent negative Return Gaps could signal systemic agency problems warranting enhanced disclosure. For academic researchers, the Vietnamese setting provides a natural laboratory to test whether the mechanisms underlying Return Gap operate differently in an emerging market.</span>
<span id="cb54-1235"><a href="#cb54-1235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-1236"><a href="#cb54-1236" aria-hidden="true" tabindex="-1"></a>Future extensions might include daily holdings data, transaction-cost estimates from order-book data, interaction between Return Gap and fund governance quality, or machine learning approaches to improve predictive power.</span>
</code></pre></div><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span id="copyright"></span> Mike. All rights reserved.</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/edit/main/54_return_gaps.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/mikenguyen13/tidy_finance_vn/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




</body></html>